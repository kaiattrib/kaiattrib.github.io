<!doctype html>
<html lang="zh"><head><meta charset="utf-8"><meta name="referrer" content="no-referrer"><meta name="generator" content="Hexo 4.2.0"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta><title>分析 Synchronized 锁的4个状态 - Keeplooking</title><meta description="1.前言通过JOL查看对象的头信息，Synchronized 关键字锁的状态：无锁、偏向锁、轻量级锁、重量级锁  基于64位 jdk8测试"><meta property="og:type" content="blog"><meta property="og:title" content="分析 Synchronized 锁的4个状态"><meta property="og:url" content="http://yoursite.com/2019/10/17/Java/synchronized4%E7%A7%8D%E9%94%81/"><meta property="og:site_name" content="Keeplooking"><meta property="og:description" content="1.前言通过JOL查看对象的头信息，Synchronized 关键字锁的状态：无锁、偏向锁、轻量级锁、重量级锁  基于64位 jdk8测试"><meta property="og:locale" content="zh_CN"><meta property="og:image" content="https://cdn.nlark.com/yuque/0/2020/png/501385/1589632733355-e8e87aa8-405f-4e62-b7c6-91ce252d1b53.png#align=left&amp;display=inline&amp;height=652&amp;margin=%5Bobject%20Object%5D&amp;name=Xnip2020-05-16_20-26-54.png&amp;originHeight=652&amp;originWidth=2202&amp;size=174455&amp;status=done&amp;style=none&amp;width=2202"><meta property="article:published_time" content="2019-10-17T15:23:46.000Z"><meta property="article:modified_time" content="2023-05-14T07:53:19.962Z"><meta property="article:author" content="Ken Chan"><meta property="article:tag" content="Bug"><meta property="article:tag" content="Java"><meta property="twitter:card" content="summary"><meta property="twitter:image" content="https://cdn.nlark.com/yuque/0/2020/png/501385/1589632733355-e8e87aa8-405f-4e62-b7c6-91ce252d1b53.png#align=left&amp;display=inline&amp;height=652&amp;margin=%5Bobject%20Object%5D&amp;name=Xnip2020-05-16_20-26-54.png&amp;originHeight=652&amp;originWidth=2202&amp;size=174455&amp;status=done&amp;style=none&amp;width=2202"><script type="application/ld+json">{"@context":"https://schema.org","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"http://yoursite.com/2019/10/17/Java/synchronized4%E7%A7%8D%E9%94%81/"},"headline":"Keeplooking","image":[],"datePublished":"2019-10-17T15:23:46.000Z","dateModified":"2023-05-14T07:53:19.962Z","author":{"@type":"Person","name":"Ken Chan"},"description":"1.前言通过JOL查看对象的头信息，Synchronized 关键字锁的状态：无锁、偏向锁、轻量级锁、重量级锁  基于64位 jdk8测试"}</script><link rel="canonical" href="http://yoursite.com/2019/10/17/Java/synchronized4%E7%A7%8D%E9%94%81/"><link rel="icon" href="/img/favicon.png"><link rel="stylesheet" href="https://cdn.bootcss.com/font-awesome/5.13.0/css/all.css"><link rel="stylesheet" href="https://cdnjs.loli.net/ajax/libs/highlight.js/9.12.0/styles/atom-one-light.min.css"><link rel="stylesheet" href="https://cdn.staticfile.org/entypo/2.0/entypo.woff"><link rel="stylesheet" href="/css/default.css"><style>body>.footer,body>.navbar,body>.section{opacity:0}</style><!--!--><!--!--><link rel="stylesheet" href="https://cdnjs.loli.net/ajax/libs/lightgallery/1.6.8/css/lightgallery.min.css"><link rel="stylesheet" href="https://cdnjs.loli.net/ajax/libs/justifiedGallery/3.7.0/css/justifiedGallery.min.css"><!--!--><script src="https://cdnjs.loli.net/ajax/libs/pace/1.0.2/pace.min.js"></script><style>mjx-container[jax="SVG"] {
  direction: ltr;
}

mjx-container[jax="SVG"] > svg {
  overflow: visible;
}

mjx-container[jax="SVG"] > svg a {
  fill: blue;
  stroke: blue;
}

mjx-container[jax="SVG"][display="true"] {
  display: block;
  text-align: center;
  margin: 1em 0;
}

mjx-container[jax="SVG"][justify="left"] {
  text-align: left;
}

mjx-container[jax="SVG"][justify="right"] {
  text-align: right;
}

g[data-mml-node="merror"] > g {
  fill: red;
  stroke: red;
}

g[data-mml-node="merror"] > rect[data-background] {
  fill: yellow;
  stroke: none;
}

g[data-mml-node="mtable"] > line[data-line] {
  stroke-width: 70px;
  fill: none;
}

g[data-mml-node="mtable"] > rect[data-frame] {
  stroke-width: 70px;
  fill: none;
}

g[data-mml-node="mtable"] > .mjx-dashed {
  stroke-dasharray: 140;
}

g[data-mml-node="mtable"] > .mjx-dotted {
  stroke-linecap: round;
  stroke-dasharray: 0,140;
}

g[data-mml-node="mtable"] > svg {
  overflow: visible;
}

[jax="SVG"] mjx-tool {
  display: inline-block;
  position: relative;
  width: 0;
  height: 0;
}

[jax="SVG"] mjx-tool > mjx-tip {
  position: absolute;
  top: 0;
  left: 0;
}

mjx-tool > mjx-tip {
  display: inline-block;
  padding: .2em;
  border: 1px solid #888;
  font-size: 70%;
  background-color: #F8F8F8;
  color: black;
  box-shadow: 2px 2px 5px #AAAAAA;
}

g[data-mml-node="maction"][data-toggle] {
  cursor: pointer;
}

mjx-status {
  display: block;
  position: fixed;
  left: 1em;
  bottom: 1em;
  min-width: 25%;
  padding: .2em .4em;
  border: 1px solid #888;
  font-size: 90%;
  background-color: #F8F8F8;
  color: black;
}

foreignObject[data-mjx-xml] {
  font-family: initial;
  line-height: normal;
  overflow: visible;
}

.MathJax path {
  stroke-width: 3;
}

mjx-container {
  overflow: auto hidden;
}

mjx-container + br {
  display: none;
}
</style></head><body class="is-3-column"><nav class="navbar navbar-main"><div class="container"><div class="navbar-brand justify-content-center"><a class="navbar-item navbar-logo" href="/"><img src="/img/logo.png" alt="Keeplooking" height="28"></a></div><div class="navbar-menu"><div class="navbar-start"><a class="navbar-item" href="/">主页</a><a class="navbar-item" href="/archives">归档</a><a class="navbar-item" href="/categories">分类</a><a class="navbar-item" href="/tags">标签</a><a class="navbar-item" href="/suibi/suibi.html">随笔</a><a class="navbar-item" href="/comments">关于</a></div><div class="navbar-end"><a class="navbar-item is-hidden-tablet catalogue" title="目录" href="javascript:;" style="font-size: 1.5em;"><i class="fas fa-list-ul"></i></a><a class="navbar-item search" title="搜索" href="javascript:;" style="font-size: 1.5em;"><i class="fas fa-search"></i></a></div></div></div></nav><section class="section"><div class="container"><div class="columns"><div class="column order-2 column-main is-8-tablet is-8-desktop is-8-widescreen"><div class="card"><article class="card-content article" role="article"><div class="article-meta size-small is-uppercase level is-mobile"><div class="level-left"><time class="level-item" dateTime="2019-10-17T15:23:46.000Z" title="2019-10-17T15:23:46.000Z">2019-10-17</time><span class="level-item"><a class="link-muted" href="/categories/%E8%AF%AD%E8%A8%80%E5%9F%BA%E7%A1%80/">语言基础</a><span> / </span><a class="link-muted" href="/categories/%E8%AF%AD%E8%A8%80%E5%9F%BA%E7%A1%80/Java/">Java</a></span><span class="level-item">15 分钟 读完 (大约 2311 个字)</span></div></div><h1 class="title is-3 is-size-4-mobile">分析 Synchronized 锁的4个状态</h1><div class="content"><h2 id="1-前言"><a href="#1-前言" class="headerlink" title="1.前言"></a>1.前言</h2><p>通过JOL查看对象的头信息，Synchronized 关键字锁的状态：无锁、偏向锁、轻量级锁、重量级锁<br /></p>
<ul>
<li>基于64位 jdk8测试<a id="more"></a>


</li>
</ul>
<h3 id="int-pthread-mutex-lock-pthread-mutex-t-mutex"><a href="#int-pthread-mutex-lock-pthread-mutex-t-mutex" class="headerlink" title="int pthread_mutex_lock(pthread_mutex_t *mutex);"></a>int pthread_mutex_lock(pthread_mutex_t *mutex);</h3><p>pthread_mutex_lock()返回时，该<a href="https://baike.baidu.com/item/%E4%BA%92%E6%96%A5%E9%94%81/841823">互斥锁</a>已被锁定。<a href="https://baike.baidu.com/item/%E7%BA%BF%E7%A8%8B/103101">线程</a>调用该函数让互斥锁上锁，如果该互斥锁已被另一个线程锁定和拥有，则调用该线程将阻塞，直到该互斥锁变为可用为止。 对于 Solaris线程，请参见<a href="https://baike.baidu.com/item/mutex_lock%20%E8%AF%AD%E6%B3%95">mutex_lock 语法</a></p>
<ul>
<li>会阻塞</li>
</ul>
<p><br />我们可以从JVM 源码中看到对glibc库调用，操作系统层级的锁</p>
<h3 id="ThreadCritical-ThreadCritical"><a href="#ThreadCritical-ThreadCritical" class="headerlink" title="ThreadCritical::ThreadCritical"></a>ThreadCritical::ThreadCritical</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">ThreadCritical::ThreadCritical() &#123;</span><br><span class="line">  <span class="keyword">pthread_t</span> self = pthread_self();</span><br><span class="line">  <span class="keyword">if</span> (self != tc_owner) &#123;</span><br><span class="line">    <span class="keyword">int</span> ret = pthread_mutex_lock(&amp;tc_mutex);</span><br><span class="line">    guarantee(ret == <span class="number">0</span>, <span class="string">"fatal error with pthread_mutex_lock()"</span>);</span><br><span class="line">    assert(tc_count == <span class="number">0</span>, <span class="string">"Lock acquired with illegal reentry count."</span>);</span><br><span class="line">    tc_owner = self;</span><br><span class="line">  &#125;</span><br><span class="line">  tc_count++;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id=""><a href="#" class="headerlink" title=""></a><img src="https://cdn.nlark.com/yuque/0/2020/png/501385/1589632733355-e8e87aa8-405f-4e62-b7c6-91ce252d1b53.png#align=left&display=inline&height=652&margin=%5Bobject%20Object%5D&name=Xnip2020-05-16_20-26-54.png&originHeight=652&originWidth=2202&size=174455&status=done&style=none&width=2202" alt=""></h2><p>  这个是底层系统库，我们是看不到源码的，只能自己下载。可以在glibc/nptl/phread_mutex_lock.c里看到实现。<br />  </p>
<h2 id="2-验证准备"><a href="#2-验证准备" class="headerlink" title="2.验证准备"></a>2.验证准备</h2><ul>
<li>先通过一个jni调用来获取pthread层面的tid<h3 id="JniTool-java"><a href="#JniTool-java" class="headerlink" title="JniTool.java"></a>JniTool.java</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> jnitool;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">JniTool</span> </span>&#123;</span><br><span class="line">    <span class="keyword">static</span> &#123;</span><br><span class="line">        System.loadLibrary(<span class="string">"jnitools"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">native</span> <span class="keyword">void</span> <span class="title">getThreadID</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
这里jnitool必须在 java.library.path这一jvm变量所指向的路径中，<br />可以通过如下方法获得该变量System.getProperty(“java.library.path”);<br /></li>
</ul>
<h3 id="生成-h文件，javah-jni-jnitool-JniTool"><a href="#生成-h文件，javah-jni-jnitool-JniTool" class="headerlink" title="生成.h文件，javah -jni jnitool.JniTool"></a>生成.h文件，javah -jni jnitool.JniTool</h3><p>打印java线程的pid和tid，jvm层面</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"jnitool_JniTool.h"</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;pthread.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"></span><br><span class="line">JNIEXPORT <span class="keyword">void</span> JNICALL Java_jnitool_JniTool_getThreadID</span><br><span class="line">  (JNIEnv * env, jobject obj)&#123;</span><br><span class="line">        <span class="built_in">fprintf</span>(<span class="built_in">stdout</span>,<span class="string">"java_lock log  PID = %d TID = %lu \n"</span>,getpid(),pthread_self());</span><br><span class="line">        fflush(<span class="built_in">stdout</span>);<span class="comment">//刷新，防止错位打印</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<h3 id="使用make编译"><a href="#使用make编译" class="headerlink" title="使用make编译"></a>使用make编译</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">vim makefile</span><br><span class="line"></span><br><span class="line">libjnitools.so:</span><br><span class="line">	gcc -lpthread -fPIC -shared -o libjnitools.so  -I /root/jdk1.8.0_221/include/ -I /root/jdk1.8.0_221/include/linux/ ./jnitools.c</span><br><span class="line">  </span><br><span class="line">make</span><br></pre></td></tr></table></figure>


<h3 id="对象头信息-object-header-关闭指针压缩-XX-UseCompressedOops"><a href="#对象头信息-object-header-关闭指针压缩-XX-UseCompressedOops" class="headerlink" title="对象头信息 object header 关闭指针压缩 -XX:-UseCompressedOops"></a>对象头信息 object header 关闭指针压缩 -XX:-UseCompressedOops</h3><ul>
<li><p>关于对象头信息的详情介绍，可以 </p>
</li>
<li><p>自己写个工具方法，根据markworld转换出头部信息</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">|--------------------------------------------------------------------------------------------------------------|</span><br><span class="line">|                                              Object Header (128 bits)                                        |</span><br><span class="line">|--------------------------------------------------------------------------------------------------------------|</span><br><span class="line">|                        Mark Word (64 bits)                                    |      Klass Word (64 bits)    |       </span><br><span class="line">|--------------------------------------------------------------------------------------------------------------|</span><br><span class="line">|  unused:25 | identity_hashcode:31 | unused:1 | age:4 | biased_lock:1 | lock:2 |     OOP to metadata object   |  无锁</span><br><span class="line">|----------------------------------------------------------------------|--------|------------------------------|</span><br><span class="line">|  thread:54 |         epoch:2      | unused:1 | age:4 | biased_lock:1 | lock:2 |     OOP to metadata object   |  偏向锁</span><br><span class="line">|----------------------------------------------------------------------|--------|------------------------------|</span><br><span class="line">|                     ptr_to_lock_record:62                            | lock:2 |     OOP to metadata object   |  轻量锁</span><br><span class="line">|----------------------------------------------------------------------|--------|------------------------------|</span><br><span class="line">|                     ptr_to_heavyweight_monitor:62                    | lock:2 |     OOP to metadata object   |  重量锁</span><br><span class="line">|----------------------------------------------------------------------|--------|------------------------------|</span><br><span class="line">|                                                                      | lock:2 |     OOP to metadata object   |    GC</span><br><span class="line">|--------------------------------------------------------------------------------------------------------------|</span><br></pre></td></tr></table></figure>
</li>
<li><p>接受JOL输出，自己写一个转换工具，方便debug</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">parseHeaderInfo</span><span class="params">(String printable)</span> </span>&#123;</span><br><span class="line">        String[] split = printable.replaceAll(<span class="string">"[|)]"</span>, <span class="string">""</span>).split(<span class="string">"\n"</span>);</span><br><span class="line">        StringBuilder builder = <span class="keyword">new</span> StringBuilder();</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">2</span>; i &lt;= <span class="number">3</span>; i++) &#123;</span><br><span class="line">            builder.append(split[i].split(<span class="string">"\\("</span>)[<span class="number">2</span>]);</span><br><span class="line">        &#125;</span><br><span class="line">        ArrayList&lt;String&gt; strings = <span class="keyword">new</span> ArrayList&lt;&gt;(Arrays.asList(builder.toString().split(<span class="string">" "</span>)));</span><br><span class="line">        Collections.reverse(strings);</span><br><span class="line">        builder = <span class="keyword">new</span> StringBuilder();</span><br><span class="line">        <span class="keyword">for</span> (String string : strings) &#123;</span><br><span class="line">            builder.append(string);</span><br><span class="line">        &#125;</span><br><span class="line">        String markWord = builder.toString();</span><br><span class="line">        System.out.println(<span class="string">"\n--------START-----------"</span>);</span><br><span class="line">        <span class="comment">//System.out.println("mark world:"+markWord);</span></span><br><span class="line">        String lock = markWord.substring(<span class="number">62</span>);</span><br><span class="line">        String biased_lock = String.valueOf(markWord.charAt(<span class="number">61</span>));</span><br><span class="line">        builder = <span class="keyword">new</span> StringBuilder();</span><br><span class="line">        <span class="keyword">if</span> (lock.equals(<span class="string">"01"</span>)) &#123;</span><br><span class="line">            <span class="keyword">if</span> (biased_lock.equals(<span class="string">"0"</span>)) &#123;</span><br><span class="line">                System.out.println(<span class="string">"--------无锁-----------"</span>);</span><br><span class="line">                System.out.println(<span class="string">"unused:25:"</span> + markWord.substring(<span class="number">0</span>, <span class="number">25</span>));</span><br><span class="line">                System.out.println(<span class="string">"identity_hashcode:31: "</span> + markWord.substring(<span class="number">25</span>, <span class="number">56</span>)</span><br><span class="line">                        + <span class="string">" (Hex:"</span> + Integer.toHexString(Integer.parseInt(markWord.substring(<span class="number">25</span>, <span class="number">56</span>), <span class="number">2</span>)) + <span class="string">")"</span>);</span><br><span class="line">                System.out.println(<span class="string">"unused:1:"</span> + markWord.substring(<span class="number">56</span>, <span class="number">57</span>));</span><br><span class="line">                System.out.println(<span class="string">"age:4:"</span> + markWord.substring(<span class="number">57</span>, <span class="number">61</span>));</span><br><span class="line">                System.out.println(<span class="string">"biased_lock:1:"</span> + markWord.substring(<span class="number">61</span>, <span class="number">62</span>));</span><br><span class="line">                System.out.println(<span class="string">"lock:2:"</span> + markWord.substring(<span class="number">62</span>));</span><br><span class="line"></span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                System.out.println(<span class="string">"--------偏向锁--------"</span>);</span><br><span class="line">                System.out.println(<span class="string">"thread:54:"</span> + markWord.substring(<span class="number">0</span>, <span class="number">54</span>)</span><br><span class="line">                        +<span class="string">"(Dex:"</span>+Long.parseLong(markWord.substring(<span class="number">0</span>, <span class="number">54</span>), <span class="number">2</span>)+<span class="string">")"</span>);</span><br><span class="line">                System.out.println(<span class="string">"epoch:2:"</span> + markWord.substring(<span class="number">54</span>, <span class="number">56</span>));</span><br><span class="line">                System.out.println(<span class="string">"unused:1:"</span> + markWord.substring(<span class="number">56</span>, <span class="number">57</span>));</span><br><span class="line">                System.out.println(<span class="string">"age:4:"</span> + markWord.substring(<span class="number">57</span>, <span class="number">61</span>));</span><br><span class="line">                System.out.println(<span class="string">"biased_lock:1:"</span> + markWord.substring(<span class="number">61</span>, <span class="number">62</span>));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            String hexString = Long.toHexString(Long.parseLong(markWord.substring(<span class="number">0</span>, <span class="number">62</span>), <span class="number">2</span>));</span><br><span class="line">            <span class="keyword">if</span> (lock.equals(<span class="string">"00"</span>)) &#123;</span><br><span class="line">                System.out.println(<span class="string">"--------轻量级锁--------"</span>);</span><br><span class="line">                System.out.println(<span class="string">"ptr_to_lock_record:62:"</span> + markWord.substring(<span class="number">0</span>, <span class="number">62</span>)</span><br><span class="line">                        + <span class="string">" (Hex:"</span> + hexString + <span class="string">")"</span>);</span><br><span class="line">                System.out.println(<span class="string">"lock:2:"</span> + markWord.substring(<span class="number">62</span>));</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (lock.equals(<span class="string">"10"</span>)) &#123;</span><br><span class="line">                System.out.println(<span class="string">"--------重量级锁--------"</span>);</span><br><span class="line">                System.out.println(<span class="string">"ptr_to_heavyweight_monitor::62:"</span> + markWord.substring(<span class="number">0</span>, <span class="number">62</span>)</span><br><span class="line">                        + <span class="string">" (Hex:"</span> + hexString + <span class="string">")"</span>);</span><br><span class="line">                System.out.println(<span class="string">"lock:2:"</span> + markWord.substring(<span class="number">62</span>));</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (lock.equals(<span class="string">"11"</span>)) &#123;</span><br><span class="line">                System.out.println(<span class="string">"--------GC标记--------"</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        System.out.println(<span class="string">"--------END-----------\n"</span>);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

</li>
</ul>
<br />


<h2 id="3-无锁"><a href="#3-无锁" class="headerlink" title="3.无锁"></a>3.无锁</h2><ul>
<li><p>JVM直接优化，进行无锁访问，虽然加了锁</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> jnitools.JniTools;</span><br><span class="line"><span class="keyword">import</span> org.openjdk.jol.info.ClassLayout;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.ArrayList;</span><br><span class="line"><span class="keyword">import</span> java.util.Arrays;</span><br><span class="line"><span class="keyword">import</span> java.util.Collections;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SyncTest</span> </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> Object lock = <span class="keyword">new</span> Object();</span><br><span class="line">    JniTools jniTool = <span class="keyword">new</span> JniTools();</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">        SyncTest test = <span class="keyword">new</span> SyncTest();</span><br><span class="line">        test.parseHeaderInfo((ClassLayout.parseInstance(test.lock).toPrintable()));</span><br><span class="line">        System.out.println(<span class="string">"---------------------------start--------------------"</span>);</span><br><span class="line">        test.start();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">start</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">        Runnable runnable = <span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">            <span class="keyword">int</span> count = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (count &lt; <span class="number">100</span>) &#123;</span><br><span class="line">                        count++;</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        <span class="keyword">return</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        lock();</span><br><span class="line">                        parseHeaderInfo(ClassLayout.parseInstance(lock).toPrintable());</span><br><span class="line">                        Thread.sleep(<span class="number">200</span>);</span><br><span class="line">                    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                        e.printStackTrace();</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="keyword">new</span> Thread(runnable).start();</span><br><span class="line">        Thread.sleep(<span class="number">5000</span>);</span><br><span class="line">        <span class="keyword">new</span> Thread(runnable).start();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">lock</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">synchronized</span> (lock) &#123;</span><br><span class="line">            jniTool.getTid();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>分析，虽然有多个线程访问，但是不存在，同时竞争。</p>
<p><br />log 无锁<br /><a href="https://www.yuque.com/attachments/yuque/0/2020/log/501385/1589706449975-5c61f76a-4df4-4cd6-b3b9-4ea1dcab23ff.log?_lake_card=%7B%22uid%22%3A%221589706449887-0%22%2C%22src%22%3A%22https%3A%2F%2Fwww.yuque.com%2Fattachments%2Fyuque%2F0%2F2020%2Flog%2F501385%2F1589706449975-5c61f76a-4df4-4cd6-b3b9-4ea1dcab23ff.log%22%2C%22name%22%3A%22out.log%22%2C%22size%22%3A28555%2C%22type%22%3A%22%22%2C%22ext%22%3A%22log%22%2C%22progress%22%3A%7B%22percent%22%3A99%7D%2C%22status%22%3A%22done%22%2C%22percent%22%3A0%2C%22id%22%3A%22S9m5k%22%2C%22card%22%3A%22file%22%7D">out.log</a></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">--------START-----------</span><br><span class="line">--------无锁-----------</span><br><span class="line">unused:25:0000000000000000000000000</span><br><span class="line">identity_hashcode:31: 0000000000000000000000000000000 (Hex:0)</span><br><span class="line">unused:1:0</span><br><span class="line">age:4:0000</span><br><span class="line">biased_lock:1:0</span><br><span class="line">lock:2:01</span><br><span class="line">--------END-----------</span><br><span class="line"></span><br><span class="line">---------------------------start--------------------</span><br><span class="line">java_lock <span class="built_in">log</span>-----------PID = 189 TID = 139775743776512 </span><br><span class="line"></span><br><span class="line">--------START-----------</span><br><span class="line">--------无锁-----------</span><br><span class="line">unused:25:0000000000000000000000000</span><br><span class="line">identity_hashcode:31: 0000000000000000000000000000000 (Hex:0)</span><br><span class="line">unused:1:0</span><br><span class="line">age:4:0000</span><br><span class="line">biased_lock:1:0</span><br><span class="line">lock:2:01</span><br><span class="line">--------END-----------</span><br><span class="line"></span><br><span class="line">java_lock <span class="built_in">log</span>-----------PID = 189 TID = 139775743776512 </span><br><span class="line"></span><br><span class="line">--------START-----------</span><br><span class="line">--------无锁-----------</span><br><span class="line">unused:25:0000000000000000000000000</span><br><span class="line">identity_hashcode:31: 0000000000000000000000000000000 (Hex:0)</span><br><span class="line">unused:1:0</span><br><span class="line">age:4:0000</span><br><span class="line">biased_lock:1:0</span><br><span class="line">lock:2:01</span><br><span class="line">--------END-----------</span><br><span class="line"></span><br><span class="line">java_lock <span class="built_in">log</span>-----------PID = 189 TID = 139775743776512 </span><br><span class="line"></span><br><span class="line">--------START-----------</span><br><span class="line">--------无锁-----------</span><br><span class="line">unused:25:0000000000000000000000000</span><br><span class="line">identity_hashcode:31: 0000000000000000000000000000000 (Hex:0)</span><br><span class="line">unused:1:0</span><br><span class="line">age:4:0001</span><br><span class="line">biased_lock:1:0</span><br><span class="line">lock:2:01</span><br><span class="line">--------END-----------</span><br></pre></td></tr></table></figure>


</li>
</ul>
<h2 id="4-偏向锁"><a href="#4-偏向锁" class="headerlink" title="4 偏向锁"></a>4 偏向锁</h2><ul>
<li>当关闭偏向锁功能时</li>
<li>由于多个线程竞争偏向锁导致偏向锁升级为轻量级锁。</li>
<li>一开始就是偏向锁，处于可偏向，谁先来锁，就偏向谁<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> jnitools.JniTools;</span><br><span class="line"><span class="keyword">import</span> org.openjdk.jol.info.ClassLayout;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.ArrayList;</span><br><span class="line"><span class="keyword">import</span> java.util.Arrays;</span><br><span class="line"><span class="keyword">import</span> java.util.Collections;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SyncTest</span> </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> Object lock = <span class="keyword">new</span> Object();</span><br><span class="line">    JniTools jniTool = <span class="keyword">new</span> JniTools();</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">        Thread.sleep(<span class="number">5000</span>);</span><br><span class="line">        SyncTest test = <span class="keyword">new</span> SyncTest();</span><br><span class="line">        test.parseHeaderInfo((ClassLayout.parseInstance(test.lock).toPrintable()));</span><br><span class="line">        System.out.println(<span class="string">"---------------------------start--------------------"</span>);</span><br><span class="line">        test.start();</span><br><span class="line">        Thread.sleep(<span class="number">50000</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">start</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">        Runnable runnable = <span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                <span class="keyword">int</span> count = <span class="number">0</span>;</span><br><span class="line">                <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (count &lt; <span class="number">50</span>) &#123;</span><br><span class="line">                        count++;</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        System.out.println(<span class="string">"Thread "</span>+Thread.currentThread().getName()+<span class="string">" return "</span>);</span><br><span class="line">                        <span class="keyword">return</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        lock();</span><br><span class="line">                        parseHeaderInfo(ClassLayout.parseInstance(lock).toPrintable());</span><br><span class="line">                        <span class="comment">// Thread.sleep(100);</span></span><br><span class="line">                    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                        e.printStackTrace();</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="keyword">new</span> Thread(runnable).start();</span><br><span class="line">        Thread.sleep(<span class="number">5000</span>);</span><br><span class="line">        <span class="keyword">new</span> Thread(runnable).start();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">lock</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">synchronized</span> (lock) &#123;</span><br><span class="line">            jniTool.getTid();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


</li>
</ul>
<ul>
<li><p>Thread.sleep(5000); 主要在线程启动时候加上了sleep</p>
<p><a href="https://www.yuque.com/attachments/yuque/0/2020/log/501385/1589709102148-563fab80-ff41-4ffd-9778-4ddb14d80ee4.log?_lake_card=%7B%22uid%22%3A%221589709102039-0%22%2C%22src%22%3A%22https%3A%2F%2Fwww.yuque.com%2Fattachments%2Fyuque%2F0%2F2020%2Flog%2F501385%2F1589709102148-563fab80-ff41-4ffd-9778-4ddb14d80ee4.log%22%2C%22name%22%3A%22out.log%22%2C%22size%22%3A27078%2C%22type%22%3A%22%22%2C%22ext%22%3A%22log%22%2C%22progress%22%3A%7B%22percent%22%3A99%7D%2C%22status%22%3A%22done%22%2C%22percent%22%3A0%2C%22id%22%3A%22JWuwe%22%2C%22card%22%3A%22file%22%7D">out.log</a></p>
</li>
<li><p>为了减少JVM启动时初始化时间，JVM默认延时加载偏向锁。大概为4s左右，具体时间因机器而异。当然我们也可以设置JVM参数 -XX:BiasedLockingStartupDelay=0 来取消延时加载偏向锁</p>
</li>
<li><p>你会发现占用 thread 和 epoch 的 位置的均为0，说明当前偏向锁并没有偏向任何线程，此时这个偏向锁正处于可偏向状态。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">--------START-----------</span><br><span class="line">--------偏向锁--------</span><br><span class="line">thread:54:000000000000000000000000000000000000000000000000000000(Dex:0)</span><br><span class="line">epoch:2:00</span><br><span class="line">unused:1:0</span><br><span class="line">age:4:0000</span><br><span class="line">biased_lock:1:1</span><br><span class="line">--------END-----------</span><br><span class="line"></span><br><span class="line">---------------------------start--------------------</span><br><span class="line">java_lock <span class="built_in">log</span>-----------PID = 398 TID = 140630884325120 </span><br><span class="line"></span><br><span class="line">--------START-----------</span><br><span class="line">--------偏向锁--------</span><br><span class="line">thread:54:000000000000000001111111111001110100010000100001101100(Dex:137335212140)</span><br><span class="line">epoch:2:00</span><br><span class="line">unused:1:0</span><br><span class="line">age:4:0001</span><br><span class="line">biased_lock:1:1</span><br><span class="line">--------END-----------</span><br><span class="line"></span><br><span class="line">java_lock <span class="built_in">log</span>-----------PID = 398 TID = 140630884325120 </span><br><span class="line"></span><br><span class="line">--------START-----------</span><br><span class="line">--------偏向锁--------</span><br><span class="line">thread:54:000000000000000001111111111001110100010000100001101100(Dex:137335212140)</span><br><span class="line">epoch:2:00</span><br><span class="line">unused:1:0</span><br><span class="line">age:4:0001</span><br><span class="line">biased_lock:1:1</span><br><span class="line">--------END-----------</span><br></pre></td></tr></table></figure>
<br />
</li>
<li><p>Thread Thread-1 return 当线程2开始的时候，线程1已结结束了，这里怀疑线程复用，因为这里不满足线程重新偏向，且线程没有重新偏向 </p>
</li>
<li><p>偏向的线程没有变化，且pthread的TID的对象头的里的信息都没有变化</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">java_lock <span class="built_in">log</span>-----------PID = 398 TID = 140630884325120 </span><br><span class="line"></span><br><span class="line">--------START-----------</span><br><span class="line">--------偏向锁--------</span><br><span class="line">thread:54:000000000000000001111111111001110100010000100001101100(Dex:137335212140)</span><br><span class="line">epoch:2:00</span><br><span class="line">unused:1:0</span><br><span class="line">age:4:0001</span><br><span class="line">biased_lock:1:1</span><br><span class="line">--------END-----------</span><br><span class="line"></span><br><span class="line">Thread Thread-1 <span class="built_in">return</span> </span><br><span class="line">java_lock <span class="built_in">log</span>-----------PID = 398 TID = 140630884325120 </span><br><span class="line"></span><br><span class="line">--------START-----------</span><br><span class="line">--------偏向锁--------</span><br><span class="line">thread:54:000000000000000001111111111001110100010000100001101100(Dex:137335212140)</span><br><span class="line">epoch:2:00</span><br><span class="line">unused:1:0</span><br><span class="line">age:4:0001</span><br><span class="line">biased_lock:1:1</span><br><span class="line">--------END-----------</span><br></pre></td></tr></table></figure>

</li>
</ul>
<h2 id="5-轻量级锁"><a href="#5-轻量级锁" class="headerlink" title="5 轻量级锁"></a>5 轻量级锁</h2><ul>
<li><p>我们让线程1放锁后，不让线程1退出</p>
</li>
<li><p>让线程2去拿锁</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">  import jnitool.JniTool;</span><br><span class="line">import org.openjdk.jol.info.ClassLayout;</span><br><span class="line"></span><br><span class="line">import java.util.ArrayList;</span><br><span class="line">import java.util.Arrays;</span><br><span class="line">import java.util.Collections;</span><br><span class="line"></span><br><span class="line">public class SyncTest &#123;</span><br><span class="line">    final Object lock = new Object();</span><br><span class="line">    JniTool jniTool = new JniTool();</span><br><span class="line"></span><br><span class="line">    public static void main(String[] args) throws InterruptedException &#123;</span><br><span class="line">        Thread.sleep(5000);</span><br><span class="line">        SyncTest <span class="built_in">test</span> = new SyncTest();</span><br><span class="line">        test.parseHeaderInfo((ClassLayout.parseInstance(test.lock).toPrintable()));</span><br><span class="line">        System.out.println(<span class="string">"---------------------------start--------------------"</span>);</span><br><span class="line">        test.start();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public void start() throws InterruptedException &#123;</span><br><span class="line">        Runnable runnable = new <span class="function"><span class="title">Runnable</span></span>() &#123;</span><br><span class="line">            @Override</span><br><span class="line">            public void <span class="function"><span class="title">run</span></span>() &#123;</span><br><span class="line">                int count = 0;</span><br><span class="line">                System.out.println(Thread.currentThread().getName() + <span class="string">" t1 start"</span>);</span><br><span class="line">                <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (count &lt; 50) &#123;</span><br><span class="line">                        count++;</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                     <span class="built_in">return</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                    lock();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line">        new Thread(runnable).start();</span><br><span class="line">        Thread.sleep(1000);//这里保证退出</span><br><span class="line">        new Thread(runnable).start();</span><br><span class="line">    &#125;</span><br><span class="line">    public void <span class="function"><span class="title">lock</span></span>() &#123;</span><br><span class="line">        synchronized (lock) &#123;</span><br><span class="line">            Class&lt;?&gt; aClass = lock.getClass();</span><br><span class="line">            jniTool.getThreadID();</span><br><span class="line">            parseHeaderInfo(ClassLayout.parseInstance(lock).toPrintable());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>线程1执行的时候，是偏向了线程1的</p>
</li>
<li><p>线程1退出，线程2来的时候，直接升级了轻量级锁</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">java_lock <span class="built_in">log</span>  PID = 61919   TID = 123145379807232 </span><br><span class="line"></span><br><span class="line">--------START-----------Thread-1</span><br><span class="line">--------偏向锁--------</span><br><span class="line">thread:54:000000000000000001111111110000101010110100010011100100(Dex:137181742308)</span><br><span class="line">epoch:2:00</span><br><span class="line">unused:1:0</span><br><span class="line">age:4:0000</span><br><span class="line">biased_lock:1:1</span><br><span class="line">--------END-----------Thread-1</span><br><span class="line"></span><br><span class="line">Thread-2 t1 start</span><br><span class="line">java_lock <span class="built_in">log</span>  PID = 61919   TID = 123145379807232 </span><br><span class="line"></span><br><span class="line">--------START-----------Thread-2</span><br><span class="line">--------轻量级锁--------</span><br><span class="line">ptr_to_lock_record:62:00000000000000000111000000000000000001001001111001111000001110 (Hex:1c0001279e0e)</span><br><span class="line">lock:2:00</span><br><span class="line">--------END-----------Thread-2</span><br><span class="line"></span><br><span class="line">java_lock <span class="built_in">log</span>  PID = 61919   TID = 123145379807232</span><br></pre></td></tr></table></figure>


</li>
</ul>
<h2 id="6-重量级锁"><a href="#6-重量级锁" class="headerlink" title="6. 重量级锁"></a>6. 重量级锁</h2><ul>
<li><p>偏向锁直接升级</p>
</li>
<li><p>2个线程，同时并发访问</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> jnitool.JniTool;</span><br><span class="line"><span class="keyword">import</span> org.openjdk.jol.info.ClassLayout;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.ArrayList;</span><br><span class="line"><span class="keyword">import</span> java.util.Arrays;</span><br><span class="line"><span class="keyword">import</span> java.util.Collections;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SyncTest</span> </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> Object lock = <span class="keyword">new</span> Object();</span><br><span class="line">    JniTool jniTool = <span class="keyword">new</span> JniTool();</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">        Thread.sleep(<span class="number">5000</span>);</span><br><span class="line">        SyncTest test = <span class="keyword">new</span> SyncTest();</span><br><span class="line">        test.parseHeaderInfo((ClassLayout.parseInstance(test.lock).toPrintable()));</span><br><span class="line">        System.out.println(<span class="string">"---------------------------start--------------------"</span>);</span><br><span class="line">        test.start();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">start</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">        Runnable runnable = <span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                <span class="keyword">int</span> count = <span class="number">0</span>;</span><br><span class="line">                System.out.println(Thread.currentThread().getName() + <span class="string">" t1 start"</span>);</span><br><span class="line">                <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (count &lt; <span class="number">50</span>) &#123;</span><br><span class="line">                        count++;</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                     <span class="keyword">return</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                    lock();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="keyword">new</span> Thread(runnable).start();</span><br><span class="line">        <span class="keyword">new</span> Thread(runnable).start();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">lock</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">synchronized</span> (lock) &#123;</span><br><span class="line">            Class&lt;?&gt; aClass = lock.getClass();</span><br><span class="line">            jniTool.getThreadID();</span><br><span class="line">            parseHeaderInfo(ClassLayout.parseInstance(lock).toPrintable());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>从可偏向状态，直接升级为重量级锁。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">--------START-----------main</span><br><span class="line">--------偏向锁--------</span><br><span class="line">thread:54:000000000000000000000000000000000000000000000000000000(Dex:0)</span><br><span class="line">epoch:2:00</span><br><span class="line">unused:1:0</span><br><span class="line">age:4:0000</span><br><span class="line">biased_lock:1:1</span><br><span class="line">--------END-----------main</span><br><span class="line"></span><br><span class="line">---------------------------start--------------------</span><br><span class="line">Thread-1 t1 start</span><br><span class="line">Thread-2 t1 start</span><br><span class="line">java_lock <span class="built_in">log</span>  PID = 61884   TID = 123145554096128 </span><br><span class="line"></span><br><span class="line">--------START-----------Thread-1</span><br><span class="line">--------重量级锁--------</span><br><span class="line">ptr_to_heavyweight_monitor::62:00000000000000000111111110101101000111010000000110001011010010 (Hex:1feb474062d2)</span><br><span class="line">lock:2:10</span><br><span class="line">--------END-----------Thread-1</span><br></pre></td></tr></table></figure>

</li>
</ul>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><ul>
<li>初始状态可能是偏向锁的可偏向状态，也可能是无锁状态</li>
<li>初始锁，若只有一个线程连续的多次访问，构成锁的偏向</li>
<li>不构成锁的重新偏向情况下，后面有多个线程轮流访问，不构成锁的竞争，锁升级到轻量级锁</li>
<li>可以有连续状态，连续锁的升级。</li>
</ul>
</div><div class="article-tags size-small is-uppercase mb-4"><span class="mr-2">#</span><a class="link-muted mr-2" rel="tag" href="/tags/Bug/">Bug</a><a class="link-muted mr-2" rel="tag" href="/tags/Java/">Java</a></div><!--!--></article></div><!--!--><nav class="post-navigation mt-4 level is-mobile"><div class="level-start"><a class="article-nav-prev level level-item link-muted" href="/2019/10/18/Java/Ubuntu%E7%BC%96%E8%AF%91glibc%E5%BA%93%E6%9D%A5%E9%AA%8C%E8%AF%81JavaSynchronized%E9%94%81%E4%BC%98%E5%8C%96/"><i class="level-item fas fa-chevron-left"></i><span class="level-item">Ubuntu编译glibc库来验证Synchronized锁优化效果</span></a></div><div class="level-end"><a class="article-nav-next level level-item link-muted" href="/2019/10/13/Java/JVM%E5%8F%82%E6%95%B0/"><span class="level-item">JVM参数</span><i class="level-item fas fa-chevron-right"></i></a></div></nav><!--!--></div><div class="column column-left is-4-tablet is-4-desktop is-2-widescreen  order-1"><div class="card widget"><div class="card-content"><nav class="level"><div class="level-item has-text-centered flex-shrink-1"><div><figure class="image is-128x128 mx-auto mb-2"><img class="is-rounded" src="/img/myavatar.png" alt="Ken"></figure><p class="title is-size-4 is-block line-height-inherit">Ken</p><p class="is-size-6 is-block">爱于心，鉴于行</p></div></div></nav><nav class="level is-mobile"><div class="level-item has-text-centered is-marginless"><div><p class="heading">文章</p><a href="/archives"><p class="title">71</p></a></div></div><div class="level-item has-text-centered is-marginless"><div><p class="heading">分类</p><a href="/categories"><p class="title">13</p></a></div></div><div class="level-item has-text-centered is-marginless"><div><p class="heading">标签</p><a href="/tags"><p class="title">16</p></a></div></div></nav></div></div><div class="card widget"><div class="card-content"><div class="menu"><h3 class="menu-label">分类</h3><ul class="menu-list"><li><a class="level is-mobile is-marginless" href="/categories/Android/"><span class="level-start"><span class="level-item">Android</span></span><span class="level-end"><span class="level-item tag">18</span></span></a><ul class="mr-0"><li><a class="level is-mobile is-marginless" href="/categories/Android/Java/"><span class="level-start"><span class="level-item">Java</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile is-marginless" href="/categories/Android/Kotlin/"><span class="level-start"><span class="level-item">Kotlin</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li></ul></li><li><a class="level is-mobile is-marginless" href="/categories/LeetCode/"><span class="level-start"><span class="level-item">LeetCode</span></span><span class="level-end"><span class="level-item tag">17</span></span></a></li><li><a class="level is-mobile is-marginless" href="/categories/%E5%88%86%E4%BA%AB/"><span class="level-start"><span class="level-item">分享</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile is-marginless" href="/categories/%E6%A1%86%E6%9E%B6/"><span class="level-start"><span class="level-item">框架</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile is-marginless" href="/categories/%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%9F%BA%E7%A1%80/"><span class="level-start"><span class="level-item">计算机基础</span></span><span class="level-end"><span class="level-item tag">3</span></span></a></li><li><a class="level is-mobile is-marginless" href="/categories/%E8%AF%AD%E8%A8%80%E5%9F%BA%E7%A1%80/"><span class="level-start"><span class="level-item">语言基础</span></span><span class="level-end"><span class="level-item tag">26</span></span></a><ul class="mr-0"><li><a class="level is-mobile is-marginless" href="/categories/%E8%AF%AD%E8%A8%80%E5%9F%BA%E7%A1%80/C/"><span class="level-start"><span class="level-item">C++</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile is-marginless" href="/categories/%E8%AF%AD%E8%A8%80%E5%9F%BA%E7%A1%80/Java/"><span class="level-start"><span class="level-item">Java</span></span><span class="level-end"><span class="level-item tag">21</span></span></a></li><li><a class="level is-mobile is-marginless" href="/categories/%E8%AF%AD%E8%A8%80%E5%9F%BA%E7%A1%80/Kotlin/"><span class="level-start"><span class="level-item">Kotlin</span></span><span class="level-end"><span class="level-item tag">3</span></span></a></li></ul></li><li><a class="level is-mobile is-marginless" href="/categories/%E9%97%AE%E9%A2%98%E4%B8%8E%E7%BB%8F%E9%AA%8C/"><span class="level-start"><span class="level-item">问题与经验</span></span><span class="level-end"><span class="level-item tag">3</span></span></a></li><li><a class="level is-mobile is-marginless" href="/categories/%E9%A1%B9%E7%9B%AE%E6%9E%B6%E6%9E%84/"><span class="level-start"><span class="level-item">项目架构</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li></ul></div></div></div><div class="card widget"><div class="card-content"><h3 class="menu-label">最新文章</h3><article class="media"><div class="media-content size-small"><p><time dateTime="2023-12-02T10:19:06.000Z">2023-12-02</time></p><p class="title is-6"><a class="link-muted" href="/2023/12/02/Android/android_import_rust/">Android项目接入Rust</a></p><p class="is-uppercase"><a class="link-muted" href="/categories/Android/">Android</a></p></div></article><article class="media"><div class="media-content size-small"><p><time dateTime="2023-11-07T09:30:35.000Z">2023-11-07</time></p><p class="title is-6"><a class="link-muted" href="/2023/11/07/Android/kotlin_name_dup/">Kotlin的变量重名问题</a></p><p class="is-uppercase"><a class="link-muted" href="/categories/%E8%AF%AD%E8%A8%80%E5%9F%BA%E7%A1%80/">语言基础</a> / <a class="link-muted" href="/categories/%E8%AF%AD%E8%A8%80%E5%9F%BA%E7%A1%80/Kotlin/">Kotlin</a></p></div></article><article class="media"><div class="media-content size-small"><p><time dateTime="2023-10-14T10:09:12.000Z">2023-10-14</time></p><p class="title is-6"><a class="link-muted" href="/2023/10/14/Android/kotlin_android_init_no_method/">小心Kotlin下的构造函数NoSuchMethodException</a></p><p class="is-uppercase"><a class="link-muted" href="/categories/Android/">Android</a> / <a class="link-muted" href="/categories/Android/Kotlin/">Kotlin</a></p></div></article><article class="media"><div class="media-content size-small"><p><time dateTime="2023-09-09T08:44:08.000Z">2023-09-09</time></p><p class="title is-6"><a class="link-muted" href="/2023/09/09/Android/seq_point_trace_report/">一种事件流埋点的实现方案</a></p><p class="is-uppercase"><a class="link-muted" href="/categories/%E9%97%AE%E9%A2%98%E4%B8%8E%E7%BB%8F%E9%AA%8C/">问题与经验</a></p></div></article><article class="media"><div class="media-content size-small"><p><time dateTime="2023-08-12T07:45:13.000Z">2023-08-12</time></p><p class="title is-6"><a class="link-muted" href="/2023/08/12/Android/compose_inspector/">解决 Compose Layout Inspector 不能用</a></p><p class="is-uppercase"><a class="link-muted" href="/categories/Android/">Android</a></p></div></article></div></div><div class="card widget"><div class="card-content"><div class="menu"><h3 class="menu-label">标签</h3><div class="field is-grouped is-grouped-multiline"><div class="control"><a class="tags has-addons" href="/tags/Android/"><span class="tag">Android</span><span class="tag is-grey-lightest">14</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Bug/"><span class="tag">Bug</span><span class="tag is-grey-lightest">10</span></a></div><div class="control"><a class="tags has-addons" href="/tags/C/"><span class="tag">C++</span><span class="tag is-grey-lightest">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Compose/"><span class="tag">Compose</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Gradle/"><span class="tag">Gradle</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/JNI/"><span class="tag">JNI</span><span class="tag is-grey-lightest">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Java/"><span class="tag">Java</span><span class="tag is-grey-lightest">23</span></a></div><div class="control"><a class="tags has-addons" href="/tags/K8S/"><span class="tag">K8S</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Kotlin/"><span class="tag">Kotlin</span><span class="tag is-grey-lightest">4</span></a></div><div class="control"><a class="tags has-addons" href="/tags/LeetCode/"><span class="tag">LeetCode</span><span class="tag is-grey-lightest">17</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Rust/"><span class="tag">Rust</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Spark/"><span class="tag">Spark</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E5%88%86%E4%BA%AB/"><span class="tag">分享</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E5%AE%89%E8%A3%85/"><span class="tag">安装</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/"><span class="tag">操作系统</span><span class="tag is-grey-lightest">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E8%AE%A1%E7%BB%84/"><span class="tag">计组</span><span class="tag is-grey-lightest">1</span></a></div></div></div></div></div><div class="column-right-shadow is-hidden-widescreen is-sticky"></div></div><div class="column column-right is-4-tablet is-4-desktop is-2-widescreen is-hidden-touch is-hidden-desktop-only order-3 is-sticky"><div class="card widget toc-scroll" id="toc"><div class="card-content"><div class="menu" style="max-height: 600px; overflow: auto;"><h3 class="menu-label">目录</h3><ul class="menu-list toc"><li><a class="is-flex toc-item" id="toc-item-1-前言" href="#1-前言"><span>1.前言</span></a><ul class="menu-list toc"><li><a class="is-flex toc-item" id="toc-item-int-pthread-mutex-lock-pthread-mutex-t-mutex" href="#int-pthread-mutex-lock-pthread-mutex-t-mutex"><span>int pthread_mutex_lock(pthread_mutex_t *mutex);</span></a></li><li><a class="is-flex toc-item" id="toc-item-ThreadCritical-ThreadCritical" href="#ThreadCritical-ThreadCritical"><span>ThreadCritical::ThreadCritical</span></a></li></ul></li><li><a class="is-flex toc-item" id="toc-item-" href="#"><span> </span></a></li><li><a class="is-flex toc-item" id="toc-item-2-验证准备" href="#2-验证准备"><span>2.验证准备</span></a><ul class="menu-list toc"><li><a class="is-flex toc-item" id="toc-item-JniTool-java" href="#JniTool-java"><span>JniTool.java</span></a></li><li><a class="is-flex toc-item" id="toc-item-生成-h文件，javah-jni-jnitool-JniTool" href="#生成-h文件，javah-jni-jnitool-JniTool"><span>生成.h文件，javah -jni jnitool.JniTool</span></a></li><li><a class="is-flex toc-item" id="toc-item-使用make编译" href="#使用make编译"><span>使用make编译</span></a></li><li><a class="is-flex toc-item" id="toc-item-对象头信息-object-header-关闭指针压缩-XX-UseCompressedOops" href="#对象头信息-object-header-关闭指针压缩-XX-UseCompressedOops"><span>对象头信息 object header 关闭指针压缩 -XX:-UseCompressedOops</span></a></li></ul></li><li><a class="is-flex toc-item" id="toc-item-3-无锁" href="#3-无锁"><span>3.无锁</span></a></li><li><a class="is-flex toc-item" id="toc-item-4-偏向锁" href="#4-偏向锁"><span>4 偏向锁</span></a></li><li><a class="is-flex toc-item" id="toc-item-5-轻量级锁" href="#5-轻量级锁"><span>5 轻量级锁</span></a></li><li><a class="is-flex toc-item" id="toc-item-6-重量级锁" href="#6-重量级锁"><span>6. 重量级锁</span></a></li><li><a class="is-flex toc-item" id="toc-item-总结" href="#总结"><span>总结</span></a></li></ul></div></div><script type="text/javascript" async>
        $(document).ready(function () { //参考自 https://github.com/ppoffice/hexo-theme-icarus/pull/616/files
            var observerTopMargin;
            var scrollObserver;
            var headerElems = $(".headerlink");
            var activeTocItem;
        
            function initIntersectionObserver(docHeight) {
                observerTopMargin = docHeight;
                scrollObserver = new IntersectionObserver(scrollCallBack,
                    {
                        root: null,  // viewpoint
                        rootMargin: docHeight + "px 0px -80% 0px"  // cover top 30% of viewport to the top of document
                    })
            }
        
            function scrollCallBack(entries, observer) {
                if ($(window).scrollTop() > observerTopMargin * 0.7) { 
                    // User somehow scroll to 70% of observerTopMargin (which is inited as 200% document height)
                    // Observer top margin need to extend to cover all the space to the top of the document
                    initIntersectionObserver(observerTopMargin * 2)
                    observer.disconnect();
                    return;
                }
                let toActive;
                if (entries[0].intersectionRatio == 1) {  // enter viewed area
                    let entry = entries.reduce((u, v) => (u.target.toc_id > v.target.toc_id ? u : v));  // get the lowest item
                    toActive = $("#toc-item-" + $(entry.target).attr("href").substr(1));
                } else {
                    let entry = entries.reduce((u, v) => (u.target.toc_id < v.target.toc_id ? u : v));  // get the highest item
                    let idx = Math.max(entry.target.toc_id - 1, 0);
                    toActive = $("#toc-item-" + $(headerElems[idx]).attr("href").substr(1));
                }
                if (activeTocItem) activeTocItem.removeClass("is-current");
                activeTocItem = toActive
                activeTocItem.addClass("is-current");
            }
        
            initIntersectionObserver($(document).height() * 2);
            headerElems.each(function (index, obj) {
                obj.toc_id = index;
                scrollObserver.observe(obj);
            })
        });</script></div></div></div></div></section><footer class="footer"><div class="container"><div class="level"><div class="level-start"><a class="footer-logo is-block mb-2" href="/"><img src="/img/logo.png" alt="Keeplooking" height="28"></a><p class="size-small"><span>&copy; 2019 - 2024  Ken Chan</span>  </p></div><div class="level-end"><div class="field has-addons"><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Creative Commons" href="https://creativecommons.org/"><i class="fab fa-creative-commons"></i></a></p><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Attribution 4.0 International" href="https://creativecommons.org/licenses/by/4.0/"><i class="fab fa-creative-commons-by"></i></a></p><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Fllow GitHub" href="https://github.com/kaiattrib"><i class="fab fa-github"></i></a></p></div></div></div></div></footer><script src="https://cdnjs.loli.net/ajax/libs/jquery/3.3.1/jquery.min.js"></script><script src="https://cdnjs.loli.net/ajax/libs/moment.js/2.22.2/moment-with-locales.min.js"></script><script>moment.locale("zh-CN");</script><script>var IcarusThemeSettings = {
            site: {
                url: 'http://yoursite.com',
                external_link: {"enable":true,"exclude":[]}
            },
            article: {
                highlight: {
                    clipboard: true,
                    fold: 'unfolded'
                }
            }
        };</script><script src="https://cdnjs.loli.net/ajax/libs/clipboard.js/2.0.4/clipboard.min.js" defer></script><script src="/js/animation.js"></script><a id="back-to-top" title="回到顶端" href="javascript:;"><i class="fas fa-chevron-up"></i></a><script src="/js/back_to_top.js" defer></script><!--!--><script src="https://cdnjs.loli.net/ajax/libs/lightgallery/1.6.8/js/lightgallery.min.js" defer></script><script src="https://cdnjs.loli.net/ajax/libs/justifiedGallery/3.7.0/js/jquery.justifiedGallery.min.js" defer></script><script>window.addEventListener("load", () => {
            if (typeof $.fn.lightGallery === 'function') {
                $('.article').lightGallery({ selector: '.gallery-item' });
            }
            if (typeof $.fn.justifiedGallery === 'function') {
                if ($('.justified-gallery > p > .gallery-item').length) {
                    $('.justified-gallery > p > .gallery-item').unwrap();
                }
                $('.justified-gallery').justifiedGallery();
            }
        });</script><!--!--><!--!--><script src="/js/main.js" defer></script><div class="searchbox"><div class="searchbox-container"><div class="searchbox-header"><div class="searchbox-input-container"><input class="searchbox-input" type="text" placeholder="想要查找什么..."></div><a class="searchbox-close" href="javascript:;">×</a></div><div class="searchbox-body"></div></div></div><script src="/js/insight.js" defer></script><script>document.addEventListener('DOMContentLoaded', function () {
            loadInsight({"contentUrl":"/content.json"}, {"hint":"想要查找什么...","untitled":"(无标题)","posts":"文章","pages":"页面","categories":"分类","tags":"标签"});
        });</script></body></html>