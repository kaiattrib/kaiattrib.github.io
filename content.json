{"pages":[{"title":"å…³äº","text":"å†™æœ¬åšå®¢çš„åˆå¿ƒ ä¸€ä¸ºå¤‡å¿˜ï¼Œæ„Ÿè§‰è‡ªå·±å¾ˆå¥å¿˜ äºŒä¸ºæ¢ç´¢ï¼Œæ¢ç´¢æŠ€æœ¯å®½åº¦ä¸æ·±åº¦ ä¸‰ä¸ºåˆ†äº«ï¼Œå¹¸äºæœ‰å¸®åŠ©åˆ°åˆ«äºº æ¬¢è¿æŒ‡æ•™","link":"/comments/index.html"},{"title":"ç§è‰è®¡åˆ’","text":"è¿‡ç¨‹åŒæ ·é‡è¦ gradleé¡¹ç›®ç®¡ç† è®¾è®¡æ¨¡å¼$$","link":"/suibi/studyplan.html"},{"title":"éšç¬”ï¼ŒæŠ€æœ¯ä¹‹å¤–","text":"But I donâ€™t know enough, I get some kinda of lazy day ç§è‰è®¡åˆ’ &nbsp;&nbsp;&nbsp;&nbsp;æœ€è¿‘æ‘Šäº†ä¸€æ®µæ—¶é—´ï¼Œæ²¡æœ‰æ‰¾åˆ°å­¦ä¹ çš„æ–¹å‘ï¼Œç»™è‡ªå·±ç«‹ä¸ªFlagï¼Œè¾“å‡ºå­¦ä¹ ç¬”è®°ï¼Œåå‘åº•å±‚ï¼Œé€šç”¨çš„æŠ€æœ¯ã€‚ é˜…è¯»æ›´å¤š","link":"/suibi/suibi.html"}],"posts":[{"title":"Android å¹½çµè®¾å¤‡ emulator-5554 offline","text":"é‡åˆ°çš„é—®é¢˜ï¼šadb devices å‡ºç°äº†ä¸ª emulator-5554è®¾ç½®ï¼Œå¯¼è‡´æ’å…¥å®‰å“è®¾å¤‡çš„æ—¶å€™ï¼Œæ‰§è¡Œå‘½ä»¤ç»å¸¸é‡åˆ° more than one devicesé”™è¯¯ã€‚ æ’æŸ¥è¿‡ç¨‹ï¼šåœ¨stackoverflowä¸Šæ‰¾äº†ä¸‹ï¼Œå…ˆå°è¯•å…³é—­äº†æ‰€æœ‰æ¨¡æ‹Ÿå™¨ï¼Œéƒ½é‡å¯äº†å¥½å¤šæ¬¡ï¼Œè¿˜æ˜¯æ²¡æ•ˆæœï¼Œæ’é™¤äº†æ˜¯æ¨¡æ‹Ÿå™¨æé¬¼ã€‚äºæ˜¯æŒ‰ç…§ç½‘ä¸Šæ‰¾åˆ°æŸ¥æ‰¾5555ç«¯å£çš„ç¨‹åºï¼Œnetstate å’Œ lsof è¿‡æ»¤ä¸‹5555ç«¯å£ï¼Œå®šä½ä¸‹pidï¼Œæœ€åhtopé‡Œé¢å»æŸ¥pidï¼ŒæŸ¥åˆ°æ˜¯æˆ‘ä¹‹å‰å®‰è£…çš„ä¸€ä¸ªæ’ä»¶å¯¼è‡´çš„ã€‚åœ¨æˆ‘çš„macä¸Šé¢tabnineæ’ä»¶é»˜è®¤å ç”¨äº†5555ç«¯å£ï¼Œå¯¼è‡´adbè®¤ä¸ºæ˜¯ä¸ªæ¨¡æ‹Ÿå™¨ï¼Œä¸€ç›´åœ¨å°è¯•é“¾æ¥ã€‚æ‰¾åˆ°ä¸€ç¯‡æ–‡æ¡£http://t.zoukankan.com/jiangu66-p-3184790.html adb å¯åŠ¨å°±è¿æ¥5555ç«¯å£ ä¸ºä½•è¿æ¥å« emulator-5554 è€Œä¸æ˜¯ emulator-5555ï¼Ÿè¿™æ˜¯å› ä¸ºç¼ºçœemulatorçš„ console ç«¯å£æ˜¯ 5554 ( åº”è¯¥å¯ä»¥ç”¨ telnet è¿æ¥ä¸ emulator äº¤äº’(è¿˜æ²¡æœ‰è¯•éªŒ)) , è€Œadb çš„ç«¯å£æ˜¯consoleç«¯å£ +1 å°±æ˜¯ 5555 åé¢å»tabbnieçš„githubä¸Šçœ‹äº†çœ‹ï¼ŒåŸæ¥ä¹‹å‰å°±æœ‰äººé‡åˆ°è¿‡è¿™ä¸ªé—®é¢˜ https://github.com/codota/TabNine/issues/422 (Why bind port on 5555)ï¼Œtabbnieåé¢ä¹Ÿæä¾›äº†ä¿®æ”¹ç«¯å£çš„æ¥å£ï¼ŒUnder tabnine_config.json, set tabnine_hub_port è§£å†³æ–¹æ¡ˆ:ä¿®æ”¹tabbnieçš„é…ç½®æ–‡ä»¶ tabnine_config.jsoné‡Œé¢çš„tabnine_hub_port é»˜è®¤ç«¯å£ï¼Œä¾‹å¦‚4555ã€‚å¦‚æœä½ æ‰¾ä¸åˆ°tabnine_configï¼Œè¯·æœç´¢ã€‚","link":"/2022/11/20/Android/android-emulator-5554/"},{"title":"JNIä¸ºä»€ä¹ˆè¦è°ƒç”¨AttachCurrentThreadï¼Ÿ","text":"æˆ‘ä»¬å†™JNIçš„æ—¶å€™ï¼Œé€šå¸¸è¦é€šè¿‡ å¦‚æœéœ€è¦åè°ƒjavaå±‚çš„ä»£ç ï¼Œæ˜¯éœ€è¦é€šè¿‡jvm-&gt;AttachCurrentThread å°†å½“å‰çº¿ç¨‹æ³¨å†Œåˆ°è™šæ‹Ÿæœºä¸­ï¼Œä¸ºä»€ä¹ˆä¸€å®šè¦è°ƒç”¨è¿™ä¸ªæ–¹æ³•å‘¢ï¼Ÿæˆ‘ä»¬è¿½ä¸€ä¸‹è¿™ä¸ªæ–¹æ³•é‡Œé¢åˆ°åº•åšäº†ä»€ä¹ˆï¼Ÿ JNI AttachCurrentThread é‡‡ç”¨çš„ART debugã€‚æ‰€æœ‰æ–¹æ³•é‡Œé¢çš„ä»£ç å‡æœ‰çœç•¥ï¼Œå¹¶ä¸æ˜¯å…¨éƒ¨ä»£ç  æˆ‘ä»¬å¯ä»¥åœ¨ jni.hï¼Œæ‰¾åˆ°æ”¹æ–¹æ³•çš„å£°æ˜ 123jint AttachCurrentThread(JNIEnv **p_env, void *thr_args) { return functions-&gt;AttachCurrentThread(this, p_env, thr_args);} å…·ä½“å®ç°å°±è¦è½¬åˆ°runtimeäº† ç»§ç»­æ‰¾ art/runtime/check_jni.cc çš„å®ç° 12345678910static jint AttachCurrentThread(JavaVM* vm, JNIEnv** p_env, void* thr_args) { ScopedCheck sc(kFlag_Invocation, __FUNCTION__); JniValueType args[3] = {{.v = vm}, {.p = p_env}, {.p = thr_args}}; sc.CheckNonHeap(reinterpret_cast&lt;JavaVMExt*&gt;(vm), true, \"vpp\", args); JniValueType result; //è¿™é‡Œè½¬åˆ° result.i = BaseVm(vm)-&gt;AttachCurrentThread(vm, p_env, thr_args); sc.CheckNonHeap(reinterpret_cast&lt;JavaVMExt*&gt;(vm), false, \"i\", &amp;result); return result.i;} ç»§ç»­è¿½ BaseVm(vm)-&gt;AttachCurrentThread åœ¨ art/runtime/java_vm_ext.cc ä¸­æ‰¾åˆ° å®ç° 12345678910111213141516171819202122232425262728293031323334353637383940414243444546 static jint AttachCurrentThreadInternal(JavaVM* vm, JNIEnv** p_env, void* raw_args, bool as_daemon) { if (vm == nullptr || p_env == nullptr) { return JNI_ERR; } // Return immediately if we're already attached. Thread* self = Thread::Current(); if (self != nullptr) { *p_env = self-&gt;GetJniEnv(); return JNI_OK; } Runtime* runtime = reinterpret_cast&lt;JavaVMExt*&gt;(vm)-&gt;GetRuntime(); // No threads allowed in zygote mode. if (runtime-&gt;IsZygote()) { LOG(ERROR) &lt;&lt; \"Attempt to attach a thread in the zygote\"; return JNI_ERR; } JavaVMAttachArgs* args = static_cast&lt;JavaVMAttachArgs*&gt;(raw_args); const char* thread_name = nullptr; jobject thread_group = nullptr; if (args != nullptr) { if (JavaVMExt::IsBadJniVersion(args-&gt;version)) { LOG(ERROR) &lt;&lt; \"Bad JNI version passed to \" &lt;&lt; (as_daemon ? \"AttachCurrentThreadAsDaemon\" : \"AttachCurrentThread\") &lt;&lt; \": \" &lt;&lt; args-&gt;version; return JNI_EVERSION; } thread_name = args-&gt;name; thread_group = args-&gt;group; } //è¿™é‡ŒçœŸå®çš„è°ƒç”¨äº† runtime-&gt;AttachCurrentThread if (!runtime-&gt;AttachCurrentThread(thread_name, as_daemon, thread_group, !runtime-&gt;IsAotCompiler())) { *p_env = nullptr; return JNI_ERR; } else { //å¦‚æœæˆåŠŸ *p_env = Thread::Current()-&gt;GetJniEnv(); return JNI_OK; } }}; ç»§ç»­æ‰¾ runtime-&gt;AttachCurrentThread art/runtime/runtime.cc 123456789101112 bool Runtime::AttachCurrentThread(const char* thread_name, bool as_daemon, jobject thread_group, bool create_peer) { ScopedTrace trace(__FUNCTION__); //å®é™…ä¸Šæœ€ç»ˆæ˜¯åœ¨è¿™é‡Œï¼Œåœ¨JVMå±‚é¢åŒ…è£…æˆäº†ä¸€ä¸ª JVM çš„ Threadï¼Œç„¶åå†è¿”å› Thread* self = Thread::Attach(thread_name, as_daemon, thread_group, create_peer); // Run ThreadGroup.add to notify the group that this thread is now started. if (self != nullptr &amp;&amp; create_peer &amp;&amp; !IsAotCompiler()) { ScopedObjectAccess soa(self); self-&gt;NotifyThreadGroup(soa, thread_group); } return self != nullptr;} ç»§ç»­å†è¿½ä¸€ä¸‹ Thread::Attachçš„å®ç° 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758 Thread* Thread::Attach(const char* thread_name, bool as_daemon, PeerAction peer_action) { Runtime* runtime = Runtime::Current(); if (runtime == nullptr) { LOG(ERROR) &lt;&lt; \"Thread attaching to non-existent runtime: \" &lt;&lt; ((thread_name != nullptr) ? thread_name : \"(Unnamed)\"); return nullptr; } Thread* self; { MutexLock mu(nullptr, *Locks::runtime_shutdown_lock_); if (runtime-&gt;IsShuttingDownLocked()) { LOG(WARNING) &lt;&lt; \"Thread attaching while runtime is shutting down: \" &lt;&lt; ((thread_name != nullptr) ? thread_name : \"(Unnamed)\"); return nullptr; } else { //å¼€å§‹åˆå§‹åŒ– Runtime::Current()-&gt;StartThreadBirth(); self = new Thread(as_daemon); //è¿™é‡Œè¿›è¡Œäº†åˆå§‹åŒ– bool init_success = self-&gt;Init(runtime-&gt;GetThreadList(), runtime-&gt;GetJavaVM()); //ç»“æŸ Runtime::Current()-&gt;EndThreadBirth(); if (!init_success) { delete self; return nullptr; } } } self-&gt;InitStringEntryPoints(); CHECK_NE(self-&gt;GetState(), kRunnable); self-&gt;SetState(kNative); // Run the action that is acting on the peer. if (!peer_action(self)) { runtime-&gt;GetThreadList()-&gt;Unregister(self); // Unregister deletes self, no need to do this here. return nullptr; } if (VLOG_IS_ON(threads)) { if (thread_name != nullptr) { VLOG(threads) &lt;&lt; \"Attaching thread \" &lt;&lt; thread_name; } else { VLOG(threads) &lt;&lt; \"Attaching unnamed thread.\"; } ScopedObjectAccess soa(self); self-&gt;Dump(LOG_STREAM(INFO)); } { ScopedObjectAccess soa(self); runtime-&gt;GetRuntimeCallbacks()-&gt;ThreadStart(self); } return self;} è½¬æ¥åˆ° init 12345678910111213141516171819202122232425 bool Thread::Init(ThreadList* thread_list, JavaVMExt* java_vm, JNIEnvExt* jni_env_ext) { //è¯¥å‡½æ•°æ‰§è¡Œæ‰€æœ‰å¿…é¡»ç”±å…¶åº”ç”¨çš„æœ¬æœºçº¿ç¨‹è¿è¡Œçš„åˆå§‹åŒ– //å½“æˆ‘ä»¬ä»managed code åˆ›å»ºæ–°çº¿ç¨‹æ—¶ï¼Œåœ¨Thread :: Createä¸­åˆ†é…Thread *ï¼Œè¿™æ ·å¯ä»¥åœ¨å‡†å¤‡å¥½æ—¶ä¸ç›¸åº”çš„æœ¬æœºçº¿ç¨‹æ¡æ‰‹ CHECK(Thread::Current() == nullptr); //å°†pthread_self_è®¾ç½®åœ¨pthread_setspecificä¹‹å‰ï¼Œ tlsPtr_.pthread_self = pthread_self(); CHECK(is_started_); //å„ç§init InitCpu(); InitTlsEntryPoints(); RemoveSuspendTrigger(); InitCardTable(); InitTid(); interpreter::InitInterpreterTls(this); //å„ç§CHECK //æŠŠå½“å‰çº¿ç¨‹æ³¨å†Œï¼Œå®é™…å°±æ˜¯pushåˆ°thread_list thread_list-&gt;Register(this); //ç›´æ¥return true return true;} å¯ä»¥çœ‹åˆ° ThreadList::Register(Thread* self) 1234567891011121314151617181920212223 void ThreadList::Register(Thread* self) { //çœç•¥ä¸çœ‹ //ä»¥åŸå­æ–¹å¼å°†selfæ·»åŠ åˆ°çº¿ç¨‹åˆ—è¡¨ MutexLock mu(self, *Locks::thread_list_lock_); MutexLock mu2(self, *Locks::thread_suspend_count_lock_); CHECK_GE(suspend_all_count_, debug_suspend_all_count_); for (int delta = debug_suspend_all_count_; delta &gt; 0; delta--) { bool updated = self-&gt;ModifySuspendCount(self, +1, nullptr, SuspendReason::kForDebugger); DCHECK(updated); } for (int delta = suspend_all_count_ - debug_suspend_all_count_; delta &gt; 0; delta--) { bool updated = self-&gt;ModifySuspendCount(self, +1, nullptr, SuspendReason::kInternal); DCHECK(updated); } CHECK(!Contains(self)); //åŠ å…¥ list_.push_back(self); //çœç•¥ä¸çœ‹} Javaå±‚çš„Threadåˆå§‹åŒ–,ä»¥åŠæ˜¯æ€ä¹ˆå¯åŠ¨çš„ï¼Ÿæˆ‘ä»¬åœ¨javaå±‚é¢new thread çš„æ—¶å€™ï¼Œå°±ä¼šåœ¨jvmå±‚é¢å¯¹åº”ä¸€ä¸ªThreadï¼Œä¹Ÿä¼šåšå¾ˆå¤šå’Œnativeç›¸å…³çš„åˆå§‹åŒ–ã€‚Android Threadåšäº†äº›æ”¹åŠ¨æ˜¯åœ¨çº¿ç¨‹startçš„æ—¶å€™ï¼Œæˆ‘ä»¬ä»¥Androidçš„ä¸ºåˆ— 123456// Android-changed: Use Android specific nativeCreate() method to create/start thread. // The upstream native method start0() only takes a reference to this object and so must obtain // the stack size and daemon status directly from the field whereas Android supplies the values // explicitly on the method call. // private native void start0(); private native static void nativeCreate(Thread t, long stackSize, boolean daemon); å¯¹åº”åˆ°native art/runtime/native/java_lang_Thread.cc å®ç° 1234567891011121314 static void Thread_nativeCreate(JNIEnv* env, jclass, jobject java_thread, jlong stack_size, jboolean daemon) { // æ£€æŸ¥ // There are sections in the zygote that forbid thread creation. Runtime* runtime = Runtime::Current(); if (runtime-&gt;IsZygote() &amp;&amp; runtime-&gt;IsZygoteNoThreadSection()) { jclass internal_error = env-&gt;FindClass(\"java/lang/InternalError\"); CHECK(internal_error != nullptr); env-&gt;ThrowNew(internal_error, \"Cannot create threads in zygote\"); return; } //è¿™é‡Œå»åˆ›å»º Thread::CreateNativeThread(env, java_thread, stack_size, daemon == JNI_TRUE);} é‡è¦çš„å®ç°å°±æ˜¯åœ¨CreateNativeThreadé‡Œé¢äº† 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859606162636465666768697071 void Thread::CreateNativeThread(JNIEnv* env, jobject java_peer, size_t stack_size, bool is_daemon) { CHECK(java_peer != nullptr); Thread* self = static_cast&lt;JNIEnvExt*&gt;(env)-&gt;GetSelf(); //çœç•¥CHECK Runtime* runtime = Runtime::Current(); //ä»¥åŸå­æ–¹å¼å¯åŠ¨çº¿ç¨‹çš„è¯ç”Ÿ bool thread_start_during_shutdown = false; { MutexLock mu(self, *Locks::runtime_shutdown_lock_); if (runtime-&gt;IsShuttingDownLocked()) { thread_start_during_shutdown = true; } else { //ç†Ÿæ‚‰çš„çº¿ç¨‹åˆå§‹åŒ– StartThreadBirth( runtime-&gt;StartThreadBirth(); // é‚£ä¹ˆend å‘¢ï¼Ÿï¼Ÿï¼Ÿï¼Ÿ } } if (thread_start_during_shutdown) { ScopedLocalRef&lt;jclass&gt; error_class(env, env-&gt;FindClass(\"java/lang/InternalError\")); env-&gt;ThrowNew(error_class.get(), \"Thread starting during runtime shutdown\"); return; } Thread* child_thread = new Thread(is_daemon); // Use global JNI ref to hold peer live while child thread starts. child_thread-&gt;tlsPtr_.jpeer = env-&gt;NewGlobalRef(java_peer); stack_size = FixStackSize(stack_size); // æ”¹å˜ nativePeer // Thread.start is synchronized, so we know that nativePeer is 0, and know that we're not racing // to assign it. env-&gt;SetLongField(java_peer, WellKnownClasses::java_lang_Thread_nativePeer, reinterpret_cast&lt;jlong&gt;(child_thread)); // Try to allocate a JNIEnvExt for the thread. We do this here as we might be out of memory and // do not have a good way to report this on the child's side. std::string error_msg; std::unique_ptr&lt;JNIEnvExt&gt; child_jni_env_ext( JNIEnvExt::Create(child_thread, Runtime::Current()-&gt;GetJavaVM(), &amp;error_msg)); int pthread_create_result = 0; if (child_jni_env_ext.get() != nullptr) { pthread_t new_pthread; pthread_attr_t attr; child_thread-&gt;tlsPtr_.tmp_jni_env = child_jni_env_ext.get(); CHECK_PTHREAD_CALL(pthread_attr_init, (&amp;attr), \"new thread\"); CHECK_PTHREAD_CALL(pthread_attr_setdetachstate, (&amp;attr, PTHREAD_CREATE_DETACHED), \"PTHREAD_CREATE_DETACHED\"); CHECK_PTHREAD_CALL(pthread_attr_setstacksize, (&amp;attr, stack_size), stack_size); //çœ‹åˆ°æ²¡æœ‰ï¼Œè¿™é‡Œå¯¹åº”äº†ä¸€ä¸ªpthread_createï¼Œæ˜¯åœ¨JAVAå±‚è°ƒç”¨thread startåˆ›å»º pthread_create_result = pthread_create(&amp;new_pthread, &amp;attr, Thread::CreateCallback,//çº¿ç¨‹å¯åŠ¨æ‰§è¡Œçš„å‡½æ•° child_thread); CHECK_PTHREAD_CALL(pthread_attr_destroy, (&amp;attr), \"new thread\"); //åˆ›å»ºæˆåŠŸ if (pthread_create_result == 0) { // pthread_create started the new thread. The child is now responsible for managing the // JNIEnvExt we created. // Note: we can't check for tmp_jni_env == nullptr, as that would require synchronization // between the threads. child_jni_env_ext.release(); return; } } //å…¶å®ƒåˆ›å»ºå¤±è´¥çš„æƒ…å†µ} Runtime::Current()-&gt;EndThreadBirth();åœ¨Thread::CreateCallback,é‡Œé¢ æ‰€ä»¥pthreadå¯åŠ¨åï¼Œæ‰æ˜¯EndThreadBirth() 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950 void* Thread::CreateCallback(void* arg) { Thread* self = reinterpret_cast&lt;Thread*&gt;(arg); Runtime* runtime = Runtime::Current(); if (runtime == nullptr) { LOG(ERROR) &lt;&lt; \"Thread attaching to non-existent runtime: \" &lt;&lt; *self; return nullptr; } { // TODO: pass self to MutexLock - requires self to equal Thread::Current(), which is only true // after self-&gt;Init(). MutexLock mu(nullptr, *Locks::runtime_shutdown_lock_); // Check that if we got here we cannot be shutting down (as shutdown should never have started // while threads are being born). CHECK(!runtime-&gt;IsShuttingDownLocked()); // Note: given that the JNIEnv is created in the parent thread, the only failure point here is // a mess in InitStackHwm. We do not have a reasonable way to recover from that, so abort // the runtime in such a case. In case this ever changes, we need to make sure here to // delete the tmp_jni_env, as we own it at this point. CHECK(self-&gt;Init(runtime-&gt;GetThreadList(), runtime-&gt;GetJavaVM(), self-&gt;tlsPtr_.tmp_jni_env)); self-&gt;tlsPtr_.tmp_jni_env = nullptr; //è¿™é‡Œend Runtime::Current()-&gt;EndThreadBirth(); } { ScopedObjectAccess soa(self); self-&gt;InitStringEntryPoints(); // Copy peer into self, deleting global reference when done. CHECK(self-&gt;tlsPtr_.jpeer != nullptr); self-&gt;tlsPtr_.opeer = soa.Decode&lt;mirror::Object&gt;(self-&gt;tlsPtr_.jpeer).Ptr(); self-&gt;GetJniEnv()-&gt;DeleteGlobalRef(self-&gt;tlsPtr_.jpeer); self-&gt;tlsPtr_.jpeer = nullptr; self-&gt;SetThreadName(self-&gt;GetThreadName()-&gt;ToModifiedUtf8().c_str()); ArtField* priorityField = jni::DecodeArtField(WellKnownClasses::java_lang_Thread_priority); self-&gt;SetNativePriority(priorityField-&gt;GetInt(self-&gt;tlsPtr_.opeer)); runtime-&gt;GetRuntimeCallbacks()-&gt;ThreadStart(self); // Invoke the 'run' method of our java.lang.Thread. çœŸå®è°ƒç”¨thread çš„ run æ–¹æ³• ObjPtr&lt;mirror::Object&gt; receiver = self-&gt;tlsPtr_.opeer; jmethodID mid = WellKnownClasses::java_lang_Thread_run; ScopedLocalRef&lt;jobject&gt; ref(soa.Env(), soa.AddLocalReference&lt;jobject&gt;(receiver)); InvokeVirtualOrInterfaceWithJValues(soa, ref.get(), mid, nullptr); } // Detach and delete self. è¿™é‡Œæ˜¯è§£æ³¨å†Œ Runtime::Current()-&gt;GetThreadList()-&gt;Unregister(self); return nullptr;} ç®€å•æ€»ç»“ æˆ‘ä»¬é€šè¿‡javaThread åˆ›å»ºçº¿ç¨‹çš„æ—¶å€™ï¼ŒJVMä¼šåŒ…è£…æˆä¸€ä¸ªJVMçš„Threadï¼Œç„¶åå¯åŠ¨pthreadï¼Œè°ƒç”¨runæ–¹æ³•ï¼Œä½†æˆ‘ä»¬é€šè¿‡pthreadç‹¬ç«‹åˆ›å»ºçš„çº¿ç¨‹ï¼Œæ˜¯æ²¡æœ‰å’ŒJVMé‡Œé¢çš„çº¿ç¨‹å¯¹è±¡Threadå»ºç«‹å…³è”çš„ï¼ŒJVMä¸è®¤ä½ è¿™ä¸ªçº¿ç¨‹ï¼Œä½ ç‹¬ç«‹åœ¨è¿™ä¸ªçº¿ç¨‹é‡Œé¢åšå’ŒJVMä¸ç›¸å…³çš„äº‹æƒ…æ˜¯å¯ä»¥çš„ï¼Œä½†æ˜¯ä½ è¦è®¿é—®javaï¼Œè¿™å°±å¾—éœ€è¦JVMå¸®å¿™ï¼Œæ‰€ä»¥éœ€è¦æŠŠæˆ‘ä»¬è‡ªå·±åˆ›å»ºçš„çº¿ç¨‹warpæˆä¸€ä¸ªJVMå±‚é¢çš„Threadå¯¹è±¡ï¼Œç„¶åæ·»åŠ åˆ°JVMçš„thread list é‡Œé¢å»ï¼Œè¿™æ ·åœ¨jvmå±‚é¢å°±æ„ŸçŸ¥åˆ°äº†ä¸€ä¸ªThreadçš„äº†ã€‚ æˆ‘ä»¬ç±»æ¯”çš„è¯ï¼Œä¸€ä¸ªå…ˆåšäº†1ç„¶ååš2 ï¼Œåä¸€ä¸ªå…ˆåšäº†2ï¼Œåé¢è¡¥åšäº†1","link":"/2020/05/19/Android/AttachCurrentThread/"},{"title":"JsonObject.optLong å¯¼è‡´çš„Bug","text":"é—®é¢˜èƒŒæ™¯ ä¸šåŠ¡åœºæ™¯å­˜åœ¨ä¸€ä¸ªJSBï¼ŒFEåŒå­¦ä¼ äº†ä¸ªJSONåˆ°ç«¯ä¸Šï¼Œç«¯ä¸Šæµ‹è¯•çš„æ—¶å€™éƒ½æ˜¯æ­£ç¡®çš„ï¼Œæœ‰å¤©è°ƒè¯•Serveråé¦ˆè¯´idå€¼æ‰¾ä¸åˆ°ï¼Œç«¯ä¸Šidå€¼å›ä¼ é”™äº†ï¼Œå¼€å§‹æ’æŸ¥ä»£ç ã€‚å‘ç°Jsbä¼ è¾“è¿‡æ¥çš„Jsonéƒ½æ˜¯String to Stringçš„æ ¼å¼, ç±»ä¼¼è¿™æ · 1234{ \"id1\":\"123456789087979797\", \"id2\":\"123456789087979798\"} æ–­ç‚¹å‘ç°ï¼ŒFEä¼ è¿‡æ¥çš„å€¼æ˜¯123456789087979797ï¼Œä½†æ˜¯ç«¯ä¸Šå–äº†ä¹‹åï¼Œä¼ ç»™serverçš„å€¼æ˜¯123456789087979792ï¼Œäºæ˜¯æ’æŸ¥è½¬æ¢è¿‡ç¨‹ã€‚ç«¯ä¸Šåœ¨å–idçš„æ—¶å€™ï¼Œä½¿ç”¨äº†org.json.JSONObject#optLong(java.lang.String) æ–¹æ³•ï¼Œé€ æˆæ•´æ•°è½¬æ¢é”™è¯¯ã€‚ æºç åˆ†æ1234567891011121314151617181920212223242526org.json.JSONObject#optLong(java.lang.String)public long optLong(@Nullable String name) { return optLong(name, 0L);}public long optLong(@Nullable String name, long fallback) { Object object = opt(name); Long result = JSON.toLong(object); return result != null ? result : fallback;}static Long toLong(Object value) { if (value instanceof Long) { return (Long) value; } else if (value instanceof Number) { return ((Number) value).longValue(); } else if (value instanceof String) { try { // ç•™æ„è¿™é‡Œä¼šé€ æˆbug return (long) Double.parseDouble((String) value); } catch (NumberFormatException ignored) { } } return null;} åŸç†åˆ†æä¸ºä»€ä¹ˆLongè½¬Doubleä¼šå¤±çœŸï¼Œæˆ‘ä»¬å…ˆå¤ä¹ ä¸€ä¸‹Doubleçš„è¡¨ç¤ºæ–¹å¼, é‚£å°±æ˜¯IEEE754æ ‡å‡†ï¼Œæ‰€æœ‰çš„æµ®ç‚¹æ•°éƒ½è¦è¡¨ç¤ºæˆ å°¾æ•°å’ŒæŒ‡æ•°çš„å½¢å¼ï¼Œè¿™é‡Œå°±ä¼šæœ‰ä¸€ä¸ªé—®é¢˜ï¼Œå°¾æ•°ä¿ç•™çš„ç²¾åº¦ã€‚æˆ‘ä»¬ä»¥å‰é¢çš„Longå€¼123456789087979797ä¸¾ä¾‹ï¼Œè½¬æ¢äºŒè¿›åˆ¶, æ€»å…±æœ‰57ä½ 1110110110100110110100101110101010101100110000100100010101 æ¢æˆæ ‡å‡†å½¢å¼ï¼Œå°¾æ•°åªèƒ½å­˜52ä½ï¼Œåé¢çš„å¾—ä¸¢æ‰ï¼Œæ•´æ•°å°±åœ¨è¿™é‡Œå¤±çœŸäº† 11.1011011010011011010010111010101010110011000010010001|0101(ä¸¢æ‰) å†è½¬æ¢æˆLongå€¼å°±æ˜¯ 123456789087979792æºç ä¸­ï¼Œå¹¶ä¸æ˜¯doubleè½¬longé€ æˆçš„ç²¾åº¦ä¸¢å¤±ï¼Œè€Œæ˜¯doubleè¡¨ç¤ºlongçš„æ—¶å€™ï¼Œå°¾æ•°ç²¾åº¦ä¸¢å¤± 1return (long) Double.parseDouble((String) value); doubleçš„å°¾æ•°ç²¾åº¦åªæœ‰52ä½ï¼Œ2^(52)&lt; 16ä¸ª9ï¼Œæ‰€ä»¥åè¿›åˆ¶ä¸‹ï¼Œdoubleèƒ½å‡†ç¡®è¡¨ç¤ºå°æ•°çš„ç²¾åº¦åœ¨15ä½ï¼Œè¿˜æœ‰ä¸ªç»é—®é¢˜0.1+0.2 = 0.30000â€¦4ä¹Ÿæ˜¯å°¾æ•°ç²¾åº¦å¯¼è‡´çš„ã€‚æœ¬è´¨ä¸Šè®¡ç®—æœºå­˜å‚¨çš„æ•°éƒ½æ˜¯ç¦»æ•£çš„ï¼Œä¸æ˜¯è¿ç»­çš„ã€‚ æ€»ç»“æ¯æ¬¡ä½¿ç”¨ org.json.JSONObject#optLongçš„æ—¶å€™ï¼Œç•™æ„ä¸€ä¸‹ç›®æ ‡å€¼çš„ç±»å‹ï¼Œä½ å¯èƒ½æ°å¥½å–å¯¹äº†å€¼ï¼Œä½†ä¸æ€»æ˜¯å¯¹çš„ï¼Œä¸€æ—¦å€¼è¿‡å¤§çš„case, å°±ä¼šè§¦å‘bugã€‚","link":"/2022/08/14/Android/bug-json-opt-long/"},{"title":"å¦‚ä½•ç”¨AndroidStudioåŠ¨æ€è°ƒè¯•ARTè™šæ‹Ÿæœºï¼Ÿ","text":"1.å‰è¨€ä¹‹å‰æœ‰debugè¿‡jvm, å¼€å‘anroid ä¸´æ—¶èµ·æ„æƒ³èƒ½ä¸èƒ½åŠ¨æ€debug artè™šæ‹Ÿæœºï¼Œä»£ç æ˜¯çœ‹ä¸ä¸‹å»çš„ï¼Œè¿˜æ˜¯è·‘èµ·æ¥ç›´è§‚ã€‚å…¶å®è°ƒè¯•å…¶ä»–native lib çš„åŸç†æ˜¯ä¸€æ ·çš„ã€‚ç½‘ä¸Šä¹Ÿçœ‹åˆ°ä¸€äº›ï¼Œå—å¯å‘æ¯”è¾ƒå¤§çš„æ˜¯è¿™ä½å¤§ä½¬17å¹´å†™çš„https://zhuanlan.zhihu.com/p/24867284, åœ¨æ­¤å…ˆæ„Ÿè°¢ä¸€ä¸‹ä»–ï¼Œè‡ªå·±ä¹Ÿç®—æ˜¯åšä¸€ä¸ªè¾ƒçš„ï¼Œè®°å½•ä¸€ä¸‹è‡ªå·±è¸©è¿‡çš„å‘ã€‚ä»¥ä¸‹å…¨éƒ¨åŸºäºAndroid 9 ã€‚ 2. ç¼–è¯‘Android 9 ç³»ç»Ÿè¿™ä¸ªæœ‰é—¨æ§›ï¼Œæ¯•ç«ŸAOSP è¶…å¤§ã€‚æœ‰ä¸ªåœ¨64æ ¸æœåŠ¡å™¨å½“ç„¶å¥½ï¼Œå¤§æ¦‚åŠä¸ªå°æ—¶ï¼Œå…¨ç›®å½•60GBå·¦å³ï¼Œä½†æ˜¯è‡ªå·±ç¬”è®°æœ¬è¿˜æ˜¯åƒä¸æ¶ˆçš„ï¼Œæ€ä¹ˆæ‹‰ä¸‹è‡ªå·±ç¼–è¯‘ï¼Œè¿˜è¯·googleã€‚å¦‚æœåªæ˜¯æƒ³è¦åŸç”Ÿè¿™é‡Œæœ‰https://ci.android.com/ï¼ŒAOSP googleç¼–è¯‘çš„ï¼Œå¯ä»¥åœ¨é‡Œé¢ç›´æ¥ä¸‹è½½AOSPç¼–è¯‘æ–‡ä»¶ï¼Œä¹Ÿæ¯”è¾ƒå¤§ï¼Œä¸”éœ€è¦è”ç½‘ã€‚å¦‚æœä½ è¿˜æœ‰ä¸ªpixel, è¿˜å¯ä»¥ç”¨æ¥åˆ·æœºã€‚ è‡ªå·±æœ‰æ¡ä»¶ï¼Œå¯ä»¥ç¼–è¯‘ ä»AOSPä¸‹è½½ ç”¨åˆ«äººç»™çš„ï¼Œæ¯”å¦‚æˆ‘android_framework_native_debug ä¸ç®¡æ€ä¹ˆï¼Œå½“ç„¶è¦æœ‰ç›®æ ‡åº“çš„æºç æœ€å¥½ï¼Œï¼ˆå“¦ï¼Œä½ ä¸è¦çš„çš„è¯ï¼ŒğŸ˜‚ å¯ä»¥ç›´æ¥æŒ‡ä»¤çº§debugï¼Œå…¶å®å¯ä»¥ä¸ç”¨è¿™ä¹ˆéº»çƒ¦äº†ï¼Œå¯ä»¥ç›´æ¥return ï¼‰ 3.å‡†å¤‡ä¸€å°æ‰‹æœº å¯ä»¥åˆ·æœºï¼Œé‚£å°±åˆ·è‡ªå·±ç¼–è¯‘çš„ç³»ç»Ÿ ä¸èƒ½åˆ·æœº ï¼Œä½†å¯ä»¥rootï¼Œçœ‹ä½ æ˜¯éœ€è¦è°ƒè¯•é‚£ä¸ªåº“ï¼Œå¦‚æœæ˜¯å…¶å®ƒåº“ï¼Œä½ å¯èƒ½éœ€è¦è‡ªå·±æŠŠç¼–è¯‘å¥½çš„soåº“pushåˆ°æ‰‹æœº ä¸èƒ½rootï¼ŒåŒç”¨çš„åŸºç¡€åº“æ‰å¯ä»¥ï¼Œæ¯”å¦‚æœ¬æ¬¡æˆ‘å°è¯•çš„artåº“ï¼Œlibart.so åœ¨2å°æ‰‹æœº rootå’Œérootï¼Œåˆ·æœºå’Œä¸åˆ·æœºçš„æƒ…å†µä¸‹éƒ½æ˜¯å¯ä»¥çš„ã€‚æƒ³æƒ³å‚å•†è¿˜æ˜¯å¾ˆå°‘æ”¹åŠ¨artçš„ 4. æ–°å»ºä¸€ä¸ªASå·¥ç¨‹ æˆ‘ä»¬éœ€è¦ ç¼–è¯‘å‡ºæ¥å¥½çš„ ç›®æ ‡soæ–‡ä»¶ AOSP å·¥ç¨‹é‡Œé¢æºç  ç¼–è¯‘å‡ºæ¥çš„symbol ç›®å½•ï¼Œé‡Œé¢å¯¹åº”çš„å°±æ˜¯ç›¸åº”åº“çš„ debugæ ‡è®°æ–‡ä»¶ï¼Œè°ƒè¯•ä¸­éœ€è¦ç”¨åˆ°ã€‚æ‰¾åˆ°å¯¹åº”çš„libart.soã€‚å¯¹æ¯”å¤§å°ä½ å°±ä¼šå‘ç°ï¼Œä¸€ä¸ªæ˜¯7mbï¼Œä¸€ä¸ªæ˜¯150mbã€‚æ‹·è´å‡ºæ¥ï¼Œå¯ä»¥æ”¾åˆ°å·¥ç¨‹ç›®å½•ä¸‹ å½“ç„¶ä¹Ÿå¯ä»¥ç”¨ä½ ç°åœ¨çš„å·¥ç¨‹ï¼Œåªè¦æ˜¯æ–¹ä¾¿debugï¼ŒæŸ¥çœ‹æºç ï¼Œè¿›è¡Œnative debugã€‚å¯ä»¥å…ˆå¯¼å…¥ art æºç åˆ°å·¥ç¨‹é‡Œé¢ï¼Œå¯ä»¥å‚è€ƒandroid_framework_native_debugæ ·å¼ã€‚ä¸»è¦æ˜¯é€šè¿‡ASé‡Œé¢çš„debug attach åˆ°é€‰æ‹©çš„è¿›ç¨‹ï¼Œå°±å¯ä»¥è¿›è¡Œç›¸åº”çš„è¿›ç¨‹debugäº†ã€‚ 5.å°†ç›®æ ‡åº“PUSHåˆ°æ‰‹æœº å½“ç„¶ä¹Ÿå¯ä»¥ä¸ç”¨ï¼Œæ¯”å¦‚æˆ‘åœ¨å¦å¤–ä¸€å°å…¶å®ƒå“ç‰Œä¸èƒ½rootçš„æ‰‹æœºä¸Šæµ‹è¯•ï¼Œartåº“å¯ä»¥ç›´æ¥ä½¿ç”¨ã€‚å¦‚æœä½ å…¶å®ƒåº“ï¼Œå»ºè®®å¯ä»¥å°è¯•ã€‚ 6.Attachåˆ°ç›®æ ‡è¿›ç¨‹Debugæœ¬[android_framework_native_debug](https://github.com/kaiattrib/android_framework_native_debug)å·¥ç¨‹å…ˆå†™äº†ä¸€ä¸ªnative code ï¼Œæ–¹ä¾¿æ‰“ä¸Šæ–­æ‰ï¼Œå¯»æ‰¾å…¥åº“ï¼Œä½ ä¹Ÿå¯ä»¥ä¸ç”¨ï¼Œç›´æ¥pauseä¹Ÿæ˜¯å¯ä»¥çš„ã€‚&lt;br /&gt;é€‰æ‹©å¸¦nativeï¼Œå¯ä»¥æ˜¯dualï¼Œç­‰å¾…lldbè¿æ¥æˆåŠŸã€‚&lt;br /&gt; ![](https://cdn.nlark.com/yuque/0/2020/png/501385/1589559645183-3d9e2d39-a854-4685-9621-b12d9ac860d2.png#align=left&amp;display=inline&amp;height=643&amp;margin=%5Bobject%20Object%5D&amp;name=Xnip2020-05-16_00-20-07.png&amp;originHeight=1134&amp;originWidth=772&amp;size=112011&amp;status=done&amp;style=none&amp;width=438) ç­‰å¾…lldbè¿æ¥æˆåŠŸï¼Œç‚¹å‡»è§¦å‘ ä½†æ˜¯ç°åœ¨çœ‹åˆ°ï¼Œæ ˆè¿˜æ²¡æœ‰è¡Œå·ä¿¡æ¯ï¼Œæˆ‘ä»¬è‡ªå·±å†™çš„nativeä»£ç ï¼Œæ‰æœ‰ 123456::Java_com_test_CustomizeThread_start(JNIEnv , jobject) native-lib.cpp:38 //è¿™é‡Œæœ‰è¡Œå·ï¼Œart_quick_generic_jni_trampoline 0x0000006f4bb9b9e4 //è¿™é‡Œåªæœ‰åœ°å€art_quick_invoke_stub 0x0000006f4bb9298cart::ArtMethod::Invoke(art::Thread, unsigned int, unsigned int, art::JValue, char const) 0x0000006f4b70c6ccart::interpreter::ArtInterpreterToCompiledCodeBridge(art::Thread, art::ArtMethod, art::ShadowFrame, unsigned short, art::JValue) 0x0000006f4b8bcab8bool art::interpreter::DoCall&lt;false, false&gt;(art::ArtMethod, art::Thread, art::ShadowFrame&amp;, æˆ‘ä»¬ç»§ç»­è¿›å…¥ï¼Œforce step into 123456art::(anonymous namespace)::CheckJNI::FindClass(_JNIEnv*, char const*) 0x0000006f4b71e728_JNIEnv::FindClass(char const*) jni.h:504::Java_com_test_CustomizeThread_start(JNIEnv *, jobject) native-lib.cpp:38art_quick_generic_jni_trampoline 0x0000006f4bb9b9e4art_quick_invoke_stub 0x0000006f4bb9298c--- å¯ä»¥çœ‹åˆ°ï¼Œåˆæ²¡æœ‰æºç ä¿¡æ¯äº†,æ¥ä¸‹æ¥æˆ‘ä»¬æ‰‹åŠ¨åŠ å…¥ç¬¦å·ä¿¡æ¯åº“ é€šè¿‡ d -p åç¼–è¯‘ï¼Œå¯ä»¥çŸ¥é“æˆ‘ä»¬å½“å‰pcæ‰€åœ¨çš„åº“å’Œå‡½æ•° 123456(lldb) d -plibart.so`art::(anonymous namespace)::CheckJNI::FindClass:-&gt; 0x6f4b71e728 &lt;+4&gt;: stp x28, x27, [sp, #0x70] 0x6f4b71e72c &lt;+8&gt;: stp x26, x25, [sp, #0x80] 0x6f4b71e730 &lt;+12&gt;: stp x24, x23, [sp, #0x90] 0x6f4b71e734 &lt;+16&gt;: stp x22, x21, [sp, #0xa0] æ‰‹åŠ¨åŠ å…¥ç¬¦å·ä¿¡æ¯åº“, æœ‰ä¸‹é¢ä¿¡æ¯ï¼Œè¯´æ˜ok æŠ¥é”™å°±æ˜¯ç›®æ ‡soä¸ç¬¦åˆ 12(lldb) add-dsym /Users/kenchan/GitHub/android_framework_native_debug/symbol/libart.sosymbol file '/Users/kenchan/GitHub/android_framework_native_debug/symbol/libart.so' has been added to '/Users/kenchan/.lldb/module_cache/remote-android/.cache/88B6A7B4-8B23-9260-2988-33B24671013C/libart.so' é€šè¿‡souce info æŸ¥çœ‹ä¸€ä¸‹ å¯¹åº”çš„æºç ä¿¡æ¯ 123(lldb) source infoLines found in module `libart.so[0x0000006f4b71e714-0x0000006f4b71e750): art/runtime/scoped_thread_state_change-inl.h:38:5 å¯ä»¥çœ‹åˆ°ç›®å½•ä¿¡æ¯ï¼Œè¿™é‡Œlinuxä¸‹æ˜¯ç»å¯¹è·¯å¾„ã€‚æ‰€ä»¥æˆ‘ä»¬è¦åšä¸€ä¸‹æ˜ å°„ 1(lldb) settings set target.source-map art/ /Users/kenchan/GitHub/android_framework_native_debug/art ä½ å†ç‚¹å‡»ä¸€ä¸‹ setpï¼Œå°±ä¼šå‘ç°è°ƒç”¨æ ˆé‡Œé¢æœ‰ æºç æ–‡ä»¶ä¿¡æ¯äº† æˆ‘ä»¬ç‚¹å‡»æŸä¸€ä¸ªè°ƒç”¨æ ˆï¼Œå°±æ˜¯å‘ç° è·³è½¬äº†æºç æ–‡ä»¶äº† ç°åœ¨çš„è°ƒç”¨æ ˆæ˜¯ 123456789std::__1::basic_ostream&lt;char, std::__1::char_traits&lt;char&gt; &gt;&amp; std::__1::operator&lt;&lt;&lt;std::__1::char_traits&lt;char&gt; &gt;(std::__1::basic_ostream&lt;char, std::__1::char_traits&lt;char&gt; &gt;&amp;, char const*) 0x0000006f4b71e750art::ScopedThreadStateChange::ScopedThreadStateChange(art::Thread*, art::ThreadState) scoped_thread_state_change-inl.h:38art::ScopedObjectAccessUnchecked::ScopedObjectAccessUnchecked(_JNIEnv*) scoped_thread_state_change-inl.h:108art::ScopedObjectAccess::ScopedObjectAccess(_JNIEnv*) scoped_thread_state_change-inl.h:119art::(anonymous namespace)::CheckJNI::DefineClass(_JNIEnv*, char const*, _jobject*, signed char const*, int) check_jni.cc:1824_JNIEnv::FindClass(char const*) jni.h:504::Java_com_test_CustomizeThread_start(JNIEnv *, jobject) native-lib.cpp:38art_quick_alloc_array_resolved32_tlab 0x0000006f4bb9b9e4art_quick_throw_string_bounds 0x0000006f4bb9298c æ¥ä¸‹æ¥å°±æ˜¯æ­£å¸¸debugäº† 7. ä½ å¯ä»¥ç”¨æœ¬android_framework_native_debugå·¥ç¨‹åšä»€ä¹ˆï¼Ÿ å¦‚æœä½ çš„æ‰‹æœºä¹Ÿæ˜¯ anroid 9.0 å¦‚æœä½ ä¹Ÿæ˜¯æƒ³debug art ä½ å¯ä»¥ç›´æ¥ä¸‹è½½è¿è¡Œæœ¬å·¥ç¨‹ï¼ŒæŒ‰æ­¥éª¤å³å¯ï¼Œä¸éœ€è¦rootï¼Œä¸éœ€è¦push æˆ‘ç¼–è¯‘çš„æ˜¯armå¹³å°çš„ï¼Œæ‰€ä»¥åœ¨æ¨¡æ‹Ÿå™¨é‡Œé¢ä¸è¡Œå‚è€ƒhttps://zhuanlan.zhihu.com/p/24867284","link":"/2020/05/16/Android/android-native-debug/"},{"title":"æ·±å…¥ç†è§£HandleråŸç†","text":"ä¸€. Handleråˆå§‹åŒ–Handlerâ€“&gt; Looper &lt;â€“ MessageQueue &lt;â€“ MessageHandleréœ€è¦Looperï¼ŒLooperlé‡ŒåŒ…å«æ„å»ºçš„MessageQueueã€‚ å¯ä»¥åœ¨æ„é€ çš„æ—¶å€™ï¼Œé€šè¿‡å‚æ•°ä¼ å…¥ã€‚ 1. Handler æ„é€ 12345678910111213141516171819202122232425public Handler(Callback callback, boolean async) { //æ£€æŸ¥æ½œåœ¨çš„æ³„æ¼ if (FIND_POTENTIAL_LEAKS) { final Class&lt;? extends Handler&gt; klass = getClass(); if ((klass.isAnonymousClass() || klass.isMemberClass() || klass.isLocalClass()) &amp;&amp; (klass.getModifiers() &amp; Modifier.STATIC) == 0) { Log.w(TAG, \"The following Handler class should be static or leaks might occur: \" + klass.getCanonicalName()); } } //è·å–å½“å‰çº¿ç¨‹çš„Looper mLooper = Looper.myLooper(); //Handleréœ€è¦Looper,å¦‚æœä¸ºnullï¼ŒæŠ›å‡ºå¼‚å¸¸ if (mLooper == null) { throw new RuntimeException( \"Can't create handler inside thread \" + Thread.currentThread() + \" that has not called Looper.prepare()\"); } //è®¾ç½®å½“å‰Handlerçš„MessageQueue ç­‰äºLooperçš„MessageQueue mQueue = mLooper.mQueue; mCallback = callback; mAsynchronous = async;} 2. ä¸Šé¢çš„mLooper ä¸ºä»€ä¹ˆå¯èƒ½ä¸ºç©ºï¼Ÿè¦è°ƒç”¨ Looper.prepare()?å…ˆçœ‹ä¸€ä¸‹mLooper = Looper.myLooper() 1234567891011121314151617181920//è¿™é‡Œå¯ä»¥çœ‹åˆ°æ˜¯é€šè¿‡ThreadLocalçº¿ç¨‹æŒæœ‰çš„ä¸€ä¸ª Looper public static @Nullable Looper myLooper() { return sThreadLocal.get();}//è·å–å½“å‰çº¿ç¨‹çš„map,å¹¶è¿”å›looperpublic T get() { Thread t = Thread.currentThread(); ThreadLocalMap map = getMap(t); if (map != null) { ThreadLocalMap.Entry e = map.getEntry(this); if (e != null) { @SuppressWarnings(\"unchecked\") T result = (T)e.value; return result; } } //å¦‚æœå½“å‰çº¿ç¨‹çš„mapè¿˜æ²¡æœ‰ï¼Œå°±åœ¨è¿™ä¸ªæ–¹æ³•é‡Œé¢åˆ›å»º return setInitialValue();} å†çœ‹ä¸€ä¸‹ Looper.prepare()ï¼Œè¿™é‡Œè§£é‡Šäº†ä¸ºä»€ä¹ˆåªèƒ½è°ƒç”¨ä¸€æ¬¡ 12345678private static void prepare(boolean quitAllowed) { //å¦‚æœæœ‰äº†ï¼Œå°±æŠ›é”™ï¼Œä¸€ä¸ªçº¿ç¨‹ä¿è¯äº†åªèƒ½æœ‰ä¸€ä¸ªLooper if (sThreadLocal.get() != null) { throw new RuntimeException(\"Only one Looper may be created per thread\"); } //æ²¡æœ‰å°±newä¸€ä¸ª set sThreadLocal.set(new Looper(quitAllowed)); } 3. ä¸ºä»€ä¹ˆæœ‰ä»€ä¹ˆéœ€è¦æ‰‹åŠ¨è°ƒç”¨Looper.prepare() ï¼Ÿ1å½“å‰çº¿ç¨‹æœ‰äº†looperå°±ä¸éœ€è¦æ‰‹åŠ¨è°ƒç”¨ã€‚å¦‚æœæ˜¯åœ¨ä¸»çº¿ç¨‹ActivityThreadï¼Œä¸»çº¿ç¨‹å·²ç»é»˜è®¤æœ‰äº†ä¸€ä¸ªLooperäº†ï¼Œè¿™ä¸ªLooperä¼šå¤„ç†ç•Œé¢çš„å„ç§äº‹ä»¶ã€‚ åœ¨ActivityThreadçš„mainæ–¹æ³•ä¸­ 1234567891011121314//è¿™é‡Œå°±å¯¹ä¸»çº¿ç¨‹ï¼Œè°ƒç”¨äº†Looper.prepare()ï¼Œæ‰€ä»¥åœ¨ä¸»çº¿ç¨‹å¯åŠ¨çš„æ—¶å€™ï¼Œå°±æ‹¥æœ‰äº†Looper,åé¢çš„æ˜¯åœ¨ä¸»çº¿ç¨‹ä¸­çš„Handleré»˜è®¤å…±äº«è¯¥LooeprLooper.prepareMainLooper();//å±•å¼€å°±æ˜¯Looperä¸‹çš„è¿™ä¸ªæ–¹æ³•public static void prepareMainLooper() { //è¿™é‡Œå°±æ˜¯Looper.prepare() prepare(false); synchronized (Looper.class) { if (sMainLooper != null) { throw new IllegalStateException(\"The main Looper has already been prepared.\"); } sMainLooper = myLooper(); }} æ€»ç»“1ä¸€ä¸ªHandleråªèƒ½å¯¹åº”ä¸€ä¸ªLooepr,ä¸€ä¸ªLooper æŒæœ‰MessageQueueã€‚ä¸€ä¸ªLooperå¯ä»¥å¯¹åº”å¤šä¸ªHanderã€‚é‚£ä¹ˆMessageæ˜¯æ€ä¹ˆå’ŒHandlerè”ç³»èµ·æ¥çš„å‘¢ï¼Œåœ¨åŠ å…¥æ¶ˆæ¯çš„æ—¶å€™ é€šè¿‡ msg.target = this; thiså°±æ˜¯handleræœ¬èº«è”ç³»èµ·æ¥çš„ã€‚ äºŒ. Handder å‘é€æ¶ˆæ¯ â€”&gt; å…¥é˜Ÿé€šå¸¸æˆ‘ä»¬æ–°å»ºæ¶ˆæ¯çš„æ—¶å€™ é€šè¿‡ Message obtain = Message.obtain();è·å–ï¼Œä¸»è¦æ˜¯å¤ç”¨é‡Œé¢çš„Messageå¯¹è±¡ã€‚é€šå¸¸æˆ‘ä»¬è°ƒç”¨ 1234sendMessage(Message msg)//å‘é€æ¶ˆæ¯â€”â€”&gt; sendMessageDelayed(msg, 0)//å»¶æ—¶ä¸º0â€”â€”&gt; sendMessageAtTime(msg, SystemClock.uptimeMillis() + delayMillis)//è½¬æ¢æˆç»å¯¹æ—¶é—´â€”â€”&gt; enqueueMessage(queue, msg, uptimeMillis)//å¼€å§‹å…¥é˜Ÿ ä¸‹é¢çš„å°±æ˜¯MeaageQueueå…¥é˜Ÿçš„é€»è¾‘äº†ï¼Œç±»ä¼¼é“¾è¡¨ 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859606162636465666768697071727374757677boolean enqueueMessage(Message msg, long when) { //target å°±æ˜¯å‘é€æ¶ˆæ¯çš„Hander å¦‚æœmessageçš„handelrä¸ºnullï¼ŒæŠ›é”™ if (msg.target == null) { throw new IllegalArgumentException(\"Message must have a target.\"); } //msgæ˜¯ä¸æ˜¯æ­£åœ¨è¢«ä½¿ç”¨,æ¯”å¦‚è¯´è¿™ä¸ªæ¶ˆæ¯å·²ç»å…¥é˜Ÿäº†ã€‚å°±ä¸èƒ½å†åŠ å…¥ // è¿ç»­sendMessageåŒä¸€ä¸ªmsgå¯¹è±¡å°±ä¼šæŠ›é”™,å½“ç„¶msgå¤ç”¨obtianå’Œnewçš„æ—¶å€™FLAG_IN_USEä¼šé‡ç½® if (msg.isInUse()) { throw new IllegalStateException(msg + \" This message is already in use.\"); } //ä¿è¯çº¿ç¨‹å®‰å…¨ synchronized (this) { //å½“å‰é˜Ÿåˆ—æ˜¯ä¸æ˜¯è°ƒç”¨äº†quit if (mQuitting) { IllegalStateException e = new IllegalStateException( msg.target + \" sending message to a Handler on a dead thread\"); Log.w(TAG, e.getMessage(), e); msg.recycle(); return false; } //æ ‡è®°ä¸ºUseçŠ¶æ€ msg.markInUse(); msg.when = when; //å…ˆä¿ç•™ä¹‹å‰çš„èŠ‚ç‚¹ï¼Œå‡†å¤‡æ’å…¥ç°åœ¨çš„msg Message p = mMessages; boolean needWake; //p = null ç°åœ¨é˜Ÿåˆ—æ˜¯ç©ºçš„ // ä¸ºä»€ä¹ˆ ä¼šæœ‰ when = 0 ï¼ŸHandleræä¾›äº†ä¸€ä¸ªsendMessageAtFrontOfQueue æ–¹æ³•,ä¿è¯æŸä¸ªæ¶ˆæ¯æ’åˆ°æ¶ˆæ¯å¤´ï¼ŒåŠæ—¶å¤„ç† //when &lt; p.when å½“å‰æ’å…¥çš„æ¶ˆæ¯ æ¯”å‰ä¸€ä¸ªèŠ‚ç‚¹çš„æ—¶é—´æ›´å°ï¼Œæ„å‘³ç€è¦å…ˆæ‰§è¡Œæ¶ˆæ¯ //å…¶å®å°±æ˜¯å¤´æ’å…¥ ç±»ä¼¼ null&lt;--msg æˆ–è€… null&lt;--.&lt;--p&lt;--msg if (p == null || when == 0 || when &lt; p.when) { // New head, wake up the event queue if blocked. msg.next = p; mMessages = msg; //æ ¹æ®å½“å‰çš„MessageQueue çŠ¶æ€,ç¡®å®šæ˜¯å¦è¦å”¤é†’é˜Ÿåˆ—èµ·æ¥å¤„ç†æ¶ˆæ¯ //ä¸ºä»€ä¹ˆè¦å”¤é†’ï¼Ÿå› ä¸ºé˜Ÿåˆ—ä¸ºç©ºäº†ï¼Œæˆ–è€…é˜Ÿåˆ—é‡Œé¢çš„æ¶ˆæ¯éƒ½æ˜¯æ˜å¤©æ‰è¦å¤„ç†çš„ï¼Œé‚£ä¹ˆä»Šæ™šå¯ä»¥ç¡è§‰ã€‚ä½†æ˜¯ç¡æ¢¦ä¸­åˆæœ‰æ–°çš„(bug)æ¶ˆæ¯æ¥äº†ï¼Œå°±æ˜¯è¿™æ¬¡è¦æ’å…¥çš„æ¶ˆæ¯ï¼Œå¿…é¡»èµ·æ¥å¤„ç†(bug)æ¶ˆæ¯ needWake = mBlocked; } else { // Inserted within the middle of the queue. Usually we don't have to wake // up the event queue unless there is a barrier at the head of the queue // and the message is the earliest asynchronous message in the queue. //ä»¥ä¸Šæƒ…å†µä¸æ»¡è¶³ï¼Œå°±æ˜¯è¦æŠŠå½“å‰è¿™ä¸ªæ¶ˆæ¯æ’å…¥åˆ°é˜Ÿåˆ—ä¸­é—´å»äº† // å°±æŒ‰æ—¶é—´whençš„é¡ºåºæ’å…¥ //å½“å‰ æ¶ˆæ¯é˜Ÿåˆ—æ˜¯å¦é˜»å¡ &amp;&amp; é˜Ÿå¤´çš„æ¶ˆæ¯target=null &amp;&amp; æ˜¯å¦æ”¯æŒå¼‚æ­¥ //target == null ä¸ºä»€ä¹ˆå¯ä»¥ä¸ºnullï¼Ÿä¸æ˜¯ä¸èƒ½ä¸ºnullå—ï¼Ÿè§åé¢ needWake = mBlocked &amp;&amp; p.target == null &amp;&amp; msg.isAsynchronous(); Message prev; //å¯»æ‰¾æ’å…¥ç‚¹ for (;;) { prev = p; p = p.next; if (p == null || when &lt; p.when) { break; } if (needWake &amp;&amp; p.isAsynchronous()) { needWake = false; } } //æ’å…¥æ¶ˆæ¯ msg.next = p; // invariant: p == prev.next prev.next = msg; } // We can assume mPtr != 0 because mQuitting is false. //æ˜¯å¦éœ€è¦å”¤é†’ï¼ŸmPtr used by native code if (needWake) { nativeWake(mPtr); } } return true;} target == null ä¸ºä»€ä¹ˆå¯ä»¥ä¸ºnullï¼Ÿä¸æ˜¯ä¸èƒ½ä¸ºnullå—ï¼Ÿå› ä¸ºæä¾›äº†éªšæ“ä½œï¼Œè¿˜æœ‰è¿™ç§æ‰“å¼€æ–¹å¼ã€‚postSyncBarrierã€‚ ä»¥å‰å«enqueueSyncBarrier ç½‘ä¸Šæ‰¾çš„å…¶å®ƒæœ‰å†™åˆ°è¿™ä¸ªBarrier å¯ä»¥è”æƒ³åˆ°JUCçš„CyclicBarrierã€‚å°±æ˜¯æ’å…¥ä¸€ä¸‹Barrieræ¶ˆæ¯,è¿™ä¸ªæ¶ˆæ¯ä¹‹åçš„æ‰€æœ‰æ¶ˆæ¯ä¼šé˜»å¡åœ¨è¿™ä¸ªæ¶ˆæ¯ä¹‹åã€‚ 12345678910111213141516171819202122232425262728293031323334353637public int postSyncBarrier() { //æ·»åŠ ç°åœ¨çš„æ—¶é—´ return postSyncBarrier(SystemClock.uptimeMillis()); } //æ¶ˆæ¯å…¥é˜Ÿ private int postSyncBarrier(long when) { // Enqueue a new sync barrier token. // We don't need to wake the queue because the purpose of a barrier is to stall it. synchronized (this) { final int token = mNextBarrierToken++; final Message msg = Message.obtain(); msg.markInUse(); msg.when = when; msg.arg1 = token; //è¿™é‡Œæ²¡æœ‰setTarget ï¼Œæ‰€ä»¥æ˜¯nullçš„ Message prev = null; Message p = mMessages; //å¯»æ‰¾æ’å…¥ç‚¹ if (when != 0) { while (p != null &amp;&amp; p.when &lt;= when) { prev = p; p = p.next; } } //æ’å…¥è¿™ä¸ªBarrieræ¶ˆæ¯ if (prev != null) { // invariant: p == prev.next msg.next = p; prev.next = msg; } else { msg.next = p; mMessages = msg; } return token; } } å¼‚æ­¥æ¶ˆæ¯ï¼Ÿä½œè€…ï¼šAngelDevilå‡ºå¤„ï¼šhttps://www.cnblogs.com/angeldevil/p/3340644.htmlè½¬è½½è¯·æ³¨æ˜å‡ºå¤„ï¼æ‰€è°“çš„å¼‚æ­¥æ¶ˆæ¯å…¶å®å°±æ˜¯è¿™æ ·çš„ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡enqueueBarrierå¾€æ¶ˆæ¯é˜Ÿåˆ—ä¸­æ’å…¥ä¸€ä¸ªBarrierï¼Œé‚£ä¹ˆé˜Ÿåˆ—ä¸­æ‰§è¡Œæ—¶é—´åœ¨è¿™ä¸ªBarrierä»¥åçš„åŒæ­¥æ¶ˆæ¯éƒ½ä¼šè¢«è¿™ä¸ªBarrieræ‹¦æˆªä½æ— æ³•æ‰§è¡Œï¼Œç›´åˆ°æˆ‘ä»¬è°ƒç”¨removeBarrierç§»é™¤äº†è¿™ä¸ªBarrierï¼Œè€Œå¼‚æ­¥æ¶ˆæ¯åˆ™æ²¡æœ‰å½±å“ï¼Œæ¶ˆæ¯é»˜è®¤å°±æ˜¯åŒæ­¥æ¶ˆæ¯ï¼Œé™¤éæˆ‘ä»¬è°ƒç”¨äº†Messageçš„setAsynchronousï¼Œè¿™ä¸ªæ–¹æ³•æ˜¯éšè—çš„ã€‚åªæœ‰åœ¨åˆå§‹åŒ–Handleræ—¶é€šè¿‡å‚æ•°æŒ‡å®šå¾€è¿™ä¸ªHandlerå‘é€çš„æ¶ˆæ¯éƒ½æ˜¯å¼‚æ­¥çš„ï¼Œè¿™æ ·åœ¨Handlerçš„enqueueMessageä¸­å°±ä¼šè°ƒç”¨Messageçš„setAsynchronousè®¾ç½®æ¶ˆæ¯æ˜¯å¼‚æ­¥çš„ï¼Œä»ä¸Šé¢Handler.enqueueMessageçš„ä»£ç ä¸­å¯ä»¥çœ‹åˆ°ã€‚æ‰€è°“å¼‚æ­¥æ¶ˆæ¯ï¼Œå…¶å®åªæœ‰ä¸€ä¸ªä½œç”¨ï¼Œå°±æ˜¯åœ¨è®¾ç½®Barrieræ—¶ä»å¯ä»¥ä¸å—Barrierçš„å½±å“è¢«æ­£å¸¸å¤„ç†ï¼Œå¦‚æœæ²¡æœ‰è®¾ç½®Barrierï¼Œå¼‚æ­¥æ¶ˆæ¯å°±ä¸åŒæ­¥æ¶ˆæ¯æ²¡æœ‰åŒºåˆ«ï¼Œå¯ä»¥é€šè¿‡removeSyncBarrierç§»é™¤Barrierï¼š nativeWakeå”¤é†’ ? nativePollOnce?ç¡çœ nativeæ–¹æ³•ã€‚è½®è¯¢åˆ©ç”¨epollæœºåˆ¶æœ‰ç‚¹ç±»ä¼¼wait ä¸ notifyã€‚å…·ä½“è§åé¢çš„nativeåˆ†æ 123private native static void nativeWake(long ptr);private native void nativePollOnce(long ptr, int timeoutMillis); /*non-static for callbacks*/ ä¸‰. Handler å¤„ç†æ¶ˆæ¯åŠå»¶æ—¶æ¶ˆæ¯ â€”&gt; å‡ºé˜Ÿæ¶ˆæ¯æ˜¯æ€ä¹ˆå¤„ç†çš„å‘¢ï¼Ÿé€šè¿‡è°ƒç”¨Looper.loop()æ–¹æ³•ï¼Œå¼€å§‹å¤„ç†æ¶ˆæ¯ 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111public static void loop() { //è·å–å½“å‰çº¿ç¨‹çš„Looper final Looper me = myLooper(); if (me == null) { throw new RuntimeException(\"No Looper; Looper.prepare() wasn't called on this thread.\"); } final MessageQueue queue = me.mQueue; // Make sure the identity of this thread is that of the local process, // and keep track of what that identity token actually is. //æ¸…ç©ºè¿œç¨‹è°ƒç”¨ç«¯çš„uidå’Œpidï¼Œç”¨å½“å‰æœ¬åœ°è¿›ç¨‹çš„uidå’Œpidæ›¿ä»£ï¼› Binder.clearCallingIdentity(); final long ident = Binder.clearCallingIdentity(); // Allow overriding a threshold with a system prop. e.g. // adb shell 'setprop log.looper.1000.main.slow 1 &amp;&amp; stop &amp;&amp; start' final int thresholdOverride = SystemProperties.getInt(\"log.looper.\" + Process.myUid() + \".\" + Thread.currentThread().getName() + \".slow\", 0); boolean slowDeliveryDetected = false; //è¿™é‡Œå¼€å§‹å¤„ç†æ¶ˆæ¯ï¼Œæ­»å¾ªç¯ for (;;) { //è¿™é‡Œå¯èƒ½é˜»å¡,ç°åœ¨æ²¡æœ‰æ¶ˆæ¯éœ€è¦å¤„ç†çš„æ¶ˆæ¯ Message msg = queue.next(); // might block if (msg == null) { // No message indicates that the message queue is quitting. //msg = nullï¼Œæ¶ˆæ¯é˜Ÿåˆ—é€€å‡ºäº†ï¼Œé€€å‡ºæ­»å¾ªç¯ return; } // This must be in a local variable, in case a UI event sets the logger //æ¯æ¬¡æ›´æ–°logï¼Œé˜²æ­¢è¢«setäº†æœ€æ–°çš„äº†ï¼Œæ‰“å°åˆ†å‘log final Printer logging = me.mLogging; if (logging != null) { logging.println(\"&gt;&gt;&gt;&gt;&gt; Dispatching to \" + msg.target + \" \" + msg.callback + \": \" + msg.what); } final long traceTag = me.mTraceTag; long slowDispatchThresholdMs = me.mSlowDispatchThresholdMs; long slowDeliveryThresholdMs = me.mSlowDeliveryThresholdMs; if (thresholdOverride &gt; 0) { slowDispatchThresholdMs = thresholdOverride; slowDeliveryThresholdMs = thresholdOverride; } final boolean logSlowDelivery = (slowDeliveryThresholdMs &gt; 0) &amp;&amp; (msg.when &gt; 0); final boolean logSlowDispatch = (slowDispatchThresholdMs &gt; 0); final boolean needStartTime = logSlowDelivery || logSlowDispatch; final boolean needEndTime = logSlowDispatch; if (traceTag != 0 &amp;&amp; Trace.isTagEnabled(traceTag)) { Trace.traceBegin(traceTag, msg.target.getTraceName(msg)); } final long dispatchStart = needStartTime ? SystemClock.uptimeMillis() : 0; final long dispatchEnd; try { //è¿™é‡Œå¼€å§‹è°ƒç”¨ targetæ¥å¤„ç†æ¶ˆæ¯ï¼Œtartgetå°±æ˜¯Hander // è½¬è€Œè°ƒç”¨åˆ°æˆ‘ä»¬é‡å†™çš„dispatchMessage æ–¹æ³•é‡Œé¢å» msg.target.dispatchMessage(msg); dispatchEnd = needEndTime ? SystemClock.uptimeMillis() : 0; } finally { if (traceTag != 0) { Trace.traceEnd(traceTag); } } //ä¸‹é¢ä¸»è¦æ˜¯æ‰“å°logï¼Œæ¶ˆæ¯å¤„ç†å¯èƒ½å»¶æ—¶ if (logSlowDelivery) { if (slowDeliveryDetected) { if ((dispatchStart - msg.when) &lt;= 10) { Slog.w(TAG, \"Drained\"); slowDeliveryDetected = false; } } else { if (showSlowLog(slowDeliveryThresholdMs, msg.when, dispatchStart, \"delivery\", msg)) { // Once we write a slow delivery log, suppress until the queue drains. slowDeliveryDetected = true; } } } if (logSlowDispatch) { showSlowLog(slowDispatchThresholdMs, dispatchStart, dispatchEnd, \"dispatch\", msg); } if (logging != null) { logging.println(\"&lt;&lt;&lt;&lt;&lt; Finished to \" + msg.target + \" \" + msg.callback); } // Make sure that during the course of dispatching the // identity of the thread wasn't corrupted. final long newIdent = Binder.clearCallingIdentity(); if (ident != newIdent) { Log.wtf(TAG, \"Thread identity changed from 0x\" + Long.toHexString(ident) + \" to 0x\" + Long.toHexString(newIdent) + \" while dispatching to \" + msg.target.getClass().getName() + \" \" + msg.callback + \" what=\" + msg.what); } //å›æ”¶æ¶ˆæ¯ msg.recycleUnchecked(); } } å›æ”¶æ¶ˆæ¯ï¼Œæ ‡è®°æ¸…ç©ºï¼Œæ·»åŠ ç¼“å­˜æ± android.os.Message#recycleUnchecked 123456789101112131415161718192021222324252627/** * Recycles a Message that may be in-use. * Used internally by the MessageQueue and Looper when disposing of queued Messages. */void recycleUnchecked() { // Mark the message as in use while it remains in the recycled object pool. // Clear out all other details. flags = FLAG_IN_USE; what = 0; arg1 = 0; arg2 = 0; obj = null; replyTo = null; sendingUid = -1; when = 0; target = null; callback = null; data = null; synchronized (sPoolSync) { if (sPoolSize &lt; MAX_POOL_SIZE) { next = sPool; sPool = this; sPoolSize++; } }} ä¸»è¦æ¥çœ‹ä¸€ä¸‹æ€ä¹ˆå–çš„æ¶ˆæ¯ï¼Ÿandroid.os.MessageQueue#next 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128Message next() { // Return here if the message loop has already quit and been disposed. // This can happen if the application tries to restart a looper after quit // which is not supported. final long ptr = mPtr; //mPtr é€€å‡ºäº†, return nullï¼Œå‰é¢çš„ Looper.loop æ”¶åˆ°nullæ¶ˆæ¯å°±é€€å‡ºæ­»å¾ªç¯äº† if (ptr == 0) { return null; } //ä»€ä¹ˆæ˜¯ IdleHandler ï¼Ÿè§åé¢ //è¿™ä¸ªç°åœ¨ä¸»è¦åšæ ‡è®° int pendingIdleHandlerCount = -1; // -1 only during first iteration // ä¼‘æ¯æ—¶é—´ int nextPollTimeoutMillis = 0; for (;;) { if (nextPollTimeoutMillis != 0) { Binder.flushPendingCommands(); } //æœ¬åœ°æ–¹æ³• nativePollOnce(ptr, nextPollTimeoutMillis); synchronized (this) { // Try to retrieve the next message. Return if found. //å–æ¶ˆæ¯ final long now = SystemClock.uptimeMillis(); Message prevMsg = null; Message msg = mMessages; //msg ï¼= nullï¼Œä½†æ˜¯target = nullï¼Œå‰é¢è¯´äº†è¿™ä¸ªæ˜¯barrieræ¶ˆæ¯ if (msg != null &amp;&amp; msg.target == null) { // Stalled by a barrier. Find the next asynchronous message in the queue. //ç»§ç»­å¯»æ‰¾ä¸‹ä¸€ä¸ªbarrieræ¶ˆæ¯,æ‰¾åˆ°ä¸€ä¸ªä¸æ˜¯å¼‚æ­¥çš„æ¶ˆæ¯é€€å‡º //ä¸ºä»€ä¹ˆä¸å¤„ç†è¿™ä¸ªbarrierï¼Ÿbarrier å°±æ˜¯ä¸€ä¸ªæ—¶é—´ç•Œé™ï¼Œä¸”æ²¡æœ‰Handlerï¼Œæ¶ˆæ¯é˜Ÿåˆ—å°±æ˜¯æŒ‰æ—¶é—´æ’åºçš„ï¼Œå¤„ç†åˆ°äº†å½“å‰è¿™ä¸ªbarrieræ¶ˆæ¯ï¼Œè¯´æ˜æ—¶é—´æ»¡è¶³ do { prevMsg = msg; msg = msg.next; } while (msg != null &amp;&amp; !msg.isAsynchronous()); } if (msg != null) { //è‹¥æœç°åœ¨çš„æ—¶é—´è¿˜å°äºè¿™ä¸ªæ¶ˆæ¯è®¾ç½®çš„æ‰§è¡Œæ—¶é—´ if (now &lt; msg.when) { // Next message is not ready. Set a timeout to wake up when it is ready. //è®¡ç®—ä¸€ä¸‹å¯ä»¥ä¼‘æ¯å¤šä¹…æ—¶é—´ nextPollTimeoutMillis = (int) Math.min(msg.when - now, Integer.MAX_VALUE); } else { //å¦‚æœæ—¶é—´æ»¡è¶³,å°±æ˜¯è¿™ä¸ªæ¶ˆæ¯äº†ï¼Œè¿”å›è¿™ä¸ªæ¶ˆæ¯ç»™loop // Got a message. mBlocked = false; if (prevMsg != null) { prevMsg.next = msg.next; } else { mMessages = msg.next; } msg.next = null; if (DEBUG) Log.v(TAG, \"Returning message: \" + msg); msg.markInUse(); return msg; } } else { // No more messages. nextPollTimeoutMillis = -1; } // Process the quit message now that all pending messages have been handled. //å¯èƒ½åœ¨è¿™ä¸ªæ—¶é—´ï¼Œé€€å‡ºäº† if (mQuitting) { dispose(); return null; } // If first time idle, then get the number of idlers to run. // Idle handles only run if the queue is empty or if the first message // in the queue (possibly a barrier) is due to be handled in the future. // pendingIdleHandlerCount = -1 æ ‡è®°æ²¡æœ‰è¢«æ”¹ã€‚æœ‰ç©ºé—²äº†ï¼Œå¤„ç†IdleHandler if (pendingIdleHandlerCount &lt; 0 &amp;&amp; (mMessages == null || now &lt; mMessages.when)) { pendingIdleHandlerCount = mIdleHandlers.size(); } //å±…ç„¶æ²¡æœ‰IdleHandlerï¼Ÿé‚£å°±å¯ä»¥ä¼‘æ¯äº† if (pendingIdleHandlerCount &lt;= 0) { // No idle handlers to run. Loop and wait some more. //æ ‡è®°æˆ‘è¦ä¼‘æ¯äº†,å‘é€æ¶ˆæ¯çš„æ—¶å€™ï¼Œå¯ä»¥åˆ¤æ–­æ˜¯å¦éœ€è¦å”¤é†’æˆ‘ mBlocked = true; // ç›´æ¥continue ï¼Œåœ¨ä¸Šé¢çš„ nativePollOnce(ptr, nextPollTimeoutMillis)å°±æ˜¯ç¡çœ äº† continue; } //æŠŠ mIdleHandlers è½¬åŒ–åˆ° mPendingIdleHandlers //mIdleHandlers æ˜¯ä¼šå˜åŒ–çš„ if (mPendingIdleHandlers == null) { mPendingIdleHandlers = new IdleHandler[Math.max(pendingIdleHandlerCount, 4)]; } mPendingIdleHandlers = mIdleHandlers.toArray(mPendingIdleHandlers); } // Run the idle handlers. // We only ever reach this code block during the first iteration. //ä¸‹é¢å°±æ˜¯å¤„ç†IdleHandleräº† // æ˜¾ç„¶è¿™é‡Œé¢ä¸èƒ½åšè€—æ—¶æ“ä½œï¼Œä¸ç„¶ä¼šå½±å“æ¶ˆæ¯çš„åŠæ—¶å¤„ç† for (int i = 0; i &lt; pendingIdleHandlerCount; i++) { final IdleHandler idler = mPendingIdleHandlers[i]; mPendingIdleHandlers[i] = null; // release the reference to the handler boolean keep = false; try { keep = idler.queueIdle(); } catch (Throwable t) { Log.wtf(TAG, \"IdleHandler threw exception\", t); } if (!keep) { synchronized (this) { mIdleHandlers.remove(idler); } } } //å¤„ç†å®Œäº†ï¼Œæ ‡è®°å¤ä½ // Reset the idle handler count to 0 so we do not run them again. pendingIdleHandlerCount = 0; // While calling an idle handler, a new message could have been delivered // so go back and look again for a pending message without waiting. //åœ¨å¤„ç†IdleHandlerçš„è¿‡ç¨‹ä¸­ï¼Œæ²¡æœ‰ç¡çœ ï¼Œå¯èƒ½æœ‰æ–°çš„æ¶ˆæ¯æ¥äº†ï¼Œä¸èƒ½ç¡çœ  nextPollTimeoutMillis = 0; } } ä»€ä¹ˆæ˜¯ IdleHandler ï¼ŸIdleHandler å¯ä»¥ç”¨æ¥æå‡æ€§èƒ½ï¼Œä¸»è¦ç”¨åœ¨æˆ‘ä»¬å¸Œæœ›èƒ½å¤Ÿåœ¨å½“å‰çº¿ç¨‹æ¶ˆæ¯é˜Ÿåˆ—ç©ºé—²æ—¶åšäº›äº‹æƒ…ï¼ˆè­¬å¦‚ UI çº¿ç¨‹åœ¨æ˜¾ç¤ºå®Œæˆåï¼Œå¦‚æœçº¿ç¨‹ç©ºé—²æˆ‘ä»¬å°±å¯ä»¥æå‰å‡†å¤‡å…¶ä»–å†…å®¹ï¼‰çš„æƒ…å†µä¸‹ï¼Œä¸è¿‡æœ€å¥½ä¸è¦åšè€—æ—¶æ“ä½œã€‚å…·ä½“ç”¨æ³•å¦‚ä¸‹ã€‚ 12345678//getMainLooper().myQueue()æˆ–è€…Looper.myQueue()Looper.myQueue().addIdleHandler(new IdleHandler() { @Override public boolean queueIdle() { //ä½ è¦å¤„ç†çš„äº‹æƒ… return false; } }); å¯èƒ½å­˜åœ¨çš„é—®é¢˜ï¼Ÿ æ¶ˆæ¯ä¸æ˜¯åŠæ—¶å¤„ç†çš„ï¼ŒåŠæ—¶æ€§ä¸ä¿è¯ã€‚ æˆ‘å‘é€äº†ä¸€ä¸ªå»¶æ—¶MSGï¼Œè¿™ä¸ªMSGåœ¨æ²¡æœ‰è¢«å¤„ç†çš„æƒ…å†µä¸‹ï¼Œè¿™ä¸ªMSGå¯èƒ½æŒæœ‰äº†å…¶å®ƒå¼•ç”¨å¯¼è‡´å†…å­˜æ³„æ¼ã€‚æ‰€ä»¥åœ¨åœ¨Activityé€€å‡ºçš„æ—¶å€™ï¼Œclearä¸€ä¸‹msgï¼Œæ¸…æ‰handlerã€‚ ç±»ä¼¼ Dialogå¼•å‘çš„å†…å­˜æ³„æ¼ 123456789101112131415for (;;) { //å‡è®¾è¿™æ˜¯å¾ªç¯çš„ç¬¬10æ¬¡,ç„¶åè¿™é‡Œé˜»å¡äº†ã€‚ç„¶åå…¶å®ƒåœ°æ–¹åˆšå¥½ä»çº¿ç¨‹æ± é‡Œé¢å–èµ°äº†ä¸€ä¸ªæ¶ˆæ¯ï¼Œä½†æ˜¯æ²¡æœ‰è¢«å‘é€ã€‚ // æƒ³ä¸€æƒ³è¿™ä¸ªmsgä¾ç„¶æŒæœ‰å¯¹ç¬¬9æ¬¡æ¶ˆæ¯çš„å¼•ç”¨,å¹¶åœ¨è¯»åˆ°æ¶ˆæ¯çš„æ—¶å€™è¦†ç›–ã€‚é—´æ¥çš„è¿™ä¸ªmsgå°±ä¿æŒå…¶å®ƒå¼•ç”¨ã€‚ Message msg = queue.next(); if (msg == null) { return; } msg.target.dispatchMessage(msg); //ç¬¬9æ¬¡å–çš„æ¶ˆæ¯ï¼Œåœ¨è¿™é‡Œæ ‡è®°å¤ä½äº†ï¼Œè¡¨ç¤ºå›æ”¶äº† msg.recycleUnchecked(); //è¿™é‡Œå¯ä»¥åŠ ä¸€å¥ msg = null;} æœ€åç”¨ä¸€å¼ å›¾ï¼Œæ¥è¡¨ç¤ºæ•´ä¸ªæ¶ˆæ¯æœºåˆ¶ å››. Nativeå±‚ä¸»è¦åˆ†æ nativeWakeï¼ˆï¼‰ nativePollOnce() æ–¹æ³• å®ç°å¤Ÿç€MessageQueueçš„æ—¶å€™è°ƒç”¨äº†nativeInit(); 12345MessageQueue(boolean quitAllowed) { mQuitAllowed = quitAllowed; // é€šè¿‡JNIè°ƒç”¨äº†Nativeå±‚çš„ç›¸å…³å‡½æ•°ï¼Œå¯¼è‡´äº†NativeMessageQueueçš„åˆ›å»º mPtr = nativeInit(); } å¯¹åº”çš„ C++ å±‚çš„å®ç° 123456789101112static jlong android_os_MessageQueue_nativeInit(JNIEnv* env, jclass clazz) { // åœ¨Nativeå±‚åˆåˆ›å»ºäº†NativeMessageQueue NativeMessageQueue* nativeMessageQueue = new NativeMessageQueue(); if (!nativeMessageQueue) { jniThrowRuntimeException(env, \"Unable to allocate native queue\"); return 0; } nativeMessageQueue-&gt;incStrong(env); // è¿™é‡Œè¿”å›å€¼æ˜¯Javaå±‚çš„mPtrï¼Œå› æ­¤mPtrå®é™…ä¸Šæ˜¯Javaå±‚MessageQueueä¸NativeMessesageQueueçš„æ¡¥æ¢ return reinterpret_cast&lt;jlong&gt;(nativeMessageQueue);} 1æ­¤æ—¶Javaå±‚å’ŒNativeå±‚çš„MessageQueueè¢«mPtrè¿æ¥èµ·æ¥äº†ï¼ŒNativeMessageQueueåªæ˜¯Javaå±‚MessageQueueåœ¨Nativeå±‚çš„ä½“ç°ï¼Œå…¶æœ¬èº«å¹¶æ²¡æœ‰å®ç°Queueçš„æ•°æ®ç»“æ„ï¼Œè€Œæ˜¯ä»å…¶çˆ¶ç±»MessageQueueä¸­ç»§æ‰¿mLooperå˜é‡ã€‚ä¸Javaå±‚ç±»å‹ï¼Œè¿™ä¸ªLooperä¹Ÿæ˜¯çº¿ç¨‹çº§åˆ«çš„å•åˆ—ã€‚ NativeMessageQueueæ— å‚æ„é€ å‡½æ•° 12345678910NativeMessageQueue::NativeMessageQueue() : mPollEnv(NULL), mPollObj(NULL), mExceptionObj(NULL) { // è·å–TLSä¸­çš„Looperå¯¹è±¡ mLooper = Looper::getForThread(); if (mLooper == NULL) { // åˆ›å»ºnativeå±‚çš„Looperå¯¹è±¡ mLooper = new Looper(false); // ä¿å­˜native å±‚çš„Looperåˆ°TLSä¸­(çº¿ç¨‹çº§å•ä¾‹) Looper::setForThread(mLooper); }} Looper::getForThread()ï¼šåŠŸèƒ½ç±»æ¯”äºJavaå±‚çš„Looper.myLooper(); Looper::setForThread(mLooper)ï¼šåŠŸèƒ½ç±»æ¯”äºJavaå±‚çš„ThreadLocal.set() é€šè¿‡ä¸Šè¿°ä»£ç æˆ‘ä»¬çŸ¥é“ï¼š 1ã€Javaå±‚çš„Looperçš„åˆ›å»ºå¯¼è‡´äº†MessageQueueçš„åˆ›å»ºï¼Œè€Œåœ¨Nativeå±‚åˆ™åˆšåˆšç›¸åï¼ŒNativeMessageQueueçš„åˆ›å»ºå¯¼è‡´äº†Looperçš„åˆ›å»º 2ã€MessageQueueæ˜¯åœ¨Javaå±‚ä¸Nativeå±‚æœ‰ç€ç´§å¯†çš„è”ç³»ï¼Œä½†æ˜¯æ­¤æ¬¡Nativeå±‚çš„Looperä¸Javaå±‚çš„Looperæ²¡æœ‰ä»»ä½•å…³ç³»ã€‚ 3ã€Nativeå±‚çš„Looperåˆ›å»ºå’ŒJavaå±‚çš„ä¹Ÿå®Œå…¨ä¸ä¸€æ ·ï¼Œå®ƒåˆ©ç”¨äº†Linuxçš„epollæœºåˆ¶æ£€æµ‹äº†Inputçš„fdå’Œå”¤é†’fdã€‚ä»åŠŸèƒ½ä¸Šæ¥è®²ï¼Œè¿™ä¸ªå”¤é†’fdæ‰æ˜¯çœŸæ­£å¤„ç†Java Messageå’ŒNative Messageçš„é’¥åŒ™ã€‚ æ‰€ä»¥åˆ›å»ºMessageQueueçš„æµç¨‹å¦‚å›¾ ä¸ºä»€ä¹ˆè¦å…³è”ä¸€ä¸ªNative MessageQueue ???é¦–å…ˆNative å±‚ä¹Ÿæä¾›äº† sendMesage,å…¶å®ƒåœ°æ–¹å¯ä»¥å‘è¿™ä¸ªæ¶ˆæ¯é˜Ÿåˆ—å‘é€æ¶ˆæ¯ã€‚æ¯”å¦‚å“åº”ç‚¹å‡»äº‹ä»¶ï¼ŒWMSä¸­æ¥æ”¶åˆ°æ¶ˆæ¯åï¼Œä¼šè°ƒç”¨ViewRootImplä¸­çš„dispatchInputEvent 1234 void Looper::sendMessage(const sp&lt;MessageHandler&gt;&amp; handler, const Message&amp; message) { nsecs_t now = systemTime(SYSTEM_TIME_MONOTONIC); sendMessageAtTime(now, handler, message);} 12345678910111213141516171819202122232425262728293031323334353637 void Looper::sendMessageAtTime(nsecs_t uptime, const sp&lt;MessageHandler&gt;&amp; handler, const Message&amp; message) {#if DEBUG_CALLBACKS ALOGD(\"%p ~ sendMessageAtTime - uptime=%\" PRId64 \", handler=%p, what=%d\", this, uptime, handler.get(), message.what);#endif size_t i = 0; { // acquire lock // è¯·æ±‚é” AutoMutex _l(mLock); size_t messageCount = mMessageEnvelopes.size(); // æ‰¾åˆ°messageåº”è¯¥æ’å…¥çš„ä½ç½®i while (i &lt; messageCount &amp;&amp; uptime &gt;= mMessageEnvelopes.itemAt(i).uptime) { i += 1; } MessageEnvelope messageEnvelope(uptime, handler, message); mMessageEnvelopes.insertAt(messageEnvelope, i, 1); // Optimization: If the Looper is currently sending a message, then we can skip // the call to wake() because the next thing the Looper will do after processing // messages is to decide when the next wakeup time should be. In fact, it does // not even matter whether this code is running on the Looper thread. // å¦‚æœå½“å‰æ­£åœ¨å‘é€æ¶ˆæ¯ï¼Œé‚£ä¹ˆä¸å†è°ƒç”¨wake()ï¼Œç›´æ¥è¿”å› if (mSendingMessage) { return; } } // release lock // é‡Šæ”¾é” // Wake the poll loop only when we enqueue a new message at the head. // å½“æ¶ˆæ¯åŠ å…¥åˆ°æ¶ˆæ¯é˜Ÿåˆ—çš„å¤´éƒ¨æ—¶ï¼Œéœ€è¦å”¤é†’pollå¾ªç¯ if (i == 0) { wake(); }} sendMessage()å’ŒsendMessageDelayed()éƒ½æ˜¯è°ƒç”¨sendMessageAtTime()æ¥å®Œæˆæ¶ˆæ¯æ’ sendMessageAtTime() å’Œä¸Šé¢Javaå±‚ç±»ä¼¼ MessageQueueæˆä¸ºJavaå±‚å’ŒNativeå±‚çš„æ¢çº½ï¼Œæ—¢èƒ½å¤„ç†ä¸Šå±‚æ¶ˆæ¯ï¼Œä¹Ÿèƒ½å¤„ç†Nativeæ¶ˆæ¯ï¼Œå½“ç„¶Nativeå±‚æ¶ˆæ¯æ˜¯Nativeå±‚Hanlderå¤„ç†ã€‚ æ„Ÿè§‰è‡ªå·±å†™ä¸€ä¸ªHandler æ ¹æœ¬ç”¨ä¸åˆ°native çš„ MessageQueue ï¼Ÿï¼Ÿï¼Ÿä¸ºä»€ä¹ˆä¸»çº¿ç¨‹android.app.ActivityThread#main é‡Œé¢æ˜æ˜æœ‰ä¸ª Looper.loop() å´ä¸ä¼šå¡UIä¸»çº¿ç¨‹ï¼Ÿå› ä¸ºUIäº‹ä»¶æœ¬èº«ä¹Ÿæ˜¯é€šè¿‡ä¸»çº¿ç¨‹çš„Handelræœºåˆ¶å»å¤„ç†çš„ã€‚å½“å‰ä¸»çº¿ç¨‹loopäº†ï¼Œè¿˜æœ‰æ¶ˆæ¯ä»å…¶å®ƒåœ°æ–¹è¿‡æ¥ã€‚å½“å‰Activityçš„å¯ä»¥å“åº”å›è°ƒäº‹ä»¶å’Œ å¹¿æ’­äº‹ä»¶ã€‚å¼•ç”¨ https://stackoverflow.com/questions/35931899/why-main-threads-looper-loop-doesnt-block-ui-thread 123If there is no message, it means that no updates are required. All of our code is just a callback, such as Application onCreate, Activit onCreate, BroadcastReceiver onReceive.All update callbacks are caused by the message, and these messages are from the system services, such as ActivityManagerService, InputManagerService, WindowMangerService. If you need to update the UI, the android service will send a message to the loop via the IPC. nativePollOnce()12345static void android_os_MessageQueue_nativePollOnce(JNIEnv* env, jobject obj, jlong ptr, jint timeoutMillis) { //å°†Javaå±‚ä¼ é€’ä¸‹æ¥çš„mPtrè½¬æ¢ä¸ºnativeMessageQueue NativeMessageQueue* nativeMessageQueue = reinterpret_cast&lt;NativeMessageQueue*&gt;(ptr); nativeMessageQueue-&gt;pollOnce(env, obj, timeoutMillis); } é¦–å…ˆï¼Œå°†Javaå±‚ä¼ é€’ä¸‹æ¥çš„mPtrè½¬æ¢ä¸ºnativeMessageQueue å…¶æ¬¡ï¼ŒnativeMessageQueueè°ƒç”¨pollOnce(env, obj, timeoutMillis) 1234567891011121314void NativeMessageQueue::pollOnce(JNIEnv* env, jobject pollObj, int timeoutMillis) { mPollEnv = env; mPollObj = pollObj; // é‡ç‚¹å‡½æ•° mLooper-&gt;pollOnce(timeoutMillis); mPollObj = NULL; mPollEnv = NULL; if (mExceptionObj) { env-&gt;Throw(mExceptionObj); env-&gt;DeleteLocalRef(mExceptionObj); mExceptionObj = NULL; }} è°ƒç”¨pollOnce(timeoutMillis),æœ€åè°ƒç”¨åˆ° Looper::pollOnce(int, int, int, void**)å‡½æ•° 1234567891011121314151617181920212223242526272829303132333435363738int Looper::pollOnce(int timeoutMillis, int* outFd, int* outEvents, void** outData) { int result = 0; // å¯¹fdå¯¹åº”çš„Responsesè¿›è¡Œå¤„ç†ï¼Œåé¢å‘ç°Responseé‡Œéƒ½æ˜¯æ´»åŠ¨fd for (;;) { // å…ˆå¤„ç†æ²¡æœ‰Callbackçš„Responseäº‹ä»¶ while (mResponseIndex &lt; mResponses.size()) { const Response&amp; response = mResponses.itemAt(mResponseIndex++); int ident = response.request.ident; if (ident &gt;= 0) { // ident&gt;=0åˆ™è¡¨ç¤ºæ²¡æœ‰callbackï¼Œå› ä¸ºPOLL_CALLBACK=-2 int fd = response.request.fd; int events = response.events; void* data = response.request.data;#if DEBUG_POLL_AND_WAKE ALOGD(\"%p ~ pollOnce - returning signalled identifier %d: \" \"fd=%d, events=0x%x, data=%p\", this, ident, fd, events, data);#endif if (outFd != NULL) *outFd = fd; if (outEvents != NULL) *outEvents = events; if (outData != NULL) *outData = data; return ident; } } // æ³¨æ„è¿™é‡Œå¤„äºå¾ªç¯å†…éƒ¨ï¼Œæ”¹å˜resultçš„å€¼åœ¨åé¢çš„pollInner if (result != 0) {#if DEBUG_POLL_AND_WAKE ALOGD(\"%p ~ pollOnce - returning result %d\", this, result);#endif if (outFd != NULL) *outFd = 0; if (outEvents != NULL) *outEvents = 0; if (outData != NULL) *outData = NULL; return result; } // å†å¤„ç†å†…éƒ¨è½®è®­ result = pollInner(timeoutMillis); }} Looper::pollInner()å‡½æ•° 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128129130131132133134135136137138139140141142143144145146147148149150151152153154155156157158159160161162163164165166167168169170171172173174175176177178179180 int Looper::pollInner(int timeoutMillis) {#if DEBUG_POLL_AND_WAKE ALOGD(\"%p ~ pollOnce - waiting: timeoutMillis=%d\", this, timeoutMillis);#endif // Adjust the timeout based on when the next message is due. if (timeoutMillis != 0 &amp;&amp; mNextMessageUptime != LLONG_MAX) { nsecs_t now = systemTime(SYSTEM_TIME_MONOTONIC); int messageTimeoutMillis = toMillisecondTimeoutDelay(now, mNextMessageUptime); if (messageTimeoutMillis &gt;= 0 &amp;&amp; (timeoutMillis &lt; 0 || messageTimeoutMillis &lt; timeoutMillis)) { timeoutMillis = messageTimeoutMillis; }#if DEBUG_POLL_AND_WAKE ALOGD(\"%p ~ pollOnce - next message in %\" PRId64 \"ns, adjusted timeout: timeoutMillis=%d\", this, mNextMessageUptime - now, timeoutMillis);#endif } // Poll. int result = POLL_WAKE; mResponses.clear(); mResponseIndex = 0; // We are about to idle. // å³å°†å¤„äºidleçŠ¶æ€ mPolling = true; // fdæœ€å¤§çš„ä¸ªæ•°æ˜¯16 struct epoll_event eventItems[EPOLL_MAX_EVENTS]; // ç­‰å¾…æ—¶é—´å‘ç”Ÿæˆ–è€…è¶…æ—¶ï¼Œåœ¨nativeWake()æ–¹æ³•ï¼Œå‘ç®¡é“å†™ç«¯å†™å…¥å­—ç¬¦ï¼Œåˆ™æ–¹æ³•ä¼šè¿”å›ã€‚ int eventCount = epoll_wait(mEpollFd, eventItems, EPOLL_MAX_EVENTS, timeoutMillis); // No longer idling. // ä¸å†å¤„äºidleçŠ¶æ€ mPolling = false; // è¯·æ±‚é” ï¼Œå› ä¸ºåœ¨Native Messageçš„å¤„ç†å’Œæ·»åŠ é€»è¾‘ä¸Šéœ€è¦åŒæ­¥ // Acquire lock. mLock.lock(); // Rebuild epoll set if needed. // å¦‚æœéœ€è¦ï¼Œé‡å»ºepoll if (mEpollRebuildRequired) { mEpollRebuildRequired = false; // epollé‡å»ºï¼Œç›´æ¥è·³è½¬åˆ°Done rebuildEpollLocked(); goto Done; } // Check for poll error. if (eventCount &lt; 0) { if (errno == EINTR) { goto Done; } ALOGW(\"Poll failed with an unexpected error, errno=%d\", errno); // epolläº‹ä»¶ä¸ªæ•°å°äº0ï¼Œå‘ç”Ÿé”™è¯¯ï¼Œç›´æ¥è·³è½¬Done result = POLL_ERROR; goto Done; } // Check for poll timeout. //å¦‚æœéœ€è¦ï¼Œé‡å»ºepoll if (eventCount == 0) { //epolläº‹ä»¶ä¸ªæ•°ç­‰äº0ï¼Œå‘ç”Ÿè¶…æ—¶ï¼Œç›´æ¥è·³è½¬Done#if DEBUG_POLL_AND_WAKE ALOGD(\"%p ~ pollOnce - timeout\", this);#endif result = POLL_TIMEOUT; goto Done; } // Handle all events.#if DEBUG_POLL_AND_WAKE ALOGD(\"%p ~ pollOnce - handling events from %d fds\", this, eventCount);#endif // å¾ªç¯å¤„ç†æ‰€æœ‰çš„äº‹ä»¶ for (int i = 0; i &lt; eventCount; i++) { int fd = eventItems[i].data.fd; uint32_t epollEvents = eventItems[i].events; //é¦–å…ˆå¤„ç†mWakeEventFd if (fd == mWakeEventFd) { //å¦‚æœæ˜¯å”¤é†’mWakeEventFdæœ‰ååº” if (epollEvents &amp; EPOLLIN) { /**é‡ç‚¹ä»£ç */ // å·²ç»å”¤é†’äº†ï¼Œåˆ™è¯»å–å¹¶æ¸…ç©ºç®¡é“æ•°æ® awoken(); // è¯¥å‡½æ•°å†…éƒ¨å°±æ˜¯readï¼Œä»è€Œä½¿FDå¯è¯»çŠ¶æ€è¢«æ¸…é™¤ } else { ALOGW(\"Ignoring unexpected epoll events 0x%x on wake event fd.\", epollEvents); } } else { // å…¶ä»–input fdå¤„ç†ï¼Œå…¶å®å°±æ˜¯å°†æ´»åŠ¨æ”¾å…¥responseé˜Ÿåˆ—ï¼Œç­‰å¾…å¤„ç† ssize_t requestIndex = mRequests.indexOfKey(fd); if (requestIndex &gt;= 0) { int events = 0; if (epollEvents &amp; EPOLLIN) events |= EVENT_INPUT; if (epollEvents &amp; EPOLLOUT) events |= EVENT_OUTPUT; if (epollEvents &amp; EPOLLERR) events |= EVENT_ERROR; if (epollEvents &amp; EPOLLHUP) events |= EVENT_HANGUP; // å¤„ç†requestï¼Œç”Ÿæˆå¯¹åº”çš„responseå¯¹è±¡ï¼Œpushåˆ°å“åº”æ•°ç»„ pushResponse(events, mRequests.valueAt(requestIndex)); } else { ALOGW(\"Ignoring unexpected epoll events 0x%x on fd %d that is \" \"no longer registered.\", epollEvents, fd); } } }Done: ; // Invoke pending message callbacks. // å†å¤„ç†Nativeçš„Messageï¼Œè°ƒç”¨ç›¸åº”å›è°ƒæ–¹æ³• mNextMessageUptime = LLONG_MAX; while (mMessageEnvelopes.size() != 0) { nsecs_t now = systemTime(SYSTEM_TIME_MONOTONIC); const MessageEnvelope&amp; messageEnvelope = mMessageEnvelopes.itemAt(0); if (messageEnvelope.uptime &lt;= now) { // Remove the envelope from the list. // We keep a strong reference to the handler until the call to handleMessage // finishes. Then we drop it so that the handler can be deleted *before* // we reacquire our lock. { // obtain handler sp&lt;MessageHandler&gt; handler = messageEnvelope.handler; Message message = messageEnvelope.message; mMessageEnvelopes.removeAt(0); mSendingMessage = true; // é‡Šæ”¾é” mLock.unlock();#if DEBUG_POLL_AND_WAKE || DEBUG_CALLBACKS ALOGD(\"%p ~ pollOnce - sending message: handler=%p, what=%d\", this, handler.get(), message.what);#endif // å¤„ç†æ¶ˆæ¯äº‹ä»¶ handler-&gt;handleMessage(message); } // release handler // è¯·æ±‚é” mLock.lock(); mSendingMessage = false; // å‘ç”Ÿå›è°ƒ result = POLL_CALLBACK; } else { // The last message left at the head of the queue determines the next wakeup time. mNextMessageUptime = messageEnvelope.uptime; break; } } // Release lock. // é‡Šæ”¾é” mLock.unlock(); // Invoke all response callbacks. // å¤„ç†å¸¦æœ‰Callback()æ–¹æ³•çš„responseäº‹ä»¶ï¼Œæ‰§è¡ŒResponseç›¸åº”çš„å›è°ƒæ–¹æ³• for (size_t i = 0; i &lt; mResponses.size(); i++) { Response&amp; response = mResponses.editItemAt(i); if (response.request.ident == POLL_CALLBACK) { int fd = response.request.fd; int events = response.events; void* data = response.request.data;#if DEBUG_POLL_AND_WAKE || DEBUG_CALLBACKS ALOGD(\"%p ~ pollOnce - invoking fd event callback %p: fd=%d, events=0x%x, data=%p\", this, response.request.callback.get(), fd, events, data);#endif // Invoke the callback. Note that the file descriptor may be closed by // the callback (and potentially even reused) before the function returns so // we need to be a little careful when removing the file descriptor afterwards. // å¤„ç†è¯·æ±‚çš„å›è°ƒæ–¹æ³• int callbackResult = response.request.callback-&gt;handleEvent(fd, events, data); if (callbackResult == 0) { // ç§»é™¤fd removeFd(fd, response.request.seq); } // Clear the callback reference in the response structure promptly because we // will not clear the response vector itself until the next poll. // æ¸…é™¤responseå¼•ç”¨çš„å›è°ƒæ–¹æ³• response.request.callback.clear(); // å‘ç”Ÿå›è°ƒ result = POLL_CALLBACK; } } return result;} pollOnceè¿”å›å€¼è¯´æ˜ POLL_WAKEï¼š è¡¨ç¤ºç”±wake()å‡ºå‘ï¼Œå³pipeå†™ç«¯çš„writeäº‹ä»¶è§¦å‘ POLL_CALLBACKï¼šè¡¨ç¤ºæŸä¸ªè¢«ç›‘å¬fdè¢«è§¦å‘ POLL_TIMEOUTï¼šè¡¨ç¤ºç­‰å¾…è¶…æ—¶ POLL_ERRORï¼šè¡¨ç¤ºç­‰å¾…æœŸé—´å‘ç”Ÿé”™è¯¯ pollInner()æ–¹æ³•çš„å¤„ç†æµç¨‹ï¼š 1ã€å…ˆè°ƒç”¨epoll_wait()ï¼Œè¿™æ˜¯é˜»å¡æ–¹æ³•ï¼Œç”¨äºç­‰å¾…äº‹ä»¶å‘ç”Ÿæˆ–è€…è¶…æ—¶ã€‚ 2ã€å¯¹äºepoll_wait()è¿”å›ï¼Œå½“ä¸”ä»…å½“ä»¥ä¸‹3ç§æƒ…å†µå‡ºç° POLL_ERRORï¼šå‘ç”Ÿé”™è¯¯ï¼Œç›´æ¥è·³è½¬Done POLL_TIMEOUTï¼šå‘ç”Ÿè¶…æ—¶ï¼Œç›´æ¥è·³è½¬åˆ°Done æ£€æµ‹åˆ°ç®¡é“æœ‰äº‹æƒ…å‘ç”Ÿï¼Œåˆ™å†æ ¹æ®æƒ…å†µåšç›¸åº”å¤„ç†ï¼š å¦‚æœæ£€æµ‹åˆ°ç®¡é“äº§ç”Ÿäº‹ä»¶ï¼Œåˆ™ç›´æ¥è¯»å–ç®¡é“çš„æ•°æ® å¦‚æœæ˜¯å…¶ä»–äº‹ä»¶ï¼Œåˆ™å¤„ç†requestï¼Œç”Ÿæˆå¯¹åº”çš„responseå¯¹è±¡ï¼Œpushåˆ°responseæ•°ç»„ 3ã€è¿›å…¥Doneæ ‡è®°ä½çš„ä»£ç ï¼š å…ˆå¤„ç†Nativeçš„Messageï¼Œè°ƒç”¨Nativeçš„Handleræ¥å¤„ç†è¯¥Message å†å¤„ç†Resposneæ•°ç»„ï¼ŒPOLL_CALLBACKç±»å‹çš„äº‹ä»¶ æ€»ç»“ä¸€ä¸‹ nativePollOnce() çš„æµç¨‹å°±æ˜¯ nativeWake()android_os_MessageQueue_nativeWake() 123456static void android_os_MessageQueue_nativeWake(JNIEnv* env, jclass clazz, jlong ptr) { // å°†Javaå±‚ä¼ é€’ä¸‹æ¥çš„mPtrè½¬æ¢ä¸ºnativeMessageQueue NativeMessageQueue* nativeMessageQueue = reinterpret_cast&lt;NativeMessageQueue*&gt;(ptr); //è°ƒç”¨wakeå‡½æ•° nativeMessageQueue-&gt;wake();} 123void NativeMessageQueue::wake() { mLooper-&gt;wake();} 1234567891011121314void Looper::wake() {#if DEBUG_POLL_AND_WAKE ALOGD(\"%p ~ wake\", this);#endif uint64_t inc = 1; // å‘ç®¡é“mWakeEventFdå†™å…¥å­—ç¬¦1 ssize_t nWrite = TEMP_FAILURE_RETRY(write(mWakeEventFd, &amp;inc, sizeof(uint64_t))); if (nWrite != sizeof(uint64_t)) { if (errno != EAGAIN) { ALOGW(\"Could not write wake signal, errno=%d\", errno); } }} 12Looperç±»çš„ wake()å‡½æ•°åªæ˜¯å¾€mWakeEventfdä¸­å†™äº†ä¸€äº›å†…å®¹ï¼Œè¿™ä¸ªfdåªæ˜¯é€šçŸ¥è€Œå·²ï¼Œç±»ä¼¼äºpipiï¼Œæœ€åä¼šæŠŠepoll_waiå”¤é†’ï¼Œçº¿ç¨‹å°±ä¸é˜»å¡äº†ç»§ç»­å‘é€Nativeå±‚çš„æ¶ˆæ¯ï¼Œç„¶åå¤„ç†ä¹‹å‰çš„addFdäº‹ä»¶ï¼Œç„¶åå¤„ç†Javaå±‚çš„æ¶ˆæ¯ã€‚ æ€»ç»“ä¸€ä¸‹ nativeWake() çš„æµç¨‹å°±æ˜¯ Nativeä¸Javaçš„å¯¹åº”å…³ç³»1MessageQueueé€šè¿‡mPtrå˜é‡ä¿å­˜äº†NativeMessageQueueå¯¹è±¡ï¼Œä»è€Œä½¿å¾—MessageQueueæˆä¸ºJavaå±‚å’ŒNativeå±‚çš„æ¢çº½ï¼Œæ—¢èƒ½å¤„ç†ä¸Šå±‚æ¶ˆæ¯ï¼Œä¹Ÿèƒ½å¤„ç†Nativeæ¶ˆæ¯ï¼Œä¸‹å›¾åˆ—ä¸¾äº†Javaå±‚ä¸Nativeå±‚çš„å¯¹åº”å›¾ 1ã€çº¢è‰²è™šçº¿å…³ç³»ï¼šJavaå±‚å’ŒNativeå±‚çš„MessageQueueé€šè¿‡JNIå»ºç«‹å…³è”ï¼Œå½¼æ­¤ä¹‹é—´èƒ½ç›¸äº’è°ƒç”¨ï¼Œææ˜ç™½è¿™ä¸ªäº’è°ƒå…³ç³»ï¼Œä¹Ÿå°±ææ˜ç™½Javaå¦‚ä½•è°ƒç”¨Cä»£ç ï¼ŒCä»£ç å¦‚ä½•è°ƒç”¨Javaä»£ç  2ã€è“è‰²è™šçº¿å…³ç³»ï¼šHandler/Looper/Messageè¿™ä¸‰å¤§ç±»Javaå±‚ä¸Nativeå±‚å¹¶æ²¡æœ‰ä»»ä½•çœŸæ­£çš„å…³ç³»ï¼Œåªæ˜¯åˆ†åˆ«åœ¨Javaå±‚å’ŒNativeå±‚çš„handleræ¶ˆæ¯æ¨¡å‹ä¸­å…·æœ‰ç›¸ä¼¼çš„åŠŸèƒ½ã€‚éƒ½æ˜¯å½¼æ­¤ç‹¬ç«‹çš„ï¼Œå„è‡ªå®ç°ç›¸åº”çš„é€»è¾‘ã€‚ 3ã€WeakMessageHandlerç»§æ‰¿ä¸MessageHandlerç±»ï¼ŒNativeMessageQueueç»§æ‰¿äºMessageQueueç±»ã€‚ å¦å¤–ï¼Œæ¶ˆæ¯å¤„ç†æµç¨‹æ˜¯å…ˆå¤„ç†NativeMessageï¼Œå†å¤„ç†Native Requestï¼Œæœ€åå¤„ç†Java Messageã€‚ç†è§£äº†è¯¥æµç¨‹ä¹Ÿå°±æ˜ç™½äº†æœ‰æ—¶ä¸Šå±‚æ¶ˆæ¯å¾ˆå°‘ï¼Œä½†å“åº”æ—¶é—´å´æ¯”è¾ƒé•¿çš„çœŸæ­£åŸå› ã€‚ æ€»ç»“ 1ã€NativeMessageQueueï¼šåœ¨MessageQueue.javaçš„æ„é€ å‡½æ•°ä¸­ï¼Œè°ƒç”¨äº†nativeInitåˆ›å»ºäº†NativeMessageQueueå¯¹è±¡ï¼Œå¹¶ä¸”æŠŠæŒ‡é’ˆå˜é‡è¿”å›ç»™Javaå±‚çš„mPtrã€‚è€Œåœ¨NativeMessageQueueçš„æ„é€ å‡½æ•°ä¸­ï¼Œä¼šåœ¨å½“å‰çº¿ç¨‹ä¸­åˆ›å»ºC++çš„Looperå¯¹è±¡ã€‚ 2ã€Looperï¼šæ§åˆ¶eventfdçš„è¯»å†™ï¼Œé€šè¿‡epollç›‘å¬eventfdçš„å˜åŒ–ï¼Œæ¥é˜»å¡è°ƒç”¨pollOnceå’Œæ¢å¤è°ƒç”¨wakeå½“å‰çº¿ç¨‹ é€šè¿‡ epollç›‘å¬å…¶ä»–æ–‡ä»¶æè¿°ç¬¦çš„å˜åŒ– é€šè¿‡ epollå¤„ç†C++å±‚çš„æ¶ˆæ¯æœºåˆ¶ï¼Œå½“è°ƒç”¨Looper::sendMessageAtTimeåï¼Œè°ƒç”¨wakeè§¦å‘epoll Looperçš„æ„é€ å‡½æ•°ï¼Œåˆ›å»ºä¸€ä¸ªeventfd(ä»¥å‰ç‰ˆæœ¬æ˜¯pipe)ï¼Œeventfdå®ƒçš„ä¸»è¦ç”¨äºè¿›ç¨‹æˆ–è€…çº¿ç¨‹é—´çš„é€šä¿¡ï¼Œç„¶ååˆ›å»ºepollæ¥ç›‘å¬è¯¥eventfdçš„å˜åŒ– Looper::pollOnce(int timeoutMillis) å†…éƒ¨è°ƒç”¨äº†pollInnerï¼Œå†è°ƒç”¨epoll_wait(mEpollFd, â€¦, timeoutMillis)é˜»å¡timeoutMillsæ—¶é—´ï¼Œå¹¶ç›‘å¬æ–‡ä»¶æè¿°ç¬¦mEpollFdçš„å˜åŒ–ï¼Œå½“æ—¶é—´åˆ°äº†æˆ–è€…æ¶ˆæ¯åˆ°äº†ï¼Œå³eventfdè¢«å†™å…¥å†…å®¹åï¼Œä»epoll_waitç»§ç»­å¾€ä¸‹æ‰§è¡Œï¼Œå¤„ç†epoll_waitè¿”å›çš„æ¶ˆæ¯ï¼Œè¯¥æ¶ˆæ¯æ—¢æœ‰å¯èƒ½æ˜¯eventfdäº§ç”Ÿçš„ï¼Œä¹Ÿå¯èƒ½æ˜¯å…¶ä»–æ–‡ä»¶æè¿°ç¬¦äº§ç”Ÿçš„ã€‚å¤„ç†é¡ºåºæ˜¯ï¼Œå…ˆå¤„ç†æ™®é€šçš„C++æ¶ˆæ¯é˜Ÿåˆ—mMessageEnvelopesï¼Œç„¶åå¤„ç†ä¹‹å‰addFdçš„äº‹ä»¶ï¼Œæœ€åä»pollOnceè¿”å›ï¼Œä¼šç»§ç»­MessageQueue.javaçš„next()å‡½æ•°ï¼Œå–å¾—Javaå±‚çš„æ¶ˆæ¯æ¥å¤„ç†ï¼› Looperç±»çš„wakeï¼Œå‡½æ•°åªæ˜¯å¾€mWakeEventfdä¸­å†™äº†ä¸€äº›å†…å®¹ï¼Œè¿™ä¸ªfdåªæ˜¯é€šçŸ¥è€Œå·²ï¼Œç±»ä¼¼pipeï¼Œæœ€åä¼šæŠŠepoll_waitå”¤é†’ï¼Œçº¿ç¨‹å°±ä¸é˜»å¡äº†ï¼Œç»§ç»­å…ˆå‘é€Cå±‚æ¶ˆæ¯ï¼Œç„¶åå¤„ç†ä¹‹å‰addFdäº‹ä»¶ï¼Œç„¶åå¤„ç†Javaå±‚æ¶ˆæ¯ äº” . æ„Ÿè°¢1234567891011http://gityuan.com/2015/12/26/handler-message-framework/ä½œè€…ï¼šéš”å£è€æå¤´é“¾æ¥ï¼šhttps://www.jianshu.com/p/91a4b797553dæ¥æºï¼šç®€ä¹¦è‘—ä½œæƒå½’ä½œè€…æ‰€æœ‰ã€‚å•†ä¸šè½¬è½½è¯·è”ç³»ä½œè€…è·å¾—æˆæƒï¼Œéå•†ä¸šè½¬è½½è¯·æ³¨æ˜å‡ºå¤„ã€‚ä½œè€…ï¼šLittleä¸¶Jerryé“¾æ¥ï¼šhttps://www.jianshu.com/p/a1d945c4f5a6æ¥æºï¼šç®€ä¹¦è‘—ä½œæƒå½’ä½œè€…æ‰€æœ‰ã€‚å•†ä¸šè½¬è½½è¯·è”ç³»ä½œè€…è·å¾—æˆæƒï¼Œéå•†ä¸šè½¬è½½è¯·æ³¨æ˜å‡ºå¤„ã€‚","link":"/2020/04/18/Android/hander/"},{"title":"finish()å’ŒonDestroy() åŒºåˆ«ä»€ä¹ˆï¼Ÿ","text":"1.finish åšäº†ä»€ä¹ˆï¼Ÿfinsh æ˜¯æˆ‘ä»¬ä¸»åŠ¨è°ƒç”¨çš„ã€‚èµ·ç‚¹æºäº android.app.Activity#finish() ä¸»è¦æ˜¯æŠŠå½“å‰Activityä»Taskæ ˆä¸­ç§»é™¤ã€‚ 1234public void finish() { //å…³é—­Activity,ä½†æ˜¯ä¸å…³é—­taskæ ˆ finish(DONT_FINISH_TASK_WITH_ACTIVITY);} android.app.Activity#finish(int) 12345678910111213141516171819202122232425262728private void finish(int finishTask) { if (mParent == null) { int resultCode; Intent resultData; synchronized (this) { resultCode = mResultCode; resultData = mResultData; } try { if (resultData != null) { // æœ‰æ•°æ®éœ€è¦è¿”å›ç»™è°ƒç”¨æ–¹,æ¯”å¦‚startActivityForResult resultData.prepareToLeaveProcess(this); } //è¿™é‡Œå®é™…å®é™…ä¸Šæ˜¯é€šè¿‡android.app.IActivityManager$Stub$Proxy, ä¹Ÿå°±AIDL Binder æœºåˆ¶ //æŠŠmTokenå‘é€åˆ°AMS if (ActivityManager.getService() .finishActivity(mToken, resultCode, resultData, finishTask)) { mFinished = true; } } catch (RemoteException e) { // Empty } } else { mParent.finishFromChild(this); } --- } com.android.server.am.ActivityManagerService#finishActivity 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859606162636465666768697071727374757677787980818283848586/** * This is the internal entry point for handling Activity.finish(). * * @param token The Binder token referencing the Activity we want to finish. * @param resultCode Result code, if any, from this Activity. * @param resultData Result data (Intent), if any, from this Activity. * @param finishTask Whether to finish the task associated with this Activity. * * @return Returns true if the activity successfully finished, or false if it is still running. */ @Override public final boolean finishActivity(IBinder token, int resultCode, Intent resultData, int finishTask) { // Refuse possible leaked file descriptors if (resultData != null &amp;&amp; resultData.hasFileDescriptors() == true) { throw new IllegalArgumentException(\"File descriptors passed in Intent\"); } synchronized(this) { ActivityRecord r = ActivityRecord.isInStackLocked(token); if (r == null) { return true; } // Keep track of the root activity of the task before we finish it TaskRecord tr = r.getTask(); ActivityRecord rootR = tr.getRootActivity(); if (rootR == null) { Slog.w(TAG, \"Finishing task with all activities already finished\"); } // Do not allow task to finish if last task in lockTask mode. Launchable priv-apps can // finish. if (mLockTaskController.activityBlockedFromFinish(r)) { return false; } if (mController != null) { // Find the first activity that is not finishing. ActivityRecord next = r.getStack().topRunningActivityLocked(token, 0); if (next != null) { // ask watcher if this is allowed boolean resumeOK = true; try { resumeOK = mController.activityResuming(next.packageName); } catch (RemoteException e) { mController = null; Watchdog.getInstance().setActivityController(null); } if (!resumeOK) { Slog.i(TAG, \"Not finishing activity because controller resumed\"); return false; } } } final long origId = Binder.clearCallingIdentity(); try { boolean res; final boolean finishWithRootActivity = finishTask == Activity.FINISH_TASK_WITH_ROOT_ACTIVITY; if (finishTask == Activity.FINISH_TASK_WITH_ACTIVITY || (finishWithRootActivity &amp;&amp; r == rootR)) { // If requested, remove the task that is associated to this activity only if it // was the root activity in the task. The result code and data is ignored // because we don't support returning them across task boundaries. Also, to // keep backwards compatibility we remove the task from recents when finishing // task with root activity. res = mStackSupervisor.removeTaskByIdLocked(tr.taskId, false, finishWithRootActivity, \"finish-activity\"); if (!res) { Slog.i(TAG, \"Removing task failed to finish activity\"); } } else { //èµ°è¿™é‡Œ res = tr.getStack().requestFinishActivityLocked(token, resultCode, resultData, \"app-request\", true); if (!res) { Slog.i(TAG, \"Failed to finish by app-request\"); } } return res; } finally { Binder.restoreCallingIdentity(origId); } } } com.android.server.am.ActivityStack#requestFinishActivityLocked 123456789101112131415161718/** * @return Returns true if the activity is being finished, false if for * some reason it is being left as-is. */final boolean requestFinishActivityLocked(IBinder token, int resultCode, Intent resultData, String reason, boolean oomAdj) { ActivityRecord r = isInStackLocked(token); if (DEBUG_RESULTS || DEBUG_STATES) Slog.v(TAG_STATES, \"Finishing activity token=\" + token + \" r=\" + \", result=\" + resultCode + \", data=\" + resultData + \", reason=\" + reason); if (r == null) { return false; } finishActivityLocked(r, resultCode, resultData, reason, oomAdj); return true;} ActivityStack#finishActivityLocked 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899/** * @return Returns true if this activity has been removed from the history * list, or false if it is still in the list and will be removed later. */final boolean finishActivityLocked(ActivityRecord r, int resultCode, Intent resultData, String reason, boolean oomAdj, boolean pauseImmediately) { if (r.finishing) { Slog.w(TAG, \"Duplicate finish request for \" + r); return false; } mWindowManager.deferSurfaceLayout(); try { r.makeFinishingLocked(); //å°†Ativityå¯¹åº”çš„finishingå±æ€§ç½®ä¸ºtrue final TaskRecord task = r.getTask(); EventLog.writeEvent(EventLogTags.AM_FINISH_ACTIVITY, r.app != null ? r.app.pid : 0, System.identityHashCode(r), task.taskId, r.shortComponentName, reason); //æ‰“å°event log final ArrayList&lt;ActivityRecord&gt; activities = task.mActivities; final int index = activities.indexOf(r); if (index &lt; (activities.size() - 1)) { //å¦‚æœè¦finishçš„Activityä¸æ˜¯taské¡¶éƒ¨çš„Activity task.setFrontOfTask(); if ((r.intent.getFlags() &amp; Intent.FLAG_ACTIVITY_CLEAR_WHEN_TASK_RESET) != 0) { // If the caller asked that this activity (and all above it) // be cleared when the task is reset, don't lose that information, // but propagate it up to the next activity. ActivityRecord next = activities.get(index+1); next.intent.addFlags(Intent.FLAG_ACTIVITY_CLEAR_WHEN_TASK_RESET); } } r.pauseKeyDispatchingLocked(); adjustFocusedActivityStack(r, \"finishActivity\"); //è°ƒæ•´focus activityStack(å½“å‰stack è°ƒç”¨topRunningActivityLockedä¸ºnullï¼Œå³å½“å‰stackä¸­çš„æ‰€æœ‰taskä¸­çš„Activityæ²¡æœ‰æ­£åœ¨runningçš„ï¼Œé‚£ä¹ˆæ­¤Activityä¸èƒ½å†åšå‰å°ï¼Œè¦ç§»åˆ°åé¢) finishActivityResultsLocked(r, resultCode, resultData); //å¦‚æœè¦finishçš„Activityæœ‰resultToï¼Œå‘å…¶ä¼ é€’result final boolean endTask = index &lt;= 0 &amp;&amp; !task.isClearingToReuseTask(); //æ˜¯å¦è¦é”€æ¯task(å½“è¦é”€æ¯çš„Activityåœ¨taskä¸­çš„index&lt;=0) final int transit = endTask ? TRANSIT_TASK_CLOSE : TRANSIT_ACTIVITY_CLOSE; if (mResumedActivity == r) { if (DEBUG_VISIBILITY || DEBUG_TRANSITION) Slog.v(TAG_TRANSITION, \"Prepare close transition: finishing \" + r); if (endTask) { mService.mTaskChangeNotificationController.notifyTaskRemovalStarted( task.taskId); } mWindowManager.prepareAppTransition(transit, false); // Tell window manager to prepare for this one to be removed. r.setVisibility(false); if (mPausingActivity == null) { if (DEBUG_PAUSE) Slog.v(TAG_PAUSE, \"Finish needs to pause: \" + r); if (DEBUG_USER_LEAVING) Slog.v(TAG_USER_LEAVING, \"finish() =&gt; pause with userLeaving=false\"); startPausingLocked(false, false, null, pauseImmediately); //è°ƒç”¨startPausingLockedï¼Œfinishä¹‹å‰éœ€è¦å…ˆpauseï¼Œæ³¨æ„resumingä¸ºnull } if (endTask) { mService.getLockTaskController().clearLockedTask(task); } } else if (!r.isState(PAUSING)) { //è¿™ç§æƒ…å†µæ˜¯finishçš„ä¸æ˜¯resumed Activityçš„æƒ…å†µ // If the activity is PAUSING, we will complete the finish once // it is done pausing; else we can just directly finish it here. if (DEBUG_PAUSE) Slog.v(TAG_PAUSE, \"Finish not pausing: \" + r); if (r.visible) { prepareActivityHideTransitionAnimation(r, transit); } final int finishMode = (r.visible || r.nowVisible) ? FINISH_AFTER_VISIBLE : FINISH_AFTER_PAUSE; final boolean removedActivity = finishCurrentActivityLocked(r, finishMode, oomAdj, \"finishActivityLocked\") == null; //ä¹Ÿæ˜¯è°ƒç”¨finishCurrentActivityLocked // The following code is an optimization. When the last non-task overlay activity // is removed from the task, we remove the entire task from the stack. However, // since that is done after the scheduled destroy callback from the activity, that // call to change the visibility of the task overlay activities would be out of // sync with the activitiy visibility being set for this finishing activity above. // In this case, we can set the visibility of all the task overlay activities when // we detect the last one is finishing to keep them in sync. if (task.onlyHasTaskOverlayActivities(true /* excludeFinishing */)) { for (ActivityRecord taskOverlay : task.mActivities) { if (!taskOverlay.mTaskOverlay) { continue; } prepareActivityHideTransitionAnimation(taskOverlay, transit); } } return removedActivity; } else { if (DEBUG_PAUSE) Slog.v(TAG_PAUSE, \"Finish waiting for pause of: \" + r); } return false; } finally { mWindowManager.continueSurfaceLayout(); }} æ€»çš„æµç¨‹ 2.onDestory åšäº†ä»€ä¹ˆï¼ŸonDestoryä¸»è¦æ˜¯è¿›è¡Œèµ„æºå›æ”¶ï¼ŒæŠŠè¿˜åœ¨å ç”¨çš„èµ„æºé‡Šæ”¾ï¼Œé‡Œé¢æœ‰å¾ˆå¤šcloseã€‚ onDestory å›è°ƒæ–¹æ³•ä¹Ÿæ˜¯ç”±AMSå‘å‡º çš„ ClientTransaction æ¶ˆæ¯ï¼Œç„¶åä¸»çº¿ç¨‹çš„looperå¤„ç†è¿™ä¸ªæ¶ˆæ¯ï¼Œé€šè¿‡ transaction.getLifecycleStateRequest() è·çŸ¥æ˜¯ DestroyActivityItem ,æœ€åå°±ä¸€æ­¥æ­¥è°ƒç”¨åˆ°onDestoryäº†ã€‚ è°ƒç”¨è¿‡ç¨‹å¦‚ä¸‹ 1234567891011121314151617181920212223242526272829onDestroy():95, MainActivityperformDestroy():7395, Activity (android.app)// è½¬å‘callActivityOnDestroy(Activity):1306, Instrumentation (android.app)performDestroyActivity(IBinder, boolean, int, boolean, String):4443, ActivityThread (android.app)handleDestroyActivity(IBinder, boolean, int, boolean, String):4476, ActivityThread (android.app)execute(ClientTransactionHandler, IBinder, PendingTransactionActions):39, DestroyActivityItem (android.app.servertransaction)// è·å–æ˜¯ DestroyActivityItem ï¼Œç„¶åäº¤ç»™ä¸Šé¢å¤„ç†executeLifecycleState(ClientTransaction):145, TransactionExecutor (android.app.servertransaction)//å¤„ç†execute(ClientTransaction):70, TransactionExecutor (android.app.servertransaction)//è¿™ä¸ªæ˜¯ç”±ä¸»çº¿ç¨‹é»˜è®¤çš„å†…éƒ¨Hander H æ¥å¤„ç†çš„handleMessage(Message):1808, ActivityThread$H (android.app)// åˆ†å‘åˆ°ç›®æ ‡Handerå¤„ç†dispatchMessage(Message):106, Handler (android.os)//looperåœ¨è¿™é‡Œæ­»å¾ªç¯ ï¼Œç­‰åˆ°ä¸€ä¸ªAMSå‘å‡º çš„ ClientTransaction æ¶ˆæ¯//æ˜¯æ€ä¹ˆæ”¶åˆ°äº†å‘¢ï¼Ÿæ˜¯AMSè·¨è¿›ç¨‹å‘é€çš„ï¼Œç„¶ånativeæ”¶åˆ°æ¶ˆæ¯ï¼Œå‘ä¸Šå‘é€ã€‚//åœ¨MessagQueueçš„nativeInitä¼šå…³è”nativeå±‚çš„NativeLooperå’ŒNativeMessagQueueloop():193, Looper (android.os)main(String[]):6669, ActivityThread (android.app)invoke(Object, Object[]):-1, Method (java.lang.reflect)run():493, RuntimeInit$MethodAndArgsCaller (com.android.internal.os)main(String[]):858, ZygoteInit (com.android.internal.os) å†æ¥çœ‹ä¸‹ android.app.Activity#onDestroy 1234567891011121314151617181920212223242526272829303132333435363738394041424344protected void onDestroy() { if (DEBUG_LIFECYCLE) Slog.v(TAG, \"onDestroy \" + this); mCalled = true; // dismiss any dialogs we are managing. // å–æ¶ˆæ‰€æœ‰çš„ dialogs if (mManagedDialogs != null) { final int numDialogs = mManagedDialogs.size(); for (int i = 0; i &lt; numDialogs; i++) { final ManagedDialog md = mManagedDialogs.valueAt(i); if (md.mDialog.isShowing()) { md.mDialog.dismiss(); } } mManagedDialogs = null; } // close any cursors we are managing. // å…³é—­æ‰€æœ‰çš„cursors synchronized (mManagedCursors) { int numCursors = mManagedCursors.size(); for (int i = 0; i &lt; numCursors; i++) { ManagedCursor c = mManagedCursors.get(i); if (c != null) { c.mCursor.close(); } } mManagedCursors.clear(); } // Close any open search dialog // å…³é—­ if (mSearchManager != null) { mSearchManager.stopSearch(); } if (mActionBar != null) { // æœ‰ActionBar,è°ƒç”¨onDestroy mActionBar.onDestroy(); } //æœ€åäº¤ç»™Application dispatch getApplication().dispatchActivityDestroyed(this); } android.app.Application#dispatchActivityDestroyed 123456789void dispatchActivityDestroyed(Activity activity) { // é€šçŸ¥å’Œå›è°ƒæ‰€æœ‰çš„ callbacksã€‚å¦‚æœæœ‰æ³¨å†Œäº†ActivityLifecycleCallbacks Object[] callbacks = collectActivityLifecycleCallbacks(); if (callbacks != null) { for (int i=0; i&lt;callbacks.length; i++) { ((ActivityLifecycleCallbacks)callbacks[i]).onActivityDestroyed(activity); } } } å¯ä»¥é€šè¿‡ android.app.Application#registerActivityLifecycleCallbacks æ³¨å†Œdestroye callbacks åŸºæœ¬åˆ°è¿™é‡ŒonDestroy å°±æ˜¯å·²ç»åšå®Œäº†ã€‚ å†æ¬¡æ€»ç»“ finish ä¸»åŠ¨è°ƒç”¨ï¼Œactivityæ ˆä¸­å°±æ²¡æœ‰è¿™ä¸ªäº†ï¼Œå†ä¹Ÿä¸èƒ½è¿”å›åˆ°è¿™ä¸ªactivityã€‚ä½†æ˜¯è¿™ä¸ªactivityå®ä¾‹å¯¹è±¡è¿˜åœ¨å †ä¸­ onDestory AMSå›è°ƒ,è°ƒç”¨ï¼Œæ¯”å¦‚ä¸Šæ»‘å…³é—­Activityï¼Œæ¯”å¦‚æ‰‹åŠ¨è°ƒç”¨finishå¼•å‘onDestoryã€‚onDestroyåªæ˜¯å…³é—­è¿™ä¸ªActivityå¯¹è±¡ æŒæœ‰çš„ä¸€äº›ç³»ç»Ÿèµ„æºã€‚ä½†æ˜¯è¿™ä¸ªactivityå®ä¾‹å¯¹è±¡è¿˜åœ¨å †ä¸­ å­˜åœ¨å†…å­˜æ³„æ¼é—®é¢˜ï¼Ÿå°±æ˜¯ä¸Šé¢çš„finishå’ŒonDestory åšå®Œä¹‹åï¼Œè¿™ä¸ªactivityå®ä¾‹å¯¹è±¡è¿˜åœ¨å †ä¸­ï¼Œè¿˜è¦ç­‰å¾…GCçš„åˆ°æ¥ï¼Œä½†æ˜¯ï¼Œä½†æ˜¯, å¦‚æœæˆ‘ä»¬åœ¨å…¶å®ƒåœ°æ–¹é”™è¯¯çš„ä¿ç•™äº†ä¸€ä¸ªå¯¹è¯¥activityå®ä¾‹çš„å¼•ç”¨ï¼Œé—´æ¥æˆ–ç›´æ¥çš„å¼•ç”¨ï¼Œå°±ä¼šå‘ç”Ÿå†…å­˜æ³„æ¼ã€‚å°±ç®—ä½ èµ°å®Œäº†finishå’ŒonDestoryã€‚æœ€å¸¸è§é”™è¯¯çš„å°±æ˜¯ åœ¨Activity ä¸­ ä¿ç•™äº†æŸä¸€ä¸ªå•åˆ—çš„å¼•ç”¨ æ¥æºåŠæ„Ÿè°¢Activityç›¸å…³å­¦ä¹ -finish activity https://www.jianshu.com/p/f3dbf635f2c4","link":"/2020/04/29/Android/finishandestroy/"},{"title":"Jsonè½¬Mapçš„åå‡ºç°ClassCastException","text":"è¿è¡Œé”™è¯¯æµ‹è¯•ä»£ç  12345678910import com.google.gson.Gsonfun main() { val map = HashMap&lt;String, Int&gt;() map[\"key1\"] = 111111 val jsonString = Gson().toJson(map) println(map::class.java) val hashMap = Gson().fromJson(jsonString, map::class.java) val key1:Int? = hashMap[\"key1\"] println(key1)} è¿è¡Œçš„æ—¶å€™ï¼Œä¼šæŠ›ç±»å‹è½¬æ¢é”™è¯¯ 1234class java.util.HashMapException in thread \"main\" java.lang.ClassCastException: java.lang.Double cannot be cast to java.lang.Integer at MainTestKt.main(MainTest.kt:9) at MainTestKt.main(MainTest.kt) æºç åˆ†æè¿½è¸ªè°ƒç”¨æ ˆï¼Œå‘ç°Gsoné‡Œé¢å¤„ç†numberçš„é€»è¾‘,èµ°åˆ° MapTypeAdapterFactory é‡Œé¢ 1234567read:161, MapTypeAdapterFactory$Adapter (com.google.gson.internal.bind)read:145, MapTypeAdapterFactory$Adapter (com.google.gson.internal.bind)fromJson:888, Gson (com.google.gson)fromJson:853, Gson (com.google.gson)fromJson:802, Gson (com.google.gson)fromJson:774, Gson (com.google.gson)main:8, MainTestKt com.google.gson.internal.bind.ObjectTypeAdapter#read1234567891011121314151617181920212223242526272829303132333435363738@Override public Object read(JsonReader in) throws IOException { JsonToken token = in.peek(); switch (token) { case BEGIN_ARRAY: List&lt;Object&gt; list = new ArrayList&lt;Object&gt;(); in.beginArray(); while (in.hasNext()) { list.add(read(in)); } in.endArray(); return list; case BEGIN_OBJECT: Map&lt;String, Object&gt; map = new LinkedTreeMap&lt;String, Object&gt;(); in.beginObject(); while (in.hasNext()) { map.put(in.nextName(), read(in)); } in.endObject(); return map; case STRING: return in.nextString(); case NUMBER: return in.nextDouble(); case BOOLEAN: return in.nextBoolean(); case NULL: in.nextNull(); return null; default: throw new IllegalStateException(); } } ä¸Šé¢ğŸ‘†ğŸ»æºç å¯ä»¥çœ‹åˆ°ï¼Œè¿™é‡Œåªé’ˆå¯¹å¤„ç†äº†STRINGï¼ŒNUMBERï¼ŒBOOLEANï¼ŒNULLçš„4ä¸­ç±»å‹ï¼Œå…¶ä¸­å¯¹NUMBERç±»å‹ï¼Œéƒ½æ˜¯ç”¨Doubleå»æ¥å—çš„ã€‚ä¸ºä»€ä¹ˆç¼–è¯‘çš„æ—¶å€™OKï¼Ÿ ç±»å‹æ“¦é™¤æ‰€æœ‰çš„æ³›å‹éƒ½æ˜¯ç¼–è¯‘æœŸé—´æ¦‚å¿µï¼Œåœ¨ç¼–è¯‘ä¹‹åï¼Œè¿è¡Œçš„æ—¶å€™ï¼Œæ˜¯æ„ŸçŸ¥ä¸åˆ°æ³›å‹çš„ã€‚æ³›å‹åœ¨ç¼–è¯‘çš„æ—¶å€™è¢«æ“¦é™¤äº†ï¼Œä¹Ÿå°±æ˜¯è¾“å‡ºclass nameçš„æ—¶å€™ï¼Œè¿˜æ˜¯mapæœ¬èº«ã€‚æ³›å‹ä¼šåœ¨ç¼–è¯‘çš„æ—¶å€™ï¼Œåšæ£€æŸ¥ã€‚ä¾‹å¦‚æˆ‘ä»¬ç”¨doubleå»æ¥å—ï¼Œç¼–è¯‘å™¨ä¼šæŠ›é”™ï¼Œå°½ç®¡è¿è¡Œçš„æ—¶å€™æ˜¯doubleç±»å‹ã€‚ç¼–è¯‘ä¹‹åå†åç¼–è¯‘å›æ¥, è¿è¡Œæ—¶çš„é€»è¾‘å°±æ˜¯è¿™æ ·çš„ï¼Œå¹¶æ²¡æœ‰æ³›å‹ä¿¡æ¯ã€‚å¯ä»¥çœ‹åˆ°è¿™é‡Œæœ‰ä¸ªå¼ºè½¬ï¼Œè€ŒIntegeræ˜¯åŒ…è£…ç±»å‹ï¼Œä¸æ˜¯åŸºæœ¬ç±»å‹ï¼Œæ— æ³•å¼ºè½¬ï¼Œå¯¼è‡´æŠ›é”™ã€‚ 12345678910public static final void main() { HashMap map = new HashMap(); ((Map)map).put(\"key1\", 111111); String jsonString = (new Gson()).toJson(map); Class var2 = map.getClass(); System.out.println(var2); HashMap hashMap = (HashMap)(new Gson()).fromJson(jsonString, map.getClass()); Integer key1 = (Integer)hashMap.get(\"key1\"); System.out.println(key1);} JS numberç±»å‹JSONï¼ˆJavaScript Object Notation, JSå¯¹è±¡ç®€è°±ï¼‰ï¼Œå’Œå…¶ä»–è¯­è¨€æœ‰å¤šç§æ•°å€¼ç±»å‹ä¸åŒï¼Œint/longint/float/doubleç­‰ï¼ŒJS ä¸åˆ†æ•´æ•°å’Œæµ®ç‚¹å‹ï¼Œæ‰€æœ‰æ•°å­—éƒ½ä½¿ç”¨æµ®ç‚¹å‹æ¥å‚¨å­˜ã€‚ æ€»ç»“å¯ä»¥æˆåŠŸè¿è¡Œ 123456789fun main() { val map = HashMap&lt;String, Int&gt;() map[\"key1\"] = 111111 val jsonString = Gson().toJson(map) println(map::class.java) val hashMap = Gson().fromJson(jsonString, map::class.java) val key1:Any? = hashMap[\"key1\"] println(key1)} 1234class java.util.HashMap111111.0Process finished with exit code 0 æˆ‘çš„ç†è§£æ˜¯Gsonå’ŒJson è¡¨ç¤ºå¯¹é½ï¼Œé»˜è®¤numberç±»å‹ä¹Ÿæ˜¯ç”¨doubleå»è§£æçš„ï¼Œå½“ä¸€ä¸ªstring jsonè½¬æ¢æˆmapçš„æ—¶å€™ï¼Œæ˜¯æ„ŸçŸ¥ä¸åˆ°æ³›å‹çš„ï¼Œå®é™…ä¸Šçš„mapæ˜¯map&lt;string,object&gt;ç±»å‹ï¼Œè€Œå†™ä»£ç çš„æ—¶å€™å­˜åœ¨æ³›å‹è¿‡äº†ç¼–è¯‘ï¼Œå¯¼è‡´è¿è¡Œçš„æ—¶å€™æŠ›é”™","link":"/2022/08/20/Android/json2map-cast-error/"},{"title":"ä½ æ˜¯æ€ä¹ˆæ”¶åˆ° TouchEvent çš„ï¼Ÿ","text":"åŸºäºAndroid 9 åˆ†æ InputEventReceiveræ¡†æ¶å±‚å¯è§çš„ç‚¹å‡»äº‹ä»¶ä»å“ªé‡Œæ¥ï¼Ÿæ‰€æœ‰çš„äº‹ä»¶éƒ½æ˜¯ç”±InputEventReceiver å…ˆæ¥å—å†åˆ†å‘å‡ºæ¥çš„ï¼Œ 123456 // Called from native code.@SuppressWarnings(\"unused\")private void dispatchInputEvent(int seq, InputEvent event, int displayId) { mSeqMap.put(event.getSequenceNumber(), seq); onInputEvent(event, displayId);} é‚£native code åˆæ˜¯æ€ä¹ˆæ‰ä¼šè°ƒä¸Šæ¥çš„å‘¢ï¼Ÿé‚£å°±æ˜¯åœ¨ InputEventReceiver åˆå§‹åŒ–çš„æ—¶å€™ï¼Œéœ€è¦æ³¨å†Œã€‚å°±æ˜¯åœ¨ nativeInit æ–¹æ³•é‡Œé¢ 123456789101112131415161718192021/** * Creates an input event receiver bound to the specified input channel. * * @param inputChannel The input channel. * @param looper The looper to use when invoking callbacks. */ public InputEventReceiver(InputChannel inputChannel, Looper looper) { if (inputChannel == null) { throw new IllegalArgumentException(\"inputChannel must not be null\"); } if (looper == null) { throw new IllegalArgumentException(\"looper must not be null\"); } mInputChannel = inputChannel; mMessageQueue = looper.getQueue(); mReceiverPtr = nativeInit(new WeakReference&lt;InputEventReceiver&gt;(this), inputChannel, mMessageQueue); mCloseGuard.open(\"dispose\"); } InputChannel An input channel specifies the file descriptors used to send input events to a window in another process. It is Parcelable so that it can be sent to the process that is to receive events. Only one thread should be reading from an InputChannel at a time. è¾“å…¥é€šé“æŒ‡å®šç”¨äºåœ¨å¦ä¸€ä¸ªè¿›ç¨‹ä¸­å°†è¾“å…¥äº‹ä»¶å‘é€åˆ°çª—å£çš„æ–‡ä»¶æè¿°ç¬¦ã€‚ å®ƒæ˜¯Parcelableï¼Œå› æ­¤å¯ä»¥å°†å…¶å‘é€åˆ°è¦æ¥æ”¶äº‹ä»¶çš„è¿›ç¨‹ã€‚ ä¸€æ¬¡åªèƒ½ä¸€ä¸ªçº¿ç¨‹ä»InputChannelè¯»å–ã€‚ 12private static native long nativeInit(WeakReference&lt;InputEventReceiver&gt; receiver, InputChannel inputChannel, MessageQueue messageQueue); å…ˆæ¥çœ‹ä¸€ InputEventReceiver çš„åˆå§‹åŒ– åˆæ˜¯è°è°ƒç”¨çš„å‘¢ï¼Ÿåœ¨æˆ‘ä»¬å¯åŠ¨Appçš„æ—¶å€™ï¼Œæœ€å…ˆç”±AMSè·¨è¿›ç¨‹ä¼ è¾“çš„ä¸€ä¸ªClientTransactionï¼Œå®¢æˆ·ç«¯è¿›ç¨‹ApplicationThreadæ¥æ”¶ï¼Œç„¶åå‘é€åˆ°ä¸»çº¿ç¨‹ActivityThreadï¼Œæœ€åç”±TransactionExecutorç»Ÿä¸€è§£æã€‚AMSå°è£…å¹¶ä¼ è¾“ClientTransactionï¼Œç»Ÿä¸€æ¥å£ï¼›å®¢æˆ·ç«¯è¿›ç¨‹æ¥æ”¶ClientTransactionå¹¶ä½¿ç”¨TransactionExecutorè§£æAMSçš„è¯·æ±‚ï¼Œå†æ ¹æ®ActivityLifecycleItemæ‰§è¡Œä¸åŒçš„ä»£ç ã€‚Activityçš„ç”Ÿå‘½å‘¨æœŸå°±æ˜¯ transaction.getLifecycleStateRequest() è·å–çš„ï¼Œç„¶åå†æ‰§è¡Œå“åº”çš„ç”Ÿå‘½å‘¨æœŸå›è°ƒã€‚ è°ƒç”¨æ ˆ 123456789101112131415161718192021222324252627282930313233343536373839&lt;init&gt;(InputChannel, Looper):60, InputEventReceiver (android.view)&lt;init&gt;(ViewRootImpl, InputChannel, Looper):7190, //æœ€ç»ˆè°ƒç”¨åˆ° InputEventReceiver åˆå§‹åŒ–ViewRootImpl$WindowInputEventReceiver (android.view)//è¿™é‡Œä¼šåˆå§‹åŒ–å‡ ä¸ªinputStagesetView(View, WindowManager$LayoutParams, View):847, ViewRootImpl (android.view)//DecorView æ·»åŠ  æˆ‘ä»¬è‡ªå·±å†™çš„ MainActivityaddView(View, ViewGroup$LayoutParams, Display, Window):356, WindowManagerGlobal (android.view)//WindowManagerGlobal æ·»åŠ  DecorViewaddView(View, ViewGroup$LayoutParams):93, WindowManagerImpl (android.view)//æ‰§è¡Œ ResumehandleResumeActivity(IBinder, boolean, boolean, String):3868, ActivityThread (android.app)execute(ClientTransactionHandler, IBinder,PendingTransactionActions):51, ResumeActivityItem (android.app.servertransaction)//executeLifecycleStateæ–¹æ³•æ˜¯ç”¨æ¥æ”¹å˜Activityçš„ç”Ÿå‘½å‘¨æœŸçŠ¶æ€çš„//transaction.getLifecycleStateRequest() è·å–çš„executeLifecycleState(ClientTransaction):145, //ç„¶åäº¤ç»™TransactionExecutor ç»Ÿä¸€è°ƒåº¦TransactionExecutor (android.app.servertransaction)execute(ClientTransaction):70, TransactionExecutor (android.app.servertransaction)//é¦–å…ˆæ˜¯ActivityThread æ”¶åˆ°ä¸€ä¸ªClientTransactionçš„æ¶ˆæ¯handleMessage(Message):1808, ActivityThread$H (android.app)dispatchMessage(Message):106, Handler (android.os)loop():193, Looper (android.os)main(String[]):6669, ActivityThread (android.app)invoke(Object, Object[]):-1, Method (java.lang.reflect)run():493, RuntimeInit$MethodAndArgsCaller (com.android.internal.os)main(String[]):858, ZygoteInit (com.android.internal.os) æˆ‘ä»¬å¯ä»¥çœ‹åˆ° åœ¨ android.view.ViewRootImpl#setViewå½“ä¸­è°ƒç”¨äº†,è¿™ä¸ªlooperå°±æ˜¯ä¸»çº¿ç¨‹çš„looepräº†ã€‚è¿™ä¸ªInputChannel å®é™…ä¸ŠæŒ‡å‘æˆ‘ä»¬è‡ªå·±å†™çš„MainActivity (client) 12mInputEventReceiver = new WindowInputEventReceiver(mInputChannel, Looper.myLooper()); å†æ¥çœ‹ä¸€ nativeInit åˆåšäº†ä»€ä¹ˆå‘¢ï¼Ÿåœ¨NativeInputEventReceiverçš„nativeInitæ–¹æ³•ä¸­ï¼Œåˆ›å»ºäº†NativeInputEventReceiverå¯¹è±¡ï¼Œå¹¶è°ƒç”¨å®ƒçš„initializeæ–¹æ³• 1234567891011121314151617static jint nativeInit(JNIEnv* env, jclass clazz, jobject receiverWeak, jobject inputChannelObj, jobject messageQueueObj) { ... //ç”¨ä¼ è¿‡æ¥çš„inputChannelå’ŒmessageQueueæ„å»ºä¸€ä¸ªNativeInputEventReceiver sp&lt;NativeInputEventReceiver&gt; receiver = new NativeInputEventReceiver(env, receiverWeak, inputChannel, messageQueue); //ç„¶åè°ƒç”¨å®ƒçš„åˆå§‹åŒ–æ–¹æ³• status_t status = receiver-&gt;initialize(); ...}status_t NativeInputEventReceiver::initialize() { setFdEvents(ALOOPER_EVENT_INPUT); return OK;} mMessageQueue-&gt;getLooper()-&gt;addFd(fd, 0, events, this, NULL); å®é™…ä¸Šå°±æŠŠJAVAå±‚çš„Looperå…³è”ALOOPER_EVENT_INPUT 1234567891011void NativeInputEventReceiver::setFdEvents(int events) { if (mFdEvents != events) { mFdEvents = events; int fd = mInputConsumer.getChannel()-&gt;getFd(); if (events) { mMessageQueue-&gt;getLooper()-&gt;addFd(fd, 0, events, this, NULL); } else { mMessageQueue-&gt;getLooper()-&gt;removeFd(fd); } }} fdï¼Œfdå³inputChannelçš„socket fdï¼ŒLooperä¼šä¾¦æµ‹è¯¥fdçš„çŠ¶æ€ eventsï¼Œå³ä¼ å…¥çš„ALOOPER_EVENT_INPUTï¼Œåªæœ‰fdçš„çŠ¶æ€æ˜¯INPUTçš„æ—¶å€™æ‰ä¼šè§¦å‘è°ƒç”¨LooperCallbackä¸­çš„handleEventæ–¹æ³• thisï¼Œå³NativeInputEventReceiverï¼Œå½“fdçŠ¶æ€ä¸ºInputæ—¶ï¼ŒNativeInputEventReceiverä¸­çš„handleEventæ–¹æ³•ä¼šè¢«è°ƒç”¨ åœ¨consumeEventså†…ï¼Œæˆ‘ä»¬èƒ½çœ‹åˆ°è°ƒç”¨äº†InputConsume::consumeæ¥æ¥æ”¶InputDispatcherå‘é€è¿‡æ¥çš„äº‹ä»¶ 1234567status_t NativeInputEventReceiver::consumeEvents(JNIEnv* env, bool consumeBatches, nsecs_t frameTime, bool* outConsumedBatch) { for (;;) { status_t status = mInputConsumer.consume(&amp;mInputEventFactory, consumeBatches, frameTime, &amp;seq, &amp;inputEvent); }} æœ€ç»ˆå›è°ƒåˆ° java å±‚çš„ InputEventReceiver#dispatchInputEvent ã€‚ 12env-&gt;CallVoidMethod(receiverObj.get(), gInputEventReceiverClassInfo.dispatchInputEvent, seq, inputEventObj); é€šè¿‡ä¸Šè¿°çš„JNIè°ƒç”¨ï¼Œä¼šè°ƒç”¨åˆ°WindowInputEventReceiverçš„dispatchInputEventæ–¹æ³•ï¼Œä¸è¿‡ç”±äºWindowInputEventReceiverå¹¶æ²¡æœ‰è‡ªå·±å®ç°è¿™ä¸ªæ–¹æ³•ï¼Œå› æ­¤ä¼šè°ƒç”¨çˆ¶ç±»InputEventReceiver::dispatchInputEventï¼Œå†…éƒ¨ä¼šçœŸæ­£è°ƒç”¨åˆ°android.view.ViewRootImpl.WindowInputEventReceiver#onInputEvent æ¥ä¸‹æ¥å°±æ˜¯JAVAå±‚ï¼Œä¸€å±‚å±‚åˆ†å‘äº‹ä»¶äº† android.view.ViewRootImpl.WindowInputEventReceiver#onInputEvent 123public void onInputEvent(InputEvent event, int displayId) { enqueueInputEvent(event, this, 0, true); } android.view.ViewRootImpl#enqueueInputEvent(android.view.InputEvent, android.view.InputEventReceiver, int, boolean) 1234567891011121314151617181920212223242526272829303132void enqueueInputEvent(InputEvent event, InputEventReceiver receiver, int flags, boolean processImmediately) { adjustInputEventForCompatibility(event); // æ±  åŒ…è£…,ç±»ä¼¼ obtainMessage QueuedInputEvent q = obtainQueuedInputEvent(event, receiver, flags); QueuedInputEvent last = mPendingInputEventTail; //å…¥é˜Ÿåˆ° æ‰€æœ‰ ç­‰å€™ çš„InputEvent if (last == null) { mPendingInputEventHead = q; mPendingInputEventTail = q; } else { last.mNext = q; mPendingInputEventTail = q; } //ç­‰å€™çš„äº‹ä»¶+1 mPendingInputEventCount += 1; //æ‰“ä¸ªæ—¥å¿— Trace.traceCounter(Trace.TRACE_TAG_INPUT, mPendingInputEventQueueLengthCounterName, mPendingInputEventCount); //æ˜¯ä¸æ˜¯ç«‹å³å¤„ç†æ”¹äº‹ä»¶ if (processImmediately) { doProcessInputEvents(); } else { //è¿˜æ˜¯åŠ åˆ°è°ƒåº¦å™¨é‡Œé¢ //è¿™é‡Œå®é™…ä¸Šæ˜¯å‘é€å¼‚æ­¥æ¶ˆæ¯ mHandler.sendMessage(msg); scheduleProcessInputEvents(); } } ä» enqueueInputEvent(event, this, 0, true) çœ‹ ï¼Œè¿™é‡Œçš„äº‹ä»¶æ˜¯processImmediately = trueçš„ï¼Œæ‰€ä»¥è¿›ä¸€æ­¥å†è¿½ä¸€ä¸‹ doProcessInputEvents() 12345678910111213141516171819202122232425262728293031323334353637383940414243void doProcessInputEvents() { // Deliver all pending input events in the queue. // åˆ†å‘æ‰€æœ‰çš„ ç­‰å€™ InputEvent while (mPendingInputEventHead != null) { //å‡ºé˜Ÿ QueuedInputEvent q = mPendingInputEventHead; mPendingInputEventHead = q.mNext; if (mPendingInputEventHead == null) { mPendingInputEventTail = null; } q.mNext = null; //count-- mPendingInputEventCount -= 1; //æ‰“ä¸ªæ—¥å¿— Trace.traceCounter(Trace.TRACE_TAG_INPUT, mPendingInputEventQueueLengthCounterName, mPendingInputEventCount); long eventTime = q.mEvent.getEventTimeNano(); long oldestEventTime = eventTime; if (q.mEvent instanceof MotionEvent) { MotionEvent me = (MotionEvent)q.mEvent; if (me.getHistorySize() &gt; 0) { oldestEventTime = me.getHistoricalEventTimeNano(0); } } mChoreographer.mFrameInfo.updateInputEventTime(eventTime, oldestEventTime); //è¿™é‡Œå…·ä½“ å»åˆ†å‘å¤„ç†è¯¥æ¬¡äº‹ä»¶ deliverInputEvent(q); } // We are done processing all input events that we can process right now // so we can clear the pending flag immediately. // å› ä¸ºæˆ‘ä»¬å·²ç» åˆ†å‘å®Œäº† æ‰€æœ‰ç­‰å€™ çš„ InputEvent //æ¸…é™¤wath = MSG_PROCESS_INPUT_EVENTS çš„æ¶ˆæ¯ if (mProcessInputEventsScheduled) { mProcessInputEventsScheduled = false; mHandler.removeMessages(MSG_PROCESS_INPUT_EVENTS); } } æ¥ä¸‹æ¥å†ç»§ç»­è¿½ä¸€ä¸‹ android.view.ViewRootImpl#deliverInputEvent 12345678910111213141516171819202122232425262728293031 private void deliverInputEvent(QueuedInputEvent q) { //åˆæ‰“ä¸ªæ—¥å¿— Trace.asyncTraceBegin(Trace.TRACE_TAG_VIEW, \"deliverInputEvent\",q.mEvent.getSequenceNumber()); // è¿™ä¸ªæè¿°æ˜¯ æ–¹ä¾¿debugçš„,ä¸å½±å“åé¢çš„å¤„ç† if (mInputEventConsistencyVerifier != null) { mInputEventConsistencyVerifier.onInputEvent(q.mEvent, 0); } InputStage stage; if (q.shouldSendToSynthesizer()) { stage = mSyntheticInputStage; } else { stage = q.shouldSkipIme() ? mFirstPostImeInputStage : mFirstInputStage; } if (q.mEvent instanceof KeyEvent) { mUnhandledKeyManager.preDispatch((KeyEvent) q.mEvent); } //ä¸Šé¢å†³å®šå°†äº‹ä»¶æ´¾å‘åˆ°é‚£ä¸ªInputStageå¤„ç† if (stage != null) { handleWindowFocusChanged(); stage.deliver(q); } else { finishInputEvent(q); }} deliverInputEventå…ˆåˆ¤æ–­å°†äº‹ä»¶æ´¾å‘åˆ°é‚£ä¸ªInputStageï¼Œç„¶åè°ƒç”¨è¯¥InputStateçš„deliveræ–¹æ³• é‚£ä¹ˆInputStage åˆæ˜¯ ä»€ä¹ˆï¼Ÿ12345678910111213141516171819202122public void setView(View view, WindowManager.LayoutParams attrs, View panelParentView) { ... mSyntheticInputStage = new SyntheticInputStage(); InputStage viewPostImeStage = new ViewPostImeInputStage(mSyntheticInputStage); InputStage nativePostImeStage = new NativePostImeInputStage(viewPostImeStage, \"aq:native-post-ime:\" + counterSuffix); InputStage earlyPostImeStage = new EarlyPostImeInputStage(nativePostImeStage); InputStage imeStage = new ImeInputStage(earlyPostImeStage, \"aq:ime:\" + counterSuffix); InputStage viewPreImeStage = new ViewPreImeInputStage(imeStage); InputStage nativePreImeStage = new NativePreImeInputStage(viewPreImeStage, \"aq:native-pre-ime:\" + counterSuffix); mFirstInputStage = nativePreImeStage; mFirstPostImeInputStage = earlyPostImeStage; ...} InputStage æ˜¯åœ¨setView()çš„æ—¶å€™åˆ›å»ºçš„ï¼Œä¹Ÿå°±æ˜¯åœ¨Activityçš„onResume() é€šè¿‡ä¸€è·¯çš„ forward deliver ï¼Œæœ€åèµ°åˆ°apply çš„ onProcess æ–¹æ³•ä¸­å»ã€‚ä¹Ÿå°±æ˜¯android.view.ViewRootImpl.ViewPostImeInputStage#onProcess 123456789101112131415protected int onProcess(QueuedInputEvent q) { if (q.mEvent instanceof KeyEvent) { return processKeyEvent(q); } else { final int source = q.mEvent.getSource(); if ((source &amp; InputDevice.SOURCE_CLASS_POINTER) != 0) { //å¤„ç†ç‚¹è§¦æ‘¸äº‹ä»¶ return processPointerEvent(q); } else if ((source &amp; InputDevice.SOURCE_CLASS_TRACKBALL) != 0) { return processTrackballEvent(q); } else { return processGenericMotionEvent(q); } } } é‚£ä¹ˆå†æ¥çœ‹ä¸‹ä¸€ android.view.ViewRootImpl.ViewPostImeInputStage#processPointerEvent é‡Œé¢åˆæ˜¯æ€ä¹ˆå‘çš„ï¼Ÿ 12345678910111213141516171819202122private int processPointerEvent(QueuedInputEvent q) { final MotionEvent event = (MotionEvent)q.mEvent; mAttachInfo.mUnbufferedDispatchRequested = false; mAttachInfo.mHandlingPointerEvent = true; //mView å°±æ˜¯ android.view.ViewRootImpl#setView çš„æ—¶å€™ä¼ å…¥çš„Viewï¼Œä¹Ÿå°±æ˜¯ DecorView //æ¥ä¸‹é‡Œå°±æ˜¯ èµ°åˆ° DecorViewçš„dispatchPointerEvent ä¸­å»äº† //æ ‡è®°1ï¼Œè¿™é‡Œç¬¬ä¸€æ¬¡ æŠŠäº‹ä»¶å‘åˆ° DecorView ä¸­ boolean handled = mView.dispatchPointerEvent(event); maybeUpdatePointerIcon(event); maybeUpdateTooltip(event); mAttachInfo.mHandlingPointerEvent = false; if (mAttachInfo.mUnbufferedDispatchRequested &amp;&amp; !mUnbufferedInputDispatch) { mUnbufferedInputDispatch = true; if (mConsumeBatchedInputScheduled) { scheduleConsumeBatchedInputImmediately(); } } return handled ? FINISH_HANDLED : FORWARD; } å½“è°ƒç”¨åˆ° DecorView çš„ dispatchPointerEvent ï¼Œå®é™…ä¸Šæ˜¯ android.view.View#dispatchPointerEvent ï¼Œæ¥ä¸‹æ¥çš„é—®é¢˜å®é™…ä¸Šå°±æ˜¯ viewçš„äº‹ä»¶åˆ†å‘äº†ï¼Ÿ 123456789 public final boolean dispatchPointerEvent(MotionEvent event) { //æ˜¯ç‚¹å‡»äº‹ä»¶,è½¬åˆ°dispatchTouchEvent if (event.isTouchEvent()) { return dispatchTouchEvent(event); } else { return dispatchGenericMotionEvent(event); }} è½¬æ¥åˆ° com.android.internal.policy.DecorView#dispatchTouchEvent 123456789public boolean dispatchTouchEvent(MotionEvent ev) { //Activityå®ç°äº†Window.Callbackæ¥å£ android.app.Activity#attachä¸­ mWindow.setCallback(this); æ‰€ä»¥è¿™ä¸ªcallbackæŒ‡å‘Activity // mWindow å°±æ˜¯ PhoneWindow ï¼Œåœ¨ DecorView åˆå§‹åŒ–çš„æ—¶å€™ä¼ å…¥çš„ final Window.Callback cb = mWindow.getCallback(); // æ ‡è®°2ï¼Œè¿™é‡Œä»DecorView æŠŠäº‹ä»¶è½¬å‘åˆ° Activity ä¸­ return cb != null &amp;&amp; !mWindow.isDestroyed() &amp;&amp; mFeatureId &lt; 0 ? cb.dispatchTouchEvent(ev) : super.dispatchTouchEvent(ev);} æœ€åcb.dispatchTouchEvent(ev) å°±ç›¸å½“äº èµ°å…¥åˆ°äº† android.app.-Activity#dispatchTouchEvent 1234567891011121314 public boolean dispatchTouchEvent(MotionEvent ev) { if (ev.getAction() == MotionEvent.ACTION_DOWN) { onUserInteraction(); } //äº‹ä»¶åˆè¢«ä¼ é€’åˆ°äº†PhoneWindowä¸­å»åˆ†å‘è¿™ä¸ªäº‹ä»¶ //å¦‚æœè¢«æ¶ˆè´¹äº†ï¼Œç›´æ¥return //æ ‡è®°3ï¼Œè¿™é‡ŒæŠŠäº‹ä»¶ä»Activtyè½¬å‘åˆ°phoneWindowä¸­å»äº† if (getWindow().superDispatchTouchEvent(ev)) { return true; } // å¦‚æœä¸Šé¢æ²¡æœ‰è¢«æ¶ˆè´¹ï¼Œåˆ™è¿›å…¥Activity çš„ onTouchEvent return onTouchEvent(ev);} Activity çš„ getWindow() å°±æ˜¯ android.app.Activity#attachä¸­çš„mWindow ï¼Œä¹Ÿå°±æ˜¯ PhoneWindowã€‚ com.android.internal.policy.PhoneWindow#superDispatchTouchEvent 12345 @Overridepublic boolean superDispatchTouchEvent(MotionEvent event) { //çº³å°¼ï¼Œåˆ è½¬æ¥åˆ°äº† DecorView ä¸­å» return mDecor.superDispatchTouchEvent(event);} ä»ä¸Šé¢çš„æ ‡è®°1ï¼Œ2ï¼Œ3 å¯ä»¥çœ‹åˆ°ï¼Œé¦–å…ˆäº‹ä»¶ä» android.view.ViewRootImpl.ViewPostImeInputStage#processPointerEvent å‘åˆ° DecorView ,DecorView å†åˆ†å‘äº‹ä»¶çš„æ—¶å€™ï¼Œé€šè¿‡ Window è·å–callback æ‹¿åˆ° Activity ,è½¬äº¤ç»™Activity å»å‘é€ï¼Œä½†æ˜¯Activityåˆé€šè¿‡ getWindowï¼ŒåˆæŠŠäº‹ä»¶è½¬äº¤ç»™Window ï¼ŒWindow æœ€ååˆé€šè¿‡mDecor.superDispatchTouchEvent(event) è½¬äº¤ç»™ äº†DecorViewã€‚æåŠå¤©ï¼Ÿæœ€åè¿˜æ˜¯å›åˆ° android.view.ViewRootImpl.ViewPostImeInputStage#processPointerEvent çš„ mView.dispatchPointerEvent(event)ä¸­ï¼Ÿ æ˜¾ç„¶ä¸æ˜¯ ç¬¬ä¸€æ¬¡è°ƒç”¨çš„æ˜¯ DecorView.dispatchPointerEvent(event) ï¼Œç¬¬äºŒæ¬¡å›åˆ° DecorViewæ˜¯è°ƒç”¨çš„ DecorView.superDispatchTouchEvent(event);ä¹Ÿå°±è°ƒç”¨åˆ° DecorView çš„çˆ¶ç±» DispatchTouchEvent ï¼Œæœ€åä¹Ÿå°±æ˜¯ android.view.ViewGroup#dispatchTouchEventçš„äº†ã€‚ ä¸€å°æ®µè°ƒç”¨æ ˆ 123456789---dispatchTouchEvent(MotionEvent):2543, ViewGroup (android.view)//ViewGroup åˆ†å‘äº‹ä»¶superDispatchTouchEvent(MotionEvent):440, DecorView (com.android.internal.policy)//ç¬¬äºŒæ¬¡superDispatchTouchEvent(MotionEvent):1830, PhoneWindow (com.android.internal.policy)dispatchTouchEvent(MotionEvent):3400, Activity (android.app)dispatchTouchEvent(MotionEvent):398, DecorView (com.android.internal.policy)//ç¬¬ä¸€æ¬¡dispatchPointerEvent(MotionEvent):12752, View (android.view)processPointerEvent(ViewRootImpl$QueuedInputEvent):5106,ã€--- è¾—è½¬çš„åŸå› ï¼Ÿæ¥è‡ª https://www.jianshu.com/p/b7cef3b3e703ä¸ºä»€ä¹ˆåœ¨InputStage.processPointerEvent()ä¸­ä¸ç›´æ¥æŠŠäº‹ä»¶ä¼ é€’ç»™Activityï¼Œè€Œæ˜¯è¿™æ ·æ¥å›ç»•ä¸€åœˆã€‚è¿™æ ·DecorView -&gt; Activity -&gt; PhoneWindow -&gt; DecorViewçš„æ¥å›ç»•ä¸€åœˆä¸æ˜¯å¾ˆæŠ˜è…¾å—ï¼Ÿ é¦–å…ˆï¼Œä¸ºäº†è§£è€¦ï¼ŒViewRootImplå¹¶ä¸çŸ¥é“æœ‰Activityè¿™ç§ä¸œè¥¿å­˜åœ¨ï¼ä¸çŸ¥é“ï¼å®ƒåªæ˜¯æŒæœ‰äº†DecorViewã€‚æ‰€ä»¥ï¼Œæƒ³è¦ç›´æ¥æŠŠè§¦æ‘¸äº‹ä»¶é€åˆ°Activity.dispatchTouchEvent() æ˜¯ä¸è¡Œçš„ã€‚ é‚£ä¹ˆï¼Œæ—¢ç„¶è§¦æ‘¸äº‹ä»¶å·²ç»åˆ°äº†Activity.dispatchTouchEvent()ä¸­äº†ï¼Œä¸ºä»€ä¹ˆä¸ç›´æ¥åˆ†å‘ç»™DecorView ï¼Œè€Œæ˜¯è¦é€šè¿‡PhoneWindow æ¥é—´æ¥å‘é€å‘¢ï¼Ÿå› ä¸ºActivity ä¸çŸ¥é“æœ‰DecorView è¿™ç§å¥‡æ€ªçš„ä¸œè¥¿å­˜åœ¨å•Šï¼ä¸çŸ¥é“ï¼ä½†æ˜¯ï¼ŒActivityæŒæœ‰PhoneWindow ï¼Œè€ŒPhoneWindowå½“ç„¶çŸ¥é“è‡ªå·±çš„çª—å£é‡Œæœ‰äº›ä»€ä¹ˆäº†ï¼Œæ‰€ä»¥èƒ½å¤ŸæŠŠäº‹ä»¶æ´¾å‘ç»™DecorView ã€‚ä½ çœ‹ï¼Œåœ¨Androidä¸­ï¼ŒActivityå¹¶ä¸çŸ¥é“è‡ªå·±çš„Windowä¸­æœ‰äº›ä»€ä¹ˆï¼Œè¿™æ ·è€¦åˆæ€§å°±å¾ˆä½äº†ã€‚æˆ‘ä»¬æ¢ä¸€ä¸ªWindowè¯•è¯•ï¼Ÿä¸ç®¡Windowé‡Œé¢çš„å†…å®¹å¦‚ä½•ï¼Œåªè¦Windowä»»ç„¶ç¬¦åˆActivityåˆ¶å®šçš„æ ‡å‡†ï¼Œé‚£ä¹ˆå®ƒå°±èƒ½åœ¨Activityä¸­å¾ˆå¥½çš„å·¥ä½œã€‚è¿™å°±æ˜¯è§£è€¦æ‰€å¸¦æ¥çš„æ‰©å±•æ€§çš„å¥½å¤„ã€‚ ä½œè€…ï¼šCoorChiceé“¾æ¥ï¼šhttps://www.jianshu.com/p/b7cef3b3e703æ¥æºï¼šç®€ä¹¦è‘—ä½œæƒå½’ä½œè€…æ‰€æœ‰ã€‚å•†ä¸šè½¬è½½è¯·è”ç³»ä½œè€…è·å¾—æˆæƒï¼Œéå•†ä¸šè½¬è½½è¯·æ³¨æ˜å‡ºå¤„ã€‚ ViewGroup çš„äº‹ä»¶åˆ†å‘æµç¨‹ï¼Ÿé¦–å…ˆåˆ†æ¸…æ¥š 3ä¸ªæ–¹æ³• dispatchTouchEvent() åˆ†å‘å™¨ï¼Œå†³å®šäº‹ä»¶æ€ä¹ˆåˆ†å‘ï¼Œä¼šå…ˆè¯¢é—®onInterceptTouchEvent()ï¼Œå¦‚æœæ‹¦æˆªäº† è¿›ä¸€æ­¥åˆ° è‡ªå·±çš„ onTouchEvent() ä¸­å»ã€‚å¦‚æœæ²¡æœ‰æ‹¦æˆªï¼Œè½¬å‘åˆ°å­viewçš„dispatchTouchEvent() onInterceptTouchEvent() æ‹¦æˆªå™¨ æ˜¯ViewGroupç‰¹æœ‰çš„æ–¹æ³•ï¼Œå¯ä»¥åˆ¤æ–­å’Œæ‹¦æˆªè¦ä¸è¦å°†äº‹ä»¶ä¸‹å‘åˆ°å­viewå»å¤„ç†ã€‚ onTouchEvent() å¤„ç†å™¨ã€‚æœ€åçš„ä¸€ä¸ªå­view æ”¶åˆ°äº‹ä»¶å°†ä¼šç›´æ¥ç”±ã€åˆ†å‘å™¨ã€‘åˆ†å‘åˆ°ã€å¤„ç†å™¨ã€‘ä¸­ã€‚å¦‚æœå¤„ç†äº†è¿”å›trueï¼Œå¦‚æœä¸å¤„ç†è¿”å›falseï¼Œé‚£ä¹ˆäº‹ä»¶å°†ä¼ é€’åˆ°å®ƒçš„çˆ¶çº§çš„ã€å¤„ç†å™¨ã€‘ä¸­ã€‚ ä¸ç®¡ä¸ªå±‚çº§çš„ã€å¤„ç†å™¨ã€‘ï¼Œå¦‚æœå¤„ç†äº‹ä»¶è¿”å›trueï¼Œä¸€æ¬¡è§¦æ‘¸äº‹ä»¶å°±ç»“æŸäº†ã€‚å¦‚æœä¸å¤„ç†äº‹ä»¶ï¼Œè¿”å›falseï¼Œå°±æ˜¯äº‹ä»¶è¿˜æ²¡æœ‰è¢«æ¶ˆè´¹ï¼Œå°±ä¼šä¼ é€åˆ°ä¸Šä¸€çº§çš„ã€å¤„ç†å™¨ã€‘ä¸­ã€‚æœ€ç»ˆï¼Œå¦‚æœDecorViewçš„ã€å¤„ç†å™¨ã€‘ä¹Ÿä¸æ‰“ç®—å¤„ç†äº‹ä»¶ï¼Œé‚£ä¹ˆäº‹ä»¶å°†ä¼šè¢«å‘é€åˆ°Activityçš„ã€å¤„ç†å™¨ã€‘ä¸­å¤„ç†ã€‚ è¯´ç™½äº†ï¼Œå°±æ˜¯å…ˆäº¤ç»™å­viewä¼˜å…ˆæ¶ˆè´¹ï¼Œæ¶ˆè´¹ä¸äº†ï¼Œè¿”å›äº†ï¼Œæˆ‘å†æ¶ˆè´¹ã€‚ é‚£ä¹ˆViewGroup dispatchTouchEvent()åˆæ˜¯æ€ä¹ˆæŠŠäº‹ä»¶å‘åˆ°child viewä¸­å»çš„å‘¢ï¼Ÿ android.view.ViewGroup#dispatchTouchEvent 12345678910111213141516171819202122232425262728293031// Find a child that can receive the event.// Scan children from front to back.// æ‰¾ä¸€ä¸ªå¯ä»¥æ¥å—è¿™ä¸ªäº‹ä»¶çš„å­view,ä»åé¢å‘å‰æ‰¾ï¼Œæ‰¾åˆ°ä¸€ä¸ªå°±ç»“æŸfinal ArrayList&lt;View&gt; preorderedList = buildTouchDispatchChildList();final boolean customOrder = preorderedList == null &amp;&amp; isChildrenDrawingOrderEnabled();final View[] children = mChildren;for (int i = childrenCount - 1; i &gt;= 0; i--) { final int childIndex = getAndVerifyPreorderedIndex( childrenCount, i, customOrder); final View child = getAndVerifyPreorderedView( preorderedList, children, childIndex); // If there is a view that has accessibility focus we want it // to get the event first and if not handled we will perform a // normal dispatch. We may do a double iteration but this is // safer given the timeframe. if (childWithAccessibilityFocus != null) { if (childWithAccessibilityFocus != child) { continue; } childWithAccessibilityFocus = null; i = childrenCount - 1; } //è¯¥æ¬¡ç‚¹å‡»æ˜¯ä¸æ˜¯è½åœ¨äº† å­viewçš„ å¸ƒå±€èŒƒå›´ä¹‹ä¸­ï¼Œä¸”å­view å¯ä»¥æ¥å—ç‚¹å‡»ï¼Œæ¯”å¦‚å¯è§ if (!canViewReceivePointerEvents(child) || !isTransformedTouchPointInView(x, y, child, null)) { ev.setTargetAccessibilityFocus(false); continue; } å¯èƒ½å­˜åœ¨çš„é—®é¢˜ï¼Œå°±æ˜¯å¸ƒå±€é‡å çš„æ—¶å€™ï¼Œæ”¶ä¸åˆ°å“åº”ï¼Ÿ æœ€åå†å­viewçš„ android.view.View#onTouchEventä¸­ï¼ŒåŒ…è£…æˆä¸€ä¸ª mPerformClick ,æœ€åé€šè¿‡ mHandler.post(action) æŠŠè¿™ä¸ª action å‘åˆ° ä¸»çº¿ç¨‹çš„looper é‡Œé¢å»å¤„ç†äº†ï¼Œç„¶ålooepr å¤„ç†æ¶ˆæ¯ï¼Œè°ƒç”¨action ï¼Œå°±æ˜¯æˆ‘ä»¬setçš„OnClickListeneré‡Œé¢å»äº†ã€‚ android.os.Handler#dispatchMessage 1234567891011121314public void dispatchMessage(Message msg) { // msg.callback = performClick //å¼€å§‹å¤„ç† å¤„ç† Callback if (msg.callback != null) { handleCallback(msg); } else { if (mCallback != null) { if (mCallback.handleMessage(msg)) { return; } } handleMessage(msg); }} æœ€å è°ƒåˆ° message.callback.run(); ç„¶å åœ¨run() è°ƒç”¨ performClick() ä¸­çš„ mOnClickListener.onClick(this); æœ€åæˆ‘ä»¬ å°±å¼€å§‹æˆ‘ä»¬çš„OnClick é€»è¾‘äº† æ€»ç»“ æœ€åä¸€å¼ å¤§å›¾ æ„Ÿè°¢[Android] è¾“å…¥ç³»ç»Ÿï¼ˆäºŒï¼‰] https://www.cnblogs.com/TaigaCon/p/4750349.html ä½œè€…ï¼šCoorChiceé“¾æ¥ï¼šhttps://www.jianshu.com/p/b7cef3b3e703æ¥æºï¼šç®€ä¹¦è‘—ä½œæƒå½’ä½œè€…æ‰€æœ‰ã€‚å•†ä¸šè½¬è½½è¯·è”ç³»ä½œè€…è·å¾—æˆæƒï¼Œéå•†ä¸šè½¬è½½è¯·æ³¨æ˜å‡ºå¤„ã€‚","link":"/2020/04/27/Android/touchevent/"},{"title":"Viewçš„å‡ ä¸ªé«˜åº¦&#x2F;å®½åº¦","text":"è‡ªå®šä¹‰viewçš„è¿‡ç¨‹onMeasure()â€“&gt;onLayout()â€“&gt;onDraw() onMeasure() è®¡ç®—å½“å‰å„ä¸ªå­viewçš„é«˜å®½åº¦ onLayout() ç¡®å®šå„ä¸ªå­viewåœ¨çˆ¶å®¹å™¨çš„ä½ç½® éœ€è¦4ä¸ªå‚æ•°ç¡®å®šå­viewçš„ä½ç½®ã€‚éƒ½æ˜¯ç›¸å¯¹çˆ¶å®¹å™¨çš„left å·¦è¾¹è·ç¦»top ä¸Šè¾¹è·ç¦»right å³è¾¹è·ç¦»bottom ä¸‹è¾¹è·ç¦»å¦‚æœæˆ‘æƒ³è®©æŸä¸ªå­viewå æ®çˆ¶å¸ƒå±€çš„ä¸Šä¸€åŠã€‚å°±æ˜¯ child.layout(0,0,0,1/2*çˆ¶å®¹å™¨çš„é«˜åº¦) onDraw() å¼€å§‹ç»˜åˆ¶ çœŸæ­£å¼€å§‹å…·ä½“ç»˜åˆ¶ 1 view.getLayoutParams().height/widthè·å–å½“å‰viewåœ¨çˆ¶å®¹å™¨ä¸­çš„å¸ƒå±€å®½é«˜åº¦, çˆ¶å®¹å™¨æ ¹æ®LayoutParams()å¯ä»¥ç¡®å®šè¿™ä¸ªviewçš„æ€ä¹ˆå¸ƒå±€ã€‚è¿™é‡Œçš„height å’Œ width å¯ä»¥æ˜¯å…·ä½“çš„æ•°ï¼Œä¹Ÿå¯ä»¥æ˜¯å¦‚ä¸‹çš„å‚æ•°ã€‚æ¯ä¸ªä¸ä¸€æ ·çš„ViewGroupæ‹¥æœ‰ä¸ä¸€æ ·çš„LayoutParamsã€‚LayoutParams()ä¸ä»…ä»…æ˜¯ç¡®å®šé«˜åº¦å’Œå®½åº¦ï¼Œè¿˜å¯ä»¥ç¡®å®šMarginï¼Œgravityã€‚ è·å–æ¥æºï¼š1.åŠ¨æ€å¸ƒå±€ï¼Œå¯ä»¥ä»»ä½•æ—¶å€™æ‰‹åŠ¨setLayoutParamsï¼ŒsetLayoutParamsæ–¹æ³•é‡Œé¢ä¼šè§¦å‘requestLayout();requestLayoutè§¦å‘çˆ¶å®¹å™¨é‡æ–°ä¾æ¬¡è®¡ç®—å­viewåœ¨çˆ¶å¸ƒå±€çš„ä½ç½®ã€‚2.android.view.ViewGroup çš„ç»˜åˆ¶è¿‡ç¨‹ä¸­çš„æ–¹æ³•ä¼šè‡ªåŠ¨è°ƒç”¨ view.setLayoutParams(params);æ³¨æ„å¯èƒ½è·å–ä¸ºnullï¼Œè¿˜æ²¡æ²¡æœ‰æ·»åŠ åˆ°å¸ƒå±€ä¸­ï¼Œè‡ªç„¶ä¸å­˜åœ¨ LayoutParamsã€‚åœ¨æ–¹æ³• public void addView(**)ä¼šåˆ›å»ºparams = generateDefaultLayoutParams();æ¯ä¸€ç§ä¸åŒçš„å¸ƒå±€ç±»å‹ï¼Œä¸åŒçš„generateDefaultLayoutParamsåˆå§‹åŒ–ç­–ç•¥ã€‚ è·å–æ—¶æœºï¼šaddViewä¹‹å 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849public static class LayoutParams { /** * Special value for the height or width requested by a View. * FILL_PARENT means that the view wants to be as big as its parent, * minus the parent's padding, if any. This value is deprecated * starting in API Level 8 and replaced by {@link #MATCH_PARENT}. */ @SuppressWarnings({\"UnusedDeclaration\"}) @Deprecated public static final int FILL_PARENT = -1; /** * Special value for the height or width requested by a View. * MATCH_PARENT means that the view wants to be as big as its parent, * minus the parent's padding, if any. Introduced in API Level 8. */ public static final int MATCH_PARENT = -1; /** * Special value for the height or width requested by a View. * WRAP_CONTENT means that the view wants to be just large enough to fit * its own internal content, taking its own padding into account. */ public static final int WRAP_CONTENT = -2; /** * Information about how wide the view wants to be. Can be one of the * constants FILL_PARENT (replaced by MATCH_PARENT * in API Level 8) or WRAP_CONTENT, or an exact size. */ @ViewDebug.ExportedProperty(category = \"layout\", mapping = { @ViewDebug.IntToString(from = MATCH_PARENT, to = \"MATCH_PARENT\"), @ViewDebug.IntToString(from = WRAP_CONTENT, to = \"WRAP_CONTENT\") }) public int width; /** * Information about how tall the view wants to be. Can be one of the * constants FILL_PARENT (replaced by MATCH_PARENT * in API Level 8) or WRAP_CONTENT, or an exact size. */ @ViewDebug.ExportedProperty(category = \"layout\", mapping = { @ViewDebug.IntToString(from = MATCH_PARENT, to = \"MATCH_PARENT\"), @ViewDebug.IntToString(from = WRAP_CONTENT, to = \"WRAP_CONTENT\") }) public int height; ...} 2 view().getHeight()/getWidth()è·å–å½“å‰viewçš„é«˜åº¦å’Œå®½åº¦ï¼Œéœ€åœ¨onLayoutä¹‹åè·å–ï¼Œå°±æ˜¯ç”¨laoutä¸­çš„ å®½åº¦å°±æ˜¯=å·¦è¾¹-å»å³è¾¹ é«˜åº¦ = ä¸Šè¾¹-ä¸‹è¾¹ è·å–æ—¶æœºï¼šå¿…é¡»åœ¨onLayout ä¹‹å 1234567public final int getHeight() { return mBottom - mTop; } public final int getWidth() { return mRight - mLeft; } 3 view().getMeasuredHeight()/getMeasuredWidth()è·å–viewè‡ªå·±çš„åŸå§‹é«˜åº¦, 123456789 //The raw measured width of this view. public final int getMeasuredWidth() { //å–mod MEASURED_SIZE_MASK = 0x00ffffff; return mMeasuredWidth &amp; MEASURED_SIZE_MASK; } //The raw measured height of this view. public final int getMeasuredHeight() { return mMeasuredHeight &amp; MEASURED_SIZE_MASK;} å€¼çš„æ¥æº onMeasureä¸­è°ƒç”¨çš„setMeasuredDimensionRaw 123456private void setMeasuredDimensionRaw(int measuredWidth, int measuredHeight) { mMeasuredWidth = measuredWidth; mMeasuredHeight = measuredHeight; mPrivateFlags |= PFLAG_MEASURED_DIMENSION_SET; } setMeasuredDimensionRawæ¥æºäºview#measure(int widthMeasureSpec, int heightMeasureSpec)widthMeasureSpec å’Œ heightMeasureSpec å’Œ view å’Œ åŸå§‹layoutpram åˆç›¸å…³ã€‚ è·å–æ—¶æœºï¼šå¿…é¡»åœ¨viewçš„onMeasureä¹‹å å…³äºMeasuredHeight() è¯·å‚è€ƒ MeasureSpec 4. å‡ºå‘ç‚¹çš„BUG ä¸ºä»€ä¹ˆviewé‡å çš„æ—¶å€™ï¼Œæœ‰æ—¶å¯ä»¥ç‚¹å‡»ï¼Ÿè€Œæœ‰æ—¶ä¸å¯ä»¥ç‚¹å‡»ï¼Ÿå¦‚å›¾æ‰€ç¤ºï¼Œå­˜åœ¨ä»¥ä¸ºè§†å›¾å¸ƒå±€å¦‚ä¸‹,å½“ä»¥ä½ ä»¥ä¸ºçš„å¸ƒå±€è¿›è¡Œç‚¹å‡»çš„æ—¶å€™ï¼Œå‘ç°ç‚¹å‡»å°viewæ—¶è€Œå¯ä»¥ï¼Œæ—¶è€Œä¸è¡Œï¼Ÿwhyï¼Ÿæœ¬è´¨æ˜¯ç‚¹å‡»äº‹ä»¶çš„åˆ†å‘æœ‰å…³ï¼Œç‚¹å‡»äº‹ä»¶ç”±ViewGroupå‘å¾€å­Viewçš„æ—¶å€™ï¼Œæ˜¯ä»åé¢å‘å‰éå†çš„ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œå½“2ä¸ªviewé‡å çš„æƒ…å†µï¼Œè°åœ¨åé¢ï¼Œè°å“åº”æœ¬æ¬¡äº‹ä»¶ã€‚ å¯è§android.view.ViewGroup#dispatchTouchEvent 1234567891011121314151617181920212223242526272829303132333435public boolean dispatchTouchEvent(MotionEvent ev){ --- if (newTouchTarget == null &amp;&amp; childrenCount != 0) { final float x = ev.getX(actionIndex); final float y = ev.getY(actionIndex); // Find a child that can receive the event. // Scan children from front to back. // ä»åå‘å‰éå† ä¸€ä¸ªå¯ä»¥æ¥å—ç‚¹å‡»äº‹ä»¶çš„ view final ArrayList&lt;View&gt; preorderedList = buildTouchDispatchChildList(); final boolean customOrder = preorderedList == null &amp;&amp; isChildrenDrawingOrderEnabled(); final View[] children = mChildren; for (int i = childrenCount - 1; i &gt;= 0; i--) { final int childIndex = getAndVerifyPreorderedIndex( childrenCount, i, customOrder); final View child = getAndVerifyPreorderedView( preorderedList, children, childIndex); if (childWithAccessibilityFocus != null) { if (childWithAccessibilityFocus != child) { continue; } childWithAccessibilityFocus = null; i = childrenCount - 1; } //åˆ¤æ–­å­ view èƒ½ä¸èƒ½æ”¶åˆ° ç‚¹å‡»äº‹ä»¶ï¼Œå’Œç‚¹å‡»äº‹ä»¶æ˜¯ä¸æ˜¯åœ¨ å­viewçš„èŒƒå›´ä¸­ if (!canViewReceivePointerEvents(child) || !isTransformedTouchPointInView(x, y, child, null)) { ev.setTargetAccessibilityFocus(false); continue; } if (dispatchTransformedTouchEvent(ev, false, child, idBitsToAssign)) ---} æœ€åæ‰åœ¨ dispatchTransformedTouchEvent è°ƒç”¨ child.dispatchTouchEvent(event) åœ¨onMeasure è°ƒç”¨ super.onMeasure åœ¨super.onMeasureä¸­è®¡ç®—å­viewçš„é«˜åº¦çš„æ—¶å€™ä¼šç”¨åˆ°å­viewåŸæ¥çš„LayoutParamsï¼Œç„¶åå†è®¡ç®— setå­viewçš„LayoutParamsçš„ï¼Œæœ€ååœ¨onLayoutçš„æ—¶å€™ é€šè¿‡ getMeasuredWidth()è·å–é«˜åº¦ã€‚é—®é¢˜åœ¨äºgetMeasuredWidth()è·å–çš„é«˜åº¦æ˜¯åœ¨super.onMeasureçš„æ—¶å€™å°±å·²ç»ç¡®å®šäº†çš„ï¼Œå¹¶ä¸æ˜¯åœ¨åœ¨onMeasureè®¡ç®—çš„é«˜åº¦ï¼Œå®é™…åœ¨äºåˆšæ‰setçš„LayoutParamsã€‚åé¢è¿›å…¥çš„æ—¶å€™ LayoutParamså·²ç»è¢«æ›´æ–°äº†ï¼Œå†æ¬¡super.onMeasure æ›´æ–°çš„MeasuredWidth()å°±æ˜¯å’Œæ–°çš„LayoutParamsç›¸å…³äº†,å±•ç¤ºå°±ä¼šæ­£ç¡®ã€‚ é—®é¢˜å°±æ˜¯ç¬¬ä¸€æ¬¡è¿›æ¥çš„æ—¶å€™å°±ä¼šè·å–é”™è¯¯çš„é«˜åº¦ï¼Œonlayoutå¹¶ä¸æ˜¯æˆ‘ä»¬æ‰‹åŠ¨è®¡ç®—çš„é«˜åº¦ã€‚","link":"/2020/04/26/Android/viewsomeheight/"},{"title":"ç†è§£MeasureSpec  widthMeasureSpec&#x2F;heightMeasureSpec","text":"åœ¨ onMeasureä¸­çš„å‚æ•° heightMeasureSpec åˆæ˜¯ä»€ä¹ˆï¼Ÿ MeasureSpecæ˜¯çˆ¶æ§ä»¶æä¾›ç»™å­Viewçš„onMeaureå‚æ•°ï¼Œä½œä¸ºè®¾å®šè‡ªèº«å¤§å°å‚è€ƒï¼Œåªæ˜¯ä¸ªå‚è€ƒï¼Œè¦å¤šå¤§ï¼Œè¿˜æ˜¯Viewè‡ªå·±è¯´äº†ç®—ã€‚ MeasureSpec æ˜¯ä¸€ä¸ªå¤åˆå‚æ•°ï¼ŒåŒ…å«äº†specModeå’ŒspecSize,å¯ä»¥é€šè¿‡å¦‚ä¸‹è·å–ã€‚ 12int specMode = MeasureSpec.getMode(measureSpec);int specSize = MeasureSpec.getSize(measureSpec); ä¹Ÿå¯ä»¥é€šè¿‡å¦‚ä¸‹åˆå¹¶ 1MeasureSpec.makeMeasureSpec(resultSize, resultMode); specMode æœ‰3ç§æ¨¡å¼ UNSPECIFIEDï¼šä¸å¯¹Viewå¤§å°åšé™åˆ¶ï¼Œå¦‚ï¼šListViewï¼ŒScrollView EXACTLYï¼šç¡®åˆ‡çš„å¤§å°ï¼Œå¦‚ï¼š100dpæˆ–è€…march_parent AT_MOSTï¼šå¤§å°ä¸å¯è¶…è¿‡æŸæ•°å€¼ï¼Œå¦‚ï¼šwrap_content å­Viewçš„MeasureSpecç”±çˆ¶Viewçš„MeasureSpecå’Œå­Viewæœ¬èº«çš„LayoutPramaså…±åŒå†³å®šï¼Œåœ¨ViewGroupçš„getChildMeasureSpecæ–¹æ³•ä¸­å®ç°ï¼Œå…·ä½“è§£æåœ¨ä¸‹é¢ä»£ç ä¸­ã€‚ 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778//spec parentWidthMeasureSpec// childDimension æ˜¯å­view è‡ªå·±çš„ç»´åº¦public static int getChildMeasureSpec(int spec, int padding, int childDimension) { //è·å–çš„çˆ¶å®¹å™¨çš„ mode size int specMode = MeasureSpec.getMode(spec); int specSize = MeasureSpec.getSize(spec); int size = Math.max(0, specSize - padding); int resultSize = 0; int resultMode = 0; switch (specMode) { //å¦‚æœçˆ¶å®¹å™¨ æ˜¯ EXACTLYï¼šç¡®åˆ‡çš„å¤§å°ï¼Œå¦‚ï¼š100dpæˆ–è€…march\\_parent case MeasureSpec.EXACTLY: //å¦‚æœchild view æœ‰å…·ä½“çš„å¤§å°ã€‚åˆ™ç›´æ¥å°±ç”¨è¿™ä¸ªå¤§å°ã€‚ // ä¾‹å¦‚child view çš„xmlé‡Œé¢æè¿°çš„é«˜åº¦æ˜¯ 100dp if (childDimension &gt;= 0) { resultSize = childDimension; resultMode = MeasureSpec.EXACTLY; //å¦‚æœå­child viewçš„ç»´åº¦æè¿°æ˜¯ MATCH_PARENT } else if (childDimension == LayoutParams.MATCH_PARENT) { //é‚£ä¹ˆchild viewçš„sizeå°±æ˜¯ ç­‰äº çˆ¶å®¹å™¨çš„size //mode ä¹Ÿç­‰äºçˆ¶å®¹å™¨çš„mode resultSize = size; resultMode = MeasureSpec.EXACTLY; //å¦‚æœå­child viewçš„ç»´åº¦æè¿°æ˜¯ WRAP_CONTENT } else if (childDimension == LayoutParams.WRAP_CONTENT) { //é‚£ä¹ˆchild viewçš„sizeä¹Ÿç­‰äº çˆ¶å®¹å™¨çš„sizeã€‚ä½†æ˜¯modeæ˜¯AT_MOSTï¼Œchild viewå¯ä»¥å‚è€ƒè¿™ä¸ªsize resultSize = size; resultMode = MeasureSpec.AT_MOST; } break; // å¦‚æœçˆ¶å®¹å™¨ä½¿ç”¨çš„æ˜¯ AT\\_MOSTï¼šå¤§å°ä¸å¯è¶…è¿‡æŸæ•°å€¼ï¼Œå¦‚ï¼šwrap\\_content case MeasureSpec.AT_MOST: //è¿˜æ˜¯å¦‚æœchild view æŒ‡å®šäº†é«˜åº¦ï¼Œéƒ½é‡‡ç”¨è‡ªå·±çš„é«˜åº¦ï¼Œmodeä¹Ÿæ˜¯EXACTLY if (childDimension &gt;= 0) { resultSize = childDimension; resultMode = MeasureSpec.EXACTLY; //å¦‚æœå­child viewçš„ç»´åº¦æè¿°æ˜¯ MATCH_PARENT } else if (childDimension == LayoutParams.MATCH_PARENT) { //child view çš„å‚è€ƒsize ç­‰åŒäº çˆ¶å®¹å™¨çš„size //ä½†æ­¤æ—¶çˆ¶å®¹å™¨çš„sizeæ²¡æœ‰ç¡®å®šå€¼,æ‰€ä»¥modeä¹ŸåŒäºAT_MOST resultSize = size; resultMode = MeasureSpec.AT_MOST; } else if (childDimension == LayoutParams.WRAP_CONTENT) { //é‚£ä¹ˆchild viewçš„sizeä¹Ÿç­‰äº çˆ¶å®¹å™¨çš„sizeã€‚ä½†æ˜¯modeæ˜¯AT_MOSTï¼Œchild viewå¯ä»¥å‚è€ƒè¿™ä¸ªsize resultSize = size; resultMode = MeasureSpec.AT_MOST; } break; //å¦‚æœçˆ¶å®¹å™¨ä½¿ç”¨çš„æ˜¯ UNSPECIFIEDï¼šä¸å¯¹Viewå¤§å°åšé™åˆ¶ï¼Œå¦‚ï¼šListViewï¼ŒScrollView case MeasureSpec.UNSPECIFIED: //è¿˜æ˜¯å¦‚æœchild view æŒ‡å®šäº†é«˜åº¦ï¼Œéƒ½é‡‡ç”¨è‡ªå·±çš„é«˜åº¦ï¼Œmodeä¹Ÿæ˜¯EXACTLY if (childDimension &gt;= 0) { resultSize = childDimension; resultMode = MeasureSpec.EXACTLY; } else if (childDimension == LayoutParams.MATCH_PARENT) { // å­view MATCH_PARENT,åˆ™åŒäºçˆ¶size modeä¹Ÿæ˜¯UNSPECIFIED resultSize = View.sUseZeroUnspecifiedMeasureSpec ? 0 : size; resultMode = MeasureSpec.UNSPECIFIED; } else if (childDimension == LayoutParams.WRAP_CONTENT) { //WRAP_CONTENT resultSize = View.sUseZeroUnspecifiedMeasureSpec ? 0 : size; resultMode = MeasureSpec.UNSPECIFIED; } break; } //æ‹¼è£…Size å’ŒMode ,è¿”å›è¿™ä¸ªå­viewçš„MeasureSpec return MeasureSpec.makeMeasureSpec(resultSize, resultMode); } MeasureSpecä¸ç®¡çˆ¶å®¹å™¨æ˜¯ä»€ä¹ˆszieå’Œmodeï¼Œå¦‚æœchild view æŒ‡å®šäº†é«˜åº¦ï¼Œéƒ½é‡‡ç”¨è‡ªå·±çš„é«˜åº¦ï¼Œmodeä¹Ÿæ˜¯EXACTLY å½“å­Viewæ¥æ”¶åˆ°çˆ¶æ§ä»¶ä¼ é€’çš„MeasureSpecçš„æ—¶å€™ï¼Œå°±å¯ä»¥çŸ¥é“çˆ¶æ§ä»¶å¸Œæœ›è‡ªå·±å¦‚ä½•æ˜¾ç¤ºï¼Œè¿™ä¸ªç‚¹å¯¹äºå¼€å‘è€…è€Œè¨€å°±æ˜¯onMeasureå‡½æ•° ViewGroupåœ¨è®¡ç®—è‡ªå·±å°ºå¯¸çš„æ—¶å€™ï¼Œå¿…é¡»é¢„å…ˆçŸ¥é“æ‰€æœ‰å­Viewçš„å°ºå¯¸ å¦‚æœçˆ¶æ§ä»¶ä¼ é€’ç»™çš„MeasureSpecçš„modeæ˜¯MeasureSpec.UNSPECIFIEDï¼Œå°±è¯´æ˜ï¼Œçˆ¶æ§ä»¶å¯¹è‡ªå·±æ²¡æœ‰ä»»ä½•é™åˆ¶ï¼Œé‚£ä¹ˆå°ºå¯¸å°±é€‰æ‹©è‡ªå·±éœ€è¦çš„å°ºå¯¸size å¦‚æœçˆ¶æ§ä»¶ä¼ é€’ç»™çš„MeasureSpecçš„modeæ˜¯MeasureSpec.EXACTLYï¼Œå°±è¯´æ˜çˆ¶æ§ä»¶æœ‰æ˜ç¡®çš„è¦æ±‚ï¼Œå¸Œæœ›è‡ªå·±èƒ½ç”¨measureSpecä¸­çš„å°ºå¯¸ï¼Œè¿™æ—¶å°±æ¨èä½¿ç”¨MeasureSpec.getSize(measureSpec) å¦‚æœçˆ¶æ§ä»¶ä¼ é€’ç»™çš„MeasureSpecçš„modeæ˜¯MeasureSpec.AT_MOSTï¼Œå°±è¯´æ˜çˆ¶æ§ä»¶å¸Œæœ›è‡ªå·±ä¸è¦è¶…å‡ºMeasureSpec.getSize(measureSpec)ï¼Œå¦‚æœè¶…å‡ºäº†ï¼Œå°±é€‰æ‹©MeasureSpec.getSize(measureSpec)ï¼Œå¦åˆ™ç”¨è‡ªå·±æƒ³è¦çš„å°ºå¯¸å°±è¡Œäº† ViewGroupçš„å°ºå¯¸å…¶å®åªéœ€è¦ä¸‰éƒ¨ï¼š æµ‹é‡æ‰€æœ‰å­Viewï¼Œè·å–æ‰€æœ‰å­Viewçš„å°ºå¯¸ æ ¹æ®è‡ªèº«ç‰¹ç‚¹è®¡ç®—æ‰€éœ€è¦çš„å°ºå¯¸ ç»¼åˆè€ƒé‡éœ€è¦çš„å°ºå¯¸è·Ÿçˆ¶æ§ä»¶ä¼ é€’çš„MeasureSpecï¼Œå¾—å‡ºä¸€ä¸ªåˆç†çš„å°ºå¯¸ é¡¶å±‚Viewçš„MeasureSpecæ˜¯è°æŒ‡å®šä¼ é€’ç»™å­Viewçš„MeasureSpecæ˜¯çˆ¶å®¹å™¨æ ¹æ®è‡ªå·±çš„MeasureSpecåŠå­Viewçš„å¸ƒå±€å‚æ•°æ‰€ç¡®å®šçš„ï¼Œé‚£ä¹ˆæ ¹MeasureSpecæ˜¯è°åˆ›å»ºçš„å‘¢ï¼Ÿæˆ‘ä»¬ç”¨æœ€å¸¸ç”¨çš„ä¸¤ç§Windowæ¥è§£é‡Šä¸€ä¸‹ï¼ŒActivityä¸Dialogï¼ŒDecorViewæ˜¯Activityçš„æ ¹å¸ƒå±€ï¼Œä¼ é€’ç»™DecorViewçš„MeasureSpecæ˜¯ç³»ç»Ÿæ ¹æ®Activityæˆ–è€…Dialogçš„Themeæ¥ç¡®å®šçš„ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œæœ€åˆçš„MeasureSpecæ˜¯ç›´æ¥æ ¹æ®Windowçš„å±æ€§æ„å»ºçš„ï¼Œä¸€èˆ¬å¯¹äºActivityæ¥è¯´ï¼Œæ ¹MeasureSpecæ˜¯EXACTLY+å±å¹•å°ºå¯¸ï¼Œå¯¹äºDialogæ¥è¯´ï¼Œå¦‚æœä¸åšç‰¹æ®Šè®¾å®šä¼šé‡‡ç”¨AT_MOST+å±å¹•å°ºå¯¸ã€‚è¿™é‡Œç‰µæ‰¯åˆ°WindowManagerServiceè·ŸActivityManagerService æ„Ÿè°¢123456é“¾æ¥ï¼šhttps://www.jianshu.com/p/cecd0de7ec27æ¥æºï¼šç®€ä¹¦ä½œè€…ï¼šçœ‹ä¹¦çš„å°èœ—ç‰›é“¾æ¥ï¼šhttps://www.jianshu.com/p/d16ec64181f2æ¥æºï¼šç®€ä¹¦","link":"/2020/04/26/Android/widthMeasureSpec-heightMeasureSpec/"},{"title":"App Debug ä¸»çº¿ç¨‹ï¼Œå‡ºç°ANRåè¢«ç³»ç»ŸKill","text":"ç—›ç‚¹ç¬”è€…æ‰‹ä¸Šæœ‰ä¸ªReamle GTï¼Œæ—¥å¸¸å¼€å‘å·¥ä½œä¸­ï¼Œæ˜¯ä¸æ˜¯ä¼šdebugï¼Œæ–­ç‚¹åœ¨ä¸»çº¿ç¨‹é‡Œé¢ï¼ŒåŸºæœ¬è¢«killï¼Œæ²¡åŠæ³•è°ƒè¯•ä»£ç ï¼Œè‡ªåŠ¨é‡å¯ç»™å¼€å‘å¸¦æ¥å¾ˆå¤§å›°æ‰°ï¼Œå®åœ¨å—ä¸äº†ï¼Œç€æ‰‹è§£å†³ã€‚ ç¯å¢ƒï¼šrealme gtï¼ŒAndroid11ï¼Œrealme ui 2.0 æ€è·¯å…ˆå…¨å±€æ‰¾logï¼Œå‘ç°ä¿¡æ¯ï¼Œæ¡†æ¶é‡Œé¢ä¸€å®šä¼šç•™ä¸‹ä¸‹ä»€ä¹ˆã€‚å¤ç°ä¸€æ¬¡ï¼Œé‡‡é›†logcatï¼Œå°è¯•æœç´¢åŒ…åï¼Œkill app å¤šå…³æ³¨ ActivityManagerã€‚ æ‰¾å®ç°é€»è¾‘ä»”ç»†ç­›é€‰ä¸€ä¸‹ï¼Œ å‘ç°äº†è¿™ä¸ªæ—¥å¿—ï¼Œå°±æ˜¯ç½ªé­ç¥¸é¦–äº† 104-23 14:07:36.545 1397 1695 I ActivityManager: Killing 13134:com.hi.dhl.startup.simple/u0a297 (adj 0): user request after error:Input dispatching timed out (3f0c272 com.simple/com.simple.MainActivity (server) is not responding. Waited 5001ms for MotionEvent) æ¥ç€è¿‡æ»¤ä¸€ä¸‹ActivityManager logï¼Œå¯ä»¥çœ‹åˆ°æœ‰å‡ºç°ANRä¹‹åï¼Œå¤„ç†å®ŒANRä¹‹åï¼Œappå°±è¢«killäº† 12345678910111213141516171819202122237485: 04-23 14:07:36.527 1397 13246 E ActivityManager: 0% 12803/kworker/4:2-mm_percpu_wq: 0% user + 0% kernel7486: 04-23 14:07:36.527 1397 13246 E ActivityManager: +0% 13207/logcat: 0% user + 0% kernel7487: 04-23 14:07:36.527 1397 13246 E ActivityManager: 3.7% TOTAL: 1% user + 1.8% kernel + 0% iowait + 0.6% irq + 0.1% softirq7488: 04-23 14:07:36.527 1397 13246 E ActivityManager: CPU usage from 61ms to 379ms later (2022-04-23 14:07:36.082 to 2022-04-23 14:07:36.400):7489: 04-23 14:07:36.527 1397 13246 E ActivityManager: 37% 1397/system_server: 10% user + 27% kernel / faults: 921 minor7490: 04-23 14:07:36.527 1397 13246 E ActivityManager: 31% 13246/AnrConsumer: 6.8% user + 24% kernel7491: 04-23 14:07:36.527 1397 13246 E ActivityManager: 3.4% 2468/SensorService: 0% user + 3.4% kernel7492: 04-23 14:07:36.527 1397 13246 E ActivityManager: 3.4% 2790/OplusAppBwCore: 0% user + 3.4% kernel7493: 04-23 14:07:36.527 1397 13246 E ActivityManager: 3.2% 356/kworker/u24:6-ufs_clk_gating_0: 0% user + 3.2% kernel7494: 04-23 14:07:36.527 1397 13246 E ActivityManager: 3.3% 1008/usbtemp_kthread: 0% user + 3.3% kernel7495: 04-23 14:07:36.527 1397 13246 E ActivityManager: 4.2% 11938/kworker/u24:2-memlat_wq: 0% user + 4.2% kernel7496: 04-23 14:07:36.527 1397 13246 E ActivityManager: 7.2% TOTAL: 2% user + 4.8% kernel + 0.4% irq7497 04-23 14:07:36.527 1397 13246 V java.lang.ASSERT: copyAnr filePath = /data/anr/anr_2022-04-23-14-07-36-4287499 04-23 14:07:36.528 1397 13246 D OplusManager: send on stamp success7500: 04-23 14:07:36.528 1397 13246 D ActivityManager: Completed ANR of com.simple in 508ms, latency 1ms7501: 04-23 14:07:36.529 1397 1695 W ActivityManager: Dismiss app ANR dialog : com.simple 7502: 04-23 14:07:36.529 1397 1695 W ContextImpl: Calling a method in the system process without a qualified user: android.app.ContextImpl.sendBroadcast:1161 com.android.server.am.OplusExtraActivityManagerService.setKeyLockModeNormal:51 com.android.server.am.ActivityManagerService.killAppAtUsersRequest:10688 com.android.server.am.AppErrors.handleShowAnrUi:966 com.android.server.am.ActivityManagerService$UiHandler.handleMessage:1884 7503 04-23 14:07:36.529 1397 13247 I DropBoxManagerService: add tag=data_app_anr isTagEnabled=true flags=0x27527 04-23 14:07:36.544 1397 1695 D ScreenMode: switch from 2 to 37528: 04-23 14:07:36.545 1397 1695 I ActivityManager: Killing 13134:com.simple /u0a297 (adj 0): user request after error:Input dispatching timed out (3f0c272 com.simple /com.simple .MainActivity (server) is not responding. Waited 5001ms for MotionEvent)7529 04-23 14:07:36.545 1397 1700 D OplusFeatureHDREnhanceBrightness: onConfigChangedthreadId=22, threadName=android.display, configId=1 åŸºæœ¬å¯ä»¥ç¡®å®šï¼Œæ˜¯å‡ºç°ANRä¹‹åï¼Œè¢«killäº†ï¼Œä½†æ˜¯å…¶ä»–æ‰‹æœºä¸Šï¼Œä¼šå‡ºç°ä¸ªANRå¯¹è¯æ¡†ï¼Œå¯ä»¥ç¡®å®šçš„æ˜¯ï¼Œå¼€å‘è€…é€‰é¡¹é‡Œé¢çš„å·²ç»å¼€å¯äº†ã€‚é‚£ä¹ˆå‚å•†æ˜¯æ€ä¹ˆåšçš„å‘¢ï¼Ÿå»æ‹‰ä¸€ä¸‹æ¡†æ¶ä»£ç  1adb pull /system/framework é¦–å…ˆæ¥çœ‹ä¸€ä¸‹ framework.jar ,å»çœ‹ä¸‹Activity Managerçš„ä»£ç å»æœç´¢ä¸€ä¸‹ æ—¥å¿—é‡Œé¢çš„å­—æ®µï¼Œå¾ˆé—æ†¾æ²¡æœ‰æ‰¾åˆ°ä»€ä¹ˆã€‚é™¤äº† framework.jar è¿˜æœ‰ services.jarï¼Œä¸€äº›ç³»ç»ŸæœåŠ¡åœ¨é‡Œé¢ã€‚åœ¨services.jar é‡Œé¢ï¼Œå‘ç°ä¸€äº›ç«¯å€ªï¼Œå»è¿½ ï¼Œæœç„¶æ˜¯åœ¨ActivityManagerServiceé‡Œé¢ 12345678910111213141516171819public void killAppAtUserRequestLocked(ProcessRecord app) { String killAnnotation; ProcessRecord.ErrorDialogController controller = app.getDialogController(); int reasonCode = 6; int subReason = 0; if (controller.hasDebugWaitingDialog()) { reasonCode = 13; subReason = 1; } controller.clearAllErrorDialogs(); if (app == null || app.mAnrAnnotation == null) { killAnnotation = \"user request after error\"; } else { String killAnnotation2 = \"user request after error:\" + app.mAnrAnnotation; app.mAnrAnnotation = null; killAnnotation = killAnnotation2; } killAppImmediateLocked(app, reasonCode, subReason, \"user-terminated\", killAnnotation);} è°ƒç”¨æ¥ç€ 123456789101112131415public void killAppAtUsersRequest(ProcessRecord app) { synchronized (this) { try { boostPriorityForLockedSection(); if (app.pid &gt; 0 &amp;&amp; app.pid != MY_PID) { OplusExtraActivityManagerService.setKeyLockModeNormal(this.mContext, app.processName, this.mSystemReady); } this.mAppErrors.killAppAtUserRequestLocked(app); } catch (Throwable th) { resetPriorityAfterLockedSection(); throw th; } } resetPriorityAfterLockedSection();} ç»§ç»­è¿½è°ƒç”¨ï¼Œå‘ç°æœ‰4ä¸ªåœ°æ–¹åœ¨å¼•ç”¨ï¼Œæˆ‘ä»¬æŒ¨ä¸ªç¡®è®¤ä¸€ä¸‹ï¼Œåœ¨åœ¨ handleShowAnrUi é‡Œé¢ï¼Œå¯ä»¥å‘ç°è¿™æ®µé€»è¾‘å‘ä¸Šå»è¿½è¿™æ®µé€»è¾‘ï¼Œå‘ç°æœ‰ä¸ªæ§åˆ¶é€»è¾‘_ java.lang.String r5 = â€œpersist.sys.assert.panicâ€ï¼Œ _åœ¨shellé‡Œé¢getproè¯•ä¸€ä¸‹ï¼Œå¾—åˆ°é»˜è®¤falseã€‚æˆ‘ä»¬ç°åœ¨è¦è·³è¿‡killçš„é€»è¾‘ï¼Œæ”¹æ‰è¿™ä¸ªå€¼ä¸å°±å¯ä»¥å•¦ã€‚ ä¿®æ”¹_ ä¸å¹¸çš„æ˜¯ï¼Œpersist.sys.æ˜¯ç³»ç»Ÿå±æ€§ï¼Œæ™®é€šç”¨æˆ·æ²¡æœ‰æƒé™ä¿®æ”¹ï¼Œä¹Ÿå°±æ˜¯è¯´éœ€è¦rootæƒé™ã€‚rootæƒé™ï¼Œéœ€è¦è§£é”ã€‚è§£é”éƒ¨åˆ†å¯ä»¥å»xdaçœ‹çœ‹ï¼Œä¹Ÿæ˜¯ç”³è¯·è§£é”ï¼Œå¯åŠ¨twrpï¼Œåˆ·å†™magiské‚£ä¸€å¥—ã€‚rootå®Œä¹‹åï¼Œshellé‡Œé¢ï¼Œsu setpro _persist.sys.assert.panic = trueã€‚ éªŒè¯ç°åœ¨æ–­ç‚¹åœ¨ä¸»çº¿ç¨‹é‡Œé¢ï¼Œå°±å‡ºç°å¼¹çª—ï¼Œä¸ä¼šç›´æ¥kill debugçš„appäº†ã€‚æƒ³æ–­å¤šä¹…å°±å¤šä¹…äº†ã€‚ å»ºè®®å›½å†…å¯ä»¥è€ƒè™‘å°ç±³å’Œä¸€åŠ ï¼Œè§£é”å’Œåˆ·æœºèµ·æ¥æ¯”è¾ƒç®€å•ï¼Œå¯ä»¥åˆ·ä¸€äº›ç®€å•çš„ROMï¼Œè°ƒè¯•å’Œå¯ç©æ€§éƒ½æ¯”è¾ƒé«˜ã€‚","link":"/2022/04/30/Android/ui-timeout-kill-app-md/"},{"title":"å¦‚ä½•ä¸‹è½½AOSP (Android Open Source Project)","text":"å‡†å¤‡æ¡ä»¶ä½ å¯èƒ½ä¸´æ—¶èµ·æ„æƒ³è¦å°è¯•ï¼Œæœ€å¥½å…ˆç¡®è®¤ä¸€ä¸‹è‡ªå·±çš„è½¯ç¡¬ä»¶ç¯å¢ƒ å†…å­˜16GBèµ·æ­¥,ç¼–è¯‘ä¼šå‡ºç° fatal error: runtime: out of memory ç£ç›˜200GB+ å¦‚æœä½ æ˜¯è¦çœ‹æºç ï¼Œç”¨ä¸ç€ä¸‹è½½ http://androidxref.com/ http://www.aospxref.com/ https://cs.android.com/ æœ¬æ–‡é‡‡ç”¨çš„æ˜¯æ¸…åæº https://mirrors.tuna.tsinghua.edu.cn/help/AOSP/ï¼Œä½ å¯ä»¥å¯ä»¥æŒ‰åŸæ–‡é‡Œé¢çš„æ­¥éª¤ ä¸‹è½½repoå·¥å…·repoå°±æ˜¯ä¸€ä¸ªgitè„šæœ¬çš„é›†åˆï¼Œå…¶å®è¿˜æ˜¯gitå…¬äº¤ï¼Œå¾ˆå¤šgitå‘½ä»¤å¯ä»¥ç›´æ¥å¥—ç”¨ã€‚ 1234mkdir ~/binPATH=~/bin:$PATHcurl https://storage.googleapis.com/git-repo-downloads/repo &gt; ~/bin/repochmod a+x ~/bin/repo repo init åˆå§‹åŒ– æˆ‘æ²¡æœ‰é€šè¿‡åˆå§‹åŒ…çš„æ–¹å¼ä¸‹è½½ï¼ŒåŒ…å«äº†è‡ªå·±ä¸éœ€è¦çš„ï¼Œè€Œä¸”å…¨éƒ¨å·¥ç¨‹æœ‰ç‚¹å¤§ã€‚æˆ‘ä»¬åšä¸€äº›ç²¾ç®€ã€‚æ‹‰å–æŒ‡å®šçš„åˆ†æ”¯ï¼Œå¦‚æœéœ€è¦ç‰¹å®šçš„åˆ†æ”¯ å»https://source.android.com/source/build-numbers.html#source-code-tags-and-builds é€‰æ‹©Tag repo init --depth=1 -u https://aosp.tuna.tsinghua.edu.cn/platform/manifest -b android-11.0.0_r39 â€“depth=1 è¡¨ç¤ºåªä¸‹è½½æœ€è¿‘ç‰ˆæœ¬çš„ä»£ç ï¼Œåªä¿ç•™æœ€è¿‘çš„commitç‰ˆæœ¬ã€‚ä½¿ç”¨â€“depth å¯ä»¥èŠ‚çœæœ¬åœ°ç£ç›˜ç©ºé—´ï¼ŒåŠ é€Ÿä¸‹è½½ï¼Œå¯¹äºå¼€å‘å¤Ÿç”¨äº† repo sync ä¸‹è½½repo sync -c -f --no-tags --no-clone-bundle -j`nproc` -c æˆ–è€…â€“current-branchè¡¨ç¤ºåªæ‹‰å–å½“å‰åˆ†æ”¯ä»£ç . â€“no-tags ä¸æ‹‰å–tags â€“no-clone-bundle ä¸ä½¿ç”¨clone.bundle -f å¦‚æœsyncå¤±è´¥ï¼Œç»§ç»­åŒæ­¥ â€“force-sync å¦‚æœæ–‡ä»¶ç›®å½•æœ‰å·®å¼‚ï¼Œå¼ºåˆ¶è¦†ç›–æ‰ -j å‚æ•°æŒ‡å®šåŒæ—¶è¿è¡Œå¤šå°‘ä¸ªjob, çœ‹å…·ä½“çš„æºæ˜¯å¦æ”¯æŒè¶³å¤Ÿçš„æ•°é‡ æ‰§è¡Œç©ä¼šå‡ºç°successçš„logï¼Œå¤§æ¦‚80GBå·¦å³ï¼Œå‡ºé”™å¯é‡æ–°æ‰§è¡Œã€‚ å¦‚æœå‡ºç°å¦‚ä¸‹çš„é”™è¯¯ï¼Œä¸Šé¢çš„å‘½ä»¤è¿½åŠ é‡æ–°è·‘ä¸€æ¬¡ 123error: Unable to fully sync the tree.error: Downloading network changes failed.Try re-running with \"-j1 --fail-fast\" to exit at the first error å¸¸ç”¨çš„repoå‘½ä»¤ åˆ›å»ºåˆ†æ”¯ 1repo start --all è‡ªå®šä¹‰åˆ†æ”¯å åˆ é™¤åˆ†æ”¯ 1repo abandon å·²åˆ›å»ºçš„æœ¬åœ°åˆ†æ”¯å åˆ‡æ¢åˆ†æ”¯ 12repo init -b xxx --depth=1repo sync -c -f repoå›æ»š 123repo sync -drepo forall -c 'git reset --hard' # Remove all working directory (and staged) changes.repo forall -c 'git clean -f -d' # Clean untracked files æŸ¥çœ‹å½“å‰é¡¹ç›®åˆ†æ”¯ 12repo branchrepo status å¯ä»¥çœ‹åˆ°æ¯ä¸€ä¸ªgit å·¥ç¨‹ 12345678910111213141516171819202122232425262728project art/ branch android_11_study_ckproject bionic/ branch android_11_study_ckproject bootable/recovery/ branch android_11_study_ckproject build/blueprint/ branch android_11_study_ckproject build/make/ branch android_11_study_ckproject build/soong/ branch android_11_study_ckproject compatibility/cdd/ branch android_11_study_ckproject cts/ branch android_11_study_ckproject dalvik/ branch android_11_study_ckproject developers/build/ branch android_11_study_ckproject developers/demos/ branch android_11_study_ckproject developers/samples/android/ branch android_11_study_ckproject development/ branch android_11_study_ckproject device/amlogic/yukawa/ branch android_11_study_ckproject device/amlogic/yukawa-kernel/ branch android_11_study_ckproject device/common/ branch android_11_study_ckproject device/generic/arm64/ branch android_11_study_ckproject device/generic/armv7-a-neon/ branch android_11_study_ckproject device/generic/art/ branch android_11_study_ckproject device/generic/car/ branch android_11_study_ckproject device/generic/common/ branch android_11_study_ckproject device/generic/goldfish/ branch android_11_study_ckproject device/generic/goldfish-opengl/ branch android_11_study_ckproject device/generic/mini-emulator-arm64/ branch android_11_study_ckproject device/generic/mini-emulator-armv7-a-neon/ branch android_11_study_ckproject device/generic/mini-emulator-x86/ branch android_11_study_ckproject device/generic/mini-emulator-x86_64/ branch android_11_study_ckproject device/generic/opengl-transport/ branch android_11_study_ck AOSP ç›®å½•ç®€ä»‹ç›®å½•ç»“æ„https://elinux.org/Master-android 123456789101112131415161718192021222324252627./â”œâ”€â”€ artâ”œâ”€â”€ bionicâ”œâ”€â”€ bootableâ”œâ”€â”€ buildâ”œâ”€â”€ compatibilityâ”œâ”€â”€ ctsâ”œâ”€â”€ dalvikâ”œâ”€â”€ developersâ”œâ”€â”€ developmentâ”œâ”€â”€ deviceâ”œâ”€â”€ externalâ”œâ”€â”€ frameworksâ”œâ”€â”€ hardwareâ”œâ”€â”€ kernelâ”œâ”€â”€ libcoreâ”œâ”€â”€ libnativehelperâ”œâ”€â”€ outâ”œâ”€â”€ packagesâ”œâ”€â”€ pdkâ”œâ”€â”€ platform_testingâ”œâ”€â”€ prebuiltsâ”œâ”€â”€ sdkâ”œâ”€â”€ systemâ”œâ”€â”€ testâ”œâ”€â”€ toolchainâ””â”€â”€ tools abiï¼ˆApplication Binary Interfaceï¼‰ https://developer.android.com/ndk/guides/abis artï¼ˆAndroid runtimeï¼‰ https://source.android.com/devices/tech/dalvik/ bionic ä¸€äº›åŸºç¡€åº“ libmï¼ˆlibrary mathï¼‰ libcï¼ˆlibrary cï¼‰ï¼šåœ¨ glibc çš„åŸºç¡€ä¸Šåšäº†è£å‰ªä¸ä¿®æ”¹çš„ï¼Œä¸ºäº†è§„é¿GNU GPLç­‰å•†ä¸šè¡Œä¸ºçš„çº¦æŸ libstdc++ï¼ˆlibrary standard C++ï¼‰ï¼šå¹¶éå®Œæ•´ç‰ˆï¼Œåªåšäº†ç®€å•æ”¯æŒlinkerï¼šè£…è½½é“¾æ¥ç›¸å…³åº“ bootablebootable ä¸‹ä»…åŒ…å« recovery æ­¤æ–‡ä»¶å¤¹ï¼Œå…¶å®å°±æ˜¯å¯åŠ¨ Android recovery æ¨¡å¼ç›¸å…³çš„ä»£ç  buildAndroid Build ç³»ç»Ÿï¼Œç”¨æ¥å®šåˆ¶å„ç§ç¼–è¯‘è§„åˆ™ã€‚ä¸»è¦ç”± makefile ç»„æˆã€‚æ¯”å¦‚åœ¨ç¼–è¯‘æ—¶è¦æ‰§è¡Œçš„ source build/envsetup.sh å°±ä½äº build ä¸‹ ctsï¼ˆCompatibility Test Suite)ä¸€ä¸ªè‡ªåŠ¨åŒ–æµ‹è¯•å·¥å…· CTS dalvikdalvik è™šæ‹Ÿæœº , https://source.android.com/devices/tech/dalvik/ developersä¸€äº›å¯è¿è¡Œçš„ Android ç¤ºä¾‹é¡¹ç›®ï¼Œå¯ä»¥å•ç‹¬æ‹‰å‡ºæ¥è¿è¡Œ deviceåŒ…å«ä¸åŒå“ç‰Œæ‰‹æœºç‹¬æœ‰çš„è®¾å¤‡ä¿¡æ¯ externalä¸€äº›å¼€æºçš„ç¬¬ä¸‰æ–¹ç»„ä»¶ï¼Œè¿™é‡Œä»…åˆ—äº†ä¸€ä¸‹å¤§å®¶æ¯”è¾ƒç†Ÿæ‚‰çš„å¦‚glideã€junitã€okhttpã€sqlite ç­‰ frameworksAndroid ä¸­å¤§å®¶ç†Ÿæ‚‰çš„ Frameworksï¼Œåº”ç”¨ç¨‹åºæ¡†æ¶å±‚ 12345678910111213141516avbasecompiledata-bindingexmffminikinmlmultidexnativeoptrssupportvolleywebviewwilhelm Android support åŒ… com.android.support:support-v4ã€v7 ç­‰éƒ½ä½äº frameworks/support æ–‡ä»¶å¤¹ä¸‹ webview å°±ä½äº frameworks/webview æ–‡ä»¶å¤¹ä¸‹ å„ç§ Serviceï¼Œæ¯”å¦‚ActivityManagerServiceã€SystemServiceã€WindowManagerServiceã€InputManagerServiceç­‰å°±ä½äº frameworks/base æ–‡ä»¶å¤¹ä¸‹ keystoreã€opengl ç­‰ä¹Ÿä½äº frameworks/base æ–‡ä»¶å¤¹ä¸‹ hardwareåŒ…å«äº† android HALï¼ˆç¡¬ä»¶æŠ½è±¡å±‚ï¼‰ç›¸å…³ä»£ç ã€‚ç¡¬ä»¶æŠ½è±¡å±‚ä»‹äº Linuxå†…æ ¸é©±åŠ¨ç¨‹åºä¸ Android ç³»ç»Ÿä¹‹é—´ã€‚å¯¹ Linux é©±åŠ¨è¿›è¡Œäº†å°è£…ï¼Œä½¿æ“ä½œç³»ç»Ÿçº§åˆ«å¯ä»¥å¿½ç•¥åº•å±‚å®ç°çš„ç»†èŠ‚ã€‚ libcore ä¸€äº›æ ¸å¿ƒåº“ libnativehelperJNI ç›¸å…³çš„ä¸€äº›ç±» ndkåŸç”Ÿå¼€å‘å·¥å…·åŒ… outç¼–è¯‘å®Œåè¾“å‡ºçš„æ‰€æœ‰ç›¸å…³æ–‡ä»¶éƒ½ä½äºæ­¤æ–‡ä»¶å¤¹ä¸‹ï¼ŒåŒ…æ‹¬ç”Ÿæˆçš„å„ç§ img å°±ä½äº out/target/product/hammerhead ä¸‹ packageså„ç§å†…ç½®çš„ apkã€ContentProviderã€è¾“å…¥æ³•ã€å£çº¸ç­‰ è“ç‰™ã€æµè§ˆå™¨ã€ç›¸æœºã€é‚®ä»¶ã€éŸ³ä¹ã€NFC ç­‰éƒ½ä½äº packages/apps ä¸‹é¢ MediaProviderã€DownloadProviderã€MmsProviderç­‰éƒ½ä½äº packages/providers ä¸‹ å£çº¸ç›¸å…³ä½äº packages/wallpapers ä¸‹ pdkï¼ˆPlatform Development Kitï¼‰å¹³å°å¼€å‘å¥—ä»¶ï¼Œä»…åŒ…å«äº†ä¸€äº›ä¾›ç¡¬ä»¶æŠ½è±¡å±‚å¼€å‘ä½¿ç”¨çš„å¿…è¦ç»„ä»¶ï¼Œä¾›ä¸€äº› OEM å‚å•†ç”¨æ¥é€‚é…åŠæµ‹è¯•æœ€æ–°çš„Android ç³»ç»Ÿï¼ŒåŠ å¿«ç¬¬ä¸‰æ–¹å‚å•†çš„æ›´æ–°é€Ÿåº¦ã€‚åŠ å¿«OEMå‚å•†çš„updateé€Ÿåº¦ prebuiltsä¸€äº›é¢„æ„å»ºæˆäºŒè¿›åˆ¶çš„åº“ prebuiltshttps://developer.android.com/ndk/guides/prebuilts systemAndroid çš„éƒ¨åˆ†ç³»ç»Ÿæºç åŠä¸€äº›å·¥å…·ï¼Œä¸»è¦æ˜¯åœ¨å„ç§ java å¯åŠ¨ç¨‹åºèµ·æ¥å‰çš„éƒ¨åˆ†ã€‚å·¥å…·æ¯”å¦‚ adbã€fastbootã€keystore ç­‰ï¼Œå…¶ä»–å¦‚ mkbootimgã€init è¿›ç¨‹ç­‰ vendoråŒ…å«ä¸åŒä¾›åº”å•†çš„ç§æœ‰çš„äºŒè¿›åˆ¶åº“ å‚è€ƒ https://blog.csdn.net/counsellor/article/details/86591081 https://ressrc.com/2018/11/19/android-source-directory-structure-analysis/","link":"/2021/07/17/Android/%E5%A6%82%E4%BD%95%E4%B8%8B%E8%BD%BDaosp/"},{"title":"Androidå¼€å‘å·¥å…·æ¨è","text":"è‡ªå·±åœ¨å¹³æ—¶å·¥ä½œä¸­å‘ç°çš„ä¸€äº›ä¸é”™çš„å·¥å…·ï¼Œè®°å½•ä¸‹ï¼Œæ–¹ä¾¿åœ¨åˆ‡æ¢å¤–éƒ¨ç¯å¢ƒçš„æ—¶å€™ï¼Œå¿«é€Ÿæ‰¾å›æŒç»­æ›´æ–° AS æ’ä»¶ SaveActionå¯ä»¥åœ¨ä¿å­˜çš„æ—¶å€™ï¼Œè‡ªåŠ¨æ ¼å¼åŒ–è‡ªå·±ä¿®æ”¹è¿‡çš„ä»£ç ï¼Œå¯ä»¥è‡ªåŠ¨å»æ‰å¤šä½™çš„import Git Tool Boxå¿«é€Ÿç›´æ¥æ˜¾ç¤ºgit balme CodeLocator https://github.com/bytedance/CodeLocator å±•ç¤ºå½“å‰çš„Viewè§†å›¾ å±•ç¤ºå½“å‰çš„Activityä¿¡æ¯ å±•ç¤ºå½“å‰æ‰€æœ‰Fragmentçš„ä¿¡æ¯ å±•ç¤ºè‡ªå®šä¹‰çš„Appè¿è¡Œæ—¶ä¿¡æ¯ å±•ç¤ºå½“å‰åº”ç”¨çš„æ–‡ä»¶ä¿¡æ¯ å®æ—¶ç¼–è¾‘Viewçš„çŠ¶æ€, å¦‚å¯è§æ€§, æ–‡æœ¬å†…å®¹ç­‰ å®šä½å½“å‰å“åº”è§¦æ‘¸äº‹ä»¶çš„View è·å–å½“å‰Viewç»‘å®šçš„æ•°æ® è·å–å½“å‰Viewå¯¹åº”çš„ç»˜åˆ¶å†…å®¹ è·³è½¬Viewçš„ç‚¹å‡»äº‹ä»¶ä»£ç , findViewById, ViewHolderçš„ä»£ç ä½ç½® è·³è½¬Viewçš„xmlå¸ƒå±€æ–‡ä»¶ è·³è½¬Toast, Dialogçš„æ˜¾ç¤ºä»£ç ä½ç½® è·³è½¬å¯åŠ¨å½“å‰Activityçš„ä»£ç ä½ç½® å±•ç¤ºåº”ç”¨æ”¯æŒçš„æ‰€æœ‰Schemaä¿¡æ¯ å‘åº”ç”¨å‘é€æŒ‡å®šSchema å®šä½é¡¹ç›®å†…æœ€æ–°çš„Apkæ–‡ä»¶ apkæ–‡ä»¶æ”¯æŒå³é”®å®‰è£… å¿«é€Ÿæ‰“å¼€æ˜¾ç¤ºå¸ƒå±€è¾¹ç•Œ, è¿‡æ¸¡ç»˜åˆ¶, ç‚¹æŒ‰æ“ä½œç­‰ å¿«é€Ÿè¿æ¥Charlesä»£ç† Appå·¥å…· Topactivityå¯ä»¥æŸ¥çœ‹å½“å‰æ‰“å¼€çš„é¡µé¢ï¼ŒåŒ…åç§°å’Œé¡µé¢åç§°ï¼Œæ–¹ä¾¿å¿«é€Ÿå®šä½Activity ä¸‹è½½ topactivity.mp3 LibChecker æ–¹ä¾¿å¿«é€Ÿåˆ†äº«ç›®æ ‡appä½¿ç”¨äº†å“ªäº›åŸç”Ÿåº“ï¼Œå¯ä»¥è·Ÿè¸ªå­¦ä¹ ä¸€äº›å¼€æºé¡¹ç›®ï¼Œä¾‹å¦‚åˆ†æå¾®ä¿¡çš„so ä¸‹è½½ libchecker.mp3 Intet Interceptå‘é€æˆ–æ¥å—ä¸€ä¸ªIntetï¼Œå¯ä»¥åˆ†æå’Œdebug Intet ä¸‹è½½ intentintercept.mp3 ActivityManageråˆ†æç›®å‰appçš„Activityï¼Œå¹¶æ”¯æŒç›´æ¥æŒ‘æˆ˜ç›®æ ‡é¡µé¢ ä¸‹è½½activitymanager.mp3","link":"/2021/12/11/Android/%E5%BC%80%E5%8F%91%E5%B7%A5%E5%85%B7%E6%8E%A8%E8%8D%90/"},{"title":"å¿«é€Ÿç‚¹å‡»StartActivityå¼•å‘çš„è¯¯ä¼š","text":"é—®é¢˜æ¥æºåœ¨A è·³åˆ° B ï¼Œå†è·³åˆ°Cçš„è¿‡ç¨‹ä¸­ï¼Œä¸€å®šæ¡ä»¶ä¸‹å‘é€å¹¿æ’­ï¼Œéœ€è¦æŠŠBå…³æ‰ï¼Œè¾¾åˆ°çš„æ•ˆæœå°±æ˜¯ Cç›´æ¥è¿”å›Aã€‚ä½†æ˜¯ç°åœ¨å‡ºç°ä¸€ä¸ªBugå°±æ˜¯Cè¿”å›çš„æ—¶å€™ï¼Œè¿˜æ˜¯Bã€‚å½“æ—¶æ²¡æœ‰æ‰“å°onCreateçš„æ—¥å¿—ï¼Œåªå‘ç°Båœ¨å‰é¢finishäº†ï¼Œå±…ç„¶åˆåœ¨åé¢onResumeäº†ï¼Œè¿™æ˜¾ç„¶è¿åç§‘å­¦ã€‚å½“æ—¶æƒ³å°±ç®—Bå¯åŠ¨äº†å¤šä¸ªï¼ŒBä¹Ÿéƒ½åœ¨onCreateçš„æ—¶å€™æ³¨å†Œäº†å¹¿æ’­ï¼Œéƒ½åº”è¯¥å¯ä»¥æ”¶åˆ°å¹¿æ’­çš„ã€‚åé¢æ€€ç–‘æ˜¯æ‰‹æ»‘ä¸å°å¿ƒç‚¹å‡»äº†2æ¬¡ï¼Œæˆ–æ˜¯ç³»ç»Ÿçªç„¶å“åº”è¿‡æ…¢ï¼Œç‚¹å‡»äº†å¤šæ¬¡ï¼Œé€ æˆåˆ›å»ºäº†å¤šä¸ªå®ä¾‹ï¼Œæ‰€ä»¥æˆ‘ç›´æ¥é€šè¿‡forå¾ªç¯å¿«é€Ÿæ¨¡æ‹Ÿè¿™ç§æƒ…å†µã€‚ é—®é¢˜åˆ†æ æ¨¡æ‹Ÿå¤ç°é—®é¢˜123for (int i = 0; i &lt; 4; i++) { startActivity(new Intent(MainActivity.this, Main2Activity.class));} é¦–å…ˆæŸ¥çœ‹ activityæ ˆ é€šè¿‡db shell dumpsys activity activities æŸ¥çœ‹ activityæ ˆçš„è¯¦ç»†ä¿¡æ¯ è¿‡æ»¤äº†æˆ‘ä»¬åªå…³å¿ƒçš„ä¿¡æ¯ 12345678910111213141516* Hist #4: ActivityRecord{6a9b44e u0 com.test/.Main2Activity t36} state=RESUMED stopped=false delayedResume=false finishing=false * Hist #3: ActivityRecord{d603f13 u0 com.test/.Main2Activity t36} state=INITIALIZING stopped=false delayedResume=false finishing=false * Hist #2: ActivityRecord{ec9aee4 u0 com.test/.Main2Activity t36} state=INITIALIZING stopped=false delayedResume=false finishing=false * Hist #1: ActivityRecord{aea6311 u0 com.test/.Main2Activity t36} state=INITIALIZING stopped=false delayedResume=false finishing=false * Hist #0: ActivityRecord{ff269a8 u0 com.test/.MainActivity t36} state=STOPPED stopped=true delayedResume=false finishing=false Running activities (most recent first): TaskRecord{561d198 #36 A=com.test U=0 StackId=11 sz=5} Run #1: ActivityRecord{6a9b44e u0 com.test/.Main2Activity t36} Run #0: ActivityRecord{ff269a8 u0 com.test/.MainActivity t36} mResumedActivity: ActivityRecord{6a9b44e u0 com.test/.Main2Activity t36} state=INITIALIZING ï¼Ÿï¼Ÿæˆ‘ä»¬å¯ä»¥çœ‹åˆ°åˆ›å»ºäº†4ä¸ªActivityRecordï¼Œè¿™ä¸ªæ˜¯ç¬¦åˆé¢„æœŸçš„ï¼Œå‰é¢çš„3ä¸ªActivityRecordçŠ¶æ€è¿˜æ˜¯INITIALIZINGï¼Œå°±æœ€åä¸€ä¸ªActivityRecordèµ°åˆ°äº†RESUMEDã€‚å‘ç°åœ¨è¿™ç§æƒ…å†µä¸‹é¢ï¼Œç‚¹å‡»è¿”å›çš„æ—¶å€™ï¼Œstate=INITIALIZING çš„Activityæ‰èµ°äº†onCreateã€‚ ç–‘æƒ‘ï¼Ÿ éš¾é“å‰é¢çš„ ActivityRecord ä¸åº”è¯¥éƒ½æ˜¯ state=STOPPED å—ï¼Ÿ æ€€ç–‘ç‚¹ï¼Œæ‰€æœ‰çš„Activityçš„ç”Ÿå‘½å‘¨æœŸæ–¹æ³•éƒ½æ˜¯AMSæ¥å›è°ƒçš„ï¼Œéƒ½ä¼šåœ¨æˆ‘ä»¬çš„ä¸»çº¿ç¨‹æ¶ˆæ¯é‡Œé¢å¤„ç† æ˜¯ä¸æ˜¯AMSååº”å¤ªæ…¢ï¼Ÿåæ­£å°±æ˜¯AMSçš„å›åˆ°æ¶ˆæ¯æ²¡æœ‰å‘è¿‡æ¥ï¼Ÿ æ¶ˆæ¯å‘è¿‡æ¥äº†ï¼Œæˆ‘ä»¬è¿˜æ²¡æœ‰å¤„ç† åŸºäºä¸Šé¢çš„å‡è®¾æˆ‘ä»¬ï¼Œæˆ‘ä»¬å¯ä»¥dumpä¸€ä¸‹æ¶ˆæ¯ dump message æŸ¥çœ‹ä¸»çº¿ç¨‹çš„çš„Looperé‡Œçš„MessageQueueé‡Œé¢çš„æŒæœ‰çš„æ¶ˆæ¯ 123456789 for (int i = 0; i &lt; 4; i++) { Log.i(TAG, \"startActivity: click -------------------\"); startActivity(new Intent(MainActivity.this, Main2Activity.class)); dump(); }public static void dump() { Looper.getMainLooper().dump(new LogPrinter(Log.DEBUG, TAG), \"PREFIX\");} 1234567891011121314151617181920212223242526272829303132333435363738394041// ç¬¬ä¸€æ¬¡ç«‹é©¬ç‚¹å‡»çš„æ—¶å€™ï¼Œå°±æ”¶åˆ°äº†ä¸€ä¸ª ClientTransaction æ¶ˆæ¯ 3.609 I/MainActivity: startActivity: click ------------------- 3.670 Looper (main, tid 2) {833b991} 3.670 Message 0: { when=-67ms callback=android.view.View$UnsetPressedState target=android.view.ViewRootImpl$ViewRootHandler } 3.671 Message 1: { when=-29ms what=159 obj=android.app.servertransaction.ClientTransaction@efd342 target=android.app.ActivityThread$H } 3.671 (Total messages: 2, polling=false, quitting=false) //ç¬¬äºŒæ¬¡ç‚¹å‡»çš„æ—¶å€™ï¼Œå¹¶æ²¡æœ‰æ”¶åˆ°æ¶ˆæ¯ï¼Œå¯ä»¥çœ‹åˆ°æ¶ˆæ¯æ²¡æœ‰å˜åŒ– 3.671 I/MainActivity: startActivity: click ------------------- 3.721 Looper (main, tid 2) {833b991} 3.721 Message 0: { when=-118ms callback=android.view.View$UnsetPressedState target=android.view.ViewRootImpl$ViewRootHandler } 3.721 Message 1: { when=-80ms what=159 obj=android.app.servertransaction.ClientTransaction@efd342 target=android.app.ActivityThread$H } 3.721 (Total messages: 2, polling=false, quitting=false) //ç¬¬ä¸‰æ¬¡ç‚¹å‡»çš„æ—¶å€™ï¼Œå¹¶æ²¡æœ‰æ”¶åˆ°æ¶ˆæ¯ï¼Œå¯ä»¥çœ‹åˆ°æ¶ˆæ¯æ²¡æœ‰å˜åŒ– 3.721 I/MainActivity: startActivity: click ------------------- 3.760 Looper (main, tid 2) {833b991} 3.760 Message 0: { when=-157ms callback=android.view.View$UnsetPressedState target=android.view.ViewRootImpl$ViewRootHandler } 3.761 Message 1: { when=-119ms what=159 obj=android.app.servertransaction.ClientTransaction@efd342 target=android.app.ActivityThread$H } 3.761 (Total messages: 2, polling=false, quitting=false) //ç¬¬å››æ¬¡ç‚¹å‡»çš„æ—¶å€™ï¼Œå¹¶æ²¡æœ‰æ”¶åˆ°æ¶ˆæ¯ï¼Œå¯ä»¥çœ‹åˆ°æ¶ˆæ¯æ²¡æœ‰å˜åŒ– 3.761 I/MainActivity: startActivity: click ------------------- 3.797 Looper (main, tid 2) {833b991} 3.797 Message 0: { when=-194ms callback=android.view.View$UnsetPressedState target=android.view.ViewRootImpl$ViewRootHandler } 3.797 Message 1: { when=-156ms what=159 obj=android.app.servertransaction.ClientTransaction@efd342 target=android.app.ActivityThread$H } 3.797 (Total messages: 2, polling=false, quitting=false) //åˆ°è¿™é‡Œä¸»çº¿ç¨‹æ‰ç©ºå‡ºæ‰‹æ¥ï¼Œå»å¤„ç†åé¢çš„æ¶ˆæ¯ //è¿™ä¸ªå°±æ˜¯è¿™ä¸ªonPauseæ¶ˆæ¯å¤„ç† 3.815 I/MainActivity: onPause: 3.815 Looper (main, tid 2) {833b991} 3.815 Message 0: { when=-15ms callback=android.view.Choreographer$FrameDisplayEventReceiver target=android.view.Choreographer$FrameHandler } 3.816 (Total messages: 1, polling=false, quitting=false) 4.808 I/MainActivity: onStop: æˆ‘ä»¬ç¡®å®åªæ”¶åˆ°äº†ä¸€ä¸ª onPauseæ¶ˆæ¯ï¼Œä¸ºä»€ä¹ˆï¼Ÿé‚£å°±éœ€è¦æ‰¾ä¸‹å¤§å“¥AMSé—®ä¸‹äº† æºç debugï¼Œå‘AMSå®šä½é—®é¢˜ å½“AMSæ”¶åˆ°startActivityä¹‹åï¼Œä¼šnewä¸€ä¸ªActivityRecord,ç„¶ååé¢éœ€è¦æŠŠå½“å‰ResumedçŠ¶æ€çš„Activityï¼ŒonPauseæ‰ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥ç›´æ¥å®šä½å‘é€Pauseæ¶ˆæ¯çš„åœ°æ–¹ã€‚ com.android.server.am.ActivityStack#startPausingLocked 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263final boolean startPausingLocked(boolean userLeaving, boolean uiSleeping, ActivityRecord resuming, boolean pauseImmediately) { //ç¬¬ä¸€æ¬¡è¿›æ¥mPausingActivityæ˜¯nullï¼Œåº”ç”¨æ²¡æœ‰æš‚åœå°±æ²¡æœ‰æ‰€è°“çš„mPausingActivity if (mPausingActivity != null) { ---- } //ç¬¬äºŒæ¬¡è¿›æ¥ï¼Œå¦‚æœ mResumedActivity = null ã€‚è¿™é‡Œç›´æ¥returnäº†ã€‚å°±æ˜¯Trying to pause when nothing is resumed //mResumedActivity å°±æ˜¯ å°†è¦å¯åŠ¨çš„activity com.test/.Main2Activity ActivityRecord prev = mResumedActivity; if (prev == null) { if (resuming == null) { Slog.wtf(TAG, \"Trying to pause when nothing is resumed\"); mStackSupervisor.resumeFocusedStackTopActivityLocked(); } return false; } if (prev == resuming) { Slog.wtf(TAG, \"Trying to pause activity that is in process of being resumed\"); return false; } // prev å°±æ˜¯å°†è¦æš‚åœçš„ ä¹‹å‰çš„ com.test/.MainActivity mPausingActivity = prev; mLastPausedActivity = prev; mLastNoHistoryActivity = (prev.intent.getFlags() &amp; Intent.FLAG_ACTIVITY_NO_HISTORY) != 0 || (prev.info.flags &amp; ActivityInfo.FLAG_NO_HISTORY) != 0 ? prev : null; // è®¾ç½®çŠ¶æ€PAUSING android 9åœ¨è¿™é‡Œé¢åšäº† mResumedActivity = null, å’Œç½‘ä¸Šä»¥å‰çš„åšå®¢çš„ä¸ä¸€æ · // åé¢è°ƒç”¨åˆ°äº†onActivityStateChanged prev.setState(PAUSING, \"startPausingLocked\"); prev.getTask().touchActiveTime(); clearLaunchTime(prev); mStackSupervisor.getLaunchTimeTracker().stopFullyDrawnTraceIfNeeded(getWindowingMode()); mService.updateCpuStats(); //è°ƒç”¨è¿›ç¨‹ä¸ä¸ºnullï¼Œä¸”è°ƒç”¨è¿›ç¨‹çš„ApplicationThreadä¸ä¸ºnull if (prev.app != null &amp;&amp; prev.app.thread != null) { if (DEBUG_PAUSE) Slog.v(TAG_PAUSE, \"Enqueueing pending pause: \" + prev); try { // è¿™é‡Œå‘é€äº†PauseActivityItem //é€šè¿‡è°ƒç”¨è¿›ç¨‹çš„ApplicationThreadé€šçŸ¥è°ƒç”¨è¿›ç¨‹schedulePauseActivityæ–¹æ³• //é‚£ä¹ˆåœ¨ onActivityStateChanged ä¹‹å†…ï¼Œåªä¼šèµ°ä¸€æ¬¡ mService.getLifecycleManager().scheduleTransaction(prev.app.thread, prev.appToken, PauseActivityItem.obtain(prev.finishing, userLeaving, prev.configChangeFlags, pauseImmediately)); } catch (Exception e) { // Ignore exception, if process died other code will cleanup. Slog.w(TAG, \"Exception thrown during pause\", e); mPausingActivity = null; mLastPausedActivity = null; mLastNoHistoryActivity = null; } } else { mPausingActivity = null; mLastPausedActivity = null; mLastNoHistoryActivity = null; }} com.android.server.am.ActivityStack#onActivityStateChanged 123456789void onActivityStateChanged(ActivityRecord record, ActivityState state, String reason) { //ä¹‹å‰çš„Resumedçš„ActivityRecord çš„ çŠ¶æ€æ”¹å˜æˆæ–°çš„ï¼Œå°±æ˜¯ state = PAUSINGï¼Œreason = startPausingLocked //è¿™é‡Œ setResumedActivity = null if (record == mResumedActivity &amp;&amp; state != RESUMED) { setResumedActivity(null, reason + \" - onActivityStateChanged\"); } ... } è±ç„¶å¼€æœ— onPause è‚¯å®šå’Œ ResumedActivity ç›¸å…³ï¼Œæ²¡æœ‰ResumedActivity ï¼Œè‡ªç„¶å°±ä¸éœ€è¦onPauseã€‚æ‰€ä»¥åœ¨çŸ­æ—¶é—´é‡Œé¢ï¼Œé‡å¤è¿›å…¥startPausingLockedå°±ä¼šå­˜åœ¨ä¸€ä¸ªçŠ¶æ€ï¼Œä¹Ÿå°±æ˜¯ mResumedActivity= nullã€‚ç„¶åè¿™ä¸ªstartPausingLockedæ–¹æ³•æå‰returnäº†ï¼Œæ ¹æœ¬æ²¡æœ‰å‘é€scheduleTransaction-&gt;PauseActivityItem ,æ‰€ä»¥çŸ­æ—¶æ—¶é—´é‡Œé¢åªå‘é€äº†ä¸€æ¬¡ï¼Œä¹Ÿå°±æ˜¯ä¸‹æ¬¡çš„mResumedActivityçš„setStateè¿˜æ²¡è°ƒç”¨çš„ä¹‹å‰ã€‚ ç‚¹å‡»äº‹ä»¶,æ‰€æœ‰çš„startActivityäº‹ä»¶éƒ½æ˜¯åœ¨ ä¸»çº¿ç¨‹é‡Œé¢æ‰§è¡Œçš„ å°±ç®—åœ¨è¿™ä¸ªforå¾ªç¯é‡Œé¢çš„è¿™æ®µæ—¶é—´é‡Œé¢æ”¶åˆ°äº†AMSå‘è¿‡æ¥çš„ClientTransaction,ä¹Ÿä¸èƒ½ç«‹å³å»æ‰§è¡Œ ç¬¬ä¸€æ¬¡å¯åŠ¨çš„activityAMSæŠ›å‡ºäº†onPauseçš„Messageï¼Œè€Œåé¢æ²¡æœ‰æŠ›å‡º ç­‰è¿™ä¸ªforå¾ªç¯èµ°å®Œä¹‹åï¼Œå†å»å¤„ç†ClientTransaction æ¶ˆæ¯ï¼Œå»æ‰§è¡Œå½“å‰activityçš„onPauseå›è°ƒæ–¹æ³•ï¼Œæ˜¯æœ€åå›ä¸€ä¸ªæ¶ˆæ¯ç»™AMS AMSæ”¶åˆ°æ¶ˆæ¯ä¹‹åï¼Œä»TaskRecordçš„æ ˆé¡¶å–å‡ºActivityRecordï¼Œæ‰§è¡Œå®ƒçš„ç”Ÿå‘½å‘¨æœŸæ–¹æ³•ï¼Œæ¯”å¦‚onCreate è¿™æ ·æˆ‘ä»¬é¡µé¢å±•ç¤ºçš„å°±æ˜¯æœ€åä¸€æ¬¡çš„Activity å½“ä½ ç•™å¤Ÿäº†æ—¶é—´?1234for (int i = 0; i &lt; 4; i++) { startActivity(new Intent(MainActivity.this, Main2Activity.class)); Thread.sleep(1000); } ä½ ä¼šå‘ç° ä¹‹å‰çš„ state=INITIALIZING å…¨éƒ¨å˜æˆäº†state=STOPPED ,ä¹Ÿå°±æ˜¯ä¸€èˆ¬çš„é¡µé¢è·³è½¬æƒ…å†µ 123456789101112131415161718192021 * Hist #4: ActivityRecord{1b0bee6 u0 com.test/.Main2Activity t40} state=RESUMED stopped=false delayedResume=false finishing=false * Hist #3: ActivityRecord{77e243c u0 com.test/.Main2Activity t40} state=STOPPED stopped=true delayedResume=false finishing=false * Hist #2: ActivityRecord{3085c2 u0 com.test/.Main2Activity t40} state=STOPPED stopped=true delayedResume=false finishing=false * Hist #1: ActivityRecord{769b0f8 u0 com.test/.Main2Activity t40} state=STOPPED stopped=true delayedResume=false finishing=false * Hist #0: ActivityRecord{9808381 u0 com.test/.MainActivity t40} state=STOPPED stopped=true delayedResume=false finishing=falseRunning activities (most recent first): TaskRecord{557a2f7 #40 A=com.test U=0 StackId=15 sz=5} Run #4: ActivityRecord{1b0bee6 u0 com.test/.Main2Activity t40} Run #3: ActivityRecord{77e243c u0 com.test/.Main2Activity t40} Run #2: ActivityRecord{3085c2 u0 com.test/.Main2Activity t40} Run #1: ActivityRecord{769b0f8 u0 com.test/.Main2Activity t40} Run #0: ActivityRecord{9808381 u0 com.test/.MainActivity t40}mResumedActivity: ActivityRecord{1b0bee6 u0 com.test/.Main2Activity t40}mLastPausedActivity: ActivityRecord{77e243c u0 com.test/.Main2Activity t40} è€Œä¸”ä½ ä¼šå‘ç°ä¸»çº¿ç¨‹çš„æ¶ˆæ¯é˜Ÿåˆ—é‡Œé¢å·²ç»æ”¶åˆ°äº†å¾ˆå¤šä¸ªç”Ÿå‘½å‘¨æœŸçš„ClientTransactionå›è°ƒæ¶ˆæ¯ï¼Œä¸å†æ˜¯ä¹‹å‰çš„å°±åªæœ‰1ä¸ªäº† 123456789101112.535 Message 0: { when=-3s642ms what=159 obj=android.app.servertransaction.ClientTransaction@4962 target=android.app.ActivityThread$H }.539 Message 1: { when=-3s606ms what=159 obj=android.app.servertransaction.ClientTransaction@17b4bc5e target=android.app.ActivityThread$H }.540 Message 2: { when=-3s604ms what=6 target=android.view.ViewRootImpl$ViewRootHandler }.543 Message 3: { when=-3s123ms what=159 obj=android.app.servertransaction.ClientTransaction@efd342 target=android.app.ActivityThread$H }.543 Message 4: { when=-2s613ms what=159 obj=android.app.servertransaction.ClientTransaction@4962 target=android.app.ActivityThread$H }.543 Message 5: { when=-2s606ms what=159 obj=android.app.servertransaction.ClientTransaction@119702d7 target=android.app.ActivityThread$H }.543 Message 6: { when=-2s85ms what=159 obj=android.app.servertransaction.ClientTransaction@efd342 target=android.app.ActivityThread$H }.544 Message 7: { when=-1s573ms what=159 obj=android.app.servertransaction.ClientTransaction@4962 target=android.app.ActivityThread$H }.545 Message 8: { when=-1s567ms what=159 obj=android.app.servertransaction.ClientTransaction@a56cd5ac target=android.app.ActivityThread$H }.545 Message 9: { when=-1s44ms what=159 obj=android.app.servertransaction.ClientTransaction@efd342 target=android.app.ActivityThread$H }.546 Message 10: { when=-536ms what=159 obj=android.app.servertransaction.ClientTransaction@4962 target=android.app.ActivityThread$H }.546 Message 11: { when=-529ms what=159 obj=android.app.servertransaction.ClientTransaction@f1a0fa6d target=android.app.ActivityThread$H } è¿™æ ·ä¹‹å‰activityéƒ½æ˜¯èµ°äº†onCreateçš„æµç¨‹äº† æ€»ç»“ æˆ‘ä¹‹å‰ä»¥ä¸ºæƒ…å†µ å®é™…ç‚¹å‡»è¿”å›å‡ºç°çš„æƒ…å†µ ä¹‹å‰é”™è¯¯çš„ç†è§£å°†ActivityRecord ä¸ RunningActivity ä¸€ä¸€å¯¹åº”äº†ã€‚ ActivityRecordå¯¹åº”çš„Activity å¯èƒ½æ²¡æœ‰åŠæ—¶åˆ›å»º è¿”å›ä¸Šä¸€ä¸ªActivity,ä¸Šä¸€ä¸ªActivityçš„çŠ¶æ€å¯èƒ½æ˜¯INITIALIZING OnPause onStop é™„å½• è½¬è½½startActivityçš„æµç¨‹å›¾ (https://img-blog.csdn.net/20171121115636419?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQveXVuX2hlbg==/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast)","link":"/2020/06/05/Android/%E5%BF%AB%E9%80%9F%E7%82%B9%E5%87%BBStartActivity%E5%BC%95%E5%8F%91%E7%9A%84%E8%AF%AF%E4%BC%9A/"},{"title":"æ€ä¹ˆdebug wechat-release.apkï¼Ÿ","text":"debugæ˜¯æŒ‡åœ¨smailå±‚é¢ï¼Œç±»ä¼¼å­—èŠ‚ç å±‚é¢ã€‚ 1.å®‰è£…smailideaæ’ä»¶ä»æœ¬åœ°å®‰è£…ï¼Œmarketé‡Œé¢æœç´¢ä¸åˆ°ã€‚https://bitbucket.org/JesusFreke/smali/downloads/ 2. ä½¿ç”¨baksmail åç¼–è¯‘Apkjava -jar baksmail.jar d testapk.apk -o ./srcDir 3. å¯¼å…¥ASæ‰“å¼€AS ,é€‰æ‹©æ–°å»ºproject é€‰æ‹© new-&gt;import é€‰æ‹© ä¸Šé¢çš„srcDirï¼Œä¾æ¬¡é€‰æ‹©jdkï¼Œæœ€åé‚®ä»¶æ ‡è®°è·Ÿç›®å½•ä¸º Mark Director -&gt; Source rootç„¶åè®¾ç½®sdkï¼Œæœ€åå’Œæµ‹è¯•æ‰‹æœºçš„ç³»ç»Ÿç‰ˆæœ¬ä¸€è‡´ï¼šé¡¹ç›®ç›®å½•â€“&gt;å³é”®â€“&gt;Open ModuleSettingsï¼š æˆ‘ä»¬å¯ä»¥çœ‹åˆ°å·¥ç¨‹ç›®å½• 4.AS é…ç½®debugæ¥ä¸‹æ¥é…ç½®ï¼šRun/Debug Configurationsé‡Œé¢çš„é…ç½®æ–‡ä»¶ï¼šæ‰“å¼€åæˆ‘ä»¬ç‚¹å‡»ä¸Šé¢çš„+ç¬¦åˆï¼Œç„¶åé€‰æ‹©Remoteï¼Œæ·»åŠ ä¸€ä¸ªè¿œç¨‹è°ƒè¯•å¦‚ä¸‹å›¾ï¼šport åé¢å†è¯´ 6.å®‰è£…è¿è¡ŒAPK å¯åŠ¨æ–¹å¼å¯ä»¥é€‰æ‹© å¼€å‘è€…æ¨¡å¼é‡Œé¢ ç­‰å¾…åº”ç”¨è°ƒè¯• ä¹Ÿå¯ä»¥é€‰æ‹© adb shell am start -D -S -W åŒ…å/å¯åŠ¨ACTICITY ä¾‹å¦‚ adb shell am start -D -S -W com.tencent.mm/com.tencent.mm.ui.LauncherUI 7.DEBUGè·å–portçš„2ä¸­æ–¹å¼ ï¼Œåœ¨ASé‡Œé¢è®¾ç½®è¿™ä¸ªport ä½¿ç”¨ JDWP é¦–å…ˆé€šè¿‡ adb ps | grep æŸ¥çœ‹ è¿™ä¸ªapkçš„ pid ç«¯å£è½¬å‘ï¼ŒæŠŠå½“å‰ç”µè„‘çš„Aç«¯å£ ï¼Œè½¬å‘å¯¹æ¥åˆ°æ‰‹æœºçš„Bç«¯å£ã€‚JDWPçš„ç«¯å£é»˜è®¤å°±æ˜¯PIDï¼Œæ‰€ä»¥éœ€è¦æŸ¥çœ‹PID adb forward tcp:8080 jdwp:pid ä½¿ç”¨DDMS æ‰“å¼€DDMSï¼Œé‡åˆ°ç«¯å£é—®é¢˜ï¼Œå…ˆadb kill-server å’Œ adb start-server é‡å¯ä¸€ä¸‹adb é€‰æ‹©ç›®æ ‡APKï¼Œç‚¹å‡» ä¼šå‡ºç° æœ€åä¸€åˆ— ä¼šå‡ºç° 8080/8700 ï¼Œå°±æ˜¯è¦å¡«8080,ä¸æ˜¯å¡«8700 åœ¨AS ä¸­ç‚¹å‡» debugï¼ŒDDMS é€‰ä¸­çš„è¿›ç¨‹ ä¼šå‡ºç°ç»¿è‰²çš„bugå›¾æ ‡ ç‚¹å‡»debug ç†Ÿæ‚‰çš„ç•Œé¢8 å…¶å®ƒ ç¡®ä¿app æ˜¯ debug enableçš„ï¼Œè‹¥ä¸æ˜¯ï¼Œå¯ä»¥ ä¿®æ”¹APKåé‡æ–°ç­¾åæ‰“åŒ… ä¹Ÿå¯ä»¥ç»™æ‰‹æœºæˆ–æ¨¡æ‹Ÿå™¨ç¼–è¯‘ä¸€ä¸ªdebugçš„rom","link":"/2020/05/07/Android/%E6%80%8E%E4%B9%88debugrelase%E5%8C%85smail/"},{"title":"JavaæŒ‡ä»¤é‡æ’","text":"1234567891011121314151617181920212223public class Main{ static boolean mark = true; public static void main(String[] args) throws InterruptedException { run(); /*åŠ ä¸Šè¿™å¥ä¼šæ€ä¹ˆæ ·ï¼Ÿ*/ //Thread.sleep(100); mrak = false; System.out.println(\"main end\"); } static void run(){ new Thread(new Runnable() { @Override public void run() { int i = 0; while (mark){ //è¿™é‡Œå…·ä½“è¦åšä»€ä¹ˆä¹Ÿä¼šå½±å“åˆ°ç»“æœ i++; } } }).start(); }} 1.ä¸åŠ Thread.sleep(100)ç¨‹åºä¼šæ­£å¸¸ç»“æŸï¼Œå¤§å¤šæ•°æƒ…å†µä¸‹ï¼Œåœ¨å¯åŠ¨æ–°çº¿ç¨‹çš„æ—¶å€™ï¼Œä¸»çº¿ç¨‹åé¢çš„ä¼šè·å¾—æ‰§è¡Œã€‚ 1234567public void run() { int i = 0; while (run){ System.out.println(\"new thread start\"); i++; } } é€šè¿‡éªŒè¯å‘ç°ï¼Œ System.out.println(â€œnew thread startâ€) å¹¶ä¸ä¼šè¾“å‡ºã€‚ 2.åŠ Thread.sleep(100)å¥‡æ€ªçš„ç°è±¡å‘ç”Ÿäº†ã€‚è¿™æ—¶å€™ï¼Œæ–°å¼€çš„çº¿ç¨‹ä¸ä¼šç»“æŸã€‚whyï¼Ÿç¼–è¯‘çš„è¿‡ç¨‹æœ‰ å…¶ä¸­ä¸­é—´ä»£ç æ˜¯å’Œå¹³å°æ— å…³çš„ï¼Œç¼–è¯‘å™¨åœ¨ä¸­é—´ä»£ç åé¢å¯ä»¥è¿›è¡Œä¸€äº›å’Œå¹³å°æ— å…³çš„ä»£ç ä¼˜åŒ–ï¼Œåœ¨ç›®æ ‡ä»£ç ç”Ÿæˆçš„æ—¶å€™ï¼Œç¼–è¯‘å™¨å½“ç„¶ä¹Ÿå¯ä»¥æ ¹æ®ç›®æ ‡å¹³å°æ”¯æŒçš„ç‰¹æ€§è¿›è¡Œä¼˜åŒ–ï¼Œå¸¸è§çš„æŒ‡ä»¤é‡æ’å¯ä»¥æ˜¯CPUæµæ°´çº¿ä¼˜åŒ–ï¼ŒIOé‡æ’ç­‰ã€‚å½“ç„¶JVMä¹Ÿä¼šå¯¹ä½ å†™çš„ä»£ç è¿›è¡Œä¸€äº›ä¼˜åŒ–ï¼Œå‘ç”Ÿåœ¨ç¼–è¯‘é˜¶æ®µå’Œè¿è¡Œé˜¶æ®µéƒ½æœ‰å¯èƒ½ã€‚ ä¸»è¦è¿˜æ˜¯ç¼–è¯‘å™¨ä»¥åŠCPUä¸ºäº†ä¼˜åŒ–ä»£ç æˆ–è€…æ‰§è¡Œçš„æ•ˆç‡è€Œæ‰§è¡Œçš„ä¼˜åŒ–æ“ä½œï¼›åº”ç”¨æ¡ä»¶æ˜¯å•çº¿ç¨‹åœºæ™¯ä¸‹ï¼Œå¯¹äºå¹¶å‘å¤šçº¿ç¨‹åœºæ™¯ä¸‹ï¼ŒæŒ‡ä»¤é‡æ’ä¼šäº§ç”Ÿä¸ç¡®å®šçš„æ‰§è¡Œæ•ˆæœ(åŸæ–‡é“¾æ¥https://blog.csdn.net/blueheart20/article/details/52117761[é“¾æ¥](https://blog.csdn.net/blueheart20/article/details/52117761)) 3 å¦‚ä½•é˜²æ­¢æŒ‡ä»¤é‡æ’?volatileå…³é”®å­—å¯ä»¥ä¿è¯å˜é‡çš„å¯è§æ€§ï¼Œå› ä¸ºå¯¹volatileçš„æ“ä½œéƒ½åœ¨Main Memoryä¸­ï¼Œè€ŒMain Memoryæ˜¯è¢«æ‰€æœ‰çº¿ç¨‹æ‰€å…±äº«çš„ï¼Œè¿™é‡Œçš„ä»£ä»·å°±æ˜¯ç‰ºç‰²äº†æ€§èƒ½ï¼Œæ— æ³•åˆ©ç”¨å¯„å­˜å™¨æˆ–Cacheï¼Œå› ä¸ºå®ƒä»¬éƒ½ä¸æ˜¯å…¨å±€çš„ï¼Œæ— æ³•ä¿è¯å¯è§æ€§ï¼Œå¯èƒ½äº§ç”Ÿè„è¯»ã€‚ volatileè¿˜æœ‰ä¸€ä¸ªä½œç”¨å°±æ˜¯å±€éƒ¨é˜»æ­¢é‡æ’åºçš„å‘ç”Ÿï¼Œå¯¹volatileå˜é‡çš„æ“ä½œæŒ‡ä»¤éƒ½ä¸ä¼šè¢«é‡æ’åºï¼Œå› ä¸ºå¦‚æœé‡æ’åºï¼Œåˆå¯èƒ½äº§ç”Ÿå¯è§æ€§é—®é¢˜ã€‚ åœ¨ä¿è¯å¯è§æ€§æ–¹é¢ï¼Œé”ï¼ˆåŒ…æ‹¬æ˜¾å¼é”ã€å¯¹è±¡é”ï¼‰ä»¥åŠå¯¹åŸå­å˜é‡çš„è¯»å†™éƒ½å¯ä»¥ç¡®ä¿å˜é‡çš„å¯è§æ€§ã€‚ä½†æ˜¯å®ç°æ–¹å¼ç•¥æœ‰ä¸åŒï¼Œä¾‹å¦‚åŒæ­¥é”ä¿è¯å¾—åˆ°é”æ—¶ä»å†…å­˜é‡Œé‡æ–°è¯»å…¥æ•°æ®åˆ·æ–°ç¼“å­˜ï¼Œé‡Šæ”¾é”æ—¶å°†æ•°æ®å†™å›å†…å­˜ä»¥ä¿æ•°æ®å¯è§ï¼Œè€Œvolatileå˜é‡å¹²è„†éƒ½æ˜¯è¯»å†™å†…å­˜ã€‚(åŸæ–‡é“¾æ¥ï¼šhttps://blog.csdn.net/blueheart20/article/details/52117761[é“¾æ¥](https://blog.csdn.net/blueheart20/article/details/52117761)) 12// åœ¨runæ–¹æ³•é‡Œé¢è¿›è¡Œè·¨å¯¹è±¡è®¿é—®ã€‚ä¹Ÿä¼šé¿å…å½“å‰è¿™ä¸ªä¼˜åŒ–static volatile boolean run = true;","link":"/2019/09/27/Java/Java%E6%8C%87%E4%BB%A4%E9%87%8D%E6%8E%92/"},{"title":"Javaçš„å¤šæ€æ–¹æ³•çš„ä¸é™æ€ä¸åŠ¨æ€åˆ†æ´¾","text":"å‰è¨€ å¤šæ€ï¼šä¸€ä¸ªå¯¹è±¡å˜é‡å¯ä»¥å¼•ç”¨å¤šä¸ªå®é™…å¯¹è±¡ åŠ¨æ€ç»‘å®šï¼šç¨‹åºè¿è¡Œè‡ªåŠ¨é€‰æ‹©è°ƒç”¨é‚£ä¸ªå¯¹è±¡çš„æ–¹æ³• 1 å…ˆçœ‹C++ 1234567891011121314151617181920#include using namespace std;class Person{public:int x=1,y=1;void Show() { cout &lt;&lt; \"I am a Person \" &lt;&lt;x&lt;&lt;y&lt;&lt; endl;}};class Student:public Person{public:void Show() { cout &lt;&lt; \"I am a Student \" &lt;&lt;x&lt;&lt;y&lt;&lt; endl;}};int main(){ Student s0; Person p0=s0; p0.Show(); s0.Show(); return 0;} è¿è¡Œç»“æœ 12I am a Person 11I am a Student 11 2.å†çœ‹Java 123456789101112131415161718192021class Person{public void Show(){ System.out.println(\"I am a Person\");}}class Student extends Person{public void Show(){ System.out.println(\"I am a Student\");}}public class Main{public static void main(String arg[]){ Student s0=new Student(); Person p0=s0; p0.Show(); s0.Show();}} è¿è¡Œç»“æœ 12I am a StudentI am a Student 3.åˆ†æåŸå› Javaä¸Cçš„ç»‘å®šä¸åŒã€‚Javaä¸­åªæœ‰finalã€staticã€privateå’Œæ„é€ æ–¹æ³•æ˜¯é™æ€ç»‘å®šçš„ï¼Œå…¶å®ƒæ‰€æœ‰æ–¹æ³•éƒ½é‡‡ç”¨åŠ¨æ€ç»‘å®šï¼Œè€ŒC++åªæœ‰è™šå‡½æ•°è¿›è¡Œçš„æ˜¯åŠ¨æ€ç»‘å®šã€‚æ‰€ä»¥åœ¨C++ä¸­ï¼Œp0.Show()æ‰ç”¨é™æ€ç»‘å®šçš„Show()ï¼Œå°½ç®¡æŒ‡å‘çš„æ˜¯Studentã€‚è€ŒJavaåˆ™æ˜¯åŠ¨æ€ç»‘å®šï¼Œå› ä¸ºæœ‰JVMï¼ŒJVMä¼šè°ƒç”¨å˜é‡å®é™…æŒ‡å‘çš„å¯¹è±¡çš„æ–¹æ³•ã€‚p0å®é™…æ˜¯æŒ‡å‘s0çš„ï¼Œæ‰€ä»¥ä¼šè°ƒç”¨s0çš„Show()ã€‚ ä»javaçš„å­—èŠ‚ç è§’åº¦å‡ºå‘ï¼Œæœ‰5ç§è°ƒç”¨æŒ‡ä»¤ invokeinterface: è°ƒç”¨æ¥å£ä¸­çš„æ–¹æ³•ï¼Œå®é™…ä¸Šæ˜¯åœ¨è¿è¡ŒæœŸå†³å®šå®é™…å®ç°è¯¥æ¥å£çš„å“ªä¸€ä¸ªå¯¹è±¡ invokestatic è°ƒç”¨é™æ€æ–¹æ³• invokespecial è°ƒç”¨å®é™…çš„ç§æœ‰æ–¹æ³•ï¼Œæ„é€ æ–¹æ³• invokevirtual è°ƒç”¨è™šæ–¹æ³• è¿è¡ŒæœŸé—´åŠ¨æ€æŸ¥æ‰¾çš„è¿‡ç¨‹ invokedynamic åŠ¨æ€è°ƒç”¨ æ–¹æ³•é‡è½½æ—¶ä¸€ç§é™æ€ç±»å‹ï¼Œè°ƒç”¨çš„æ—¶å€™å°±æ˜¯å£°æ˜çš„ç±»å‹ï¼Œç¼–è¯‘æ—¶å¯ä»¥ç¡®å®šã€‚ æ–¹æ³•é‡å†™æ˜¯ä¸€ç§åŠ¨æ€ç±»å‹ï¼Œæ˜¯å®é™…è°ƒç”¨çš„æ—¶å€™ï¼Œæ‰çŸ¥é“çš„ã€‚éœ€è¦è¿è¡Œæ—¶ç¡®å®šã€‚ è™šæ‹Ÿæœºä¸€å®šè°ƒç”¨å¼•ç”¨å¯¹è±¡çš„â€å®é™…ç±»â€œçš„æœ€é€‚åˆçš„æ–¹æ³•ã€‚è™šæ‹Ÿæœºé¢„å…ˆä¸ºæ¯ä¸€ä¸ªç±»åˆ›å»ºä¸€ä¸ª æ–¹æ³•è¡¨ï¼Œåœ¨è¿è¡Œæ—¶ï¼Œè™šæ‹Ÿæœºä¼šæŸ¥è¿™ä¸ªè¡¨ã€‚é¦–å…ˆé€‚é…å®é™…ç±»çš„æ–¹æ³•ï¼Œå¦åˆ™åœ¨è¶…ç±»ä¸­ç»§ç»­å¯»æ‰¾ï¼Œä»¥æ­¤ç±»æ¨ã€‚ å­—èŠ‚ç å¸¦æ¥çš„ç–‘æƒ‘ï¼Ÿ INVOKEVIRTUAL Person.Show ()V //â€”è¿™é‡Œæ˜æ˜æ˜¾ç¤ºçš„æ˜¯è°ƒç”¨Person.Showæ€ä¹ˆè°ƒç”¨æœ‰åˆ° Student.Show 123456789101112131415161718192021222324252627282930// access flags 0x9 public static main([Ljava/lang/String;)V L0 LINENUMBER 15 L0 NEW Student DUP INVOKESPECIAL Student.&lt;init&gt; ()V ASTORE 1 L1 LINENUMBER 16 L1 ALOAD 1 ASTORE 2 L2 LINENUMBER 17 L2 ALOAD 2 INVOKEVIRTUAL Person.Show ()V //---è¿™é‡Œæ˜æ˜æ˜¾ç¤ºçš„æ˜¯è°ƒç”¨Person.Showæ€ä¹ˆè°ƒç”¨æœ‰åˆ° Student.Show L3 LINENUMBER 18 L3 ALOAD 1 INVOKEVIRTUAL Student.Show ()V L4 LINENUMBER 19 L4 RETURN L5 LOCALVARIABLE arg [Ljava/lang/String; L0 L5 0 LOCALVARIABLE s0 LStudent; L1 L5 1 LOCALVARIABLE p0 LPerson; L2 L5 2 MAXSTACK = 2 MAXLOCALS = 3} è¿™ä¸ªå°±æ¶‰åŠåˆ°åŸç†INVOKEVIRTUALäº† INVOKEVIRTUAL é¦–å…ˆå»æ‰¾åœ¨æ“ä½œæ•°çš„æ ˆé¡¶çš„å®é™…æŒ‡å‘çš„é‚£ä¸ªå¯¹è±¡çš„å®é™…ç±»å‹ï¼Œå¯»æ‰¾åˆ°æè¿°å’Œè®¿é—®æƒé™éƒ½ç¬¦åˆï¼Œåˆ™ç›´æ¥è¿”å›è¿™ä¸ªæ–¹æ³•çš„ç›´æ¥å¼•ç”¨ã€‚ å¦‚æœæ‰¾ä¸åˆ°ï¼Œç„¶åå»æ‰¾çˆ¶ç±» å†æ‰¾ä¸åˆ°ï¼ŒæŠ›å¼‚å¸¸ è¿™æ ·ä¾æ¬¡å»æ‰¾ä¼šä¸ä¼šå¾ˆæ…¢ï¼Ÿ JVMä¼šä¼˜åŒ–ï¼Œç”Ÿæˆä¸€ä¸ªå«vtableçš„æ–¹æ³•è¡¨ã€‚ é€šè¿‡vtableä»£æ›¿å®é™…æŸ¥æ‰¾ã€‚","link":"/2019/05/31/Java/Java%E7%9A%84%E5%A4%9A%E6%80%81%E6%96%B9%E6%B3%95%E7%9A%84%E4%B8%8E%E9%9D%99%E6%80%81%E4%B8%8E%E5%8A%A8%E6%80%81%E5%88%86%E6%B4%BE/"},{"title":"JavaæŸ¥çœ‹å¯¹è±¡çš„å¤§å°","text":"1.JOL 12345&lt;dependency&gt; &lt;groupId&gt;org.openjdk.jol&lt;/groupId&gt; &lt;artifactId&gt;jol-core&lt;/artifactId&gt; &lt;version&gt;0.9&lt;/version&gt; &lt;/dependency&gt; 123456//æŸ¥çœ‹å¯¹è±¡å†…éƒ¨ä¿¡æ¯ print(ClassLayout.parseInstance(obj).toPrintable()); //æŸ¥çœ‹å¯¹è±¡å¤–éƒ¨ä¿¡æ¯ print(GraphLayout.parseInstance(obj).toPrintable()); //è·å–å¯¹è±¡æ€»å¤§å° print(\"size : \" + GraphLayout.parseInstance(obj).totalSize()); 2. luceneæä¾›çš„ä¸“é—¨ç”¨äºè®¡ç®—å †å†…å­˜å ç”¨å¤§å°çš„å·¥å…·ç±»ï¼šRamUsageEstimatorï¼Œmavenåæ ‡ï¼š12345&lt;dependency&gt; &lt;groupId&gt;org.apache.lucene&lt;/groupId&gt; &lt;artifactId&gt;lucene-core&lt;/artifactId&gt; &lt;version&gt;4.0.0&lt;/version&gt;&lt;/dependency&gt; å¸¸ç”¨çš„æ–¹æ³• 123456789//è®¡ç®—æŒ‡å®šå¯¹è±¡åŠå…¶å¼•ç”¨æ ‘ä¸Šçš„æ‰€æœ‰å¯¹è±¡çš„ç»¼åˆå¤§å°ï¼Œå•ä½å­—èŠ‚long RamUsageEstimator.sizeOf(Object obj)//è®¡ç®—æŒ‡å®šå¯¹è±¡æœ¬èº«åœ¨å †ç©ºé—´çš„å¤§å°ï¼Œå•ä½å­—èŠ‚long RamUsageEstimator.shallowSizeOf(Object obj)//è®¡ç®—æŒ‡å®šå¯¹è±¡åŠå…¶å¼•ç”¨æ ‘ä¸Šçš„æ‰€æœ‰å¯¹è±¡çš„ç»¼åˆå¤§å°ï¼Œè¿”å›å¯è¯»çš„ç»“æœï¼Œå¦‚ï¼š2KBString RamUsageEstimator.humanSizeOf(Object obj) 12345public static void main(String[] args) { final byte[] sLock = new byte[0]; System.out.println(RamUsageEstimator.sizeOf(new Object())); System.out.println(RamUsageEstimator.sizeOf(sLock)); } é»˜è®¤å¼€å¯æŒ‡é’ˆå‹ç¼© -XX:+UseCompressedOops 121616 å…³é—­æŒ‡é’ˆå‹ç¼© -XX:- UseCompressedOops 121624 ç®€å•å¥½ç”¨ï¼Œé”çš„è¯å°±ç”¨new Object() 3.å…³é—­æŒ‡é’ˆå‹ç¼©ä¸ºä»€ä¹ˆå¤§äº†8ä¸ªå­—èŠ‚ï¼Ÿå¤§äº†4ä¸ªå­—èŠ‚ï¼ŒåŠ ä¸Šè¦å†…å­˜å¯¹é½8ä¸ªå­—èŠ‚ã€‚1234567891011121314151617181920212223242526272829303132333435363738394041object----------------------------------------------æŸ¥çœ‹å¯¹è±¡å†…éƒ¨ä¿¡æ¯java.lang.Object object internals: OFFSET SIZE TYPE DESCRIPTION VALUE 0 4 (object header) 01 00 00 00 (00000001 00000000 00000000 00000000) (1) 4 4 (object header) 00 00 00 00 (00000000 00000000 00000000 00000000) (0) 8 4 (object header) 00 1c c3 1c (00000000 00011100 11000011 00011100) (482548736) 12 4 (object header) 00 00 00 00 (00000000 00000000 00000000 00000000) (0)Instance size: 16 bytesSpace losses: 0 bytes internal + 0 bytes external = 0 bytes totalæŸ¥çœ‹å¯¹è±¡å¤–éƒ¨ä¿¡æ¯java.lang.Object@aec6354d object externals: ADDRESS SIZE TYPE PATH VALUE 1288d8b18 16 java.lang.Object (object)è·å–å¯¹è±¡æ€»å¤§å°size : 16sLock----------------------------------------------æŸ¥çœ‹å¯¹è±¡å†…éƒ¨ä¿¡æ¯[B object internals: OFFSET SIZE TYPE DESCRIPTION VALUE 0 4 (object header) 01 00 00 00 (00000001 00000000 00000000 00000000) (1) 4 4 (object header) 00 00 00 00 (00000000 00000000 00000000 00000000) (0) 8 4 (object header) a8 07 c3 1c (10101000 00000111 11000011 00011100) (482543528) 12 4 (object header) 00 00 00 00 (00000000 00000000 00000000 00000000) (0) 16 4 (object header) 00 00 00 00 (00000000 00000000 00000000 00000000) (0) 20 4 (alignment/padding gap) 24 0 byte [B.&lt;elements&gt; N/AInstance size: 24 bytesSpace losses: 4 bytes internal + 0 bytes external = 4 bytes totalæŸ¥çœ‹å¯¹è±¡å¤–éƒ¨ä¿¡æ¯[B@41975e01d object externals: ADDRESS SIZE TYPE PATH VALUE 1288d8b00 24 [B []è·å–å¯¹è±¡æ€»å¤§å°size : 24 å¼€å¯æŒ‡é’ˆå‹ç¼© 1234567891011121314151617181920212223242526272829303132333435363738394041object----------------------------------------------æŸ¥çœ‹å¯¹è±¡å†…éƒ¨ä¿¡æ¯java.lang.Object object internals: OFFSET SIZE TYPE DESCRIPTION VALUE 0 4 (object header) 01 00 00 00 (00000001 00000000 00000000 00000000) (1) 4 4 (object header) 00 00 00 00 (00000000 00000000 00000000 00000000) (0) 8 4 (object header) e5 01 00 f8 (11100101 00000001 00000000 11111000) (-134217243) 12 4 (loss due to the next object alignment)Instance size: 16 bytesSpace losses: 0 bytes internal + 4 bytes external = 4 bytes totalæŸ¥çœ‹å¯¹è±¡å¤–éƒ¨ä¿¡æ¯java.lang.Object@aec6354d object externals: ADDRESS SIZE TYPE PATH VALUE 76be9bd30 16 java.lang.Object (object)è·å–å¯¹è±¡æ€»å¤§å°size : 16sLock----------------------------------------------æŸ¥çœ‹å¯¹è±¡å†…éƒ¨ä¿¡æ¯[B object internals: OFFSET SIZE TYPE DESCRIPTION VALUE 0 4 (object header) 01 00 00 00 (00000001 00000000 00000000 00000000) (1) 4 4 (object header) 00 00 00 00 (00000000 00000000 00000000 00000000) (0) 8 4 (object header) f5 00 00 f8 (11110101 00000000 00000000 11111000) (-134217483) 12 4 (object header) 00 00 00 00 (00000000 00000000 00000000 00000000) (0) 16 0 byte [B.&lt;elements&gt; N/AInstance size: 16 bytesSpace losses: 0 bytes internal + 0 bytes external = 0 bytes totalæŸ¥çœ‹å¯¹è±¡å¤–éƒ¨ä¿¡æ¯[B@41975e01d object externals: ADDRESS SIZE TYPE PATH VALUE 76be9bd20 16 [B []è·å–å¯¹è±¡æ€»å¤§å°size : 16Process finished with exit code 0 4. ä¸ºä»€ä¹ˆobject header ä¼šæœ‰ 20 ä¸ªå­—èŠ‚å‘¢ï¼Ÿä¸ç®¡æ˜¯å¦å¼€å¯æŒ‡é’ˆå‹ç¼©ï¼Œæ•°ç»„å¼•ç”¨ç±»å‹è¦å¤šä¸€ä¸ª 4ä¸ªå­—èŠ‚çš„é•¿åº¦ çš„æ ‡è®°ã€‚ 1Object object = new Object[0x0FFFFFFF]; éªŒè¯ 12345678910111213object----------------------------------------------æŸ¥çœ‹å¯¹è±¡å†…éƒ¨ä¿¡æ¯[Ljava.lang.Object; object internals: OFFSET SIZE TYPE DESCRIPTION VALUE 0 4 (object header) 01 00 00 00 (00000001 00000000 00000000 00000000) (1) 4 4 (object header) 00 00 00 00 (00000000 00000000 00000000 00000000) (0) 8 4 (object header) 38 cb 6c 1c (00111000 11001011 01101100 00011100) (476891960) 12 4 (object header) 00 00 00 00 (00000000 00000000 00000000 00000000) (0) 16 4 (object header) ff ff ff 0f (11111111 11111111 11111111 00001111) (268435455) 20 4 (alignment/padding gap) 24 2147483640 java.lang.Object Object;.&lt;elements&gt; N/AInstance size: 2147483664 bytesSpace losses: 4 bytes internal + 0 bytes external = 4 bytes total é‚£æˆ‘è¦æ˜¯ç›´æ¥å£°æ˜ä¸€ä¸ª é•¿æ•´å‹ [long]çš„å‘¢ï¼Ÿå¯¹ä¸èµ·ï¼Œä¸æ”¯æŒï¼ ä¸ºä»€ä¹ˆï¼Ÿï¼Ÿï¼Ÿ Java ä¸­æ•°ç»„çš„æœ€å¤§é•¿åº¦æ˜¯å¤šå°‘å‘¢ï¼Ÿçœ‹ä¸€ä¸‹å®ƒçš„lengthå±æ€§å°±å¯ä»¥äº†ã€‚lengthå±æ€§æ˜¯32ä½çš„æœ‰ç¬¦å·æ•´æ•°ï¼Œå®ƒçš„æœ€å¤§å€¼æ˜¯2çš„31æ¬¡å¹‚ï¼Œå°±æ˜¯2Gã€‚ä¸ºä½•æœ‰è¿™ä¸ªé™åˆ¶å‘¢ï¼Ÿä¸ºä»€ä¹ˆlengthçš„å±æ€§ä¸æ˜¯longå‹å‘¢ï¼Ÿæˆ‘ä»¬å‡è®¾ä¸€ä¸‹ï¼Œå¦‚æœå®ƒæ˜¯longå‹çš„ï¼Œé‚£ä¹ˆå®ƒçš„æœ€å¤§é•¿åº¦æ˜¯2çš„63æ¬¡å¹‚ã€‚å†…å­˜æ°¸è¿œä¹Ÿä¸ä¼šæœ‰é‚£ä¹ˆå¤§å§ã€‚å³ä½¿æ˜¯å­—èŠ‚æ•°ç»„é•¿åº¦æ˜¯intçš„ï¼Œæœ€å¤§é•¿éƒ½è¾¾åˆ°2GB. ç”±æ­¤æƒ³åˆ°äº†Stringï¼Œè¿™ä¸ªå®¶ä¼™åº•å±‚ä¹Ÿæ˜¯åŸºäºæ•°ç»„çš„ï¼Œæ˜¯ä¸€ä¸ªå­—ç¬¦æ•°ç»„ã€‚å­—ç¬¦æ˜¯16ä½çš„åŸºæœ¬ç±»å‹,ä¸€ä¸ªStringçš„æœ€å¤§é•¿åº¦æ˜¯å¤šå°‘å‘¢ï¼Ÿå°±æ˜¯å­—ç¬¦æ•°ç»„çš„æœ€å¤§é•¿åº¦ä¹Ÿæ˜¯2Gï¼Œå ç”¨å†…å­˜æ˜¯4GBã€‚ ä»JVMçš„è§’åº¦æ¥è§£é‡Šï¼šåˆ›å»ºæ•°ç»„çš„å­—èŠ‚ç æ˜¯anewarrayå’Œnewarrayï¼Œæ“ä½œæ•°æ ˆçš„å­—å®½æ˜¯32ä½ï¼Œè€Œè¿™ä¸¤ä¸ªå­—èŠ‚ç çš„å‚æ•°éƒ½æ˜¯ä¸€ä¸ªå­—é•¿ï¼Œæ‰€ä»¥æ— æ³•æ¥å—longå‹çš„é•¿åº¦å‚æ•°ã€‚ä¸çŸ¥é“è¿™æ ·è§£é‡Šæ˜¯å¦å¾ˆç‰µå¼ºã€‚","link":"/2019/12/14/Java/Java%E6%9F%A5%E7%9C%8B%E5%AF%B9%E8%B1%A1%E7%9A%84%E5%A4%A7%E5%B0%8F/"},{"title":"Macä¸‹æ€ä¹ˆç”¨Clion debug openJdk8?","text":"è¿˜è®°å¾—å‰é¢ç¼–è¯‘è¿˜äº†çš„java - v æœ‰ä¸ªé”™è¯¯ï¼Œæˆ‘ä»¬æ¥è¯•ä¸€ä¸‹ç”¨Clion debugä¸€ä¸‹ 1.æ‰“å¼€Clion ï¼Œå¯¼å…¥é¡¹ç›®æ‰“å¼€ clionï¼Œé€‰æ‹© File-&gt;ImportProjectï¼Œé€‰æ‹©åˆ° ../openjdk-8/hotspot ç›®å½•ã€‚ 2.é…ç½®Runå¯¼å…¥æˆåŠŸä»¥åï¼Œä¼šå‡ºç°ä¸€ä¸ªé»˜è®¤çš„Runï¼Œä¿®æ”¹æ‰Run é‡Œé¢çš„é…ç½®ï¼Œå»æ‰buildï¼Œæˆ‘ä»¬ä¸éœ€è¦buildã€‚Target ä¸ç”¨å˜ï¼ŒExecutableéœ€è¦æ”¹æˆæˆ‘ä»¬è‡ªå·±ç¼–è¯‘çš„./bin/javaã€‚clion å¯¼å…¥æºç ä¹‹åé‡åˆ°å¤´æ–‡ä»¶æ‰¾ä¸åˆ°çš„é—®é¢˜ï¼Œå¯ä»¥åœ¨ CMakeLists.txt é‡Œé¢æ·»åŠ ä¸€äº›æ ¹è·¯å¾„ï¼Œ å¯ä»¥åœ¨CMakeLists.txté‡Œé¢æ·»åŠ ï¼Œè¿˜æœ‰ä¸å­˜åœ¨çš„å¤´æ–‡ä»¶ï¼Œå¯ä»¥ç›´æ¥æ·»åŠ åˆ°src/share/vm/precompiled/precompiled.hppï¼Œä»é‡Œé¢æ‰¾ CMakeLists 1234include_directories(./src/share/vm)include_directories(./src/cpu/x86/vm)include_directories(./src/share/vm/precompiled)include_directories(./src/share/vm/utilities) src/share/vm/precompiled/precompiled.hpp 12345678# include &lt;cstdlib&gt;# include &lt;cstdint&gt;# include &lt;cstring&gt;# include \"register_x86.hpp\"# include \"assembler_x86.hpp\"# include \"globalDefinitions.hpp\"# include \"globalDefinitions_x86.hpp\"# include \"assembler_x86.hpp\" 3.é€‰æ‹©æ–­ç‚¹ï¼Œç‚¹å‡»debug å…ˆæ‰“å¼€core dump æŸ¥çœ‹è°ƒç”¨æ ˆ,ç¡®å®šæ–­ç‚¹123456789101112Stack: [0x00007000043c8000,0x00007000044c8000], sp=0x00007000044c7c70, free space=1023k Native frames: (J=compiled Java code, j=interpreted, Vv=VM code, C=native code) V [libjvm.dylib+0xa2e268] PerfData::~PerfData()+0x8 V [libjvm.dylib+0xa2ee3d] PerfDataManager::destroy()+0x6d V [libjvm.dylib+0xa313ed] perfMemory_exit()+0x3d V [libjvm.dylib+0x6718cd] exit_globals()+0x1d V [libjvm.dylib+0xb744bc] Threads::destroy_vm()+0x19c V [libjvm.dylib+0x740e62] jni_DestroyJavaVM+0x182 C [java+0x3abc] JavaMain+0x28c C [libsystem_pthread.dylib+0x3661] _pthread_body+0x154 C [libsystem_pthread.dylib+0x350d] _pthread_body+0x0 C [libsystem_pthread.dylib+0x2bf9] thread_start+0xd åˆšå¼€å§‹å¯èƒ½ä¼šå‡ºç° å¯ä»¥åœ¨ç‚¹å‡» LLDBï¼Œè¾“å…¥ process handle SIGSEGV --stop=false å³å¯ï¼Œè¿™é‡Œå‘Šè¯‰ç¼–è¯‘å™¨å¿½ç•¥é”™è¯¯ ç„¶åç‚¹å‡»resumeï¼Œç»¿è‰²çš„ä¸‰è§’ å‘½ä¸­æ–­ç‚¹ï¼Œå°±åé¢çš„æ­£å¸¸debug å¯çœ‹åˆ°è¿™ä¸ªå‡½æ•°æ‰§è¡Œéƒ½è¿™é‡Œå°±æ˜¯crashäº†ï¼Œæ‰€ä»¥ä¹‹å‰çš„ç¼–è¯‘é”™è¯¯ï¼Œå¯ä»¥å¿½ç•¥è¿™é‡Œçš„é”™è¯¯è¾¾åˆ°æ­£å¸¸ç»“æŸçš„ç›®çš„ã€‚ è¿™æ˜¯ä»€ä¹ˆé”™Exception: EXC_BAD_INSTRUCTION (code=EXC_I386_INVOP, subcode=0x0)ï¼Ÿ","link":"/2019/05/13/Java/Mac%E4%B8%8B%E6%80%8E%E4%B9%88%E7%94%A8CliondebugJVM/"},{"title":"Javaåˆ†æObject Header ä¿¡æ¯","text":"1.å¤´ä¿¡æ¯123class AAA{ private int number;} 1234567891011------------after invoke hascode()-----------------AAA object internals: OFFSET SIZE TYPE DESCRIPTION VALUE 0 4 (object header) 01 bc 37 0b (00000001 10111100 00110111 00001011) (188201985) 4 4 (object header) 7e 00 00 00 (01111110 00000000 00000000 00000000) (126) 8 4 (object header) a8 35 85 1c (10101000 00110101 10000101 00011100) (478492072) 12 4 (object header) 00 00 00 00 (00000000 00000000 00000000 00000000) (0) 16 4 int AAA.number 0 20 4 (loss due to the next object alignment)Instance size: 24 bytesSpace losses: 0 bytes internal + 4 bytes external = 4 bytes total å¯ä»¥çœ‹åˆ°åœ¨ 64ä½æœºä¸Šï¼Œå…³é—­å‹ç¼©ã€‚object header å 16 å­—èŠ‚ã€‚ä»¥4ä¸ªå­—èŠ‚æ–¹å¼å¯¹é½ã€‚å¼€å¯å‹ç¼©ï¼Œå®æµ‹å 12å­—èŠ‚ã€‚ HotSpot è™šæ‹Ÿæœºçš„å¯¹è±¡å¤´åŒ…æ‹¬ä¸¤éƒ¨åˆ†ä¿¡æ¯ï¼šMark Wordï¼ˆæ ‡è®°å­—æ®µï¼‰å’Œ Klass Pointerï¼ˆç±»å‹æŒ‡é’ˆï¼‰ 2.MarkWordMark Word ç”¨äºå­˜å‚¨å¯¹è±¡è‡ªèº«çš„è¿è¡Œæ—¶æ•°æ®ï¼Œå¦‚å“ˆå¸Œç ï¼ˆHashCodeï¼‰ã€GCåˆ†ä»£å¹´é¾„ã€é”çŠ¶æ€æ ‡å¿—ã€çº¿ç¨‹æŒæœ‰çš„é”ã€åå‘çº¿ç¨‹ IDã€åå‘æ—¶é—´æˆ³ç­‰ç­‰ã€‚JVM å¯¹è±¡å¤´ä¸€èˆ¬å ç”¨ä¸¤ä¸ªæœºå™¨ç ï¼Œåœ¨ 32-bit JVM ä¸Šå ç”¨ 64bitï¼Œ åœ¨ 64-bit JVM ä¸Šå ç”¨ 128bit å³ 16 bytesï¼ˆæš‚ä¸è€ƒè™‘å¼€å¯å‹ç¼©æŒ‡é’ˆçš„åœºæ™¯ï¼‰ã€‚å¦å¤–ï¼Œå¦‚æœå¯¹è±¡æ˜¯ä¸€ä¸ª Java æ•°ç»„ï¼Œé‚£åœ¨å¯¹è±¡å¤´ä¸­è¿˜å¿…é¡»æœ‰ä¸€å—ç”¨äºè®°å½•æ•°ç»„é•¿åº¦çš„æ•°æ®ï¼Œå› ä¸ºè™šæ‹Ÿæœºå¯ä»¥é€šè¿‡æ™®é€š Java å¯¹è±¡çš„å…ƒæ•°æ®ä¿¡æ¯ç¡®å®š Java å¯¹è±¡çš„å¤§å°ï¼Œä½†æ˜¯ä»æ•°ç»„çš„å…ƒæ•°æ®ä¸­æ— æ³•ç¡®å®šæ•°ç»„çš„å¤§å°ã€‚å¯¹è±¡éœ€è¦å­˜å‚¨çš„è¿è¡Œæ—¶æ•°æ®å¾ˆå¤šï¼Œå…¶å®å·²ç»è¶…å‡ºäº†32ã€64ä½ Bitmap ç»“æ„æ‰€èƒ½è®°å½•çš„é™åº¦ï¼Œä½†æ˜¯å¯¹è±¡å¤´ä¿¡æ¯æ˜¯ä¸å¯¹è±¡è‡ªèº«å®šä¹‰çš„æ•°æ®æ— å…³çš„é¢å¤–å­˜å‚¨æˆæœ¬ï¼Œè€ƒè™‘åˆ°è™šæ‹Ÿæœºçš„ç©ºé—´æ•ˆç‡ï¼ŒMark Word è¢«è®¾è®¡æˆä¸€ä¸ªéå›ºå®šçš„æ•°æ®ç»“æ„ä»¥ä¾¿åœ¨æå°çš„ç©ºé—´å†…å­˜å‚¨å°½é‡å¤šçš„ä¿¡æ¯ï¼Œå®ƒä¼šæ ¹æ®å¯¹è±¡çš„çŠ¶æ€å¤ç”¨è‡ªå·±çš„å­˜å‚¨ç©ºé—´ã€‚ä¾‹å¦‚åœ¨ 32 ä½çš„HotSpot è™šæ‹Ÿæœºä¸­å¯¹è±¡æœªè¢«é”å®šçš„çŠ¶æ€ä¸‹ï¼ŒMark Word çš„ 32ä¸ªBits ç©ºé—´ä¸­çš„ 25Bits ç”¨äºå­˜å‚¨å¯¹è±¡å“ˆå¸Œç ï¼ˆHashCodeï¼‰ï¼Œ4Bits ç”¨äºå­˜å‚¨å¯¹è±¡åˆ†ä»£å¹´é¾„ï¼Œ2Bits ç”¨äºå­˜å‚¨é”æ ‡å¿—ä½ï¼Œ1Bitå›ºå®šä¸º0ï¼Œåœ¨å…¶ä»–çŠ¶æ€ï¼ˆè½»é‡çº§é”å®šã€é‡é‡çº§é”å®šã€GCæ ‡è®°ã€å¯åå‘ï¼‰ä¸‹å¯¹è±¡çš„å­˜å‚¨å†…å®¹å¦‚ä¸‹è¡¨æ‰€ç¤ºã€‚ åŸæ–‡é“¾æ¥ï¼šhttps://blog.csdn.net/wenniuwuren/article/details/50939410 æ¥è‡ª https://gist.github.com/arturmkrtchyan/43d6135e8a15798cc46c 64ä½æœºã€‚å…³é—­å‹ç¼© å¤´éƒ¨ä¿¡æ¯ å„ä¸ªå­—æ®µå ä½123456789101112131415|------------------------------------------------------------------------------------------------------------|--------------------|| Object Header (128 bits) | State ||------------------------------------------------------------------------------|-----------------------------|--------------------|| Mark Word (64 bits) | Klass Word (64 bits) | ||------------------------------------------------------------------------------|-----------------------------|--------------------|| unused:25 | identity_hashcode:31 | unused:1 | age:4 | biased_lock:1 | lock:2 | OOP to metadata object | Normal ||------------------------------------------------------------------------------|-----------------------------|--------------------|| thread:54 | epoch:2 | unused:1 | age:4 | biased_lock:1 | lock:2 | OOP to metadata object | Biased ||------------------------------------------------------------------------------|-----------------------------|--------------------|| ptr_to_lock_record:62 | lock:2 | OOP to metadata object | Lightweight Locked ||------------------------------------------------------------------------------|-----------------------------|--------------------|| ptr_to_heavyweight_monitor:62 | lock:2 | OOP to metadata object | Heavyweight Locked ||------------------------------------------------------------------------------|-----------------------------|--------------------|| | lock:2 | OOP to metadata object | Marked for GC ||------------------------------------------------------------------------------|-----------------------------|--------------------| 64ä½æœºã€‚å¼€å¯å‹ç¼© å¤´éƒ¨ä¿¡æ¯ å„ä¸ªå­—æ®µå ä½123456789101112131415|--------------------------------------------------------------------------------------------------------------|--------------------|| Object Header (96 bits) | State ||--------------------------------------------------------------------------------|-----------------------------|--------------------|| Mark Word (64 bits) | Klass Word (32 bits) | ||--------------------------------------------------------------------------------|-----------------------------|--------------------|| unused:25 | identity_hashcode:31 | cms_free:1 | age:4 | biased_lock:1 | lock:2 | OOP to metadata object | Normal ||--------------------------------------------------------------------------------|-----------------------------|--------------------|| thread:54 | epoch:2 | cms_free:1 | age:4 | biased_lock:1 | lock:2 | OOP to metadata object | Biased ||--------------------------------------------------------------------------------|-----------------------------|--------------------|| ptr_to_lock_record | lock:2 | OOP to metadata object | Lightweight Locked ||--------------------------------------------------------------------------------|-----------------------------|--------------------|| ptr_to_heavyweight_monitor | lock:2 | OOP to metadata object | Heavyweight Locked ||--------------------------------------------------------------------------------|-----------------------------|--------------------|| | lock:2 | OOP to metadata object | Marked for GC ||--------------------------------------------------------------------------------|-----------------------------|--------------------| 3.Klass Pointerï¼Œå³æ˜¯å¯¹è±¡æŒ‡å‘å®ƒçš„ç±»å…ƒæ•°æ®çš„æŒ‡é’ˆï¼Œè™šæ‹Ÿæœºé€šè¿‡è¿™ä¸ªæŒ‡é’ˆæ¥ç¡®å®šè¿™ä¸ªå¯¹è±¡æ˜¯å“ªä¸ªç±»çš„å®ä¾‹ã€‚ 4.é€šè¿‡JOL éªŒè¯ å¤´éƒ¨å­—æ®µä¿¡æ¯ ã€‚å¹¶åˆ†æå­—æ®µä¿¡æ¯ã€‚12345601 bc 37 0b (00000001 10111100 00110111 00001011) (188201985)7e 00 00 00 (01111110 00000000 00000000 00000000) (126)a8 35 85 1c (10101000 00110101 10000101 00011100) (478492072)00 00 00 00 (00000000 00000000 00000000 00000000) (0) è¿›ä¸€æ­¥æ‹†åˆ†Mark Word (64 bits) ã€‚å¯¹æ¯”å„ä¸ªå­—æ®µã€‚ unused:25 | identity_hashcode:31 | unused:1 | age:4 | biased_lock:1 | lock:2 ç”±äºå¤§å°ç«¯çš„å…³ç³»ï¼Œæ‰“å° hashcodeå¯ä»¥çœ‹å‡ºæ˜¯å€’åºçš„ã€‚ 12 unused:25 | identity_hashcode:31 | unused:1 | age:4 | biased_lock:1 | lock:200000001 10111100 00110111 0|00010110 11111100 00000000 0000000 | 0 |0000 |0 | 00 çœ‹åˆ°ageæ˜¯4ä¸ªbitï¼Œå¥½åƒä¹Ÿå¯ä»¥è§£é‡Šä¸ºä»€ä¹ˆå¹´é¾„æœ€é«˜ä¸º15äº†ã€‚ ğŸ˜‚","link":"/2019/10/11/Java/ObjectHeader/"},{"title":"Macä¸‹ç¼–è¯‘OpenJdk8","text":"1.ä¸‹è½½å’Œè§£å‹æºç  æœ¬åœ°ç¯å¢ƒ OS version 10.13.6 ç½‘ä¸Šä¹Ÿæœ‰è¯´é€šè¿‡mercurialä¸‹è½½ï¼Œå¤ªæ…¢äº†ï¼Œå»http://jdk.java.net/ä¸‹è½½æºç åŒ…ç„¶åè§£å‹ã€‚ 2.é…ç½®ç¯å¢ƒæœ¬åœ°éœ€è¦ä¸€ä¸ªå¯ç”¨çš„JDKï¼Œç›´æ¥java -verisonå¯ç”¨å³å¯ï¼Œæœ€å¥½ç‰ˆæœ¬ä½äºç¼–è¯‘ç‰ˆæœ¬ 2.1 å®‰è£…ä¾èµ– å’Œé…ç½®ç¯å¢ƒ ç¼ºå°‘ä»€ä¹ˆå°±å°è¯•brew install ä¸€ä¸‹ ä¸»è¦ breaw install binutils freetype 123456If you need to have binutils first in your PATH run: echo 'export PATH=\"/usr/local/opt/binutils/bin:$PATH\"' &gt;&gt; ~/.zshrcFor compilers to find binutils you may need to set: export LDFLAGS=\"-L/usr/local/opt/binutils/lib\" export CPPFLAGS=\"-I/usr/local/opt/binutils/include\" è®¾ç½®ä»¥ä¸‹ç¯å¢ƒå˜é‡ï¼Œnewä¸€ä¸ªenv.sh12345678910111213141516171819202122232425262728293031323334353637383940# è®¾å®šè¯­è¨€é€‰é¡¹ï¼Œå¿…é¡»è®¾ç½®export LANG=C# Macå¹³å°ï¼ŒCç¼–è¯‘å™¨ä¸å†æ˜¯GCCï¼Œæ˜¯clangexport CC=clangexport CXX=clang++# è·³è¿‡clangçš„ä¸€äº›ä¸¥æ ¼çš„è¯­æ³•æ£€æŸ¥ï¼Œä¸ç„¶ä¼šå°†Nå¤šçš„è­¦å‘Šä½œä¸ºErrorexport COMPILER_WARNINGS_FATAL=false# é“¾æ¥æ—¶ä½¿ç”¨çš„å‚æ•°export LFLAGS='-Xlinker -lstdc++'# æ˜¯å¦ä½¿ç”¨clangexport USE_CLANG=true# ä½¿ç”¨64ä½æ•°æ®æ¨¡å‹export LP64=1# å‘Šè¯‰ç¼–è¯‘å¹³å°æ˜¯64ä½ï¼Œä¸ç„¶ä¼šæŒ‰32ä½æ¥ç¼–è¯‘export ARCH_DATA_MODEL=64# å…è®¸è‡ªåŠ¨ä¸‹è½½ä¾èµ–export ALLOW_DOWNLOADS=true# å¹¶è¡Œç¼–è¯‘çš„çº¿ç¨‹æ•°ï¼Œç¼–è¯‘æ—¶é—´é•¿ï¼Œä¸ºäº†ä¸å½±å“å…¶ä»–å·¥ä½œï¼Œæˆ‘é€‰æ‹©ä¸º2export HOTSPOT_BUILD_JOBS=2# æ˜¯å¦è·³è¿‡ä¸å…ˆå‰ç‰ˆæœ¬çš„æ¯”è¾ƒexport SKIP_COMPARE_IMAGES=true# æ˜¯å¦ä½¿ç”¨é¢„ç¼–è¯‘å¤´æ–‡ä»¶ï¼ŒåŠ å¿«ç¼–è¯‘é€Ÿåº¦export USE_PRECOMPILED_HEADER=true# æ˜¯å¦ä½¿ç”¨å¢é‡ç¼–è¯‘export INCREMENTAL_BUILD=true# ç¼–è¯‘å†…å®¹export BUILD_LANGTOOLS=trueexport BUILD_JAXP=trueexport BUILD_JAXWS=trueexport BUILD_CORBA=trueexport BUILD_HOTSPOT=trueexport BUILD_JDK=true# ç¼–è¯‘ç‰ˆæœ¬export SKIP_DEBUG_BUILD=trueexport SKIP_FASTDEBUG_BUILD=falseexport DEBUG_NAME=debug# é¿å¼€javawså’Œæµè§ˆå™¨Javaæ’ä»¶ä¹‹ç±»çš„éƒ¨åˆ†çš„buildexport BUILD_DEPLOY=falseexport BUILD_INSTALL=falseunset JAVA_HOME 2.2 ä¸ºä»€ä¹ˆåŒºåˆ†releaseå’Œdebugç‰ˆæœ¬ï¼Ÿé¦–å…ˆç¼–è¯‘releaseç‰ˆæœ¬æ¯”è¾ƒç®€å•ï¼Œé‡åˆ°çš„é”™è¯¯ä¼šæ¯”è¾ƒå°‘ã€‚æˆ‘å‰é¢ç¼–è¯‘releaeçš„æ—¶å€™ï¼Œä¹Ÿæ¯”è¾ƒé¡ºåˆ©ï¼Œåé¢ç¼–è¯‘debugç‰ˆæœ¬å‡ºäº†å¾ˆå¤šé—®é¢˜ï¼Œæœ‰äº›åªåœ¨debugä¸‹æ‰ä¼šæœ‰ã€‚æˆ‘è§æœ‰çš„åšå®¢é‡Œé¢æè¿°çš„é—®é¢˜ï¼Œæˆ‘ä¹Ÿæ²¡æœ‰é‡åˆ°ï¼Œæ‰€ä»¥é‡åˆ°å…·ä½“é—®é¢˜ï¼Œå…·ä½“ç¯å¢ƒåˆ†æï¼Œçœ‹åˆ°é”™è¯¯ï¼Œå°½é‡å¾€å‰çœ‹ç¬¬ä¸€ä¸ªerrorï¼Œåé¢çš„æ˜¯ç”±å‰é¢çš„errorå¼•èµ·çš„ï¼Œæœç´¢å…³é”®çš„errorã€‚ 2.3 é…ç½®debugç‰ˆæœ¬ çš„configure1./configure --with-freetype-include=/usr/local/include/freetype2 --with-freetype-lib=/usr/local/lib/ --with-target-bits=64 --with-debug-level=slowdebug --enable-debug-symbols ZIP_DEBUGINFO_FILES=0 OBJCOPY=gobjcopy with-target-bits=64 ï¼šæŒ‡å®šç”Ÿæˆ64ä½jdkï¼› with-debug-level=slowdebugï¼šç¼–è¯‘æ—¶debugçš„çº§åˆ«ï¼Œæœ‰release, fastdebug, slowdebug ä¸‰ç§çº§åˆ«ï¼› enable-debug-symbols ZIP_DEBUGINFO_FILES=0ï¼šç”Ÿæˆè°ƒè¯•çš„ç¬¦å·ä¿¡æ¯ï¼Œå¹¶ä¸”ä¸å‹ç¼© 2.4 é…ç½®releaseç‰ˆæœ¬ çš„configure1./configure --with-freetype-include=/usr/local/include/freetype2 --with-freetype-lib=/usr/local/lib/ configureæˆåŠŸçš„ä¿¡æ¯123456789101112131415161718Configuration summary:* Debug level: release* JDK variant: normal* JVM variants: server* OpenJDK target: OS: macosx, CPU architecture: x86, address length: 64Tools summary:* Boot JDK: java version \"1.8.0_211\" Java(TM) SE Runtime Environment (build 1.8.0_211-b12) Java HotSpot(TM) 64-Bit Server VM (build 25.211-b12, mixed mode) (at /Library/Java/JavaVirtualMachines/jdk1.8.0_211.jdk/Contents/Home)* C Compiler: Apple LLVM version (clang-1000.10.44.4) version 10.0.0 (clang-1000.10.44.4) (at /usr/bin/clang)* C++ Compiler: version (at /usr/bin/g++)Build performance summary:* Cores to use: 4* Memory limit: 8192 MB* ccache status: not installed (consider installing)Build performance tip: ccache gives a tremendous speedup for C++ recompilations.You do not have ccache installed. Try installing it. 2.4 configure å¯èƒ½é‡åˆ°çš„é”™è¯¯12345678checking for clang... /usr/bin/clangconfigure: Resolving CC (as /usr/bin/clang) failed, using /usr/bin/clang directly.checking resolved symbolic links for CC... /usr/bin/clangchecking if CC is disguised ccache... no, keeping CCconfigure: The C compiler (located as /usr/bin/clang) does not seem to be the required GCC compiler.configure: The result from running with --version was: \"Apple LLVM version 10.0.0 (clang-1000.10.44.4)\"configure: error: GCC compiler is required. Try setting --with-tools-dir.configure exiting with result code 1 ä¿®æ”¹vim common/autoconf/generated-configure.shä¸­çš„2ä¸ªåœ°æ–¹ï¼ŒæŠŠåˆ¤æ–­å»æ‰1234567# if test $? -ne 0; then# { $as_echo \"$as_me:${as_lineno-$LINENO}: The $COMPILER_NAME compiler (located as $COMPILER) does not seem to be the required GCC compiler.\" &gt;&amp;5# $as_echo \"$as_me: The $COMPILER_NAME compiler (located as $COMPILER) does not seem to be the required GCC compiler.\" &gt;&amp;6;}# { $as_echo \"$as_me:${as_lineno-$LINENO}: The result from running with --version was: \\\"$COMPILER_VERSION_TEST\\\"\" &gt;&amp;5# $as_echo \"$as_me: The result from running with --version was: \\\"$COMPILER_VERSION_TEST\\\"\" &gt;&amp;6;}# as_fn_error $? \"GCC compiler is required. Try setting --with-tools-dir.\" \"$LINENO\" 5# fi 3.ç¼–è¯‘å¯èƒ½é‡åˆ°çš„é”™è¯¯ æœ€å¸¸è§çš„å°±æ˜¯ç¼–è¯‘å™¨åŠç‰ˆæœ¬å’Œä»£ç çš„å†å²åŸå› ï¼Œè¯­æ³•æ ¼å¼ä¸æ”¯æŒäº†ï¼Œå¸¸è§çš„åšæ³•æ˜¯ä¿®æ”¹ä»£ç ï¼Œæˆ–å‡é™ç¼–è¯‘å™¨ã€‚çœ‹æŠ¥é”™çš„å…·ä½“æ–‡ä»¶è·¯å¾„å’Œè¡Œæ•° è‹¥æŠ¥ä¸‹é¢çš„é”™æ›¿æ¢ ä¸º Universe::narrow_oop_base() != NULL 12345 if (Universe::narrow_oop_base()&gt;0) { // Implies UseCompressedOops. ~~~~~~~~~~~~~~~~~~~~~~~~~~~^~1 error generated.make[6]: *** [lcm.o] Error 1make[6]: *** Waiting for unfinished jobs.... è‹¥æŠ¥ä¸‹é¢ç±»ä¼¼çš„é”™è¯¯ æ›¿æ¢è¯­æ³• if (base()!=NULL),ä¿å­˜,é‡æ–° make 123456789 if (base()&gt;0) { ~~~~~~^~1 error generated.make[6]: *** [virtualspace.o] Error 1make[6]: *** Waiting for unfinished jobs....make[5]: *** [the_vm] Error 2make[4]: *** [product] Error 2make[3]: *** [generic_build2] Error 2make[2]: *** [product] Error 2 æœ€åå¯èƒ½é‡åˆ°æ‰¾ä¸åˆ° x86_64 ç¬¦å· 123456Undefined symbols for architecture x86_64: \"_attachCurrentThread\", referenced from: +[ThreadUtilities getJNIEnv] in ThreadUtilities.o +[ThreadUtilities getJNIEnvUncached] in ThreadUtilities.old: symbol(s) not found for architecture x86_64clang: error: linker command failed with exit code 1 (use -v to see invocation) è§£å†³åŠæ³•ï¼š 12345vi ./jdk/src/macosx/native/sun/osxapp/ThreadUtilities.mç„¶åæŠŠinline void attachCurrentThread(void** env) {æ”¹ä¸ºstatic inline void attachCurrentThread(void** env) { 4.ç¼–è¯‘æˆåŠŸ12345678910----- Build times -------Start 2019-05-11 19:58:39End 2019-05-11 20:02:5900:00:16 corba00:01:20 hotspot00:00:10 jaxp00:00:15 jaxws00:02:00 jdk00:00:18 langtools00:04:20 TOTAL åˆ°buildç›®å½•ä¸‹æ£€æŸ¥ç‰ˆæœ¬./java -version 123openjdk version \"1.8.0-internal-debug\"OpenJDK Runtime Environment (build 1.8.0-internal-debug-kenchan_2019_05_11_19_58-b00)OpenJDK 64-Bit Server VM (build 25.40-b25-debug, mixed mode) å¦‚æœæ£€æŸ¥ç‰ˆæœ¬ï¼Œä½ æ°å¥½ä¹Ÿé‡åˆ°çš„äº†è¿è¡Œæ—¶é”™è¯¯ å¯è§ https://bugs.openjdk.java.net/browse/JDK-8204325 12345678910111213141516171819202122232425openjdk version \"1.8.0-internal-debug\"OpenJDK Runtime Environment (build 1.8.0-internal-debug-kenchan_2019_05_11_19_58-b00)OpenJDK 64-Bit Server VM (build 25.40-b25-debug, mixed mode)## A fatal error has been detected by the Java Runtime Environment:## SIGILL (0x4) at pc=0x000000010f42e268, pid=67347, tid=8451## JRE version: OpenJDK Runtime Environment (8.0) (build 1.8.0-internal-debug-kenchan_2019_05_11_19_58-b00)# Java VM: OpenJDK 64-Bit Server VM (25.40-b25-debug mixed mode bsd-amd64 compressed oops)# Problematic frame:# V [libjvm.dylib+0xa2e268] PerfData::~PerfData()+0x8## Failed to write core dump. Core dumps have been disabled. To enable core dumping, try \"ulimit -c unlimited\" before starting Java again## An error report file with more information is saved as:# /Users/kenchan/Downloads/openjdk/build/macosx-x86_64-normal-server-slowdebug/jdk/bin/hs_err_pid67347.log## If you would like to submit a bug report, please visit:# http://bugreport.java.com/bugreport/crash.jsp#[error occurred during error reporting , id 0x4][1] 67347 abort ./java -version è§£å†³åŠæ³• å‚è€ƒäº†https://stackoverflow.com/questions/50678467/building-openjdk-9-on-mac-os/54954805#54954805 ä¿®æ”¹ hotspot/src/share/vm/runtime /perfMemory.cpp 123// if (SafepointSynchronize::is_at_safepoint() &amp;&amp; !StatSampler::is_active()) {// PerfDataManager::destroy();// } è¿™ä¸ªæ˜æ˜¾æ˜¯å»æ‰äº†å†…å­˜å›æ”¶ï¼Œå¯èƒ½å¯¼è‡´å†…å­˜æ³„æ¼ï¼Œä¸è¿‡æˆ‘ä»¬æ˜¯æœ¬åœ°æµ‹è¯•å­¦ä¹ ï¼Œå…ˆå¿½ç•¥è¿™ä¸ªé”™è¯¯ã€‚ ä¿®æ”¹ hotspot/src/share/vm/runtime/perfData.cpp PerfDataManager::destroy() å‡½æ•°123456789101112131415161718void PerfDataManager::destroy() {if (_all == NULL) // destroy already called, or initialization never happened return;for (int index = 0; index &lt; _all-&gt;length(); index++) { PerfData* p = _all-&gt;at(index); delete p;//æ³¨é‡Šæ‰æˆ‘}delete(_all);delete(_sampled);delete(_constants);_all = NULL;_sampled = NULL;_constants = NULL;} æ€ä¹ˆæ‰¾åˆ°è¿™ä¸ªé”™çš„å‘¢ï¼Ÿè¯·çœ‹ ï¼ŸMacä¸‹æ€ä¹ˆç”¨Clion debug openJdk8? 5.å‚è€ƒ https://github.com/johnwatsondev/johnwatsondev.github.io/issues/2 https://blog.csdn.net/lizhengjava/article/details/105629780 https://stackoverflow.com/questions/50678467/building-openjdk-9-on-mac-os/54954805#54954805","link":"/2019/05/11/Java/Mac%E4%B8%8B%E7%BC%96%E8%AF%91OpenJdk8/"},{"title":"Synchronizedåå‘é”æ‰¹é‡é‡åå‘ä¸æ‰¹é‡æ’¤é”€","text":"1.æ‰¹é‡é‡åå‘ intx BiasedLockingBulkRebiasThreshold = 20 é»˜è®¤åå‘é”æ‰¹é‡é‡åå‘é˜ˆå€¼ å¯ä»¥é€šè¿‡JVMå‚æ•° -XX:BiasedLockingBulkRebiasThresholdæ‰‹åŠ¨è®¾ç½®é˜ˆå€¼ èµ·å› ï¼šå½“ä¸€ä¸ªçº¿ç¨‹Aå¯¹æŸä¸ªç±»ç”Ÿæˆå¤§é‡çš„å¯¹è±¡çš„å¯¹è±¡ï¼Œè¿™äº›å¯¹è±¡åå‘äº†Aï¼Œåé¢çªç„¶æœ‰æ¥äº†ä¸ªçº¿ç¨‹Bå»æŠ¢çº¿ç¨‹Aç”Ÿæˆçš„å¯¹è±¡ï¼Œå°±ä¼šå¯¼è‡´åå‘é”çš„å‡çº§ä¸ºè½»é‡çº§é”ï¼Œå¦‚æœæ€»æ˜¯åœ¨ä¸æ–­çš„å‡çº§é”ï¼Œåˆ°äº†ä¸€å®šçš„é˜ˆå€¼ï¼ŒJVM å°±ä¼šå¯¹ç±»çš„æ‰€æœ‰å¯¹è±¡è¿›è¡Œæ‰¹é‡çš„é‡æ–°åå‘ä¸Bã€‚ æµ‹è¯•ä»£ç 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950public class BiasedLock { public static void main(String[] args) throws InterruptedException { //åå‘å»¶æ—¶ Thread.sleep(5000); final ArrayList&lt;Dog&gt; dogArrayList = new ArrayList&lt;&gt;(); Runnable runnable1 = new Runnable() { @Override public void run() { while (dogArrayList.size() &lt; 60) { Dog dog = new Dog(); synchronized (dog){ dogArrayList.add(dog); HeaderPrint.parseHeaderInfo(dog); } } //ä¿æŒçº¿ç¨‹ä¸è¦é€€å‡º try { Thread.sleep(100000); } catch (InterruptedException e) { e.printStackTrace(); } } }; Runnable runnable2 = new Runnable() { @Override public void run() { for (int i = 0; i &lt; 50; i++) { Dog dog = dogArrayList.get(i); synchronized (dog){ System.out.print((i+1)+\":\"); dogArrayList.add(dog); HeaderPrint.parseHeaderInfo(dog); } } //ä¿æŒçº¿ç¨‹ä¸è¦é€€å‡º try { Thread.sleep(100000); } catch (InterruptedException e) { e.printStackTrace(); } } }; new Thread(runnable1).start(); //ä¿è¯çº¿ç¨‹1ç”Ÿæˆå®Œæ¯• Thread.sleep(5000); new Thread(runnable2).start(); }} æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œçº¿ç¨‹2å¯åŠ¨çš„æ—¶å€™ï¼Œæ˜¯ä»åå‘é”å‡çº§åˆ°äº† è½»é‡çº§é” ä¸€ç›´å‡çº§åˆ° é˜ˆå€¼20çš„æ—¶å€™ï¼Œè§¦å‘JVMä¼˜åŒ–æœºåˆ¶ï¼ŒJVMè®¤ä¸ºåå‘çš„ä¸å¯¹ï¼Œæ€ä¹ˆæ€»æ˜¯çº¿ç¨‹2æ¥å¼º=æŠ¢ï¼Œæ€»çš„å‡çº§é”ï¼Œæ¯”è¾ƒéº»çƒ¦ï¼Œæ‰€ä»¥JVMç›´æ¥è®©å‰©ä¸‹dogå¯¹è±¡ï¼Œç›´æ¥é‡æ–°åå‘åˆ°çº¿ç¨‹2 çº¿ç¨‹0 çš„åå‘å€¼ thread:54:000000000000000001111111101001001000101100000011000100(HEX:1fe922c0c4) åœ¨ ç¬¬ 20ä¸ªæ˜¯çš„æ—¶å€™ï¼Œå°±å·²ç»é‡æ–°åå‘äº† åé¢çš„ä¹Ÿéƒ½æ˜¯åå‘é” 1234567891050:--------START-----------Thread-2--------åå‘é”--------thread:54:000000000000000001111111101001001000101100011000001110(HEX:1fe922c60e)epoch:2:01unused:1:0age:4:0000biased_lock:1:1--------END-----------Thread-2 2.æ‰¹é‡æ’¤é”€ intx BiasedLockingBulkRevokeThreshold = 40 é»˜è®¤åå‘é”æ‰¹é‡æ’¤é”€é˜ˆå€¼ å¯ä»¥é€šè¿‡JVMå‚æ•° -XX:BiasedLockingBulkRevokeThresholdæ‰‹åŠ¨è®¾ç½®é˜ˆå€¼ èµ·å› ï¼šåœ¨å¤šä¸ªçº¿ç¨‹ç«äº‰å‰§çƒˆçš„æƒ…å†µä¸‹ï¼Œä½¿ç”¨åå‘é”å°†ä¼šé™ä½æ•ˆç‡ï¼Œäºæ˜¯ä¹äº§ç”Ÿäº†æ‰¹é‡æ’¤é”€æœºåˆ¶ã€‚ æµ‹è¯•ä»£ç ï¼š æ‰¹é‡é‡åå‘å’Œæ‰¹é‡æ’¤é”€æ˜¯é’ˆå¯¹ç±»çš„ä¼˜åŒ–ã€‚ åå‘é”åªä¼šé‡åå‘ä¸€æ¬¡ï¼Œåé¢å°±æ˜¯å‡çº§é” å½“æŸä¸ªç±»å·²ç»è§¦å‘æ‰¹é‡æ’¤é”€æœºåˆ¶åï¼Œè¯¥ç±»çš„å¯¹è±¡ä¸ä¼šå†ä½¿ç”¨åå‘é” 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758596061626364656667686970717273747576777879808182public static void main(String[] args) throws InterruptedException { final CountDownLatch countDownLatch = new CountDownLatch(2); //åå‘å»¶æ—¶ Thread.sleep(5000); final ArrayList&lt;Dog&gt; dogArrayList = new ArrayList&lt;&gt;(); Runnable runnable1 = new Runnable() { @Override public void run() { while (dogArrayList.size() &lt; 80) { Dog dog = new Dog(); synchronized (dog) { dogArrayList.add(dog); } } //ä¿æŒçº¿ç¨‹ä¸è¦é€€å‡º try { Thread.sleep(50000); } catch (InterruptedException e) { e.printStackTrace(); } } }; Runnable runnable2 = new Runnable() { @Override public void run() { for (int i = 0; i &lt;39; i++) { if (i == 38) { System.out.println((i + 1) + \":\"); //è¿™é‡Œä¸»è¦æ˜¯ç»™ä¸»çº¿ç¨‹ç•™å‡ºæ—¶é—´ï¼Œè®©ä¸»çº¿ç¨‹æ‰“å°å‡ºä¸€ä¸ªnew Dog countDownLatch.countDown(); try { Thread.sleep(1000); } catch (InterruptedException e) { e.printStackTrace(); } } Dog dog = dogArrayList.get(i); synchronized (dog) { dogArrayList.add(dog); try { Thread.sleep(20); } catch (InterruptedException e) { e.printStackTrace(); } } } //ä¿æŒçº¿ç¨‹ä¸è¦é€€å‡º try { Thread.sleep(50000); } catch (InterruptedException e) { e.printStackTrace(); } } }; new Thread(runnable1).start(); //ä¿è¯çº¿ç¨‹1ç”Ÿæˆå®Œæ¯• Thread.sleep(3000); //é‡æ–°åå‘çº¿ç¨‹2 new Thread(runnable2).start(); Thread.sleep(3000); //çº¿ç¨‹3å¯¼è‡´åå‘é”å‡çº§ new Thread(runnable2).start(); //çº¿ç¨‹3å¯¼è‡´é”å‡çº§åˆ°39çš„æ—¶å€™ï¼Œnewå‡ºæ¥çš„å¯¹è±¡ï¼Œé»˜è®¤æ˜¯å¯åå‘çš„çŠ¶æ€ countDownLatch.await(); HeaderPrint.parseHeaderInfo(new Dog()); //ä¿è¯ä¹‹å Thread.sleep(3000); //ç¬¬39ä¹‹åçš„æ–°å¯¹è±¡ï¼Œå·²ç»æ²¡æœ‰åå‘äº†ï¼Œåå‘è¢«æ’¤é”€äº† HeaderPrint.parseHeaderInfo(new Dog()); } è¾“å‡º ç¬¬39çš„æ—¶å€™ï¼Œé»˜è®¤è¾“å‡ºçš„æ˜¯ï¼Œå¯åå‘çŠ¶æ€ ç¬¬39ä¹‹åï¼Œnew çš„å¯¹è±¡ï¼Œå·²ç»è¢«å–æ¶ˆé»˜è®¤å¯åå‘çš„çŠ¶æ€äº†ï¼Œæˆæ— é”äº† 123456789101112131415161718192039:--------START-----------main--------åå‘é”--------thread:54:000000000000000000000000000000000000000000000000000000(HEX:0)epoch:2:01unused:1:0age:4:0000biased_lock:1:1--------END-----------main--------START-----------main--------æ— é”-----------unused:25:0000000000000000000000000identity_hashcode:31: 0000000000000000000000000000000 (Hex:0)unused:1:0age:4:0000biased_lock:1:0lock:2:01--------END-----------main","link":"/2019/10/20/Java/Synchronized%E5%81%8F%E5%90%91%E9%94%81%E6%89%B9%E9%87%8F%E9%87%8D%E5%81%8F%E5%90%91%E4%B8%8E%E6%89%B9%E9%87%8F%E6%92%A4%E9%94%80/"},{"title":"Ubuntuç¼–è¯‘glibcåº“æ¥éªŒè¯Synchronizedé”ä¼˜åŒ–æ•ˆæœ","text":"0.å‰è¨€å½“ç„¶ä½ å¯ä»¥è¯´é€šè¿‡JOLæŸ¥çœ‹å¯¹è±¡çš„å¤´ä¿¡æ¯ï¼Œå½“ç„¶é‚£ä¸ªä¹Ÿæ˜¯ä¸€ç§æ–¹æ³•ï¼Œä½†é‚£ä¸ªåªèƒ½è¯´æ˜æ˜¯è¿™ç§çŠ¶æ€ï¼Œæ²¡æœ‰è¿‡ç¨‹ï¼Œæœ¬æ¬¡ä¸»è¦ç»“åˆæ¥éªŒè¯ï¼ŒSynchronized å…³é”®å­—é”çš„çŠ¶æ€ï¼šæ— é”ã€åå‘é”ã€è½»é‡çº§é”ã€é‡é‡çº§é”åŸºäºUbuntu16æµ‹è¯•æˆåŠŸã€‚18æµ‹è¯•å¤±è´¥ï¼Œcentosæ²¡æœ‰æµ‹è¯•ä¸»è¦æ˜¯åœ¨Javaè°ƒç”¨ç³»ç»Ÿå‡½æ•°çš„æ—¶å€™ï¼Œæ‰“å°logã€‚ä½†æ˜¯åœ¨Javaé‡Œé¢æ‰“å°çº¿ç¨‹IDæ˜¯JVMå±‚é¢çš„ã€‚éœ€è¦è‡ªå·±å®ç°ä¸€ä¸ªnativeæ–¹æ³•ï¼Œåœ¨javaå±‚é¢è°ƒç”¨ã€‚æœ€åå¯¹æ¯”å¯¹åº”çš„PID å’ŒTIDï¼Œå‘ç°æŸ¥çœ‹å½“å‰çº¿ç¨‹è°ƒç”¨äº†å‡ æ¬¡ç³»ç»Ÿé”Java çš„é‡é‡çº§çº§é”éƒ½æ˜¯é€šè¿‡glibcåº“çš„pthread_mutex_lockå‡½æ•°å®ç°çš„ï¼Œæ˜¯åœ¨å’Œæ“ä½œç³»ç»Ÿçº§åˆ«çš„é”ã€‚ glibcåº“glibcæ˜¯linuxç³»ç»Ÿä¸­æœ€åº•å±‚çš„apiï¼Œå‡ ä¹å…¶å®ƒä»»ä½•è¿è¡Œåº“éƒ½ä¼šä¾èµ–äºglibcã€‚glibcé™¤äº†å°è£…linuxæ“ä½œç³»ç»Ÿæ‰€æä¾›çš„ç³»ç»ŸæœåŠ¡å¤–ï¼Œå®ƒæœ¬èº«ä¹Ÿæä¾›äº†è®¸å¤šå…¶å®ƒä¸€äº›å¿…è¦åŠŸèƒ½æœåŠ¡çš„å®ç°ã€‚ æ“ä½œç³»ç»Ÿåº•å±‚åº“ int pthread_mutex_lock(pthread_mutex_t *mutex);pthread_mutex_lock()è¿”å›æ—¶ï¼Œè¯¥äº’æ–¥é”å·²è¢«é”å®šã€‚çº¿ç¨‹è°ƒç”¨è¯¥å‡½æ•°è®©äº’æ–¥é”ä¸Šé”ï¼Œå¦‚æœè¯¥äº’æ–¥é”å·²è¢«å¦ä¸€ä¸ªçº¿ç¨‹é”å®šå’Œæ‹¥æœ‰ï¼Œåˆ™è°ƒç”¨è¯¥çº¿ç¨‹å°†é˜»å¡ï¼Œç›´åˆ°è¯¥äº’æ–¥é”å˜ä¸ºå¯ç”¨ä¸ºæ­¢ã€‚ å¯¹äº Solarisçº¿ç¨‹ï¼Œè¯·å‚è§mutex_lock è¯­æ³• ä¼šé˜»å¡ æˆ‘ä»¬å¯ä»¥ä»JVM æºç ä¸­çœ‹åˆ°è°ƒç”¨ ThreadCritical::ThreadCritical12345678910ThreadCritical::ThreadCritical() { pthread_t self = pthread_self(); if (self != tc_owner) { int ret = pthread_mutex_lock(&amp;tc_mutex); guarantee(ret == 0, \"fatal error with pthread_mutex_lock()\"); assert(tc_count == 0, \"Lock acquired with illegal reentry count.\"); tc_owner = self; } tc_count++;} è¿™ä¸ªæ˜¯åº•å±‚ç³»ç»Ÿåº“ï¼Œæˆ‘ä»¬æ˜¯çœ‹ä¸åˆ°æºç çš„ï¼Œåªèƒ½è‡ªå·±ä¸‹è½½ã€‚å¯ä»¥åœ¨glibc/nptl/phread_mutex_lock.cé‡Œçœ‹åˆ°å®ç°ã€‚ æˆ‘å°è¯•å°±æ˜¯åœ¨è¿™é‡Œå‡½æ•°é‡ŒåŠ ä¸Šè‡ªå·±çš„log 12345int __pthread_mutex_lock (pthread_mutex_t *mutex){ //æ‰“å°log fprintf(stdout,\"pthread_mutex_lock log PID = %d TID = %lu mutex = %p \\n\",getpid(),pthread_self(),&amp;mutex); --- 1. æŸ¥çœ‹è‡ªå·±çš„glibcç‰ˆæœ¬12345root@189415df5c51:/lib/x86_64-linux-gnu# pwd/lib/x86_64-linux-gnuroot@189415df5c51:/lib/x86_64-linux-gnu# ls -l libc.so.6lrwxrwxrwx 1 root root 12 Feb 5 2019 libc.so.6 -&gt; libc-2.23.soroot@189415df5c51:/lib/x86_64-linux-gnu# 2.æœ€å¥½ä¸‹è½½åŒä¸€ä¸ªç‰ˆæœ¬ï¼Œç¼–è¯‘glibcç‰ˆæœ¬https://ftp.gnu.org/gnu/glibc/?C=M;O=Aç›®å½•å¯ä»¥è‡ªå·±å˜åŒ–ï¼Œä½†æ˜¯glibcä¸è®©åœ¨æºç ç›®å½•ä¸‹é¢ç¼–è¯‘ ä¼šæŠ¥ Makeconfig:42: *** missing separator. Stopè‹¥æœ‰å¿…è¦ï¼Œå¯ä»¥å‚è€ƒ Linuxæºç åŒ…çš„ä¸€èˆ¬å®‰è£…æ­¥ 12345mkdir buildcd build./../configure --prefix = usr/local/glibc makemake install 3.ä¿®æ”¹æ›¿æ¢ ç¼–è¯‘vim pthread_mutex_lock.c æ·»åŠ log 1fprintf(stdout,\"pthread_mutex_lock log PID = %d TID = %lu mutex = %p \\n\",getpid(),pthread_self(),&amp;mutex); 4.è¿è¡Œæ—¶æ›¿æ¢å…³é”®åº“ è¿™é‡Œéœ€è¦æ³¨æ„ï¼Œæé”™äº†ï¼Œå°±ä¸èƒ½çš„è¯ï¼Œæ‰€æœ‰å‘½ä»¤éƒ½å¯èƒ½ç”¨ä¸äº†äº† è‡ªå·±ä¸»è¦ä¿®æ”¹çš„æ˜¯pthreadåº“ï¼Œæ‰€ä»¥æ›¿æ¢ç³»ç»Ÿçš„pthreadåº“ï¼Œfindä¸€ä¸‹ 1.æŸ¥çœ‹ /etc/ld.conf.d/x86-gnu*.conf ä¸‹çš„ç›®å½• 2.å› ä¸ºè¦æ›¿æ¢å‡ ä¸ªå…³é”®æ–‡ä»¶ï¼Œç›´æ¥æ‰‹åŠ¨æ›¿æ¢ä¼šå‡ºé”™ï¼Œç³»ç»Ÿåº“æ˜¯åœ¨åŠ¨æ€åŠ è½½çš„ã€‚copy ä¸€ä¸ªä¸´æ—¶ç›®å½•ï¼ŒåŠ ä¸Šäº†nåç¼€ï¼ŒåšåŒºåˆ†ã€‚å»æ›¿æ¢ä¸´æ—¶ç›®å½•é‡Œé¢çš„æ–‡ä»¶ 3.ä¾‹å¦‚æˆ‘çš„ 12345cp /usr/local/glibc23/lib/libpthread.so /usr/lib/x86_64-linux-gnu-n/libpthread.socp /usr/local/glibc23/lib/libpthread_nonshared.a /usr/lib/x86_64-linux-gnu-n/libpthread_nonshared.acp /usr/local/glibc23/lib/libpthread.a /usr/lib/x86_64-linux-gnu-n/libpthread.acp /usr/local/glibc23/lib/libpthread-2.23.so /lib/x86_64-linux-gnu-n/libpthread-2.23.socp /usr/local/glibc23/lib/libpthread.so.0 /lib/x86_64-linux-gnu-n/libpthread.so.0 4.ä¿®æ”¹ /etc/ld.conf.d/x86-gnu*.conf é‡Œé¢çš„é“¾æ¥åº“è·¯å¾„æŒ‡å‘ä¸´æ—¶ç›®å½•ï¼Œä¸ç”¨äº†å¯ä»¥æ”¹å› 5.æ‰§è¡Œldconfigï¼Œç”Ÿæ•ˆ 6.è‡ªå·±é…ç½®javaç¯å¢ƒ åŸºæœ¬ä»»å‘½ä»¤éƒ½ä¼šè§¦å‘è¿™è¡Œlog 123root@189415df5c51:/etc/ld.so.conf.d# lspthread_mutex_lock log PID = 62030 TID = 140453473769472 mutex=0x7fbddf6a1948libc.conf x86_64-linux-gnu.conf 5.ç¼–å†™JavaéªŒè¯æ¥ä¸‹æ¥ï¼Œå°±æ˜¯æ­£å¸¸jniæµç¨‹äº† JniTool.java12345678package jnitool;public class JniTool { static { System.loadLibrary(\"jnitools\"); } public native void getThreadID();} è¿™é‡Œjnitoolå¿…é¡»åœ¨ java.library.pathè¿™ä¸€jvmå˜é‡æ‰€æŒ‡å‘çš„è·¯å¾„ä¸­ï¼Œå¯ä»¥é€šè¿‡å¦‚ä¸‹æ–¹æ³•è·å¾—è¯¥å˜é‡System.getProperty(â€œjava.library.pathâ€); ç”Ÿæˆ.hæ–‡ä»¶ï¼Œjavah -jni jnitool.JniToolæ‰“å°javaçº¿ç¨‹çš„pidå’Œtidï¼Œjvmå±‚é¢ 12345678910#include \"jnitool_JniTool.h\"#include &lt;stdio.h&gt;#include &lt;pthread.h&gt;#include &lt;unistd.h&gt;JNIEXPORT void JNICALL Java_jnitool_JniTool_getThreadID (JNIEnv * env, jobject obj){ fprintf(stdout,\"java_lock log PID = %d TID = %lu \\n\",getpid(),pthread_self()); fflush(stdout);//åˆ·æ–°ï¼Œé˜²æ­¢é”™ä½æ‰“å°} ä½¿ç”¨makeç¼–è¯‘123456vim makefilelibjnitools.so: gcc -lpthread -fPIC -shared -o libjnitools.so -I /root/jdk1.8.0_221/include/ -I /root/jdk1.8.0_221/include/linux/ ./jnitools.c make 6. è§‚å¯Ÿä¸åŒçš„é” ä¸»è¦æ˜¯å¯¹æ¯”ä¸åŒçš„é”æƒ…å†µä¸‹ï¼Œå¯¹æ“ä½œç³»ç»Ÿç³»ç»Ÿé”çš„è°ƒç”¨æƒ…å†µï¼Œè§‚å¯Ÿä¼˜åŒ–æ•ˆæœ å½“ç„¶JVMå¯¹é”çš„ä¼˜åŒ–ï¼Œæ˜¯è°ƒç”¨ç³»ç»Ÿé”çš„æ¬¡æ•°è¶Šå°‘è¶Šå¥½ å¬è¿‡ç³»ç»Ÿé”çš„logï¼Œç›´è§‚å¯¹æ¯”è°ƒç”¨pthread_mutex_lockæ¬¡æ•° å¥‡æ€ªçš„æ˜¯æˆ‘åœ¨dockeré‡Œé¢ï¼Œä¿®æ”¹glibcåº“åï¼ŒåŠ ä¸Šjolæ‰“å°å¤´ä¿¡æ¯å°±ä¼šå¡ï¼Œæ‰€ä»¥å…ˆéªŒè¯æ˜¯ä»€ä¹ˆé”çš„æƒ…å†µä¸‹ï¼Œå†æ‰“çš„log 6.1 æ— é”123456789101112131415161718192021222324252627282930313233343536373839404142public class SyncTest { //æµ‹è¯•é” final Object lock = new Object(); //è·å–pthread tid JniTool jniTool = new JniTool(); public static void main(String[] args) throws InterruptedException { //ä¸æ‰“å¼€ï¼Œé»˜è®¤å°±æ˜¯æ— æ‰€çš„çŠ¶æ€ //Thread.sleep(5000); SyncTest test = new SyncTest(); System.out.println(\"---------------------------start--------------------\"); test.start(); } public void start() throws InterruptedException { Runnable runnable = new Runnable() { @Override public void run() { int count = 0; System.out.println(Thread.currentThread().getName() + \" start\"); while (true) { if (count &lt; 50) { count++; } else { return; } try { lock(); } catch (InterruptedException e) { e.printStackTrace(); } } } }; new Thread(runnable).start(); } public void lock() throws InterruptedException { synchronized (lock) { jniTool.getThreadID(); } }} out.log é€šè¿‡logå¯ä»¥çœ‹åˆ°50æ¬¡è°ƒç”¨,é€šè¿‡æœç´¢tidæŸ¥çœ‹ åˆšå¼€å§‹å’Œç»“æŸè°ƒç”¨äº†ç³»ç»Ÿé”ï¼Œä¸­é—´æ˜¯æ²¡æœ‰è°ƒç”¨ç³»ç»Ÿé” 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657583545: pthread_mutex_lock log PID = 399 TID = 140058569967360 mutex=0x7f61e800b728 3546: pthread_mutex_lock log PID = 399 TID = 140058569967360 mutex=0x7f61e8100b28 3549: pthread_mutex_lock log PID = 399 TID = 140058569967360 mutex=0x7f61e8100b28 3555: pthread_mutex_lock log PID = 399 TID = 140058569967360 mutex=0x7f61e80b9228 3562: pthread_mutex_lock log PID = 399 TID = 140058569967360 mutex=0x7f61f778b8a0 3563: pthread_mutex_lock log PID = 399 TID = 140058569967360 mutex=0x7f61f83d3948 3564: java_lock log-----------PID = 399 TID = 140058569967360 3575: java_lock log-----------PID = 399 TID = 140058569967360 3576: java_lock log-----------PID = 399 TID = 140058569967360 3577: java_lock log-----------PID = 399 TID = 140058569967360 3578: java_lock log-----------PID = 399 TID = 140058569967360 3579: java_lock log-----------PID = 399 TID = 140058569967360 3580: java_lock log-----------PID = 399 TID = 140058569967360 3581: java_lock log-----------PID = 399 TID = 140058569967360 3582: java_lock log-----------PID = 399 TID = 140058569967360 3583: java_lock log-----------PID = 399 TID = 140058569967360 3584: java_lock log-----------PID = 399 TID = 140058569967360 3585: java_lock log-----------PID = 399 TID = 140058569967360 3586: java_lock log-----------PID = 399 TID = 140058569967360 3587: java_lock log-----------PID = 399 TID = 140058569967360 3588: java_lock log-----------PID = 399 TID = 140058569967360 3590: java_lock log-----------PID = 399 TID = 140058569967360 3591: java_lock log-----------PID = 399 TID = 140058569967360 3592: java_lock log-----------PID = 399 TID = 140058569967360 3593: java_lock log-----------PID = 399 TID = 140058569967360 3594: java_lock log-----------PID = 399 TID = 140058569967360 3595: java_lock log-----------PID = 399 TID = 140058569967360 3596: java_lock log-----------PID = 399 TID = 140058569967360 3597: java_lock log-----------PID = 399 TID = 140058569967360 3598: java_lock log-----------PID = 399 TID = 140058569967360 3599: java_lock log-----------PID = 399 TID = 140058569967360 3600: java_lock log-----------PID = 399 TID = 140058569967360 3601: java_lock log-----------PID = 399 TID = 140058569967360 3602: java_lock log-----------PID = 399 TID = 140058569967360 3603: java_lock log-----------PID = 399 TID = 140058569967360 3604: java_lock log-----------PID = 399 TID = 140058569967360 3605: java_lock log-----------PID = 399 TID = 140058569967360 3606: java_lock log-----------PID = 399 TID = 140058569967360 3607: java_lock log-----------PID = 399 TID = 140058569967360 3608: java_lock log-----------PID = 399 TID = 140058569967360 3609: java_lock log-----------PID = 399 TID = 140058569967360 3610: java_lock log-----------PID = 399 TID = 140058569967360 3611: java_lock log-----------PID = 399 TID = 140058569967360 3612: java_lock log-----------PID = 399 TID = 140058569967360 3613: java_lock log-----------PID = 399 TID = 140058569967360 3614: java_lock log-----------PID = 399 TID = 140058569967360 3615: java_lock log-----------PID = 399 TID = 140058569967360 3616: java_lock log-----------PID = 399 TID = 140058569967360 3617: java_lock log-----------PID = 399 TID = 140058569967360 3618: java_lock log-----------PID = 399 TID = 140058569967360 3619: java_lock log-----------PID = 399 TID = 140058569967360 3620: java_lock log-----------PID = 399 TID = 140058569967360 3621: java_lock log-----------PID = 399 TID = 140058569967360 3622: java_lock log-----------PID = 399 TID = 140058569967360 3623: java_lock log-----------PID = 399 TID = 140058569967360 3624: pthread_mutex_lock log PID = 399 TID = 140058569967360 mutex=0x7f61e800b528 3625: pthread_mutex_lock log PID = 399 TID = 140058569967360 mutex=0x7f61f77a32c0 3626: pthread_mutex_lock log PID = 399 TID = 140058569967360 mutex=0x7f61f77a32c0 6.2 åå‘é” åå‘é”æ˜¯é»˜è®¤å»¶æ—¶åŠ è½½çš„ æˆ‘ä»¬å¯ä»¥åŠ JVMå‚æ•°æˆ–sleep é€šè¿‡ä¸Šé¢çš„ä»£ç ï¼ŒåŠ ä¸Š Thread.sleep(5000);ç¡®ä¿åå‘é”æ‰“å¼€ out.log æŸ¥çœ‹è¾“å‡º, æ•ˆæœå¦‚ä¸Š 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758596061623742: pthread_mutex_lock log PID = 431 TID = 139799890413312 mutex=0x7f25c800b728 3743: pthread_mutex_lock log PID = 431 TID = 139799890413312 mutex=0x7f25c80e9128 3750: pthread_mutex_lock log PID = 431 TID = 139799890413312 mutex=0x7f25c80e9128 3752: pthread_mutex_lock log PID = 431 TID = 139799890413312 mutex=0x7f25c80b9228 3763: pthread_mutex_lock log PID = 431 TID = 139799890413312 mutex=0x7f25cffe18a0 3764: pthread_mutex_lock log PID = 431 TID = 139799890413312 mutex=0x7f25d4c8b948 3765: java_lock log-----------PID = 431 TID = 139799890413312 3772: java_lock log-----------PID = 431 TID = 139799890413312 3773: java_lock log-----------PID = 431 TID = 139799890413312 3774: java_lock log-----------PID = 431 TID = 139799890413312 3775: java_lock log-----------PID = 431 TID = 139799890413312 3776: java_lock log-----------PID = 431 TID = 139799890413312 3777: java_lock log-----------PID = 431 TID = 139799890413312 3778: java_lock log-----------PID = 431 TID = 139799890413312 3779: java_lock log-----------PID = 431 TID = 139799890413312 3780: java_lock log-----------PID = 431 TID = 139799890413312 3781: java_lock log-----------PID = 431 TID = 139799890413312 3782: java_lock log-----------PID = 431 TID = 139799890413312 3783: java_lock log-----------PID = 431 TID = 139799890413312 3785: java_lock log-----------PID = 431 TID = 139799890413312 3787: java_lock log-----------PID = 431 TID = 139799890413312 3788: java_lock log-----------PID = 431 TID = 139799890413312 3789: java_lock log-----------PID = 431 TID = 139799890413312 3790: java_lock log-----------PID = 431 TID = 139799890413312 3791: java_lock log-----------PID = 431 TID = 139799890413312 3792: java_lock log-----------PID = 431 TID = 139799890413312 3793: java_lock log-----------PID = 431 TID = 139799890413312 3794: java_lock log-----------PID = 431 TID = 139799890413312 3795: java_lock log-----------PID = 431 TID = 139799890413312 3796: java_lock log-----------PID = 431 TID = 139799890413312 3797: java_lock log-----------PID = 431 TID = 139799890413312 3798: java_lock log-----------PID = 431 TID = 139799890413312 3799: java_lock log-----------PID = 431 TID = 139799890413312 3800: java_lock log-----------PID = 431 TID = 139799890413312 3801: java_lock log-----------PID = 431 TID = 139799890413312 3802: java_lock log-----------PID = 431 TID = 139799890413312 3803: java_lock log-----------PID = 431 TID = 139799890413312 3804: java_lock log-----------PID = 431 TID = 139799890413312 3805: java_lock log-----------PID = 431 TID = 139799890413312 3806: java_lock log-----------PID = 431 TID = 139799890413312 3807: java_lock log-----------PID = 431 TID = 139799890413312 3808: java_lock log-----------PID = 431 TID = 139799890413312 3809: java_lock log-----------PID = 431 TID = 139799890413312 3810: java_lock log-----------PID = 431 TID = 139799890413312 3811: java_lock log-----------PID = 431 TID = 139799890413312 3812: java_lock log-----------PID = 431 TID = 139799890413312 3813: java_lock log-----------PID = 431 TID = 139799890413312 3814: java_lock log-----------PID = 431 TID = 139799890413312 3815: java_lock log-----------PID = 431 TID = 139799890413312 3816: java_lock log-----------PID = 431 TID = 139799890413312 3817: java_lock log-----------PID = 431 TID = 139799890413312 3818: java_lock log-----------PID = 431 TID = 139799890413312 3819: java_lock log-----------PID = 431 TID = 139799890413312 3820: java_lock log-----------PID = 431 TID = 139799890413312 3821: java_lock log-----------PID = 431 TID = 139799890413312 3822: java_lock log-----------PID = 431 TID = 139799890413312 3823: pthread_mutex_lock log PID = 431 TID = 139799890413312 mutex=0x7f25c8079528 3824: pthread_mutex_lock log PID = 431 TID = 139799890413312 mutex=0x7f25c80e9128 3828: pthread_mutex_lock log PID = 431 TID = 139799890413312 mutex=0x7f25c80e9128 3829: pthread_mutex_lock log PID = 431 TID = 139799890413312 mutex=0x7f25c800b528 3830: pthread_mutex_lock log PID = 431 TID = 139799890413312 mutex=0x7f25cfff92c0 3831: pthread_mutex_lock log PID = 431 TID = 139799890413312 mutex=0x7f25cfff92c0 6.3 è½»é‡çº§é” æˆ‘ä»¬åå‘é”ï¼Œå‡çº§åˆ°è½»é‡çº§é”1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556public class SyncTest { //æµ‹è¯•é” final Object lock = new Object(); //è·å–pthread tid JniTool jniTool = new JniTool(); public static void main(String[] args) throws InterruptedException { //æ‰“å¼€å°±æ˜¯é»˜è®¤çš„åå‘é”ï¼Œé»˜è®¤æ˜¯å¯åå‘çŠ¶æ€ï¼Œä½†æ˜¯ä¸åå‘ä»»ä½•ä¸€ä¸ªçº¿ç¨‹ //ä¸æ‰“å¼€ï¼Œé»˜è®¤å°±æ˜¯æ— æ‰€çš„çŠ¶æ€ Thread.sleep(5000); SyncTest test = new SyncTest(); // test.parseHeaderInfo((ClassLayout.parseInstance(test.lock).toPrintable())); System.out.println(\"---------------------------start--------------------\"); test.start(); } public void start() throws InterruptedException { Runnable runnable = new Runnable() { @Override public void run() { int count = 0; System.out.println(Thread.currentThread().getName() + \" start\"); while (true) { if (count &lt; 50) { count++; } else { //è‹¥çº¿ç¨‹æ²¡æœ‰ç»“æŸï¼Œä½†æ˜¯çº¿ç¨‹1æ”¾é”äº†ï¼Œå‡çº§ä¸ºè½»é‡çº§é” try { Thread.sleep(100000); } catch (InterruptedException e) { e.printStackTrace(); } return; } try { lock(); // parseHeaderInfo(ClassLayout.parseInstance(lock).toPrintable()); } catch (InterruptedException e) { e.printStackTrace(); } } } }; new Thread(runnable).start(); //åŠ ä¸Šï¼Œä¿è¯çº¿ç¨‹1ç»“æŸï¼Œè‹¥æœçº¿ç¨‹1å·²ç»ç»“æŸï¼Œåˆ™è¿˜æ˜¯åå‘é” //è‹¥çº¿ç¨‹æ²¡æœ‰ç»“æŸï¼Œä½†æ˜¯çº¿ç¨‹1æ”¾é”äº†ï¼Œå‡çº§ä¸ºè½»é‡çº§é” Thread.sleep(2000); //ä¸åŠ ,åˆ™ä¼šå‡çº§ä¸ºé‡é‡çº§é” new Thread(runnable).start(); } public void lock() throws InterruptedException { synchronized (lock) { jniTool.getThreadID(); } }} out.log çº¿ç¨‹1çš„æ—¶å€™åå‘ çº¿ç¨‹2çš„æ—¶å€™ï¼Œå‡çº§åˆ°è½»é‡çº§é”1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859606162636465666768697071727374757677787980818283848586878889909192939495969798991001011021031041051061071081091101111121131143763: pthread_mutex_lock log PID = 498 TID = 139928822331136 mutex=0x7f43cc00b728 3764: pthread_mutex_lock log PID = 498 TID = 139928822331136 mutex=0x7f43cc108d28 3768: pthread_mutex_lock log PID = 498 TID = 139928822331136 mutex=0x7f43cc108d28 3769: pthread_mutex_lock log PID = 498 TID = 139928822331136 mutex=0x7f43cc0bba28 3774: pthread_mutex_lock log PID = 498 TID = 139928822331136 mutex=0x7f43d3fe18a0 3775: pthread_mutex_lock log PID = 498 TID = 139928822331136 mutex=0x7f43d9bea948 3777: java_lock log-----------PID = 498 TID = 139928822331136 3789: java_lock log-----------PID = 498 TID = 139928822331136 3790: java_lock log-----------PID = 498 TID = 139928822331136 3791: java_lock log-----------PID = 498 TID = 139928822331136 3792: java_lock log-----------PID = 498 TID = 139928822331136 3793: java_lock log-----------PID = 498 TID = 139928822331136 3794: java_lock log-----------PID = 498 TID = 139928822331136 3795: java_lock log-----------PID = 498 TID = 139928822331136 3796: java_lock log-----------PID = 498 TID = 139928822331136 3797: java_lock log-----------PID = 498 TID = 139928822331136 3798: java_lock log-----------PID = 498 TID = 139928822331136 3799: java_lock log-----------PID = 498 TID = 139928822331136 3800: java_lock log-----------PID = 498 TID = 139928822331136 3801: java_lock log-----------PID = 498 TID = 139928822331136 3802: java_lock log-----------PID = 498 TID = 139928822331136 3803: java_lock log-----------PID = 498 TID = 139928822331136 3804: java_lock log-----------PID = 498 TID = 139928822331136 3805: java_lock log-----------PID = 498 TID = 139928822331136 3806: java_lock log-----------PID = 498 TID = 139928822331136 3807: java_lock log-----------PID = 498 TID = 139928822331136 3808: java_lock log-----------PID = 498 TID = 139928822331136 3809: java_lock log-----------PID = 498 TID = 139928822331136 3810: java_lock log-----------PID = 498 TID = 139928822331136 3811: java_lock log-----------PID = 498 TID = 139928822331136 3812: java_lock log-----------PID = 498 TID = 139928822331136 3813: java_lock log-----------PID = 498 TID = 139928822331136 3814: java_lock log-----------PID = 498 TID = 139928822331136 3815: java_lock log-----------PID = 498 TID = 139928822331136 3816: java_lock log-----------PID = 498 TID = 139928822331136 3817: java_lock log-----------PID = 498 TID = 139928822331136 3818: java_lock log-----------PID = 498 TID = 139928822331136 3819: java_lock log-----------PID = 498 TID = 139928822331136 3820: java_lock log-----------PID = 498 TID = 139928822331136 3822: java_lock log-----------PID = 498 TID = 139928822331136 3824: java_lock log-----------PID = 498 TID = 139928822331136 3825: java_lock log-----------PID = 498 TID = 139928822331136 3826: java_lock log-----------PID = 498 TID = 139928822331136 3827: java_lock log-----------PID = 498 TID = 139928822331136 3828: java_lock log-----------PID = 498 TID = 139928822331136 3829: java_lock log-----------PID = 498 TID = 139928822331136 3830: java_lock log-----------PID = 498 TID = 139928822331136 3831: java_lock log-----------PID = 498 TID = 139928822331136 3832: java_lock log-----------PID = 498 TID = 139928822331136 3833: java_lock log-----------PID = 498 TID = 139928822331136 3834: java_lock log-----------PID = 498 TID = 139928822331136 3835: java_lock log-----------PID = 498 TID = 139928822331136 3836: java_lock log-----------PID = 498 TID = 139928822331136 3837: java_lock log-----------PID = 498 TID = 139928822331136 3838: java_lock log-----------PID = 498 TID = 139928822331136 3839: java_lock log-----------PID = 498 TID = 139928822331136 3840: pthread_mutex_lock log PID = 498 TID = 139928822331136 mutex=0x7f43cc108b28 3932: pthread_mutex_lock log PID = 498 TID = 139928821278464 mutex=0x7f43cc00b728 3933: pthread_mutex_lock log PID = 498 TID = 139928821278464 mutex=0x7f43cc0dd228 3938: pthread_mutex_lock log PID = 498 TID = 139928821278464 mutex=0x7f43cc0dd228 3942: pthread_mutex_lock log PID = 498 TID = 139928821278464 mutex=0x7f43cc079528 3945: pthread_mutex_lock log PID = 498 TID = 139928821278464 mutex=0x7f43cc079528 3950: pthread_mutex_lock log PID = 498 TID = 139928821278464 mutex=0x7f43cc079528 3953: java_lock log-----------PID = 498 TID = 139928821278464 3954: java_lock log-----------PID = 498 TID = 139928821278464 3955: java_lock log-----------PID = 498 TID = 139928821278464 3956: java_lock log-----------PID = 498 TID = 139928821278464 3957: java_lock log-----------PID = 498 TID = 139928821278464 3958: java_lock log-----------PID = 498 TID = 139928821278464 3959: java_lock log-----------PID = 498 TID = 139928821278464 3960: java_lock log-----------PID = 498 TID = 139928821278464 3961: java_lock log-----------PID = 498 TID = 139928821278464 3962: java_lock log-----------PID = 498 TID = 139928821278464 3963: java_lock log-----------PID = 498 TID = 139928821278464 3964: java_lock log-----------PID = 498 TID = 139928821278464 3965: java_lock log-----------PID = 498 TID = 139928821278464 3966: java_lock log-----------PID = 498 TID = 139928821278464 3967: java_lock log-----------PID = 498 TID = 139928821278464 3968: java_lock log-----------PID = 498 TID = 139928821278464 3969: java_lock log-----------PID = 498 TID = 139928821278464 3970: java_lock log-----------PID = 498 TID = 139928821278464 3971: java_lock log-----------PID = 498 TID = 139928821278464 3972: java_lock log-----------PID = 498 TID = 139928821278464 3973: java_lock log-----------PID = 498 TID = 139928821278464 3974: java_lock log-----------PID = 498 TID = 139928821278464 3975: java_lock log-----------PID = 498 TID = 139928821278464 3976: java_lock log-----------PID = 498 TID = 139928821278464 3977: java_lock log-----------PID = 498 TID = 139928821278464 3978: java_lock log-----------PID = 498 TID = 139928821278464 3979: java_lock log-----------PID = 498 TID = 139928821278464 3980: java_lock log-----------PID = 498 TID = 139928821278464 3981: java_lock log-----------PID = 498 TID = 139928821278464 3982: java_lock log-----------PID = 498 TID = 139928821278464 3983: java_lock log-----------PID = 498 TID = 139928821278464 3984: java_lock log-----------PID = 498 TID = 139928821278464 3985: java_lock log-----------PID = 498 TID = 139928821278464 3986: java_lock log-----------PID = 498 TID = 139928821278464 3987: java_lock log-----------PID = 498 TID = 139928821278464 3988: java_lock log-----------PID = 498 TID = 139928821278464 3989: java_lock log-----------PID = 498 TID = 139928821278464 3990: java_lock log-----------PID = 498 TID = 139928821278464 3991: java_lock log-----------PID = 498 TID = 139928821278464 3992: java_lock log-----------PID = 498 TID = 139928821278464 3993: java_lock log-----------PID = 498 TID = 139928821278464 3994: java_lock log-----------PID = 498 TID = 139928821278464 3995: java_lock log-----------PID = 498 TID = 139928821278464 3996: java_lock log-----------PID = 498 TID = 139928821278464 3997: java_lock log-----------PID = 498 TID = 139928821278464 3998: java_lock log-----------PID = 498 TID = 139928821278464 3999: java_lock log-----------PID = 498 TID = 139928821278464 4000: java_lock log-----------PID = 498 TID = 139928821278464 4001: java_lock log-----------PID = 498 TID = 139928821278464 4002: java_lock log-----------PID = 498 TID = 139928821278464 4003: pthread_mutex_lock log PID = 498 TID = 139928821278464 mutex=0x7f43cc0dd028 6.4 é‡é‡çº§é” ä¸Šé¢çš„ä»£ç ï¼Œæˆ‘ä»¬2ä¸ªçº¿ç¨‹ä¸ç­‰å¾…ï¼Œç›´æ¥å¯åŠ¨ åˆ™ä¼šå†åå‘é”çš„æƒ…å†µä¸‹ï¼Œç›´æ¥å‡çº§åˆ°é‡é‡çº§é” out.log å¯ä»¥æ˜æ˜¾çœ‹åˆ° ç³»ç»Ÿé”çš„è°ƒç”¨æµ‹è¯•å˜å¤š 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859606162636465666768697071727374757677787980818283848586878889909192939495969798991001011021031041051061071081091101111121131141151161171181191201211221231241251261271281291301311321331341351361371381391401411421431441451461471481491501511521531541551561571581591601611621631641651661671681691701711721731741751761771781791801811821831841851861871881891901911921931941951961971981992002012022032042052062072082092102112122132142152162172182192202212222232242252262272282292302312322332342352362372382392402412422432442452462472482492502512522532542552562572582592602613750: pthread_mutex_lock log PID = 532 TID = 139648716183296 mutex=0x7f029000b728 3751: pthread_mutex_lock log PID = 532 TID = 139648716183296 mutex=0x7f0290108c28 3756: pthread_mutex_lock log PID = 532 TID = 139648716183296 mutex=0x7f0290108c28 3758: pthread_mutex_lock log PID = 532 TID = 139648647034624 mutex=0x7f029000b728 3759: pthread_mutex_lock log PID = 532 TID = 139648716183296 mutex=0x7f02900b9228 3760: pthread_mutex_lock log PID = 532 TID = 139648647034624 mutex=0x7f029010a528 3770: pthread_mutex_lock log PID = 532 TID = 139648647034624 mutex=0x7f029010a528 3775: pthread_mutex_lock log PID = 532 TID = 139648716183296 mutex=0x7f029d4b28a0 3776: pthread_mutex_lock log PID = 532 TID = 139648716183296 mutex=0x7f029e0fa948 3778: java_lock log-----------PID = 532 TID = 139648716183296 3784: pthread_mutex_lock log PID = 532 TID = 139648647034624 mutex=0x7f0290079528 3785: pthread_mutex_lock log PID = 532 TID = 139648647034624 mutex=0x7f029010a528 3796: java_lock log-----------PID = 532 TID = 139648716183296 3797: pthread_mutex_lock log PID = 532 TID = 139648647034624 mutex=0x7f029010a528 3798: pthread_mutex_lock log PID = 532 TID = 139648647034624 mutex=0x7f029010a128 3799: pthread_mutex_lock log PID = 532 TID = 139648716183296 mutex=0x7f029010a128 3800: java_lock log-----------PID = 532 TID = 139648716183296 3801: pthread_mutex_lock log PID = 532 TID = 139648647034624 mutex=0x7f029010a128 3802: pthread_mutex_lock log PID = 532 TID = 139648647034624 mutex=0x7f029010a128 3803: pthread_mutex_lock log PID = 532 TID = 139648716183296 mutex=0x7f029010a128 3804: java_lock log-----------PID = 532 TID = 139648716183296 3805: pthread_mutex_lock log PID = 532 TID = 139648647034624 mutex=0x7f029010a128 3806: pthread_mutex_lock log PID = 532 TID = 139648647034624 mutex=0x7f029010a128 3807: pthread_mutex_lock log PID = 532 TID = 139648716183296 mutex=0x7f029010a128 3808: java_lock log-----------PID = 532 TID = 139648716183296 3809: pthread_mutex_lock log PID = 532 TID = 139648647034624 mutex=0x7f029010a128 3810: pthread_mutex_lock log PID = 532 TID = 139648647034624 mutex=0x7f029010a128 3811: pthread_mutex_lock log PID = 532 TID = 139648716183296 mutex=0x7f029010a128 3812: java_lock log-----------PID = 532 TID = 139648716183296 3813: pthread_mutex_lock log PID = 532 TID = 139648647034624 mutex=0x7f029010a128 3814: pthread_mutex_lock log PID = 532 TID = 139648647034624 mutex=0x7f029010a128 3815: pthread_mutex_lock log PID = 532 TID = 139648716183296 mutex=0x7f029010a128 3816: java_lock log-----------PID = 532 TID = 139648716183296 3817: pthread_mutex_lock log PID = 532 TID = 139648647034624 mutex=0x7f029010a128 3818: pthread_mutex_lock log PID = 532 TID = 139648647034624 mutex=0x7f029010a128 3819: pthread_mutex_lock log PID = 532 TID = 139648716183296 mutex=0x7f029010a128 3820: java_lock log-----------PID = 532 TID = 139648716183296 3821: pthread_mutex_lock log PID = 532 TID = 139648647034624 mutex=0x7f029010a128 3822: pthread_mutex_lock log PID = 532 TID = 139648647034624 mutex=0x7f029010a128 3823: pthread_mutex_lock log PID = 532 TID = 139648716183296 mutex=0x7f029010a128 3824: java_lock log-----------PID = 532 TID = 139648716183296 3825: pthread_mutex_lock log PID = 532 TID = 139648647034624 mutex=0x7f029010a128 3826: pthread_mutex_lock log PID = 532 TID = 139648647034624 mutex=0x7f029010a128 3827: pthread_mutex_lock log PID = 532 TID = 139648716183296 mutex=0x7f029010a128 3828: java_lock log-----------PID = 532 TID = 139648716183296 3829: pthread_mutex_lock log PID = 532 TID = 139648647034624 mutex=0x7f029010a128 3830: pthread_mutex_lock log PID = 532 TID = 139648647034624 mutex=0x7f029010a128 3831: pthread_mutex_lock log PID = 532 TID = 139648716183296 mutex=0x7f029010a128 3832: java_lock log-----------PID = 532 TID = 139648716183296 3833: pthread_mutex_lock log PID = 532 TID = 139648647034624 mutex=0x7f029010a128 3834: pthread_mutex_lock log PID = 532 TID = 139648647034624 mutex=0x7f029010a128 3835: pthread_mutex_lock log PID = 532 TID = 139648716183296 mutex=0x7f029010a128 3836: java_lock log-----------PID = 532 TID = 139648716183296 3837: pthread_mutex_lock log PID = 532 TID = 139648647034624 mutex=0x7f029010a128 3838: pthread_mutex_lock log PID = 532 TID = 139648647034624 mutex=0x7f029010a128 3839: pthread_mutex_lock log PID = 532 TID = 139648716183296 mutex=0x7f029010a128 3840: java_lock log-----------PID = 532 TID = 139648716183296 3841: pthread_mutex_lock log PID = 532 TID = 139648647034624 mutex=0x7f029010a128 3842: pthread_mutex_lock log PID = 532 TID = 139648647034624 mutex=0x7f029010a128 3843: pthread_mutex_lock log PID = 532 TID = 139648716183296 mutex=0x7f029010a128 3844: java_lock log-----------PID = 532 TID = 139648716183296 3845: pthread_mutex_lock log PID = 532 TID = 139648647034624 mutex=0x7f029010a128 3846: pthread_mutex_lock log PID = 532 TID = 139648647034624 mutex=0x7f029010a128 3847: pthread_mutex_lock log PID = 532 TID = 139648716183296 mutex=0x7f029010a128 3848: java_lock log-----------PID = 532 TID = 139648716183296 3849: pthread_mutex_lock log PID = 532 TID = 139648647034624 mutex=0x7f029010a128 3850: pthread_mutex_lock log PID = 532 TID = 139648647034624 mutex=0x7f029010a128 3851: pthread_mutex_lock log PID = 532 TID = 139648716183296 mutex=0x7f029010a128 3852: java_lock log-----------PID = 532 TID = 139648716183296 3853: pthread_mutex_lock log PID = 532 TID = 139648647034624 mutex=0x7f029010a128 3854: pthread_mutex_lock log PID = 532 TID = 139648647034624 mutex=0x7f029010a128 3855: pthread_mutex_lock log PID = 532 TID = 139648716183296 mutex=0x7f029010a128 3856: java_lock log-----------PID = 532 TID = 139648716183296 3857: pthread_mutex_lock log PID = 532 TID = 139648647034624 mutex=0x7f029010a128 3858: pthread_mutex_lock log PID = 532 TID = 139648647034624 mutex=0x7f029010a128 3859: pthread_mutex_lock log PID = 532 TID = 139648716183296 mutex=0x7f029010a128 3860: java_lock log-----------PID = 532 TID = 139648716183296 3861: pthread_mutex_lock log PID = 532 TID = 139648647034624 mutex=0x7f029010a128 3862: pthread_mutex_lock log PID = 532 TID = 139648647034624 mutex=0x7f029010a128 3863: pthread_mutex_lock log PID = 532 TID = 139648716183296 mutex=0x7f029010a128 3864: java_lock log-----------PID = 532 TID = 139648716183296 3865: pthread_mutex_lock log PID = 532 TID = 139648647034624 mutex=0x7f029010a128 3866: pthread_mutex_lock log PID = 532 TID = 139648647034624 mutex=0x7f029010a128 3867: pthread_mutex_lock log PID = 532 TID = 139648716183296 mutex=0x7f029010a128 3868: java_lock log-----------PID = 532 TID = 139648716183296 3869: pthread_mutex_lock log PID = 532 TID = 139648647034624 mutex=0x7f029010a128 3870: pthread_mutex_lock log PID = 532 TID = 139648647034624 mutex=0x7f029010a128 3871: pthread_mutex_lock log PID = 532 TID = 139648716183296 mutex=0x7f029010a128 3872: java_lock log-----------PID = 532 TID = 139648716183296 3873: pthread_mutex_lock log PID = 532 TID = 139648647034624 mutex=0x7f029010a128 3874: pthread_mutex_lock log PID = 532 TID = 139648647034624 mutex=0x7f029010a128 3875: pthread_mutex_lock log PID = 532 TID = 139648716183296 mutex=0x7f029010a128 3876: java_lock log-----------PID = 532 TID = 139648716183296 3877: pthread_mutex_lock log PID = 532 TID = 139648647034624 mutex=0x7f029010a128 3878: pthread_mutex_lock log PID = 532 TID = 139648647034624 mutex=0x7f029010a128 3879: pthread_mutex_lock log PID = 532 TID = 139648716183296 mutex=0x7f029010a128 3880: java_lock log-----------PID = 532 TID = 139648716183296 3881: pthread_mutex_lock log PID = 532 TID = 139648647034624 mutex=0x7f029010a128 3882: pthread_mutex_lock log PID = 532 TID = 139648647034624 mutex=0x7f029010a128 3883: pthread_mutex_lock log PID = 532 TID = 139648716183296 mutex=0x7f029010a128 3884: java_lock log-----------PID = 532 TID = 139648716183296 3885: pthread_mutex_lock log PID = 532 TID = 139648647034624 mutex=0x7f029010a128 3886: pthread_mutex_lock log PID = 532 TID = 139648647034624 mutex=0x7f029010a128 3887: pthread_mutex_lock log PID = 532 TID = 139648716183296 mutex=0x7f029010a128 3888: java_lock log-----------PID = 532 TID = 139648716183296 3889: pthread_mutex_lock log PID = 532 TID = 139648647034624 mutex=0x7f029010a128 3890: pthread_mutex_lock log PID = 532 TID = 139648647034624 mutex=0x7f029010a128 3891: pthread_mutex_lock log PID = 532 TID = 139648716183296 mutex=0x7f029010a128 3892: java_lock log-----------PID = 532 TID = 139648716183296 3893: pthread_mutex_lock log PID = 532 TID = 139648647034624 mutex=0x7f029010a128 3894: pthread_mutex_lock log PID = 532 TID = 139648647034624 mutex=0x7f029010a128 3895: pthread_mutex_lock log PID = 532 TID = 139648716183296 mutex=0x7f029010a128 3896: java_lock log-----------PID = 532 TID = 139648716183296 3897: pthread_mutex_lock log PID = 532 TID = 139648647034624 mutex=0x7f029010a128 3898: pthread_mutex_lock log PID = 532 TID = 139648647034624 mutex=0x7f029010a128 3899: pthread_mutex_lock log PID = 532 TID = 139648716183296 mutex=0x7f029010a128 3900: java_lock log-----------PID = 532 TID = 139648716183296 3901: pthread_mutex_lock log PID = 532 TID = 139648647034624 mutex=0x7f029010a128 3902: pthread_mutex_lock log PID = 532 TID = 139648647034624 mutex=0x7f029010a128 3903: pthread_mutex_lock log PID = 532 TID = 139648716183296 mutex=0x7f029010a128 3904: java_lock log-----------PID = 532 TID = 139648716183296 3905: pthread_mutex_lock log PID = 532 TID = 139648647034624 mutex=0x7f029010a128 3906: pthread_mutex_lock log PID = 532 TID = 139648647034624 mutex=0x7f029010a128 3907: pthread_mutex_lock log PID = 532 TID = 139648716183296 mutex=0x7f029010a128 3908: java_lock log-----------PID = 532 TID = 139648716183296 3909: pthread_mutex_lock log PID = 532 TID = 139648647034624 mutex=0x7f029010a128 3910: pthread_mutex_lock log PID = 532 TID = 139648647034624 mutex=0x7f029010a128 3911: pthread_mutex_lock log PID = 532 TID = 139648716183296 mutex=0x7f029010a128 3912: java_lock log-----------PID = 532 TID = 139648716183296 3913: pthread_mutex_lock log PID = 532 TID = 139648647034624 mutex=0x7f029010a128 3914: pthread_mutex_lock log PID = 532 TID = 139648647034624 mutex=0x7f029010a128 3915: pthread_mutex_lock log PID = 532 TID = 139648716183296 mutex=0x7f029010a128 3916: java_lock log-----------PID = 532 TID = 139648716183296 3917: pthread_mutex_lock log PID = 532 TID = 139648647034624 mutex=0x7f029010a128 3918: pthread_mutex_lock log PID = 532 TID = 139648647034624 mutex=0x7f029010a128 3919: pthread_mutex_lock log PID = 532 TID = 139648716183296 mutex=0x7f029010a128 3920: java_lock log-----------PID = 532 TID = 139648716183296 3921: pthread_mutex_lock log PID = 532 TID = 139648647034624 mutex=0x7f029010a128 3922: pthread_mutex_lock log PID = 532 TID = 139648647034624 mutex=0x7f029010a128 3923: pthread_mutex_lock log PID = 532 TID = 139648716183296 mutex=0x7f029010a128 3924: java_lock log-----------PID = 532 TID = 139648716183296 3925: pthread_mutex_lock log PID = 532 TID = 139648647034624 mutex=0x7f029010a128 3926: pthread_mutex_lock log PID = 532 TID = 139648647034624 mutex=0x7f029010a128 3927: pthread_mutex_lock log PID = 532 TID = 139648716183296 mutex=0x7f029010a128 3928: java_lock log-----------PID = 532 TID = 139648716183296 3929: pthread_mutex_lock log PID = 532 TID = 139648647034624 mutex=0x7f029010a128 3930: pthread_mutex_lock log PID = 532 TID = 139648647034624 mutex=0x7f029010a128 3931: pthread_mutex_lock log PID = 532 TID = 139648716183296 mutex=0x7f029010a128 3932: java_lock log-----------PID = 532 TID = 139648716183296 3933: pthread_mutex_lock log PID = 532 TID = 139648647034624 mutex=0x7f029010a128 3934: pthread_mutex_lock log PID = 532 TID = 139648647034624 mutex=0x7f029010a128 3935: pthread_mutex_lock log PID = 532 TID = 139648716183296 mutex=0x7f029010a128 3936: java_lock log-----------PID = 532 TID = 139648716183296 3937: pthread_mutex_lock log PID = 532 TID = 139648647034624 mutex=0x7f029010a128 3938: pthread_mutex_lock log PID = 532 TID = 139648647034624 mutex=0x7f029010a128 3939: pthread_mutex_lock log PID = 532 TID = 139648716183296 mutex=0x7f029010a128 3940: java_lock log-----------PID = 532 TID = 139648716183296 3941: pthread_mutex_lock log PID = 532 TID = 139648647034624 mutex=0x7f029010a128 3942: pthread_mutex_lock log PID = 532 TID = 139648647034624 mutex=0x7f029010a128 3943: pthread_mutex_lock log PID = 532 TID = 139648716183296 mutex=0x7f029010a128 3944: java_lock log-----------PID = 532 TID = 139648716183296 3945: pthread_mutex_lock log PID = 532 TID = 139648647034624 mutex=0x7f029010a128 3946: pthread_mutex_lock log PID = 532 TID = 139648647034624 mutex=0x7f029010a128 3947: pthread_mutex_lock log PID = 532 TID = 139648716183296 mutex=0x7f029010a128 3948: java_lock log-----------PID = 532 TID = 139648716183296 3949: pthread_mutex_lock log PID = 532 TID = 139648647034624 mutex=0x7f029010a128 3950: pthread_mutex_lock log PID = 532 TID = 139648647034624 mutex=0x7f029010a128 3951: pthread_mutex_lock log PID = 532 TID = 139648716183296 mutex=0x7f029010a128 3952: java_lock log-----------PID = 532 TID = 139648716183296 3953: pthread_mutex_lock log PID = 532 TID = 139648647034624 mutex=0x7f029010a128 3954: pthread_mutex_lock log PID = 532 TID = 139648647034624 mutex=0x7f029010a128 3955: pthread_mutex_lock log PID = 532 TID = 139648716183296 mutex=0x7f029010a128 3956: java_lock log-----------PID = 532 TID = 139648716183296 3957: pthread_mutex_lock log PID = 532 TID = 139648647034624 mutex=0x7f029010a128 3958: pthread_mutex_lock log PID = 532 TID = 139648647034624 mutex=0x7f029010a128 3959: pthread_mutex_lock log PID = 532 TID = 139648716183296 mutex=0x7f029010a128 3960: java_lock log-----------PID = 532 TID = 139648716183296 3961: pthread_mutex_lock log PID = 532 TID = 139648647034624 mutex=0x7f029010a128 3962: pthread_mutex_lock log PID = 532 TID = 139648647034624 mutex=0x7f029010a128 3963: pthread_mutex_lock log PID = 532 TID = 139648716183296 mutex=0x7f029010a128 3964: java_lock log-----------PID = 532 TID = 139648716183296 3965: pthread_mutex_lock log PID = 532 TID = 139648647034624 mutex=0x7f029010a128 3966: pthread_mutex_lock log PID = 532 TID = 139648647034624 mutex=0x7f029010a128 3967: pthread_mutex_lock log PID = 532 TID = 139648716183296 mutex=0x7f029010a128 3968: java_lock log-----------PID = 532 TID = 139648716183296 3969: pthread_mutex_lock log PID = 532 TID = 139648647034624 mutex=0x7f029010a128 3970: pthread_mutex_lock log PID = 532 TID = 139648647034624 mutex=0x7f029010a128 3971: pthread_mutex_lock log PID = 532 TID = 139648716183296 mutex=0x7f029010a128 3972: java_lock log-----------PID = 532 TID = 139648716183296 3973: pthread_mutex_lock log PID = 532 TID = 139648647034624 mutex=0x7f029010a128 3974: pthread_mutex_lock log PID = 532 TID = 139648647034624 mutex=0x7f029010a128 3975: pthread_mutex_lock log PID = 532 TID = 139648716183296 mutex=0x7f029010a128 3976: java_lock log-----------PID = 532 TID = 139648716183296 3977: pthread_mutex_lock log PID = 532 TID = 139648647034624 mutex=0x7f029010a128 3978: pthread_mutex_lock log PID = 532 TID = 139648647034624 mutex=0x7f029010a128 3979: pthread_mutex_lock log PID = 532 TID = 139648716183296 mutex=0x7f029010a128 3980: java_lock log-----------PID = 532 TID = 139648716183296 3981: pthread_mutex_lock log PID = 532 TID = 139648647034624 mutex=0x7f029010a128 3982: pthread_mutex_lock log PID = 532 TID = 139648647034624 mutex=0x7f029010a128 3983: pthread_mutex_lock log PID = 532 TID = 139648716183296 mutex=0x7f029010a128 3984: java_lock log-----------PID = 532 TID = 139648716183296 3985: pthread_mutex_lock log PID = 532 TID = 139648647034624 mutex=0x7f029010a128 3986: pthread_mutex_lock log PID = 532 TID = 139648647034624 mutex=0x7f029010a128 3987: pthread_mutex_lock log PID = 532 TID = 139648716183296 mutex=0x7f029010a128 3988: java_lock log-----------PID = 532 TID = 139648716183296 3989: pthread_mutex_lock log PID = 532 TID = 139648647034624 mutex=0x7f029010a128 3990: pthread_mutex_lock log PID = 532 TID = 139648647034624 mutex=0x7f029010a128 3991: pthread_mutex_lock log PID = 532 TID = 139648716183296 mutex=0x7f029010a128 3992: pthread_mutex_lock log PID = 532 TID = 139648716183296 mutex=0x7f0290108a28 3993: pthread_mutex_lock log PID = 532 TID = 139648647034624 mutex=0x7f029010a128 3994: java_lock log-----------PID = 532 TID = 139648647034624 3995: java_lock log-----------PID = 532 TID = 139648647034624 3996: java_lock log-----------PID = 532 TID = 139648647034624 3997: java_lock log-----------PID = 532 TID = 139648647034624 3998: java_lock log-----------PID = 532 TID = 139648647034624 3999: java_lock log-----------PID = 532 TID = 139648647034624 4000: java_lock log-----------PID = 532 TID = 139648647034624 4001: java_lock log-----------PID = 532 TID = 139648647034624 4002: java_lock log-----------PID = 532 TID = 139648647034624 4003: java_lock log-----------PID = 532 TID = 139648647034624 4004: java_lock log-----------PID = 532 TID = 139648647034624 4005: java_lock log-----------PID = 532 TID = 139648647034624 4006: java_lock log-----------PID = 532 TID = 139648647034624 4007: java_lock log-----------PID = 532 TID = 139648647034624 4008: java_lock log-----------PID = 532 TID = 139648647034624 4009: java_lock log-----------PID = 532 TID = 139648647034624 4010: java_lock log-----------PID = 532 TID = 139648647034624 4011: java_lock log-----------PID = 532 TID = 139648647034624 4012: java_lock log-----------PID = 532 TID = 139648647034624 4013: java_lock log-----------PID = 532 TID = 139648647034624 4014: java_lock log-----------PID = 532 TID = 139648647034624 4015: java_lock log-----------PID = 532 TID = 139648647034624 4016: java_lock log-----------PID = 532 TID = 139648647034624 4017: java_lock log-----------PID = 532 TID = 139648647034624 4018: java_lock log-----------PID = 532 TID = 139648647034624 4019: java_lock log-----------PID = 532 TID = 139648647034624 4020: java_lock log-----------PID = 532 TID = 139648647034624 4021: java_lock log-----------PID = 532 TID = 139648647034624 4022: java_lock log-----------PID = 532 TID = 139648647034624 4023: java_lock log-----------PID = 532 TID = 139648647034624 4024: java_lock log-----------PID = 532 TID = 139648647034624 4025: java_lock log-----------PID = 532 TID = 139648647034624 4026: java_lock log-----------PID = 532 TID = 139648647034624 4027: java_lock log-----------PID = 532 TID = 139648647034624 4028: java_lock log-----------PID = 532 TID = 139648647034624 4029: java_lock log-----------PID = 532 TID = 139648647034624 4030: java_lock log-----------PID = 532 TID = 139648647034624 4031: java_lock log-----------PID = 532 TID = 139648647034624 4032: java_lock log-----------PID = 532 TID = 139648647034624 4033: java_lock log-----------PID = 532 TID = 139648647034624 4034: java_lock log-----------PID = 532 TID = 139648647034624 4035: java_lock log-----------PID = 532 TID = 139648647034624 4036: java_lock log-----------PID = 532 TID = 139648647034624 4037: java_lock log-----------PID = 532 TID = 139648647034624 4038: java_lock log-----------PID = 532 TID = 139648647034624 4039: java_lock log-----------PID = 532 TID = 139648647034624 4040: java_lock log-----------PID = 532 TID = 139648647034624 4041: java_lock log-----------PID = 532 TID = 139648647034624 4042: java_lock log-----------PID = 532 TID = 139648647034624 4043: java_lock log-----------PID = 532 TID = 139648647034624 4044: pthread_mutex_lock log PID = 532 TID = 139648647034624 mutex=0x7f029010a328 7 æ€»ç»“ æ— é”ï¼Œåå‘é”ï¼Œè½»é‡çº§é”ï¼Œæœ¬è´¨ä¸Šéƒ½JVMå±‚é¢çš„é”ï¼Œé™¤äº†å¼€å§‹å’Œç»“æŸçš„æ—¶å€™ï¼Œæ²¡æœ‰è°ƒç”¨ç³»ç»Ÿé”ã€‚ é‡é‡çº§é”æ˜¯éœ€è¦ ç³»ç»Ÿé” pthread_mutex_lock æ”¯æŒçš„ æ¯ä¸ªçº¿ç¨‹50æ¬¡è°ƒç”¨ï¼Œç³»ç»Ÿé”çš„è°ƒç”¨æ¬¡æ•°ï¼Œæˆ‘ä»¬åŒ…æ‹¬å¼€å§‹å’Œç»“æŸ æ— é” åå‘ è½»é‡çº§ é‡é‡çº§ çº¿ç¨‹æ•°é‡ 1 1 2 2 pthread_mutex_lock è°ƒç”¨æ¬¡æ•° 12 æ¬¡ 12æ¬¡ 14 æ¬¡ 161æ¬¡ å¯¹æ¯” è½»é‡çº§é”å’Œ é‡é‡çº§é”è¿˜æ˜¯ ä¼˜åŒ–æ¯”è¾ƒå¤§çš„ 8 docker é•œåƒå¦‚æœæœ‰éœ€è¦, ä¸Šé¢ docker pull registry.cn-hangzhou.aliyuncs.com/kaiattrib/test:ubuntu16_glibc23 å¸¦ jdk å¸¦ glibc23 æºç ï¼Œå¯ç¼–è¯‘ å¸¦ è‡ªå·±å†™çš„ä¸€ä¸ªjniè°ƒç”¨åº“","link":"/2019/10/18/Java/Ubuntu%E7%BC%96%E8%AF%91glibc%E5%BA%93%E6%9D%A5%E9%AA%8C%E8%AF%81JavaSynchronized%E9%94%81%E4%BC%98%E5%8C%96/"},{"title":"æ·±å…¥ç†è§£ Java HashCode","text":"1. hashcode1.Objectçš„hashcodeé»˜è®¤è°ƒç”¨objectçš„hashcodeçš„è¯ï¼Œä¼šè°ƒç”¨nativeæ–¹æ³•ï¼Œä¸æœ¬åœ°ç›¸å…³ã€‚1public native int hashCode(); æ¥è‡ª ï¼š https://zhuanlan.zhihu.com/p/33915892ä¸‹è½½å®Œæ•´çš„jdkå‘—ï¼ˆopenJDK1.8ï¼‰ã€‚æ‰¾åˆ°Object.cæ–‡ä»¶ï¼ŒæŸ¥çœ‹ä¸Šé¢çš„æ–¹æ³•æ˜ å°„è¡¨å‘ç°ï¼ŒhashCodeè¢«æ˜ å°„åˆ°äº†ä¸€ä¸ªå«JVM_IHashCodeä¸Šå»äº†ã€‚ 1234567static JNINativeMethod methods[] = { {\"hashCode\", \"()I\", (void *)&amp;JVM_IHashCode}, {\"wait\", \"(J)V\", (void *)&amp;JVM_MonitorWait}, {\"notify\", \"()V\", (void *)&amp;JVM_MonitorNotify}, {\"notifyAll\", \"()V\", (void *)&amp;JVM_MonitorNotifyAll}, {\"clone\", \"()Ljava/lang/Object;\", (void *)&amp;JVM_Clone},}; é¡ºè—¤æ‘¸ç“œå»çœ‹çœ‹JVM_IHashCodeåˆ°åº•å¹²äº†ä»€ä¹ˆï¼Ÿç†Ÿæ‚‰çš„å‘³é“ï¼Œåœ¨jvm.hé‡Œé¢æœ‰æ–¹æ³•å£°æ˜ï¼Œé‚£å®ç°ä¸€å®šåœ¨jvm.cppé‡Œé¢ã€‚ä¸è¿‡jvm.cppå¯¹äºJVM_IHashCodeçš„å®ç°è°ƒç”¨çš„æ˜¯ObjectSynchronizer::FastHashCodeçš„æ–¹æ³•ã€‚ 12345JVM_ENTRY(jint, JVM_IHashCode(JNIEnv* env, jobject handle)) JVMWrapper(\"JVM_IHashCode\"); // as implemented in the classic virtual machine; return 0 if object is NULL return handle == NULL ? 0 : ObjectSynchronizer::FastHashCode (THREAD, JNIHandles::resolve_non_null(handle)) ;JVM_END å‘ç°å£°æ˜åœ¨synchronizer.hpp å®ç°åœ¨è¿™é‡Œsynchronizer.cpp 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128129130131132133134135136137138139140141142143144145146147148149150151152153154155156157158159160161162163// hashCode() generation ://// Possibilities:// * MD5Digest of {obj,stwRandom}// * CRC32 of {obj,stwRandom} or any linear-feedback shift register function.// * A DES- or AES-style SBox[] mechanism// * One of the Phi-based schemes, such as:// 2654435761 = 2^32 * Phi (golden ratio)// HashCodeValue = ((uintptr_t(obj) &gt;&gt; 3) * 2654435761) ^ GVars.stwRandom ;// * A variation of Marsaglia's shift-xor RNG scheme.// * (obj ^ stwRandom) is appealing, but can result// in undesirable regularity in the hashCode values of adjacent objects// (objects allocated back-to-back, in particular). This could potentially// result in hashtable collisions and reduced hashtable efficiency.// There are simple ways to \"diffuse\" the middle address bits over the// generated hashCode values:static inline intptr_t get_next_hash(Thread * Self, oop obj) { intptr_t value = 0; if (hashCode == 0) { // This form uses global Park-Miller RNG. // On MP system we'll have lots of RW access to a global, so the // mechanism induces lots of coherency traffic. value = os::random(); } else if (hashCode == 1) { // This variation has the property of being stable (idempotent) // between STW operations. This can be useful in some of the 1-0 // synchronization schemes. intptr_t addrBits = cast_from_oop&lt;intptr_t&gt;(obj) &gt;&gt; 3; value = addrBits ^ (addrBits &gt;&gt; 5) ^ GVars.stwRandom; } else if (hashCode == 2) { value = 1; // for sensitivity testing } else if (hashCode == 3) { value = ++GVars.hcSequence; } else if (hashCode == 4) { value = cast_from_oop&lt;intptr_t&gt;(obj); } else { // Marsaglia's xor-shift scheme with thread-specific state // This is probably the best overall implementation -- we'll // likely make this the default in future releases. unsigned t = Self-&gt;_hashStateX; t ^= (t &lt;&lt; 11); Self-&gt;_hashStateX = Self-&gt;_hashStateY; Self-&gt;_hashStateY = Self-&gt;_hashStateZ; Self-&gt;_hashStateZ = Self-&gt;_hashStateW; unsigned v = Self-&gt;_hashStateW; v = (v ^ (v &gt;&gt; 19)) ^ (t ^ (t &gt;&gt; 8)); Self-&gt;_hashStateW = v; value = v; } value &amp;= markOopDesc::hash_mask; if (value == 0) value = 0xBAD; assert(value != markOopDesc::no_hash, \"invariant\"); TEVENT(hashCode: GENERATE); return value;}intptr_t ObjectSynchronizer::FastHashCode(Thread * Self, oop obj) { if (UseBiasedLocking) { // NOTE: many places throughout the JVM do not expect a safepoint // to be taken here, in particular most operations on perm gen // objects. However, we only ever bias Java instances and all of // the call sites of identity_hash that might revoke biases have // been checked to make sure they can handle a safepoint. The // added check of the bias pattern is to avoid useless calls to // thread-local storage. if (obj-&gt;mark()-&gt;has_bias_pattern()) { // Handle for oop obj in case of STW safepoint Handle hobj(Self, obj); // Relaxing assertion for bug 6320749. assert(Universe::verify_in_progress() || !SafepointSynchronize::is_at_safepoint(), \"biases should not be seen by VM thread here\"); BiasedLocking::revoke_and_rebias(hobj, false, JavaThread::current()); obj = hobj(); assert(!obj-&gt;mark()-&gt;has_bias_pattern(), \"biases should be revoked by now\"); } } // hashCode() is a heap mutator ... // Relaxing assertion for bug 6320749. assert(Universe::verify_in_progress() || DumpSharedSpaces || !SafepointSynchronize::is_at_safepoint(), \"invariant\"); assert(Universe::verify_in_progress() || DumpSharedSpaces || Self-&gt;is_Java_thread() , \"invariant\"); assert(Universe::verify_in_progress() || DumpSharedSpaces || ((JavaThread *)Self)-&gt;thread_state() != _thread_blocked, \"invariant\"); ObjectMonitor* monitor = NULL; markOop temp, test; intptr_t hash; markOop mark = ReadStableMark(obj); // object should remain ineligible for biased locking assert(!mark-&gt;has_bias_pattern(), \"invariant\"); if (mark-&gt;is_neutral()) { hash = mark-&gt;hash(); // this is a normal header if (hash) { // if it has hash, just return it return hash; } hash = get_next_hash(Self, obj); // allocate a new hash code temp = mark-&gt;copy_set_hash(hash); // merge the hash code into header // use (machine word version) atomic operation to install the hash test = obj-&gt;cas_set_mark(temp, mark); if (test == mark) { return hash; } // If atomic operation failed, we must inflate the header // into heavy weight monitor. We could add more code here // for fast path, but it does not worth the complexity. } else if (mark-&gt;has_monitor()) { monitor = mark-&gt;monitor(); temp = monitor-&gt;header(); assert(temp-&gt;is_neutral(), \"invariant\"); hash = temp-&gt;hash(); if (hash) { return hash; } // Skip to the following code to reduce code size } else if (Self-&gt;is_lock_owned((address)mark-&gt;locker())) { temp = mark-&gt;displaced_mark_helper(); // this is a lightweight monitor owned assert(temp-&gt;is_neutral(), \"invariant\"); hash = temp-&gt;hash(); // by current thread, check if the displaced if (hash) { // header contains hash code return hash; } // WARNING: // The displaced header is strictly immutable. // It can NOT be changed in ANY cases. So we have // to inflate the header into heavyweight monitor // even the current thread owns the lock. The reason // is the BasicLock (stack slot) will be asynchronously // read by other threads during the inflate() function. // Any change to stack may not propagate to other threads // correctly. } // Inflate the monitor to set hash code monitor = ObjectSynchronizer::inflate(Self, obj, inflate_cause_hash_code); // Load displaced header and check it has hash code mark = monitor-&gt;header(); assert(mark-&gt;is_neutral(), \"invariant\"); hash = mark-&gt;hash(); if (hash == 0) { hash = get_next_hash(Self, obj); temp = mark-&gt;copy_set_hash(hash); // merge hash code into header assert(temp-&gt;is_neutral(), \"invariant\"); test = Atomic::cmpxchg(temp, monitor-&gt;header_addr(), mark); if (test != mark) { // The only update to the header in the monitor (outside GC) // is install the hash code. If someone add new usage of // displaced header, please update this code hash = test-&gt;hash(); assert(test-&gt;is_neutral(), \"invariant\"); assert(hash != 0, \"Trivial unexpected object/monitor header usage.\"); } } // We finally get the hash return hash;} 2.Java Object.hashCode()è¿”å›çš„æ˜¯å¯¹è±¡å†…å­˜åœ°å€ï¼Ÿä¸æ˜¯ï¼OpenJDK8 é»˜è®¤hashCodeçš„è®¡ç®—æ–¹æ³•æ˜¯é€šè¿‡å’Œå½“å‰çº¿ç¨‹æœ‰å…³çš„ä¸€ä¸ªéšæœºæ•°+ä¸‰ä¸ªç¡®å®šå€¼ï¼Œè¿ç”¨Marsagliaâ€™s xorshift schemeéšæœºæ•°ç®—æ³•å¾—åˆ°çš„ä¸€ä¸ªéšæœºæ•°ã€‚å’Œå¯¹è±¡å†…å­˜åœ°å€æ— å…³ã€‚å½“ç„¶ä¹Ÿå¯ä»¥è‡ªå·±å®ç°hashcodeæ–¹æ³•ï¼Œå…³äºhashcode() ä¸ equals()ã€‚ä¸»è¦æ˜¯åˆ©ç”¨hashcode å¯ä»¥åˆ¤æ–­2ä¸ªå¯¹è±¡çš„ä¸ç­‰ï¼Œhashcodeç›¸ç­‰ï¼Œå¯¹è±¡ä¸ä¸€å®šç›¸ç­‰ï¼Œä½†hashcodeä¸ç­‰ï¼Œå¯ä»¥è‚¯å®š2ä¸ªå¯¹è±¡ä¸ç›¸ç­‰ã€‚åœ¨å¾ˆå¤šåœ°æ–¹åˆ¤æ–­å¯¹è±¡ç­‰ä¸ç­‰ã€‚å¦‚æœequals å®šä¹‰äº†2ä¸ªå¯¹è±¡æ˜¯ç›¸ç­‰çš„ï¼Œéœ€è¦æ³¨æ„hashcodeè¿˜æ˜¯ä¸æ˜¯ç›¸ç­‰çš„ã€‚ 3.Stringç±»çš„hasCode()123456789101112public int hashCode() { int h = hash; if (h == 0 &amp;&amp; value.length &gt; 0) { char val[] = value; for (int i = 0; i &lt; value.length; i++) { h = 31 * h + val[i]; } hash = h; } return h; } 2.ä½¿ç”¨JOLæŸ¥çœ‹å¯¹è±¡ä¿¡æ¯maven ä¾èµ– 12345&lt;dependency&gt; &lt;groupId&gt;org.openjdk.jol&lt;/groupId&gt; &lt;artifactId&gt;jol-core&lt;/artifactId&gt; &lt;version&gt;0.9&lt;/version&gt;&lt;/dependency&gt; ä¸ºäº†å†…å­˜æ¯”è¾ƒâ€œæ•´é½â€ï¼Œå…³é—­å‹ç¼©æŒ‡é’ˆï¼Œå¯åŠ¨å‚æ•°åŠ ä¸Š-XX:-UseCompressedOops 1.æµ‹è¯•å¯¹è±¡123class AAA{ private int number;} 2.æµ‹è¯•æ–¹å¼112345678910111213141516171819202122public static void main(String[] args) { AAA aaa = new AAA(); System.out.println(\"---------before invoke hascode()-----------------\"); System.out.println(ClassLayout.parseInstance(aaa).toPrintable()); /*invoke hashcode() è½¬æ¢æˆ16è¿›åˆ¶*/ System.out.println(Integer.toHexString(aaa.hashCode())); System.out.println(\"------------after invoke hascode()-----------------\"); System.out.println(ClassLayout.parseInstance(aaa).toPrintable()); synchronized (aaa){ System.out.println(\"---------in synchronized() func--------------\"); System.out.println(Integer.toHexString(aaa.hashCode())); System.out.println(ClassLayout.parseInstance(aaa).toPrintable()); System.out.println(Integer.toHexString(aaa.hashCode())); } System.out.println(\"---------after invoke synchronized()--------------\"); System.out.println(Integer.toHexString(aaa.hashCode())); System.out.println(ClassLayout.parseInstance(aaa).toPrintable()); } è¾“å‡º 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051---------before invoke hascode()-----------------AAA object internals: OFFSET SIZE TYPE DESCRIPTION VALUE 0 4 (object header) 01 00 00 00 (00000001 00000000 00000000 00000000) (1) 4 4 (object header) 00 00 00 00 (00000000 00000000 00000000 00000000) (0) 8 4 (object header) a8 35 85 1c (10101000 00110101 10000101 00011100) (478492072) 12 4 (object header) 00 00 00 00 (00000000 00000000 00000000 00000000) (0) 16 4 int AAA.number 0 20 4 (loss due to the next object alignment)Instance size: 24 bytesSpace losses: 0 bytes internal + 4 bytes external = 4 bytes total7e0b37bc------------after invoke hascode()-----------------AAA object internals: OFFSET SIZE TYPE DESCRIPTION VALUE 0 4 (object header) 01 bc 37 0b (00000001 10111100 00110111 00001011) (188201985) 4 4 (object header) 7e 00 00 00 (01111110 00000000 00000000 00000000) (126) 8 4 (object header) a8 35 85 1c (10101000 00110101 10000101 00011100) (478492072) 12 4 (object header) 00 00 00 00 (00000000 00000000 00000000 00000000) (0) 16 4 int AAA.number 0 20 4 (loss due to the next object alignment)Instance size: 24 bytesSpace losses: 0 bytes internal + 4 bytes external = 4 bytes total---------in synchronized() func--------------7e0b37bcAAA object internals: OFFSET SIZE TYPE DESCRIPTION VALUE 0 4 (object header) b0 f4 34 03 (10110000 11110100 00110100 00000011) (53802160) 4 4 (object header) 00 00 00 00 (00000000 00000000 00000000 00000000) (0) 8 4 (object header) a8 35 85 1c (10101000 00110101 10000101 00011100) (478492072) 12 4 (object header) 00 00 00 00 (00000000 00000000 00000000 00000000) (0) 16 4 int AAA.number 0 20 4 (loss due to the next object alignment)Instance size: 24 bytesSpace losses: 0 bytes internal + 4 bytes external = 4 bytes total7e0b37bc---------after invoke synchronized()--------------7e0b37bcAAA object internals: OFFSET SIZE TYPE DESCRIPTION VALUE 0 4 (object header) 01 bc 37 0b (00000001 10111100 00110111 00001011) (188201985) 4 4 (object header) 7e 00 00 00 (01111110 00000000 00000000 00000000) (126) 8 4 (object header) a8 35 85 1c (10101000 00110101 10000101 00011100) (478492072) 12 4 (object header) 00 00 00 00 (00000000 00000000 00000000 00000000) (0) 16 4 int AAA.number 0 20 4 (loss due to the next object alignment)Instance size: 24 bytesSpace losses: 0 bytes internal + 4 bytes external = 4 bytes total å¯ä»¥çœ‹åˆ°ï¼Œåœ¨è°ƒç”¨ä¸€æ¬¡ hashcodeä¹‹åï¼Œå°±ä¼šåœ¨object header ä¸­ç”Ÿæˆhashcodeã€‚æ³¨æ„åŒºåˆ†å¤§å°ç«¯æ¨¡å¼ã€‚ object header åœ¨æœ‰é”çš„æƒ…å†µä¸‹ä¼šå‘ç”Ÿå˜åŒ–ï¼Œä½†æ˜¯ä¸ä¼šæ”¹å˜hashcodeçš„å€¼ã€‚ ä¸ºä»€ä¹ˆæœ‰é”çš„çŠ¶æ€ä¸‹ï¼Œå¤´éƒ¨çš„hashcodeä¼šå˜ã€‚æ— é”å åˆå˜å›æ¥äº†ï¼Ÿè¿™æ˜¯å› ä¸ºheaderä¼šéšç€é”çš„çŠ¶æ€å‘ç”Ÿå˜åŒ–ã€‚åªæœ‰åœ¨æ— é”çš„æƒ…å†µä¸‹ï¼Œæ‰æ˜¯è¿™äº›å­—æ®µã€‚unused:25 | identity_hashcode:31 | unused:1 | age:4 | biased_lock:1 | lock:2 å¦å¤–ï¼Œè°ƒç”¨äº†ä¸€æ¬¡hashcode å°±ä¼šåœ¨æ ˆå¸§ä¸­å­˜åœ¨hashcodeï¼Œä½†æ˜¯ä¸ åå‘é”çš„å­—æ®µå‘ç”Ÿå†²çªï¼Œå› æ­¤jvmé‡‡ç”¨è°ƒç”¨è¿‡hashcodeçš„ï¼Œä¸ä¼šå­˜åœ¨åå‘é”ã€‚ä¸ºä»€ä¹ˆå…¶å®ƒé” å¯ä»¥å‘¢ï¼Ÿå› ä¸ºä¿å­˜äº†æŒ‡å‘æ ˆä¸­é”è®°å½•çš„æŒ‡é’ˆï¼Œå¯ä»¥è®°å½•åœ¨é‡Œé¢ã€‚","link":"/2020/04/21/Java/javahashcode/"},{"title":"pthreadID çº¿ç¨‹ID å¤ç”¨è¯æ˜","text":"èƒŒæ™¯pthread åº“ä¸­æœ‰ä¸€ä¸ª pthread_self() æ¥å£ç”¨æ¥è·å–çº¿ç¨‹ IDï¼Œä½†æ˜¯è¿™ä¸ª IDå¹¶ä¸æ˜¯å†…æ ¸ä¸­é‚£ä¸ªçº¿ç¨‹ IDï¼Œpthread_t åˆ°åº•æ˜¯ä¸ªä»€ä¹ˆæ ·çš„æ•°æ®ç»“æ„å‘¢ï¼Ÿå› ä¸º POSIX æ ‡å‡†å¹¶æ²¡æœ‰é™åˆ¶ pthread_t çš„æ•°æ®ç±»å‹ï¼Œæ‰€ä»¥è¯¥ç±»å‹å–å†³äºå…·ä½“å®ç°ã€‚å¯¹äº Linux ç›®å‰ä½¿ç”¨çš„ NPTL å®ç°è€Œè¨€ï¼Œpthread_t ç±»å‹çš„çº¿ç¨‹ IDï¼Œæœ¬è´¨ä¸Šå°±æ˜¯ä¸€ä¸ªè¿›ç¨‹åœ°å€ç©ºé—´ä¸Šçš„ä¸€ä¸ªåœ°å€ï¼Œè€Œä¸” pthread_t ç±»å‹çš„çº¿ç¨‹ IDå¾ˆæœ‰å¯èƒ½è¢«å¤ç”¨ã€‚è¿›ç¨‹ä¹‹é—´ä¸ä¼šå­˜åœ¨é‡å¤çš„çº¿ç¨‹ IDï¼Œè€Œä¸”ä¸åŒçº¿ç¨‹ä¹‹é—´ä¹Ÿä¸ä¼šé‡å¤ï¼Œåœ¨ä»»æ„æ—¶åˆ»éƒ½æ˜¯å…¨å±€å”¯ä¸€çš„å€¼ã€‚ æ¥æºï¼šåœ¨å­¦ä¹ åå‘é”çš„è¿‡ç¨‹ä¸­ï¼Œåå‘é”æ˜¯ä¸èƒ½é‡æ–°åå‘çš„ï¼Œä¸ºä»€ä¹ˆåœ¨å„ä¸ªçº¿ç¨‹ä¸­å‘ç°éƒ½æ˜¯åå‘åˆ°åŒä¸€ä¸ªçº¿ç¨‹ï¼Ÿ ä¸Šä¸€ä¸ªçº¿ç¨‹æ‹¿åˆ°é”ä¹‹åï¼Œæ˜¯åå‘é”ã€‚ç°åœ¨ä¸€ä¸ªæ–°çº¿ç¨‹æ‹¿åˆ°é”ä¹‹åï¼Œå¯èƒ½å¤ç”¨äº†ä¸Šä¸€ä¸ªIDã€‚JVMåˆ¤æ–­åŠ é”çš„å¯¹è±¡æ˜¯å¯åå‘çš„ï¼Œè¿›ä¸€æ­¥å¯¹æ¯”å‘ç°åå‘çš„çº¿ç¨‹è¿˜æ˜¯å½“å‰çº¿ç¨‹ï¼Œæ‰€ä»¥åå‘é”ä½¿ç”¨æˆåŠŸã€‚å®é™…ä¸Šè¿™æ˜¯ä¸€ä¸ªæ–°çº¿ç¨‹äº†ã€‚å…¶å®è¿™æ ·åŠ ä¸Šåå‘é”æ€§èƒ½è¿˜å¥½äº›ï¼Œå…å¾—å‡çº§é”ã€‚ è¯æ˜JNI native code è·å–çº¿ç¨‹ID 12345JNIEXPORT void JNICALL Java_jnitool_JniTool_getThreadID (JNIEnv * env, jobject obj){ fprintf(stdout,\"java_lock log PID = %d TID = %lu \\n\",getpid(),pthread_self());} æµ‹è¯•ä»£ç ï¼Œè®©çº¿ç¨‹é¡ºåºæ‰§è¡Œã€‚ 123456789101112131415161718192021222324252627282930313233343536373839404142public static void main(String[] args) throws Exception { out.println(\"\\n main ------------------------ start\"); JniTool jniTool = new JniTool(); Thread thread1 = new Thread(new Runnable() { public void run() { out.println(\"t1------------------------ start\"); jniTool.getThreadID(); out.println(\"java getId \"+(Thread.currentThread().getId())); out.println(\"t1------------------------ end\"); } }); thread1.start(); thread1.join(); Thread thread2 = new Thread(new Runnable() { public void run() { out.println(\"t2------------------------start\"); jniTool.getThreadID(); out.println(\"java getId \"+(Thread.currentThread().getId())); out.println(\"t2------------------------end\"); } }); thread2.start(); thread2.join(); Thread thread3 = new Thread(new Runnable() { public void run() { out.println(\"t3------------------------start\"); jniTool.getThreadID(); out.println(\"java getId \"+(Thread.currentThread().getId())); out.println(\"t3------------------------end\"); } }); thread3.start(); thread3.join(); out.println(\"\\n main ------------------------ end\"); }} 123456789101112131415 main ------------------------ startt1------------------------ startjava_lock log PID = 55 TID = 140073151424256 java getId 8t1------------------------ endt2------------------------startjava_lock log PID = 55 TID = 140073151424256 java getId 9t2------------------------endt3------------------------startjava_lock log PID = 55 TID = 140073151424256 java getId 10t3------------------------end main ------------------------ end è§‚å¯Ÿè¾“å‡ºï¼ŒæŸ¥çœ‹çº¿ç¨‹ID ç¡®å®è¢«å¤ç”¨äº†ã€‚","link":"/2019/10/13/Java/pthreadID%E5%A4%8D%E7%94%A8/"},{"title":"static final String ä¸ç±»çš„åŠ è½½ä¸åˆå§‹åŒ–é—®é¢˜","text":"é¢˜ç›® ä¸‹é¢çš„ä»£ç ä¼šä¸ä¼šå¯¼è‡´Studentç±»çš„åŠ è½½ä¸åˆå§‹åŒ–ï¼Ÿ 1234567891011public class ClassLoadTest { public static void main(String[] args) { System.out.println(Student.final_str); }}class Student { //åœ¨ç¼–è¯‘é˜¶æ®µç¼–è¯‘é˜¶æ®µï¼ŒåŠ å…¥åˆ°äº†ç±»çš„å¸¸é‡æ± ä¸­,æ²¡æœ‰ç›´æ¥å¼•ç”¨åˆ°ç±»ï¼Œä¸ä¼šè§¦å‘ç±»çš„åˆå§‹åŒ– static final String final_str = \"final world\"; static String str = \"str world\";} ç­”æ¡ˆæ˜¯ä¸ä¸€å®šä¼šåŠ è½½ç±»ï¼Œä½†ä¸ä¼šåˆå§‹åŒ–ï¼Œä¼šåŠ è½½ç±»å¯ä»¥é€šè¿‡ JVMå‚æ•° -XX:+TraceClassLoading å¾—åˆ°éªŒè¯ ä¹‹å‰ä¹Ÿæœ‰åˆ·è¿‡è¿™æ ·çš„é¢˜ç›®ï¼Œrunä¸€ä¸‹ä»£ç ï¼Œè¿˜çœŸæ˜¯ï¼Œç„¶åçœ‹è§£é‡Šï¼Œå—¯ï¼Œç„¶åå°±æ²¡æœ‰ç„¶åäº†ï¼Œä¹‹å‰çœ‹è¿‡çš„è§£é‡Šæ˜¯è¯´åœ¨ç¼–è¯‘é˜¶æ®µç¼–è¯‘é˜¶æ®µï¼Œç±»çš„å¸¸é‡æ± ä¸­,æ²¡æœ‰ç›´æ¥å¼•ç”¨åˆ°ç±»ï¼Œä¸ä¼šè§¦å‘ç±»çš„åˆå§‹åŒ–ã€‚åé¢ä¹Ÿå°±å¿˜äº† æ‰€ä»¥è¿™æ¬¡æ¥æ·±å…¥éªŒè¯ä¸€ä¸‹ è¿™å¥è¯ â€œåœ¨ç¼–è¯‘é˜¶æ®µç¼–è¯‘é˜¶æ®µï¼ŒåŠ å…¥åˆ°äº†ç±»çš„å¸¸é‡æ± ä¸­â€ï¼Œä¸»è¦å¯¹æ¯” static final String ä¸ static String éªŒè¯ ä½ é€šè¿‡-XX:+TraceClassLoadingæ‰“å°äº†ç±»çš„åŠ è½½ä¿¡æ¯ï¼Œå±…ç„¶æ²¡æœ‰å¯¼è‡´åŠ è½½ç±»ï¼Ÿæ²¡æœ‰åŠ è½½ï¼Ÿç±»çš„éƒ½æ²¡æœ‰åŠ è½½ï¼Œä½ æ€ä¹ˆè®¿é—®ç±»çš„æˆå‘˜å‘¢ï¼Ÿï¼Ÿï¼Ÿ æ›´åŠ æœ‰åŠ›çš„è¯´æ˜å…¶å®å°±æ˜¯åœ¨è°ƒç”¨æ–¹æ³•é‡Œé¢çœ‹åˆ° 123456789101112131415// access flags 0x9 public static main([Ljava/lang/String;)V L0 LINENUMBER 17 L0 GETSTATIC java/lang/System.out : Ljava/io/PrintStream; LDC \"final world\" //è¿™é‡Œç›´æ¥åŠ è½½äº†ä¸€ä¸ªå¸¸é‡ï¼Œå¹¶æ²¡æœ‰è°ƒç”¨æŸä¸€ä¸ªå¯¹è±¡ï¼Œæ‰€ä»¥ç­æœ‰åŠ è½½ç±» INVOKEVIRTUAL java/io/PrintStream.println (Ljava/lang/String;)V L1 LINENUMBER 18 L1 RETURN L2 LOCALVARIABLE args [Ljava/lang/String; L0 L2 0 MAXSTACK = 2 MAXLOCALS = 1} å¦‚æœæ˜¯static stringçš„è¯ï¼Œä¼šæœ‰è°ƒç”¨ç±»çš„ä¿¡æ¯å‡ºæ¥ 1234567891011// access flags 0x9 public static main([Ljava/lang/String;)V L0 LINENUMBER 17 L0 GETSTATIC java/lang/System.out : Ljava/io/PrintStream; GETSTATIC com/test/classload/Student.str : Ljava/lang/String; //è¿™é‡ŒæŒ‡çš„é‚£ä¸ªç±» INVOKEVIRTUAL java/io/PrintStream.println (Ljava/lang/String;)V L1 LINENUMBER 18 L1 RETURN L2 å…¶å®ä¸Šé¢å·²ç»è¯´æ˜äº†ç±»çš„åˆå§‹åŒ–é—®é¢˜ï¼Œä½†æ˜¯æˆ‘ä»¬ç»§ç»­çœ‹ä¸€ä¸‹åŒºåˆ« å…ˆç¼–è¯‘Student ç›´æ¥æŸ¥çœ‹äºŒè¿›åˆ¶class é€šè¿‡åç¼–è¯‘ æŸ¥çœ‹å­—èŠ‚ç ï¼Œæœ‰æ³¨é‡Š 12345678910111213141516171819202122232425262728293031323334// class version 52.0 (52)// access flags 0x20class com/test/classload/Student { // compiled from: ClassLoadTest.java // access flags 0x18 æ³¨æ„åŒºåˆ« è¿™é‡Œç›´æ¥ç»™äº†å€¼ final static Ljava/lang/String; final_str = \"final world\" // access flags 0x8 æ³¨æ„åŒºåˆ« è¿™é‡Œåœ¨ç±»çš„åˆå§‹åŒ–çš„æ—¶å€™ç»™å€¼ static Ljava/lang/String; str // access flags 0x0 å¯¹è±¡çš„initæ–¹æ³• &lt;init&gt;()V L0 LINENUMBER 21 L0 ALOAD 0 INVOKESPECIAL java/lang/Object.&lt;init&gt; ()V RETURN L1 LOCALVARIABLE this Lcom/test/classload/Student; L0 L1 0 MAXSTACK = 1 MAXLOCALS = 1 // access flags 0x8 ç±»çš„initæ–¹æ³•ï¼Œå…¶å®è¿™é‡Œ static &lt;clinit&gt;()V L0 LINENUMBER 24 L0 LDC \"str world\" //çœ‹åˆ°æ²¡æœ‰ï¼Œè¿™é‡Œåªæœ‰å¯¹strçš„èµ‹å€¼ï¼Œå¹¶æ²¡æœ‰å¯¹ final_str è¿›è¡Œèµ‹å€¼ PUTSTATIC com/test/classload/Student.str : Ljava/lang/String; RETURN MAXSTACK = 1 MAXLOCALS = 0} åªçœ‹è¿™é‡Œï¼Œåªèƒ½è¯´æ˜åŒºåˆ«ï¼Œæ²¡æœ‰å®Œå…¨ï¼Œè¯´æ˜é—®é¢˜ï¼Œç›´æ¥çœ‹ä¸€ä¸‹åŸå§‹çš„äºŒè¿›åˆ¶ è¿™å°±æ¶‰åŠåˆ°ï¼Œclassæ–‡ä»¶çš„æ ¼å¼çš„çš„ å¯ä»¥ç®€å•çš„çœ‹åˆ°ï¼Œ16è¿›åˆ¶å¯¹åº”çš„Stringä¿¡æ¯ï¼Œæœ‰æˆ‘ä»¬å†™çš„str worldï¼Œå…¶å®å°±æ˜¯æŒ‰ç…§ä¸€å®šçš„TLVï¼ˆtype length valueï¼‰æ ¼å¼ï¼Œè¿›è¡Œæ•°æ®çš„æ ‡è¯†ã€‚ å…·ä½“çš„æ ¼å¼ä¿¡æ¯ï¼Œæˆ‘ä»¬å¯ä»¥å€Ÿç”¨jclasslibå·¥å…·æ¥å¯è§†åŒ– è¿™å°±classæ–‡ä»¶çš„ä¿¡æ¯æ’åˆ—é¡ºåº å¯ä»¥çœ‹åˆ°æˆ‘ä»¬å®šä¹‰å­—æ®µä¿¡æ¯ï¼Œæ¯”å¦‚strå’Œfinal_strï¼Œä»¥åŠè‡ªåŠ¨ç”Ÿæˆinitçš„æ–¹æ³• æ³¨æ„åˆ°äº†åŒºåˆ«ï¼Œå‘ç°final_stræ˜¯ç›´æ¥æŒ‡å‘äº†å¸¸é‡æ± çš„ä¿¡æ¯çš„ï¼Œè€Œstrå°±æ˜¯ç©ºçš„ï¼Œåªæœ‰å±æ€§ï¼Œæ²¡æœ‰valueä¿¡æ¯ï¼Œéœ€è¦åœ¨class initçš„æ—¶å€™è¿›è¡Œèµ‹å€¼ï¼Œè¿™ä¸ªä¹Ÿç¬¦åˆä¸Šé¢çœ‹åˆ°çš„å­—èŠ‚ç  å¯ä»¥çœ‹åˆ°final_strçš„å±æ€§ä¿¡æ¯å’Œvalueï¼Œå°±æ˜¯æˆ‘ä»¬è‡ªå®šä¹‰çš„ final world ä»¥ä¸Šè¯´æ˜åœ¨ç¼–è¯‘åï¼Œfinal_stråœ¨è¿˜æ²¡æœ‰è¿›è¡Œç±»çš„åˆå§‹åŒ–çš„æ—¶å€™ï¼Œå°±å·²ç»æœ‰äº†å€¼ï¼ŒæŒ‡å‘äº†å¸¸é‡æ± çš„ä¸­çš„å­—ç¬¦ä¸²ã€‚æ€»ç»“ç¼–è¯‘çš„æ—¶å€™ï¼Œç¼–è¯‘å™¨çŸ¥é“ æ—¢ç„¶æ˜¯finalçš„ï¼Œç›´æ¥åœ¨è°ƒç”¨æ”¾åŠ å…¥äº†ï¼Œå…¶å®è¿™æ˜¯ä¸€ç§ç¼–è¯‘å™¨çš„ä¼˜åŒ–ï¼Œä¸ç”¨å»è°ƒç”¨ç±»çš„æ–¹æ³•ï¼Œæ‰€ä»¥æ‰æ²¡æœ‰å¯¼è‡´ç±»çš„åŠ è½½ï¼Œå¹¶ä¸æ˜¯è¯´åªè¦è°ƒç”¨äº†ç±»çš„final static å°±ä¸€å®šæ²¡æœ‰å¯¼è‡´ç±»çš„åˆå§‹åŒ–ï¼Œæ¯”å¦‚é€šè¿‡åå°„ã€‚","link":"/2019/10/21/Java/staticfinalString%E4%B8%8E%E7%B1%BB%E7%9A%84%E5%8A%A0%E8%BD%BD%E4%B8%8E%E5%88%9D%E5%A7%8B%E5%8C%96%E9%97%AE%E9%A2%98/"},{"title":"åˆ†æ Synchronized é”çš„4ä¸ªçŠ¶æ€","text":"1.å‰è¨€é€šè¿‡JOLæŸ¥çœ‹å¯¹è±¡çš„å¤´ä¿¡æ¯ï¼ŒSynchronized å…³é”®å­—é”çš„çŠ¶æ€ï¼šæ— é”ã€åå‘é”ã€è½»é‡çº§é”ã€é‡é‡çº§é” åŸºäº64ä½ jdk8æµ‹è¯• int pthread_mutex_lock(pthread_mutex_t *mutex);pthread_mutex_lock()è¿”å›æ—¶ï¼Œè¯¥äº’æ–¥é”å·²è¢«é”å®šã€‚çº¿ç¨‹è°ƒç”¨è¯¥å‡½æ•°è®©äº’æ–¥é”ä¸Šé”ï¼Œå¦‚æœè¯¥äº’æ–¥é”å·²è¢«å¦ä¸€ä¸ªçº¿ç¨‹é”å®šå’Œæ‹¥æœ‰ï¼Œåˆ™è°ƒç”¨è¯¥çº¿ç¨‹å°†é˜»å¡ï¼Œç›´åˆ°è¯¥äº’æ–¥é”å˜ä¸ºå¯ç”¨ä¸ºæ­¢ã€‚ å¯¹äº Solarisçº¿ç¨‹ï¼Œè¯·å‚è§mutex_lock è¯­æ³• ä¼šé˜»å¡ æˆ‘ä»¬å¯ä»¥ä»JVM æºç ä¸­çœ‹åˆ°å¯¹glibcåº“è°ƒç”¨ï¼Œæ“ä½œç³»ç»Ÿå±‚çº§çš„é” ThreadCritical::ThreadCritical12345678910ThreadCritical::ThreadCritical() { pthread_t self = pthread_self(); if (self != tc_owner) { int ret = pthread_mutex_lock(&amp;tc_mutex); guarantee(ret == 0, \"fatal error with pthread_mutex_lock()\"); assert(tc_count == 0, \"Lock acquired with illegal reentry count.\"); tc_owner = self; } tc_count++;} è¿™ä¸ªæ˜¯åº•å±‚ç³»ç»Ÿåº“ï¼Œæˆ‘ä»¬æ˜¯çœ‹ä¸åˆ°æºç çš„ï¼Œåªèƒ½è‡ªå·±ä¸‹è½½ã€‚å¯ä»¥åœ¨glibc/nptl/phread_mutex_lock.cé‡Œçœ‹åˆ°å®ç°ã€‚ 2.éªŒè¯å‡†å¤‡ å…ˆé€šè¿‡ä¸€ä¸ªjniè°ƒç”¨æ¥è·å–pthreadå±‚é¢çš„tidJniTool.java12345678package jnitool;public class JniTool { static { System.loadLibrary(\"jnitools\"); } public native void getThreadID();} è¿™é‡Œjnitoolå¿…é¡»åœ¨ java.library.pathè¿™ä¸€jvmå˜é‡æ‰€æŒ‡å‘çš„è·¯å¾„ä¸­ï¼Œå¯ä»¥é€šè¿‡å¦‚ä¸‹æ–¹æ³•è·å¾—è¯¥å˜é‡System.getProperty(â€œjava.library.pathâ€); ç”Ÿæˆ.hæ–‡ä»¶ï¼Œjavah -jni jnitool.JniToolæ‰“å°javaçº¿ç¨‹çš„pidå’Œtidï¼Œjvmå±‚é¢ 12345678910#include \"jnitool_JniTool.h\"#include &lt;stdio.h&gt;#include &lt;pthread.h&gt;#include &lt;unistd.h&gt;JNIEXPORT void JNICALL Java_jnitool_JniTool_getThreadID (JNIEnv * env, jobject obj){ fprintf(stdout,\"java_lock log PID = %d TID = %lu \\n\",getpid(),pthread_self()); fflush(stdout);//åˆ·æ–°ï¼Œé˜²æ­¢é”™ä½æ‰“å°} ä½¿ç”¨makeç¼–è¯‘123456vim makefilelibjnitools.so: gcc -lpthread -fPIC -shared -o libjnitools.so -I /root/jdk1.8.0_221/include/ -I /root/jdk1.8.0_221/include/linux/ ./jnitools.c make å¯¹è±¡å¤´ä¿¡æ¯ object header å…³é—­æŒ‡é’ˆå‹ç¼© -XX:-UseCompressedOops å…³äºå¯¹è±¡å¤´ä¿¡æ¯çš„è¯¦æƒ…ä»‹ç»ï¼Œå¯ä»¥ è‡ªå·±å†™ä¸ªå·¥å…·æ–¹æ³•ï¼Œæ ¹æ®markworldè½¬æ¢å‡ºå¤´éƒ¨ä¿¡æ¯ 123456789101112131415|--------------------------------------------------------------------------------------------------------------|| Object Header (128 bits) ||--------------------------------------------------------------------------------------------------------------|| Mark Word (64 bits) | Klass Word (64 bits) | |--------------------------------------------------------------------------------------------------------------|| unused:25 | identity_hashcode:31 | unused:1 | age:4 | biased_lock:1 | lock:2 | OOP to metadata object | æ— é”|----------------------------------------------------------------------|--------|------------------------------|| thread:54 | epoch:2 | unused:1 | age:4 | biased_lock:1 | lock:2 | OOP to metadata object | åå‘é”|----------------------------------------------------------------------|--------|------------------------------|| ptr_to_lock_record:62 | lock:2 | OOP to metadata object | è½»é‡é”|----------------------------------------------------------------------|--------|------------------------------|| ptr_to_heavyweight_monitor:62 | lock:2 | OOP to metadata object | é‡é‡é”|----------------------------------------------------------------------|--------|------------------------------|| | lock:2 | OOP to metadata object | GC|--------------------------------------------------------------------------------------------------------------| æ¥å—JOLè¾“å‡ºï¼Œè‡ªå·±å†™ä¸€ä¸ªè½¬æ¢å·¥å…·ï¼Œæ–¹ä¾¿debug 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556public void parseHeaderInfo(String printable) { String[] split = printable.replaceAll(\"[|)]\", \"\").split(\"\\n\"); StringBuilder builder = new StringBuilder(); for (int i = 2; i &lt;= 3; i++) { builder.append(split[i].split(\"\\\\(\")[2]); } ArrayList&lt;String&gt; strings = new ArrayList&lt;&gt;(Arrays.asList(builder.toString().split(\" \"))); Collections.reverse(strings); builder = new StringBuilder(); for (String string : strings) { builder.append(string); } String markWord = builder.toString(); System.out.println(\"\\n--------START-----------\"); //System.out.println(\"mark world:\"+markWord); String lock = markWord.substring(62); String biased_lock = String.valueOf(markWord.charAt(61)); builder = new StringBuilder(); if (lock.equals(\"01\")) { if (biased_lock.equals(\"0\")) { System.out.println(\"--------æ— é”-----------\"); System.out.println(\"unused:25:\" + markWord.substring(0, 25)); System.out.println(\"identity_hashcode:31: \" + markWord.substring(25, 56) + \" (Hex:\" + Integer.toHexString(Integer.parseInt(markWord.substring(25, 56), 2)) + \")\"); System.out.println(\"unused:1:\" + markWord.substring(56, 57)); System.out.println(\"age:4:\" + markWord.substring(57, 61)); System.out.println(\"biased_lock:1:\" + markWord.substring(61, 62)); System.out.println(\"lock:2:\" + markWord.substring(62)); } else { System.out.println(\"--------åå‘é”--------\"); System.out.println(\"thread:54:\" + markWord.substring(0, 54) +\"(Dex:\"+Long.parseLong(markWord.substring(0, 54), 2)+\")\"); System.out.println(\"epoch:2:\" + markWord.substring(54, 56)); System.out.println(\"unused:1:\" + markWord.substring(56, 57)); System.out.println(\"age:4:\" + markWord.substring(57, 61)); System.out.println(\"biased_lock:1:\" + markWord.substring(61, 62)); } } else { String hexString = Long.toHexString(Long.parseLong(markWord.substring(0, 62), 2)); if (lock.equals(\"00\")) { System.out.println(\"--------è½»é‡çº§é”--------\"); System.out.println(\"ptr_to_lock_record:62:\" + markWord.substring(0, 62) + \" (Hex:\" + hexString + \")\"); System.out.println(\"lock:2:\" + markWord.substring(62)); } else if (lock.equals(\"10\")) { System.out.println(\"--------é‡é‡çº§é”--------\"); System.out.println(\"ptr_to_heavyweight_monitor::62:\" + markWord.substring(0, 62) + \" (Hex:\" + hexString + \")\"); System.out.println(\"lock:2:\" + markWord.substring(62)); } else if (lock.equals(\"11\")) { System.out.println(\"--------GCæ ‡è®°--------\"); } } System.out.println(\"--------END-----------\\n\"); } 3.æ— é” JVMç›´æ¥ä¼˜åŒ–ï¼Œè¿›è¡Œæ— é”è®¿é—®ï¼Œè™½ç„¶åŠ äº†é” 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051import jnitools.JniTools;import org.openjdk.jol.info.ClassLayout;import java.util.ArrayList;import java.util.Arrays;import java.util.Collections;public class SyncTest { final Object lock = new Object(); JniTools jniTool = new JniTools(); public static void main(String[] args) throws InterruptedException { SyncTest test = new SyncTest(); test.parseHeaderInfo((ClassLayout.parseInstance(test.lock).toPrintable())); System.out.println(\"---------------------------start--------------------\"); test.start(); } public void start() throws InterruptedException { Runnable runnable = new Runnable() { int count = 0; @Override public void run() { while (true) { if (count &lt; 100) { count++; } else { return; } try { lock(); parseHeaderInfo(ClassLayout.parseInstance(lock).toPrintable()); Thread.sleep(200); } catch (Exception e) { e.printStackTrace(); } } } }; new Thread(runnable).start(); Thread.sleep(5000); new Thread(runnable).start(); } public void lock() { synchronized (lock) { jniTool.getTid(); } }} åˆ†æï¼Œè™½ç„¶æœ‰å¤šä¸ªçº¿ç¨‹è®¿é—®ï¼Œä½†æ˜¯ä¸å­˜åœ¨ï¼ŒåŒæ—¶ç«äº‰ã€‚ log æ— é”out.log 12345678910111213141516171819202122232425262728293031323334353637383940414243444546--------START-------------------æ— é”-----------unused:25:0000000000000000000000000identity_hashcode:31: 0000000000000000000000000000000 (Hex:0)unused:1:0age:4:0000biased_lock:1:0lock:2:01--------END--------------------------------------start--------------------java_lock log-----------PID = 189 TID = 139775743776512 --------START-------------------æ— é”-----------unused:25:0000000000000000000000000identity_hashcode:31: 0000000000000000000000000000000 (Hex:0)unused:1:0age:4:0000biased_lock:1:0lock:2:01--------END-----------java_lock log-----------PID = 189 TID = 139775743776512 --------START-------------------æ— é”-----------unused:25:0000000000000000000000000identity_hashcode:31: 0000000000000000000000000000000 (Hex:0)unused:1:0age:4:0000biased_lock:1:0lock:2:01--------END-----------java_lock log-----------PID = 189 TID = 139775743776512 --------START-------------------æ— é”-----------unused:25:0000000000000000000000000identity_hashcode:31: 0000000000000000000000000000000 (Hex:0)unused:1:0age:4:0001biased_lock:1:0lock:2:01--------END----------- 4 åå‘é” å½“å…³é—­åå‘é”åŠŸèƒ½æ—¶ ç”±äºå¤šä¸ªçº¿ç¨‹ç«äº‰åå‘é”å¯¼è‡´åå‘é”å‡çº§ä¸ºè½»é‡çº§é”ã€‚ ä¸€å¼€å§‹å°±æ˜¯åå‘é”ï¼Œå¤„äºå¯åå‘ï¼Œè°å…ˆæ¥é”ï¼Œå°±åå‘è°1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253import jnitools.JniTools;import org.openjdk.jol.info.ClassLayout;import java.util.ArrayList;import java.util.Arrays;import java.util.Collections;public class SyncTest { final Object lock = new Object(); JniTools jniTool = new JniTools(); public static void main(String[] args) throws InterruptedException { Thread.sleep(5000); SyncTest test = new SyncTest(); test.parseHeaderInfo((ClassLayout.parseInstance(test.lock).toPrintable())); System.out.println(\"---------------------------start--------------------\"); test.start(); Thread.sleep(50000); } public void start() throws InterruptedException { Runnable runnable = new Runnable() { @Override public void run() { int count = 0; while (true) { if (count &lt; 50) { count++; } else { System.out.println(\"Thread \"+Thread.currentThread().getName()+\" return \"); return; } try { lock(); parseHeaderInfo(ClassLayout.parseInstance(lock).toPrintable()); // Thread.sleep(100); } catch (Exception e) { e.printStackTrace(); } } } }; new Thread(runnable).start(); Thread.sleep(5000); new Thread(runnable).start(); } public void lock() { synchronized (lock) { jniTool.getTid(); } }} Thread.sleep(5000); ä¸»è¦åœ¨çº¿ç¨‹å¯åŠ¨æ—¶å€™åŠ ä¸Šäº†sleep out.log ä¸ºäº†å‡å°‘JVMå¯åŠ¨æ—¶åˆå§‹åŒ–æ—¶é—´ï¼ŒJVMé»˜è®¤å»¶æ—¶åŠ è½½åå‘é”ã€‚å¤§æ¦‚ä¸º4så·¦å³ï¼Œå…·ä½“æ—¶é—´å› æœºå™¨è€Œå¼‚ã€‚å½“ç„¶æˆ‘ä»¬ä¹Ÿå¯ä»¥è®¾ç½®JVMå‚æ•° -XX:BiasedLockingStartupDelay=0 æ¥å–æ¶ˆå»¶æ—¶åŠ è½½åå‘é” ä½ ä¼šå‘ç°å ç”¨ thread å’Œ epoch çš„ ä½ç½®çš„å‡ä¸º0ï¼Œè¯´æ˜å½“å‰åå‘é”å¹¶æ²¡æœ‰åå‘ä»»ä½•çº¿ç¨‹ï¼Œæ­¤æ—¶è¿™ä¸ªåå‘é”æ­£å¤„äºå¯åå‘çŠ¶æ€ã€‚ 12345678910111213141516171819202122232425262728293031--------START-------------------åå‘é”--------thread:54:000000000000000000000000000000000000000000000000000000(Dex:0)epoch:2:00unused:1:0age:4:0000biased_lock:1:1--------END--------------------------------------start--------------------java_lock log-----------PID = 398 TID = 140630884325120 --------START-------------------åå‘é”--------thread:54:000000000000000001111111111001110100010000100001101100(Dex:137335212140)epoch:2:00unused:1:0age:4:0001biased_lock:1:1--------END-----------java_lock log-----------PID = 398 TID = 140630884325120 --------START-------------------åå‘é”--------thread:54:000000000000000001111111111001110100010000100001101100(Dex:137335212140)epoch:2:00unused:1:0age:4:0001biased_lock:1:1--------END----------- Thread Thread-1 return å½“çº¿ç¨‹2å¼€å§‹çš„æ—¶å€™ï¼Œçº¿ç¨‹1å·²ç»“ç»“æŸäº†ï¼Œè¿™é‡Œæ€€ç–‘çº¿ç¨‹å¤ç”¨ï¼Œå› ä¸ºè¿™é‡Œä¸æ»¡è¶³çº¿ç¨‹é‡æ–°åå‘ï¼Œä¸”çº¿ç¨‹æ²¡æœ‰é‡æ–°åå‘ åå‘çš„çº¿ç¨‹æ²¡æœ‰å˜åŒ–ï¼Œä¸”pthreadçš„TIDçš„å¯¹è±¡å¤´çš„é‡Œçš„ä¿¡æ¯éƒ½æ²¡æœ‰å˜åŒ– 12345678910111213141516171819202122java_lock log-----------PID = 398 TID = 140630884325120 --------START-------------------åå‘é”--------thread:54:000000000000000001111111111001110100010000100001101100(Dex:137335212140)epoch:2:00unused:1:0age:4:0001biased_lock:1:1--------END-----------Thread Thread-1 return java_lock log-----------PID = 398 TID = 140630884325120 --------START-------------------åå‘é”--------thread:54:000000000000000001111111111001110100010000100001101100(Dex:137335212140)epoch:2:00unused:1:0age:4:0001biased_lock:1:1--------END----------- 5 è½»é‡çº§é” æˆ‘ä»¬è®©çº¿ç¨‹1æ”¾é”åï¼Œä¸è®©çº¿ç¨‹1é€€å‡º è®©çº¿ç¨‹2å»æ‹¿é” 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748 import jnitool.JniTool;import org.openjdk.jol.info.ClassLayout;import java.util.ArrayList;import java.util.Arrays;import java.util.Collections;public class SyncTest { final Object lock = new Object(); JniTool jniTool = new JniTool(); public static void main(String[] args) throws InterruptedException { Thread.sleep(5000); SyncTest test = new SyncTest(); test.parseHeaderInfo((ClassLayout.parseInstance(test.lock).toPrintable())); System.out.println(\"---------------------------start--------------------\"); test.start(); } public void start() throws InterruptedException { Runnable runnable = new Runnable() { @Override public void run() { int count = 0; System.out.println(Thread.currentThread().getName() + \" t1 start\"); while (true) { if (count &lt; 50) { count++; } else { return; } lock(); } } }; new Thread(runnable).start(); Thread.sleep(1000);//è¿™é‡Œä¿è¯é€€å‡º new Thread(runnable).start(); } public void lock() { synchronized (lock) { Class&lt;?&gt; aClass = lock.getClass(); jniTool.getThreadID(); parseHeaderInfo(ClassLayout.parseInstance(lock).toPrintable()); } }} çº¿ç¨‹1æ‰§è¡Œçš„æ—¶å€™ï¼Œæ˜¯åå‘äº†çº¿ç¨‹1çš„ çº¿ç¨‹1é€€å‡ºï¼Œçº¿ç¨‹2æ¥çš„æ—¶å€™ï¼Œç›´æ¥å‡çº§äº†è½»é‡çº§é” 123456789101112131415161718192021java_lock log PID = 61919 TID = 123145379807232 --------START-----------Thread-1--------åå‘é”--------thread:54:000000000000000001111111110000101010110100010011100100(Dex:137181742308)epoch:2:00unused:1:0age:4:0000biased_lock:1:1--------END-----------Thread-1Thread-2 t1 startjava_lock log PID = 61919 TID = 123145379807232 --------START-----------Thread-2--------è½»é‡çº§é”--------ptr_to_lock_record:62:00000000000000000111000000000000000001001001111001111000001110 (Hex:1c0001279e0e)lock:2:00--------END-----------Thread-2java_lock log PID = 61919 TID = 123145379807232 6. é‡é‡çº§é” åå‘é”ç›´æ¥å‡çº§ 2ä¸ªçº¿ç¨‹ï¼ŒåŒæ—¶å¹¶å‘è®¿é—® 12345678910111213141516171819202122232425262728293031323334353637383940414243444546import jnitool.JniTool;import org.openjdk.jol.info.ClassLayout;import java.util.ArrayList;import java.util.Arrays;import java.util.Collections;public class SyncTest { final Object lock = new Object(); JniTool jniTool = new JniTool(); public static void main(String[] args) throws InterruptedException { Thread.sleep(5000); SyncTest test = new SyncTest(); test.parseHeaderInfo((ClassLayout.parseInstance(test.lock).toPrintable())); System.out.println(\"---------------------------start--------------------\"); test.start(); } public void start() throws InterruptedException { Runnable runnable = new Runnable() { @Override public void run() { int count = 0; System.out.println(Thread.currentThread().getName() + \" t1 start\"); while (true) { if (count &lt; 50) { count++; } else { return; } lock(); } } }; new Thread(runnable).start(); new Thread(runnable).start(); } public void lock() { synchronized (lock) { Class&lt;?&gt; aClass = lock.getClass(); jniTool.getThreadID(); parseHeaderInfo(ClassLayout.parseInstance(lock).toPrintable()); } }} ä»å¯åå‘çŠ¶æ€ï¼Œç›´æ¥å‡çº§ä¸ºé‡é‡çº§é”ã€‚ 12345678910111213141516171819--------START-----------main--------åå‘é”--------thread:54:000000000000000000000000000000000000000000000000000000(Dex:0)epoch:2:00unused:1:0age:4:0000biased_lock:1:1--------END-----------main---------------------------start--------------------Thread-1 t1 startThread-2 t1 startjava_lock log PID = 61884 TID = 123145554096128 --------START-----------Thread-1--------é‡é‡çº§é”--------ptr_to_heavyweight_monitor::62:00000000000000000111111110101101000111010000000110001011010010 (Hex:1feb474062d2)lock:2:10--------END-----------Thread-1 æ€»ç»“ åˆå§‹çŠ¶æ€å¯èƒ½æ˜¯åå‘é”çš„å¯åå‘çŠ¶æ€ï¼Œä¹Ÿå¯èƒ½æ˜¯æ— é”çŠ¶æ€ åˆå§‹é”ï¼Œè‹¥åªæœ‰ä¸€ä¸ªçº¿ç¨‹è¿ç»­çš„å¤šæ¬¡è®¿é—®ï¼Œæ„æˆé”çš„åå‘ ä¸æ„æˆé”çš„é‡æ–°åå‘æƒ…å†µä¸‹ï¼Œåé¢æœ‰å¤šä¸ªçº¿ç¨‹è½®æµè®¿é—®ï¼Œä¸æ„æˆé”çš„ç«äº‰ï¼Œé”å‡çº§åˆ°è½»é‡çº§é” å¯ä»¥æœ‰è¿ç»­çŠ¶æ€ï¼Œè¿ç»­é”çš„å‡çº§ã€‚","link":"/2019/10/17/Java/synchronized4%E7%A7%8D%E9%94%81/"},{"title":"ä»ContextClassLoaderåˆ°JDBCå’ŒSPI","text":"SystemClassLoaderå¯ä»¥jvmå‚æ•° java.system.class.loader è®¾ç½®é»˜è®¤çš„ç³»ç»ŸåŠ è½½å™¨ï¼Œé»˜è®¤æ˜¯å½“å‰çº¿ç¨‹çš„ContextClassLoaderã€‚æ¥è‡ªsun.misc.Launcher.getLauncherçš„getClassLoader, è€ŒgetLauncherçš„getClassLoaderå®é™…æ¥è‡ªLauncher.AppClassLoader.getAppClassLoaderã€‚ ContextClassLoader ä¸»è¦ç”¨äºæ‰“ç ´åŒäº²æ¨¡å‹ä¸€ä¸ªå…¸å‹çš„ä¾‹å­å°±æ˜¯JDBCï¼ŒJDBCçš„è§„èŒƒç±»æ˜¯åœ¨rt.jaråŒ…é‡Œé¢çš„ï¼Œé»˜è®¤æ˜¯ç”±BootstrapClassLoadråŠ è½½çš„ï¼Œæ‰€ä»¥JDBCæ‰€ä¾èµ–çš„ç±»ï¼Œæ¯”å¦‚æˆ‘ä»¬è‡ªå·±å®ç°çš„MYSQLï¼Œä¹Ÿåº”è¯¥æ˜¯ç”±BootstrapClassLoadræ¥åŠ è½½ï¼Œä½†æ˜¯æˆ‘ä»¬çš„MYSQLåŒ…è·¯å¾„å¹¶ä¸åœ¨BootstrapClassLoadråŠ è½½çš„è·¯å¾„å½“ä¸­ï¼Œè¿™æ ·å°±ä¼šå‡ºç°æ‰¾ä¸åˆ°ç±»çš„æƒ…å†µã€‚æ‰€ä»¥åœ¨è¿™ç§æƒ…å†µä¸‹é¢ï¼Œæˆ‘ä»¬å°±éœ€è¦æ‰“ç ´åŒäº²å§”æ´¾æ¨¡å‹ï¼ŒContextClassLoaderå°±åº”è¿è€Œç”Ÿã€‚åœ¨BootstrapClassLoadråŠ è½½ä¸åˆ°çš„æƒ…å½¢ä¸‹é¢ï¼Œç”±BootstrapClassLoadrè½¬æ¥åˆ°å½“å‰çº¿ç¨‹çš„ContextClassLoaderæ¥åŠ è½½ã€‚åœ¨SPIåœºåˆä¸‹éƒ½ä¼šå‡ºç°ï¼ŒSPIå°±æ˜¯JDKæä¾›æ¥å£ï¼Œå…·ä½“å®ç°ç”±å„ä¸ªå‚å•†å®ç°ï¼Œæœ€åç”±ServiceLoaderæ¥è¿›è¡ŒåŠ è½½ã€‚ SPIçš„å…³é”®ï¼ŒServiceLoader SPIçš„å…·ä½“å®ç°ï¼Œä¹Ÿå°±æ˜¯jaråŒ…åœ¨serviceç”±ServiceLoaderçš„loadæ–¹æ³•å‡ºè§¦å‘ å£°æ˜ï¼Œæ³›å‹ï¼Œä¸”å®ç°äº†è¿­ä»£æ¥å£ 1public final class ServiceLoader&lt;S&gt; implements Iterable&lt;S&gt; æˆ‘ä»¬å¯ä»¥çœ‹ä¸€ä¸‹jdocé‡Œé¢çš„æè¿° A service provider is identified by placing a provider-configuration file in the resource directory META-INF/services. The fileâ€™s name is the fully-qualified binary name of the serviceâ€™s type. The file contains a list of** fully-qualified binary names of concrete provider classes**, one per line. Space and tab characters surrounding each name, as well as blank lines, are ignored. The comment character is â€˜#â€™ (â€˜\\u0023â€™, NUMBER SIGN); on each line all characters following the first comment character are ignored. The file must be encoded in UTF-8. è¿™å®é™…ä¸Šå°±æè¿°äº†ï¼Œserviceçš„æ¥å£å’Œå…·ä½“å®ç°ç±»å£°æ˜å…·ä½“ä½ç½®ã€‚ è·Ÿè¸ªJDBCåŠ è½½çš„è¿‡ç¨‹ é¦–å…ˆå¼•å…¥myqlå’Œoracleçš„JDBCåŒ… å®‰è£…è¿‡ç¨‹ä¸­å‘ç°maven pomå¯¼å…¥å¤±è´¥ mvn æ‰‹åŠ¨å®‰è£… 1mvn install:install-file -Dfile=/Users/kenchan/ojdbc7-12.1.0.2.jar -DgroupId=oracle -DartifactId=ojdbc7 -Dversion=12.1.0.2 -Dpackaging=jar æ¥å£å°±æ˜¯ java.sql.Driverï¼Œæ˜¯JDKå®ç°çš„è§„èŒƒã€‚ æˆ‘ä»¬å¯ä»¥çœ‹åˆ°mysqlå’Œoracleçš„jar åŒ…ä¸­çš„serviceå£°æ˜ å…·ä½“çš„å®ç°ç±»åˆ†åˆ«æ˜¯ com.mysql.cj.jdbc.Driver ï¼Œoracle.jdbc.OracleDriverç±» æµ‹è¯•ä»£ç ï¼Œæˆ‘ä»¬ç”¨ServiceLoader.loadå»åŠ è½½ä¸€æ¬¡java.sql.Driver.class 12345//ServiceLoaderæœåŠ¡æä¾›è€…ï¼ŒåŠ è½½å®ç°çš„æœåŠ¡ ServiceLoader&lt;java.sql.Driver&gt; loader = ServiceLoader.load(java.sql.Driver.class); for (java.sql.Driver driver : loader) { System.out.println(\"driver:\" + driver.getClass() + \",loader\" + driver.getClass().getClassLoader()); } å¯ä»¥çœ‹åˆ°æˆ‘ä»¬å°±æ˜¯æŠŠjaråŒ…å¯¼å…¥ç¯å¢ƒï¼Œä»€ä¹ˆéƒ½æ²¡åšï¼Œå°±å·²ç»æ˜¾ç¤ºåŠ è½½æˆåŠŸäº†JDBCçš„2ä¸ªå®ç°å¯¹è±¡ è€Œä¸”å¯ä»¥çœ‹åˆ°ä»–æ˜¯ç”±AppClassLoaderåŠ è½½çš„ï¼Œä½†java.sql.Driveræ˜¯ç”±BoostrapClassLoaderåŠ è½½çš„ã€‚ 12driver:class com.mysql.cj.jdbc.Driver,loadersun.misc.Launcher$AppClassLoader@135fbaa4driver:class oracle.jdbc.OracleDriver,loadersun.misc.Launcher$AppClassLoader@135fbaa4 é¦–å…ˆå¯ä»¥çœ‹åˆ° ** java.util.ServiceLoader#load(java.lang.Class)** 12345//åœ¨è¿™é‡Œå»è·å–äº† ContextClassLoaderpublic static &lt;S&gt; ServiceLoader&lt;S&gt; load(Class&lt;S&gt; service) { ClassLoader cl = Thread.currentThread().getContextClassLoader(); return ServiceLoader.load(service, cl); } è½¬æ¥åˆ°java.util.ServiceLoader#ServiceLoader(Class svc, ClassLoader cl) 123456private ServiceLoader(Class&lt;S&gt; svc, ClassLoader cl) { //å¦‚æœçº¿ç¨‹ ContextClassLoader ä¸ºnullï¼Œåˆ™é€‰ç”¨SystemClassLoaderï¼Œä¹Ÿå°±æ˜¯AppClassLoaderå»åŠ è½½ loader = (cl == null) ? ClassLoader.getSystemClassLoader() : cl; acc = (System.getSecurityManager() != null) ? AccessController.getContext() : null; reload(); } reload()é‡Œé¢æ˜¯newäº†ä¸€ä¸ªLazyIterator å°±èµ°äº†ã€‚å®é™…åŠ è½½æ˜¯ä½¿ç”¨çš„æ—¶å€™ï¼ŒåŠæ—¶è°ƒç”¨è¿­ä»£å™¨nextè·å–çš„æ—¶å€™ï¼Œ 1234567891011public S next() { if (acc == null) { //å°±æ˜¯è¿™é‡Œ return nextService(); } else { PrivilegedAction&lt;S&gt; action = new PrivilegedAction&lt;S&gt;() { public S run() { return nextService(); } }; return AccessController.doPrivileged(action, acc); } } åœ¨java.util.ServiceLoader.LazyIterator#hasNextService é‡Œé¢åšäº†æ‰«æï¼Œä»META-INF/services/é‡Œé¢å»è¯»å–å…·ä½“çš„å®ç°ç±»ï¼Œä¿ç•™äº†nextName é‚£ServiceLoaderæ€ä¹ˆçŸ¥é“åªåŠ è½½JDBCå‘¢ï¼Ÿå…¶å®ƒçš„serviceå®ƒä¸åŠ è½½ï¼Ÿï¼Ÿï¼Ÿ è¿™å°±æ˜¯é€šè¿‡String fullName = _PREFIX _+ service.getName();é™å®šæ¥è·å–çš„ï¼Œservice.getName() æˆ‘ä»¬ä¼ å…¥çš„æ³›å‹åŠæ—¶serviceå°±æ˜¯java.sql.Driverï¼Œä¹Ÿå¯ä»¥ä»ä¸Šé¢çœ‹åˆ°jaråŒ…ä¸­çš„serviceä¸‹çš„æ–‡ä»¶åå°±æ˜¯æ¥å£ã€‚ 123456789101112131415161718192021222324252627private boolean hasNextService() { if (nextName != null) { return true; } if (configs == null) { try { //ç†Ÿæ‚‰çš„æ ·å­ï¼Œè¿™é‡Œå°±æ˜¯ä»META-INF/services/è·å–å…·ä½“çš„ç±»é™å®šå String fullName = PREFIX + service.getName(); //è¿™é‡Œå°±æ˜¯å»è¯»åˆ°äº†å…·ä½“çš„å®ç°ç±»åç§° if (loader == null) configs = ClassLoader.getSystemResources(fullName); else configs = loader.getResources(fullName); } catch (IOException x) { fail(service, \"Error locating configuration files\", x); } } while ((pending == null) || !pending.hasNext()) { if (!configs.hasMoreElements()) { return false; } pending = parse(service, configs.nextElement()); } //æ¯”å¦‚è¿™é‡Œå°±å¯èƒ½è·å–åˆ°com.mysql.cj.jdbc.Driver nextName = pending.next(); return true; } è½¬æ¥åˆ° java.util.ServiceLoader.LazyIterator#nextService é‡Œé¢ï¼Œè¿™é‡Œå®é™…ä¸Šå°±æ˜¯é€šè¿‡åå°„åšäº†çœŸæ­£çš„åŠ è½½ 12345678910111213141516171819202122232425262728293031private S nextService() { if (!hasNextService()) throw new NoSuchElementException(); //nextNameå°±æ˜¯ä¸Šé¢è·å–åˆ°çš„ String cn = nextName; nextName = null; Class&lt;?&gt; c = null; try { //è¿™é‡Œåå°„è·å–ï¼Œå¯ä»¥çœ‹åˆ°ç”¨åˆ°äº†loader å°±æ˜¯ContextClassLoaderã€‚ c = Class.forName(cn, false, loader); } catch (ClassNotFoundException x) { fail(service, \"Provider \" + cn + \" not found\"); } if (!service.isAssignableFrom(c)) { fail(service, \"Provider \" + cn + \" not a subtype\"); } //é€šè¿‡åå°„ï¼Œåˆ©ç”¨æˆ‘ä»¬è‡ªå®šçš„ContextClassLoader åšäº†åŠ è½½ä¹‹åï¼Œå°±æ˜¯åˆ©ç”¨åå°„ç”Ÿæˆä¸€ä¸ªå®ä¾‹ï¼Œæ”¾åˆ°ç¼“é‡Œé¢ try { S p = service.cast(c.newInstance()); providers.put(cn, p); return p; } catch (Throwable x) { fail(service, \"Provider \" + cn + \" could not be instantiated\", x); } throw new Error(); // This cannot happen } åˆ°æ­¤ï¼ŒJDBCçš„å®ç°ç±»åŠ è½½å®Œæ¯• æˆ‘ä»¬ç”¨JDBC æ²¡æœ‰åƒè¿™æ ·å»æ‰loaderå•Šï¼Ÿï¼Ÿï¼Ÿå…¶å®ä½ åœ¨ç”¨java.sql.DriverManagerçš„æ—¶å€™ï¼Œjava.sql.DriverManager#loadInitialDriversé‡Œé¢ è°ƒç”¨äº†ServiceLoader.load(Driver.class); æ€»ç»“ åŒäº²å§”æ´¾æ¨¡å‹åœ¨SPIæœºåˆ¶ä¸‹é¢ç¼ºé™·ï¼Œä¸èƒ½åŠ è½½å…·ä½“çš„å®ç°ç±» JDKé‡‡ç”¨ContextClassLoaderå¯ä»¥è®©æˆ‘ä»¬è‡ªå®šåŠ è½½å™¨å»åŠ è½½å…·ä½“çš„å®ç°ç±» å…·ä½“çš„å®ç°ç±»ï¼Œå½’ç»“åˆ°åå°„æ–¹æ³•ï¼Œå¯ä»¥è®©åŠ è½½ç±»çš„æ—¶å€™ï¼ŒæŒ‡å®šå…·ä½“çš„ClassLoader1public static Class&lt;?&gt; forName(String name, boolean initialize,ClassLoader loader)","link":"/2020/05/29/Java/%E4%BB%8EContextClassLoader%E5%88%B0JDBC%E5%92%8CSPI/"},{"title":"å…³äºä¿®æ”¹å’Œä»£ç†Finalç±»å’Œæ–¹æ³•ï¼Ÿ","text":"èƒŒæ™¯cglibæ˜¯åŸºäºç»§æ‰¿çš„ä»£ç†çš„ï¼Œä½†æ˜¯finalä¿®é¥°çš„ç±»çš„æ–¹æ³•ä¸èƒ½è¢«ä»£ç†ï¼Œæ¯•ç«Ÿè™šæ‹Ÿæœºè§„èŒƒé™å®šäº†finalå…³é”®å­—ï¼Œæƒ³è¦å®ç°ä»£ç†çš„åŠŸèƒ½ï¼Œè‡ªå·±ä¸è¦åŠ ä¸Šfinalå°±æ˜¯äº†ã€‚ä½†æ˜¯ç°åœ¨åˆ«äººå†™å¥½äº†åº“é‡Œçš„ç±»ï¼Œä¸æ–¹ä¾¿ä¿®æ”¹æƒ³è¦å°è¯•ã€‚ 1.è‡ªå®šä¹‰Classloaderï¼Œåˆ©ç”¨ASMå»æ‰finalå…³é”®å­—jvmåˆ©ç”¨åŒäº²å§”æ´¾æœºåˆ¶åŠ è½½ç±»ï¼Œä¼˜å…ˆå°è¯•è®©çˆ¶ç±»åŠ è½½ï¼Œçˆ¶ç±»åŠ è½½æˆåŠŸï¼Œè‡ªå·±å°±æ²¡æœ‰æœºä¼šåŠ è½½ï¼Œè¿™æ˜¯å®‰å…¨å’Œé˜²æ­¢é‡å¤åŠ è½½çš„æœºåˆ¶ã€‚é»˜è®¤æƒ…å†µä¸‹è‡ªå·±å†™çš„classæ˜¯ç¨‹åºåŠ è½½å™¨åŠ è½½çš„ï¼Œjvmè®¤ä¸ºClassloder+ç±»è·¯å¾„å å®Œå…¨ä¸€æ ·æ‰æ˜¯ç›¸åŒçš„ä¸€ä¸ªclassã€‚æ‰€ä»¥ç”¨è‡ªå·±çš„åŠ è½½å™¨åŠ è½½çš„ç±»ï¼Œæ²¡æ³•è½¬æ¢æˆä¸ºä¹‹å‰çš„çš„å¼•ç”¨ã€‚æƒ³è¦è°ƒç”¨å’Œè®¿é—®ï¼Œä¹Ÿåªèƒ½åˆ©ç”¨åå°„ã€‚ æ¯”å¦‚è¿™æ ·æ˜¯ä¸è¡Œçš„ 1Person person = new MyClassLoaderï¼ˆPerson.class).newInstance() 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556public class MyClassLoader extends ClassLoader { public MyClassLoader() { //æŒ‡å®šçˆ¶åŠ è½½å™¨ä¸ºnull super(null); } @Override protected Class&lt;?&gt; findClass(String name) throws ClassNotFoundException { System.out.println(\"findClass: \"+name); try { ClassReader reader = new ClassReader(name); ClassWriter writer = new ClassWriter(reader, 0); RemoveFinalFlagClassVisitor classVisitor = new RemoveFinalFlagClassVisitor(writer); reader.accept(classVisitor, ClassReader.SKIP_CODE); byte[] bytes = writer.toByteArray(); return defineClass(name, bytes, 0, bytes.length); } catch (IOException e) { e.printStackTrace(); } return null; }}// åˆ©ç”¨ClassVisitorå»æ‰finalçš„ä¿®é¥°class RemoveFinalFlagClassVisitor extends ClassVisitor { public RemoveFinalFlagClassVisitor(ClassVisitor cv) { super(Opcodes.ASM5, cv); } @Override public void visit(int version, int access, String name, String signature, String superName, String[] interfaces) { // we have the final flag if((access &amp; Opcodes.ACC_FINAL) == Opcodes.ACC_FINAL) { //remove the final flag access = access ^ Opcodes.ACC_FINAL; }// åœ¨è°ƒç”¨super.visitçš„æ—¶å€™ï¼Œæˆ‘ä»¬å°±å·²ç»æŠŠfinalå…³é”®å­—å»æ‰äº† super.visit(version, access, name, signature, superName, interfaces); } @Override public MethodVisitor visitMethod(int i, String s, String s1, String s2, String[] strings) { /*å¯ä»¥åœ¨è¿™é‡Œä¿®æ”¹finalä¿®é¥°éæ–¹æ³• è¿™é‡Œå¯ä»¥åˆ©ç”¨debugæŸ¥çœ‹ä¿®é¥°çš„ç‰¹å¾å€¼ */ if (i==17){ return super.visitMethod(1, s, s1, s2, strings); } return super.visitMethod(i, s, s1, s2, strings); }} æµ‹è¯•æµ‹è¯•ç±» 123456789101112final public class Manager{ private static int AAA = 1; private static int BBB = 2; private static int CCC = 3; final public void testFinal(){ System.out.println(\"test\"); } public void testPublic(){ System.out.println(\"test\"); }} æµ‹è¯•æ–¹æ³• 1234567MyClassLoader myClassLoader = new MyClassLoader(); Class&lt;?&gt; aClass = myClassLoader.loadClass(Manager.class.getName()); System.out.println(Modifier.toString(aClass.getModifiers())); Method[] methods = aClass.getDeclaredMethods(); for (Method method : methods) { System.out.println(Modifier.toString(method.getModifiers())); } æµ‹è¯•ç»“æœ 1234findClass: test.Managerpublicpublicpublic","link":"/2019/09/28/Java/%E5%85%B3%E4%BA%8E%E4%BF%AE%E6%94%B9%E5%92%8C%E4%BB%A3%E7%90%86Final%E7%B1%BB/"},{"title":"ä»¿å†™ä¸€ä¸ªJava Thread åº•å±‚å®ç°","text":"Javaé‡Œçš„çº¿ç¨‹å’Œæ“ä½œç³»ç»Ÿçš„çº¿ç¨‹æ˜¯ä¸€ä¸€å¯¹åº”çš„ï¼Œä¸ºäº†æ–¹ä¾¿ç†è§£Thread ç±»çš„åº•å±‚å®ç°ï¼Œæˆ‘ä»¬å¯ä»¥è‡ªå·±æ¥ä»¿é€ ä¸€ä¸ªMyThread, åŒæ ·æ¥å—ä¸€ä¸ªRunableæ¥å£ï¼Œè°ƒç”¨startå®ç°runæ–¹æ³•ã€‚ è¿™æ˜¯è¦å®ç°çš„ç±» 1234567public class MyThread { Runnable mRunnable; public MyThread(Runnable runnable) { mRunnable = runnable; } native public void start();} é‚£ä¹ˆæˆ‘ä»¬å…ˆå»å®ç°nativeæ–¹æ³•12345678910111213141516171819202122232425#define TAG \"native-lib\" // è¿™ä¸ªæ˜¯è‡ªå®šä¹‰çš„LOGçš„æ ‡è¯†#define LOGD(...) __android_log_print(ANDROID_LOG_DEBUG,TAG,__VA_ARGS__) // å®šä¹‰LOGDç±»å‹JavaVM *jvm = 0;jclass RunnableClass = NULL;extern \"C\"JNIEXPORT void JNICALLJava_com_test_MyThread_start(JNIEnv *env, jobject thiz) { LOGD(\"java invoke start()---------------start\"); jclass MyThreadClass = env-&gt;FindClass(\"com/test/MyThread\"); RunnableClass = (jclass) env-&gt;NewGlobalRef(env-&gt;FindClass(\"java/lang/Runnable\")); jfieldID runnableID = env-&gt;GetFieldID(MyThreadClass, \"mRunnable\", \"Ljava/lang/Runnable;\"); jobject mRunnable = env-&gt;NewGlobalRef(env-&gt;GetObjectField(thiz, runnableID)); pthread_t tid; int ret_t = -1; ret_t = pthread_create(&amp;tid, NULL, new_thread, mRunnable); pthread_detach(tid); if (ret_t != 0) { printf(\"pthread_create error \\n\"); return; } LOGD(\"java invoke start()---------------end\"); return;} java è°ƒç”¨äº†startæ–¹æ³•è¿›å…¥ c å±‚é¢ï¼Œæ¥ä¸‹æ¥ ä¸»è¦æ˜¯é€šè¿‡pthreadåˆ›å»ºæ–°çº¿ç¨‹ï¼Œåœ¨æ–°çº¿ç¨‹é‡Œé¢åè°ƒjavaé‡Œé¢çš„runæ–¹æ³•ã€‚ æ–°å»ºçš„çº¿ç¨‹ void *new_thread(void *arg)123456789101112131415161718void *new_thread(void *arg) { LOGD(\"new_thread-----------------\"); JNIEnv *env; jobject mRunnable = static_cast&lt;jobject&gt;(arg); LOGD(\"new_thread-----------------AttachCurrentThread()\"); //å°†å½“å‰çº¿ç¨‹æ³¨å†Œåˆ°è™šæ‹Ÿæœºä¸­ jvm-&gt;AttachCurrentThread(&amp;env, NULL); jmethodID run = NULL; LOGD(\"new_thread-----------------GetMethodID\"); // æ‹¿åˆ°runæ–¹æ³• run = env-&gt;GetMethodID(RunnableClass, \"run\", \"()V\"); LOGD(\"new_thread-----------------CallVoidMethod\"); env-&gt;CallVoidMethod(mRunnable, run); env-&gt;DeleteGlobalRef(mRunnable); LOGD(\"new_thread-----------------end\"); //è¿”å›å€¼ä¸€å®šè¦ return nullptr;} åŠ è½½åº“çš„æ—¶å€™åšä¸€ä¸‹åˆå§‹åŒ–1234567891011/*åŠ è½½åº“çš„æ—¶å€™ï¼Œåˆå§‹åŒ–JavaVMå¯¹è±¡ï¼Œå…¨å±€å¤ç”¨*/jint JNI_OnLoad(JavaVM *vm, void *reserved) { JNIEnv *env; if (JNI_OK != vm-&gt;GetEnv((void **) &amp;env, JNI_VERSION_1_6)) { printf(\"JNI_OnLoad error \\n\"); return -1; } jvm = vm; LOGD(\"JNI_OnLoad-----------------------------------\"); return JNI_VERSION_1_6;} æœ€ååœ¨java é‡Œé¢åŠ è½½soæ–‡ä»¶1234567891011121314public class MyThread { Runnable mRunnable; static { System.loadLibrary(\"native-lib\"); System.out.println(\"load native-lib\"); } public MyThread(Runnable runnable) { mRunnable = runnable; } native public void start();} æµ‹è¯•123456new MyThread(new Runnable() { @Override public void run() { System.out.println(\"Hello World!\"); } }).start(); ç»“æœ12345678910D/native-lib: JNI_OnLoad-----------------------------------I/System.out: load native-libD/native-lib: java invoke start()---------------start java invoke start()---------------endD/native-lib: new_thread----------------- new_thread-----------------AttachCurrentThread() new_thread-----------------GetMethodID new_thread-----------------CallVoidMethodI/System.out: Hello World!D/native-lib: new_thread-----------------end","link":"/2019/09/24/Java/%E4%BB%BF%E5%86%99%E4%B8%80%E4%B8%AAJavaThread%E5%BA%95%E5%B1%82%E5%AE%9E%E7%8E%B0/"},{"title":"å¦‚ä½•å®šä½CPUå ç”¨æœ€é«˜çš„ä»£ç å—?","text":"1. å…ˆåˆ©ç”¨topæŸ¥çœ‹ å ç”¨è¾ƒé«˜çš„è¿›ç¨‹ 2 ã€‚åˆ©ç”¨ top -Hp pid æˆ– ps H -p pid -o pid,tid,pmem,pcpu,time,commã€‚æŸ¥çœ‹æŸä¸ªè¿›ç¨‹ä¸­çš„çº¿ç¨‹å ç”¨CPUçš„æƒ…å†µã€‚ 3. åˆ©ç”¨jstack pid å¯¹åº”æŸä¸ªçº¿ç¨‹ï¼Œæ³¨æ„ jstack ä¸­çš„ nid æ˜¯16è¿›åˆ¶çš„ï¼Œæ³¨æ„è½¬æ¢ã€‚ 4.å¯ä»¥åœ¨çº¿ç¨‹å¯åŠ¨çš„æ—¶å€™ï¼Œè®¾ç½®çº¿ç¨‹çš„nameï¼Œæ–¹ä¾¿å¿«é€Ÿå®šä½ã€‚","link":"/2019/11/08/Java/%E5%A6%82%E4%BD%95%E5%AE%9A%E4%BD%8DCPU%E5%8D%A0%E7%94%A8%E6%9C%80%E9%AB%98%E7%9A%84%E4%BB%A3%E7%A0%81%E5%9D%97/"},{"title":"åŒ¿åå†…éƒ¨ç±»ä¸ºä»€ä¹ˆè¦æ˜¯final?","text":"1. java æ˜¯å¼•ç”¨ä¼ å‚ã€‚åœ¨é‡Œé¢æ˜¯ä¿®æ”¹ä¸äº†çš„ã€‚ Java8 1234567891011121314151617181920212223242526272829303132public class FinalTest { public static void changeStr(String string){ string = \"BBBB\"; } public static void testInterface(TestInterface testInterface){ testInterface.say(); } public static void main(String[] args) { String string = \"AAAA\"; //è¿™ä¸ªæ˜¯æ”¹ä¸äº†çš„ changeStr(string); System.out.println(string); testInterface(new TestInterface() { @Override public void say() { /* å¦‚æœå¯ä»¥,è¿™ä¸ªæ”¹å¾—äº†å—ï¼Ÿ string = \"CCCCC\"; */ System.out.println(string); } }); }}interface TestInterface{ void say();} 2.å¦‚æœåœ¨åŒ¿åå†…éƒ¨å†…é‡Œé¢ å¯ä»¥ä¿®æ”¹ï¼Ÿ ä½ è§‰æ˜¯æ”¹äº†å¤–éƒ¨ç±»çš„å¼•ç”¨ï¼Œè¿˜æ˜¯æ²¡æ”¹å‘¢ï¼ŸæŒ‰å†™ä»£ç çš„æ€è·¯ï¼Œä½ å¯èƒ½è®¤ä¸ºç»™æ”¹äº†ï¼Œå› ä¸ºè¿™ä¸æ˜¯æ–¹æ³•çš„ä¼ å‚ã€‚ä½†å®é™…ä¸Šå‘¢ï¼Ÿä¼šäº§ç”Ÿæ­§ä¹‰ã€‚ 3.åŒ¿åå†…éƒ¨ç±»å¼•ç”¨å¤–éƒ¨å˜é‡ å®é™…ä¸Šæ˜¯æ‹·è´çš„å¼•ç”¨ã€‚åŒæ–¹æ³•çš„ä¼ å‚ã€‚javaä¸ºäº†ä¿æŒæ•°æ®çš„ä¸€è‡´æ€§ã€‚ä¸è®©åœ¨å†…éƒ¨ç±»é‡Œé¢ä¿®æ”¹ã€‚å› ä¸ºç¼–è¯‘é˜¶æ®µå°±å¤„ç†äº†ï¼ŒåŒ¿åå†…éƒ¨ç±»å› å¼•ç”¨çš„å¤–éƒ¨å˜é‡ï¼Œåœ¨åŒ¿åå¯¹è±¡æ„é€ æ—¶å€™ï¼Œä»¥æ„é€ å‚æ•°å½¢å¼ä¼ å…¥çš„ã€‚12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758596061626364656667686970717273747576777879808182// class version 52.0 (52)// access flags 0x21public class test/FinalTest { // compiled from: FinalTest.java // access flags 0x8 static INNERCLASS test/FinalTest$1 null null // access flags 0x1 public &lt;init&gt;()V L0 LINENUMBER 3 L0 ALOAD 0 INVOKESPECIAL java/lang/Object.&lt;init&gt; ()V RETURN L1 LOCALVARIABLE this Ltest/FinalTest; L0 L1 0 MAXSTACK = 1 MAXLOCALS = 1 // access flags 0x9 public static changeStr(Ljava/lang/String;)V L0 LINENUMBER 6 L0 LDC \"BBBB\" ASTORE 0 L1 LINENUMBER 7 L1 RETURN L2 LOCALVARIABLE string Ljava/lang/String; L0 L2 0 MAXSTACK = 1 MAXLOCALS = 1 // access flags 0x9 public static testInterface(Ltest/TestInterface;)V L0 LINENUMBER 10 L0 ALOAD 0 INVOKEINTERFACE test/TestInterface.say ()V (itf) L1 LINENUMBER 11 L1 RETURN L2 LOCALVARIABLE testInterface Ltest/TestInterface; L0 L2 0 MAXSTACK = 1 MAXLOCALS = 1 // access flags 0x9 public static main([Ljava/lang/String;)V L0 LINENUMBER 13 L0 LDC \"AAAA\" ASTORE 1 L1 LINENUMBER 15 L1 ALOAD 1 INVOKESTATIC test/FinalTest.changeStr (Ljava/lang/String;)V L2 LINENUMBER 16 L2 GETSTATIC java/lang/System.out : Ljava/io/PrintStream; ALOAD 1 INVOKEVIRTUAL java/io/PrintStream.println (Ljava/lang/String;)V L3 LINENUMBER 18 L3 NEW test/FinalTest$1 DUP ALOAD 1 //çœ‹è¿™é‡Œï¼Œçœ‹è¿™é‡Œ &lt;init&gt; æ–¹æ³•å¤šäº†ä¸€ä¸ªString // åŒ¿åå†…éƒ¨ç±»å› å¼•ç”¨çš„å¤–éƒ¨å˜é‡ï¼Œåœ¨åŒ¿åå¯¹è±¡æ„é€ æ—¶å€™ï¼Œä»¥æ„é€ å‚æ•°å½¢å¼ä¼ å…¥çš„ INVOKESPECIAL test/FinalTest$1.&lt;init&gt; (Ljava/lang/String;)V INVOKESTATIC test/FinalTest.testInterface (Ltest/TestInterface;)V L4 LINENUMBER 28 L4 RETURN L5 LOCALVARIABLE args [Ljava/lang/String; L0 L5 0 LOCALVARIABLE string Ljava/lang/String; L1 L5 1 MAXSTACK = 3 MAXLOCALS = 2} 4.ä¸ºä»€ä¹ˆï¼Ÿ å› ä¸ºåŒ¿åå†…éƒ¨ç±» å¼•ç”¨å¤–éƒ¨ç±»çš„å˜é‡ æ˜¯éšå¼çš„ç±»ä¼¼æ–¹æ³•çš„ä¼ å‚ã€‚å…³é”®æ˜¯éšå¼çš„å¤„ç†ï¼Œè‹¥æœå¯ä»¥æ”¹ï¼Œå¿…å®šæ˜¯æ”¹ä¸äº†å¤–éƒ¨å¼•ç”¨çš„ï¼Œé˜²æ­¢äº§ç”Ÿæ­§ä¹‰ã€‚ä¸ºä»€ä¹ˆJava8 ä¸éœ€è¦åŠ finalï¼Ÿåªæ˜¯è¯­æ³•ç³–ï¼Œå†…éƒ¨ç±»é‡Œé¢ç…§æ ·ä¸èƒ½ä¿®æ”¹å¼•ç”¨ï¼Œä¿®æ”¹å¯¼è‡´ç¼–è¯‘ä¸è¿‡çš„ã€‚**","link":"/2019/12/27/Java/%E5%8C%BF%E5%90%8D%E5%86%85%E9%83%A8%E7%B1%BB%E4%B8%BA%E4%BB%80%E4%B9%88%E8%A6%81%E6%98%AFFinal/"},{"title":"ç±»åŠ è½½å™¨ä¹‹é—´çš„å…³ç³»","text":"æœ¬æ¬¡æˆ‘ä»¬ä¸»è¦è®¨è®ºå­ç±»å’Œçˆ¶ç±»çš„ç±»åŠ è½½å™¨ä¹‹å‰çš„å…³ç³», ä»¥åŠåŒ…å«ä¹‹å‰çš„ç±»åŠ è½½å™¨å…³ç³»ã€‚æˆ‘ä»¬è‡ªå®šä¹‰ä¸€ä¸ªclassloderï¼Œè®¾ç½®çˆ¶åŠ è½½å™¨ä¸ºnullï¼Œè¿™æ ·ä¿è¯éƒ½æ˜¯è‡ªå·±æ¥åŠ è½½ï¼ŒæŒ‡å‘çš„è·¯å¾„å’ŒAppClassloaderä¸€è‡´ï¼Œè¿™æ ·æ–¹ä¾¿2ä¸ªéƒ½å¥½ç›´æ¥åŠ è½½ ç»§æ‰¿å…³ç³»12345class MyAnimal { public MyAnimal() { System.out.println(\"MyAnimal by load \" + MyAnimal.class.getClassLoader()); }} 12345class MyDog extends MyAnimal{ public MyDog() { System.out.println(\"MyDog by Load \" + MyDog.class.getClassLoader()); }} 123456789public static void main(String[] args) throws Exception { MyCustomClassLoader loader = new MyCustomClassLoader();//è‡ªå®šåŠ è½½ç±» loader.setPath(\"/Users/kenchan/GitHub/jvm_study/target/classes/\"); Class&lt;?&gt; myDog = loader.loadClass(\"com.test.classload.MyDog\");//åŠ è½½ Constructor&lt;?&gt; constructor = myDog.getConstructor();//å®åˆ—åŒ– constructor.setAccessible(true); Object o = constructor.newInstance(); } è¾“å‡º 1234findClass,è‡ªå®šä¹‰ç±»åŠ è½½å™¨åŠ è½½äº†æŒ‡å®šçš„ç±»findClass,è‡ªå®šä¹‰ç±»åŠ è½½å™¨åŠ è½½äº†æŒ‡å®šçš„ç±»MyAnimal by load com.test.classload.MyCustomClassLoader@4b67cf4dMyDog by Load com.test.classload.MyCustomClassLoader@4b67cf4d å¯ä»¥çœ‹åˆ°MyDogå¼•å‘MyAnimalçš„ç±»åŠ è½½ï¼ŒåŒæ—¶ä¹Ÿç”¨äº†MyDogçš„åŠ è½½å™¨ ä»è°ƒç”¨æ ˆæ¥çœ‹ï¼Œåœ¨MyDogç±»è¢«åŠ è½½çš„æ—¶å€™ï¼Œnative defineClass1 é˜¶æ®µï¼Œnative codeç›´æ¥å›è°ƒåˆ°Dogçš„åŠ è½½å™¨ MyCustomClassLoaderæ¥å°è¯•åŠ è½½MyDogçš„çˆ¶ç±» 1234567891011findClass:34, MyCustomClassLoader (com.test.classload) [2]//MyCustomClassLoaderåŠ è½½çˆ¶ç±»MyAnimalloadClass:424, ClassLoader (java.lang)loadClass:357, ClassLoader (java.lang)//native define å¼•å‘åŠ è½½çˆ¶ç±»MyAnimalçš„åŠ è½½ï¼Œä»è¿™é‡Œæ”¾å›çš„å°±æ˜¯MyCustomClassLoaderäº†defineClass1:-1, ClassLoader (java.lang)defineClass:763, ClassLoader (java.lang)defineClass:642, ClassLoader (java.lang)findClass:36, MyCustomClassLoader (com.test.classload) [1]//é¦–å…ˆåŠ è½½DogloadClass:424, ClassLoader (java.lang)loadClass:357, ClassLoader (java.lang)main:15, ç–‘é—®1ï¼Œå‡å¦‚MyAnimalæå‰è¢«AppClassloderåŠ è½½äº†å‘¢ï¼Ÿ123456789101112public static void main(String[] args) throws Exception { MyCustomClassLoader loader = new MyCustomClassLoader(); loader.setPath(\"/Users/kenchan/GitHub/jvm_study/target/classes/\"); Class&lt;?&gt; myDog = loader.loadClass(\"com.test.classload.MyDog\"); //æå‰è§¦å‘ä¸€ä¸‹ MyAnimalç±»çš„åŠ è½½ï¼Œè¿™é‡Œé»˜è®¤æ˜¯ç”¨çš„AppClassloder Class&lt;?&gt; myAnimal = Class.forName(\"com.test.classload.MyAnimal\");//åªæ˜¯å£°æ˜ï¼Œå¹¶æ²¡æœ‰å¼•å‘ç±»çš„åŠ è½½; myAnimal.newInstance();//å¼•å‘ç±»çš„åŠ è½½ Constructor&lt;?&gt; constructor = myDog.getConstructor();//å®åˆ—åŒ– constructor.setAccessible(true); Object o = constructor.newInstance();} æŸ¥çœ‹è¾“å‡ºï¼Œè¿™é‡Œå¯ä»¥çœ‹åˆ°æˆ‘ä»¬æå‰ç”¨äº†AppClassLoader åŠ è½½äº†ä¸€æ¬¡ MyAnimal ï¼Œä½†æ˜¯åé¢è¿˜æ˜¯å¾—è¢«MyCustomClassLoader åŠ è½½äº†ä¸€æ¬¡ 12345findClass,è‡ªå®šä¹‰ç±»åŠ è½½å™¨åŠ è½½äº†æŒ‡å®šçš„ç±»findClass,è‡ªå®šä¹‰ç±»åŠ è½½å™¨åŠ è½½äº†æŒ‡å®šçš„ç±»MyAnimal by load sun.misc.Launcher$AppClassLoader@135fbaa4MyAnimal by load com.test.classload.MyCustomClassLoader@4b67cf4dMyDog by Load com.test.classload.MyCustomClassLoader@4b67cf4d ç–‘é—®2 ï¼Œå‡å¦‚MyAnimalæå‰è¢«MyCustomClassLoaderåŠ è½½äº†å‘¢ï¼Ÿ æˆ‘ä»¬ä¿®æ”¹éƒ½ç”¨MyCustomClassLoaderåŠ è½½ä¸€æ¬¡ 12Class&lt;?&gt; myDog = loader.loadClass(\"com.test.classload.MyDog\");Class&lt;?&gt; myAnimal = loader.loadClass(\"com.test.classload.MyAnimal\");//åªæ˜¯å£°æ˜ï¼Œå¹¶æ²¡æœ‰å¼•å‘ç±»çš„åŠ è½½; çœ‹è¾“å‡ºï¼Œéƒ½æ˜¯åªä¼šåŠ è½½ä¸€æ¬¡çš„ 1234findClass,è‡ªå®šä¹‰ç±»åŠ è½½å™¨åŠ è½½äº†æŒ‡å®šçš„ç±»findClass,è‡ªå®šä¹‰ç±»åŠ è½½å™¨åŠ è½½äº†æŒ‡å®šçš„ç±»MyAnimal by load com.test.classload.MyCustomClassLoader@4b67cf4dMyDog by Load com.test.classload.MyCustomClassLoader@4b67cf4d JVMè®¤ä¸ºç±»çš„ä¸åŒï¼Œæ˜¯æ ¹æ®åŠ è½½å™¨å’Œç±»å…¨åæ¥åˆ¤æ–­çš„ï¼Œç±»ä¹‹é—´çš„åŠ è½½å™¨ä¸åŒï¼ŒåŒ…ååŒï¼Œæ˜¯å±äºä¸åŒçš„å‘½åç©ºé—´é‡Œï¼Œæ‰€ä»¥ä¸€ä¸ªAnmialç±»å¯ä»¥è¢«åŒæ—¶è¢«ä¸åŒçš„ç±»åŠ è½½å™¨åŠ è½½ä¸€æ¬¡ã€‚è€Œä¸åŒå‘½åç©ºé—´é‡Œçš„ç±»åœ¨ä½¿ç”¨æŸä¸ªç±»çš„æ—¶å€™ï¼Œå‘ç°å¹¶æ²¡æœ‰åŠ è½½ï¼Œå°±ä¼šä½¿ç”¨è¯¥å‘½åç©ºé—´çš„ç±»åŠ è½½å™¨å»åŠ è½½ã€‚ åŒ…å«å…³ç³» å¦‚æœæˆ‘ä»¬æŠŠMyDogæ”¹æˆè¿™æ · 123456class MyDog { public MyDog() { System.out.println(\"MyDog by Load \" + MyDog.class.getClassLoader()); new MyAnimal(); }} åŒç†ï¼Œåœ¨æˆ‘ä»¬å®ä¾‹åŒ–MyAnimal()æ—¶å€™ï¼Œéƒ½æ˜¯å…ˆç”¨è°ƒç”¨æ–¹MyDogçš„ç±»åŠ è½½å™¨å»åŠ è½½ï¼ŒMyDogæˆ‘ä»¬è®¾ç½®çš„çˆ¶åŠ è½½å™¨ä¸ä¸ºç©ºçš„ï¼Œç»§ç»­äº¤ç»™çˆ¶åŠ è½½å™¨å»åŠ è½½ã€‚é€šå¸¸æƒ…å†µä¸‹æˆ‘ä»¬å†™çš„éƒ½æ˜¯ç”±AppClassloderå»åŠ è½½çš„ï¼Œéƒ½åœ¨ä¸€ä¸ªå‘½åç©ºé—´ä¸‹é¢ã€‚ çˆ¶åŠ è½½å™¨ä¼šåè¿‡æ¥ç”¨å­åŠ è½½å™¨æ¯”å¦‚æˆ‘ä»¬åœ¨çˆ¶åŠ è½½å™¨ä¸­å»è®¿é—®å­åŠ è½½å™¨åŠ è½½çš„ç±» è®©Dog åŒ…å« Anmial 123456public class MyDog { public MyDog() { System.out.println(\"MyDog by Load \" + MyDog.class.getClassLoader()); new MyAnimal(); }} è®©Anmialå»è®¿é—®ä¸€ä¸‹Dog 123456public class MyAnimal { public MyAnimal() { System.out.println(\"MyAnimal by load \" + MyAnimal.class.getClassLoader()); System.out.println(\"MyAnimal:MyDog lode by \"+MyDog.class.getClassLoader()); }} è¿™æ ·åœ¨æˆ‘ä»¬ç›´æ¥åˆå§‹åŒ–Dogçš„æ—¶å€™ï¼Œä¼šè§¦å‘MyAnmialå»è®¿é—®Dogç±» æˆ‘ä»¬ç›´æ¥ç§»åŠ¨ä¸€ä¸‹ç¼–è¯‘å¥½çš„Dog.class è®©Dogä½¿ç”¨è‡ªå®šä¹‰çš„ç±»åŠ è½½å™¨ï¼Œè®©Anmialä½¿ç”¨ä½¿ç”¨AppClassLoder 12345678public static void main(String[] args) throws Exception { MyCustomClassLoader loader = new MyCustomClassLoader(); loader.setPath(\"/Users/kenchan/GitHub/jvm_study/target/out/\"); Class&lt;?&gt; myDog = loader.loadClass(\"com.test.classload.MyDog\"); Constructor&lt;?&gt; constructor = myDog.getConstructor();//å®åˆ—åŒ– constructor.setAccessible(true); Object o = constructor.newInstance(); } æˆ‘ä»¬å¯ä»¥çœ‹åˆ°æ˜æ˜åŠ è½½äº†MyDogç±»ï¼Œå´åœ¨Anmailæ‰“å°System.out.println(&quot;MyAnimal:MyDog lode by &quot;+MyDog.class.getClassLoader());æ˜¯æŠ›é”™è¯´æ‰¾ä¸åˆ°ç±» å®é™…ä¸Šçš„é”™è¯¯æ˜¯ç”±äºAppClassLoaderæ˜¯è®¿é—®ä¸åˆ°å®ƒçš„å­åŠ è½½å™¨åŠ è½½çš„ç±»çš„ï¼Œå±äºä¸åŒçš„å‘½åç©ºé—´ã€‚AppClassLoderå°è¯•è‡ªå·±å»åŠ è½½MyDogï¼Œç»“æœæ²¡æœ‰æ‰¾åˆ°ã€‚ ä¸¾ä¸ªç»§æ‰¿çš„ä¾‹å­å°±æ˜¯å¦‚æœï¼Œå­ç±»æ˜¯è‡ªå®šä¹‰åŠ è½½å™¨æ‰èƒ½åŠ è½½ï¼Œçˆ¶ç±»é€šè¿‡AppClassloderæ‰èƒ½åŠ è½½ï¼Œé‚£ä¹ˆå¦‚æœçˆ¶ç±»åˆå¼•ç”¨äº†ä¹‹ç±»çš„è¯ï¼Œçˆ¶ç±»çš„åŠ è½½å™¨AppClassloderæ˜¯åŠ è½½ä¸äº†å­ç±»çš„ã€‚ ç»“è®ºç±»åŠ è½½å™¨ï¼ŒåŠå…¶çˆ¶åŠ è½½å™¨å…±åŒæ„æˆä¸€ä¸ªå‘½åç©ºé—´ï¼Œä½†çˆ¶ç±»å‘½åç©ºé—´ä¸èƒ½åè¿‡æ¥è®¿é—®å­åŠ è½½å™¨åŠ è½½çš„ç±»ï¼Œå­åŠ è½½å™¨æ˜¯å¯ä»¥è®¿é—®çˆ¶åŠ è½½å™¨åŠ è½½çš„ç±»,å­åŠ è½½å™¨çš„çˆ¶åŠ è½½å™¨æ˜¯ä¸€ä¸ªï¼Œä½†æ˜¯çˆ¶åŠ è½½å™¨çš„å­åŠ è½½å™¨æ˜¯å¯èƒ½æœ‰å¤šä¸ªçš„ï¼Œæ‰€ä»¥ç”±è°è§¦å‘çš„åŠ è½½ï¼Œè°å¯ä»¥ä¸€ç›´æƒ³ä¸Šè¿½ï¼Œè¿½ä¸åˆ°å°±è‡ªå·±ï¼Œä½†æ˜¯ä¸Šé¢çš„å´ä¸èƒ½å‘ä¸‹è¿½ï¼Œå› ä¸ºä¸‹é¢æœ‰å¤šä¸ªï¼Œä¸çŸ¥é“è¿½è°ã€‚å½“åŠ è½½æŸä¸€ä¸ªç±»çš„æ—¶å€™ï¼Œä¼šè°ƒç”¨å½“å‰çš„å‘½åç©ºé—´çš„å­åŠ è½½å™¨ï¼Œç„¶åé‡‡ç”¨åŒäº²å§”æ´¾æœºåˆ¶ä¸Šäº¤ç»™çˆ¶åŠ è½½å™¨åŠ è½½ã€‚æˆ‘ä»¬ä¹Ÿæ˜¯å¯ä»¥åšåˆ° MyDog æ˜¯è‡ªå®šä¹‰åŠ è½½å™¨ï¼ŒMyAnimalæ˜¯AppClassloderçš„ï¼Œåªè¦ä¸æ‰“ç ´åŒäº²å§”æ´¾æœºåˆ¶ã€‚åœ¨ä¸æ‰“ç ´åŒäº²å§”æ´¾åŸºç¡€ä¸‹ï¼Œå„ä¸ªåŠ è½½å™¨ä¹‹å‰çš„å…³ç³»å¦‚ä¸‹ï¼š ä¼˜å…ˆé€ä¸ªäº¤ç»™æœ€é‡Œé¢çš„åŠ è½½å™¨æ¥åš é‡Œé¢çš„åšä¸äº†ï¼Œå¤–é¢å†æ¥åš å¤–é¢å¯ä»¥è®¿é—®é‡Œé¢çš„åŠ è½½çš„ç±» é‡Œé¢å´ä¸èƒ½è®¿é—®å¤–é¢çš„åŠ è½½å™¨åŠ è½½çš„ç±»","link":"/2019/10/25/Java/%E7%B1%BB%E5%8A%A0%E8%BD%BD%E5%99%A8%E4%B9%8B%E5%89%8D%E7%9A%84%E5%85%B3%E7%B3%BB/"},{"title":"è®°ä¸€æ¬¡ç±»åŠ è½½å¼•èµ·çš„Bug","text":"1.èµ·å› ç¨‹åºè«åå…¶å¦™å‡ºäº† error:java.lang.NullPointerException: Null reference used for synchronization (monitor-enterï¼‰å°±æ˜¯åœ¨ä½¿ç”¨åŒæ­¥é”çš„æ—¶å€™ï¼Œæ˜¯é”çš„å¯¹è±¡æ˜¯ç©ºçš„ã€‚å¾ˆæ˜¯å¥‡æ€ªï¼Œçœ‹ä»£ç æ²¡è§‰å¾—å•Šã€‚æ‰“å°ä¸€ä¸‹ï¼Œç¡®å®æ˜¯ç©ºçš„ï¼ŒWhyï¼Ÿ 2. ä»£ç ï¼Œçœ‹å‡ºé—®é¢˜ï¼Ÿä»£ç é€»è¾‘ç®€åŒ–å¦‚ä¸‹: 12345678910111213141516171819202122public class SynTest { public static void main(String[] args) { System.out.println(LockInstance.string); }}class LockInstance { public static String string = getString(); private static byte[] sLock = new byte[0]; public static LockInstance getInstance() { synchronized (sLock){ return new LockInstance(); } } private static String getString(){ return LockInstance.getInstance().getApplicationContext(); } public String getApplicationContext() { return \"string\"; }} æ²¡é—®é¢˜å•Šï¼Ÿ çŒœä¸€ä¸‹ç»“æœè¾“å‡ºï¼Ÿå‡ºé”™æ‹‰ï¼ï¼ 1234567Exception in thread \"main\" java.lang.ExceptionInInitializerError at SynTest.main(SynTest.java:3)Caused by: java.lang.NullPointerException at LockInstance.getInstance(SynTest.java:11) at LockInstance.getString(SynTest.java:16) at LockInstance.&lt;clinit&gt;(SynTest.java:8) ... 1 more 3 ä¸ºä»€ä¹ˆï¼Ÿæœ¬è´¨ä¸Šæ˜¯æ²¡æœ‰ç†è§£ç±»åŠ è½½çš„è¿‡ç¨‹å¯¼è‡´å‡ºé”™çš„ã€‚æ¥ç†ä¸€ä¸‹æ€è·¯é¦–å…ˆåœ¨ç¬¬ä¸€æ¬¡è°ƒç”¨ LockInstane çš„é™æ€æ–¹æ³•çš„æ—¶å€™ï¼Œç±»ä¼šè¿›è¡Œåˆå§‹åŒ–ã€‚é‚£ä¹ˆç±»çš„åˆå§‹åŒ–æ˜¯æœ‰ä¸€ä¸ªè¿‡ç¨‹çš„ã€‚æŒ‰å£°æ˜çš„é™æ€å˜é‡è¿›è¡Œåˆå§‹åŒ–ï¼Œå†æ˜¯ç±»çš„é™æ€å—ï¼Œæœ€åå†æ˜¯æ‰§è¡Œè°ƒç”¨çš„é™æ€æ–¹æ³•ã€‚æŒ‰ä¸Šé¢çš„ä»£ç ï¼Œé—®é¢˜é”™åœ¨ ç±»åˆå§‹åŒ–çš„æ—¶å€™ï¼Œç”±äºé™æ€çš„æˆå‘˜å˜é‡è°ƒç”¨äº†é™æ€æ–¹æ³•è¿›è¡Œåˆå§‹åŒ–ï¼Œä½†æ˜¯åœ¨é‡Œé¢ç”¨çš„å˜é‡å´è¿˜æ²¡æ¥å¾—åŠåˆå§‹åŒ–ã€‚ 4 è§£å†³åŠæ³•å¦‚æœç±»çš„æˆå‘˜å˜é‡çš„åˆå§‹åŒ–éœ€è¦ç”¨åˆ°ç±»çš„æˆå‘˜å˜é‡ï¼Œè¯·ä¿è¯åœ¨è¿™ä¹‹å‰å·²ç»ç”¨åˆ°çš„å˜é‡å·²ç»åˆå§‹åŒ–äº†ã€‚ ä¿®æ”¹æ–¹æ³•ï¼Œæ”¾åˆ°å‰é¢å°±å¯ä»¥äº†ã€‚ 12private static byte[] sLock = new byte[0];public static String string = getString(); æµ‹è¯•è¿è¡ŒæˆåŠŸã€‚","link":"/2020/04/18/Java/%E7%B1%BB%E5%8A%A0%E8%BD%BD%E5%BC%95%E8%B5%B7%E7%9A%84Bug/"},{"title":"æŠŠæ•°å­—ç¿»è¯‘æˆå­—ç¬¦ä¸²","text":"ç»™å®šä¸€ä¸ªæ•°å­—ï¼Œæˆ‘ä»¬æŒ‰ç…§å¦‚ä¸‹è§„åˆ™æŠŠå®ƒç¿»è¯‘ä¸ºå­—ç¬¦ä¸²ï¼š0 ç¿»è¯‘æˆ â€œaâ€ ï¼Œ1 ç¿»è¯‘æˆ â€œbâ€ï¼Œâ€¦â€¦ï¼Œ11 ç¿»è¯‘æˆ â€œlâ€ï¼Œâ€¦â€¦ï¼Œ25 ç¿»è¯‘æˆ â€œzâ€ã€‚ä¸€ä¸ªæ•°å­—å¯èƒ½æœ‰å¤šä¸ªç¿»è¯‘ã€‚è¯·ç¼–ç¨‹å®ç°ä¸€ä¸ªå‡½æ•°ï¼Œç”¨æ¥è®¡ç®—ä¸€ä¸ªæ•°å­—æœ‰å¤šå°‘ç§ä¸åŒçš„ç¿»è¯‘æ–¹æ³•ã€‚ ç¤ºä¾‹ 1: è¾“å…¥: 12258è¾“å‡º: 5 è§£é‡Š: 12258æœ‰5ç§ä¸åŒçš„ç¿»è¯‘ï¼Œåˆ†åˆ«æ˜¯â€bccfiâ€, â€œbwfiâ€, â€œbcziâ€, â€œmcfiâ€å’Œâ€mziâ€ æç¤ºï¼š 0 &lt;= num &lt; 231 DFSä»åé¢å‘å‰é¢æ‰¾1234567891011121314151617181920class Solution { //ä»åé¢çš„æ•°å­—å‘å‰æ‰¾ public int translateNum(int num) { //åªæœ‰ä¸€ç§å¯èƒ½ if (num &lt;= 9) { return 1; } //å…ˆåˆ¤æ–­ä»¥åé¢2ä¸ªæ•°å­— int last2num = num % 100; //åé¢2ä½æ•°å­—åªèƒ½æœ‰ä¸€ç§,å°±æ˜¯å•ä¸ªæ•°å­—ä¸€ç§ï¼Œé‚£å°±å–å•ä¸ªæ•°å­— if (last2num&lt;=9||last2num&gt;=26){ return translateNum(num / 10); }else{ // åé¢2ä¸ªæ•°å­—ï¼Œå¯ä»¥å•ç‹¬ä¸€ç§ï¼Œä¹Ÿå¯ä»¥åˆæˆã€‚æ‰€ä»¥ç›¸åŠ  return translateNum(num / 10) + translateNum(num / 100); } }}","link":"/2020/04/30/LeetCode/ba-shu-zi-fan-yi-cheng-zi-fu-chuan-lcof/"},{"title":"åŒºåˆ†Kotlinä¸­çš„ &#x3D;&#x3D; å’Œ &#x3D;&#x3D;&#x3D;","text":"æµ‹è¯•ä»£ç 12345678fun main() { val list1 = mutableListOf&lt;String&gt;() val list2 = mutableListOf&lt;String&gt;() list1.add(\"sss\") list2.add(\"sss\") println(list1 == list2) println(list1 === list2)} æµ‹è¯•è¾“å‡º 12truefalse æˆ‘ä»¬å¯ä»¥ç‚¹å‡»è·³è½¬çœ‹åˆ°ï¼Œ== åœ¨kotlinä¸­æ˜¯ä¸€ä¸ªè¢«é‡è½½äº†çš„æ“ä½œç¬¦åˆç‚¹å‡»è·³è½¬å®ç° ï¼Œç­‰ä»·äºè°ƒç”¨objectçš„equals å‡½æ•°è€Œ === ä¸èƒ½ç›´æ¥è·³è½¬ã€‚æˆ‘ä»¬é€šè¿‡åç¼–è¯‘æˆå­—èŠ‚ç å†ç¼–åè¯‘æˆjavaï¼Œ=== ç­‰ä»·äº java ä¸­çš„==ï¼Œæ¯”è¾ƒçš„æ˜¯åœ°å€ï¼Œ ==åœ¨kotlinä¸­æ˜¯Intrinsics.areEqualæ–¹æ³•ã€‚https://asmsupport.github.io/doc/0.4/jvmref/ref-if_acmpne.html === ç­‰å·ä¸­å«æœ‰IF_ACMPNEçŸ¥å†·æš–æ–¹ä¾¿æŸ¥çœ‹ï¼Œå¯ä»¥å†åç¼–è¯‘æˆjavaï¼ŒæŸ¥çœ‹ 1234567891011121314public static final void main() { boolean var1 = false; List list1 = (List)(new ArrayList()); boolean var2 = false; List list2 = (List)(new ArrayList()); list1.add(\"sss\"); list2.add(\"sss\"); var2 = Intrinsics.areEqual(list1, list2); boolean var3 = false; System.out.println(var2); var2 = list1 == list2; var3 = false; System.out.println(var2);} ä¸€èˆ¬Intrinsics.areEqualçš„å®ç°æ˜¯åˆ¤æ–­å†…å®¹ç›¸ç­‰ï¼Œ=== åˆ¤æ–­çš„æ˜¯åœ°å€ç›¸ç­‰ æ€»ç»“åœ¨kotlinä¸­ ï¼Œ== è¢«é‡è½½ä¸ºequalsï¼Œåˆ¤æ–­çš„æ˜¯å†…å®¹ç›¸åŒå°±ç›¸ç­‰ã€‚=== åˆ¤æ–­çš„æ˜¯åœ°å€ç›¸ç­‰","link":"/2021/08/21/Kotlin/kotlin-equal-java/"},{"title":"æŠŠæ•°ç»„æ’æˆæœ€å°çš„æ•°","text":"è¾“å…¥ä¸€ä¸ªæ­£æ•´æ•°æ•°ç»„ï¼ŒæŠŠæ•°ç»„é‡Œæ‰€æœ‰æ•°å­—æ‹¼æ¥èµ·æ¥æ’æˆä¸€ä¸ªæ•°ï¼Œæ‰“å°èƒ½æ‹¼æ¥å‡ºçš„æ‰€æœ‰æ•°å­—ä¸­æœ€å°çš„ä¸€ä¸ªã€‚ ç¤ºä¾‹ 1: è¾“å…¥: [10,2]è¾“å‡º: â€œ102&quot; ç¤ºä¾‹ 2: è¾“å…¥: [3,30,34,5,9]è¾“å‡º: â€œ3033459&quot; æç¤º: 0 &lt; nums.length &lt;= 100 è¯´æ˜: è¾“å‡ºç»“æœå¯èƒ½éå¸¸å¤§ï¼Œæ‰€ä»¥ä½ éœ€è¦è¿”å›ä¸€ä¸ªå­—ç¬¦ä¸²è€Œä¸æ˜¯æ•´æ•° æ‹¼æ¥èµ·æ¥çš„æ•°å­—å¯èƒ½ä¼šæœ‰å‰å¯¼ 0ï¼Œæœ€åç»“æœä¸éœ€è¦å»æ‰å‰å¯¼ 0 123456789101112131415161718192021222324252627class Solution { public String minNumber(int[] nums) { NumNode[] numNode = new NumNode[nums.length]; for (int i = 0; i &lt; nums.length; i++) { numNode[i] = new NumNode(nums[i] + \"\"); } Arrays.sort(numNode); //æµ æ¯”è¾ƒä¼˜é›…ï¼Œä½†å´ä¸æ˜¯æœ€å¿« //return Arrays.stream(numNode).map(i -&gt; i.string).collect(Collectors.joining(\"\")); StringBuffer buffer = new StringBuffer(); for (NumNode node : numNode) { buffer.append(node.string); } return buffer.toString(); } class NumNode implements Comparable&lt;NumNode&gt;{ public NumNode(String string) { this.string = string; } public String string; @Override public int compareTo(NumNode o) { return (int) (Long.parseLong(string + o.string) - Long.parseLong(o.string + string)); } }}","link":"/2020/04/27/LeetCode/ba-shu-zu-pai-cheng-zui-xiao-de-shu-lcof/"},{"title":"Kotlin on JVM åç¨‹çš„å¯é‡å…¥å®ç°","text":"1. åç¨‹ï¼Ÿåç¨‹çš„ä¼˜åŠ¿å°±æ˜¯ä¸Šä¸‹æ–‡åˆ‡æ¢çš„ä¼˜åŠ¿ï¼Œä¸ç”¨æ‰“æ‰°åˆ°æ“ä½œç³»ç»Ÿã€‚ç”¨æˆ·è‡ªå·±å®ç°åç¨‹çš„åˆ‡æ¢ã€‚åç¨‹å¯ä»¥ä¸»åŠ¨è®©å‡ºçº¿ç¨‹çš„èƒ½åŠ›ï¼Œè®©Runtimeè¿›è¡Œè°ƒåº¦ã€‚è€Œé¢å¯¹çº¿ç¨‹è€Œè¨€ï¼Œé€šå¸¸ä¸æ˜¯ä¸»åŠ¨è®©å‡ºçš„ï¼Œè€Œæ˜¯è¢«æ“ä½œç³»ç»Ÿå¼ºåˆ¶è°ƒåº¦ã€‚æ“ä½œç³»ç»Ÿæ˜¯æ„ŸçŸ¥ä¸åˆ°Runtimeå±‚é¢çš„åç¨‹çš„ï¼Œä¹Ÿä¸å…³å¿ƒæ˜¯ä¸æ˜¯æ­£åœ¨è¿›è¡Œåç¨‹è°ƒåº¦ã€‚çº¿ç¨‹çš„ç°åœºä¿¡æ¯ç”±æ“ä½œç³»ç»Ÿç»´æŠ¤ï¼Œåç¨‹çš„ç°åœºä¿¡æ¯ç”±Runtimeæ¥ç»´æŠ¤ã€‚ Kotlin on JVM çš„â€œåç¨‹â€ï¼Œä¸æ˜¯çœŸæ­£æ„ä¹‰ä¸Šçš„åç¨‹ ï¼Ÿ æ•ˆæœä¸Šï¼Œæ¯”åœ¨Javaçº¿ç¨‹æ± çš„çš„RunableåŸºç¡€ä¸Šé¢ï¼ŒRunable ä¸å…·å¤‡æš‚åœè°ƒåº¦å¯æ¢å¤çš„ç‰¹æ€§ã€‚Runableä»å¼€å§‹åˆ°ç»“æŸä¸€ç›´å ç”¨å½“å‰çº¿ç¨‹ï¼Œä¸ç®¡æ˜¯runingè¿˜æ˜¯waitï¼Œè€ŒKotlinåœ¨åç¨‹â€waitâ€œçš„æ—¶å€™ï¼Œä¼šé‡Šæ”¾å½“å‰çº¿ç¨‹ã€‚ 2. åç¨‹çš„åˆ›å»ºå’Œæ‰§è¡Œè¿‡ç¨‹å†™ä¸ªåç¨‹æ¥æµ‹è¯•ï¼ŒExample1 æ·»åŠ  jvmå‚æ•° -Dkotlinx.coroutines.debug æ‰“å°çº¿ç¨‹ä¿¡æ¯çš„æ—¶å€™å¯ä»¥çœ‹åˆ°åç¨‹å’Œçº¿ç¨‹çš„å…³ç³» 123456789suspend fun test(){ val job = GlobalScope.launch { delay(2000) printThreadInfo() delay(2000) printThreadInfo() } Thread.sleep(10000)} è¾“å‡º 12DefaultDispatcher-worker-1 @coroutine#1DefaultDispatcher-worker-1 @coroutine#1 çœ‹è¿™ä¸ªçº¿ç¨‹åç§°ï¼Œæœ‰æ²¡æœ‰è”æƒ³åˆ°äº†çº¿ç¨‹æ± ï¼Ÿ åç¨‹çš„åˆ†å‘ å¯ä»¥é€šè¿‡è·Ÿè¸ªè°ƒç”¨é“¾å‘ç° Schduler çš„ç»“æ„ ä¸¤ä¸ªéƒ½æ˜¯å…¨å±€é˜Ÿåˆ—ï¼ŒåŒºåˆ«åªæ˜¯ä¸€ä¸ªè´Ÿè´£CPUå¯†é›†Taskï¼Œä¸€ä¸ªè´Ÿè´£IOå¯†é›†Task å…¨å±€é˜Ÿåˆ—ä¹‹å¤–ï¼Œæ¯ä¸ªçº¿ç¨‹è‡ªå·±è¿˜æœ‰ä¸€ä¸ªç§æœ‰é˜Ÿåˆ— vmMain/scheduling/CoroutineScheduler.kt:383 123456789101112131415161718192021222324252627fun dispatch(block: Runnable, taskContext: TaskContext = NonBlockingContext, tailDispatch: Boolean = false) { trackTask() // this is needed for virtual time support // åŒ…è£…æˆTask,Taskå®é™…ä¸Šç»§æ‰¿Runable val task = createTask(block, taskContext) // try to submit the task to the local queue and act depending on the result val currentWorker = currentWorker() // ä¼˜å…ˆæäº¤åˆ°å½“å‰Workerï¼Œå½“å‰Worker å¯èƒ½æ˜¯nullï¼Œæäº¤é‡Œé¢ç›´æ¥return val notAdded = currentWorker.submitToLocalQueue(task, tailDispatch) if (notAdded != null) { //ç„¶åå°è¯•æŠŠTaskæäº¤GlobalQueue if (!addToGlobalQueue(notAdded)) { // Global queue is closed in the last step of close/shutdown -- no more tasks should be accepted throw RejectedExecutionException(\"$schedulerName was terminated\") } } val skipUnpark = tailDispatch &amp;&amp; currentWorker != null // Checking 'task' instead of 'notAdded' is completely okay if (task.mode == TASK_NON_BLOCKING) { if (skipUnpark) return // é‡Œé¢ä¼šå…ˆå°è¯•å»parkedWorkersæ‹¿çº¿ç¨‹ï¼Œæ‹¿ä¸åˆ°å°±åˆ›å»º signalCpuWork() } else { // Increment blocking tasks anyway signalBlockingWork(skipUnpark = skipUnpark) }} å¤šä¸ªçº¿ç¨‹æäº¤Taskåˆ°Queueçš„å¹¶å‘é”é—®é¢˜ï¼Œç”±Queueä¿è¯ åˆ›å»ºwokerçº¿ç¨‹ä¹‹åï¼Œå¯åŠ¨wokerçº¿ç¨‹ è¿™é‡Œå¯åŠ¨wokerå®é™…ä¸Šæ˜¯ä¸€ä¸ªwhileï¼Œwhileé‡Œé¢ä¸åœçš„å»è·å–Taskæ‰§è¡ŒTaskï¼Œæ²¡æœ‰Taskå°±parkï¼Œå’ŒHanlderé‡Œé¢loopå¾ˆåƒã€‚ jvmMain/scheduling/CoroutineScheduler.kt:670 123456789101112131415161718192021222324252627282930313233343536 private fun runWorker() { var rescanned = false while (!isTerminated &amp;&amp; state != WorkerState.TERMINATED) { // è¿™é‡Œå»æ‹¿Task val task = findTask(mayHaveLocalTasks) // æ‹¿åˆ°äº†å°±å»æ‰§è¡Œ ï¼Œç„¶åé‡å¤å¾ªç¯ if (task != null) { rescanned = false minDelayUntilStealableTaskNs = 0L executeTask(task) continue } else { mayHaveLocalTasks = false } // è¿™é‡Œå…ˆå°è¯•äº†park minDelayUntilStealableTaskNs ï¼Œç„¶åæŠŠ // minDelayUntilStealableTaskNs = 0 // ä¸»è¦æ˜¯ å­˜åœ¨æ­£åœ¨çªƒå–çš„ä»»åŠ¡ï¼Œè¿˜æ²¡çªƒå–å®Œæˆ if (minDelayUntilStealableTaskNs != 0L) { if (!rescanned) { rescanned = true } else { rescanned = false tryReleaseCpu(WorkerState.PARKING) interrupted() LockSupport.parkNanos(minDelayUntilStealableTaskNs) minDelayUntilStealableTaskNs = 0L } continue } //å¼€å§‹parkï¼Œç„¶åç­‰å¾…å”¤é†’ tryPark() } tryReleaseCpu(WorkerState.TERMINATED) } å†çœ‹ä¸€æ€ä¹ˆfindTaskçš„ï¼Ÿ 12345678910111213141516171819202122232425262728fun findTask(scanLocalQueue: Boolean): Task? { if (tryAcquireCpuPermit()) return findAnyTask(scanLocalQueue) // If we can't acquire a CPU permit -- attempt to find blocking task val task = if (scanLocalQueue) { // localQueue.poll() ?: globalBlockingQueue.removeFirstOrNull() } else { globalBlockingQueue.removeFirstOrNull() } return task ?: trySteal(blockingOnly = true)}private fun findAnyTask(scanLocalQueue: Boolean): Task? { /* * Anti-starvation mechanism: probabilistically poll either local * or global queue to ensure progress for both external and internal tasks. */ if (scanLocalQueue) { val globalFirst = nextInt(2 * corePoolSize) == 0 if (globalFirst) pollGlobalQueues()?.let { return it } localQueue.poll()?.let { return it } if (!globalFirst) pollGlobalQueues()?.let { return it } } else { pollGlobalQueues()?.let { return it } } return trySteal(blockingOnly = false)} tryAcquireCpuPermit()å°è¯•å½“å‰æ˜¯ä¸æ˜¯å æœ‰CPUæ§åˆ¶æƒï¼Œæœ‰çš„è¯å°±çœ‹å…¨å±€Taské˜Ÿåˆ—å’Œç§æœ‰Taské˜Ÿåˆ—å“ªä¸ªä¼˜å…ˆçº§æ›´é«˜ï¼Œå“ªä¸ªé«˜å°±ä»å“ªä¸ªå–ä»»åŠ¡ å¦‚æœæ²¡æœ‰CPUä½¿ç”¨æƒï¼Œé‚£ä¹ˆä¼˜å…ˆçœ‹æœ¬åœ°é˜Ÿåˆ—æ˜¯ä¸æ˜¯æœ‰ä»»åŠ¡ï¼Œæ²¡æœ‰çš„è¯å†å»å–å…¨å±€çš„IOå¯†é›†å‹ä»»åŠ¡ã€‚ å¦‚æœéƒ½æ²¡æ‹¿åˆ°ä»»åŠ¡çš„è¯ï¼Œæœ€åä¼šé€šè¿‡ trySteal() å°è¯•å»å·åˆ«çš„wokerçº¿ç¨‹çš„ä»»åŠ¡ è¿™é‡Œå¯ä»¥æ¸…æ¥šäº†åç¨‹çš„åˆ†å‘æµç¨‹ï¼Œå®é™…ä¸Šæ˜¯çº¿ç¨‹æ±  æ€»ç»“ï¼š æ–°å¯åŠ¨ä¸€ä¸ªåç¨‹ï¼Œé€šè¿‡scheduler çš„ dispatch åˆ†å‘ï¼ŒåŒ…è£…æˆä¸€ä¸ªTaskï¼Œå¦‚æœæ˜¯å½“å‰wokerçº¿ç¨‹ï¼Œåˆ™ç›´æ¥åŠ å…¥åˆ°å½“å‰Wokerçº¿ç¨‹çš„Taské˜Ÿåˆ—é‡Œé¢å»ï¼Œå¦‚æœå½“å‰Wokerçº¿ç¨‹æ˜¯nullï¼ŒåŠ å…¥åˆ°globalé˜Ÿåˆ—ä¸­ï¼Œå¹¶åˆ¤æ–­çº¿ç¨‹æ± å‚æ•°æ¥æ˜¯å¦å¯åŠ¨ä¸€ä¸ªæ–°çš„wokerï¼Œæ˜¯ä¸æ˜¯å¯ä»¥ä»pakedWokerçº¿ç¨‹é˜Ÿåˆ—é‡Œé¢å”¤é†’ä¸€ä¸ªwokerã€‚ Woker çº¿ç¨‹ä¸€æ—¦å¯åŠ¨ä¹‹åå°±æ˜¯ åœ¨ä¸€ä¸ªæ­»å¾ªç¯ runwokerä¸­ï¼Œä¸æ–­çš„å»findTaskæ¥æ‰§è¡Œï¼ŒfindTaskä¼˜å…ˆä»è‡ªå·±çº¿ç¨‹çš„Taské˜Ÿåˆ—æ‹¿ï¼Œç„¶åå…¨å±€çš„Taské˜Ÿåˆ—ï¼Œæœ€åè¿˜å¯ä»¥å»â€œå·â€å…¶ä»–wokerçš„Taskã€‚æ²¡æœ‰æ–°çš„Taskå°±ä¼šparkä½å½“å‰çº¿ç¨‹ï¼Œæ”¾å…¥pakerWokerçº¿ç¨‹é˜Ÿåˆ—é‡Œé¢ï¼Œç­‰å¾…ä¸‹æ¬¡æœ‰æ–°çš„å”¤é†’ã€‚ 3.Kotlin on JVM åç¨‹çš„å¯é‡å…¥æ€§ åç¨‹é‡å…¥ï¼ŸExample2 123456789 GlobalScope.launch { printThreadInfo() delay(5000) printThreadInfo() } sleep(1000) GlobalScope.launch { printThreadInfo() } è¾“å‡ºä¿¡æ¯ 123DefaultDispatcher-worker-1 @coroutine#1DefaultDispatcher-worker-1 @coroutine#2DefaultDispatcher-worker-1 @coroutine#1 å¯ä»¥çœ‹åˆ°åˆ›å»ºçš„2ä¸ªåç¨‹éƒ½åœ¨çº¿ç¨‹worker-1ï¼Œåç¨‹1åœ¨çº¿ç¨‹1ä¸Šæ‰§è¡Œäº†ä¸€ä¸‹ï¼Œç„¶åè®©å‡ºäº†çº¿ç¨‹ï¼Œæ¥ç€åç¨‹2è·å¾—çº¿ç¨‹æ‰§è¡Œï¼Œæœ€ååç¨‹1é‡æ–°è·å¾—çº¿ç¨‹æ‰§è¡Œã€‚ å—¯ï¼Ÿï¼Ÿï¼Ÿ,è¿™ç§â€œè°ƒåº¦â€æœºåˆ¶æ˜¯æ€ä¹ˆå®ç°çš„ï¼Ÿä¸€ä¸ªåç¨‹çš„æš‚åœå’Œæ¢å¤æ˜¯æ€ä¹ˆå®ç°çš„ï¼Ÿï¼Ÿï¼Ÿ åç¨‹çš„ç”Ÿå‘½å‘¨æœŸ å®é™…ä¸ŠKotlin JVM Coroutine çš„è¿è¡Œä¾èµ–äºå„ç§ Callback æœºåˆ¶ CPSï¼ˆContinuation-Passing-Style, ç»­ä½“ä¼ é€’é£æ ¼ï¼‰ å‡½æ•°é€šè¿‡å›è°ƒä¼ é€’ç»“æœ ä¸€èˆ¬çš„å†™æ³• 12345678class Test { public static long plus(int i1, int i2) { return i1 + i2; } public static void main(String[] args) { System.out.println(plus(1, 2)); }} CPS å†™æ³• 1234567891011class Test { interface Continuation { void next(int result); } public static void plus(int i1, int i2, Continuation continuation) { continuation.next(i1 + i2); } public static void main(String[] args) { plus(1, 2, result -&gt; System.out.println(result)); }} Kotlin Continuation æ¥å£ 1234567891011public interface Continuation; { /** * The context of the coroutine that corresponds to this continuation. */ public val context: CoroutineContext /** * Resumes the execution of the corresponding coroutine passing a successful or failed [result] as the * return value of the last suspension point. */ public fun resumeWith(result: Resultlt)} æ¯æ¬¡åˆ‡å‡ºå»åˆ° suspend çŠ¶æ€ï¼Œå†è¿›å…¥ running çŠ¶æ€éƒ½æ˜¯é€šè¿‡ resumeWith æ¥å£ Coroutine å®ç°äº† Job,Continuationï¼ŒCoroutineScope æ¥å£ 123456789public abstract class AbstractCoroutine;( /** * The context of the parent coroutine. */ @JvmField protected val parentContext: CoroutineContext, active: Boolean = true) : JobSupport(active), Job, Continuation&amp;lt;, CoroutineScope { // çœç•¥ Kotlin Coroutine â€”&gt; Java åç¼–è¯‘ å¯¹Example1åšåç¼–è¯‘ï¼Œçœ‹ä¸‹å­—èŠ‚ç çš„å±‚é¢ 12345678910 public static final Object test(Continuation&amp;lt;? super Unit&amp;gt; $completion) { Job launch$default = BuildersKt__Builders_commonKt.launch$default(GlobalScope.INSTANCE, (CoroutineContext) null, (CoroutineStart) null, new KotlinCodeKt$test$job$1((Continuation) null), 3, (Object) null); Thread.sleep(10000); return Unit.INSTANCE; } public static final void printThreadInfo() { Thread currentThread = Thread.currentThread(); Intrinsics.checkExpressionValueIsNotNull(currentThread, &amp;quot;Thread.currentThread()&amp;quot;); System.out.println(currentThread.getName()); } Kotlin å‡½æ•° ç”Ÿæˆäº†ä¸€ä¸ª åŒ¿åå‡½æ•° KotlinCodeKt$test$job$1 ç»§æ‰¿äº† SuspendLambda è€Œ SuspendLambda &lt;â€”- ContinuationImpl &lt;â€”- BaseContinuationImpl &lt;â€”-Continuation ä¹Ÿå°±æ˜¯è¯´æˆ‘ä»¬å†™çš„ä»£ç ï¼Œè¢«ç¼–è¯‘å™¨åŒ…è£…æˆäº†ä¸€ä¸ª Continuation 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596final class KotlinCodeKt$test$job$1 extends SuspendLambda implements Function2&amp;lt;CoroutineScope, Continuation&amp;lt;? super Unit&amp;gt;, Object&amp;gt; { Object L$0; int label; private CoroutineScope p$; KotlinCodeKt$test$job$1(Continuation continuation) { super(2, continuation); } public final Continuation&amp;lt;Unit&amp;gt; create(Object obj, Continuation&amp;lt;?&amp;gt; continuation) { Intrinsics.checkParameterIsNotNull(continuation, &amp;quot;completion&amp;quot;); KotlinCodeKt$test$job$1 kotlinCodeKt$test$job$1 = new KotlinCodeKt$test$job$1(continuation); CoroutineScope coroutineScope = (CoroutineScope) obj; kotlinCodeKt$test$job$1.p$ = (CoroutineScope) obj; return kotlinCodeKt$test$job$1; } public final Object invoke(Object obj, Object obj2) { return ((KotlinCodeKt$test$job$1) create(obj, (Continuation) obj2)).invokeSuspend(Unit.INSTANCE); } // è°ƒç”¨ resumeWith() æ¢å¤åç¨‹è°ƒç”¨çš„æ–¹æ³•ï¼Œå®ƒé‡Œé¢çš„é€»è¾‘ï¼Œæ˜¯è°ƒç”¨invokeSuspend() è¿™ä¸ªæ–¹æ³•å†…éƒ¨å°±æ˜¯æˆ‘ä»¬è‡ªå·±å†™çš„åç¨‹ä»»åŠ¡çš„ä»£ç  // return coroutine_suspended è¡¨ç¤ºåç¨‹æŒ‚èµ·äº† public final Object invokeSuspend(Object $result) { CoroutineScope $this$launch; Object coroutine_suspended = IntrinsicsKt.getCOROUTINE_SUSPENDED(); int i = this.label; if (i == 0) { ResultKt.throwOnFailure($result); $this$launch = this.p$; this.L$0 = $this$launch; this.label = 1; //è°ƒç”¨æˆ‘ä»¬å†™çš„ä»£ç ç‰‡æ®µ if (DelayKt.delay(2000, this) == coroutine_suspended) { return coroutine_suspended; } } else if (i == 1) { $this$launch = (CoroutineScope) this.L$0; ResultKt.throwOnFailure($result); } else if (i == 2) { CoroutineScope $this$launch2 = (CoroutineScope) this.L$0; ResultKt.throwOnFailure($result); KotlinCodeKt.printThreadInfo(); return Unit.INSTANCE; } else { throw new IllegalStateException(&amp;quot;call to &amp;#39;resume&amp;#39; before &amp;#39;invoke&amp;#39; with coroutine&amp;quot;); } //è°ƒç”¨æˆ‘ä»¬å†™çš„ä»£ç ç‰‡æ®µ KotlinCodeKt.printThreadInfo(); this.L$0 = $this$launch; this.label = 2; //è°ƒç”¨æˆ‘ä»¬å†™çš„ä»£ç ç‰‡æ®µ // è¿™é‡Œå®é™…ä¸Šå°± è¾¾åˆ°dealy çš„æ•ˆæœï¼ŒpostDelayed(Time=2000ï¼ŒRunnable = this) // è®©this Runable è·å¾—å†æ¬¡è°ƒåº¦çš„æœºä¼š // è¿™é‡Œæ˜¯éé˜»å¡çš„ if (DelayKt.delay(2000, this) == coroutine_suspended) { return coroutine_suspended; } CoroutineScope coroutineScope = $this$launch; //è°ƒç”¨æˆ‘ä»¬å†™çš„ä»£ç ç‰‡æ®µ KotlinCodeKt.printThreadInfo(); return Unit.INSTANCE; }}public final override fun resumeWith(result: Result&amp;lt;Any?&amp;gt;) { // This loop unrolls recursion in current.resumeWith(param) to make saner and shorter stack traces on resume var current = this var param = result while (true) { // Invoke &amp;quot;resume&amp;quot; debug probe on every resumed continuation, so that a debugging library infrastructure // can precisely track what part of suspended callstack was already resumed probeCoroutineResumed(current) with(current) { val completion = completion!! // fail fast when trying to resume continuation without completion val outcome: Result&amp;lt;Any?&amp;gt; = try { val outcome = invokeSuspend(param) // å¦‚æœæ˜¯SUSPENDEDåˆ™ç›´æ¥returnè¿™æ¬¡resume if (outcome === COROUTINE_SUSPENDED) return Result.success(outcome) } catch (exception: Throwable) { Result.failure(exception) } releaseIntercepted() // this state machine instance is terminating if (completion is BaseContinuationImpl) { // unrolling recursion via loop current = completion param = outcome } else { // top-level completion reached -- invoke and return completion.resumeWith(outcome) return } } } } é€šè¿‡å…³é”®è¯ç»“åˆç¼–è¯‘æœŸæˆ‘ä»¬è‡ªå·±å†™çš„åç¨‹ä»£ç è¿›è¡ŒåŒ…è£…æˆ Continuation å¯¹è±¡ï¼Œå®é™…å°±æ˜¯å¯¹ä»£ç è¿›è¡Œäº†åˆ†ç‰‡ï¼Œåœ¨æ‰§è¡Œå’Œå”¤é†’çš„ç²’åº¦å°±æ˜¯ä»£ç ç‰‡ Kotlin on JVM åç¨‹æœ¬è´¨æ˜¯é€šè¿‡ç¼–è¯‘åˆ†ç‰‡å’ŒçŠ¶æ€æœºæ¥å®ç°ï¼Œæ²¡æœ‰åç¨‹çš„ç°åœºæ¢å¤å’Œä¿ç•™çš„è¿‡ç¨‹ã€‚ dealyæš‚åœï¼Œå®é™…ä¸Šæ˜¯returnäº†ï¼Œdealyçš„æ—¶é—´å®é™…ä¸Šæ˜¯é€šè¿‡ postDelayed(Timeï¼Œ_Runnable)æ¥å®ç°ï¼Œä½†æ˜¯_postDelayå¹¶ä¸æ˜¯poståˆ°scheduleré‡Œé¢çš„Taské˜Ÿåˆ—é‡Œé¢çš„ã€‚ Dealy 2s åˆæ˜¯æ€ä¹ˆå®ç°çš„ï¼Ÿï¼Ÿï¼Ÿ 1DelayKt.delay(2000, this) è”ç³»åˆ°handler ï¼Œæ¶‰åŠåˆ°å»¶æ—¶çš„ï¼Œè‚¯å®šæ˜¯æœ‰åºçš„ï¼Œæ€ä¹ˆå®ç°æ—¶é—´æœ‰åºï¼Ÿ å®é™…æ˜¯ åŒ…è£…æˆäº†ä¸€ä¸ª DelayedResumeTask ,ç­‰æ—¶é—´åˆ°äº†ï¼Œæœ€åè°ƒç”¨task.run è¿˜æ˜¯ èµ°åˆ°äº†ä¸Šé¢çš„schedulerçš„dispatchæµç¨‹ã€‚ 1234567private inner class DelayedResumeTask( nanoTime: Long, private val cont: CancellableContinuation&lt;Unit&gt;) : DelayedTask(nanoTime) { override fun run() { with(cont) { resumeUndispatched(Unit) } } override fun toString(): String = super.toString() + cont.toString()} å»¶è¿Ÿ2ç§’æ˜¯æ€ä¹ˆå®ç°çš„ï¼Ÿï¼Ÿï¼Ÿ æˆ‘ä»¬å†™çš„dalayé¦–å…ˆç›´æ¥ä¼šè°ƒåˆ° 123456789101112131415public suspend fun delay(timeMillis: Long) { if (timeMillis &lt;= 0) return // don't delay return suspendCancellableCoroutine sc@ { cont: CancellableContinuation&lt;Unit&gt; -&gt; // è¿™é‡Œè·å–äº†context.delay cont.context.delay.scheduleResumeAfterDelay(timeMillis, cont) }}// å®é™…ä¸Šè·å–äº† DefaultDelay internal val CoroutineContext.delay: Delay get() = get(ContinuationInterceptor) as? Delay ?: DefaultDelay// DefaultDelay å°±æ˜¯ DefaultExecutorinternal actual val DefaultDelay: Delay = DefaultExecutor ä¹Ÿå°±æ˜¯è¯´dealyçš„æ—¶å€™å’Œ DefaultExecutoræŒ‚é’©äº† ç„¶å dealyæ–¹æ³• ä¼šå…ˆè°ƒåˆ° EventLoop.common.kt:370 123456789private fun scheduleImpl(now: Long, delayedTask: DelayedTask): Int { if (isCompleted) return SCHEDULE_COMPLETED val delayedQueue = _delayed.value ?: run { _delayed.compareAndSet(null, DelayedTaskQueue(now)) _delayed.value!! } //è¿™é‡Œå¯ä»¥çœ‹ delayedQueue = _delayedå®é™…ä¸Šæ˜¯DelayedTaskQueue return delayedTask.scheduleTask(now, delayedQueue, this)} DelayedTaskQueue ç»§æ‰¿äº†ThreadSafeHeap ç»§ç»­è·Ÿè¸ª scheduleTaskï¼Œå®é™…ä¸Šèµ°åˆ°commonMain/internal/ThreadSafeHeap.kt:64ï¼Œæ·»åŠ åˆ°æœ€å 12345678public inline fun addLastIf(node: T, cond: (T?) -&gt; Boolean): Boolean = synchronized(this) { if (cond(firstImpl())) { addImpl(node) true } else { false }} addImplé‡Œé¢å®é™…ä¸Šå°±æ˜¯æ·»åŠ åˆ°æ•°ç»„çš„æœ€åé¢ 1234567891011121314151617181920212223242526272829303132internal fun addImpl(node: T) { assert { node.heap == null } node.heap = this val a = realloc() val i = size++ a[i] = node node.index = i // è°ƒæ•´ siftUpFrom(i)}// è¿™é‡Œåœ¨æ¯”è¾ƒè°ƒæ•´ï¼Œçœ‹ä¸‹ å®ç°çš„ Comparable&lt;T&gt;private tailrec fun siftUpFrom(i: Int) { if (i &lt;= 0) return val a = a!! val j = (i - 1) / 2 if (a[j]!! &lt;= a[i]!!) return swap(i, j) siftUpFrom(j)}// æ˜¯åœ¨æ¯”è¾ƒ dealy timeoverride fun compareTo(other: DelayedTask): Int { val dTime = nanoTime - other.nanoTime return when { dTime &gt; 0 -&gt; 1 dTime &lt; 0 -&gt; -1 else -&gt; 0 }} å…·ä½“çš„å»¶æ—¶æ˜¯é€šè¿‡ DelayedTaskQueueæ¥å®šæ—¶è°ƒåº¦ä»»åŠ¡çš„ï¼Œå®é™…ä¸Šæ˜¯é€šè¿‡æœ€å°å †æ¥æ’åºçš„ï¼Œæ·»åŠ çš„node é€šè¿‡ æ¯”è¾ƒ dealy æ—¶é—´ã€‚ sheduleImplå®Œæˆä¹‹åï¼Œä¹Ÿå°±åŠ å…¥åˆ°DefaultExecutorçš„ DelayedTaskQueueä¹‹åï¼Œè°ƒç”¨äº†unpark 12345678public fun schedule(now: Long, delayedTask: DelayedTask) { when (scheduleImpl(now, delayedTask)) { SCHEDULE_OK -&gt; if (shouldUnpark(delayedTask)) unpark() SCHEDULE_COMPLETED -&gt; reschedule(now, delayedTask) SCHEDULE_DISPOSED -&gt; {} // do nothing -- task was already disposed else -&gt; error(&quot;unexpected result&quot;) }} Unpark é‡Œé¢ å‘ç°çº¿ç¨‹ä¸ºnullï¼Œåˆ™ä¼šåˆ›å»ºçº¿ç¨‹ï¼Œstartçº¿ç¨‹ï¼Œç›´æ¥å°±æ˜¯DefaultExecutorçš„runæ–¹æ³•äº†ï¼Œruné‡Œé¢è°ƒç”¨processNextEventã€‚è¿™é‡Œå°±æ˜¯å–å‡ºæ¥ç”¨äº†ï¼Œè°ƒç”¨ processNextEvent() æ¥å¤„ç†äº‹ä»¶ã€‚ 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647// ç•™æ„ processNextEvent() æ˜¯æœ‰è¿”å›å€¼çš„ï¼Œå®é™…ä¸Šè¿”å›çš„çº¿ç¨‹çš„parkæ—¶é—´override fun processNextEvent(): Long { // çœç•¥éƒ¨åˆ†ä»£ç  //è¿™é‡Œå‡ºç°äº† _delayed ï¼Œä¹Ÿå°±æ˜¯ä¸Šé¢æåˆ°äº†DelayedTaskQueue val delayed = _delayed.value if (delayed != null &amp;&amp; !delayed.isEmpty) { val now = nanoTime() // while ï¼Œæ˜¯å¯èƒ½å­˜åœ¨å¤šä¸ªtaskåˆ°æœŸäº† while (true) { // è¿™é‡Œä» DelayedTaskQueue å–å‡ºæ¥æ”¾åˆ°äº† é˜Ÿåˆ— _queue ä¸­å»äº† // it.timeToExecuteå®é™…ä¸Šå°±æ˜¯æ¯”è¾ƒ now - nanoTime &gt;= 0 delayed.removeFirstIf { if (it.timeToExecute(now)) { enqueueImpl(it) } else false } ?: break // quit loop when nothing more to remove or enqueueImpl returns false on \"isComplete\" } } // ä» _queue é‡Œé¢å–å‡ºä¸€ä¸ªæ¥DelayedResumeTaskä»»åŠ¡æ‰§è¡Œ // è™½ç„¶æœ¬æ¬¡å¯èƒ½åŠ å…¥å¤šä¸ªTaskï¼Œä½†æ˜¯æœ¬æ¬¡åªæ‰§è¡Œä¸€ä¸ªï¼Œå‰©ä¸‹çš„ä¸‹æ¬¡æ‰§è¡Œï¼Œ val task = dequeue() if (task != null) { task.run() return 0 } // éœ€è¦park return nextTime}// æ ¹æ®queueå’ŒnextDelayedTaskåˆ¤æ–­ï¼Œæœ¬æ¬¡éœ€è¦parkçš„æ—¶é—´protected override val nextTime: Long get() { if (super.nextTime == 0L) return 0L val queue = _queue.value when { queue === null -&gt; {} // empty queue -- proceed queue is Queue&lt;*&gt; -&gt; if (!queue.isEmpty) return 0 // non-empty queue queue === CLOSED_EMPTY -&gt; return Long.MAX_VALUE // no more events -- closed else -&gt; return 0 // non-empty queue } val nextDelayedTask = _delayed.value?.peek() ?: return Long.MAX_VALUE return (nextDelayedTask.nanoTime - nanoTime()).coerceAtLeast(0) } ä¸ºä»€ä¹ˆè¦å–å‡ºæ¥æ”¾åˆ°_queueï¼Œç›´æ¥å–å‡ºæ¥æ‰§è¡Œä¸è¡Œï¼Ÿ å–å‡ºæ¥ä¸€ä¸ªï¼Œæ‰§è¡Œä¸€ä¸ªï¼Œéœ€è¦æ—¶é—´ï¼Œè€Œä¸”åœ¨å¤šæ¬¡ä¿®æ”¹ThreadSafeHeapæ’åºå †ï¼ŒåŒæ—¶å…¶ä»–çº¿ç¨‹ä¹Ÿå¯èƒ½å­˜åœ¨ç«äº‰æƒ…å†µï¼Œæ˜¯å¸¦æœ‰é”çš„ï¼Œä¸€æ¬¡æ€§å–æ¥ï¼Œå–å‡ºæ¥çš„taskæ”¾åˆ°_queueæ˜¯æ— åºçš„ã€‚ Dealy ä¼šå¯¼è‡´åç¨‹åˆ‡æ¢çº¿ç¨‹å—ï¼Ÿ å¯ä»¥ï¼Œåç¨‹å¯èƒ½åˆ‡æ¢çº¿ç¨‹ã€‚å¦‚æœå½“å‰åç¨‹è·å¾—æ¢å¤æ‰§è¡Œï¼Œè€ŒåŸå…ˆçš„çº¿ç¨‹åˆåœ¨æ‰§è¡Œå…¶å®ƒçº¿ç¨‹ï¼Œåˆ™åç¨‹ä¼šåœ¨å…¶å®ƒçº¿ç¨‹ä¸Šæ‰§è¡Œã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œåç¨‹åœ¨ç”Ÿå‘½å‘¨æœŸä¸­å¯ä»¥æ›´æ¢çº¿ç¨‹ã€‚ ä¸ºä»€ä¹ˆKotlin JVM è¦ç”¨çº¿ç¨‹æ± åŠ CPSçš„æ–¹å¼æ¥å®ç° ï¼Ÿç›´æ¥ç”¨çº¿ç¨‹æ± ä¸è¡Œï¼Ÿ ä¸»è¦æ˜¯JVMåŸç”Ÿæ²¡æœ‰åç¨‹çš„æ¦‚å¿µï¼Œæ„ŸçŸ¥ä¸åˆ°åç¨‹ï¼Œåªæœ‰çº¿ç¨‹ï¼ŒJVMè¦çœŸæ­£çš„åƒGOé‚£æ ·å…ƒç´ æ”¯æŒåç¨‹ï¼Œæ˜¯éœ€è¦ä¿®æ”¹JVMçš„ï¼Œæˆ–è€…æŠ›å¼ƒJVMï¼Œä½†è¿™æ ·é€šç”¨æ€§å’Œå¯æ‰©å±•æ€§å°±ä¼šå¾ˆå—å½±å“ Kotlin çš„ç›®æ ‡æ˜¯æƒ³è¦å…¨å¹³å°çš„ï¼ŒKotlin on JS ,Kotlin on Nativeã€‚ä½ JVMæ²¡æœ‰çš„èƒ½åŠ›ï¼Œä¸ä»£è¡¨å…¶ä»–æ²¡æœ‰ã€‚å¯ä»¥æä¾›ç»Ÿä¸€çš„ç¼–ç¨‹æ¥å£ï¼Œä¸ç”¨å…³å¿ƒå¹³å°çš„å®ç°ã€‚ æä¾›å‹å¥½çš„å¼‚æ­¥ç¼–ç¨‹æ–¹å¼ï¼Œç®€æ´ æ›´é«˜æŠ½è±¡éšè—å¼‚æ­¥å®ç°ç»†èŠ‚ï¼Œå®ç°å†™å¼‚æ­¥å¦‚åŒåŒæ­¥çš„é¡ºåºå¼å†™æ³•ï¼Œå¼€å‘ç»´æŠ¤æˆæœ¬å¤§å¤§å‡ä½ã€ä½†å†…å­˜ä¸Šæœ‰éƒ¨åˆ†çš„å¦¥åï¼Œåç¨‹å› ä¸ºåˆ›å»ºäº†ä¸­é—´çš„ä¸€ç³»åˆ—å°è£…å¯¹è±¡ï¼Œæ¯”ä¼ ç»Ÿçš„å¤šçº¿ç¨‹ç¼–ç¨‹å¢åŠ äº†é¢å¤–çš„å†…å­˜æ¶ˆè€— ä¸ºä»€ä¹ˆç”¨ dealy ä»£æ›¿ sleep ï¼Ÿ äº†è§£äº†Kotlinçš„åç¨‹å®ç°åŸç†ï¼Œåœ¨sleepçš„è¿™æ®µæ—¶é—´ï¼Œè¿˜æ˜¯å ç”¨å½“å‰çº¿ç¨‹ï¼Œå…¶ä»–åç¨‹å¾—ä¸åˆ°æ¥è¿™ä¸ªçº¿ç¨‹æ‰§è¡Œçš„æœºä¼šã€‚æœ¬è´¨ä¸Šsleepæ˜¯sleepäº†å½“å‰çº¿ç¨‹ï¼Œè€Œdealyæ˜¯dealyäº†å½“å‰åç¨‹ã€‚ é™„å½• å‚è€ƒèµ„æ–™ Thread.sleepã€Object.waitã€LockSupport.park åŒºåˆ« æ²¡è®²æ˜ç™½ï¼Œçœ‹ä¸‹åŸæ–‡å‘— https://www.jianshu.com/p/557a728e74c6 https://ethanhua.github.io/2018/12/24/kotlin_coroutines/ https://blog.csdn.net/weixin_42063726/article/details/106198068","link":"/2020/09/13/Kotlin/Kotlin-on-JVM%E5%8D%8F%E7%A8%8B/"},{"title":"é˜Ÿåˆ—çš„æœ€å¤§å€¼","text":"è¯·å®šä¹‰ä¸€ä¸ªé˜Ÿåˆ—å¹¶å®ç°å‡½æ•° max_value å¾—åˆ°é˜Ÿåˆ—é‡Œçš„æœ€å¤§å€¼ï¼Œè¦æ±‚å‡½æ•°max_valueã€push_back å’Œ pop_front çš„å‡æ‘Šæ—¶é—´å¤æ‚åº¦éƒ½æ˜¯O(1)ã€‚ è‹¥é˜Ÿåˆ—ä¸ºç©ºï¼Œpop_front å’Œ max_value éœ€è¦è¿”å› -1 ç¤ºä¾‹ 1ï¼š è¾“å…¥:[â€œMaxQueueâ€,â€push_backâ€,â€push_backâ€,â€max_valueâ€,â€pop_frontâ€,â€max_valueâ€][[],[1],[2],[],[],[]]*è¾“å‡º: *[null,null,null,2,1,2] ç¤ºä¾‹ 2ï¼š è¾“å…¥:[â€œMaxQueueâ€,â€pop_frontâ€,â€max_valueâ€][[],[],[]]*è¾“å‡º: *[null,-1,-1] é™åˆ¶ï¼š 1 &lt;= push_back,pop_front,max_valueçš„æ€»æ“ä½œæ•° &lt;= 10000 1 &lt;= value &lt;= 10^5 é˜Ÿåˆ—æ ‡è®°æ¯æ¬¡æ ‡è®°ä¸Šä¸€æ¬¡æœ€å¤§å€¼çš„åé¢çš„æœ€å¤§å€¼ã€‚ class MaxQueue {1234567891011121314151617181920212223242526272829303132333435363738394041424344454647 //è®°å½•å½“å‰çš„æ•° ArrayDeque&lt;Integer&gt; queue = new ArrayDeque&lt;&gt;(); //è®°å½•æ¯æ¬¡æ›´æ–°çš„æœ€å¤§å€¼ ArrayDeque&lt;Integer&gt; maxIndex = new ArrayDeque&lt;&gt;(); public MaxQueue() { } //maxIndexå¤´èŠ‚ç‚¹å°±æ˜¯å½“å‰çš„ public int max_value() { if (queue.isEmpty()) { return -1; } return maxIndex.peek(); } // è®°å½•æ›´æ–°æ¯æ¬¡çš„æœ€å¤§å€¼ï¼Œå‰é¢çš„å°çš„ï¼Œéƒ½å‡ºé˜Ÿï¼Œæ‰€ä»¥æ¯æ¬¡å°±ä¿ç•™äº†åé¢çš„æœ€å¤§å€¼ // å®é™…ä¸Šmaxindexé™åºä¿ç•™æœ€å¤§å€¼ public void push_back(int value) { if (!queue.isEmpty()) { //æ¯æ¬¡ä¿ç•™æœ€å¤§å€¼ while (!maxIndex.isEmpty()&amp;&amp;maxIndex.getLast() &lt;= value) { maxIndex.removeLast(); } } maxIndex.add(value); queue.add(value); } public int pop_front() { if (queue.isEmpty()) { return -1; } Integer poll = queue.poll(); //è‹¥æœå½“å‰ å¼¹å‡ºçš„æ•°ï¼Œæœ€å¤§å€¼å‡ºé˜Ÿ if (poll.equals(maxIndex.peek())) { maxIndex.poll(); } return poll ; }}","link":"/2020/05/01/LeetCode/dui-lie-de-zui-da-zhi-lcof/"},{"title":"ä¸‘æ•°","text":"æˆ‘ä»¬æŠŠåªåŒ…å«å› å­ 2ã€3 å’Œ 5 çš„æ•°ç§°ä½œä¸‘æ•°ï¼ˆUgly Numberï¼‰ã€‚æ±‚æŒ‰ä»å°åˆ°å¤§çš„é¡ºåºçš„ç¬¬ n ä¸ªä¸‘æ•°ã€‚ ç¤ºä¾‹: è¾“å…¥: n = 10è¾“å‡º: 12è§£é‡Š: 1, 2, 3, 4, 5, 6, 8, 9, 10, 12 æ˜¯å‰ 10 ä¸ªä¸‘æ•°ã€‚ *è¯´æ˜: * 1 æ˜¯ä¸‘æ•°ã€‚ n ä¸è¶…è¿‡1690ã€‚ ä¸‘æ•°çš„é€’æ¨æ€§è´¨ï¼š ä¸‘æ•°åªåŒ…å«å› å­ 2,3,52, 3, 5 2, 3,5 ï¼Œå› æ­¤æœ‰ â€œä¸‘æ•° == = æŸè¾ƒå°ä¸‘æ•° Ã—\\times Ã— æŸå› å­â€ ï¼ˆä¾‹å¦‚ï¼š10=5Ã—210 = 5 \\times 2 10= 5Ã— 2 ï¼‰ã€‚ ä¸‘æ•°çš„é€’æ¨æ€§è´¨ï¼š ä¸‘æ•°åªåŒ…å«å› å­ 2, 3, 52,3,5 ï¼Œå› æ­¤æœ‰ â€œä¸‘æ•° == æŸè¾ƒå°ä¸‘æ•° \\timesÃ— æŸå› å­â€ ï¼ˆä¾‹å¦‚ï¼š10 = 5 \\times 210=5Ã—2ï¼‰ã€‚ ä½œè€…ï¼šjydé“¾æ¥ï¼šhttps://leetcode-cn.com/problems/chou-shu-lcof/solution/mian-shi-ti-49-chou-shu-dong-tai-gui-hua-qing-xi-t/æ¥æºï¼šåŠ›æ‰£ï¼ˆLeetCodeï¼‰è‘—ä½œæƒå½’ä½œè€…æ‰€æœ‰ã€‚å•†ä¸šè½¬è½½è¯·è”ç³»ä½œè€…è·å¾—æˆæƒï¼Œéå•†ä¸šè½¬è½½è¯·æ³¨æ˜å‡ºå¤„ã€‚ 12345678910111213141516171819202122//ä¸‘æ•°çš„é€’æ¨æ€§è´¨ï¼š ä¸‘æ•°åªåŒ…å«å› å­ 2, 3, 52,3,5 ï¼Œå› æ­¤æœ‰ â€œä¸‘æ•° == æŸè¾ƒå°ä¸‘æ•° \\timesÃ— æŸå› å­â€ ï¼ˆä¾‹å¦‚ï¼š10 = 5 \\times 210=5Ã—2ï¼‰ã€‚public int nthUglyNumber(int n) { int[] dp = new int[n]; dp[0] = 1; //ç”¨a,b,c æ ‡è®°åˆ†åˆ«*2ï¼Œ*3ï¼Œ*5çš„æ•° //å› ä¸ºå¯èƒ½å­˜åœ¨å…ˆåŠ å…¥äº†æ¯”è¾ƒå¤§çš„æ•°,æ‰€ä»¥ä¸èƒ½ç›´æ¥æŒ‰é¡ºåºåŠ å…¥ã€‚åˆ†åˆ«æ ‡è®°ä¸Šä¸€æ¬¡ç”¨äº†è° int a=0, b=0, c = 0; for (int i = 1; i &lt; n; i++) { int numA = dp[a] * 2; int numB = dp[b] * 3; int numC = dp[c] * 5; //ä¿è¯äº†å½“æœŸé‚£æ·»åŠ çš„æ˜¯æœ€å°çš„ dp[i] = Math.min(numA, Math.min(numB, numC)); //å¯èƒ½ä¼šå­˜åœ¨ç›¸ç­‰çš„æƒ…å†µï¼Œéƒ½åŠ  if(dp[i] == numA) a++; if(dp[i] == numB) b++; if(dp[i] == numC) c++; } return dp[n-1];}","link":"/2020/04/24/LeetCode/chou-shu-lcof/"},{"title":"äºŒå‰æ ‘ä¸­å’Œä¸ºæŸä¸€å€¼çš„è·¯å¾„","text":"è¾“å…¥ä¸€æ£µäºŒå‰æ ‘å’Œä¸€ä¸ªæ•´æ•°ï¼Œæ‰“å°å‡ºäºŒå‰æ ‘ä¸­èŠ‚ç‚¹å€¼çš„å’Œä¸ºè¾“å…¥æ•´æ•°çš„æ‰€æœ‰è·¯å¾„ã€‚ä»æ ‘çš„æ ¹èŠ‚ç‚¹å¼€å§‹å¾€ä¸‹ä¸€ç›´åˆ°å¶èŠ‚ç‚¹æ‰€ç»è¿‡çš„èŠ‚ç‚¹å½¢æˆä¸€æ¡è·¯å¾„ã€‚ ç¤ºä¾‹:ç»™å®šå¦‚ä¸‹äºŒå‰æ ‘ï¼Œä»¥åŠç›®æ ‡å’Œ sum = 22ï¼Œ 5 / \\ 4 8 / / \\ 11 13 4 / \\ / \\ 7 2 5 1è¿”å›: [ [5,4,11,2], [5,8,4,5]] æç¤ºï¼š èŠ‚ç‚¹æ€»æ•° &lt;= 10000 å®é™…ä¸Šå°±æ˜¯å…ˆåºéå†ï¼Œè®°å½•è·¯å¾„ï¼Œå›é€€çš„æ—¶å€™è®°å¾—removeæ‰å¶å­ è§£æ³•1 ï¼š7ms1234567891011121314151617181920212223242526class Solution { List&lt;List&lt;Integer&gt;&gt; result = new ArrayList&lt;&gt;(); int sum; public List&lt;List&lt;Integer&gt;&gt; pathSum(TreeNode root, int sum) { this.sum = sum; lookSum(root, new ArrayList&lt;&gt;()); return result; } public void lookSum(TreeNode root,List&lt;Integer&gt; integerList){ if(root == null){ return; } //å› ä¸ºJavaæ˜¯ä¼ é€’çš„å¼•ç”¨,æˆ‘ä»¬ä¸èƒ½å…±åŒç”¨ä¸€ä¸ªlistã€‚è€Œæ˜¯æ¯æ¬¡newä¸€ä¸ªï¼Œå¤ç”¨ä¹‹å‰çš„è·¯å¾„ ArrayList&lt;Integer&gt; integerArrayList = new ArrayList&lt;&gt;(integerList); integerArrayList.add(root.val); if(root.left == null &amp;&amp; root.right == null){ if (integerArrayList.stream().mapToInt(Integer::intValue).sum() == sum) { result.add(integerArrayList); } return; } lookSum(root.left, integerArrayList); lookSum(root.right, integerArrayList); }} æ‰§è¡Œç”¨æ—¶ï¼š7 ms å†…å­˜æ¶ˆè€—ï¼š42.2 MB ç¼ºç‚¹ï¼š æ¯æ¬¡éƒ½newäº† æ¯æ¬¡éƒ½è®¡ç®—äº†æ•°ç»„äº†å’Œäº† stream æ˜¯è¦æ…¢ä¸€ç‚¹ ä¼˜åŒ– ï¼š3ms12345678910111213141516171819202122232425class Solution { List&lt;List&lt;Integer&gt;&gt; result = new ArrayList&lt;&gt;(); int sum; public List&lt;List&lt;Integer&gt;&gt; pathSum(TreeNode root, int sum) { this.sum = sum; lookSum(root, new ArrayList&lt;&gt;(),0); return result; } public void lookSum(TreeNode root,List&lt;Integer&gt; integerList,int cur_sum){ if(root == null){ return; } ArrayList&lt;Integer&gt; integerArrayList = new ArrayList&lt;&gt;(integerList); integerArrayList.add(root.val); if(root.left == null &amp;&amp; root.right == null){ if (cur_sum+root.val == sum) { result.add(integerArrayList); } return; } lookSum(root.left, integerArrayList,cur_sum+root.val); lookSum(root.right, integerArrayList, cur_sum + root.val); }} æ‰§è¡Œç”¨æ—¶ï¼š3 ms å†…å­˜æ¶ˆè€—ï¼š42.9 MBç¼ºç‚¹ ä¸ç”¨æ¯æ¬¡éƒ½è®¡ç®—å’Œäº†ï¼ŒæŠŠå’Œæ ‡è®°ä¸‹ æ¯æ¬¡éƒ½newæœ‰ç‚¹ä¸åˆ’ç®— ä¼˜åŒ– ï¼š1ms12345678910111213141516171819202122232425262728class Solution { List&lt;List&lt;Integer&gt;&gt; result = new ArrayList&lt;&gt;(); int sum; public List&lt;List&lt;Integer&gt;&gt; pathSum(TreeNode root, int sum) { this.sum = sum; lookSum(root, new ArrayList&lt;&gt;(),0); return result; } public void lookSum(TreeNode root,List&lt;Integer&gt; integerList,int cur_sum){ if(root == null){ return; } integerList.add(root.val); if(root.left == null &amp;&amp; root.right == null){ if (cur_sum+root.val == sum) { result.add(new ArrayList&lt;&gt;(integerList)); } //å›é€€è®°å¾—remove integerList.remove(integerList.size() - 1); return; } lookSum(root.left, integerList,cur_sum+root.val); lookSum(root.right, integerList, cur_sum + root.val); //å›é€€è®°å¾—remove integerList.remove(integerList.size() - 1); }} æ‰§è¡Œç”¨æ—¶ï¼š1 ms å†…å­˜æ¶ˆè€—ï¼š39.7 MB","link":"/2020/04/27/LeetCode/er-cha-shu-zhong-he-wei-mou-yi-zhi-de-lu-jing-lcof/"},{"title":"äºŒå‰æœç´¢æ ‘çš„ååºéå†åºåˆ—","text":"è¾“å…¥ä¸€ä¸ªæ•´æ•°æ•°ç»„ï¼Œåˆ¤æ–­è¯¥æ•°ç»„æ˜¯ä¸æ˜¯æŸäºŒå‰æœç´¢æ ‘çš„ååºéå†ç»“æœã€‚å¦‚æœæ˜¯åˆ™è¿”å› trueï¼Œå¦åˆ™è¿”å› falseã€‚å‡è®¾è¾“å…¥çš„æ•°ç»„çš„ä»»æ„ä¸¤ä¸ªæ•°å­—éƒ½äº’ä¸ç›¸åŒã€‚ å‚è€ƒä»¥ä¸‹è¿™é¢—äºŒå‰æœç´¢æ ‘ï¼š 5 / \\ 2 6 / \\ 1 3ç¤ºä¾‹ 1ï¼š è¾“å…¥: [1,6,3,2,5]è¾“å‡º: false ç¤ºä¾‹ 2ï¼š è¾“å…¥: [1,3,2,6,5]è¾“å‡º: true æç¤ºï¼š æ•°ç»„é•¿åº¦ &lt;= 1000 é€’å½’äºŒå‰æœç´¢æ ‘çš„ï¼Œä¸­åºéå† å·¦ æ ¹ å³ æ˜¯å‡åºçš„ï¼Œä¹Ÿå°±æ˜¯å·¦æ¯”æ ¹å°ï¼Œå³æ¯”æ ¹å¤§ã€‚ åç»­éå†ç»“åˆäºŒå‰æ ‘çš„ç‰¹ç‚¹å°±æ˜¯ æœ€åä¸€ä¸ªæ˜¯æ ¹ï¼Œæ ¹çš„å‰é¢ï¼Œä¸€éƒ¨åˆ†è¿ç»­å°äºæ ¹ï¼Œåé¢ä¸€éƒ¨åˆ†è¿ç»­å¤§äºæ ¹ã€‚ æ»¡è¶³æ¡ä»¶ï¼Œå†é€’å½’åˆ¤æ–­å·¦å³å­æ ‘ï¼Œ 12345678910111213141516171819202122232425262728 class Solution { public boolean verifyPostorder(int[] postorder) { return recur(postorder,0,postorder.length-1); } //å½“å‰è¿™é¢—æ ‘ï¼Œå¼€å§‹å’Œç»“æŸçš„ç‚¹ public boolean recur(int[] postorder,int start ,int end ){ //åç»­éå†ï¼Œæœ€åä¸€ä¸ªå°±æ˜¯æ ¹ if (start &gt;= end) { return true; } //æœ‰è¿ç»­çš„ä¸€éƒ¨åˆ†å°äºæ ¹, æ‰¾åˆ°å°äºçš„ç•Œé™ int cur = start; while (postorder[cur] &lt; postorder[end]) cur++; //å·¦å­æ ‘çš„ç•Œé™ int left = cur-1; //ä»ç•Œé™å¼€å§‹ï¼Œæœ‰è¿ç»­çš„ä¸€éƒ¨åˆ†å¤§äºæ ¹ while (postorder[cur]&gt;postorder[end]) cur++; //åˆšå¥½é‡åˆ°æ ¹ &amp;&amp; å·¦å­æ ‘ &amp;&amp; å³å­æ ‘(å³å­æ ‘å½“ç„¶è¦å»æ‰æ ¹) return cur == end &amp;&amp; recur(postorder, start, left) &amp;&amp; recur(postorder,left+1, end-1); }}","link":"/2020/05/01/LeetCode/er-cha-sou-suo-shu-de-hou-xu-bian-li-xu-lie-lcof/"},{"title":"è‚¡ç¥¨çš„æœ€å¤§åˆ©æ¶¦","text":"å‡è®¾æŠŠæŸè‚¡ç¥¨çš„ä»·æ ¼æŒ‰ç…§æ—¶é—´å…ˆåé¡ºåºå­˜å‚¨åœ¨æ•°ç»„ä¸­ï¼Œè¯·é—®ä¹°å–è¯¥è‚¡ç¥¨ä¸€æ¬¡å¯èƒ½è·å¾—çš„æœ€å¤§åˆ©æ¶¦æ˜¯å¤šå°‘ï¼Ÿ ç¤ºä¾‹ 1: è¾“å…¥: [7,1,5,3,6,4]è¾“å‡º: 5è§£é‡Š: åœ¨ç¬¬ 2 å¤©ï¼ˆè‚¡ç¥¨ä»·æ ¼ = 1ï¼‰çš„æ—¶å€™ä¹°å…¥ï¼Œåœ¨ç¬¬ 5 å¤©ï¼ˆè‚¡ç¥¨ä»·æ ¼ = 6ï¼‰çš„æ—¶å€™å–å‡ºï¼Œæœ€å¤§åˆ©æ¶¦ = 6-1 = 5 ã€‚ æ³¨æ„åˆ©æ¶¦ä¸èƒ½æ˜¯ 7-1 = 6, å› ä¸ºå–å‡ºä»·æ ¼éœ€è¦å¤§äºä¹°å…¥ä»·æ ¼ã€‚ ç¤ºä¾‹ 2: è¾“å…¥: [7,6,4,3,1]è¾“å‡º: 0è§£é‡Š: åœ¨è¿™ç§æƒ…å†µä¸‹, æ²¡æœ‰äº¤æ˜“å®Œæˆ, æ‰€ä»¥æœ€å¤§åˆ©æ¶¦ä¸º 0ã€‚ é™åˆ¶ï¼š 0 &lt;= æ•°ç»„é•¿åº¦ &lt;= 10^5 æš´åŠ›æ³•å…ˆæŒ‰ä»·å€¼æ’åºï¼Œå¹¶æ ‡è®°æ—¥æœŸã€‚ä»é«˜ä»·å€¼å¼€å§‹éå†ï¼Œå¦‚æœæ»¡è¶³æ—¥æœŸå‰åå…³ç³»,åˆ™è¿™æ¬¡éå†ç»“æŸï¼Œæ›´æ–°æœ€å¤§å€¼ã€‚ 12345678910111213141516171819202122232425262728293031323334class Solution { class Tnode implements Comparable&lt;Tnode&gt;{ public Tnode(int vlaue, int index) { this.value = vlaue; this.index = index; } int value,index; @Override public int compareTo(Tnode o) { return o.value-value; } } public int maxProfit(int[] prices) { Tnode[] tnodes = new Tnode[prices.length]; for (int i = 0; i &lt; tnodes.length; i++) { tnodes[i] = new Tnode(prices[i], i); } //å…ˆæ’åº Arrays.sort(tnodes); int max = 0; for (int i = 0; i &lt; tnodes.length; i++) { for (int j = tnodes.length-1; j &gt;i ; j--) { if (tnodes[i].index &gt; tnodes[j].index) { max = Math.max(max, tnodes[i].value - tnodes[j].value); break; } } } return max; }} 1234200 / 200 ä¸ªé€šè¿‡æµ‹è¯•ç”¨ä¾‹çŠ¶æ€ï¼šé€šè¿‡æ‰§è¡Œç”¨æ—¶ï¼š431 mså†…å­˜æ¶ˆè€—ï¼š39.7 MB åŠ¨æ€è§„åˆ’ å½“å‰çš„å¯ä»¥è·å¾—æœ€å¤§ä»·å€¼ï¼Œå’Œå‰é¢å¯ä»¥è·å¾—çš„æœ€å¤§ä»·å€¼ï¼Œä¸å‰é¢æœ€ä½çš„ä»·å€¼ç›¸å…³ã€‚ 1234567891011121314151617public int maxProfit(int[] prices) { //å°äº2å¤©ï¼Œä¸èƒ½äº¤æ˜“ if (prices.length &lt; 2) { return 0; } int[] dp = new int[prices.length + 1]; dp[0] = 0; //æ ‡è®°åˆ°ç¬¬iå¤©ï¼Œç»è¿‡çš„æœ€å°å€¼ int min = prices[0]; for (int i = 1; i &lt;= prices.length; i++) { //å½“å‰æœ€å¤§ä»·å€¼ max(ä¸Šä¸€æ¬¡çš„ï¼Œå½“å¤©çš„ä»·å€¼å‡å»ä¹‹å‰çš„æœ€å°å€¼) dp[i] = Math.max(dp[i - 1], prices[i-1] - min); min = Math.min(min, prices[i-1]); } return dp[prices.length]; } 12345200 / 200 ä¸ªé€šè¿‡æµ‹è¯•ç”¨ä¾‹çŠ¶æ€ï¼šé€šè¿‡æ‰§è¡Œç”¨æ—¶ï¼š2 mså†…å­˜æ¶ˆè€—ï¼š39.8 MB","link":"/2020/04/23/LeetCode/gu-piao-de-zui-da-li-run-lcof/"},{"title":"å‰ªç»³å­","text":"ç»™ä½ ä¸€æ ¹é•¿åº¦ä¸º n çš„ç»³å­ï¼Œè¯·æŠŠç»³å­å‰ªæˆæ•´æ•°é•¿åº¦çš„ m æ®µï¼ˆmã€néƒ½æ˜¯æ•´æ•°ï¼Œn&gt;1å¹¶ä¸”m&gt;1ï¼‰ï¼Œæ¯æ®µç»³å­çš„é•¿åº¦è®°ä¸º k[0],k[1]...k[m] ã€‚è¯·é—® k[0]*k[1]*...*k[m] å¯èƒ½çš„æœ€å¤§ä¹˜ç§¯æ˜¯å¤šå°‘ï¼Ÿä¾‹å¦‚ï¼Œå½“ç»³å­çš„é•¿åº¦æ˜¯8æ—¶ï¼Œæˆ‘ä»¬æŠŠå®ƒå‰ªæˆé•¿åº¦åˆ†åˆ«ä¸º2ã€3ã€3çš„ä¸‰æ®µï¼Œæ­¤æ—¶å¾—åˆ°çš„æœ€å¤§ä¹˜ç§¯æ˜¯18ã€‚ ç¤ºä¾‹ 1ï¼š è¾“å…¥: 2è¾“å‡º: 1è§£é‡Š: 2 = 1 + 1, 1 Ã— 1 = 1 ç¤ºä¾‹ 2: è¾“å…¥: 10è¾“å‡º: 36è§£é‡Š: 10 = 3 + 3 + 4, 3 Ã— 3 Ã— 4 = 36 æç¤ºï¼š 2 &lt;= n &lt;= 58 1.æ•°å­¦æ¨å¯¼æˆ‘ä»¬éƒ½çŸ¥é“ä¸€ä¸ª â€œç®—æœ¯å‡ ä½•å‡å€¼ä¸ç­‰å¼â€ å½“ a=bçš„æ—¶å€™ï¼Œå–ç›¸ç­‰ï¼Œä¹Ÿå°±æ˜¯abçš„æœ€å¤§å€¼äº†ã€‚ è¯¥æ¨å¹¿çš„å…¬å¼ æ¨è®º å°†ç»³å­ ä»¥ç›¸ç­‰çš„é•¿åº¦ç­‰åˆ†ä¸ºå¤šæ®µ ï¼Œå¾—åˆ°çš„ä¹˜ç§¯æœ€å¤§ã€‚å‡è®¾åˆ†ä¸º æ®µï¼Œæ¯æ®µé•¿ä¸º ï¼Œåˆ™æœ‰ , å¾—åˆ°çš„æœ€å¤§ç§¯ æ±‚å‡½æ•° çš„æœ€å¤§å€¼ï¼Œæˆ‘ä»¬è½¬ä¸º å’Œ çš„å…³ç³» ï¼Œå°±æ˜¯ä½†æ˜¯næ˜¯ä¸€ä¸ªå¸¸æ•°,è½¬è€Œæ±‚ä¸‹é¢çš„æœ€å¤§å€¼ è¡¥å……ä¸€ç‚¹ï¼Œæ±‚ä¸€ä¸ªå·²çŸ¥å‡½æ•°çš„æœ€å¤§å€¼ï¼Œå°±æ˜¯æ±‚å¯¼æ•°ï¼Œç„¶åæ ¹æ®ä¸€é˜¶å¯¼æ•°ä¸º0çš„ç‚¹å°±æ˜¯é©»ç‚¹ï¼Œå¦‚æœé©»ç‚¹å·¦å³å¼‚çš„è¯ï¼Œè¿™ä¸ªé©»ç‚¹å°±å¯èƒ½æ˜¯æå€¼ç‚¹ï¼Œæå€¼ç‚¹åˆå¯èƒ½æ˜¯æœ€å€¼ç‚¹ã€‚ å…ˆæ±‚é©»ç‚¹ï¼Œå°±è¦å…ˆæ±‚å¯¼ã€‚ä½†æ˜¯æ±‚å¯¼åŸºæœ¬å…¬å¼é‡Œé¢æ˜¯æ²¡æœ‰ è¿™ä¸ªå½¢å¼çš„æ±‚å¯¼çš„ ï¼Œåšä¸ªå˜åŒ–ï¼Œä¸¤è¾¹å–å¯¹æ•°ï¼Œå› ä¸ºå¯¹æ•°å‡½æ•°æ˜¯å•è°ƒé€’å¢çš„ï¼Œæ‰€ä»¥ä¸å½±å“åŸå‡½æ•°çš„å•è°ƒæ€§ã€‚ ä¸¤è¾¹å–å¯¹ ä¸¤è¾¹å¯¹æ±‚å¯¼ å†ä»£å…¥,åŒ–ç®€ å– å¯å¾—åˆ° æ»¡è¶³è¡¨è¾¾å¼ï¼Œé€šå¸¸æ˜¯çŒœå€¼æ³•ï¼Œä½†æ˜¯è¿™ä¸ªåªèƒ½æ‰¾åˆ°ä¸€ä¸ªé©»ç‚¹ï¼Œä¸èƒ½è¯´æ˜è¿™ä¸ªé©»ç‚¹æ˜¯å”¯ä¸€çš„ã€‚é‚£è¦è¯æ˜è¯æ˜è¿™ä¸ªé©»ç‚¹å”¯ä¸€å‘¢ï¼Ÿé€šå¸¸çš„åšæ³•å¯ä»¥æ˜¯æ±‚äºŒé˜¶å¯¼ï¼Œä½†æ˜¯æˆ‘ä»¬è¿™ä¸ªæ˜¯ä¸ªæœ‰å®é™…æ„ä¹‰çš„é¢˜ï¼Œä¸”x&gt;0ã€‚æ˜¾ç„¶çš„æ­£è´Ÿå–å†³äº ,1æ˜¯ä¸ªå¸¸æ•°ï¼Œ æ˜¯å•è°ƒçš„ï¼Œ æ‰€ä»¥æ˜¾ç„¶ ä¹Ÿæ˜¯å•è°ƒçš„ï¼Œé‚£ä¹ˆå°±æœ€å¤šåªèƒ½æœ‰ä¸€ä¸ªé›¶ç‚¹ï¼Œè€Œæ°å¥½ï¼Œæˆ‘ä»¬çŒœåˆ°äº†æ˜¯ å–eå·¦å³æé™ï¼Œåˆ¤æ–­çš„æ­£è´Ÿ çªç„¶æƒ³èµ·è€å¸ˆå¸¸è¯´çš„ä¸€ç‚¹ä¸å½±å“å•è°ƒæ€§ï¼ŒğŸ˜€ eå·¦è¾¹é€’å¢åŠ ï¼Œeçš„å³è¾¹å‡å°‘ï¼Œå¯ä»¥çœ‹å‡ºè¿™ä¸ªæ˜¯ä¸ªæå¤§å€¼ç‚¹ï¼Œæˆ‘ä»¬å‰é¢è¯æ˜äº†åªæœ‰ä¸€ä¸ªé©»ç‚¹ï¼Œä¹Ÿå°±æœ€å¤šåªæœ‰ä¸€ä¸ªæå€¼ç‚¹ï¼Œä¹Ÿå°±æœ€å¤šåªæœ‰ä¸€ä¸ªæå¤§å€¼ç‚¹ï¼Œæœ€å¤§å€¼å°±æ˜¯åœ¨æ‰€æœ‰çš„æå¤§å€¼ç‚¹é€‰ã€‚æ°å¥½åªæœ‰ä¸€ä¸ªï¼Œé‚£ä¹ˆæœ€å¤§å€¼ç‚¹å°±æ˜¯äº†ã€‚ å¦‚æœè¿™æ˜¯ä¸ªæ•°å­¦é—®é¢˜ï¼Œé‚£ä¹ˆå°±æ˜¯eäº†ï¼Œäº¤å·ã€‚ä½†æ˜¯è¿™æ˜¯ä¸ªå®é™…æ„ä¹‰çš„é¢˜ï¼Œxçš„å–å€¼æ˜¯æ•´æ•°ã€‚æ‰€æœ‰åœ¨eçš„é™„ä»¶å–å€¼ï¼Œä»£å…¥å‡½æ•° æ¯”è¾ƒæœ€å¤§å€¼å³å¯ã€‚ è¯æ˜å®Œæ¯•ï¼Œå–3æœ€ä¼˜ã€‚ ä¼˜å…ˆå–3 å‰©ä¸‹ 2 ï¼Œå°±ç”¨2 å‰©ä¸‹ 1 ï¼Œæ‹¿å›æ¥ä¸€ä¸ª 3 å› ä¸º $31&lt;22$ 12345678910111213141516171819class Solution { public int cuttingRope(int n) { if (n &lt;= 3) { return n - 1; } int count = n / 3; int last = n % 3; switch (last){ case 0: return (int) Math.pow(3, count); case 1: return (int) Math.pow(3, count-1)*4; case 2: return (int) Math.pow(3, count)*2; } return 0; }} æ‰§è¡Œç”¨æ—¶ :0 ms, åœ¨æ‰€æœ‰ Java æäº¤ä¸­å‡»è´¥äº†100.00% çš„ç”¨æˆ· å†…å­˜æ¶ˆè€— :36.2 MB, åœ¨æ‰€æœ‰ Java æäº¤ä¸­å‡»è´¥äº†100.00%çš„ç”¨æˆ·","link":"/2020/04/28/LeetCode/jian-sheng-zi-lcof/"},{"title":"ç¤¼ç‰©çš„æœ€å¤§ä»·å€¼","text":"åœ¨ä¸€ä¸ª m*n çš„æ£‹ç›˜çš„æ¯ä¸€æ ¼éƒ½æ”¾æœ‰ä¸€ä¸ªç¤¼ç‰©ï¼Œæ¯ä¸ªç¤¼ç‰©éƒ½æœ‰ä¸€å®šçš„ä»·å€¼ï¼ˆä»·å€¼å¤§äº 0ï¼‰ã€‚ä½ å¯ä»¥ä»æ£‹ç›˜çš„å·¦ä¸Šè§’å¼€å§‹æ‹¿æ ¼å­é‡Œçš„ç¤¼ç‰©ï¼Œå¹¶æ¯æ¬¡å‘å³æˆ–è€…å‘ä¸‹ç§»åŠ¨ä¸€æ ¼ã€ç›´åˆ°åˆ°è¾¾æ£‹ç›˜çš„å³ä¸‹è§’ã€‚ç»™å®šä¸€ä¸ªæ£‹ç›˜åŠå…¶ä¸Šé¢çš„ç¤¼ç‰©çš„ä»·å€¼ï¼Œè¯·è®¡ç®—ä½ æœ€å¤šèƒ½æ‹¿åˆ°å¤šå°‘ä»·å€¼çš„ç¤¼ç‰©ï¼Ÿ ç¤ºä¾‹ 1: è¾“å…¥:[ [1,3,1], [1,5,1], [4,2,1] ]è¾“å‡º: 12 è§£é‡Š: è·¯å¾„ 1â†’3â†’5â†’2â†’1 å¯ä»¥æ‹¿åˆ°æœ€å¤šä»·å€¼çš„ç¤¼ç‰© æç¤ºï¼š 0 &lt; grid.length &lt;= 200 0 &lt; grid[0].length &lt;= 200 1234567891011121314151617181920212223242526class Solution { public int maxValue(int[][] grid) { int m = grid.length; int n = grid[0].length; //ç¬¬ä¸€è¡Œï¼Œåªèƒ½ä»å·¦åˆ°å³ï¼Œæ‰€æœ‰åé¢çš„ç­‰äºå‰é¢çš„ç›¸åŠ  for (int i = 1; i &lt; n; i++) { grid[0][i] += grid[0][i -1]; } //ç¬¬ä¸€åˆ—ï¼Œåªèƒ½æ˜¯ä»ä¸Šåˆ°ä¸‹ for (int i = 1; i &lt; m; i++) { grid[i][0] += grid[i - 1][0]; } //å½“å‰ iï¼Œj åªèƒ½æ˜¯ä»ä¸Šé¢æ¥ï¼Œæˆ–è€…ä»å‰é¢æ¥ for (int i = 1; i &lt; m; i++) { for (int j = 1; j &lt; n; j++) { grid[i][j] += Math.max(grid[i - 1][j], grid[i][j - 1]); } } //èµ°åˆ°æœ€åï¼Œå°±æ˜¯æœ€å¤§çš„ return grid[m - 1][n - 1]; }}","link":"/2020/04/21/LeetCode/li-wu-de-zui-da-jie-zhi-lcof/"},{"title":"æ ‘çš„å­ç»“æ„","text":"è¾“å…¥ä¸¤æ£µäºŒå‰æ ‘Aå’ŒBï¼Œåˆ¤æ–­Bæ˜¯ä¸æ˜¯Açš„å­ç»“æ„ã€‚(çº¦å®šç©ºæ ‘ä¸æ˜¯ä»»æ„ä¸€ä¸ªæ ‘çš„å­ç»“æ„) Bæ˜¯Açš„å­ç»“æ„ï¼Œ å³ Aä¸­æœ‰å‡ºç°å’ŒBç›¸åŒçš„ç»“æ„å’ŒèŠ‚ç‚¹å€¼ã€‚ ä¾‹å¦‚:ç»™å®šçš„æ ‘ A: ` 3 / \\ 4 5 / \\ 1 2` ç»™å®šçš„æ ‘ Bï¼š ` 4 / 1`è¿”å› trueï¼Œå› ä¸º B ä¸ A çš„ä¸€ä¸ªå­æ ‘æ‹¥æœ‰ç›¸åŒçš„ç»“æ„å’ŒèŠ‚ç‚¹å€¼ã€‚ ç¤ºä¾‹ 1ï¼š è¾“å…¥ï¼šA = [1,2,3], B = [3,1]è¾“å‡ºï¼šfalse ç¤ºä¾‹ 2ï¼š è¾“å…¥ï¼šA = [3,4,5,1,2], B = [4,1]è¾“å‡ºï¼štrue é™åˆ¶ï¼š 0 &lt;= èŠ‚ç‚¹ä¸ªæ•° &lt;= 10000 ##å…ˆåºéå†ï¼Œä¸€æ¬¡æ£€æŸ¥ å­æ ‘Bçš„æ ¹èŠ‚ç‚¹å¯èƒ½æ˜¯æ ‘Açš„ä»»æ„ä¸€èŠ‚ç‚¹ 1234567891011121314151617181920212223242526272829 /** * Definition for a binary tree node. * public class TreeNode { * int val; * TreeNode left; * TreeNode right; * TreeNode(int x) { val = x; } * } */class Solution { public boolean isSubStructure(TreeNode A, TreeNode B) { if (A == null || B == null) { return false; } //å½“å‰æ ¹ï¼Œå·¦å³å­æ ‘ //æœ¬è´¨ä¸Šï¼Œè¿™é‡Œå°±æ˜¯å…ˆåºéå†Aæ•°ï¼Œç„¶åéå†æ¯”è¾ƒBæ•° return recursive(A, B) || isSubStructure(A.left, B) || isSubStructure(A.right, B); } //ä»¥å½“å‰èŠ‚ç‚¹åˆ¤æ–­ï¼ŒBæ˜¯ä¸æ˜¯å­æ ‘ public boolean recursive(TreeNode A, TreeNode B){ if (B == null) { return true; } if (A==null||A.val!=B.val) return false; return recursive(A.left, B.left) &amp;&amp; recursive(A.right, B.right); }}","link":"/2020/05/05/LeetCode/shu-de-zi-jie-gou-lcof/"},{"title":"é‡å»ºäºŒå‰æ ‘","text":"è¾“å…¥æŸäºŒå‰æ ‘çš„å‰åºéå†å’Œä¸­åºéå†çš„ç»“æœï¼Œè¯·é‡å»ºè¯¥äºŒå‰æ ‘ã€‚å‡è®¾è¾“å…¥çš„å‰åºéå†å’Œä¸­åºéå†çš„ç»“æœä¸­éƒ½ä¸å«é‡å¤çš„æ•°å­—ã€‚ ä¾‹å¦‚ï¼Œç»™å‡º å‰åºéå† preorder = [3,9,20,15,7]ä¸­åºéå† inorder = [9,3,15,20,7] è¿”å›å¦‚ä¸‹çš„äºŒå‰æ ‘ï¼š 3 / \\ 9 20 / \\ 15 7é™åˆ¶ï¼š0 &lt;= èŠ‚ç‚¹ä¸ªæ•° &lt;= 5000 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849/** * Definition for a binary tree node. * public class TreeNode { * int val; * TreeNode left; * TreeNode right; * TreeNode(int x) { val = x; } * } */class Solution { //åˆ©ç”¨åŸç†,å…ˆåºéå†çš„ç¬¬ä¸€ä¸ªèŠ‚ç‚¹å°±æ˜¯æ ¹ã€‚åœ¨ä¸­åºéå†ä¸­é€šè¿‡æ ¹ åŒºåˆ†å“ªäº›æ˜¯å·¦å­æ ‘çš„ï¼Œå“ªäº›æ˜¯å³å­æ ‘çš„ //å·¦å³å­æ ‘ï¼Œé€’å½’ HashMap&lt;Integer, Integer&gt; map = new HashMap&lt;&gt;();//æ ‡è®°ä¸­åºéå† int[] preorder;//ä¿ç•™çš„å…ˆåºéå† public TreeNode buildTree(int[] preorder, int[] inorder) { this.preorder = preorder; for (int i = 0; i &lt; preorder.length; i++) { map.put(inorder[i], i); } return recursive(0,0,inorder.length-1); } /** * @param pre_root_idx å…ˆåºéå†çš„ç´¢å¼• * @param in_left_idx ä¸­åºéå†çš„ç´¢å¼• * @param in_right_idx ä¸­åºéå†çš„ç´¢å¼• */ public TreeNode recursive(int pre_root_idx, int in_left_idx, int in_right_idx) { //ç›¸ç­‰å°±æ˜¯è‡ªå·± if (in_left_idx &gt; in_right_idx) { return null; } //root_idxæ˜¯åœ¨å…ˆåºé‡Œé¢çš„ TreeNode root = new TreeNode(preorder[pre_root_idx]); // æœ‰äº†å…ˆåºçš„,å†æ ¹æ®å…ˆåºçš„ï¼Œåœ¨ä¸­åºä¸­è· å½“å‰æ ¹çš„ç´¢å¼• int idx = map.get(preorder[pre_root_idx]); //å·¦å­æ ‘çš„æ ¹èŠ‚ç‚¹å°±æ˜¯ å·¦å­æ ‘çš„(å‰åºéå†ï¼‰ç¬¬ä¸€ä¸ªï¼Œå°±æ˜¯+1,å·¦è¾¹è¾¹ç•Œå°±æ˜¯leftï¼Œå³è¾¹è¾¹ç•Œæ˜¯ä¸­é—´åŒºåˆ†çš„idx-1 root.left = recursive(pre_root_idx + 1, in_left_idx, idx - 1); //ç”±æ ¹èŠ‚ç‚¹åœ¨ä¸­åºéå†çš„idx åŒºåˆ†æˆ2æ®µ,idx å°±æ˜¯æ ¹ //å³å­æ ‘çš„æ ¹ï¼Œå°±æ˜¯å³å­æ ‘ï¼ˆå‰åºéå†ï¼‰çš„ç¬¬ä¸€ä¸ª,å°±æ˜¯å½“å‰æ ¹èŠ‚ç‚¹ åŠ ä¸Šå·¦å­æ ‘çš„æ•°é‡ // pre_root_idx å½“å‰çš„æ ¹ å·¦å­æ ‘çš„é•¿åº¦ = å·¦å­æ ‘çš„å·¦è¾¹-å³è¾¹ (idx-1 - in_left_idx +1) ã€‚æœ€å+1å°±æ˜¯å³å­æ ‘çš„æ ¹äº† root.right = recursive(pre_root_idx + (idx-1 - in_left_idx +1) + 1, idx + 1, in_right_idx); return root; }}","link":"/2020/04/20/LeetCode/zhong-jian-er-cha-shu-lcof/"},{"title":"å­—ç¬¦ä¸²çš„æ’åˆ—","text":"è¾“å…¥ä¸€ä¸ªå­—ç¬¦ä¸²ï¼Œæ‰“å°å‡ºè¯¥å­—ç¬¦ä¸²ä¸­å­—ç¬¦çš„æ‰€æœ‰æ’åˆ—ã€‚ ä½ å¯ä»¥ä»¥ä»»æ„é¡ºåºè¿”å›è¿™ä¸ªå­—ç¬¦ä¸²æ•°ç»„ï¼Œä½†é‡Œé¢ä¸èƒ½æœ‰é‡å¤å…ƒç´ ã€‚ ç¤ºä¾‹: è¾“å…¥ï¼šs = â€œabcâ€è¾“å‡ºï¼š[â€œabcâ€,â€acbâ€,â€bacâ€,â€bcaâ€,â€cabâ€,â€cbaâ€] é™åˆ¶ï¼š 1 &lt;= s çš„é•¿åº¦ &lt;= 8 æš´åŠ›åŠ å‰ªæï¼Œå›æº¯å®é™…å¯ä»¥ç±»æ¯”äºŒå‰æ ‘çš„å…ˆåºéå†DFSã€‚ä¸è¿‡äºŒå‰æ ‘æœ‰å·¦å³ï¼Œæˆ‘ä»¬å¯ä»¥åŒºåˆ†ã€‚ç±»æ¯”æˆæ¯”å¦‚8ä¸ªå­—æ¯ï¼Œåˆ™æœ‰8å±‚çš„æ•°ï¼Œæˆ‘ä»¬æ¯ä¸€å±‚éƒ½æš´åŠ›åŒ¹é…ä¸€ä¸‹æ‰€æœ‰çš„8ä¸ªå­—æ¯ï¼Œä½†æ˜¯æˆ‘å¯ä»¥é€šè¿‡è®°å¿†çŸ¥é“å‰é¢èµ°è¿‡çš„å­—æ¯ã€‚è¿™æ ·å°±å¯ä»¥å»æ‰ä¸€éƒ¨åˆ†\bæš´åŠ›ã€‚æœ€åèµ°åˆ°å¶å­çš„æ—¶å€™ï¼Œå›é€€ã€‚ 12345678910111213141516171819202122232425262728293031323334353637383940//é˜²æ­¢æœ‰é‡å¤çš„å­—æ¯HashSet&lt;String&gt; stringArrayList = new HashSet&lt;&gt;();public String[] permutation(String s) { dfs(s, 0, new StringBuffer(), new HashSet&lt;&gt;()); String[] result = new String[stringArrayList.size()]; return stringArrayList.toArray(result);}public void dfs(String s, int cur, StringBuffer stringBuffer, HashSet&lt;Integer&gt; visited) { //èµ°åˆ°æœ€åä¸€ä¸ªäº†ï¼Œæ·»åŠ  if (cur == s.length()) { stringArrayList.add(stringBuffer.toString()); return; } //æ¯ä¸€å±‚éƒ½å°è¯•ä¸€ä¸‹æ‰€æœ‰å­—æ¯ //ç±»åˆ«äºŒå‰æ ‘ï¼Œå¯ä»¥åŒºåˆ†å·¦å³ã€‚å…ˆå·¦åå³ã€‚æ‰€ä»¥è¿™é‡Œé‡è¯•æ‰€æœ‰çš„å­—æ¯ for (int i = 0; i &lt; s.length(); i++) { //å¦‚æœå‰é¢ä¸€å±‚è¿™ä¸ªå­—æ¯,è¢«è®¿é—®è¿‡äº†,å°±åªèƒ½é€‰ä¸‹ä¸€ä¸ª if (visited.contains(i)) { continue; } //æ ‡è®°è®¿é—® visited.add(i); //æ·»åŠ è¿›å»ï¼Œå¼€å§‹è¿›å…¥ä¸‹ä¸€å±‚ stringBuffer.append(s.charAt(i)); dfs(s, cur + 1, stringBuffer, visited); //å›æº¯,å›é€€åˆ°ä¸Šä¸€å±‚ï¼Œå»æ‰è¿™ä¸€å±‚çš„æ ‡è®° stringBuffer.deleteCharAt(stringBuffer.length() - 1); visited.remove(i); }}","link":"/2020/04/29/LeetCode/zi-fu-chuan-de-pai-lie-lcof/"},{"title":"æ•°å€¼çš„æ•´æ•°æ¬¡æ–¹","text":"å®ç°å‡½æ•°double Power(double base, int exponent)ï¼Œæ±‚baseçš„exponentæ¬¡æ–¹ã€‚ä¸å¾—ä½¿ç”¨åº“å‡½æ•°ï¼ŒåŒæ—¶ä¸éœ€è¦è€ƒè™‘å¤§æ•°é—®é¢˜ã€‚ ç¤ºä¾‹ 1: è¾“å…¥: 2.00000, 10è¾“å‡º: 1024.00000 ç¤ºä¾‹ 2: è¾“å…¥: 2.10000, 3è¾“å‡º: 9.26100 ç¤ºä¾‹ 3: è¾“å…¥: 2.00000, -2è¾“å‡º: 0.25000è§£é‡Š: 2-2 = 1/22 = 1/4 = 0.25 è¯´æ˜: -100.0 &lt; x &lt; 100.0 n æ˜¯ 32 ä½æœ‰ç¬¦å·æ•´æ•°ï¼Œå…¶æ•°å€¼èŒƒå›´æ˜¯ [âˆ’231, 231 âˆ’ 1] ã€‚ é€’å½’ äºŒåˆ†æ³•æ±‚è§£123456789101112class Solution { public double myPow(double x, int n) { //åŸºæœ¬æƒ…å†µ if(n==0) return 1; if(n==1) return x; if(n==-1) return 1/x; //å…ˆç®—n/2*n/2,æœ‰ä½™æ•°å†è¡¥å……ä½™æ•° double a = myPow(x,n/2); double b = myPow(x,n%2); return a*a*b; }}","link":"/2020/05/06/LeetCode/%E6%95%B0%E5%80%BC%E7%9A%84%E6%95%B4%E6%95%B0%E6%AC%A1%E6%96%B9/"},{"title":"æ•°å­—åºåˆ—ä¸­æŸä¸€ä½çš„æ•°å­—","text":"æ•°å­—ä»¥0123456789101112131415â€¦çš„æ ¼å¼åºåˆ—åŒ–åˆ°ä¸€ä¸ªå­—ç¬¦åºåˆ—ä¸­ã€‚åœ¨è¿™ä¸ªåºåˆ—ä¸­ï¼Œç¬¬5ä½ï¼ˆä»ä¸‹æ ‡0å¼€å§‹è®¡æ•°ï¼‰æ˜¯5ï¼Œç¬¬13ä½æ˜¯1ï¼Œç¬¬19ä½æ˜¯4ï¼Œç­‰ç­‰ã€‚ è¯·å†™ä¸€ä¸ªå‡½æ•°ï¼Œæ±‚ä»»æ„ç¬¬nä½å¯¹åº”çš„æ•°å­—ã€‚ ç¤ºä¾‹ 1ï¼š è¾“å…¥ï¼šn = 3è¾“å‡ºï¼š3 ç¤ºä¾‹ 2ï¼š è¾“å…¥ï¼šn = 11è¾“å‡ºï¼š0 é™åˆ¶ï¼š 0 &lt;= n &lt; 2^31 æ‰¾è§„å¾‹ ï¼Œé™å®šèŒƒå›´è¦ç”¨long 12345678910111213141516171819202122232425262728293031/** * é¦–å…ˆï¼Œæˆ‘ä»¬è¦æ˜ç¡®çš„æ˜¯ï¼Œnæ˜¯ä¸‹æ ‡ï¼Œä»0å¼€å§‹çš„ï¼ * æˆ‘ä»¬å¯ä»¥æ³¨æ„åˆ°è§„å¾‹ 0~9æœ‰10ä¸ªæ•°å­—ï¼Œ10~99æœ‰90ä¸ªæ•°å­—ï¼Œ100~999æœ‰900ä¸ªæ•°å­—ï¼Œso~ * @param n * @return */ public int findNthDigit(int n){ if (n &lt; 10) { return n; } //å…ˆæ‰¾ä¸€ä¸‹ï¼Œåœ¨å“ªä¸ªæ•°ä½èŒƒå›´ã€‚è¦ç”¨long long target = 9; int i = 1; while (n - target*i &gt; 0) { n = (int) (n - target*i); i = i + 1; target = target * 10; } //æ‰¾åˆ°äº†åœ¨iä½é‡Œé¢ long start = (int) Math.pow(10, i-1); System.out.println(start); //è¿˜å‰©ä¸‹nä¸ªæ•°å­—ï¼Œæ¥ä¸‹æ¥å°±æ˜¯æ¯ä¸ªæ•°å­—éƒ½æ˜¯iä½äº† int count = (n-1) / i;//æœ‰å‡ ä¸ªæ•°å­—,ä»0å¼€å§‹çš„ï¼Œn-1 //ç›®æ ‡æ•° long num = start + count; //æ‰€æ±‚æ•°ä½ä¸ºæ•°å­— numnum çš„ç¬¬ (n - 1) \\% digit(nâˆ’1)%digit ä½ return String.valueOf(num).charAt((n - 1) % i) - '0'; }","link":"/2020/05/06/LeetCode/%E6%95%B0%E5%AD%97%E5%BA%8F%E5%88%97%E4%B8%AD%E6%9F%90%E4%B8%80%E4%BD%8D%E7%9A%84%E6%95%B0%E5%AD%97/"},{"title":"æ•°ç»„ä¸­çš„é€†åºå¯¹","text":"åœ¨æ•°ç»„ä¸­çš„ä¸¤ä¸ªæ•°å­—ï¼Œå¦‚æœå‰é¢ä¸€ä¸ªæ•°å­—å¤§äºåé¢çš„æ•°å­—ï¼Œåˆ™è¿™ä¸¤ä¸ªæ•°å­—ç»„æˆä¸€ä¸ªé€†åºå¯¹ã€‚è¾“å…¥ä¸€ä¸ªæ•°ç»„ï¼Œæ±‚å‡ºè¿™ä¸ªæ•°ç»„ä¸­çš„é€†åºå¯¹çš„æ€»æ•°ã€‚ ç¤ºä¾‹ 1: è¾“å…¥: [7,5,6,4]è¾“å‡º: 5 é™åˆ¶ï¼š 0 &lt;= æ•°ç»„é•¿åº¦ &lt;= 50000 é¢˜è§£åˆ©ç”¨å½’å¹¶æ’åºçš„å±€éƒ¨æœ‰åºï¼Œå°±å¯ä»¥æ‰¹é‡çŸ¥é“å·¦å³çš„å¤§å°å…³ç³»ã€‚ å¦‚å›¾ï¼Œ1å°å…ˆèµ°ï¼Œåˆ™å³è¾¹çš„å…¨éƒ¨æ¯”1å¤§ã€‚æ‰€ä»¥åªéœ€è¦åŠ ä¸Šå³è¾¹çš„å°±å¯ä»¥äº†ã€‚ 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758596061 public int reversePairs(int[] nums) { if (nums == null || nums.length &lt; 2) { return 0; } int k = mergeSort(nums, 0, nums.length - 1); System.out.println(Arrays.toString(nums)); return k;}//å…ˆåˆ†æˆï¼Œ2æ®µï¼Œè®¡ç®—2æ®µä¹‹å‰çš„é€†åºå¯¹private int mergeSort(int[] nums, int left, int right) { if (left == right) return 0; int mid = (left + right) / 2; int leftCount = mergeSort(nums, left, mid);//è®¡ç®—å·¦è¾¹éƒ¨åˆ† int rightCount = mergeSort(nums, mid+1, right);//è®¡ç®—å³è¾¹éƒ¨åˆ† return leftCount+rightCount+merger(nums, left, mid, right);}//çœŸå®merge,è®¡ç®—ä»¥midåˆ†ç•Œçš„é€†åºå¯¹private int merger(int[] nums,int left ,int mid,int right){ //æœ€ç»ˆå½’å¹¶çš„æ•°ç»„ int[] temp = new int[right - left + 1]; int count = 0; int p1 = left; int p2 = mid + 1; int i = 0; //ä»¥midåˆ†ç•Œ while (p1 &lt;= mid &amp;&amp; p2 &lt;= right) { if (nums[p1] &lt;= nums[p2]) { //p1æ¯”è¾ƒå°ï¼Œp1å…¥é˜Ÿ temp[i++] = nums[p1++]; }else { //p2å…¥é˜Ÿ temp[i++] = nums[p2++]; //åŠ ä¸Šå·¦è¾¹çš„æ•°ï¼Œå°±é€†åºå¯¹æ•° count += mid - p1 +1 ; } } //æ¥ä¸‹æ¥å¤„ç†æŸä¸€ä¸ªæœ‰å‰©ä½™çš„æƒ…å†µ,è°å‰©ä¸‹ï¼Œè°å…¨éƒ¨ç§»äº¤åˆ°temp while (p1 &lt;= mid) { temp[i++] = nums[p1++]; } while (p2 &lt;= right) { temp[i++] = nums[p2++]; } //æ’åºå¥½çš„ï¼Œcopyåˆ°æºæ•°ç»„ for (int j = 0; j &lt; temp.length; j++) { nums[left + j] = temp[j]; } return count;}","link":"/2020/05/13/LeetCode/%E6%95%B0%E7%BB%84%E4%B8%AD%E7%9A%84%E9%80%86%E5%BA%8F%E5%AF%B9/"},{"title":"æœ€é•¿ä¸å«é‡å¤å­—ç¬¦çš„å­å­—ç¬¦ä¸²","text":"ç»™å®šä¸€ä¸ªå­—ç¬¦ä¸²ï¼Œè¯·ä½ æ‰¾å‡ºå…¶ä¸­ä¸å«æœ‰é‡å¤å­—ç¬¦çš„ *æœ€é•¿å­ä¸² *çš„é•¿åº¦ã€‚ ç¤ºä¾‹ 1: è¾“å…¥: â€œabcabcbbâ€è¾“å‡º: 3è§£é‡Š: å› ä¸ºæ— é‡å¤å­—ç¬¦çš„æœ€é•¿å­ä¸²æ˜¯ &quot;abc&quot;ï¼Œæ‰€ä»¥å…¶é•¿åº¦ä¸º 3ã€‚ ç¤ºä¾‹ 2: è¾“å…¥: â€œbbbbbâ€è¾“å‡º: 1è§£é‡Š: å› ä¸ºæ— é‡å¤å­—ç¬¦çš„æœ€é•¿å­ä¸²æ˜¯ &quot;b&quot;ï¼Œæ‰€ä»¥å…¶é•¿åº¦ä¸º 1ã€‚ ç¤ºä¾‹ 3: è¾“å…¥: â€œpwwkewâ€è¾“å‡º: 3è§£é‡Š: å› ä¸ºæ— é‡å¤å­—ç¬¦çš„æœ€é•¿å­ä¸²æ˜¯ &quot;wke&quot;ï¼Œæ‰€ä»¥å…¶é•¿åº¦ä¸º 3ã€‚ è¯·æ³¨æ„ï¼Œä½ çš„ç­”æ¡ˆå¿…é¡»æ˜¯ å­ä¸² çš„é•¿åº¦ï¼Œ&quot;pwke&quot; æ˜¯ä¸€ä¸ªå­åºåˆ—ï¼Œä¸æ˜¯å­ä¸²ã€‚ åˆ©ç”¨æ»‘åŠ¨çª—å£æ±‚è§£ 1234567891011121314151617181920212223242526272829class Solution { public int lengthOfLongestSubstring(String s) { int head = 0; int max = 0; char[] chars = s.toCharArray(); //æ ‡è®°å½“å‰çª—å£ HashSet&lt;Character&gt; stringHashSet = new HashSet&lt;&gt;(); for (int tail = 0; tail &lt; chars.length; tail++) { //å¦‚æœçª—å£ä¸åŒ…å«ï¼Œåˆ™å°¾æŒ‡é’ˆåç§»ï¼Œæ›´æ–°max if (!stringHashSet.contains(chars[tail])) { max = Math.max(max, tail - head +1); }else { //å¦‚æœåŒ…å«ï¼Œåˆ™è·Ÿæ–°headå€¼ï¼Œç›´åˆ°ä¸åŒ…å«ä¸ºæ­¢ while (stringHashSet.contains(chars[tail])) { stringHashSet.remove(chars[head]); head++; } } //åŠ å…¥ stringHashSet.add(chars[tail]); } return max; }}","link":"/2020/05/07/LeetCode/%E6%9C%80%E9%95%BF%E4%B8%8D%E5%90%AB%E9%87%8D%E5%A4%8D%E5%AD%97%E7%AC%A6%E7%9A%84%E5%AD%90%E5%AD%97%E7%AC%A6%E4%B8%B2/"},{"title":"iOSå¦‚ä½•å®‰è£…æ—§ç‰ˆæœ¬app, appé™çº§","text":"èƒŒæ™¯æœ‰æ—¶å€™ï¼Œæ–°çš„appç‰ˆæœ¬å»æ‰äº†æŸäº›åŠŸèƒ½æˆ–æ–°åŠ äº†æŸäº›åŠŸèƒ½æ˜¯æˆ‘ä»¬ä¸æƒ³è¦çš„ï¼Œä¾‹å¦‚æ–°ç‰ˆæœ¬bilibiliåŠ äº†å¾ˆå¤šå¹¿å‘Šï¼Œè¿˜æ˜¯æƒ³ä½¿ç”¨æ—§ç‰ˆæœ¬ã€‚å¤§ä½“æœ‰2ä¸ªæ–¹æ³•ï¼Œéƒ½éœ€è¦ç”¨åˆ°çˆ±æ€åŠ©æ‰‹ã€‚å¦‚æœæ˜¯Androidåˆ™å¾ˆæ–¹ä¾¿ï¼Œåªéœ€è¦æœç´¢ä¸‹è½½åˆ°å¯¹åº”çš„apkæ–‡ä»¶å³å¯ï¼Œä½†æ˜¯iOSçš„ipaæ–‡ä»¶æ˜¯å’Œè´¦å·ç»‘å®šçš„ï¼Œåˆ«äººä¸‹çš„ipaæ–‡ä»¶åˆ†äº«ç»™ä½ ï¼Œä¹Ÿæ˜¯éœ€è¦å¯¹åº”çš„è´¦å·æ¿€æ´»ä¸€æ¬¡æ‰èƒ½ä½¿ç”¨çš„ã€‚â€‹ æ–¹æ³•ä¸€ï¼šç›´æ¥ä½¿ç”¨çˆ±æ€åŠ©æ‰‹å®‰è£…é€‚ç”¨macå’Œwindowsçš„ï¼Œé€šå¸¸åªæœ‰å›½åŒºappï¼Œæ— éœ€å¯¹åº”çš„apple idè´¦å·ã€‚çˆ±æ€åŠ©æ‰‹å®˜ç½‘ï¼šhttps://www.i4.cn/ ç”µè„‘ä¸‹è½½å®‰è£…ï¼Œæ‰‹æœºè¿æ¥å®‰è£…ï¼Œæ‰‹æœºç‰ˆçˆ±æ€åŠ©æ‰‹ æ‰‹æœºæ‰“å¼€çˆ±æ€åŠ©æ‰‹appï¼Œæœç´¢å¯¹åº”çš„appï¼Œ ç‚¹å‡»è¿›å…¥è¯¦æƒ…é¡µï¼Œä¸‹æ‹‰ï¼ŒæŸ¥çœ‹å†å²ç‰ˆæœ¬ï¼Œç‚¹å‡»å®‰è£…å¯¹åº”çš„ç‰ˆæœ¬å³å¯ã€‚ â€‹ â€‹ æ–¹æ³•äºŒï¼šç”¨è‡ªå·±çš„è´¦å·å»ä¸‹è½½æ—§çš„ipaæ–‡ä»¶åŸç†ï¼šåœ¨æ—§ç‰ˆæœ¬çš„iTunesæ”¯æŒä¸‹è½½ipaæ–‡ä»¶ï¼Œæˆ‘ä»¬ç‚¹å‡»ä¸‹è½½çš„æ—¶å€™ï¼Œé€šè¿‡ä¸­é—´ä»£ç†ï¼Œä¿®æ”¹æ‰å¯¹åº”çš„ç‰ˆæœ¬å·ï¼Œä»¥æ­¤æ¥ä¸‹è½½å¯¹åº”ç‰ˆæœ¬çš„appçš„ipaçš„æ–‡ä»¶ã€‚ä¸‹è½½å¥½çš„ipaæ–‡ä»¶ï¼Œæœ€åé€šè¿‡çˆ±æ€åŠ©æ‰‹ï¼Œæ‰‹åŠ¨å®‰è£…ä¸€æ¬¡ï¼Œç™»é™†å¯¹åº”çš„è´¦å·å³å¯ã€‚â€‹ è¦æ±‚ï¼šå¿…é¡»windowsç¯å¢ƒï¼Œæµ‹è¯•Macç‰ˆ12.6 å°±ç®—æˆåŠŸå®‰è£…äº†ï¼Œä¹Ÿæ— æ³•ä¸‹è½½ipaæ–‡ä»¶ã€‚macç”¨æˆ·å¯ä»¥é€šè¿‡è™šæ‹Ÿæœºæ¥è§£å†³ã€‚å·¥å…·ï¼šFiddleræŠ“åŒ…æ‹¦æˆª, iTuneså¿…é¡»12.6åŠä»¥ä¸‹iTunes 12.6 æ—§ç‰ˆä¸‹è½½ï¼šhttps://secure-appldnld.apple.com/itunes12/091-87819-20180912-69177170-B085-11E8-B6AB-C1D03409AD2A6/iTunes64Setup.exehttps://secure-appldnld.apple.com/itunes12/091-33626-20170922-F51D3530-A003-11E7-8324-03D19A97A551/iTunes64Setup.exeâ€‹ æˆ‘æ€ä¹ˆçŸ¥é“å¯¹åº”çš„ç‰ˆæœ¬å·å‘¢ï¼Ÿå»appå†å²ç‰ˆæœ¬å¥½æŸ¥è¯¢ä¸‹è½½ https://tools.lancely.tech/apple/app-searchâ€‹ å…ˆå®‰è£…ä¸Šé¢çš„å·¥å…·ï¼ŒæˆåŠŸç™»é™†ä¸€ä¸‹iTunesï¼Œä»¥åå®‰è£…ä½ ä¸‹è½½çš„ipaæ–‡ä»¶ï¼Œæ˜¯éœ€è¦è¿™æ¬¡çš„apple idçš„ã€‚æœç´¢ä¸€ä¸‹appï¼Œéšä¾¿ç‚¹å‡»ä¸‹è½½ä¸€ä¸ªæ˜¯ä¸æ˜¯å¯ä»¥çš„ã€‚ å¯ä»¥å…ˆå»æŸ¥è¯¢ä½ æƒ³è¦ä¸‹è½½çš„ç‰ˆæœ¬å¯¹åº”ç‰ˆæœ¬å· https://tools.lancely.tech/apple/app-search æ‰“å¼€Fiddlerï¼Œå…ˆåœ¨tools-&gt;optioné‡Œé¢ç‚¹å¼€https æ‹¦æˆªä¸‹è½½çš„æ–­ç‚¹ï¼šbpu MZBuy.woa æœç´¢å¯¹åº”çš„app å»filddleré‡Œé¢æŸ¥çœ‹æ–­ç‚¹ï¼Œä¿®æ”¹ç‰ˆæœ¬å·å¥½åï¼Œç‚¹å‡»run fillddleré‡Œå‘½ä¸­äº†å‡ æ¬¡ï¼Œä½ å°±ä¿®æ”¹å‡ æ¬¡ï¼Œç‚¹å‡»ç»¿è‰²çš„runä¹‹åï¼Œitunnesé‡Œé¢å°±ä¼šå‡ºç°ä¸‹è½½äº†ï¼Œç­‰ä¸€ä¼šå„¿å³å¯ï¼Œå¦‚æœæ²¡æœ‰å‡ºç°ä¸‹è½½ï¼Œé‡æ–°è§¦å‘ä¸€æ¬¡å³å¯ æœ€åå»æ‰¾åˆ°ä¸‹è½½å¥½çš„ipaæ–‡ä»¶é€šè¿‡çˆ±æ€åŠ©æ‰‹æ‰‹åŠ¨å®‰è£…ä¸€æ¬¡ï¼Œå³å¯ ä¸‹è½½å¥½çš„ipaæ–‡ä»¶ï¼Œè‡ªå·±å¯ä»¥é‡å¤ä½¿ç”¨ï¼Œä¹Ÿå¯ä»¥åˆ†äº«ä½¿ç”¨ï¼Œä½†æ˜¯éœ€è¦ä½ ä¸‹è½½æ—¶å€™çš„apple idã€‚","link":"/2022/02/13/%E5%88%86%E4%BA%AB/ios-download-old-app/"},{"title":"çŸ©é˜µä¸­çš„è·¯å¾„","text":"è¯·è®¾è®¡ä¸€ä¸ªå‡½æ•°ï¼Œç”¨æ¥åˆ¤æ–­åœ¨ä¸€ä¸ªçŸ©é˜µä¸­æ˜¯å¦å­˜åœ¨ä¸€æ¡åŒ…å«æŸå­—ç¬¦ä¸²æ‰€æœ‰å­—ç¬¦çš„è·¯å¾„ã€‚è·¯å¾„å¯ä»¥ä»çŸ©é˜µä¸­çš„ä»»æ„ä¸€æ ¼å¼€å§‹ï¼Œæ¯ä¸€æ­¥å¯ä»¥åœ¨çŸ©é˜µä¸­å‘å·¦ã€å³ã€ä¸Šã€ä¸‹ç§»åŠ¨ä¸€æ ¼ã€‚å¦‚æœä¸€æ¡è·¯å¾„ç»è¿‡äº†çŸ©é˜µçš„æŸä¸€æ ¼ï¼Œé‚£ä¹ˆè¯¥è·¯å¾„ä¸èƒ½å†æ¬¡è¿›å…¥è¯¥æ ¼å­ã€‚ä¾‹å¦‚ï¼Œåœ¨ä¸‹é¢çš„3Ã—4çš„çŸ©é˜µä¸­åŒ…å«ä¸€æ¡å­—ç¬¦ä¸²â€œbfceâ€çš„è·¯å¾„ï¼ˆè·¯å¾„ä¸­çš„å­—æ¯ç”¨åŠ ç²—æ ‡å‡ºï¼‰ã€‚ [[â€œaâ€,â€bâ€œ,â€câ€,â€eâ€],[â€œsâ€,â€ fâ€œ,â€câ€œ,â€sâ€],[â€œaâ€,â€dâ€,â€ eâ€œ,â€eâ€]] ä½†çŸ©é˜µä¸­ä¸åŒ…å«å­—ç¬¦ä¸²â€œabfbâ€çš„è·¯å¾„ï¼Œå› ä¸ºå­—ç¬¦ä¸²çš„ç¬¬ä¸€ä¸ªå­—ç¬¦bå æ®äº†çŸ©é˜µä¸­çš„ç¬¬ä¸€è¡Œç¬¬äºŒä¸ªæ ¼å­ä¹‹åï¼Œè·¯å¾„ä¸èƒ½å†æ¬¡è¿›å…¥è¿™ä¸ªæ ¼å­ã€‚ ç¤ºä¾‹ 1ï¼š è¾“å…¥ï¼šboard = [[â€œAâ€,â€Bâ€,â€Câ€,â€Eâ€],[â€œSâ€,â€Fâ€,â€Câ€,â€Sâ€],[â€œAâ€,â€Dâ€,â€Eâ€,â€Eâ€]], word = â€œABCCEDâ€è¾“å‡ºï¼štrue ç¤ºä¾‹ 2ï¼š è¾“å…¥ï¼šboard = [[â€œaâ€,â€bâ€],[â€œcâ€,â€dâ€]], word = â€œabcdâ€è¾“å‡ºï¼šfalse æç¤ºï¼š 1 &lt;= board.length &lt;= 200 1 &lt;= board[i].length &lt;= 200 è§£ç­”éå†æ¯ä¸€ä¸ªèµ·ç‚¹ã€‚ä»æ¯ä¸€ä¸ªèµ·ç‚¹å¼€å§‹å°è¯•èµ° 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657class Solution { public boolean exist(char[][] board, String word) { char[] chars = word.toCharArray(); //ä¾æ¬¡åˆ¤æ–­ï¼Œæ¯ä¸€ä¸ªèµ·ç‚¹ for (int i = 0; i &lt; board.length; i++) { for (int j = 0; j &lt; board[i].length; j++) { //æ¯æ¬¡éƒ½ä»å½“å‰èŠ‚ç‚¹ï¼Œä»k=0å¼€å§‹å°è¯•ï¼Œåªè¦æœ‰æ»¡è¶³ä¸€æ¡è·¯å¾„ï¼Œreturn true if (dfs(board, i, j, chars, 0)) { return true; } } } //éƒ½ä¸å—æ»¡è¶³ return false; } //å½“å‰åŒ¹é…çš„èŠ‚ç‚¹K public boolean dfs(char[][] board,int i,int j,char[] chars,int k){ //è¶Šç•Œäº† if(i &gt;= board.length || i &lt; 0 || j &gt;= board[0].length || j &lt; 0) return false; //å½“å‰kä¸æ»¡è¶³ï¼Œè¯´æ˜è¿™æ¡è·¯èµ°ä¸é€š if (board[i][j] != chars[k]) { return false; } //è¯´æ˜å½“å‰æ»¡è¶³æ¡ä»¶ï¼Œå®é™…ä¸ŠK+1 //èµ°åˆ°ï¼Œæœ€åä¸€ä¸ªäº†Kï¼Œæ»¡è¶³æ¡ä»¶ if (k+1 == chars.length) { return true; } //ä¸æ˜¯èµ°åˆ°çš„æœ€åä¸€ä¸ªï¼Œè¿˜è¦ç»§ç»­åˆ¤æ–­ï¼Œä¾æ¬¡ï¼Œä¸Šä¸‹å·¦å³å°è¯•ç€èµ° //è¿™ä¸ªåšä¸ªæ ‡è®°ï¼Œå›æº¯ï¼Œå‰ªæ char temp = board[i][j]; //æ ‡è®°å½“å‰è·¯å¾„ï¼Œèµ°è¿‡äº† board[i][j] = '\\n'; boolean res = dfs(board, i + 1, j, chars,k + 1) || dfs(board, i - 1, j, chars,k + 1) || dfs(board, i, j + 1, chars,k + 1) || dfs(board, i , j - 1, chars,k + 1); //å›é€€çš„æ—¶å€™ï¼Œå»æ‰æ ‡è®° board[i][j] = temp; return res; }}","link":"/2020/05/10/LeetCode/%E7%9F%A9%E9%98%B5%E4%B8%AD%E7%9A%84%E8%B7%AF%E5%BE%84/"},{"title":"å…³äºSpark é›†ç¾¤ä¸­è°ƒåº¦GPUçš„ä¸€äº›å®éªŒ","text":"è‡ªå·±æ¯•è®¾åšäº†ä¸€äº›Spark è°ƒç”¨GPU ç›¸å…³çš„å®éªŒï¼Œè‡ªå·±ä¹Ÿåœ¨ç½‘ä¸Šæ‰¾åˆ°äº†ä¸€äº›èµ„æ–™ï¼Œä¹Ÿå†™ä¸‹æ¥åˆ†äº«ä¸€äº›è‡ªå·±çš„åšæ³•ã€‚ç›®å‰Spark(2.3) è¿˜ä¸æ”¯æŒç›´æ¥è°ƒç”¨GPU , éœ€è¦è‡ªå·±é€šè¿‡JNIçš„æ–¹å¼å®ç°è°ƒç”¨GPUæ¥åšä¸€äº›åŠ é€Ÿè®¡ç®—ã€‚é€šå¸¸æ˜¯è‡ªå·±å®šä¹‰å¥½æ¥å£ï¼Œåœ¨ç”¨NVCCç”ŸæˆåŠ¨æ€é“¾æ¥åº“ï¼Œç„¶ååœ¨Sparkä¸­è°ƒç”¨ã€‚ è‡ªå·±åšçš„ä¸€äº›å°è¯• 1.é€šè¿‡Docker åšåˆ° GPU å®¹å™¨åŒ–ï¼Œè™šæ‹ŸåŒ–ã€‚è‹¥GPUæ”¯æŒMPSï¼Œå»ºè®®å¼€å¯MPSã€‚ ä¸€ä¸ªå®¹å™¨æˆä¸ºä¸€ä¸ªSparkè®¡ç®—èŠ‚ç‚¹ã€‚ 2.ä¸ºäº†æ›´å¥½çš„æ‰©å±•å’Œè°ƒåº¦ï¼Œé‡‡ç”¨ä¸Šé¢çš„é•œåƒã€‚åœ¨K8Sä¸­å»ºç«‹Sparké›†ç¾¤ï¼Œå¯ä»¥é€šè¿‡å‰¯æœ¬é›†å¿«é€Ÿæ‰©å®¹ã€‚ 3.å¯ä»¥é¢„ä¼°å•ä¸ªè®¡ç®—ä»»åŠ¡ï¼Œéœ€è¦çš„èµ„æºï¼Œåˆç†çš„æŒ‡å®šæ¯ä¸ªGPU node éƒ¨ç½²çš„ å•ä¸ªSparkGPUå®¹å™¨çš„æ•°é‡ã€‚è‹¥éœ€è¦æ›´ç»†ç²’åº¦çš„ç®¡ç†æ¯ä¸ªå®¹å™¨åˆ†é…çš„GPUèµ„æºï¼Œå¯ä»¥æŸ¥çœ‹é˜¿é‡Œäº‘å¼€æºçš„ä¸€ä¸ªK8Sæ’ä»¶ï¼Œæ”¯æŒMBçº§åˆ«çš„åˆ†é…ï¼ˆhttps://github.com/nvidia/k8s-device-pluginï¼‰ 4.æ€»ç»“èµ·æ¥å°±æ˜¯ï¼Œæˆ‘åšçš„æ˜¯æŠŠæ¯å¼ ä¸åŒçš„GPUå¡ï¼Œé€šè¿‡Dockerè™šæ‹ŸåŒ–åšåˆ°ç»†ç²’åº¦çš„é‡åŒ–ï¼Œå› ä¸ºæ¯å¼ å¡çš„è®¡ç®—èƒ½åŠ›ä¸åŒï¼Œè¿™æ ·å¯ä»¥é€šè¿‡K8Sï¼Œå¿«é€Ÿç»™ä¸åŒçš„èŠ‚ç‚¹éƒ¨ç½²ä¸åŒä¸ªæ•°çš„å®¹å™¨å®ä¾‹ï¼Œåœ¨å®¹å™¨å®ä¾‹ä¸­å¯åŠ¨Sparkï¼Œå†å¯¹saprkå±‚é¢åšå…¬å¹³çš„è®¡ç®—åˆ†é…ã€‚","link":"/2019/06/28/%E6%A1%86%E6%9E%B6/gpuonspark/"},{"title":"K8Så®‰è£…","text":"1.æ¯ä¸ªèŠ‚ç‚¹å®‰è£…k8s kubelet kubeadm kubectlï¼Œæ³¨æ„ä¸dockerç‰ˆæœ¬æ˜¯å¦å…¼å®¹ sudo curl https://mirrors.aliyun.com/kubernetes/apt/doc/apt-key.gpg | apt-key add - sudo apt update æŸ¥çœ‹æºä¸­çš„è½¯ä»¶ç‰ˆæœ¬ sudo apt-cache madison kubelet sudo apt install kubelet=1.14.0-00 kubeadm=1.14.0-00 kubectl=1.14.0-00 2.masterèŠ‚ç‚¹åˆ—å‡ºéœ€è¦çš„é•œåƒ kubeadm config images list k8s.gcr.io/kube-apiserver:v1.14.0 k8s.gcr.io/kube-controller-manager:v1.14.0 k8s.gcr.io/kube-scheduler:v1.14.0 k8s.gcr.io/kube-proxy:v1.14.0 k8s.gcr.io/pause:3.1 k8s.gcr.io/etcd:3.3.10 k8s.gcr.io/coredns:1.3.1 3.éœ€è¦ç¿»å¢™ï¼Œæ‰€ä»¥é‡‡ç”¨é•œåƒä¸‹è½½ï¼Œç„¶åé‡æ–°tag docker pull mirrorgooglecontainers/kube-apiserver:v1.14.0 docker pull mirrorgooglecontainers/kube-controller-manager:v1.14.0 docker pull mirrorgooglecontainers/kube-scheduler:v1.14.0 docker pull mirrorgooglecontainers/kube-proxy:v1.14.0 docker pull mirrorgooglecontainers/pause:3.1 docker pull mirrorgooglecontainers/etcd:3.3.10 docker pull coredns/coredns:1.3.1 docker tag mirrorgooglecontainers/kube-apiserver:v1.14.0 k8s.gcr.io/kube-apiserver:v1.14.0 docker tag mirrorgooglecontainers/kube-controller-manager:v1.14.0 k8s.gcr.io/kube-controller-manager:v1.14.0 docker tag mirrorgooglecontainers/kube-scheduler:v1.14.0 k8s.gcr.io/kube-scheduler:v1.14.0 docker tag mirrorgooglecontainers/kube-proxy:v1.14.0 k8s.gcr.io/kube-proxy:v1.14.0 docker tag mirrorgooglecontainers/pause:3.1 k8s.gcr.io/pause:3.1 docker tag mirrorgooglecontainers/etcd:3.3.10 k8s.gcr.io/etcd:3.3.10 docker tag coredns/coredns:1.3.1 k8s.gcr.io/coredns:1.3.1 4.åˆå§‹åŒ–Kubernetes sudo kubeadm init â€“kubernetes-version=v1.14.0 â€“pod-network-cidr=10.244.0.0/16 â€“kubernetes-version ç”¨æ¥æŒ‡å®šç‰ˆæœ¬ â€“pod-network-cidr ç”¨äºåæœŸé‡‡ç”¨flannelä½œä¸ºç½‘ç»œç»„å»ºè€Œå‡†å¤‡ â€“apiserver-advertise-address å¦‚æœæœºå™¨ä¸Šåªæœ‰å•ä¸ªç½‘å¡ï¼Œå¯ä»¥ä¸è¿›è¡ŒæŒ‡å®š [ERROR Swap]: running with swap on is not supported. Please disable swap å…³é—­swap ç¦ç”¨å‘½ä»¤ sudo swapoff -a å¯ç”¨å‘½ä»¤ sudo swapon -a æŸ¥çœ‹äº¤æ¢åˆ†åŒºçš„çŠ¶æ€ sudo free -m Your Kubernetes control-plane has initialized successfully! To start using your cluster, you need to run the following as a regular user: mkdir -p $HOME/.kube sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config sudo chown $(id -u):$(id -g) $HOME/.kube/config You should now deploy a pod network to the cluster. Run â€œkubectl apply -f [podnetwork].yamlâ€ with one of the options listed at: https://kubernetes.io/docs/concepts/cluster-administration/addons/ Then you can join any number of worker nodes by running the following on each as root: kubeadm join 172.16.121.6:6443 â€“token d1m708.8w7qwnomcecapizk â€“discovery-token-ca-cert-hash sha256:01e71d90ca6e7ca5e9359519d1eb42d95c8783c764a53f6048697c586042586f 6.å®‰è£…ç½‘ç»œæ’ä»¶flannel https://raw.githubusercontent.com/coreos/flannel/master/Documentation/kube-flannel.yml kubectl apply -f kube-flannel.yml kubectl get csæ£€æŸ¥ 7.èŠ‚ç‚¹å®‰è£… åŠ è½½å†…æ ¸æ¨¡å— sudo modprobe ip_vs ip_vs_rr ip_vs_wrr ip_vs_sh 8.èŠ‚ç‚¹åŠ å…¥ kubeadm join 172.16.121.6:6443 â€“token d1m708.8w7qwnomcecapizk â€“discovery-token-ca-cert-hash sha256m:01e71d90ca6e7ca5e9359519d1eb42d95c8783c764a53f6048697c586042586f [WARNING IsDockerSystemdCheck]: detected â€œcgroupfsâ€ as the Docker cgroup driver. The recommended driver is â€œsystemdâ€. Please follow the guide at https://kubernetes.io/docs/setup/cri/ error execution phase preflight: [preflight] Some fatal errors occurred: [ERROR Swap]: running with swap on is not supported. Please disable swap å…³é—­swap sudo swapoff -a ä¿®æ”¹cgroup vim /etc/default/kubelet KUBELET_EXTRA_ARGS=â€“cgroup-driver=cgroupfs systemctl daemon-reload systemctl restart kubelet 9.èŠ‚ç‚¹åˆ é™¤ åœ¨master kubectl drain â€“delete-local-data â€“force â€“ignore-daemonsets kubectl delete node ç„¶åä½¿ç”¨ èŠ‚ç‚¹ kubeadm reset 10.journalctl -f -u kubelet æŸ¥çœ‹æ—¥å¿— kubectl logs -f coredns-99b9bb8bd-47mvf -n kube-system kubectl get pods -n kube-system 11.é…ç½®dashborad https://blog.csdn.net/AtlanSI/article/details/88544500 master kubectl apply -f https://raw.githubusercontent.com/kubernetes/dashboard/v1.10.1/src/deploy/recommended/kubernetes-dashboard.yaml æ‰€æœ‰nodeèŠ‚ç‚¹ä¸Š docker pull mirrorgooglecontainers/kubernetes-dashboard-amd64:v1.10.1 docker tag mirrorgooglecontainers/kubernetes-dashboard-amd64:v1.10.1 k8s.gcr.io/kubernetes-dashboard-amd64:v1.10.1 docker pull mirrorgooglecontainers/kubernetes-dashboard-amd64:v1.10.1 docker tag mirrorgooglecontainers/kubernetes-dashboard-amd64:v1.10.1 k8s.gcr.io/kubernetes-dashboard-amd64:v1.10.1 kubectl get pods -n kube-system æŸ¥çœ‹ [root@C7-1 ~]# kubectl get svc -n kube-system NAME TYPE CLUSTER-IP EXTERNAL-IP PORT(S) AGE kube-dns ClusterIP 10.96.0.10 53/UDP,53/TCP 15d kubernetes-dashboard ClusterIP 10.106.249.245 443/TCP 10m [root@C7-1 ~]# kubectl patch svc kubernetes-dashboard -p â€˜{â€œspecâ€:{â€œtypeâ€:â€NodePortâ€}}â€™ -n kube-system [root@C7-1 ~]# kubectl get svc -n kube-system NAME TYPE CLUSTER-IP EXTERNAL-IP PORT(S) AGE kube-dns ClusterIP 10.96.0.10 53/UDP,53/TCP 15d kubernetes-dashboard NodePort 10.106.249.245 443:30115/TCP 147m kubernetes-dashboard NodePort 10.99.200.36 443:32357/TCP 98m 12.Forwarding loop detected in â€œ.â€ zone. Exiting. See ä¿®æ”¹/etc/resolve.conf nameserver 114.114.114.114 kubectl delete pod coredns-fb8b8dccf-7vqfw -n kube-system åˆ é™¤èŠ‚ç‚¹","link":"/2019/05/21/%E6%A1%86%E6%9E%B6/k8sinstall/"},{"title":"C++ï¼šå¦‚ä½•å°†ç±»æˆå‘˜å‡½æ•°ä¼ é€’ç»™pthread_createï¼ˆï¼‰ï¼Ÿ","text":"https://thispointer.com/c-how-to-pass-class-member-function-to-pthread_create/ 1int pthread_create(pthread_t *thread, const pthread_attr_t *attr,void *(*start_routine) (void *), void *arg); æ¥å—ä¸€ä¸ªå‚æ•°å’Œè¿”å›å€¼éƒ½æ˜¯void * çš„å‡½æ•° class Task 123456class Task { public: void * execute(); static void * threadFunc(void *); }; éé™æ€æˆå‘˜å‡½æ•°ä¼ é€’ç»™pthread_createï¼ˆï¼‰ ç¼–è¯‘å™¨å°†classï¼ˆthisæŒ‡é’ˆï¼‰çš„æŒ‡é’ˆä½œä¸ºæ¯ä¸ªæˆå‘˜å‡½æ•°ä¸­çš„ç¬¬ä¸€ä¸ªå‚æ•°ä¼ é€’ã€‚å› æ­¤ï¼Œå°†æŒ‡å‘ç±»Taskçš„å¯¹è±¡çš„æŒ‡é’ˆä½œä¸ºå‚æ•°ä¼ é€’ 1234567typedef void * (*THREADFUNCPTR)(void *); // Pointer to object of class Task Task * taskPtr = new Task(); //Thread ID pthread_t threadId; // Create thread using memeber function as startup routine pthread_create(&amp;threadId, NULL, (THREADFUNCPTR) &amp;Task::execute,taskPtr); å°†é™æ€æˆå‘˜å‡½æ•°ä¼ é€’ç»™pthread_createï¼ˆï¼‰ ç”±äºé™æ€å‡½æ•°ä¸ä»»ä½•å¯¹è±¡éƒ½æ²¡æœ‰å…³è”ï¼Œå› æ­¤ç¼–è¯‘å™¨ä¸ä¼šå°†æ­¤æŒ‡é’ˆä¼ é€’ç»™å®ƒã€‚æ‰€ä»¥ï¼Œæˆ‘ä»¬ä¸éœ€è¦ä¼ é€’ä»»ä½•æŒ‡é’ˆä½œä¸ºå‚æ•°ã€‚åªæ˜¯ä¼ é€’NULLå³ 123typedef void * (*THREADFUNCPTR)(void *); // Create pthread using static function as startup routine pthread_create(&amp;threadId, NULL, (THREADFUNCPTR) &amp;Task::threadFunc, NULL);","link":"/2019/09/23/%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%9F%BA%E7%A1%80/c-pthread/"},{"title":"C++ å¼º&#x2F;å¼±æŒ‡é’ˆ","text":"å¼•ç”¨è®¡æ•°æ³• å¼ºæŒ‡é’ˆ ä¼šä¿®æ”¹å¼•ç”¨è®¡æ•°ã€‚å¼±æŒ‡é’ˆï¼Œä¸ä¼šä¿®æ”¹å¼•ç”¨è®¡æ•° å‚è€ƒ https://www.cnblogs.com/hellokitty2/p/10646353.html 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859606162636465666768697071727374757677787980818283848586878889#include &lt;iostream&gt; using namespace std; //å‚è€ƒ https://www.cnblogs.com/hellokitty2/p/10646353.html //åŸºç±»å®ç° å¼•ç”¨çš„è®¡æ•°çš„åŠŸèƒ½ // ç¼ºé™· è¿™æ˜¯éçº¿ç¨‹å®‰å…¨çš„ class RefBase { private: int refcount = 0; public: RefBase() {} void incStrong(void) { refcount++; } void decStrong(void) { refcount--; } int getStrong(void) { return refcount; } }; //æ¨¡æ¿ç±» å®ç° æŒ‡é’ˆå¼•ç”¨å…¶ä»–ç±»ï¼Œ // å› ä¸ºéœ€è¦è°ƒç”¨å¯¹è±¡çš„æ–¹æ³•ï¼Œæ‰€ä»¥å…¶ä»–ç±»éœ€è¦å®ç°åŸºç±» template&lt;typename T&gt; class sp { private: T *p; public: sp() : p(NULL) { cout &lt;&lt; \"sp()\" &lt;&lt; endl; } //æ„é€ å‡½æ•° å¼•ç”¨åŠ ä¸€ sp(T *p) { cout &lt;&lt; \"sp(T *p)\" &lt;&lt; endl; this-&gt;p = p; this-&gt;p-&gt;incStrong(); } //æ‹·è´å‡½æ•° å¼•ç”¨åŠ ä¸€ sp(const sp &amp;other) { cout &lt;&lt; \"sp(const sp &amp; other)\" &lt;&lt; endl; this-&gt;p = other.p; this-&gt;p-&gt;incStrong(); } //ææ„å‡½æ•° å¼•ç”¨å‡ä¸€ ~sp() { cout &lt;&lt; \"~sp()\" &lt;&lt; endl; this-&gt;p-&gt;decStrong(); // å½“å¼•ç”¨å‡å°‘åˆ°0çš„æ—¶å€™ å°±é‡Šæ”¾å¯¹è±¡ if (!this-&gt;p-&gt;getStrong()) { delete p; //è‡ªåŠ¨è°ƒç”¨ ~Person() cout &lt;&lt; \"delete p\" &lt;&lt; endl; } } //æ“ä½œç¬¦é‡è½½ï¼Œå¯¹æŒ‡é’ˆspè°ƒç”¨çš„æ—¶å€™ï¼Œç­‰ä»·äºpåœ¨è°ƒç”¨ T *operator-&gt;() { return this-&gt;p; } //æ“ä½œç¬¦é‡è½½ï¼Œå¯¹æŒ‡é’ˆspè°ƒç”¨çš„æ—¶å€™ï¼Œç­‰ä»·äºpåœ¨è°ƒç”¨ T &amp;operator*() { return *(this-&gt;p); } }; class Person : public RefBase { public: Person() { cout &lt;&lt; \"Person()\" &lt;&lt; endl; } ~Person() { cout &lt;&lt; \"~Person()\" &lt;&lt; endl; } }; int main() { cout &lt;&lt; \"\"; sp&lt;Person&gt; p1 = new Person(); sp&lt;Person&gt; p2 = p1; } log 1234567Person() sp(T *p) sp(const sp &amp; other) ~sp() ~sp() ~Person() delete p C++å†…å­˜ç®¡ç† new/deleteæ˜¯C++çš„æ“ä½œç¬¦ï¼Œè€Œmalloc/freeæ˜¯Cä¸­çš„å‡½æ•° new/deleteæ˜¯ä¿ç•™å­—ï¼Œä¸éœ€è¦å¤´æ–‡ä»¶æ”¯æŒï¼›malloc/freeéœ€è¦å¤´æ–‡ä»¶åº“å‡½æ•°æ”¯æŒ freeåªæ˜¯é‡Šæ”¾äº†mallocæ‰€ç”³è¯·çš„å†…å­˜ï¼Œå¹¶æ²¡æœ‰æ”¹å˜æŒ‡é’ˆçš„å€¼ new åšäº†2ä»¶äº‹ã€‚å…ˆç”³è¯·ç©ºé—´ï¼Œå†è°ƒç”¨æ„é€ å‡½æ•°ã€‚ delete åšäº†2ä»¶äº‹ä»¶ã€‚å…ˆè°ƒç”¨ææ„å‡½æ•°ï¼Œå†é‡Šæ”¾ç©ºé—´ã€‚ æ³¨æ„ new[] ä¸ delete[] é…å¯¹ä½¿ç”¨ï¼Œå¦‚æœå…ˆ ptr=new object[] åˆ›å»ºå¤šä¸ªå¯¹è±¡ï¼Œç›´æ¥è°ƒç”¨ delete ptrï¼Œåªä¼šè°ƒç”¨å’Œé‡Šæ”¾ä¸€ä¸ªï¼Œå‰©ä¸‹çš„ä¸ä¼šé‡Šæ”¾ï¼Œé€ æˆå†…å­˜æ³„æ¼ã€‚123Cat * ptr= new Cat[5];delete(ptr);//é”™è¯¯ï¼Œåªä¼šå›æ”¶ä¸€ä¸ªdelete[] (ptr);//æ­£ç¡®","link":"/2019/09/21/%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%9F%BA%E7%A1%80/C-ptr/"},{"title":"Cacheä¸è™šå­˜çš„å¼‚åŒ","text":"è™šæ‹Ÿå­˜å‚¨å™¨è™šæ‹Ÿå­˜å‚¨å™¨æ˜¯ä¸€ä¸ªå®¹é‡éå¸¸å¤§çš„å­˜å‚¨å™¨çš„é€»è¾‘æ¨¡å‹ï¼Œä¸æ˜¯ä»»ä½•å®é™…çš„ç‰©ç†å­˜å‚¨å™¨ã€‚è™šæ‹Ÿå­˜å‚¨å™¨æŒ‡çš„æ˜¯ä¸»å­˜â€”â€”å¤–å­˜å±‚æ¬¡ã€‚å®ƒä»¥é€æ˜çš„æ–¹å¼ç»™ç”¨æˆ·æä¾› äº†ä¸€ä¸ªæ¯”å®é™…ä¸»å­˜ç©ºé—´å¤§å¾—å¤šçš„ç¨‹åºåœ°å€ç©ºé—´ã€‚ å®åœ°å€ä¸è™šåœ°å€ç”¨æˆ·ç¼–åˆ¶ç¨‹åºæ—¶ä½¿ç”¨çš„åœ°å€ç§°ä¸ºè™šåœ°å€æˆ–é€»è¾‘åœ°å€ã€‚å…¶å¯¹åº”çš„å­˜å‚¨ç©ºé—´ç§°ä¸ºè™šå­˜ç©ºé—´æˆ–é€»è¾‘åœ°å€ç©ºé—´ï¼›è€Œè®¡ç®—æœºç‰©ç†å†…å­˜çš„è®¿é—®åœ°å€åˆ™ç§°ä¸ºå®åœ°å€æˆ–ç‰©ç†åœ°å€ï¼Œå…¶å¯¹åº”çš„å­˜å‚¨ç©ºé—´ç§°ä¸ºç‰©ç†å­˜å‚¨ç©ºé—´æˆ–ä¸»å­˜ç©ºé—´ã€‚ç¨‹åºè¿›è¡Œè™šåœ°å€åˆ°å®åœ°å€è½¬æ¢çš„è¿‡ç¨‹ç§°ä¸ºç¨‹åºå†å®šä½ã€‚ è™šå­˜çš„è®¿é—®è¿‡ç¨‹æ¯æ¬¡è®¿å­˜æ˜¯ï¼Œé¦–å…ˆåˆ¤æ–­è¯¥è™šåœ°å€æ‰€å¯¹å¼ˆçš„éƒ¨åˆ†æ˜¯å¦åœ¨å®å­˜ä¸­ï¼Œå¦‚æœæ˜¯ï¼Œåˆ™è¿›è¡Œåœ°å€è½¬æ¢å¹¶ç”¨å®åœ°å€è®¿é—®ä¸»å­˜ï¼›å¦åˆ™ï¼ŒæŒ‰ç…§æŸç§ç®—æ³•å°†è¾…å­˜ä¸­çš„éƒ¨åˆ†ç¨‹åºè°ƒåº¦è¿›å†…å­˜ï¼Œå†æŒ‰åŒæ ·çš„æ–¹æ³•è®¿é—®ä¸»å­˜ã€‚ cacheä¸è™šå­˜çš„å¼‚åŒåœ¨ä¸‰çº§å­˜å‚¨ä½“ç³»ä¸­ ï¼Œcache-ä¸»å­˜å’Œä¸»å­˜-è¾…å­˜è¿™ä¸¤ä¸ªå­˜å‚¨å±‚æ¬¡æœ‰è®¸å¤šç›¸åŒç‚¹ï¼šï¼ˆ1ï¼‰å‡ºå‘ç‚¹ç›¸åŒï¼šäºŒè€…éƒ½æ˜¯ä¸ºäº†æé«˜å­˜å‚¨ç³»ç»Ÿçš„æ€§èƒ½ä»·æ ¼æ¯”è€Œè´­ç½®çš„åˆ†å±‚å­˜å‚¨ä½“ç³»ï¼Œéƒ½åŠ›å›¾ä½¿å­˜å‚¨ç³»ç»Ÿçš„æ€§èƒ½æ¥è¿‘é«˜é€Ÿå­˜å‚¨å™¨ï¼Œè€Œä»·æ ¼å’Œå®¹é‡æ¥è¿‘ä½é€Ÿå­˜å‚¨å™¨ã€‚ï¼ˆ2ï¼‰åŸç†ç›¸åŒï¼šéƒ½æ˜¯åˆ©ç”¨äº†ç¨‹åºè¿è¡Œæ—¶çš„å±€éƒ¨æ€§åŸç†å§æœ€è¿‘å¸¸ç”¨çš„ä¿¡æ¯å—ä»ç›¸å¯¹æ…¢é€Ÿè€Œå¤§å®¹é‡çš„å­˜å‚¨å™¨è°ƒå…¥ç›¸å¯¹é«˜é€Ÿè€Œå°å®¹é‡çš„å­˜å‚¨å™¨ã€‚ï¼ˆ3ï¼‰ä¾§é‡ç‚¹ä¸åŒï¼šcacheä¸»è¦è§£å†³ä¸»å­˜ä¸CPUçš„é€Ÿåº¦å·®å¼‚é—®é¢˜ï¼›è€Œå°±æ€§èƒ½ä»·æ ¼æ¯”çš„æé«˜è€Œè¨€ï¼Œè™šå­˜ä¸»è¦æ˜¯è§£å†³å­˜å‚¨å®¹é‡é—®é¢˜ã€‚ï¼ˆ4ï¼‰æ•°æ®é€šè·¯ä¸åŒï¼šCPUä¸cacheå’Œä¸»å­˜ä¹‹é—´å‡æœ‰ç›´æ¥è®¿é—®é€šè·¯ï¼Œcacheä¸å‘½ä¸­æ—¶å¯ç›´æ¥è®¿é—®ä¸»å­˜ï¼Œè€Œè™šå­˜æ‰€ä¸€æ çš„è¾…å­˜ä¸CPUä¹‹é—´ä¸å­˜åœ¨ç›´æ¥çš„æ•°æ®é€šè·¯ï¼Œè€Œä¸»å­˜ä¸å‘½ä¸­æ—¶åªèƒ½é€šè¿‡è°ƒé¡µè§£å†³ï¼ŒCPUæœ€ç»ˆè¿˜æ˜¯è¦è®¿é—®ä¸»å­˜ã€‚ï¼ˆ5ï¼‰é€æ˜æ€§ä¸åŒï¼šcacheçš„ç®¡ç†å®Œå…¨æœ‰ç¡¬ä»¶å®Œæˆï¼Œå¯¹ç³»ç»Ÿç¨‹åºå‘˜å’Œåº”ç”¨ç¨‹åºå‘˜å‡é€æ˜ï¼›è€Œè™šå­˜ç®¡ç†ç”±è½¯ä»¶ï¼ˆæ“ä½œç³»ç»Ÿï¼‰å’Œç¡¬ä»¶å…±åŒå®Œæˆï¼Œç”±äºè½¯ä»¶çš„ä»‹å…¥ï¼Œè™šå­˜å¯¹å®ç°å­˜å‚¨ç®¡ç†çš„ç³»ç»Ÿç¨‹åºå‘˜ä¸é€æ˜ï¼Œè€Œæ”¯é˜Ÿåº”ç”¨ç¨‹åºå‘˜é€æ˜ã€‚ï¼ˆ6ï¼‰æœªå‘½ä¸­æ—¶çš„æŸå¤±ä¸åŒï¼šç”±äºä¸»å­˜çš„å­˜å–æ—¶é—´æ˜¯cacheçš„å­˜å–æ—¶é—´çš„5-10å€ï¼Œè€Œä¸»å­˜çš„å­˜å–é€Ÿåº¦é€šå¸¸æ¯”è¾…å­˜çš„å­˜å–é€Ÿåº¦å¿«ä¸Šåƒå€ï¼Œæ•…ä¸»å­˜æœªå‘½ä¸­æ—¶ç³»ç»Ÿçš„æ€§èƒ½æŸå¤±è¦è¿œå²›å±¿cacheæœªå‘½ä¸­æ—¶çš„æŸå¤±ã€‚","link":"/2019/05/19/%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%9F%BA%E7%A1%80/huancunandxucun/"},{"title":"I&#x2F;Oå¤šè·¯å¤ç”¨çš„æŠ€æœ¯","text":"1. äº‹ä»¶é©±åŠ¨ select() æ¨¡å‹ ç”¨æ³• select()å‡½æ•°å…è®¸è¿›ç¨‹æŒ‡ç¤ºå†…æ ¸ç­‰å¾…å¤šä¸ªäº‹ä»¶ä¸­çš„ä»»ä½•ä¸€ä¸ªå‘ç”Ÿï¼Œå¹¶åªåœ¨æœ‰ä¸€ä¸ªæˆ–å¤šä¸ªäº‹ä»¶å‘ç”Ÿæˆ–ç»å†ä¸€æ®µæŒ‡å®šæ—¶é—´åæ‰å”¤é†’å®ƒ 12345678#include &lt;sys/select.h&gt;#include &lt;sys/time.h&gt;// è¿”å›å€¼ï¼šè‹¥æœ‰å°±ç»ªæè¿°ç¬¦ï¼Œåˆ™è¿”å›å°±ç»ªæè¿°ç¬¦æ•°ç›®ï¼›è‹¥è¶…æ—¶åˆ™è¿”å›0ï¼Œå‡ºé”™è¿”å›-1int select(int maxfdp1, fd_set *readset, fd_set *writeset, fd_set *exceptset, const struct timeval *timeout);//maxfdp1: æŒ‡å®šå¾…æµ‹è¯•çš„æè¿°ç¬¦ä¸ªæ•°ï¼Œå®ƒçš„å€¼æ˜¯å¾…æµ‹è¯•çš„æœ€å¤§æè¿°ç¬¦åŠ 1//readsetã€writesetã€exceptsetï¼šæŒ‡å®šè®©å†…æ ¸æµ‹è¯•è¯»ã€å†™ã€å¼‚å¸¸æ¡ä»¶çš„æè¿°ç¬¦ æè¿°ç¬¦çš„å°±ç»ªæ¡ä»¶ï¼š å¯è¯»æ¡ä»¶ï¼š 1.è¯¥å¥—æ¥å­—æ¥æ”¶ç¼“å†²åŒºä¸­çš„æ•°æ®å­—èŠ‚æ•°å¤§äºç­‰äºå¥—æ¥å­—æ¥æ”¶ç¼“å†²åŒºä½æ°´ä½æ ‡è®°çš„å½“å‰å¤§å° 2.è¯¥è¿æ¥çš„è¯»åŠéƒ¨å…³é—­(å³æ¥æ”¶äº†FINçš„TCPè¿æ¥) 3.è¯¥å¥—æ¥å­—æ˜¯ä¸€ä¸ªç›‘å¬å¥—æ¥å­—ä¸”å·²å®Œæˆçš„è¿æ¥æ•°ä¸ä¸º0 4.è¯¥å¥—æ¥å­—ä¸Šæœ‰ä¸€ä¸ªå¥—æ¥å­—é”™è¯¯å¾…å¤„ç† å¯å†™æ¡ä»¶ï¼š 1.è¯¥å¥—æ¥å­—å‘é€ç¼“å†²åŒºä¸­çš„å¯ç”¨ç©ºé—´å­—èŠ‚æ•°å¤§äºç­‰äºå¥—æ¥å­—å‘é€ç¼“å†²åŒºä½æ°´ä½æ ‡è®°çš„å½“å‰å¤§å° 2.è¯¥è¿æ¥çš„å†™åŠéƒ¨å…³é—­ 3.ä½¿ç”¨éé˜»å¡å¼connectçš„å¥—æ¥å­—å·²å»ºç«‹è¿æ¥ï¼Œæˆ–è€…connectå·²ç»ä»¥å¤±è´¥å‘Šç»ˆ 4.è¯¥å¥—æ¥å­—ä¸Šæœ‰ä¸€ä¸ªå¥—æ¥å­—é”™è¯¯å¾…å¤„ç† å¼‚å¸¸æ¡ä»¶ï¼šè¯¥å¥—æ¥å­—å­˜åœ¨å¸¦å¤–æ•°æ®æˆ–è€…ä»å¤„äºå¸¦å¤–æ ‡è®° ä¼˜ç‚¹ ç›®å‰å‡ ä¹åœ¨æ‰€æœ‰çš„å¹³å°ä¸Šæ”¯æŒ ç¼ºç‚¹ 1.æ¯æ¬¡è°ƒç”¨ select()ï¼Œéƒ½éœ€è¦æŠŠ fd é›†åˆä»ç”¨æˆ·æ€æ‹·è´åˆ°å†…æ ¸æ€ï¼Œè¿™ä¸ªå¼€é”€åœ¨ fd å¾ˆå¤šæ—¶ä¼šå¾ˆå¤§ï¼ŒåŒæ—¶æ¯æ¬¡è°ƒç”¨ select() éƒ½éœ€è¦åœ¨å†…æ ¸éå†ä¼ é€’è¿›æ¥çš„æ‰€æœ‰ fdï¼Œè¿™ä¸ªå¼€é”€åœ¨ fd å¾ˆå¤šæ—¶ä¹Ÿå¾ˆå¤§ã€‚ 2.å•ä¸ªè¿›ç¨‹èƒ½å¤Ÿç›‘è§†çš„æ–‡ä»¶æè¿°ç¬¦çš„æ•°é‡å­˜åœ¨æœ€å¤§é™åˆ¶ï¼Œ32ä½æœºé»˜è®¤æ˜¯1024ä¸ªï¼Œ64ä½æœºé»˜è®¤æ˜¯2048ã€‚å¯ä»¥é€šè¿‡ä¿®æ”¹å®å®šä¹‰ç”šè‡³é‡æ–°ç¼–è¯‘å†…æ ¸çš„æ–¹å¼æå‡è¿™ä¸€é™åˆ¶ï¼Œä½†æ˜¯è¿™æ ·ä¹Ÿä¼šé€ æˆæ•ˆç‡çš„é™ä½ 2 äº‹ä»¶é©±åŠ¨ poll() æ¨¡å‹ ç”¨æ³• #include &lt;poll.h&gt; int poll(struct pollfd *fds, nfds_t nfds, int timeout); å¯¹åº”å‚æ•° ä¼ å…¥ä¸€ä¸ªæ–‡ä»¶æè¿°ç¬¦ç»“æ„ä½“æ•°ç»„ï¼Œä¸ªæ•°ï¼Œç­‰å¾…çš„æ—¶é—´ pollfdç»“æ„ä½“12345struct pollfd{ int fd; //æ–‡ä»¶æè¿°ç¬¦ short events; //éœ€è¦ç­‰å¾…çš„äº‹ä»¶ short revents; //å®é™…å‘ç”Ÿçš„äº‹ä»¶ï¼Œæ“ä½œç³»ç»Ÿå›å†™ }; äº‹ä»¶ ä¼˜ç‚¹ é‡‡ç”¨é“¾è¡¨çš„æ–¹å¼æ›¿æ¢åŸæœ‰fd_setæ•°æ®ç»“æ„,poll() æ²¡æœ‰æœ€å¤§æ–‡ä»¶æè¿°ç¬¦æ•°é‡çš„é™åˆ¶ ç¼ºç‚¹ poll() å’Œ select() åŒæ ·å­˜åœ¨ä¸€ä¸ªç¼ºç‚¹å°±æ˜¯ï¼ŒåŒ…å«å¤§é‡æ–‡ä»¶æè¿°ç¬¦çš„æ•°ç»„è¢«æ•´ä½“å¤åˆ¶äºç”¨æˆ·æ€å’Œå†…æ ¸çš„åœ°å€ç©ºé—´ä¹‹é—´ï¼Œè€Œä¸è®ºè¿™äº›æ–‡ä»¶æè¿°ç¬¦æ˜¯å¦å°±ç»ªï¼Œå®ƒçš„å¼€é”€éšç€æ–‡ä»¶æè¿°ç¬¦æ•°é‡çš„å¢åŠ è€Œçº¿æ€§å¢å¤§ã€‚ 3 äº‹ä»¶é©±åŠ¨ epoll() æ¨¡å‹ å¼•ç”¨ selectã€pollã€epollçš„åŸç†ä¸åŒºåˆ« æ¥è‡ª https://blog.csdn.net/nanxiaotao/article/details/90612404 å‚è€ƒ epollåŸç†å›¾è§£ https://blog.csdn.net/qq_35433716/article/details/85345907 ç”¨æ³• 12345#include &lt;sys/epoll.h&gt; int epoll_create(int size); int epoll_ctl(int epfd, int op, int fd, struct epoll_event *event); int epoll_wait(int epfd, struct epoll_event *event, int maxevents, int timeout); epollçš„ä¸¤ç§å·¥ä½œæ–¹å¼ï¼š1.æ°´å¹³è§¦å‘ï¼ˆLTï¼‰2.è¾¹ç¼˜è§¦å‘ï¼ˆETï¼‰ ETæ¨¡å¼åªæ”¯æŒéé˜»å¡çš„è¯»å†™ï¼šä¸ºäº†ä¿è¯æ•°æ®çš„å®Œæ•´æ€§ã€‚ LTæ¨¡å¼ï¼šè‹¥å°±ç»ªçš„äº‹ä»¶ä¸€æ¬¡æ²¡æœ‰å¤„ç†å®Œè¦åšçš„äº‹ä»¶ï¼Œå°±ä¼šä¸€ç›´å»å¤„ç†ã€‚å³å°±ä¼šå°†æ²¡æœ‰å¤„ç†å®Œçš„äº‹ä»¶ç»§ç»­æ”¾å›åˆ°å°±ç»ªé˜Ÿåˆ—ä¹‹ä¸­ï¼ˆå³é‚£ä¸ªå†…æ ¸ä¸­çš„é“¾è¡¨ï¼‰ï¼Œä¸€ç›´è¿›è¡Œå¤„ç†ã€‚ ETæ¨¡å¼ï¼šå°±ç»ªçš„äº‹ä»¶åªèƒ½å¤„ç†ä¸€æ¬¡ï¼Œè‹¥æ²¡æœ‰å¤„ç†å®Œä¼šåœ¨ä¸‹æ¬¡çš„å…¶å®ƒäº‹ä»¶å°±ç»ªæ—¶å†è¿›è¡Œå¤„ç†ã€‚è€Œè‹¥ä»¥åå†ä¹Ÿæ²¡æœ‰å°±ç»ªçš„äº‹ä»¶ï¼Œé‚£ä¹ˆå‰©ä½™çš„é‚£éƒ¨åˆ†æ•°æ®ä¹Ÿä¼šéšä¹‹è€Œä¸¢å¤± ä¼˜ç‚¹ æœ¬è´¨çš„æ”¹è¿›åœ¨äºepollé‡‡ç”¨åŸºäºäº‹ä»¶çš„å°±ç»ªé€šçŸ¥æ–¹å¼ epollä¹Ÿéœ€è¦å°†æ–‡ä»¶æè¿°ç¬¦å…ˆæ‹·è´è¿›å†…å­˜ï¼Œä½†æ˜¯å®ƒåªåšä¸€æ¬¡ epoll_create()å°±å¥½åƒå…ˆåœ¨å†…æ ¸ä¸­å¼€è¾Ÿå‡ºä¸€ä¸ªå›ºå®šå¤§å°çš„ç©ºçš„æ–‡ä»¶æè¿°ç¬¦é›†åˆï¼Œä¹‹åå†å°†ç›¸åº”çš„æ–‡ä»¶æè¿°ç¬¦æ”¾è¿›å»æˆ–è€…ä»ä¸­å°†æŸä¸€ä¸ªæ–‡ä»¶æè¿°ç¬¦åˆ æ‰ã€‚ åªå…³å¿ƒâ€œæ´»è·ƒâ€çš„é“¾æ¥ï¼Œæ— éœ€éå†å…¨éƒ¨æè¿°ç¬¦é›†åˆ èƒ½å¤Ÿå¤„ç†å¤§é‡çš„é“¾æ¥è¯·æ±‚(ç³»ç»Ÿå¯ä»¥æ‰“å¼€çš„æ–‡ä»¶æ•°ç›®) åœ¨select/pollä¸­ï¼Œè¿›ç¨‹åªæœ‰åœ¨è°ƒç”¨ä¸€å®šçš„æ–¹æ³•åï¼Œå†…æ ¸æ‰å¯¹æ‰€æœ‰ç›‘è§†çš„æ–‡ä»¶æè¿°ç¬¦è¿›è¡Œæ‰«æï¼Œè€Œepolläº‹å…ˆé€šè¿‡epoll_ctl()æ¥æ³¨å†Œä¸€ä¸ªæ–‡ä»¶æè¿°ç¬¦ï¼Œä¸€æ—¦åŸºäºæŸä¸ªæ–‡ä»¶æè¿°ç¬¦å°±ç»ªæ—¶ï¼Œå†…æ ¸ä¼šé‡‡ç”¨ç±»ä¼¼callbackçš„å›è°ƒæœºåˆ¶ï¼Œè¿…é€Ÿæ¿€æ´»è¿™ä¸ªæ–‡ä»¶æè¿°ç¬¦ï¼Œå½“è¿›ç¨‹è°ƒç”¨epoll_wait()æ—¶ä¾¿å¾—åˆ°é€šçŸ¥ã€‚ epoll(å¸‚åœºç”¨çš„æœ€å¤šï¼Œå¦‚æœå•å•è¿æ¥ä¸åšä»»ä½•äº‹ 1Gå†…æ ¸å†…å­˜å¯ä»¥æ”¯æŒ10Wè¿æ¥) epoll ç°åœ¨æ˜¯çº¿ç¨‹å®‰å…¨çš„ ç¼ºç‚¹ åªæœ‰linuxæ”¯æŒ","link":"/2019/04/26/%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%9F%BA%E7%A1%80/ioselect/"},{"title":"æ·±æŒ–CASçš„åº•å±‚å®ç°","text":"å‰è¨€ ä»£ç å±‚é¢ï¼Œæ‰€æœ‰çš„é”åœ¨cpuå±‚é¢éƒ½æ˜¯ä¸€æ¡æ¡çš„æŒ‡ä»¤ï¼Œæ‰€æœ‰æœ€ç»ˆæ‰€æœ‰çš„é”ï¼Œéƒ½è¦è€ƒåº•å±‚æŒ‡ä»¤çš„æ”¯æŒï¼ŒCASæ˜¯ä»£ç å±‚é¢æ¯”è¾ƒå¸¸ç”¨çš„ä¸€ç§â€œæ— é”â€,å®é™…å¯¹åº”äºcpué‡Œé¢çš„å‡ æ¡æŒ‡ä»¤ï¼Œå½“ç„¶ä¸€ä¸ªcpuæœ‰å¤šä¸ªæ ¸ä¸‹æ˜¯å¦‚ä½•è§£å†³é”çš„ã€‚åœ¨å•æ ¸çš„æ—¶å€™ï¼Œè¿˜å¯ä»¥é€šè¿‡å…³é—­ä¸­æ–­ï¼Œæ¥é˜»æ­¢æ“ä½œç³»ç»Ÿè°ƒåº¦ã€‚ä½†æ˜¯åœ¨å¤šæ ¸çš„æƒ…å†µä¸‹ï¼Œå„ä¸ªcpuæ˜¯å¹¶è¡Œæ‰§è¡Œçš„ï¼Œå› æ­¤è¿™ä¸ªæ—¶å€™ï¼Œå°±ä¼šå‡ºç°ï¼ŒåŒæ—¶è·å–åˆ°é”çš„çŠ¶æ€ï¼Œè€Œè¿™ä¸ªæ—¶å€™ï¼Œé€šè¿‡ç¦æ­¢ä¸­æ–­ï¼Œæ˜¯æ²¡æœ‰æ•ˆæœçš„ï¼Œå°±éœ€è¦å¼•å…¥ä¸€ç§æœºåˆ¶å®ç°å¤šæ ¸æœ¬åœ°ç¼“å­˜å¤±æ•ˆå’Œå†…å­˜å…¨å±€çš„é”ï¼Œæ¶‰åŠå¤šçº§ç¼“å­˜çš„å¤±æ•ˆä¸åŒæ­¥ï¼Œå…¶å®åœ¨è®¡ç®—æœºç»„æˆåŸç†ä¸æ“ä½œç³»ç»Ÿé‡Œé¢æœ‰å­¦çš„ã€‚ X86å¹³å° åŸºäºJVM unsafe.compareAndSwapInt å¯ä»¥çœ‹åˆ°jdké‡Œé¢çš„éƒ½æ˜¯nativeå®ç° 12345public final native boolean compareAndSwapObject(Object var1, long var2, Object var4, Object var5); public final native boolean compareAndSwapInt(Object var1, long var2, int var4, int var5); public final native boolean compareAndSwapLong(Object var1, long var2, long var4, long var6); å¯ä»¥åœ¨openjdkçš„æºç src/share/vm/prims/unsafe.cppé‡Œæ‰¾åˆ°å¯¹åº”çš„Cå±‚é¢çš„è°ƒç”¨ 123456UNSAFE_ENTRY(jboolean, Unsafe_CompareAndSwapInt(JNIEnv *env, jobject unsafe, jobject obj, jlong offset, jint e, jint x)) UnsafeWrapper(\"Unsafe_CompareAndSwapInt\"); oop p = JNIHandles::resolve(obj); jint* addr = (jint *) index_oop_from_field_offset_long(p, offset); return (jint)(Atomic::cmpxchg(x, addr, e)) == e;UNSAFE_END æˆ‘ä»¬å¯ä»¥é€šè¿‡c++çš„atmoicåº“è¿›è¡Œè°ƒè¯•ï¼Œå‘ç°æ±‡ç¼–å±‚é¢ 123456789untitled1`atomic_worker:-&gt; 0x10ce7fbed &lt;+157&gt;: lock 0x10ce7fbee &lt;+158&gt;: cmpxchgb %cl, (%rdx) 0x10ce7fbf1 &lt;+161&gt;: sete %cl 0x10ce7fbf4 &lt;+164&gt;: testb $0x1, %cl 0x10ce7fbf7 &lt;+167&gt;: movb %cl, -0x65(%rbp) 0x10ce7fbfa &lt;+170&gt;: movb %al, -0x66(%rbp) 0x10ce7fbfd &lt;+173&gt;: jne 0x10ce7fc8f ; &lt;+319&gt; [inlined] std::__1::__atomic_base&lt;bool, false&gt;::compare_exchange_strong(bool&amp;, bool, std::__1::memory_order) + 249 at main.cpp:30 0x10ce7fc03 &lt;+179&gt;: jmp 0x10ce7fc86 ; &lt;+310&gt; [inlined] std::__1::__atomic_base&lt;bool, false&gt;::compare_exchange_strong(bool&amp;, bool, std::__1::memory_order) + 240 at main.cpp:30 lockä¸cmpxchgb lock å¹¶ä¸æ˜¯å•ç‹¬çš„ä¸€æ¡å¯æ‰§è¡ŒæŒ‡ä»¤ï¼Œä½ debug ä½¿ç”¨next i ä¼šå‘ç°æ˜¯2æ¡ä¸€èµ·èµ°äº† LOCKå‰ç¼€å¯ç¡®ä¿CPUåœ¨æ“ä½œæœŸé—´å¯¹é€‚å½“çš„é«˜é€Ÿç¼“å­˜è¡Œå…·æœ‰æ’ä»–æ€§æ‰€æœ‰æƒï¼Œå¹¶æä¾›æŸäº›å…¶ä»–æ’åºä¿è¯ã€‚ è¿™å¯ä»¥é€šè¿‡å£°æ˜æ€»çº¿é”å®šæ¥å®ç°ï¼Œä½†æ˜¯CPUä¼šå°½å¯èƒ½é¿å…è¿™ç§æƒ…å†µã€‚ å¦‚æœæ€»çº¿è¢«é”å®šï¼Œåˆ™ä»…åœ¨é”å®šæŒ‡ä»¤æœŸé—´ã€‚ cmpxchgb ç³»åˆ—å°±æ˜¯çœŸæ­£çš„åº•å±‚CASçš„æ”¯æŒ ARMå¹³å° åŸºäºandroid art CompareAndSetWeakAcquire123456// Atomically replace the value with desired_value if it matches the expected_value. Prior writes // made to other memory locations by the thread that did the release become visible in this // thread. bool CompareAndSetWeakAcquire(T expected_value, T desired_value) { return this-&gt;compare_exchange_weak(expected_value, desired_value, std::memory_order_acquire); } é€šè¿‡ASdebug å¾—åˆ°nativeæ±‡ç¼– 123456-&gt; 0x7ea6aa6964 &lt;+220&gt;: ldaxr w10, [x22] //æ¯”è¾ƒ 0x7ea6aa6968 &lt;+224&gt;: cmp w10, w9 //bne: æ•°æ®è·³è½¬æŒ‡ä»¤ï¼Œé“æ ‡å¿—å¯„å­˜å™¨ä¸­Zæ ‡å¿—ä½ä¸ç­‰äºé›¶æ—¶, è·³è½¬åˆ°BNEåæ ‡ç­¾å¤„ 0x7ea6aa696c &lt;+228&gt;: b.ne 0x7ea6aa693c ; &lt;+180&gt; [inlined] std::__1::__atomic_base&lt;int, false&gt;::compare_exchange_weak(int&amp;, int, std::__1::memory_order) at atomic.h:159 0x7ea6aa6970 &lt;+232&gt;: stxr w9, w8, [x22] ldaxr stxrLoad-acquire exclusive register ARMV8ä¸‹çš„CASå¹¶ä¸æ˜¯ä¸€æ¡æŒ‡ä»¤OK Load-Acquire Exclusive Register derives an address from a base register value, loads a 32-bit word or 64-bit doubleword from memory, and writes it to a register. The memory access is atomic. The PE marks the physical address being accessed as an exclusive access. This exclusive access mark is checked by Store Exclusive instructions. See Synchronization and semaphores. The instruction also has memory ordering semantics as described in Load-Acquire, Store-Release. For information about memory accesses see Load/Store addressing modes. å†…å­˜è®¿é—®æ˜¯åŸå­çš„ã€‚PEå°†è¦è®¿é—®çš„ç‰©ç†åœ°å€æ ‡è®°ä¸ºäº’æ–¥è®¿é—® LDXRæŒ‡ä»¤ï¼Œå°†çŠ¶æ€ä»opençŠ¶æ€åˆ‡æ¢åˆ°exclusiveçŠ¶æ€ï¼ŒSTXRæŒ‡ä»¤ï¼Œå°†çŠ¶æ€ä»exclusiveçŠ¶æ€åˆ‡æ¢åˆ°opençŠ¶æ€ï¼Œè¿™ä¸ªå°±è¡¨ç¤ºstore exclusiveæ“ä½œæˆåŠŸã€‚ ä¸ºäº†è§£å†³å¤šæ ¸æƒ…å†µä¸‹çš„é”ç«äº‰é—®é¢˜ï¼Œarmå¼•å…¥äº†exclusiveæ“ä½œï¼Œå¹¶æ·»åŠ äº†ç›¸åº”çš„æŒ‡ä»¤ exclusiveçš„æ“ä½œçš„æ ¸å¿ƒï¼Œå°±æ˜¯ä¼šå°†é”ï¼Œç”¨ä¸€ä¸ªçŠ¶æ€æœºè¿›è¡Œç»´æŠ¤ï¼Œè¯¥çŠ¶æ€æœºæœ‰2ç§çŠ¶æ€ï¼ŒopençŠ¶æ€å’ŒexclusiveçŠ¶æ€ã€‚è¦æƒ³æˆåŠŸçš„å¯¹é”è¿›è¡Œä¸Šé”ï¼ŒçŠ¶æ€å¿…é¡»è¦ä»exclusiveçŠ¶æ€åˆ‡æ¢åˆ°opençŠ¶æ€ï¼Œå…¶ä»–çŠ¶æ€ï¼Œéƒ½æ˜¯å¤±è´¥çš„ã€‚ è¦è¾¾åˆ°ç›®çš„ï¼Œæ˜¾ç„¶exclusiveæ˜¯å¯¹æ¯ä¸ªCPUæ ¸éƒ½æ˜¯æœ‰æ•ˆçš„ é€šè¿‡ldaxr/stxræŒ‡ä»¤å®ç°åœ¨SMPç³»ç»Ÿä¸­å¤šæ ¸å…±äº«å†…å­˜çš„äº’æ–¥è®¿é—®ï¼Œä¹Ÿå°±æ˜¯è¯´åŸå­æ“ä½œæ˜¯ç”±ç‹¬å è®¿é—®æŒ‡ä»¤â€Load-Exclusive and Store-Exclusiveâ€æ¥å®ç°çš„ï¼Œå…¶ä¸­æœ€æ ¸å¿ƒçš„åœ°æ–¹åœ¨äºç³»ç»Ÿé€šè¿‡exclusive monitor(ä¸€ç§ç®€å•çš„çŠ¶æ€æœº)æ¥ç›‘æ§ç‹¬å è®¿é—®ã€‚ldaxr/stxrå¯ä»¥ä¿è¯ä»»ä½•æƒ…å†µä¸‹ï¼ˆåŒ…æ‹¬è¢«ä¸­æ–­ï¼‰çš„è®¿é—®åŸå­æ€§ã€‚ STXRæŒ‡ä»¤å’Œæ™®é€šçš„STRæŒ‡ä»¤ï¼Œä¸åŒçš„æ˜¯ï¼Œè¯¥æŒ‡ä»¤æœ‰è¿”å›å€¼ï¼Œè¡¨ç¤ºstore exclusiveæ˜¯å¦æˆåŠŸã€‚å¦‚æœæˆåŠŸï¼Œwsä¸º0ï¼Œä¸æˆåŠŸï¼Œwsä¸º1 å‚è€ƒ éƒ¨åˆ†è½¬è½½ http://www.lujun.org.cn/?p=4097 http://shell-storm.org/armv8-a/ISA_v85A_A64_xml_00bet8/from-ISA_v84A_A64_xml_00bet7/ldaxr.html https://www.cnblogs.com/i-arm-rex/p/6736170.html","link":"/2020/05/19/%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%9F%BA%E7%A1%80/%E6%B7%B1%E6%8C%96CAS%E7%9A%84%E5%BA%95%E5%B1%82%E5%AE%9E%E7%8E%B0/"},{"title":"é¡¹ç›®å¦‚ä½•ç”Ÿæˆæ¨¡å—å…³ç³»å›¾ï¼Ÿ","text":"æ•ˆæœå›¾å¦‚ä¸‹ Gradle Task123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116task projectDependencyGraph { doLast { def dot = new File(rootProject.buildDir, 'reports/dependency-graph/project.dot') dot.parentFile.mkdirs() dot.delete() dot &lt;&lt; 'digraph {\\n' dot &lt;&lt; \" graph [label=\\\"${rootProject.name}\\\\n \\\",labelloc=t,fontsize=30,ranksep=1.4];\\n\" dot &lt;&lt; ' node [style=filled, fillcolor=\"#bbbbbb\"];\\n' dot &lt;&lt; ' rankdir=TB;\\n' def rootProjects = [] def queue = [rootProject] while (!queue.isEmpty()) { def project = queue.remove(0) rootProjects.add(project) queue.addAll(project.childProjects.values()) } def projects = new LinkedHashSet&lt;Project&gt;() def dependencies = new LinkedHashMap&lt;Tuple2&lt;Project, Project&gt;, List&lt;String&gt;&gt;() def multiplatformProjects = [] def jsProjects = [] def androidProjects = [] def javaProjects = [] queue = [rootProject] while (!queue.isEmpty()) { def project = queue.remove(0) queue.addAll(project.childProjects.values()) if (project.plugins.hasPlugin('org.jetbrains.kotlin.multiplatform')) { multiplatformProjects.add(project) } if (project.plugins.hasPlugin('org.jetbrains.kotlin.js')) { jsProjects.add(project) } if (project.plugins.hasPlugin('com.android.library') || project.plugins.hasPlugin('com.android.application')) { androidProjects.add(project) } if (project.plugins.hasPlugin('java-library') || project.plugins.hasPlugin('java')) { javaProjects.add(project) } project.configurations.all { config -&gt; config.dependencies .withType(ProjectDependency) .collect { it.dependencyProject } .each { dependency -&gt; projects.add(project) projects.add(dependency) rootProjects.remove(dependency) def graphKey = new Tuple2&lt;Project, Project&gt;(project, dependency) def traits = dependencies.computeIfAbsent(graphKey) { new ArrayList&lt;String&gt;() } if (config.name.toLowerCase().endsWith('implementation')) { traits.add('style=dotted') } } } } projects = projects.sort { it.path } dot &lt;&lt; '\\n # Projects\\n\\n' for (project in projects) { def traits = [] if (rootProjects.contains(project)) { traits.add('shape=box') } if (multiplatformProjects.contains(project)) { traits.add('fillcolor=\"#ffd2b3\"') } else if (jsProjects.contains(project)) { traits.add('fillcolor=\"#ffffba\"') } else if (androidProjects.contains(project)) { traits.add('fillcolor=\"#baffc9\"') } else if (javaProjects.contains(project)) { traits.add('fillcolor=\"#ffb3ba\"') } else { traits.add('fillcolor=\"#eeeeee\"') } dot &lt;&lt; \" \\\"${project.path}\\\" [${traits.join(\", \")}];\\n\" } dot &lt;&lt; '\\n {rank = same;' for (project in projects) { if (rootProjects.contains(project)) { dot &lt;&lt; \" \\\"${project.path}\\\";\" } } dot &lt;&lt; '}\\n' dot &lt;&lt; '\\n # Dependencies\\n\\n' dependencies.forEach { key, traits -&gt; dot &lt;&lt; \" \\\"${key.first.path}\\\" -&gt; \\\"${key.second.path}\\\"\" if (!traits.isEmpty()) { dot &lt;&lt; \" [${traits.join(\", \")}]\" } dot &lt;&lt; '\\n' } dot &lt;&lt; '}\\n' def p = 'dot -Tpng -O project.dot'.execute([], dot.parentFile) p.waitFor() if (p.exitValue() != 0) { throw new RuntimeException(p.errorStream.text) } println(\"Project module dependency graph created at ${dot.absolutePath}.png\") }} ä¾èµ–å®‰è£…ç”Ÿæˆçš„é¡¹ç›®ä¾èµ–æè¿°æ–‡ä»¶è½¬å›¾ç‰‡ï¼Œä¾èµ– graphviz,éœ€è¦æ‰‹åŠ¨å®‰è£…ä¸€ä¸‹ Linux, æ ¹äºåŒ…ç®¡ç†å™¨è‡ªé€‰ apt install graphviz yum install graphviz Macï¼Œæ ¹äºåŒ…ç®¡ç†å™¨è‡ªé€‰ port install graphviz brew install graphviz æ¥æº GitHub Gradleä»»åŠ¡","link":"/2021/07/10/%E9%A1%B9%E7%9B%AE%E6%9E%B6%E6%9E%84/android_project_graph/"},{"title":"JVMå‚æ•°","text":"1.å‚æ•°çº§åˆ«å…¶ä¸€æ˜¯æ ‡å‡†å‚æ•°ï¼ˆ-ï¼‰æ‰€æœ‰çš„JVMå®ç°éƒ½å¿…é¡»å®ç°è¿™äº›å‚æ•°çš„åŠŸèƒ½ï¼Œè€Œä¸”å‘åå…¼å®¹ï¼› å…¶äºŒæ˜¯éæ ‡å‡†å‚æ•°ï¼ˆ-Xï¼‰é»˜è®¤jvmå®ç°è¿™äº›å‚æ•°çš„åŠŸèƒ½ï¼Œä½†æ˜¯å¹¶ä¸ä¿è¯æ‰€æœ‰jvmå®ç°éƒ½æ»¡è¶³ï¼Œä¸”ä¸ä¿è¯å‘åå…¼å®¹ï¼› å…¶ä¸‰æ˜¯éStableå‚æ•°ï¼ˆ-XXï¼‰æ­¤ç±»å‚æ•°å„ä¸ªjvmå®ç°ä¼šæœ‰æ‰€ä¸åŒï¼Œå°†æ¥å¯èƒ½ä¼šéšæ—¶å–æ¶ˆï¼Œéœ€è¦æ…é‡ä½¿ç”¨ï¼› 2.åœ¨å‘½ä»¤è¡Œä¸­å¯ä»¥è¾“å‡ºæ‰€æœ‰XXå‚æ•°å’Œå€¼-XX:+PrintCommandLineFlags1234567-XX:InitialHeapSize=264819328-XX:MaxHeapSize=4237109248 -XX:+PrintCommandLineFlags-XX:+UseCompressedClassPointers -XX:+UseCompressedOops -XX:-UseLargePagesIndividualAllocation -XX:+UseParallelGC -XX:+PrintFlagsFinal and -XX:+PrintFlagsInitial3 .å¸¸è§å‚æ•°BiasedLockingBulkRebiasThreshold = 20 åç½®é”å®šæ‰¹é‡é‡æ–°åç½®é˜ˆå€¼åŒä¸€ä¸ªç±»çš„å¯¹è±¡ï¼Œæ’¤é”€åå‘é”å‡çº§ä¸ºè½»é‡çº§é” æ¬¡æ•°è¾¾åˆ°20ï¼Œæ‰¹é‡é‡æ–°åå‘åˆ°å½“å‰çº¿ç¨‹ã€‚BiasedLockingBulkRevokeThreshold = 40 åç½®é”å®šæ‰¹é‡æ’¤é”€é˜ˆå€¼åŒä¸€ä¸ªç±»çš„å¯¹è±¡ï¼Œæ’¤é”€åå‘é”å‡çº§ä¸ºè½»é‡çº§é” æ¬¡æ•°è¶…è¿‡40ï¼Œå…¨éƒ¨æ‰¹é‡æ’¤é”€ï¼Œå‡çº§ä¸ºè½»é‡çº§é”ã€‚-XX:+PrintGCDetails -XX:BiasedLockingStartupDelay=0 -XX:+TraceBiasedLocking -XX:+PrintGCApplicationStoppedTime 4 .é™„å½•728è¡Œ 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128129130131132133134135136137138139140141142143144145146147148149150151152153154155156157158159160161162163164165166167168169170171172173174175176177178179180181182183184185186187188189190191192193194195196197198199200201202203204205206207208209210211212213214215216217218219220221222223224225226227228229230231232233234235236237238239240241242243244245246247248249250251252253254255256257258259260261262263264265266267268269270271272273274275276277278279280281282283284285286287288289290291292293294295296297298299300301302303304305306307308309310311312313314315316317318319320321322323324325326327328329330331332333334335336337338339340341342343344345346347348349350351352353354355356357358359360361362363364365366367368369370371372373374375376377378379380381382383384385386387388389390391392393394395396397398399400401402403404405406407408409410411412413414415416417418419420421422423424425426427428429430431432433434435436437438439440441442443444445446447448449450451452453454455456457458459460461462463464465466467468469470471472473474475476477478479480481482483484485486487488489490491492493494495496497498499500501502503504505506507508509510511512513514515516517518519520521522523524525526527528529530531532533534535536537538539540541542543544545546547548549550551552553554555556557558559560561562563564565566567568569570571572573574575576577578579580581582583584585586587588589590591592593594595596597598599600601602603604605606607608609610611612613614615616617618619620621622623624625626627628629630631632633634635636637638639640641642643644645646647648649650651652653654655656657658659660661662663664665666667668669670671672673674675676677678679680681682683684685686687688689690691692693694695696697698699700701702703704705706707708709710711712713714715716717718719720721722723724725726727728 intx ActiveProcessorCount = -1 {product} uintx AdaptiveSizeDecrementScaleFactor = 4 {product} uintx AdaptiveSizeMajorGCDecayTimeScale = 10 {product} uintx AdaptiveSizePausePolicy = 0 {product} uintx AdaptiveSizePolicyCollectionCostMargin = 50 {product} uintx AdaptiveSizePolicyInitializingSteps = 20 {product} uintx AdaptiveSizePolicyOutputInterval = 0 {product} uintx AdaptiveSizePolicyWeight = 10 {product} uintx AdaptiveSizeThroughPutPolicy = 0 {product} uintx AdaptiveTimeWeight = 25 {product} bool AdjustConcurrency = false {product} bool AggressiveHeap = false {product} bool AggressiveOpts = false {product} intx AliasLevel = 3 {C2 product} bool AlignVector = true {C2 product} intx AllocateInstancePrefetchLines = 1 {product} intx AllocatePrefetchDistance = -1 {product} intx AllocatePrefetchInstr = 0 {product} intx AllocatePrefetchLines = 3 {product} intx AllocatePrefetchStepSize = 16 {product} intx AllocatePrefetchStyle = 1 {product} bool AllowJNIEnvProxy = false {product} bool AllowNonVirtualCalls = false {product} bool AllowParallelDefineClass = false {product} bool AllowUserSignalHandlers = false {product} bool AlwaysActAsServerClassMachine = false {product} bool AlwaysCompileLoopMethods = false {product} bool AlwaysLockClassLoader = false {product} bool AlwaysPreTouch = false {product} bool AlwaysRestoreFPU = false {product} bool AlwaysTenure = false {product} bool AssertOnSuspendWaitFailure = false {product} bool AssumeMP = false {product} intx AutoBoxCacheMax = 128 {C2 product} uintx AutoGCSelectPauseMillis = 5000 {product} intx BCEATraceLevel = 0 {product} intx BackEdgeThreshold = 100000 {pd product} bool BackgroundCompilation = true {pd product} uintx BaseFootPrintEstimate = 268435456 {product} intx BiasedLockingBulkRebiasThreshold = 20 {product} intx BiasedLockingBulkRevokeThreshold = 40 {product} intx BiasedLockingDecayTime = 25000 {product} intx BiasedLockingStartupDelay = 4000 {product} bool BindGCTaskThreadsToCPUs = false {product} bool BlockLayoutByFrequency = true {C2 product} intx BlockLayoutMinDiamondPercentage = 20 {C2 product} bool BlockLayoutRotateLoops = true {C2 product} bool BranchOnRegister = false {C2 product} bool BytecodeVerificationLocal = false {product} bool BytecodeVerificationRemote = true {product} bool C1OptimizeVirtualCallProfiling = true {C1 product} bool C1ProfileBranches = true {C1 product} bool C1ProfileCalls = true {C1 product} bool C1ProfileCheckcasts = true {C1 product} bool C1ProfileInlinedCalls = true {C1 product} bool C1ProfileVirtualCalls = true {C1 product} bool C1UpdateMethodData = true {C1 product} intx CICompilerCount = 2 {product} bool CICompilerCountPerCPU = false {product} bool CITime = false {product} bool CMSAbortSemantics = false {product} uintx CMSAbortablePrecleanMinWorkPerIteration = 100 {product} intx CMSAbortablePrecleanWaitMillis = 100 {manageable} uintx CMSBitMapYieldQuantum = 10485760 {product} uintx CMSBootstrapOccupancy = 50 {product} bool CMSClassUnloadingEnabled = true {product} uintx CMSClassUnloadingMaxInterval = 0 {product} bool CMSCleanOnEnter = true {product} bool CMSCompactWhenClearAllSoftRefs = true {product} uintx CMSConcMarkMultiple = 32 {product} bool CMSConcurrentMTEnabled = true {product} uintx CMSCoordinatorYieldSleepCount = 10 {product} bool CMSDumpAtPromotionFailure = false {product} bool CMSEdenChunksRecordAlways = true {product} uintx CMSExpAvgFactor = 50 {product} bool CMSExtrapolateSweep = false {product} uintx CMSFullGCsBeforeCompaction = 0 {product} uintx CMSIncrementalDutyCycle = 10 {product} uintx CMSIncrementalDutyCycleMin = 0 {product} bool CMSIncrementalMode = false {product} uintx CMSIncrementalOffset = 0 {product} bool CMSIncrementalPacing = true {product} uintx CMSIncrementalSafetyFactor = 10 {product} uintx CMSIndexedFreeListReplenish = 4 {product} intx CMSInitiatingOccupancyFraction = -1 {product} uintx CMSIsTooFullPercentage = 98 {product} double CMSLargeCoalSurplusPercent = 0.950000 {product} double CMSLargeSplitSurplusPercent = 1.000000 {product} bool CMSLoopWarn = false {product} uintx CMSMaxAbortablePrecleanLoops = 0 {product} intx CMSMaxAbortablePrecleanTime = 5000 {product} uintx CMSOldPLABMax = 1024 {product} uintx CMSOldPLABMin = 16 {product} uintx CMSOldPLABNumRefills = 4 {product} uintx CMSOldPLABReactivityFactor = 2 {product} bool CMSOldPLABResizeQuicker = false {product} uintx CMSOldPLABToleranceFactor = 4 {product} bool CMSPLABRecordAlways = true {product} uintx CMSParPromoteBlocksToClaim = 16 {product} bool CMSParallelInitialMarkEnabled = true {product} bool CMSParallelRemarkEnabled = true {product} bool CMSParallelSurvivorRemarkEnabled = true {product} uintx CMSPrecleanDenominator = 3 {product} uintx CMSPrecleanIter = 3 {product} uintx CMSPrecleanNumerator = 2 {product} bool CMSPrecleanRefLists1 = true {product} bool CMSPrecleanRefLists2 = false {product} bool CMSPrecleanSurvivors1 = false {product} bool CMSPrecleanSurvivors2 = true {product} uintx CMSPrecleanThreshold = 1000 {product} bool CMSPrecleaningEnabled = true {product} bool CMSPrintChunksInDump = false {product} bool CMSPrintEdenSurvivorChunks = false {product} bool CMSPrintObjectsInDump = false {product} uintx CMSRemarkVerifyVariant = 1 {product} bool CMSReplenishIntermediate = true {product} uintx CMSRescanMultiple = 32 {product} uintx CMSSamplingGrain = 16384 {product} bool CMSScavengeBeforeRemark = false {product} uintx CMSScheduleRemarkEdenPenetration = 50 {product} uintx CMSScheduleRemarkEdenSizeThreshold = 2097152 {product} uintx CMSScheduleRemarkSamplingRatio = 5 {product} double CMSSmallCoalSurplusPercent = 1.050000 {product} double CMSSmallSplitSurplusPercent = 1.100000 {product} bool CMSSplitIndexedFreeListBlocks = true {product} intx CMSTriggerInterval = -1 {manageable} uintx CMSTriggerRatio = 80 {product} intx CMSWaitDuration = 2000 {manageable} uintx CMSWorkQueueDrainThreshold = 10 {product} bool CMSYield = true {product} uintx CMSYieldSleepCount = 0 {product} uintx CMSYoungGenPerWorker = 67108864 {pd product} uintx CMS_FLSPadding = 1 {product} uintx CMS_FLSWeight = 75 {product} uintx CMS_SweepPadding = 1 {product} uintx CMS_SweepTimerThresholdMillis = 10 {product} uintx CMS_SweepWeight = 75 {product} bool CheckEndorsedAndExtDirs = false {product} bool CheckJNICalls = false {product} bool ClassUnloading = true {product} bool ClassUnloadingWithConcurrentMark = true {product} intx ClearFPUAtPark = 0 {product} bool ClipInlining = true {product} uintx CodeCacheExpansionSize = 65536 {pd product} uintx CodeCacheMinimumFreeSpace = 512000 {product} bool CollectGen0First = false {product} bool CompactFields = true {product} intx CompilationPolicyChoice = 0 {product}ccstrlist CompileCommand = {product} ccstr CompileCommandFile = {product}ccstrlist CompileOnly = {product} intx CompileThreshold = 10000 {pd product} bool CompilerThreadHintNoPreempt = true {product} intx CompilerThreadPriority = -1 {product} intx CompilerThreadStackSize = 0 {pd product} uintx CompressedClassSpaceSize = 1073741824 {product} uintx ConcGCThreads = 0 {product} intx ConditionalMoveLimit = 3 {C2 pd product} intx ContendedPaddingWidth = 128 {product} bool ConvertSleepToYield = true {pd product} bool ConvertYieldToSleep = false {product} bool CrashOnOutOfMemoryError = false {product} bool CreateMinidumpOnCrash = false {product} bool CriticalJNINatives = true {product} bool DTraceAllocProbes = false {product} bool DTraceMethodProbes = false {product} bool DTraceMonitorProbes = false {product} bool Debugging = false {product} uintx DefaultMaxRAMFraction = 4 {product} intx DefaultThreadPriority = -1 {product} intx DeferPollingPageLoopCount = -1 {product} intx DeferThrSuspendLoopCount = 4000 {product} bool DeoptimizeRandom = false {product} bool DisableAttachMechanism = false {product} bool DisableExplicitGC = false {product} bool DisplayVMOutputToStderr = false {product} bool DisplayVMOutputToStdout = false {product} bool DoEscapeAnalysis = true {C2 product} bool DontCompileHugeMethods = true {product} bool DontYieldALot = false {pd product} ccstr DumpLoadedClassList = {product} bool DumpReplayDataOnError = true {product} bool DumpSharedSpaces = false {product} bool EagerXrunInit = false {product} intx EliminateAllocationArraySizeLimit = 64 {C2 product} bool EliminateAllocations = true {C2 product} bool EliminateAutoBox = true {C2 product} bool EliminateLocks = true {C2 product} bool EliminateNestedLocks = true {C2 product} intx EmitSync = 0 {product} bool EnableContended = true {product} bool EnableResourceManagementTLABCache = true {product} bool EnableSharedLookupCache = true {product} bool EnableTracing = false {product} uintx ErgoHeapSizeLimit = 0 {product} ccstr ErrorFile = {product} ccstr ErrorReportServer = {product} double EscapeAnalysisTimeout = 20.000000 {C2 product} bool EstimateArgEscape = true {product} bool ExitOnOutOfMemoryError = false {product} bool ExplicitGCInvokesConcurrent = false {product} bool ExplicitGCInvokesConcurrentAndUnloadsClasses = false {product} bool ExtendedDTraceProbes = false {product} ccstr ExtraSharedClassListFile = {product} bool FLSAlwaysCoalesceLarge = false {product} uintx FLSCoalescePolicy = 2 {product} double FLSLargestBlockCoalesceProximity = 0.990000 {product} bool FailOverToOldVerifier = true {product} bool FastTLABRefill = true {product} intx FenceInstruction = 0 {ARCH product} intx FieldsAllocationStyle = 1 {product} bool FilterSpuriousWakeups = true {product} ccstr FlightRecorderOptions = {product} bool ForceNUMA = false {product} bool ForceTimeHighResolution = false {product} intx FreqInlineSize = 325 {pd product} double G1ConcMarkStepDurationMillis = 10.000000 {product} uintx G1ConcRSHotCardLimit = 4 {product} uintx G1ConcRSLogCacheSize = 10 {product} intx G1ConcRefinementGreenZone = 0 {product} intx G1ConcRefinementRedZone = 0 {product} intx G1ConcRefinementServiceIntervalMillis = 300 {product} uintx G1ConcRefinementThreads = 0 {product} intx G1ConcRefinementThresholdStep = 0 {product} intx G1ConcRefinementYellowZone = 0 {product} uintx G1ConfidencePercent = 50 {product} uintx G1HeapRegionSize = 0 {product} uintx G1HeapWastePercent = 5 {product} uintx G1MixedGCCountTarget = 8 {product} intx G1RSetRegionEntries = 0 {product} uintx G1RSetScanBlockSize = 64 {product} intx G1RSetSparseRegionEntries = 0 {product} intx G1RSetUpdatingPauseTimePercent = 10 {product} intx G1RefProcDrainInterval = 10 {product} uintx G1ReservePercent = 10 {product} uintx G1SATBBufferEnqueueingThresholdPercent = 60 {product} intx G1SATBBufferSize = 1024 {product} intx G1UpdateBufferSize = 256 {product} bool G1UseAdaptiveConcRefinement = true {product} uintx GCDrainStackTargetSize = 64 {product} uintx GCHeapFreeLimit = 2 {product} uintx GCLockerEdenExpansionPercent = 5 {product} bool GCLockerInvokesConcurrent = false {product} uintx GCLogFileSize = 8192 {product} uintx GCPauseIntervalMillis = 0 {product} uintx GCTaskTimeStampEntries = 200 {product} uintx GCTimeLimit = 98 {product} uintx GCTimeRatio = 99 {product} uintx HeapBaseMinAddress = 2147483648 {pd product} bool HeapDumpAfterFullGC = false {manageable} bool HeapDumpBeforeFullGC = false {manageable} bool HeapDumpOnOutOfMemoryError = false {manageable} ccstr HeapDumpPath = {manageable} uintx HeapFirstMaximumCompactionCount = 3 {product} uintx HeapMaximumCompactionInterval = 20 {product} uintx HeapSizePerGCThread = 87241520 {product} bool IgnoreEmptyClassPaths = false {product} bool IgnoreUnrecognizedVMOptions = false {product} uintx IncreaseFirstTierCompileThresholdAt = 50 {product} bool IncrementalInline = true {C2 product} uintx InitialBootClassLoaderMetaspaceSize = 4194304 {product} uintx InitialCodeCacheSize = 2555904 {pd product} uintx InitialHeapSize = 0 {product} uintx InitialRAMFraction = 64 {product} double InitialRAMPercentage = 1.562500 {product} uintx InitialSurvivorRatio = 8 {product} uintx InitialTenuringThreshold = 7 {product} uintx InitiatingHeapOccupancyPercent = 45 {product} bool Inline = true {product} ccstr InlineDataFile = {product} intx InlineSmallCode = 1000 {pd product} bool InlineSynchronizedMethods = true {C1 product} bool InsertMemBarAfterArraycopy = true {C2 product} intx InteriorEntryAlignment = 16 {C2 pd product} intx InterpreterProfilePercentage = 33 {product} bool JNIDetachReleasesMonitors = true {product} bool JavaMonitorsInStackTrace = true {product} intx JavaPriority10_To_OSPriority = -1 {product} intx JavaPriority1_To_OSPriority = -1 {product} intx JavaPriority2_To_OSPriority = -1 {product} intx JavaPriority3_To_OSPriority = -1 {product} intx JavaPriority4_To_OSPriority = -1 {product} intx JavaPriority5_To_OSPriority = -1 {product} intx JavaPriority6_To_OSPriority = -1 {product} intx JavaPriority7_To_OSPriority = -1 {product} intx JavaPriority8_To_OSPriority = -1 {product} intx JavaPriority9_To_OSPriority = -1 {product} bool LIRFillDelaySlots = false {C1 pd product} uintx LargePageHeapSizeThreshold = 134217728 {product} uintx LargePageSizeInBytes = 0 {product} bool LazyBootClassLoader = true {product} intx LiveNodeCountInliningCutoff = 40000 {C2 product} bool LogCommercialFeatures = false {product} intx LoopMaxUnroll = 16 {C2 product} intx LoopOptsCount = 43 {C2 product} intx LoopUnrollLimit = 60 {C2 pd product} intx LoopUnrollMin = 4 {C2 product} bool LoopUnswitching = true {C2 product} bool ManagementServer = false {product} uintx MarkStackSize = 4194304 {product} uintx MarkStackSizeMax = 536870912 {product} uintx MarkSweepAlwaysCompactCount = 4 {product} uintx MarkSweepDeadRatio = 5 {product} intx MaxBCEAEstimateLevel = 5 {product} intx MaxBCEAEstimateSize = 150 {product} uintx MaxDirectMemorySize = 0 {product} bool MaxFDLimit = true {product} uintx MaxGCMinorPauseMillis = 4294967295 {product} uintx MaxGCPauseMillis = 4294967295 {product} uintx MaxHeapFreeRatio = 70 {manageable} uintx MaxHeapSize = 130862280 {product} intx MaxInlineLevel = 9 {product} intx MaxInlineSize = 35 {product} intx MaxJNILocalCapacity = 65536 {product} intx MaxJavaStackTraceDepth = 1024 {product} intx MaxJumpTableSize = 65000 {C2 product} intx MaxJumpTableSparseness = 5 {C2 product} intx MaxLabelRootDepth = 1100 {C2 product} intx MaxLoopPad = 15 {C2 product} uintx MaxMetaspaceExpansion = 5452592 {product} uintx MaxMetaspaceFreeRatio = 70 {product} uintx MaxMetaspaceSize = 4294967295 {product} uintx MaxNewSize = 4294967295 {product} intx MaxNodeLimit = 80000 {C2 product} uint64_t MaxRAM = 0 {pd product} uintx MaxRAMFraction = 4 {product} double MaxRAMPercentage = 25.000000 {product} intx MaxRecursiveInlineLevel = 1 {product} uintx MaxTenuringThreshold = 15 {product} intx MaxTrivialSize = 6 {product} intx MaxVectorSize = 32 {C2 product} uintx MetaspaceSize = 21810376 {pd product} bool MethodFlushing = true {product} uintx MinHeapDeltaBytes = 170392 {product} uintx MinHeapFreeRatio = 40 {manageable} intx MinInliningThreshold = 250 {product} intx MinJumpTableSize = 10 {C2 pd product} uintx MinMetaspaceExpansion = 340784 {product} uintx MinMetaspaceFreeRatio = 40 {product} uintx MinRAMFraction = 2 {product} double MinRAMPercentage = 50.000000 {product} uintx MinSurvivorRatio = 3 {product} uintx MinTLABSize = 2048 {product} intx MonitorBound = 0 {product} bool MonitorInUseLists = false {product} intx MultiArrayExpandLimit = 6 {C2 product} bool MustCallLoadClassInternal = false {product} uintx NUMAChunkResizeWeight = 20 {product} uintx NUMAInterleaveGranularity = 2097152 {product} uintx NUMAPageScanRate = 256 {product} uintx NUMASpaceResizeRate = 1073741824 {product} bool NUMAStats = false {product} ccstr NativeMemoryTracking = off {product} bool NeedsDeoptSuspend = false {pd product} bool NeverActAsServerClassMachine = false {pd product} bool NeverTenure = false {product} uintx NewRatio = 2 {product} uintx NewSize = 1363144 {product} uintx NewSizeThreadIncrease = 5320 {pd product} intx NmethodSweepActivity = 10 {product} intx NmethodSweepCheckInterval = 5 {product} intx NmethodSweepFraction = 16 {product} intx NodeLimitFudgeFactor = 2000 {C2 product} uintx NumberOfGCLogFiles = 0 {product} intx NumberOfLoopInstrToAlign = 4 {C2 product} intx ObjectAlignmentInBytes = 8 {lp64_product} uintx OldPLABSize = 1024 {product} uintx OldPLABWeight = 50 {product} uintx OldSize = 5452592 {product} bool OmitStackTraceInFastThrow = true {product}ccstrlist OnError = {product}ccstrlist OnOutOfMemoryError = {product} intx OnStackReplacePercentage = 140 {pd product} bool OptimizeFill = true {C2 product} bool OptimizePtrCompare = true {C2 product} bool OptimizeStringConcat = true {C2 product} bool OptoBundling = false {C2 pd product} intx OptoLoopAlignment = 16 {pd product} bool OptoScheduling = false {C2 pd product} uintx PLABWeight = 75 {product} bool PSChunkLargeArrays = true {product} intx ParGCArrayScanChunk = 50 {product} uintx ParGCDesiredObjsFromOverflowList = 20 {product} bool ParGCTrimOverflow = true {product} bool ParGCUseLocalOverflow = false {product} uintx ParallelGCBufferWastePct = 10 {product} uintx ParallelGCThreads = 0 {product} bool ParallelGCVerbose = false {product} uintx ParallelOldDeadWoodLimiterMean = 50 {product} uintx ParallelOldDeadWoodLimiterStdDev = 80 {product} bool ParallelRefProcBalancingEnabled = true {product} bool ParallelRefProcEnabled = false {product} bool PartialPeelAtUnsignedTests = true {C2 product} bool PartialPeelLoop = true {C2 product} intx PartialPeelNewPhiDelta = 0 {C2 product} uintx PausePadding = 1 {product} intx PerBytecodeRecompilationCutoff = 200 {product} intx PerBytecodeTrapLimit = 4 {product} intx PerMethodRecompilationCutoff = 400 {product} intx PerMethodTrapLimit = 100 {product} bool PerfAllowAtExitRegistration = false {product} bool PerfBypassFileSystemCheck = false {product} intx PerfDataMemorySize = 32768 {product} intx PerfDataSamplingInterval = 50 {product} ccstr PerfDataSaveFile = {product} bool PerfDataSaveToFile = false {product} bool PerfDisableSharedMem = false {product} intx PerfMaxStringConstLength = 1024 {product} intx PreInflateSpin = 10 {pd product} bool PreferInterpreterNativeStubs = false {pd product} intx PrefetchCopyIntervalInBytes = -1 {product} intx PrefetchFieldsAhead = -1 {product} intx PrefetchScanIntervalInBytes = -1 {product} bool PreserveAllAnnotations = false {product} bool PreserveFramePointer = false {pd product} uintx PretenureSizeThreshold = 0 {product} bool PrintAdaptiveSizePolicy = false {product} bool PrintCMSInitiationStatistics = false {product} intx PrintCMSStatistics = 0 {product} bool PrintClassHistogram = false {manageable} bool PrintClassHistogramAfterFullGC = false {manageable} bool PrintClassHistogramBeforeFullGC = false {manageable} bool PrintCodeCache = false {product} bool PrintCodeCacheOnCompilation = false {product} bool PrintCommandLineFlags = false {product} bool PrintCompilation = false {product} bool PrintConcurrentLocks = false {manageable} intx PrintFLSCensus = 0 {product} intx PrintFLSStatistics = 0 {product} bool PrintFlagsFinal = false {product} bool PrintFlagsInitial = false {product} bool PrintGC = false {manageable} bool PrintGCApplicationConcurrentTime = false {product} bool PrintGCApplicationStoppedTime = false {product} bool PrintGCCause = true {product} bool PrintGCDateStamps = false {manageable} bool PrintGCDetails = false {manageable} bool PrintGCID = false {manageable} bool PrintGCTaskTimeStamps = false {product} bool PrintGCTimeStamps = false {manageable} bool PrintHeapAtGC = false {product rw} bool PrintHeapAtGCExtended = false {product rw} bool PrintHeapAtSIGBREAK = true {product} bool PrintJNIGCStalls = false {product} bool PrintJNIResolving = false {product} bool PrintOldPLAB = false {product} bool PrintOopAddress = false {product} bool PrintPLAB = false {product} bool PrintParallelOldGCPhaseTimes = false {product} bool PrintPromotionFailure = false {product} bool PrintReferenceGC = false {product} bool PrintSafepointStatistics = false {product} intx PrintSafepointStatisticsCount = 300 {product} intx PrintSafepointStatisticsTimeout = -1 {product} bool PrintSharedArchiveAndExit = false {product} bool PrintSharedDictionary = false {product} bool PrintSharedSpaces = false {product} bool PrintStringDeduplicationStatistics = false {product} bool PrintStringTableStatistics = false {product} bool PrintTLAB = false {product} bool PrintTenuringDistribution = false {product} bool PrintTieredEvents = false {product} bool PrintVMOptions = false {product} bool PrintVMQWaitTime = false {product} bool PrintWarnings = true {product} uintx ProcessDistributionStride = 4 {product} bool ProfileInterpreter = true {pd product} bool ProfileIntervals = false {product} intx ProfileIntervalsTicks = 100 {product} intx ProfileMaturityPercentage = 20 {product} bool ProfileVM = false {product} bool ProfilerPrintByteCodeStatistics = false {product} bool ProfilerRecordPC = false {product} uintx PromotedPadding = 3 {product} uintx QueuedAllocationWarningCount = 0 {product} uintx RTMRetryCount = 5 {ARCH product} bool RangeCheckElimination = true {product} intx ReadPrefetchInstr = 0 {ARCH product} bool ReassociateInvariants = true {C2 product} bool ReduceBulkZeroing = true {C2 product} bool ReduceFieldZeroing = true {C2 product} bool ReduceInitialCardMarks = true {C2 product} bool ReduceSignalUsage = false {product} intx RefDiscoveryPolicy = 0 {product} bool ReflectionWrapResolutionErrors = true {product} bool RegisterFinalizersAtInit = true {product} bool RelaxAccessControlCheck = false {product} ccstr ReplayDataFile = {product} bool RequireSharedSpaces = false {product} uintx ReservedCodeCacheSize = 50331648 {pd product} bool ResizeOldPLAB = true {product} bool ResizePLAB = true {product} bool ResizeTLAB = true {pd product} bool RestoreMXCSROnJNICalls = false {product} bool RestrictContended = true {product} bool RewriteBytecodes = true {pd product} bool RewriteFrequentPairs = true {pd product} intx SafepointPollOffset = 256 {C1 pd product} intx SafepointSpinBeforeYield = 2000 {product} bool SafepointTimeout = false {product} intx SafepointTimeoutDelay = 10000 {product} bool ScavengeBeforeFullGC = true {product} intx SelfDestructTimer = 0 {product} uintx SharedBaseAddress = 0 {product} ccstr SharedClassListFile = {product} uintx SharedMiscCodeSize = 122880 {product} uintx SharedMiscDataSize = 4194304 {product} uintx SharedReadOnlySize = 16777216 {product} uintx SharedReadWriteSize = 16777216 {product} bool ShowMessageBoxOnError = false {product} intx SoftRefLRUPolicyMSPerMB = 1000 {product} bool SpecialEncodeISOArray = true {C2 product} bool SplitIfBlocks = true {C2 product} intx StackRedPages = 1 {pd product} intx StackShadowPages = 6 {pd product} bool StackTraceInThrowable = true {product} intx StackYellowPages = 3 {pd product} bool StartAttachListener = false {product} intx StarvationMonitorInterval = 200 {product} bool StressLdcRewrite = false {product} uintx StringDeduplicationAgeThreshold = 3 {product} uintx StringTableSize = 60013 {product} bool SuppressFatalErrorMessage = false {product} uintx SurvivorPadding = 3 {product} uintx SurvivorRatio = 8 {product} intx SuspendRetryCount = 50 {product} intx SuspendRetryDelay = 5 {product} intx SyncFlags = 0 {product} ccstr SyncKnobs = {product} intx SyncVerbose = 0 {product} uintx TLABAllocationWeight = 35 {product} uintx TLABRefillWasteFraction = 64 {product} uintx TLABSize = 0 {product} bool TLABStats = true {product} uintx TLABWasteIncrement = 4 {product} uintx TLABWasteTargetPercent = 1 {product} uintx TargetPLABWastePct = 10 {product} uintx TargetSurvivorRatio = 50 {product} uintx TenuredGenerationSizeIncrement = 20 {product} uintx TenuredGenerationSizeSupplement = 80 {product} uintx TenuredGenerationSizeSupplementDecay = 2 {product} intx ThreadPriorityPolicy = 0 {product} bool ThreadPriorityVerbose = false {product} uintx ThreadSafetyMargin = 52428800 {product} intx ThreadStackSize = 0 {pd product} uintx ThresholdTolerance = 10 {product} intx Tier0BackedgeNotifyFreqLog = 10 {product} intx Tier0InvokeNotifyFreqLog = 7 {product} intx Tier0ProfilingStartPercentage = 200 {product} intx Tier23InlineeNotifyFreqLog = 20 {product} intx Tier2BackEdgeThreshold = 0 {product} intx Tier2BackedgeNotifyFreqLog = 14 {product} intx Tier2CompileThreshold = 0 {product} intx Tier2InvokeNotifyFreqLog = 11 {product} intx Tier3BackEdgeThreshold = 60000 {product} intx Tier3BackedgeNotifyFreqLog = 13 {product} intx Tier3CompileThreshold = 2000 {product} intx Tier3DelayOff = 2 {product} intx Tier3DelayOn = 5 {product} intx Tier3InvocationThreshold = 200 {product} intx Tier3InvokeNotifyFreqLog = 10 {product} intx Tier3LoadFeedback = 5 {product} intx Tier3MinInvocationThreshold = 100 {product} intx Tier4BackEdgeThreshold = 40000 {product} intx Tier4CompileThreshold = 15000 {product} intx Tier4InvocationThreshold = 5000 {product} intx Tier4LoadFeedback = 3 {product} intx Tier4MinInvocationThreshold = 600 {product} bool TieredCompilation = true {pd product} intx TieredCompileTaskTimeout = 50 {product} intx TieredRateUpdateMaxTime = 25 {product} intx TieredRateUpdateMinTime = 1 {product} intx TieredStopAtLevel = 4 {product} bool TimeLinearScan = false {C1 product} bool TraceBiasedLocking = false {product} bool TraceClassLoading = false {product rw} bool TraceClassLoadingPreorder = false {product} bool TraceClassPaths = false {product} bool TraceClassResolution = false {product} bool TraceClassUnloading = false {product rw} bool TraceDynamicGCThreads = false {product} bool TraceGen0Time = false {product} bool TraceGen1Time = false {product} ccstr TraceJVMTI = {product} bool TraceLoaderConstraints = false {product rw} bool TraceMetadataHumongousAllocation = false {product} bool TraceMonitorInflation = false {product} bool TraceParallelOldGCTasks = false {product} intx TraceRedefineClasses = 0 {product} bool TraceSafepointCleanupTime = false {product} bool TraceSharedLookupCache = false {product} bool TraceSuspendWaitFailures = false {product} intx TrackedInitializationLimit = 50 {C2 product} bool TransmitErrorReport = false {product} bool TrapBasedNullChecks = false {pd product} bool TrapBasedRangeChecks = false {C2 pd product} intx TypeProfileArgsLimit = 2 {product} uintx TypeProfileLevel = 111 {pd product} intx TypeProfileMajorReceiverPercent = 90 {C2 product} intx TypeProfileParmsLimit = 2 {product} intx TypeProfileWidth = 2 {product} intx UnguardOnExecutionViolation = 0 {product} bool UnlinkSymbolsALot = false {product} bool Use486InstrsOnly = false {ARCH product} bool UseAES = false {product} bool UseAESIntrinsics = false {product} intx UseAVX = 99 {ARCH product} bool UseAdaptiveGCBoundary = false {product} bool UseAdaptiveGenerationSizePolicyAtMajorCollection = true {product} bool UseAdaptiveGenerationSizePolicyAtMinorCollection = true {product} bool UseAdaptiveNUMAChunkSizing = true {product} bool UseAdaptiveSizeDecayMajorGCCost = true {product} bool UseAdaptiveSizePolicy = true {product} bool UseAdaptiveSizePolicyFootprintGoal = true {product} bool UseAdaptiveSizePolicyWithSystemGC = false {product} bool UseAddressNop = false {ARCH product} bool UseAltSigs = false {product} bool UseAutoGCSelectPolicy = false {product} bool UseBMI1Instructions = false {ARCH product} bool UseBMI2Instructions = false {ARCH product} bool UseBiasedLocking = true {product} bool UseBimorphicInlining = true {C2 product} bool UseBoundThreads = true {product} bool UseCLMUL = false {ARCH product} bool UseCMSBestFit = true {product} bool UseCMSCollectionPassing = true {product} bool UseCMSCompactAtFullCollection = true {product} bool UseCMSInitiatingOccupancyOnly = false {product} bool UseCRC32Intrinsics = false {product} bool UseCodeCacheFlushing = true {product} bool UseCompiler = true {product} bool UseCompilerSafepoints = true {product} bool UseCompressedClassPointers = false {lp64_product} bool UseCompressedOops = false {lp64_product} bool UseConcMarkSweepGC = false {product} bool UseCondCardMark = false {C2 product} bool UseCountLeadingZerosInstruction = false {ARCH product} bool UseCountTrailingZerosInstruction = false {ARCH product} bool UseCountedLoopSafepoints = false {C2 product} bool UseCounterDecay = true {product} bool UseDivMod = true {C2 product} bool UseDynamicNumberOfGCThreads = false {product} bool UseFPUForSpilling = false {C2 product} bool UseFastAccessorMethods = true {product} bool UseFastEmptyMethods = true {product} bool UseFastJNIAccessors = true {product} bool UseFastStosb = false {ARCH product} bool UseG1GC = false {product} bool UseGCLogFileRotation = false {product} bool UseGCOverheadLimit = true {product} bool UseGCTaskAffinity = false {product} bool UseHeavyMonitors = false {product} bool UseInlineCaches = true {product} bool UseInterpreter = true {product} bool UseJumpTables = true {C2 product} bool UseLWPSynchronization = true {product} bool UseLargePages = false {pd product} bool UseLargePagesInMetaspace = false {product} bool UseLargePagesIndividualAllocation := false {pd product} bool UseLockedTracing = false {product} bool UseLoopCounter = true {product} bool UseLoopInvariantCodeMotion = true {C1 product} bool UseLoopPredicate = true {C2 product} bool UseMathExactIntrinsics = true {C2 product} bool UseMaximumCompactionOnSystemGC = true {product} bool UseMembar = false {pd product} bool UseMontgomeryMultiplyIntrinsic = false {C2 product} bool UseMontgomerySquareIntrinsic = false {C2 product} bool UseMulAddIntrinsic = false {C2 product} bool UseMultiplyToLenIntrinsic = false {C2 product} bool UseNUMA = false {product} bool UseNUMAInterleaving = false {product} bool UseNewLongLShift = false {ARCH product} bool UseOSErrorReporting = false {pd product} bool UseOldInlining = true {C2 product} bool UseOnStackReplacement = true {pd product} bool UseOnlyInlinedBimorphic = true {C2 product} bool UseOptoBiasInlining = true {C2 product} bool UsePSAdaptiveSurvivorSizePolicy = true {product} bool UseParNewGC = false {product} bool UseParallelGC = false {product} bool UseParallelOldGC = false {product} bool UsePerfData = true {product} bool UsePopCountInstruction = false {product} bool UseRDPCForConstantTableBase = false {C2 product} bool UseRTMDeopt = false {ARCH product} bool UseRTMLocking = false {ARCH product} bool UseSHA = false {product} bool UseSHA1Intrinsics = false {product} bool UseSHA256Intrinsics = false {product} bool UseSHA512Intrinsics = false {product} intx UseSSE = 99 {product} bool UseSSE42Intrinsics = false {product} bool UseSerialGC = false {product} bool UseSharedSpaces = true {product} bool UseSignalChaining = true {product} bool UseSquareToLenIntrinsic = false {C2 product} bool UseStoreImmI16 = true {ARCH product} bool UseStringDeduplication = false {product} bool UseSuperWord = true {C2 product} bool UseTLAB = true {pd product} bool UseThreadPriorities = true {pd product} bool UseTypeProfile = true {product} bool UseTypeSpeculation = true {C2 product} bool UseUTCFileTimestamp = true {product} bool UseUnalignedLoadStores = false {ARCH product} bool UseVMInterruptibleIO = false {product} bool UseXMMForArrayCopy = false {product} bool UseXmmI2D = false {ARCH product} bool UseXmmI2F = false {ARCH product} bool UseXmmLoadAndClearUpper = true {ARCH product} bool UseXmmRegToRegMoveAll = false {ARCH product} bool VMThreadHintNoPreempt = false {product} intx VMThreadPriority = -1 {product} intx VMThreadStackSize = 0 {pd product} intx ValueMapInitialSize = 11 {C1 product} intx ValueMapMaxLoopSize = 8 {C1 product} intx ValueSearchLimit = 1000 {C2 product} bool VerifyMergedCPBytecodes = true {product} bool VerifySharedSpaces = false {product} intx WorkAroundNPTLTimedWaitHang = 1 {product} uintx YoungGenerationSizeIncrement = 20 {product} uintx YoungGenerationSizeSupplement = 80 {product} uintx YoungGenerationSizeSupplementDecay = 8 {product} uintx YoungPLABSize = 4096 {product} bool ZeroTLAB = false {product} intx hashCode = 5 {product}","link":"/2019/10/13/Java/JVM%E5%8F%82%E6%95%B0/"},{"title":"MacOS Pythonè·å–ç³»ç»Ÿç‰ˆæœ¬ä¸å¯¹","text":"èƒŒæ™¯ä»Šå¤©é‡åˆ°ä¸ªå¥‡æ€ªçš„é—®é¢˜ï¼Œåœ¨condaå®‰è£…è½¯ä»¶ï¼Œä¸èƒ½è‡ªåŠ¨è·å–æœ€æ–°çš„ç‰ˆæœ¬ï¼ŒæŸ¥çœ‹äº†ä¸€ä¸‹infoï¼Œå‘ç°é‡Œé¢è·å–çš„ç³»ç»Ÿç‰ˆæœ¬ä¸å¯¹ï¼Œå¼€å§‹æ€€ç–‘æ˜¯è¿™ä¸ªç‰ˆæœ¬çš„é—®é¢˜ï¼Œä½†æ˜¯åœ¨deactive condaä¹‹åï¼Œè·å–çš„ç‰ˆæœ¬æ˜¯æ­£ç¡®çš„ 1conda info æ˜¾ç¤ºé”™è¯¯çš„ç‰ˆæœ¬åœ¨condaå¤–é¢æ‰“å°ç‰ˆæœ¬ï¼Œæ˜¯âœ…çš„äºæ˜¯ä»£ç æŸ¥çœ‹äº†ä¸€ä¸‹ï¼ŒPython æºç  123456789101112131415161718def mac_ver(release='', versioninfo=('', '', ''), machine=''): \"\"\" Get macOS version information and return it as tuple (release, versioninfo, machine) with versioninfo being a tuple (version, dev_stage, non_release_version). Entries which cannot be determined are set to the parameter values which default to ''. All tuple entries are strings. \"\"\" # First try reading the information from an XML file which should # always be present info = _mac_ver_xml() if info is not None: return info # If that also doesn't work return the default values return release, versioninfo, machine å…¶å®å°±æ˜¯è¯»å–çš„ /System/Library/CoreServices/SystemVersion.plist 1234567891011121314151617181920212223242526def _mac_ver_xml(): fn = '/System/Library/CoreServices/SystemVersion.plist' if not os.path.exists(fn): if 'SDKROOT' in os.environ: fn = os.environ['SDKROOT'] + fn if not os.path.exists(fn): return None else: return None try: import plistlib except ImportError: return None with open(fn, 'rb') as f: pl = plistlib.load(f) release = pl['ProductVersion'] versioninfo = ('', '', '') machine = os.uname().machine if machine in ('ppc', 'Power Macintosh'): # Canonical name machine = 'PowerPC' return release, versioninfo, machine å¯¹æ¯”äº†2ä¸ªç¯å¢ƒçš„SystemVersion.plistï¼Œå°±æ˜¯åŒä¸€ä¸ªï¼Œcat å‡ºæ¥çš„ç‰ˆæœ¬ä¸ä¸€æ ·conda deactive 123456789101112131415161718&lt;?xml version=\"1.0\" encoding=\"UTF-8\"?&gt;&lt;!DOCTYPE plist PUBLIC \"-//Apple//DTD PLIST 1.0//EN\" \"http://www.apple.com/DTDs/PropertyList-1.0.dtd\"&gt;&lt;plist version=\"1.0\"&gt;&lt;dict&gt; &lt;key&gt;ProductBuildVersion&lt;/key&gt; &lt;string&gt;22C65&lt;/string&gt; &lt;key&gt;ProductCopyright&lt;/key&gt; &lt;string&gt;1983-2022 Apple Inc.&lt;/string&gt; &lt;key&gt;ProductName&lt;/key&gt; &lt;string&gt;macOS&lt;/string&gt; &lt;key&gt;ProductUserVisibleVersion&lt;/key&gt; &lt;string&gt;13.1&lt;/string&gt; &lt;key&gt;ProductVersion&lt;/key&gt; &lt;string&gt;13.1&lt;/string&gt; &lt;key&gt;iOSSupportVersion&lt;/key&gt; &lt;string&gt;16.2&lt;/string&gt;&lt;/dict&gt;&lt;/plist&gt; conda active 123456789101112131415161718&lt;?xml version=\"1.0\" encoding=\"UTF-8\"?&gt;&lt;!DOCTYPE plist PUBLIC \"-//Apple//DTD PLIST 1.0//EN\" \"http://www.apple.com/DTDs/PropertyList-1.0.dtd\"&gt;&lt;plist version=\"1.0\"&gt;&lt;dict&gt; &lt;key&gt;ProductBuildVersion&lt;/key&gt; &lt;string&gt;22C65&lt;/string&gt; &lt;key&gt;ProductCopyright&lt;/key&gt; &lt;string&gt;1983-2022 Apple Inc.&lt;/string&gt; &lt;key&gt;ProductName&lt;/key&gt; &lt;string&gt;Mac OS X&lt;/string&gt; &lt;key&gt;ProductUserVisibleVersion&lt;/key&gt; &lt;string&gt;10.16&lt;/string&gt; &lt;key&gt;ProductVersion&lt;/key&gt; &lt;string&gt;10.16&lt;/string&gt; &lt;key&gt;iOSSupportVersion&lt;/key&gt; &lt;string&gt;16.2&lt;/string&gt;&lt;/dict&gt;&lt;/plist&gt; éƒ½æ˜¯catçš„åŒä¸€ä¸ªè·¯å¾„æ–‡ä»¶ï¼Œæœ‰ç‚¹ä¸ç†è§£äº†ï¼Œéƒ½æ˜¯åŒä¸€ä¸ªæ–‡ä»¶ï¼Œä¸ºå•¥catå‡ºæ¥çš„å†…å®¹ä¸ä¸€æ ·ï¼Ÿç®€ç›´åç§‘å­¦ åŒä¸€ä¸ªæ–‡ä»¶å†…å®¹ä¸ä¸€æ ·ï¼Ÿç½‘ä¸ŠæŸ¥äº†ä¸‹https://stackoverflow.com/questions/69097567/macos-version-returned-as-10-16-instead-of-12-0https://eclecticlight.co/2020/08/13/macos-version-numbering-isnt-so-simple/å¤§è‡´æ˜¯mac osè€ƒè™‘åˆ°ï¼Œå…¼å®¹æ€§ï¼Œåœ¨opençš„æ—¶å€™ï¼Œhookæ‰äº†SystemVersion.plistï¼ŒæŒ‡å‘äº† SystemVersionCompat.plisï¼ŒåŒæ—¶ç•™ç»™äº†ä¸€ä¸ªå¼€å…³ç»™æˆ‘ä»¬æ§åˆ¶ï¼Œé‚£å°±æ˜¯ç¯å¢ƒå˜é‡SYSTEM_VERSION_COMPAT è§£å†³åŠæ³•æ§åˆ¶ç¯å¢ƒå˜é‡ 1export SYSTEM_VERSION_COMPAT = 0","link":"/2023/05/14/%E9%97%AE%E9%A2%98%E4%B8%8E%E7%BB%8F%E9%AA%8C/conda_macos_ver_python/"},{"title":"æ³›å‹çš„ååºåˆ—åŒ–","text":"ç®€åŒ–é—®é¢˜æ—¥å¸¸ä½¿ç”¨è¿‡ç¨‹ä¸­ï¼Œæˆ‘ä»¬ç»å¸¸ç¢°åˆ°æ³›å‹çš„åºåˆ—åŒ–Jsonï¼Œä½†æ˜¯æœ‰æ—¶å€™æˆ‘ä»¬éœ€è¦æŠŠä¸€ä¸ªJsonååºåˆ—åŒ–æˆä¸€ä¸ªæ³›å‹å¯¹è±¡ï¼Œæ€ä¹ˆåšï¼Œä½ å¯èƒ½ä¼šæƒ³åˆ°è¿™æ ·åšï¼Œä¾‹å¦‚åœ¨Gsonä¸­ 1Gson().fromJson&lt;List&lt;String&gt;&gt;(JsonString, List&lt;String&gt;::class.java) ä½†æ˜¯ä½ è¿™æ ·å†™ï¼Œå…¶å®ä¼šé‡åˆ°ä¸€ä¸ªé”™è¯¯ ** Only classes are allowed on the left hand side of a class literal**ä¸ºä»€ä¹ˆä¼šè¿™æ ·ï¼Œå› ä¸ºæ³›å‹æœ‰ç±»å‹æ“¦é™¤ï¼Œæ³›å‹å…¶å®åªæ˜¯åœ¨ç¼–è¯‘çš„å­˜åœ¨ï¼Œè¿è¡Œçš„æ—¶å€™æ˜¯ä¸å­˜åœ¨çš„ï¼Œè€Œååºåˆ—åŒ–éœ€è¦å†è¿è¡Œçš„æ—¶å€™è·å–åˆ°å…·ä½“çš„ç±»å‹ï¼Œè€Œç±»å‹å´è¢«æ“¦é™¤äº†ï¼Œæ‰€ä»¥ä¼šæŠ¥é”™ï¼Œé‚£ä¹ˆæ€ä¹ˆåŠï¼Ÿ æ³›å‹æ€ä¹ˆååºåˆ—åŒ–æˆå¯¹è±¡ï¼Ÿçœ‹å‡½æ•°çš„å‚æ•°ç±»å‹ 12345678910111213141516//è¿™é‡Œè¦çš„æ˜¯ä¸ªclasspublic &lt;T&gt; T fromJson(String json, Class&lt;T&gt; classOfT) throws JsonSyntaxException { // éƒ½è½¬æˆåˆ°è¿™é‡Œ T object = fromJson(json, TypeToken.get(classOfT)); return Primitives.wrap(classOfT).cast(object); }// å…¶å®éœ€è¦çš„æ˜¯ä¸€ä¸ªTypeTokenpublic &lt;T&gt; T fromJson(String json, TypeToken&lt;T&gt; typeOfT) throws JsonSyntaxException { if (json == null) { return null; } StringReader reader = new StringReader(json); return fromJson(reader, typeOfT); } TypeTokenå®é™…ä¸Šæ˜¯ç§æœ‰çš„ 123456789101112131415public class TypeToken&lt;T&gt; { @SuppressWarnings(\"unchecked\") protected TypeToken() { this.type = getTypeTokenTypeArgument(); this.rawType = (Class&lt;? super T&gt;) $Gson$Types.getRawType(type); this.hashCode = type.hashCode(); } @SuppressWarnings(\"unchecked\") private TypeToken(Type type) { this.type = $Gson$Types.canonicalize(Objects.requireNonNull(type)); this.rawType = (Class&lt;? super T&gt;) $Gson$Types.getRawType(this.type); this.hashCode = this.type.hashCode(); }} æˆ‘ä»¬å¯ä»¥é€šè¿‡æ„é€ Typeæ¥è¾¾åˆ°ç›®çš„, ä½†æ˜¯è¿™ä¸ªTypeæ˜¯æ¥å£ï¼Œæˆ‘ä»¬éœ€è¦æ„é€ ParameterizedType 123public &lt;T&gt; T fromJson(String json, Type typeOfT) throws JsonSyntaxException { return (T) fromJson(json, TypeToken.get(typeOfT));} 1234567891011fun main(args: Array&lt;String&gt;) { Gson().fromJson&lt;List&lt;String&gt;&gt;(\"JsonString\", getType(List::class.java, String::class.java))}fun getType(raw: Class&lt;*&gt;, vararg args: Type) = object : ParameterizedType { //åŸå§‹ç±»å‹ï¼Œä¾‹å¦‚List&lt;String&gt;ï¼Œæ•´ä½“çœ‹æ¥å°±æ˜¯List override fun getRawType(): Type = raw // æ³›å‹ å‚æ•°ï¼Œä¾‹å¦‚æœ‰å¤šä¸ª override fun getActualTypeArguments(): Array&lt;out Type&gt; = args //é¡¶å±‚ç±»å°±æ˜¯nullï¼ŒType å¯¹è±¡ï¼Œè¡¨ç¤ºæ­¤ç±»å‹æ˜¯å…¶æˆå‘˜ä¹‹ä¸€çš„ç±»å‹ï¼Œä¾‹å¦‚Mapæ¥å£å°±æ˜¯Map.Entryçš„OwnerType. override fun getOwnerType(): Type? = null} å¦‚æœæœ‰å¤šé‡æ³›å‹æ€ä¹ˆå†™ï¼ŒgetTypeå¯ä»¥åµŒå¥—è°ƒç”¨çš„ï¼Œé€šè¿‡Typeæ„æˆType 12//List&lt;List&lt;String&gt;&gt;getType(List::class.java, getType(List::class.java, String::class.java))","link":"/2023/05/14/%E9%97%AE%E9%A2%98%E4%B8%8E%E7%BB%8F%E9%AA%8C/typetojson/"},{"title":"è§£å†³ Compose Layout Inspector ä¸èƒ½ç”¨","text":"é”™è¯¯ä¿¡æ¯å½“ä½ è¾›è‹¦å†™å®Œä¸€ä¸ªé¡µé¢ï¼Œæ‰“å¼€Layout Inspector å‘ç°ä¸èƒ½ä½¿ç”¨ 123Could not download androidx.compose.ui:ui:1.5.0-alphao1 from maven.google.com. Check the internet connection. For offline repositories (not common) please specify -Dappinspection.use.dev.jar=true as a custom VM property. è§£å†³åŠæ³•ï¼š æ‰“å¼€Help-&gt;Edit Custom VM Options æ·»åŠ å‚æ•°-Dappinspection.use.dev.jar=true å¦‚æœä½ åªåšè¿™ä¸€æ­¥ï¼Œä½ ä¼šå‘ç°ä¼šæŠ¥å¦ä¸€ä¸ªé”™è¯¯ï¼Œæç¤ºæ‰¾ä¸åˆ°compose-ui-inspection.jarï¼Œæ‰€ä»¥æˆ‘ä»¬ç»§ç»­å¾€ä¸‹ä¿®æ”¹ æ‰¾åˆ° grade androidx.compose.ui çš„ç›®å½•ï¼Œä¾‹å¦‚å¯ä»¥åœ¨AndroidStudioçš„ä¾èµ–é‡Œé¢çœ‹åˆ° å¹¶æ‰“å¼€ç›®å½• æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ä¸€ä¸ªinspector.jarçš„æ–‡ä»¶ å°†inspector.jaå¤åˆ¶åˆ°compose.jar å¤åˆ¶åˆ°ASçš„å®‰è£…ç›®å½•ä¸‹çš„ï¼Œä¾‹å¦‚macosä¸‹çš„ï¼ŒApplications/Android Studio.app/Contents/plugins/android/resourcesç›®å½•ï¼Œå¹¶é‡å‘½åä¸ºcompose-ui-inspection.jar é‡å¯ä¸€ä¸‹Android Studio","link":"/2023/08/12/Android/compose_inspector/"},{"title":"Kotlinçš„å˜é‡é‡åé—®é¢˜","text":"é—®é¢˜èƒŒæ™¯ä»¥ä¸‹æ˜¯ä¸€ä¸ªç®€åŒ–çš„é—®é¢˜ï¼Œå¯ä»¥æ€è€ƒä¸€ä¸‹ï¼Œä»¥ä¸‹ä»£ç ä¼šå‡ºç°ä»€ä¹ˆé—®é¢˜ 12345678910111213interface Student { fun getName(): String}class Main : Student { private val name by lazy { \"name\" } override fun getName() = name}//æµ‹è¯•ï¼Œä¾‹å¦‚æˆ‘è¦è¿™æ ·è°ƒç”¨fun main() { println(Main().getName())} å®é™…ä¸Šï¼Œä¸Šé¢çš„ä»£ç åœ¨IDEä¸­ï¼Œå¹¶æ²¡æœ‰ä»»ä½•æç¤ºå’ŒæŠ¥é”™ä¿¡æ¯ï¼Œåªæœ‰åœ¨ç¼–è¯‘çš„æ—¶å€™æ‰ä¼šå‡ºç°å¦‚ä¸‹é”™è¯¯ï¼Œ 123Platform declaration clash: The following declarations have the same JVM signature (getName()Ljava/lang/String;): fun `&lt;get-name&gt;`(): String defined in Main fun getName(): String defined in Main å¤§æ„æ˜¯è¯´ï¼Œ2ä¸ªæ–¹æ³•åé‡å¤äº†ï¼Œä¸ºä»€ä¹ˆå‘¢ï¼Ÿ è§£æƒ‘Kotlinä¸Javaä¸åŒçš„ä¹‹ä¸€ï¼Œå°±æ˜¯Kotlinä¼šé»˜è®¤ç»™å˜é‡æ·»åŠ getå’Œsetæ–¹æ³•ï¼Œé»˜è®¤çš„è§„åˆ™ä¹Ÿæ˜¯å˜é‡åå‰é¢ç›´æ¥æ·»åŠ getæˆ–setï¼Œå¦‚æœæˆ‘ä»¬åœ¨æ˜¾ç¤ºçš„å†™äº†ä¸€ä¸ªæ–¹æ³•åç›¸åŒçš„å‡½æ•°ï¼Œå°±æœ‰å¯èƒ½å‡ºç°æ–¹æ³•ç­¾åå†²çªï¼Œæ‰€ä»¥ä¸Šé¢çš„æƒ…å†µå°±å‡ºç°äº†æ–¹æ³•åçš„å†²çªã€‚å¦‚æœæˆ‘ä»¬å»æ‰æ˜¾ç¤ºå†™çš„getName()ï¼Œå¯ä»¥çœ‹åˆ°ç”Ÿæˆçš„å‡½æ•° 12345678public final class Main { private final Lazy name$delegate; //è¿™ä¸ª getå‡½æ•°æ˜¯è‡ªåŠ¨ç”Ÿæˆçš„ private final String getName() { Lazy var1 = this.name$delegate; return (String)var1.getValue(); }} è§£å†³åŠæ³•æ—¢ç„¶æˆ‘ä»¬å®šä½åˆ°äº†é—®é¢˜çš„åŸå› ï¼Œé‚£æˆ‘ä»¬é‡æ–°ç»™è‡ªå·±çš„å†™çš„å‡½æ•°å‘½åä¸€ä¸‹ï¼Œæ˜¯ä¸æ˜¯å°±å¯ä»¥äº†ï¼Ÿè¿™ç§æ–¹æ³•æ˜¯å¯ä»¥çš„ï¼Œä½†æ˜¯ä¸å¤Ÿä¼˜é›…ï¼Œå…¶å®Kotlinç»™æˆ‘æä¾›äº†ä¸€ä¸‹æ–¹æ³•ï¼Œå»å¤„ç†è¿™ç§æƒ…å†µã€‚ æµ‹è¯•æ–¹æ³•ä¸€ï¼š@JvmName æŒ‡å®šç”Ÿæˆçš„å‡½æ•°å@JvmName æ³¨è§£æ˜¯ Kotlin æä¾›çš„ä¸€ä¸ªç”¨äºæŒ‡å®šåœ¨ç¼–è¯‘ä¸º Java å­—èŠ‚ç æ—¶ç”Ÿæˆçš„ Java ç±»æˆ–æ–¹æ³•åç§°çš„æ³¨è§£ã€‚å®ƒå…è®¸ä½ åœ¨ Kotlin ä»£ç ä¸­ä¸ºç‰¹å®šçš„å…ƒç´ æŒ‡å®šä¸€ä¸ªä¸åŒäºé»˜è®¤ç”Ÿæˆçš„ Java åç§°ã€‚ä½†æ˜¯ï¼Œåœ¨ä¸Šé¢çš„ä»£ç ä¸­ï¼Œä½ ä¼šé‡åˆ°é”™è¯¯ã€‚ 1This annotation is not applicable to target 'member property with delegate' å› ä¸ºæˆ‘ä»¬ç”¨äº†Lazyä»£ç†ï¼Œæˆ‘ä»¬éœ€è¦ç”¨ @get:JvmName(â€œnameâ€) æ¥å¤„ç†è¿™ç§æƒ…å†µã€‚ æµ‹è¯•æ–¹æ³•äºŒï¼š @JvmField\u0000@JvmField æ˜¯ Kotlin æä¾›çš„ä¸€ä¸ªæ³¨è§£ï¼Œç”¨äºå°†å±æ€§æš´éœ²ä¸ºå…¬å…±çš„ Java å­—æ®µï¼Œè€Œä¸æ˜¯ç”Ÿæˆ getter å’Œ setter æ–¹æ³•ã€‚\u0000æ˜¯ä¸æ˜¯è¿™æ ·å°±å¯ä»¥äº†ï¼Ÿå…¶å®ä¹Ÿä¼šé‡åˆ°ä¸€ä¸ªé”™è¯¯ï¼Œå°±æ˜¯è¿™é‡Œä½¿ç”¨äº†ä»£ç†ç±»ï¼Œä»£ç†ç±»å®é™…ä¸Šæ˜¯ç”Ÿæˆäº†å‡½æ•°ï¼Œé€šè¿‡å‡½æ•°ä¸­è½¬çš„ï¼Œjavaå¹¶ä¸ä¼šæœ‰ä¸€ä¸ªåŒåField, è€Œæ˜¯ä¸€ä¸ªLazy name$delegate;å¦‚æœæ˜¯æ™®é€šçš„å±æ€§ï¼Œè¿™ä¸ªæ³¨è§£æ˜¯å¯ä»¥çš„ã€‚ 1JvmField cannot be applied to delegated property è¿™ä¸ªé—®é¢˜çš„æœ¬è´¨æ˜¯Kotliné»˜è®¤ç”Ÿæˆäº†getæ–¹æ³•ï¼Œé‚£Kotlinå°±ä¸èƒ½é»˜è®¤ä¸ç”Ÿæˆgetæ–¹æ³•å—ï¼Ÿå…¶å®å¯¹ä¸€ä¸ªæ™®é€šfinal feildæ˜¯æ²¡æœ‰ç”Ÿæˆgetå’Œsetï¼Œæ˜¯ç›´æ¥è®¿é—®å˜é‡çš„ï¼Œè‡ªåŠ¨ç”Ÿæˆgetä¸ªset å¸¸è§çš„æ˜¯varç±»å‹ æ–¹æ³•ä¸‰ï¼šå¯ä»¥æ·»åŠ å‰ç¼€_æ·»åŠ å‰ç¼€çš„æ–¹æ³•ï¼Œæœ¬è´¨æ˜¯è®©ï¼Œå˜é‡ä¸åŒåï¼Œä½†æ˜¯ä»£ç å¯è¯»æ€§æ²¡æœ‰æ”¹å˜ï¼Œä¸ªäººè®¤ä¸ºæ˜¯æ¯”è¾ƒä¼˜é›…çš„ä¸€ç§æ–¹å¼ã€‚@get:JvmName(â€œnameâ€) æ˜¾å¾—æ·»åŠ çš„ä¿¡æ¯æ›´å¤šï¼Œæ›´æ‰“æ‰°é˜…è¯»ã€‚","link":"/2023/11/07/Android/kotlin_name_dup/"},{"title":"å°å¿ƒKotlinä¸‹çš„æ„é€ å‡½æ•°NoSuchMethodException","text":"é—®é¢˜èƒŒæ™¯è¿‘æœŸå¼€å‘è¿‡ç¨‹ä¸­ï¼Œè¸©äº†ä¸€ä¸ªå‘, åªåœ¨releaseåŒ…ä¸‹ç¨³å®šå¤ç°ï¼Œæœ¬åœ°debugåŒ… æ²¡æœ‰å‡ºç°é—®é¢˜ã€‚ 123Exception in thread \"main\" java.lang.NoSuchMethodException: a.x.&lt;init&gt;(s.x,s.e)at java.base/java.lang.Class.getConstructor0(Class.java:3585)at java.base/java.lang.Class.getDeclaredConstructor(Class.java:2754) é€šè¿‡è§£æ··æ·†ï¼Œå®šä½æºä»£ç ï¼Œå’Œç»“åˆmappingæ–‡ä»¶ï¼Œè§£åŒ…çœ‹çœ‹æºä»£ç ï¼Œç¡®å®æ˜¯å°‘äº†ç›®æ ‡å‡½æ•° æ–¹æ³•ä¸ºä»€ä¹ˆä¼šæ¶ˆå¤±ï¼Ÿåœ¨ Android å¼€å‘ä¸­ï¼Œé€šå¸¸ä½¿ç”¨ ProGuard æ¥è¿›è¡Œä»£ç æ··æ·†å’Œå‹ç¼©ï¼Œä»¥å‡å°‘åº”ç”¨ç¨‹åºçš„ä»£ç å¤§å°å’Œé˜²æ­¢é€†å‘å·¥ç¨‹, ProGuardä¼šç§»é™¤ä¸€ä¸‹æ²¡æœ‰å¼•ç”¨åˆ°çš„æ–¹æ³•å’Œå­—æ®µï¼Œå¦‚æœæˆ‘ä»¬è¦é€šè¿‡å…¶ä»–æ–¹å¼ä½¿ç”¨ï¼Œéœ€è¦å¯¹ProGuardå£°æ˜ä¿ç•™æŸä¸€äº›å­—æ®µã€‚æ ¹æ®ç»éªŒï¼ŒdebugåŒ…å’ŒreleaseåŒ… çš„å¤§å¤šæ•°é—®é¢˜éƒ½æ˜¯æ··æ·†å¼•èµ·çš„ã€‚é€šè¿‡åå°„æ„å»ºå¯¹è±¡çš„æ—¶å€™ï¼Œç±»çš„æ„é€ å‡½æ•°ä¹Ÿæ˜¯éœ€è¦å£°æ˜keepçš„éœ€è¦å°å¿ƒï¼ŒKotlinçš„ ç›´æ¥æ¥åœ¨ç±»åé¢çš„å¤Ÿç€å‡½æ•°ï¼Œæ˜¯æ²¡æœ‰ç½®ç°æç¤ºçš„ï¼Œå¾ˆå®¹æ˜“æ¼æ‰ï¼Œå¦‚æœæ˜¯ç›´æ¥å£°æ˜çš„æ„é€ å‡½æ•°ï¼Œ è§£å†³åŠæ³•è¦ä¹ˆå¯¹æ¯ä¸ªç±»æ·»åŠ @Keepæ³¨è§£ï¼Œæˆ–è€…æ·»åŠ åŒ…çš„è§„åˆ™ã€‚ 12#å¯¹åŒ…ä¸‹com.test.pkgnameåŒ…ä¸‹çš„ç±»ä¿ç•™æ„é€ å‡½æ•°-keepclassmembers class com.test.pkgname.** { &lt;init&gt;(...)}","link":"/2023/10/14/Android/kotlin_android_init_no_method/"},{"title":"Androidé¡¹ç›®æ¥å…¥Rust","text":"èƒŒæ™¯æœ¬æ¬¡è®¨è®ºåœ¨å·²æœ‰çš„å®‰å“é¡¹ç›®å·¥ç¨‹ä¸­é…ç½®rustçš„æ–¹æ³•ï¼ŒåŒæ—¶è®°å½•ä¸€ä¸‹è¸©å‘è¿‡ç¨‹ï¼Œé¦–å…ˆæœ¬åœ°pcç«¯é…ç½®å¥½rustçš„å¼€å‘ç¯å¢ƒï¼Œé…ç½®rustçš„è¿‡ç¨‹å°±é»˜è®¤ä½ ä¼šäº†ã€‚ é¡¹ç›®é…ç½® é¡¹ç›®ç»“æ„åœ¨å·²æœ‰çš„é¡¹ç›®ï¼Œæˆ‘ä»¬æ¨èæ–°å»ºä¸€ä¸ªmoduleï¼Œè¿™é‡Œä¸éœ€è¦native moduleï¼Œå°±æ˜¯æ™®é€šçš„java moduleã€‚ æˆ‘ä»¬æŠŠrustå·¥ç¨‹å¯ä»¥æ”¾åˆ°moduleå¹³çº§ç›®å½•ï¼Œæˆ–moduleä¸‹é¢éƒ½æ˜¯å¯ä»¥çš„ã€‚ æˆ‘ä»¬æŠŠæ‰€æœ‰rustç›¸å…³çš„ä»£ç ï¼Œå…¨éƒ¨æ”¾åˆ°rustsdkå·¥ç¨‹ç›®å½•ï¼Œå¯ä»¥å•ç‹¬æ‰“å¼€ï¼Œå•ç‹¬æˆä»“åº“ï¼Œå•ç‹¬ç»´æŠ¤ã€‚å’Œè¿™ä¸ªrustç›¸å…³çš„æ¡¥æ¥å±‚ï¼Œæˆ‘ä»¬å…¨éƒ¨æ”¾åœ¨æœ¬åœ°çš„java moduleé‡Œé¢ã€‚ é¡¹ç›®æ ¹gradeé…ç½®ä¸»è¦çš„æ€è·¯æ˜¯å‚è€ƒhttps://github.com/mozilla/rust-android-gradleç°åœ¨é¡¹ç›®çš„è·Ÿç›®å½•ä¸‹é…ç½®rust-android-gradleï¼Œå…·ä½“çš„ç‰ˆæœ¬ï¼Œå¯ä»¥å‚è€ƒgithubä¸Šæœ€æ–°çš„ 12345678910buildscript { repositories { maven { url \"https://plugins.gradle.org/m2/\" } } dependencies { classpath \"org.mozilla.rust-android-gradle:plugin:0.9.3\" }} \u0000 module gradleé…ç½®å…ˆç»™æ¨¡å—æ·»åŠ æ’ä»¶ï¼Œ 1apply plugin: \"org.mozilla.rust-android-gradle.rust-android\" ç„¶åä¸»è¦çš„å°±æ˜¯é…ç½®cargoè¿™ä¸ªdslï¼Œå…·ä½“çš„å‚æ•°è¡¨æ„å¯ä»¥åœ¨githubä¸Šé¢çœ‹\u0000éœ€è¦ä¸»è¦çš„æ˜¯ï¼Œmodlue ç›´åˆ° sdkçš„ç›®å½•ï¼ŒåŒ…å«Cargo.tomlçš„ä½ç½®ï¼Œlibnameéœ€è¦å’ŒCargo.tomlæ–‡ä»¶é‡Œé¢æŒ‡å®šçš„ä¸€è‡´ï¼Œå…¶å®ƒæŒ‰éœ€é…ç½®å³å¯ã€‚æŒ‰éœ€è¦æ·»åŠ äº¤å‰ç¼–è¯‘å™¨ 12rustup target add armv7-linux-androideabi # for armrustup target add aarch64-linux-android # for arm64 å¯é€‰ï¼Œæ¯æ¬¡ç¼–è¯‘çš„æ—¶å€™ï¼Œè§¦å‘ä¸€æ¬¡rustçš„ç¼–è¯‘ 12345tasks.configureEach { task -&gt; if ((task.name == 'javaPreCompileDebug' || task.name == 'javaPreCompileRelease')) { task.dependsOn 'cargoBuild' }} æˆ–è€…é¡¹ç›®ç›®å½•ä¸‹ï¼Œæ‰‹åŠ¨ 1./gradlew cargoBuild --stacktrace --info ä¸Šé¢åŸºæœ¬å®‰å“é¡¹ç›®é‡Œé¢å°±é…ç½®å®Œäº†ã€‚ä¸‹é¢å±•ç¤ºä¸€ä¸ªè°ƒç”¨ç¤ºä¾‹, javaè°ƒä¸€ä¸‹rustã€‚ 1234567package com.example.mylibrary;public class Tools { static { System.loadLibrary(\"rust_sdk\"); } public native int addNum(int num1,int num2,);} Rust SDKé…ç½® Cargo.tomlé…ç½®1234567891011121314151617[package]name = \"rust_sdk\"version = \"0.1.0\"[dependencies]log = \"0.4.14\"jni-sys = \"0.3.0\"jni = \"0.21.1\"#å¯é€‰ï¼ŒæŒ‡å®šandroidä¸‹æ‰æ·»åŠ ä¾èµ–[target.'cfg(target_os = \"android\")'.dependencies]#ndk = { version = \"0.8.0\" }[lib]crate_type = [\"dylib\"]#æŒ‡å®šæºç æ–‡ä»¶path = \"src/lib.rs\" lib.rs123456789101112extern crate jni;extern crate jni_sys;use jni::JNIEnv;use jni::objects::JClass;use jni_sys::jint;#[allow(non_snake_case)]#[no_mangle]pub unsafe extern fn Java_com_example_mylibrary_Tools_addNum(_env: JNIEnv, _: JClass, numa: jint, numb: jint) -&gt; jint { numb + numa} ç„¶åï¼Œåœ¨Android Studioé‡Œé¢ç¼–è¯‘appè°ƒç”¨è¿™ä¸ªæ–¹æ³•å°±okäº†ã€‚è¿™é‡Œä¼šæœ‰ç›®æ ‡soï¼Œå¯ä»¥ç”¨æ£€æŸ¥ä¸€ä¸‹å¯¼å‡ºå‡½æ•°ã€‚ æˆ‘æ²¡æœ‰ç›´æ¥æŠŠæ‰€æœ‰ä¾èµ–æ”¾åˆ° [target.â€™cfg(target_os = â€œandroidâ€)â€™.dependencies]ä¸‹ï¼Œæ˜¯å› ä¸ºè¿™æ ·åœ¨pcç«¯å¯ä»¥ç›´æ¥ç¼–è¯‘ï¼Œæ£€æŸ¥é”™è¯¯ï¼Œåˆ©äºå¼€å‘ã€‚ æ¯”èµ·ğŸ‘‡ğŸ»æ–°å»ºmodçš„æ–¹æ³•ï¼Œç›®å‰ideï¼Œè¿˜æ”¯æŒçš„ä¸æ˜¯å¾ˆå‹å¥½ï¼Œä¹Ÿä¸å¥½ç¼–ç¨‹ï¼Œé”™è¯¯ä¹Ÿä¸å¥½æ£€æŸ¥ã€‚åªæœ‰å»ç¼–è¯‘ç›®æ ‡äº§ç‰©çš„æ—¶å€™æ‰ä¼šå‘ç°ã€‚è€Œè„±ç¦»ç›®æ ‡å¹³å°çš„æ–¹æ³•ï¼Œä¸€äº›é€»è¾‘æˆ‘æ˜¯å¯ä»¥æå‰æµ‹è¯•éªŒè¯çš„ã€‚ æ³¨æ„äº‹é¡¹ï¼š java.lang.UnsatisfiedLinkError: dlopen failed: library â€œlibrustsdk.soâ€ not foundæ ¹æ®ä»£ç æ˜¯ç”¨çš„ä»€ä¹ˆloadLibraryæ–¹æ³•ï¼Œå¦‚æœæ˜¯ 1System.loadLibrary(\"rust_sdk\"); æ˜¯ä¸éœ€è¦æ·»åŠ libå‰ç¼€çš„ï¼Œå°½ç®¡ç”Ÿæˆçš„libæ–‡ä»¶å¸¦æœ‰å‰ç¼€ï¼Œä¾‹å¦‚ librust_sdk.soï¼Œè¿˜æœ‰éœ€è¦ç•™æ„ä½ åœ¨gradeé‡Œé¢æŒ‡å®šçš„æ–‡ä»¶ 1234567cargo { module = \"./../rust_sdk\" // Or whatever directory contains your Cargo.toml libname = \"rust_sdk\" // Or whatever matches Cargo.toml's [package] name. targets = [\"arm64\"] // See bellow for a longer list of options verbose = true profile = \"debug\"} java.lang.UnsatisfiedLinkError: No implementation foundè¿™ä¸ªæ˜¯æ–¹æ³•æ‰¾ä¸åˆ°ï¼Œéœ€è¦æŸ¥ä¸€ä¸‹ï¼Œæ–¹æ³•åç§°å’Œå‚æ•°æ˜¯ä¸æ˜¯å¯¹åº”å¾—ä¸Šï¼Œä¸€ä¸ªæ’æŸ¥æ–¹æ³•ï¼Œå°±æ˜¯å»çœ‹soçš„å¯¼å‡ºå‡½æ•°ï¼Œæœ‰æ²¡æœ‰ã€‚ 123 ./ objdump -T librust_sdk.so | grep addNum000000000012e2ec g DF .text 0000000000000094 Java_com_example_mylibrary_Tools_addNum è¿˜æœ‰ä¸€ä¸ªå¾ˆå®¹æ˜“å¿½ç•¥çš„ç‚¹ï¼Œå¤§å‘ apkæ‰“åŒ…çš„æµç¨‹å¦‚æœæ˜¯æœ‰ç¼“å­˜çš„è¯ï¼Œå¹¶ä¸ä¼šå»æ£€æŸ¥soæ˜¯å¦æœ‰æ›´æ–°ï¼Œå†™å®Œrustï¼Œç›´æ¥å°±å»ç¼–è¯‘apkï¼Œæ‰€ä»¥apké‡Œé¢çš„soå¾ˆæœ‰å¯èƒ½æ˜¯æ—§çš„ï¼Œå¦‚æœæ˜¯æ—§çš„ï¼Œå°±éœ€è¦é‡æ–°rebuildä¸€æ¬¡ï¼Œå¯ä»¥å»æ£€æŸ¥ä¸€ä¸‹ã€‚JNIçš„æ–¹æ³•è°ƒç”¨ï¼Œæ¨èç”¨æ–¹æ³•åå»åšåŒºåˆ†ï¼Œä¸è¦ç”¨å‚æ•°é‡è½½ä¹‹ç±»çš„æ–¹æ³•ï¼Œå»åšåŒºåˆ†ï¼Œå¦‚æœä½ å†™äº†ä¸€ä¸ªaddå‡½æ•°ï¼Œå‘ç°ä½ å¤šä¼ ä¸€ä¸ªå‚æ•°ï¼Œä¹Ÿæ˜¯å¯ä»¥è°ƒçš„ã€‚","link":"/2023/12/02/Android/android_import_rust/"},{"title":"å®‰å“é€†å‘ä¹‹é‡æ–°æ‰“åŒ…","text":"å®‰å“é‡æ–°æ‰“åŒ… ä¸‹è½½å·¥å…·https://apktool.org/ è§£åŒ…å’Œé‡æ–°æ‰“åŒ…https://github.com/skylot/jadx åç¼–è¯‘æŸ¥çœ‹ å‘½ä»¤ è§£åŒ…1java -jar apktool_2.9.1.jar d firstTest.apk d=decode=è§£ç è¿™ä¸ªå‘½ä»¤ä¼šæŠŠfirstTest.apkè§£å‡ºæ¥ä¸€ä¸ªsmaliæ–‡ä»¶å¤¹ é‡æ–°æ‰“åŒ…1java -jar apktool_2.9.1.jar b firstTest -o firstTest.apk b=build=ç¼–è¯‘ o=output=è¾“å‡ºæ–‡ä»¶å ä¸€èˆ¬é‡æ–°æ‰“åŒ…åå®‰è£…æ˜¯éœ€è¦é‡æ–°ç­¾åçš„ï¼Œé‡æ–°ç­¾åéœ€è¦ä¸€ä¸ªè¯ä¹¦ã€‚ ç”Ÿæˆè¯ä¹¦1keytool -genkeypair -v -keystore repack.keystore -keyalg RSA -keysize 2048 -validity 10000 -alias repack å¯†ç å’Œaliaséœ€è¦è®°ä½ é‡æ–°ç­¾å1jarsigner -verbose -digestalg SHA1 -sigalg SHA1withRSA -keystore repack.keystore -signedjar firstTestSign.apk firstTest.apk repack","link":"/2022/12/17/Android/android_repack/"},{"title":"ä¸€ç§äº‹ä»¶æµåŸ‹ç‚¹çš„å®ç°æ–¹æ¡ˆ","text":"é—®é¢˜èƒŒæ™¯ï¼šå‡å®šappç«¯ä¸Šæœ‰ä¸ªåœºæ™¯ï¼Œæ˜¯ä¸€ä¸ªæœ‰åºçš„æµç¨‹ï¼Œåœ¨æ¯ä¸ªå…³é”®èŠ‚ç‚¹éƒ½æ˜¯å¯èƒ½å¤±è´¥çš„ã€‚ç°å­˜çš„æ–¹æ¡ˆæ˜¯åœ¨æ¯ä¸ªå…³é”®èŠ‚ç‚¹éƒ½åšä¸€ä¸ªåŸ‹ç‚¹ä¸ŠæŠ¥ï¼Œæœ‰å¦‚ä¸‹ç—›ç‚¹ï¼š åŸ‹ç‚¹æœ‰ä¸¢å¤±çš„æƒ…å†µï¼Œé€ æˆæ¼æ–—åˆ†æï¼Œåé¢æ¯”å‰é¢å¤šçš„æƒ…å†µ DAæ•°æ®åˆ†æä¾§ï¼Œä¸æ–¹ä¾¿åˆ†ææ•´ä¸ªæµç¨‹ï¼Œéœ€è¦æŸ¥è¯¢å¤šä¸ªäº‹ä»¶ï¼Œå†åšå…³è”ï¼ŒSQLè¿‡äºå¤æ‚ RDä¾§ä¹Ÿä¸èƒ½å¾ˆå¥½çš„å¤„ç†åé¦ˆå’Œå…³æ³¨é—®é¢˜ åŸ‹ç‚¹æ–¹æ¡ˆæ”¹è¿›æ–¹æ¡ˆï¼šåœ¨appä¾§åšæ•´ä¸ªäº‹ä»¶æµçš„æ‰“ç‚¹ï¼Œå¯¹æ•´ä¸ªäº‹ä»¶æµåšä¸€èµ·çš„ä¸ŠæŠ¥ã€‚æ¥å£è®¾è®¡ï¼šæ•´ä¸ªäº‹ä»¶æµåœ¨å¼€å§‹èŠ‚ï¼Œç”Ÿæˆidï¼Œåç»­è¿™ä¸ªäº‹ä»¶æµä¸­çš„æ‰€æœ‰æ‰“ç‚¹éƒ½è®°å½•åœ¨è¿™ä¸ªidæµä¸­ï¼Œè®°å½•çš„é¡ºåºå°±æ˜¯å‘ç”Ÿçš„é¡ºåºã€‚æš´éœ²ä¸€ä¸ªæ¥å£ï¼Œæä¾›ä¸€ä¸ªé»˜è®¤å®ç°ï¼Œå¼€æ”¾éƒ¨åˆ†æ–¹æ³•å¯é‡å†™ã€‚æä¾›åŸºæœ¬çš„æ–¹æ³•ï¼Œæ–°å»ºè®°å½•ï¼Œæ’å…¥è®°å½•ï¼Œå’Œè§¦å‘ä¸ŠæŠ¥ã€‚æ•°æ®æ ¼å¼: é‡‡ç”¨jsonæ ¼å¼,å¤§è‡´æ ¼å¼å¦‚ä¸‹ï¼Œå¯è‡ªç”±å¢æ·»åŠ ï¼Œåç«¯ç”¨clickhouseæ–¹ä¾¿å¤„ç†josnæ•°æ® 123456{ \"local_id\":\"\", \"server_id\":\"\", \"event\":[] \"extra\":{}} é—®é¢˜ç‚¹äº‹ä»¶æµIDæ€ä¹ˆç¡®å®šï¼Ÿç”±ä¸šåŠ¡æ–¹æŒ‡å®šï¼Œåœ¨newRecordçš„æ—¶å€™ä¼ å…¥ã€‚ç«¯ä¸Šçš„è®°å½•ä¾èµ–local_idåœ¨è®°å½•äº§ç”Ÿçš„æ—¶å€™ï¼Œå°±è®°å½•ã€‚åœ¨æœ¬åœ°ç”¨KVçš„æ–¹å¼å­˜å‚¨ï¼Œä¸è¿‡æœ¬åœ°æŒä¹…åŒ–è®°å½•çš„valueæ˜¯éœ€è¦åŠ ä¸€äº›çŠ¶æ€å­—æ®µçš„ï¼Œæ ‡è®°è¿™æ¡è®°å½•çš„çŠ¶æ€ã€‚server_idæ˜¯å› ä¸ºè¿™ä¸ªäº‹ä»¶æµåœ¨åé¢çš„æŸä¸ªé˜¶æ®µæ‰ä¼šäº§ç”Ÿä¸€ä¸ªå…³è”çš„idï¼Œåœ¨åç«¯å…³è”æŸ¥è¯¢ï¼Œä¾‹å¦‚çš„åœºæ™¯å°±æ˜¯ç›´æ’­è¿éº¦ä¸»æ’­å’Œå˜‰å®¾çš„é“¾æ¥äº‹ä»¶å…³è”ï¼Œå°±å¯ä»¥ç”¨è¿™ä¸ªæŠ½è±¡çš„server_id æ•°æ®çš„ä¸€è‡´æ€§ï¼ŸåŒä¸€ä¸ªäº‹ä»¶æµå¯èƒ½æ˜¯åœ¨å¤šä¸ªçº¿ç¨‹é‡Œé¢æ“ä½œçš„ï¼Œ æŸä¸ªçº¿ç¨‹getä¸€æ¬¡record(json)ä¹‹åä¼šï¼Œåšä¸ªä¿®æ”¹ä¹‹åï¼Œä¼šå°†è¿™ä¸ªæ›´æ–°ä¿å­˜ä¸‹æ¥ã€‚ä¼šå­˜åœ¨ä¸€ç§æƒ…å†µï¼Œåé¢çš„æäº¤ä¿®æ”¹å¯èƒ½ä¼šè¢«å‰é¢çš„è¦†ç›–çš„æƒ…å†µã€‚ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œæˆ‘ä»¬çš„æ•´ä½“çš„æ€è·¯æ˜¯ä¸€ä¸ªå•çº¿ç¨‹æ¨¡å‹ï¼Œå®‰å“é‡Œé¢ä½¿ç”¨HanderThread,æ‰€æœ‰çš„æ“ä½œéƒ½æ˜¯åœ¨ä¸€ä¸ªçº¿ç¨‹é‡Œé¢æäº¤ï¼Œä½†æ˜¯ä¹Ÿæ˜¯ä¼šæœ‰è¦†ç›–çš„æƒ…å†µï¼Œå› ä¸ºå¤šçº¿ç¨‹æ“ä½œï¼Œå®ƒçš„getå’Œsetå¯èƒ½æ˜¯åˆ†ç¦»çš„ã€‚å¦‚æœæˆ‘ä»¬å¯ä»¥ä¿è¯æ¯ä¸ªçº¿ç¨‹é‡Œé¢çš„æ“ä½œgetå’Œsetæ˜¯è¿ç»­çš„ï¼Œé‚£ä¹ˆå°±èƒ½è§£å†³è¿™ä¸ªé—®ã€‚æ—¢ç„¶è¦getå’Œsetæ˜¯è¿ç»­çš„ï¼Œæœ€ç®€å•çš„åŠæ³•å°±æ˜¯å•çº¿ç¨‹ä¸­è¿™2ä¸ªæ“ä½œæ˜¯è¿ç»­çš„å°±å¯ä»¥äº†ï¼Œæ‰€ä»¥æˆ‘ä»¬çš„æ¨¡å‹è§„å®šäº†2ä¸ªæ¨¡å‹ï¼Œä¸€ä¸ªæ˜¯ç®€å•çš„è·å–å€¼ï¼Œè¿™ä¸ªæ¥å£å¯ä»¥æ˜¯åŒæ­¥çš„æˆ–å¼‚æ­¥çš„è¿”å›éƒ½è¡Œï¼Œä¸æ¶‰åŠå€¼çš„ä¿®æ”¹ã€‚å¦‚æœæ˜¯æ¶‰åŠå€¼çš„ä¿®æ”¹ï¼Œåªæä¾›å¼‚æ­¥çš„æ¥å£ï¼Œå•çº¿ç¨‹é˜Ÿåˆ—é‡Œé¢å»å¤„ç†å›è°ƒï¼Œè°ƒç”¨æ–¹ï¼Œåœ¨å›è°ƒé‡Œé¢è¿›è¡Œå€¼çš„ä¿®æ”¹ã€‚ 12func sync getRecord(recordId:String):JSONfunc async editRecord(recordId:Stringï¼Œcallback:JSON) ä¾‹å¦‚ä¸€ä¸ªçº¿ç¨‹postäº†ä¸€ä¸ªä¿®æ”¹ï¼Œåœ¨æ¶ˆæ¯é˜Ÿåˆ—å¤„ç†è¿™ä¸ªæ¶ˆæ¯çš„æ—¶å€™ï¼Œä¹Ÿå°±æ˜¯å›è°ƒé‡Œé¢æ‹¿åˆ°çš„recordå°±æ˜¯æœ€æ–°çš„ï¼Œæ­¤åˆ»è¿™ä¸ªçº¿ç¨‹è¢«è¿™ä¸ªæ¶ˆæ¯å æœ‰ï¼Œå¯ä»¥åœ¨å›è°ƒé‡Œé¢åšå¯¹è¿™ä¸ªrecordçš„å„ç§ä¿®æ”¹ï¼Œåœ¨å›è°ƒç»“æŸçš„æ—¶å€™ï¼Œè‡ªåŠ¨åšä¿å­˜ã€‚è¿™äº›éƒ½æˆ‘ä»¬æ¡†æ¶è®¾è®¡çš„èƒ½åŠ›ï¼Œä¸šåŠ¡è°ƒç”¨æ–¹ï¼Œåªéœ€è¦åœ¨å›è°ƒé‡Œé¢å†™è‡ªå®šä¹‰çš„ä¿®æ”¹é€»è¾‘å°±å¯ä»¥äº†ï¼Œå¯ä»¥ä¸æ„ŸçŸ¥å…·ä½“çš„å®ç°ã€‚ è‡ªå®šä¹‰JSONçš„mergeä¸€ä¸ªrecordçš„æ›´æ–°ï¼Œå…¶å®æ˜¯ä¸€ä¸ªjsonçš„æ›´æ–°ï¼Œæ‰€ä»¥è¿™é‡Œéœ€è¦å®šä¹‰jsonçš„åˆå¹¶è§„åˆ™ï¼Œå¦‚æœæ˜¯æ•°ç»„ç±»å‹çš„ï¼Œå°±è¿½åŠ åœ¨åé¢ï¼Œæˆ–è€…å°±æ˜¯åé¢çš„æ›¿æ¢å‰é¢çš„ã€‚ å¦‚ä½•ä¿è¯åŸ‹ç‚¹ä¸ä¸¢å¤±ï¼Ÿå¯ä»¥é€šè¿‡ä»¥ä¸‹æ‰‹æ®µæ¥ä¿è¯è®°å½•çš„æ­£ç¡®çš„ï¼Œå°½é‡å¤šçš„ä¸ŠæŠ¥åˆ°serveråšç»Ÿè®¡ï¼Œappçªç„¶è¢«killï¼Ÿè®°å½•æ€ä¹ˆåŠï¼Ÿåˆ©ç”¨çš„æ˜¯mmapï¼ŒæŠŠç£ç›˜æ˜ å°„æˆå†…å­˜çš„æ¥è®¿é—®ï¼Œè®¿é—®å¿«ï¼Œå¹¶ä¸”åˆ©ç”¨æ“ä½œç³»ç»Ÿçš„æœºåˆ¶ï¼Œæ•°æ®ä¼šå°½å¯èƒ½çš„ä¿ç•™ï¼Œè®¡ç®—appè¢«çªç„¶killï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥è·å¾—ä¸€äº›æœ‰ç”¨ä¿¡æ¯ï¼Œåšé—®é¢˜åˆ†æã€‚ é¦–å…ˆçµæ´»çš„é…ç½®æ–¹å¼ä¸»åŠ¨è§¦å‘ä¸ŠæŠ¥çš„æ–¹å¼ã€‚åˆ©ç”¨recordçš„æ—¶æœºåœºæ™¯ï¼Œæ”¯æŒé…ç½®è¶…æ—¶ã€‚ä¾‹å¦‚è¿™ä¸ªäº‹ä»¶æµï¼Œæ­£å¸¸çš„æƒ…å†µä¹Ÿå°±æœ€å¤š1åˆ†é’Ÿï¼Œè¶…è¿‡1åˆ†é’Ÿï¼Œå°±ä¸»åŠ¨è§¦å‘ä¸ŠæŠ¥ã€‚å½“ç„¶ä¹Ÿæ”¯æŒä¸šåŠ¡è°ƒç”¨ä¸»åŠ¨è§¦å‘ä¸ŠæŠ¥ã€‚ è½®è®­æ—¶é—´é—´éš”ï¼Œæ£€æŸ¥æœ¬åœ°è®°å½•æ˜¯å¦å¯ä»¥ä¸ŠæŠ¥ã€‚ appå¯åŠ¨çš„æ—¶å€™ï¼Œæ”¯æŒå®šåˆ¶çš„å»¶æ—¶ä¸ŠæŠ¥æœ¬åœ°çš„è®°å½•ã€‚ æ·»åŠ æ—¥æœŸè¿‡æœŸæœºåˆ¶ï¼Œä¸¢æ‰æ— ç”¨çš„æ•°æ®ï¼Œå‡å°‘serveråˆ†æå‹åŠ›ã€‚","link":"/2023/09/09/Android/seq_point_trace_report/"}],"tags":[{"name":"Bug","slug":"Bug","link":"/tags/Bug/"},{"name":"Android","slug":"Android","link":"/tags/Android/"},{"name":"Java","slug":"Java","link":"/tags/Java/"},{"name":"LeetCode","slug":"LeetCode","link":"/tags/LeetCode/"},{"name":"Kotlin","slug":"Kotlin","link":"/tags/Kotlin/"},{"name":"åˆ†äº«","slug":"åˆ†äº«","link":"/tags/%E5%88%86%E4%BA%AB/"},{"name":"Spark","slug":"Spark","link":"/tags/Spark/"},{"name":"K8S","slug":"K8S","link":"/tags/K8S/"},{"name":"JNI","slug":"JNI","link":"/tags/JNI/"},{"name":"C++","slug":"C","link":"/tags/C/"},{"name":"è®¡ç»„","slug":"è®¡ç»„","link":"/tags/%E8%AE%A1%E7%BB%84/"},{"name":"æ“ä½œç³»ç»Ÿ","slug":"æ“ä½œç³»ç»Ÿ","link":"/tags/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/"},{"name":"Gradle","slug":"Gradle","link":"/tags/Gradle/"},{"name":"å®‰è£…","slug":"å®‰è£…","link":"/tags/%E5%AE%89%E8%A3%85/"},{"name":"Compose","slug":"Compose","link":"/tags/Compose/"},{"name":"Rust","slug":"Rust","link":"/tags/Rust/"}],"categories":[{"name":"Android","slug":"Android","link":"/categories/Android/"},{"name":"Java","slug":"Android/Java","link":"/categories/Android/Java/"},{"name":"è¯­è¨€åŸºç¡€","slug":"è¯­è¨€åŸºç¡€","link":"/categories/%E8%AF%AD%E8%A8%80%E5%9F%BA%E7%A1%80/"},{"name":"Java","slug":"è¯­è¨€åŸºç¡€/Java","link":"/categories/%E8%AF%AD%E8%A8%80%E5%9F%BA%E7%A1%80/Java/"},{"name":"LeetCode","slug":"LeetCode","link":"/categories/LeetCode/"},{"name":"Kotlin","slug":"è¯­è¨€åŸºç¡€/Kotlin","link":"/categories/%E8%AF%AD%E8%A8%80%E5%9F%BA%E7%A1%80/Kotlin/"},{"name":"åˆ†äº«","slug":"åˆ†äº«","link":"/categories/%E5%88%86%E4%BA%AB/"},{"name":"æ¡†æ¶","slug":"æ¡†æ¶","link":"/categories/%E6%A1%86%E6%9E%B6/"},{"name":"C++","slug":"è¯­è¨€åŸºç¡€/C","link":"/categories/%E8%AF%AD%E8%A8%80%E5%9F%BA%E7%A1%80/C/"},{"name":"è®¡ç®—æœºåŸºç¡€","slug":"è®¡ç®—æœºåŸºç¡€","link":"/categories/%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%9F%BA%E7%A1%80/"},{"name":"é¡¹ç›®æ¶æ„","slug":"é¡¹ç›®æ¶æ„","link":"/categories/%E9%A1%B9%E7%9B%AE%E6%9E%B6%E6%9E%84/"},{"name":"é—®é¢˜ä¸ç»éªŒ","slug":"é—®é¢˜ä¸ç»éªŒ","link":"/categories/%E9%97%AE%E9%A2%98%E4%B8%8E%E7%BB%8F%E9%AA%8C/"},{"name":"Kotlin","slug":"Android/Kotlin","link":"/categories/Android/Kotlin/"}]}